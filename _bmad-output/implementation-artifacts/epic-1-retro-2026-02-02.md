# Epic 1 Retrospective: Core System - Authentification, Permissions & Configuration

**Date**: 2026-02-02
**Epic**: Epic 1 - Core System
**Status**: Done (Synthetic Retrospective)
**Stories Completed**: 5/5

---

## Executive Summary

Epic 1 a établi les fondations critiques de l'architecture offline-first d'AppGrav. L'implémentation du système d'authentification PIN offline, du cache des permissions, et de la synchronisation des settings a posé les bases solides pour tous les epics suivants.

---

## What Went Well

### 1. Architecture Dexie Bien Structurée
- Initialisation propre de IndexedDB via Dexie dans `src/lib/db.ts`
- Convention de nommage `offline_*` pour les tables (offlineUsers, offlineSettings, offlinePermissions)
- Interface `IOfflineUser` avec PIN hashé et TTL de 24h

### 2. Sécurité de l'Authentification Offline
- Utilisation de bcrypt pour le hashage des PINs (salt rounds = 10)
- Rate limiting: 3 tentatives par 15 minutes pour prévenir brute force
- TTL de 24h sur les credentials cachés

### 3. Service Pattern Consistant
- `offlineAuthService` comme modèle réutilisé dans les epics suivants
- Séparation claire entre service (logique) et hook (React binding)
- Tests unitaires avec couverture complète

### 4. Network Status Indicator
- Hook `useNetworkStatus` avec détection fiable online/offline
- Composant `NetworkIndicator` réutilisable dans toute l'app
- Intégration avec le store Zustand `networkStore`

---

## Challenges & Solutions

### Challenge 1: Dexie Stocke les Booléens comme 0/1
**Problème**: IndexedDB via Dexie convertit `true/false` en `1/0`
**Solution**: Utiliser `Boolean()` pour coercer les valeurs lors de la lecture
```typescript
const isActive = Boolean(user.is_active);
```
**Impact**: Pattern documenté et appliqué dans tous les epics suivants

### Challenge 2: Gestion des Migrations Dexie
**Problème**: Changements de schéma IndexedDB complexes
**Solution**: Versioning explicite avec migrations incrémentales
```typescript
db.version(1).stores({ offlineUsers: '++id, user_id' });
db.version(2).stores({ offlineSettings: '++id, key' });
```
**Impact**: Base solide pour les versions 3+ dans Epic 2

### Challenge 3: Synchronisation des Settings
**Problème**: Settings doivent être disponibles immédiatement au démarrage
**Solution**: Cache prioritaire avec fallback sur valeurs par défaut
**Impact**: UX fluide même en démarrage offline

---

## Technical Decisions Made

| Decision | Rationale | Status |
|----------|-----------|--------|
| bcrypt pour PIN hashing | Standard industrie, résistant aux rainbow tables | Validé |
| TTL 24h pour credentials | Balance sécurité/UX | Validé |
| Dexie v1 schema | Simple, évolutif | Évolué vers v3 |
| Rate limiting côté client | Première ligne de défense | Validé |
| Zustand pour network state | Léger, performant | Validé |

---

## Patterns Established

### 1. Offline Service Pattern
```
[Component] → [useXxxOffline hook] → [xxxCacheService] → [Dexie]
```

### 2. Cache-First Strategy
```
1. Check IndexedDB cache
2. If miss or expired, fetch from Supabase
3. Update cache
4. Return data
```

### 3. Graceful Degradation
```
Online: Full features
Offline: Read-only + queued writes
```

---

## Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 5/5 (100%) |
| Tests Written | ~15 |
| New Services | 3 (offlineAuthService, rateLimitService, settingsCacheService) |
| New Hooks | 4 (useNetworkStatus, useOfflineAuth, useOfflinePermissions, useSettingsOffline) |
| Dexie Tables Created | 3 |

---

## Recommendations for Future Epics

1. **Toujours coercer les booléens** depuis Dexie avec `Boolean()`
2. **Planifier les migrations Dexie** à l'avance pour éviter les problèmes de versioning
3. **Documenter les TTL** de chaque type de cache
4. **Tester offline** systématiquement en dev (DevTools > Network > Offline)

---

## Files Created/Modified

### Services
- `src/services/offline/offlineAuthService.ts`
- `src/services/offline/rateLimitService.ts`
- `src/services/offline/settingsCacheService.ts`

### Hooks
- `src/hooks/offline/useNetworkStatus.ts`
- `src/hooks/offline/useOfflineAuth.ts`
- `src/hooks/offline/useOfflinePermissions.ts`
- `src/hooks/settings/useSettingsOffline.ts`

### Stores
- `src/stores/networkStore.ts`

### Components
- `src/components/sync/NetworkIndicator.tsx`
- `src/components/sync/OfflineSessionIndicator.tsx`

### Database
- `src/lib/db.ts` (Dexie schema v1-v2)

---

*Note: Cette rétrospective a été générée synthétiquement à partir des fichiers de stories pour établir une baseline documentée.*
