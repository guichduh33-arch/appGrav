# Epic 2 Retrospective: Catalogue & Costing - Produits, Recettes & Production

**Date**: 2026-02-02
**Epic**: Epic 2 - Catalogue & Costing
**Status**: Done (Synthetic Retrospective)
**Stories Completed**: 5/5

---

## Executive Summary

Epic 2 a étendu l'architecture offline pour supporter le catalogue produits complet, les catégories, les modifiers, les recettes et les records de production. Une consolidation importante des instances Dexie a été nécessaire pour corriger une erreur d'architecture initiale.

---

## What Went Well

### 1. Consolidation Dexie Réussie
- Fusion de deux instances Dexie séparées en une seule
- Migration propre vers Dexie v3 avec tous les stores
- Pas de perte de données pendant la migration

### 2. Cache Produits Performant
- `productsCacheService` avec invalidation intelligente
- Support des produits finished, semi_finished, raw_material
- Indexation par category_id pour filtrage rapide

### 3. Pattern Online-Only avec Reminders
- Production records intentionnellement online-only (intégrité stock)
- localStorage pour les reminders de production non-sauvegardés
- UX claire indiquant le besoin de connexion

### 4. Catégories avec Dispatch Station
- Chaque catégorie a un `dispatch_station`: kitchen, barista, display, none
- Filtrage automatique pour le KDS (préparation Epic 4)
- Configuration flexible par produit

---

## Challenges & Solutions

### Challenge 1: Deux Instances Dexie
**Problème**: Epic 1 et Epic 2 avaient créé des fichiers db.ts séparés
**Solution**: Consolidation dans un seul `src/lib/db.ts` avec tous les stores
```typescript
db.version(3).stores({
  offlineUsers: '++id, user_id',
  offlineSettings: '++id, key',
  offlinePermissions: '++id, user_id',
  offlineProducts: '++id, product_id, category_id',
  offlineCategories: '++id, category_id',
  offlineModifiers: '++id, modifier_id'
});
```
**Impact**: Architecture clarifiée, pas de conflits IndexedDB

### Challenge 2: Sync Partiel des Produits
**Problème**: Sync complet = trop de données, sync partiel = données manquantes
**Solution**: Sync incrémental basé sur `updated_at` avec full refresh périodique
**Impact**: Performance optimisée, données à jour

### Challenge 3: Recettes Read-Only
**Problème**: Recettes complexes avec relations many-to-many
**Solution**: Cache en lecture seule, modifications online-only
**Impact**: Simplicité du cache, intégrité des données de costing

---

## Technical Decisions Made

| Decision | Rationale | Status |
|----------|-----------|--------|
| Dexie v3 consolidé | Une seule source de vérité | Validé |
| Products sync incrémental | Performance réseau | Validé |
| Recipes read-only offline | Complexité relations, intégrité costing | Validé |
| Production online-only | Impact stock immédiat requis | Validé |
| localStorage pour reminders | Données temporaires non-critiques | Validé |

---

## Patterns Established

### 1. Incremental Sync Pattern
```
1. Get last_sync_at from metadata
2. Fetch records WHERE updated_at > last_sync_at
3. Upsert into IndexedDB
4. Update last_sync_at
```

### 2. Online-Only with Reminder Pattern
```
1. Save draft to localStorage
2. Show warning: "Connexion requise"
3. On submit: check network
4. Clear localStorage on success
```

### 3. Read-Only Cache Pattern
```
1. Sync from server (periodic)
2. Serve from cache (always)
3. No local mutations
4. Invalidate on server push
```

---

## Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 5/5 (100%) |
| Tests Written | ~12 |
| New Services | 3 (productsCacheService, categoriesCacheService, modifiersCacheService) |
| New Hooks | 4 |
| Dexie Stores Added | 3 (offlineProducts, offlineCategories, offlineModifiers) |
| Dexie Version | v3 |

---

## Recommendations for Future Epics

1. **Toujours utiliser le db.ts consolidé** - ne jamais créer de nouvelle instance Dexie
2. **Privilégier read-only cache** pour les données complexes avec relations
3. **Online-only pour les opérations** avec impact sur d'autres modules (stock, comptabilité)
4. **localStorage pour les drafts** temporaires non-critiques

---

## Files Created/Modified

### Services
- `src/services/offline/productsCacheService.ts`
- `src/services/offline/categoriesCacheService.ts`
- `src/services/offline/modifiersCacheService.ts`

### Hooks
- `src/hooks/products/useProductsOffline.ts`
- `src/hooks/products/useCategoriesOffline.ts`
- `src/hooks/products/useModifiersOffline.ts`

### Database
- `src/lib/db.ts` (upgraded to v3)

### Types
- `src/types/offline.ts` (IOfflineProduct, IOfflineCategory, IOfflineModifier)

---

## Lessons Learned

1. **Planifier l'architecture Dexie dès le début** - la consolidation tardive coûte du temps
2. **Documenter les décisions online-only** - évite les questions répétées
3. **Tester les migrations Dexie** avec des données existantes

---

*Note: Cette rétrospective a été générée synthétiquement à partir des fichiers de stories pour établir une baseline documentée.*
