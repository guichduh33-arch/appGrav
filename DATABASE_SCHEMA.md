# Database Schema Reference

Last updated: 2026-02-15

## Overview

PostgreSQL database hosted on Supabase. 74 SQL migrations (local) + 13 Phase 1 migrations (applied via Supabase API). All tables use UUID primary keys, RLS enabled, and `created_at`/`updated_at` timestamps.

## Core Tables

### products
- `id` UUID PK
- `name`, `sku`, `barcode`, `description`
- `type`: finished, semi_finished, raw_material
- `category_id` FK -> categories
- `price` DECIMAL, `wholesale_price` DECIMAL, `cost_price` DECIMAL
- `current_stock` DECIMAL, `min_stock` INTEGER
- `is_active` BOOLEAN
- `image_url` TEXT

### categories
- `id` UUID PK
- `name`, `slug`, `description`
- `dispatch_station`: barista, kitchen, display, none
- `show_in_pos` BOOLEAN (default true)

### suppliers
- `id` UUID PK
- `name`, `contact_person`, `phone`, `email`, `address`
- `category` VARCHAR (e.g., bakery, dairy, packaging) (Phase 1 - I1)

## Sales Tables

### orders
- `id` UUID PK
- `order_number` VARCHAR
- `status`: pending, preparing, ready, completed, cancelled, **voided**
- `order_type`: dine_in, takeaway, delivery, b2b
- `subtotal`, `tax_amount`, `discount_amount`, `total` DECIMAL
- `service_charge` DECIMAL (Phase 1 - C3)
- `guest_count` INTEGER (Phase 1 - B3)
- `payment_method`, `payment_status`
- `customer_id` FK -> customers
- `staff_id` FK -> user_profiles
- `session_id` FK -> pos_sessions
- `is_offline` BOOLEAN, `table_number`, `notes`

### order_items
- `id` UUID PK
- `order_id` FK -> orders (CASCADE)
- `product_id` FK -> products
- `quantity` **DECIMAL(10,3)** (changed from INTEGER in Sprint 4)
- `unit_price`, `subtotal`, `discount_amount` DECIMAL
- `modifiers` JSONB, `notes` TEXT

### order_payments
- `id` UUID PK
- `order_id` FK -> orders (CASCADE)
- `payment_method` VARCHAR(50)
- `amount` DECIMAL(15,2)
- `cash_received`, `change_given` DECIMAL(12,2)
- `reference` VARCHAR, `status` VARCHAR(20) default 'completed'
- `is_offline` BOOLEAN, `synced_at` TIMESTAMPTZ
- `created_by` FK -> user_profiles
- Indexes: `idx_order_payments_order_status`, `idx_order_payments_created`, `idx_order_payments_sync`

### pos_sessions
- `id` UUID PK
- `session_number` VARCHAR (auto-generated by trigger)
- `user_id` FK -> user_profiles
- `terminal_id` VARCHAR
- `opening_cash`, `closing_cash` DECIMAL
- `status`: open, closed

## Customer Tables

### customers
- `id` UUID PK
- `name`, `email`, `phone`
- `category_id` FK -> customer_categories
- `loyalty_points` INTEGER, `loyalty_tier`

### customer_categories
- `id` UUID PK
- `name`, `slug` (retail, wholesale, discount_percentage, custom)
- `price_modifier_type`, `price_modifier_value`

### product_category_prices
- Custom pricing per product per customer category

### loyalty_tiers / loyalty_transactions
- Tier definitions and point transaction history

## Inventory Tables

### stock_movements
- `id` UUID PK
- `product_id` FK -> products
- `movement_type`: purchase, production_in, adjustment_in, transfer_in, sale_pos, sale_b2b, production_out, adjustment_out, waste, transfer_out, ingredient
- `quantity` DECIMAL - **always positive** (CHECK constraint enforced)
- `unit` VARCHAR (e.g., kg, pcs, g)
- `stock_before`, `stock_after` DECIMAL (set by trigger)
- `reference_id` UUID, `reference_type` VARCHAR
- `notes` TEXT

### recipes / production_records / product_modifiers / product_uoms / inventory_counts

## Combos & Promotions

### product_combos / product_combo_groups / product_combo_group_items
- Combo meal definitions with choice groups

### promotions / promotion_products / promotion_free_products / promotion_usage
- Time-based promotion rules with usage tracking

## B2B Tables

### b2b_orders
- `tax_rate` default **0.10** (changed from 0.00 in Sprint 4)

### b2b_order_items / b2b_payments

## Purchasing

### purchase_orders / po_items

### po_activity_log (Phase 1 - I4)
- `id` UUID PK
- `po_id` FK -> purchase_orders
- `action` VARCHAR (created, updated, approved, received, cancelled)
- `user_id` FK -> user_profiles
- `details` JSONB
- `created_at` TIMESTAMPTZ

## Accounting Tables (Phase 1 additions)

### product_price_history (D3/O1)
- `id` UUID PK
- `product_id` FK -> products
- `old_price`, `new_price` DECIMAL
- `old_cost_price`, `new_cost_price` DECIMAL
- `changed_by` FK -> user_profiles
- `reason` TEXT

### vat_filings (H7)
- `id` UUID PK
- `year` INTEGER, `month` INTEGER
- `collected`, `deductible`, `payable` DECIMAL
- `status` VARCHAR (draft, filed, paid)
- `filed_at` TIMESTAMPTZ, `filed_by` FK -> user_profiles
- `notes` TEXT

### journal_entries (updated)
- `attachment_url` TEXT (Phase 1 - H3, file upload via Supabase Storage)

## Notification Tables (Phase 1 - L1)

### notification_events
- `id` UUID PK
- `code` VARCHAR UNIQUE
- `name`, `description` TEXT
- `category` VARCHAR
- `default_enabled` BOOLEAN

### notification_preferences
- `id` UUID PK
- `user_id` FK -> user_profiles
- `event_id` FK -> notification_events
- `enabled` BOOLEAN
- UNIQUE(user_id, event_id)

## Business Hours (Phase 1 - K7)

### business_holidays
- `id` UUID PK
- `name` VARCHAR
- `date` DATE UNIQUE
- `is_recurring` BOOLEAN

## User Profiles (updated)

### user_profiles (Phase 1 additions)
- `title` VARCHAR (job title - M2)
- `default_module` VARCHAR (landing page after login - M2)
- `mfa_enabled` BOOLEAN (MFA flag - M3)

## System Tables

### user_profiles / roles / permissions / role_permissions / user_roles / user_permissions
### audit_logs / settings / printer_configurations

### system_alerts
- `id` UUID PK
- `alert_type` VARCHAR(50)
- `severity`: info, warning, critical (CHECK constraint)
- `title` TEXT, `description` TEXT
- `reference_type` VARCHAR, `reference_id` UUID
- `is_read` BOOLEAN, `is_resolved` BOOLEAN
- `resolved_by` FK -> user_profiles, `resolved_at`, `resolution_notes`

## Key Views

- `view_daily_kpis` - Daily sales KPIs
- `view_inventory_valuation` - Current inventory value
- `view_payment_method_stats` - Payment method breakdown
- Plus report views created in migration `20260206120000`

## Key Functions

```sql
user_has_permission(p_user_id UUID, p_permission_code VARCHAR) -> BOOLEAN
is_admin(p_user_id UUID) -> BOOLEAN
get_customer_product_price(p_product_id UUID, p_customer_category_slug VARCHAR) -> DECIMAL
add_loyalty_points(p_customer_id UUID, p_points INTEGER, p_order_id UUID) -> VOID
redeem_loyalty_points(p_customer_id UUID, p_points INTEGER) -> BOOLEAN
open_shift(p_opening_cash DECIMAL, p_terminal_id VARCHAR, p_notes TEXT) -> JSONB
  -- Uses auth.uid() internally (no p_user_id parameter)
```

## Key Triggers

- `generate_session_number` - Auto-generates session numbers on pos_sessions INSERT
- `record_stock_before_after` - Calculates stock_before/stock_after on stock_movements INSERT
- `deduct_stock_on_sale_items` - Deducts product stock and ingredients on order_items INSERT (status = completed/preparing)

## Indexes Added (Sprint 4)

- `idx_orders_customer_id` on orders(customer_id)
- `idx_orders_staff_id` on orders(staff_id)
- `idx_loyalty_transactions_customer_id` on loyalty_transactions(customer_id)
- `idx_b2b_order_items_order_id` on b2b_order_items(order_id)
- `idx_inventory_count_items_count_id` on inventory_count_items(count_id)
- `idx_stock_movements_product_id` on stock_movements(product_id)
- `idx_order_items_order_id` on order_items(order_id)

## RLS Pattern

All tables have RLS enabled. Standard pattern:

```sql
ALTER TABLE public.{table_name} ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated read" ON public.{table_name}
    FOR SELECT USING (auth.uid() IS NOT NULL);

CREATE POLICY "Permission-based write" ON public.{table_name}
    FOR INSERT WITH CHECK (public.user_has_permission(auth.uid(), '{module}.create'));
```

Note: Anonymous insert policies were removed in Sprint 4 security hardening (migration `20260210100001`).
