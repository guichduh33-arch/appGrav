[{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\__tests__\\smoke\\pos-smoke.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\auth\\PermissionGuard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\auth\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\DeferredNotesBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\DeferredNotesPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\InventoryAlertsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\InventoryTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\OfflineAdjustmentBlockedModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\OfflineStockBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\RecipeViewerModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\StaleDataWarning.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\StockAdjustmentModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\StockAlertsBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\StockAlertsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\inventory\\__tests__\\StockAlerts.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\kds\\KDSCountdownBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\kds\\KDSOrderCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\lan\\LanConnectionIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\lan\\__tests__\\LanConnectionIndicator.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\lan\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\mobile\\MobileLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\orders\\OrderItemStatusBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\orders\\__tests__\\OrderItemStatusBadge.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\Cart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\CategoryNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\ComboGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\LoyaltyBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\POSMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\ProductGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\StockBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\__tests__\\ComboGrid.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\__tests__\\LoyaltyBadge.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\cart-components\\CartActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\cart-components\\CartItemRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\cart-components\\CartTotals.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\cart-components\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\CashierAnalyticsModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\ComboSelectorModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\CustomerSearchModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_lastSyncAt' is assigned a value but never used.","line":96,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":96,"endColumn":36},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":369,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":369,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13550,13553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13550,13553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":395,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":395,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14702,14705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14702,14705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react'\r\nimport { X, Search, QrCode, User, Crown, Star, Building2, UserCheck, Check, UserPlus, Phone, Mail, Save, WifiOff, Heart, History, ShoppingBag, RotateCcw, ChevronLeft, Package, AlertTriangle, Clock } from 'lucide-react'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport { useNetworkStore } from '../../../stores/networkStore'\r\nimport { searchCustomersOffline, syncCustomersToOffline, IOfflineCustomer } from '../../../services/sync/customerSync'\r\nimport { useCustomersLastSync } from '@/hooks/customers/useCustomersOffline'\r\nimport { formatPrice } from '../../../utils/helpers'\r\nimport { TIER_COLORS, TIER_DISCOUNTS } from '@/constants/loyalty'\r\nimport './CustomerSearchModal.css'\r\n\r\ninterface CustomerCategory {\r\n    id: string\r\n    name: string\r\n    slug: string\r\n    color: string | null\r\n    price_modifier_type: string\r\n    discount_percentage: number | null\r\n}\r\n\r\ninterface Customer {\r\n    id: string\r\n    name: string\r\n    company_name: string | null\r\n    phone: string | null\r\n    email: string | null\r\n    customer_type: string\r\n    category_id: string | null\r\n    category?: {\r\n        name: string\r\n        slug: string\r\n        color: string\r\n        price_modifier_type: string\r\n        discount_percentage: number | null\r\n    }\r\n    loyalty_points: number\r\n    loyalty_tier: string\r\n    total_spent: number\r\n    membership_number: string | null\r\n    loyalty_qr_slug: string | null\r\n}\r\n\r\ninterface OrderHistoryItem {\r\n    id: string\r\n    order_number: string\r\n    created_at: string\r\n    total: number\r\n    items: Array<{\r\n        id: string\r\n        product_id: string\r\n        product_name: string\r\n        quantity: number\r\n        unit_price: number\r\n    }>\r\n}\r\n\r\ninterface FrequentProduct {\r\n    product_id: string\r\n    product_name: string\r\n    times_ordered: number\r\n    last_ordered: string\r\n}\r\n\r\ninterface CustomerSearchModalProps {\r\n    onClose: () => void\r\n    onSelectCustomer: (customer: Customer | null) => void\r\n    selectedCustomerId?: string | null\r\n}\r\n\r\n// TIER_COLORS and TIER_DISCOUNTS imported from @/constants/loyalty\r\n\r\n// LocalStorage key for favorites\r\nconst FAVORITES_KEY = 'appgrav_favorite_customers'\r\n\r\n// Get favorites from localStorage\r\nconst getFavorites = (): string[] => {\r\n    try {\r\n        const stored = localStorage.getItem(FAVORITES_KEY)\r\n        return stored ? JSON.parse(stored) : []\r\n    } catch {\r\n        return []\r\n    }\r\n}\r\n\r\n// Save favorites to localStorage\r\nconst saveFavorites = (favorites: string[]) => {\r\n    localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites))\r\n}\r\n\r\nexport default function CustomerSearchModal({\r\n    onClose,\r\n    onSelectCustomer,\r\n    selectedCustomerId\r\n}: CustomerSearchModalProps) {\r\n    const isOnline = useNetworkStore((state) => state.isOnline)\r\n    // Story 6.1: Track cache freshness for stale data indicator\r\n    const { lastSyncAt: _lastSyncAt, isStale, ageDisplay } = useCustomersLastSync()\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [customers, setCustomers] = useState<Customer[]>([])\r\n    const [loading, setLoading] = useState(false)\r\n    const [mode, setMode] = useState<'search' | 'scan' | 'create' | 'favorites'>('search')\r\n    const [qrInput, setQrInput] = useState('')\r\n    const qrInputRef = useRef<HTMLInputElement>(null)\r\n    const searchTimeoutRef = useRef<NodeJS.Timeout | null>(null)\r\n\r\n    // Favorites state (Story 7.3)\r\n    const [favoriteIds, setFavoriteIds] = useState<string[]>(getFavorites)\r\n    const [favoriteCustomers, setFavoriteCustomers] = useState<Customer[]>([])\r\n\r\n    // Customer detail view (Story 7.4, 7.5)\r\n    const [selectedDetailCustomer, setSelectedDetailCustomer] = useState<Customer | null>(null)\r\n    const [orderHistory, setOrderHistory] = useState<OrderHistoryItem[]>([])\r\n    const [frequentProducts, setFrequentProducts] = useState<FrequentProduct[]>([])\r\n    const [loadingHistory, setLoadingHistory] = useState(false)\r\n\r\n    // New customer form state\r\n    const [newCustomerName, setNewCustomerName] = useState('')\r\n    const [newCustomerPhone, setNewCustomerPhone] = useState('')\r\n    const [newCustomerEmail, setNewCustomerEmail] = useState('')\r\n    const [newCustomerCategoryId, setNewCustomerCategoryId] = useState<string | null>(null)\r\n    const [categories, setCategories] = useState<CustomerCategory[]>([])\r\n    const [saving, setSaving] = useState(false)\r\n    const [formError, setFormError] = useState('')\r\n    const [qrError, setQrError] = useState('')\r\n    const searchAbortRef = useRef<AbortController | null>(null)\r\n\r\n    // Sync customers to offline when online (Story 2.4)\r\n    useEffect(() => {\r\n        if (isOnline) {\r\n            syncCustomersToOffline().catch(err =>\r\n                console.error('[CustomerSearchModal] Error syncing customers:', err)\r\n            )\r\n        }\r\n    }, [isOnline])\r\n\r\n    useEffect(() => {\r\n        // Focus QR input when in scan mode\r\n        if (mode === 'scan' && qrInputRef.current) {\r\n            qrInputRef.current.focus()\r\n        }\r\n    }, [mode])\r\n\r\n    useEffect(() => {\r\n        // Load customer categories for the new customer form\r\n        const fetchCategories = async () => {\r\n            const { data } = await supabase\r\n                .from('customer_categories')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .order('name')\r\n            if (data) setCategories(data)\r\n        }\r\n        fetchCategories()\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        // Search debounce\r\n        if (searchTimeoutRef.current) {\r\n            clearTimeout(searchTimeoutRef.current)\r\n        }\r\n\r\n        if (searchTerm.length >= 2) {\r\n            searchTimeoutRef.current = setTimeout(() => {\r\n                searchCustomers(searchTerm)\r\n            }, 300)\r\n        } else if (searchTerm.length === 0) {\r\n            fetchRecentCustomers()\r\n        }\r\n\r\n        return () => {\r\n            if (searchTimeoutRef.current) {\r\n                clearTimeout(searchTimeoutRef.current)\r\n            }\r\n            // Cancel any pending search on unmount\r\n            if (searchAbortRef.current) {\r\n                searchAbortRef.current.abort()\r\n            }\r\n        }\r\n    }, [searchTerm])\r\n\r\n    useEffect(() => {\r\n        fetchRecentCustomers()\r\n    }, [])\r\n\r\n    // Load favorites when mode changes to favorites (Story 7.3)\r\n    useEffect(() => {\r\n        if (mode === 'favorites' && favoriteIds.length > 0 && isOnline) {\r\n            loadFavoriteCustomers()\r\n        }\r\n    }, [mode, favoriteIds, isOnline])\r\n\r\n    // Load order history when customer detail is shown (Story 7.4)\r\n    useEffect(() => {\r\n        if (selectedDetailCustomer && isOnline) {\r\n            loadCustomerHistory(selectedDetailCustomer.id)\r\n        }\r\n    }, [selectedDetailCustomer, isOnline])\r\n\r\n    // Transform offline customer to Customer type for display\r\n    // Story 6.1: Uses new fields (points_balance, category_slug, loyalty_tier)\r\n    const transformOfflineCustomer = (c: IOfflineCustomer): Customer => ({\r\n        id: c.id,\r\n        name: c.name,\r\n        company_name: null,\r\n        phone: c.phone,\r\n        email: c.email,\r\n        customer_type: c.category_slug === 'wholesale' ? 'b2b' : 'retail',\r\n        category_id: null,\r\n        category: c.category_slug ? {\r\n            name: c.category_slug.charAt(0).toUpperCase() + c.category_slug.slice(1),\r\n            slug: c.category_slug,\r\n            color: c.category_slug === 'wholesale' ? '#3b82f6' :\r\n                   c.category_slug === 'vip' ? '#f59e0b' : '#6366f1',\r\n            price_modifier_type: c.category_slug === 'wholesale' ? 'wholesale_price' : 'none',\r\n            discount_percentage: null,\r\n        } : undefined,\r\n        loyalty_points: c.points_balance,\r\n        loyalty_tier: c.loyalty_tier?.toLowerCase() || 'bronze',\r\n        total_spent: 0,\r\n        membership_number: null,\r\n        loyalty_qr_slug: null,\r\n    })\r\n\r\n    const fetchRecentCustomers = async () => {\r\n        setLoading(true)\r\n        try {\r\n            // Story 2.4: Use offline data when offline\r\n            if (!isOnline) {\r\n                const offlineCustomers = await searchCustomersOffline('')\r\n                setCustomers(offlineCustomers.slice(0, 10).map(transformOfflineCustomer))\r\n                return\r\n            }\r\n\r\n            const { data } = await supabase\r\n                .from('customers')\r\n                .select(`\r\n                    *,\r\n                    category:customer_categories(name, slug, color, price_modifier_type, discount_percentage)\r\n                `)\r\n                .eq('is_active', true)\r\n                .order('last_visit_at', { ascending: false, nullsFirst: false })\r\n                .limit(10)\r\n\r\n            if (data) setCustomers(data as unknown as Customer[])\r\n        } catch (error) {\r\n            console.error('Error fetching customers:', error)\r\n            try {\r\n                const offlineCustomers = await searchCustomersOffline('')\r\n                setCustomers(offlineCustomers.slice(0, 10).map(transformOfflineCustomer))\r\n            } catch (offlineErr) {\r\n                console.error('Error fetching offline customers:', offlineErr)\r\n            }\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const searchCustomers = async (term: string) => {\r\n        // Cancel any pending search request\r\n        if (searchAbortRef.current) {\r\n            searchAbortRef.current.abort()\r\n        }\r\n        searchAbortRef.current = new AbortController()\r\n\r\n        setLoading(true)\r\n        try {\r\n            if (!isOnline) {\r\n                const offlineCustomers = await searchCustomersOffline(term)\r\n                setCustomers(offlineCustomers.map(transformOfflineCustomer))\r\n                return\r\n            }\r\n\r\n            const { data, error } = await supabase\r\n                .from('customers')\r\n                .select(`\r\n                    *,\r\n                    category:customer_categories(name, slug, color, price_modifier_type, discount_percentage)\r\n                `)\r\n                .eq('is_active', true)\r\n                .or(`name.ilike.%${term}%,phone.ilike.%${term}%,email.ilike.%${term}%,company_name.ilike.%${term}%,membership_number.ilike.%${term}%`)\r\n                .limit(20)\r\n                .abortSignal(searchAbortRef.current.signal)\r\n\r\n            if (error) throw error\r\n            if (data) setCustomers(data as unknown as Customer[])\r\n        } catch (error) {\r\n            // Ignore abort errors - they're expected when cancelling\r\n            if (error instanceof Error && error.name === 'AbortError') return\r\n\r\n            console.error('Error searching customers:', error)\r\n            try {\r\n                const offlineCustomers = await searchCustomersOffline(term)\r\n                setCustomers(offlineCustomers.map(transformOfflineCustomer))\r\n            } catch (offlineErr) {\r\n                console.error('Error searching offline customers:', offlineErr)\r\n            }\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    // Load favorite customers (Story 7.3)\r\n    const loadFavoriteCustomers = async () => {\r\n        if (favoriteIds.length === 0) {\r\n            setFavoriteCustomers([])\r\n            return\r\n        }\r\n\r\n        setLoading(true)\r\n        try {\r\n            const { data } = await supabase\r\n                .from('customers')\r\n                .select(`\r\n                    *,\r\n                    category:customer_categories(name, slug, color, price_modifier_type, discount_percentage)\r\n                `)\r\n                .in('id', favoriteIds)\r\n                .eq('is_active', true)\r\n\r\n            if (data) setFavoriteCustomers(data as unknown as Customer[])\r\n        } catch (error) {\r\n            console.error('Error loading favorites:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    // Toggle favorite status (Story 7.3)\r\n    const toggleFavorite = (customerId: string) => {\r\n        setFavoriteIds(prev => {\r\n            const newFavorites = prev.includes(customerId)\r\n                ? prev.filter(id => id !== customerId)\r\n                : [...prev, customerId]\r\n            saveFavorites(newFavorites)\r\n            return newFavorites\r\n        })\r\n    }\r\n\r\n    // Load customer order history and preferences (Story 7.4, 7.5)\r\n    const loadCustomerHistory = async (customerId: string) => {\r\n        setLoadingHistory(true)\r\n        try {\r\n            // Fetch recent orders\r\n            const { data: orders } = await supabase\r\n                .from('orders')\r\n                .select(`\r\n                    id,\r\n                    order_number,\r\n                    created_at,\r\n                    total,\r\n                    order_items (\r\n                        id,\r\n                        product_id,\r\n                        quantity,\r\n                        unit_price,\r\n                        products (name)\r\n                    )\r\n                `)\r\n                .eq('customer_id', customerId)\r\n                .eq('status', 'completed')\r\n                .order('created_at', { ascending: false })\r\n                .limit(10)\r\n\r\n            if (orders) {\r\n                const historyItems: OrderHistoryItem[] = orders.map(order => ({\r\n                    id: order.id,\r\n                    order_number: order.order_number,\r\n                    created_at: order.created_at ?? new Date().toISOString(),\r\n                    total: order.total ?? 0,\r\n                    items: (order.order_items || []).map((item: any) => ({\r\n                        id: item.id,\r\n                        product_id: item.product_id ?? '',\r\n                        product_name: Array.isArray(item.products) ? item.products[0]?.name : item.products?.name || 'Unknown',\r\n                        quantity: item.quantity,\r\n                        unit_price: item.unit_price\r\n                    }))\r\n                }))\r\n                setOrderHistory(historyItems)\r\n            }\r\n\r\n            // Calculate frequent products (Story 7.5)\r\n            const { data: frequentData } = await supabase\r\n                .from('order_items')\r\n                .select(`\r\n                    product_id,\r\n                    quantity,\r\n                    orders!inner (customer_id, created_at),\r\n                    products (name)\r\n                `)\r\n                .eq('orders.customer_id', customerId)\r\n                .order('orders.created_at', { ascending: false })\r\n                .limit(100)\r\n\r\n            if (frequentData) {\r\n                const productMap = new Map<string, { name: string; count: number; lastOrdered: string }>()\r\n                frequentData.forEach((item: any) => {\r\n                    if (!item.product_id) return\r\n                    const existing = productMap.get(item.product_id)\r\n                    const productName = Array.isArray(item.products) ? item.products[0]?.name : item.products?.name || 'Unknown'\r\n                    const orderDate = Array.isArray(item.orders) ? item.orders[0]?.created_at : item.orders?.created_at\r\n                    if (existing) {\r\n                        existing.count += item.quantity\r\n                    } else {\r\n                        productMap.set(item.product_id, {\r\n                            name: productName,\r\n                            count: item.quantity,\r\n                            lastOrdered: orderDate ?? new Date().toISOString()\r\n                        })\r\n                    }\r\n                })\r\n\r\n                const sortedProducts = Array.from(productMap.entries())\r\n                    .sort((a, b) => b[1].count - a[1].count)\r\n                    .slice(0, 5)\r\n                    .map(([productId, data]) => ({\r\n                        product_id: productId,\r\n                        product_name: data.name,\r\n                        times_ordered: data.count,\r\n                        last_ordered: data.lastOrdered\r\n                    }))\r\n\r\n                setFrequentProducts(sortedProducts)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error loading customer history:', error)\r\n        } finally {\r\n            setLoadingHistory(false)\r\n        }\r\n    }\r\n\r\n    const handleQrScan = async () => {\r\n        if (!qrInput.trim()) return\r\n\r\n        setLoading(true)\r\n        setQrError('')\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('customers')\r\n                .select(`\r\n                    *,\r\n                    category:customer_categories(name, slug, color, price_modifier_type, discount_percentage)\r\n                `)\r\n                .or(`loyalty_qr_code.eq.${qrInput.trim()},membership_number.eq.${qrInput.trim()}`)\r\n                .eq('is_active', true)\r\n                .single()\r\n\r\n            if (error || !data) {\r\n                setQrInput('')\r\n                setQrError('Client non trouvé avec ce code QR')\r\n                return\r\n            }\r\n\r\n            onSelectCustomer(data as unknown as Customer)\r\n            onClose()\r\n        } catch (error) {\r\n            console.error('Error scanning QR:', error)\r\n            setQrError('Erreur lors de la recherche')\r\n            setQrInput('')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleQrKeyDown = (e: React.KeyboardEvent) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault()\r\n            handleQrScan()\r\n        }\r\n    }\r\n\r\n    const handleSelectCustomer = (customer: Customer) => {\r\n        onSelectCustomer(customer)\r\n        onClose()\r\n    }\r\n\r\n    const handleRemoveCustomer = () => {\r\n        onSelectCustomer(null)\r\n        onClose()\r\n    }\r\n\r\n    // Show customer detail view (Story 7.4)\r\n    const handleShowDetail = (customer: Customer) => {\r\n        setSelectedDetailCustomer(customer)\r\n    }\r\n\r\n    // Reorder functionality (Story 7.4)\r\n    const handleReorder = async (_order: OrderHistoryItem) => {\r\n        if (selectedDetailCustomer) {\r\n            onSelectCustomer(selectedDetailCustomer)\r\n        }\r\n        onClose()\r\n    }\r\n\r\n    const handleCreateCustomer = async () => {\r\n        if (!newCustomerName.trim()) {\r\n            setFormError('Le nom est obligatoire')\r\n            return\r\n        }\r\n\r\n        setSaving(true)\r\n        setFormError('')\r\n\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('customers')\r\n                .insert({\r\n                    name: newCustomerName.trim(),\r\n                    phone: newCustomerPhone.trim() || null,\r\n                    email: newCustomerEmail.trim() || null,\r\n                    category_id: newCustomerCategoryId,\r\n                    customer_type: 'retail',\r\n                    is_active: true,\r\n                    loyalty_points: 0,\r\n                    loyalty_tier: 'bronze',\r\n                    total_spent: 0,\r\n                    visit_count: 0\r\n                })\r\n                .select(`\r\n                    *,\r\n                    category:customer_categories(name, slug, color, price_modifier_type, discount_percentage)\r\n                `)\r\n                .single()\r\n\r\n            if (error) throw error\r\n\r\n            onSelectCustomer(data as unknown as Customer)\r\n            onClose()\r\n        } catch (error: unknown) {\r\n            console.error('Error creating customer:', error)\r\n            if (error && typeof error === 'object' && 'code' in error && error.code === '23505') {\r\n                setFormError('Un client avec ce téléphone ou email existe déjà')\r\n            } else {\r\n                setFormError('Erreur lors de la création du client')\r\n            }\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    const resetCreateForm = () => {\r\n        setNewCustomerName('')\r\n        setNewCustomerPhone('')\r\n        setNewCustomerEmail('')\r\n        setNewCustomerCategoryId(null)\r\n        setFormError('')\r\n    }\r\n\r\n    const getCategoryIcon = (slug?: string) => {\r\n        switch (slug) {\r\n            case 'wholesale': return <Building2 size={12} />\r\n            case 'vip': return <Crown size={12} />\r\n            case 'staff': return <UserCheck size={12} />\r\n            default: return <User size={12} />\r\n        }\r\n    }\r\n\r\n    const formatDate = (dateStr: string) => {\r\n        const date = new Date(dateStr)\r\n        return date.toLocaleDateString('fr-FR', {\r\n            day: '2-digit',\r\n            month: 'short',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        })\r\n    }\r\n\r\n    // Render customer card\r\n    const renderCustomerCard = (customer: Customer, showFavoriteButton = true) => {\r\n        const isFavorite = favoriteIds.includes(customer.id)\r\n\r\n        return (\r\n            <div\r\n                key={customer.id}\r\n                className={`customer-item ${selectedCustomerId === customer.id ? 'selected' : ''}`}\r\n            >\r\n                <div\r\n                    className=\"customer-item__avatar\"\r\n                    style={{\r\n                        backgroundColor: customer.category?.color || TIER_COLORS[customer.loyalty_tier] || '#6366f1'\r\n                    }}\r\n                    onClick={() => handleSelectCustomer(customer)}\r\n                >\r\n                    {(customer.company_name || customer.name)[0].toUpperCase()}\r\n                </div>\r\n\r\n                <div className=\"customer-item__info\" onClick={() => handleSelectCustomer(customer)}>\r\n                    <div className=\"customer-item__name\">\r\n                        {customer.company_name || customer.name}\r\n                        {selectedCustomerId === customer.id && (\r\n                            <Check size={16} className=\"check-icon\" />\r\n                        )}\r\n                    </div>\r\n                    {customer.company_name && (\r\n                        <span className=\"customer-item__contact\">{customer.name}</span>\r\n                    )}\r\n                    <div className=\"customer-item__details\">\r\n                        {customer.phone && <span>{customer.phone}</span>}\r\n                        {customer.membership_number && (\r\n                            <span className=\"member-number\">\r\n                                <QrCode size={10} />\r\n                                {customer.membership_number}\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"customer-item__meta\">\r\n                    {customer.category && (\r\n                        <span\r\n                            className=\"category-tag\"\r\n                            style={{ backgroundColor: customer.category.color }}\r\n                        >\r\n                            {getCategoryIcon(customer.category.slug)}\r\n                            {customer.category.name}\r\n                        </span>\r\n                    )}\r\n                    <div className=\"loyalty-info\">\r\n                        <span\r\n                            className=\"tier-badge\"\r\n                            style={{ backgroundColor: TIER_COLORS[customer.loyalty_tier] }}\r\n                        >\r\n                            <Star size={10} />\r\n                            {customer.loyalty_tier}\r\n                        </span>\r\n                        <span className=\"points\">\r\n                            {customer.loyalty_points.toLocaleString()} pts\r\n                        </span>\r\n                    </div>\r\n                    {(customer.category?.discount_percentage ?? TIER_DISCOUNTS[customer.loyalty_tier]) > 0 && (\r\n                        <span className=\"discount-badge\">\r\n                            -{customer.category?.discount_percentage || TIER_DISCOUNTS[customer.loyalty_tier]}%\r\n                        </span>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"customer-item__actions-right\">\r\n                    {showFavoriteButton && (\r\n                        <button\r\n                            type=\"button\"\r\n                            className={`btn-favorite ${isFavorite ? 'is-favorite' : ''}`}\r\n                            onClick={(e) => {\r\n                                e.stopPropagation()\r\n                                toggleFavorite(customer.id)\r\n                            }}\r\n                            title={isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}\r\n                        >\r\n                            <Heart size={16} fill={isFavorite ? 'currentColor' : 'none'} />\r\n                        </button>\r\n                    )}\r\n                    {isOnline && (\r\n                        <button\r\n                            type=\"button\"\r\n                            className=\"btn-history\"\r\n                            onClick={(e) => {\r\n                                e.stopPropagation()\r\n                                handleShowDetail(customer)\r\n                            }}\r\n                            title=\"Voir l'historique\"\r\n                        >\r\n                            <History size={16} />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    // Render customer detail view (Story 7.4, 7.5)\r\n    const renderDetailView = () => {\r\n        if (!selectedDetailCustomer) return null\r\n\r\n        return (\r\n            <div className=\"customer-detail\">\r\n                <div className=\"customer-detail__header\">\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn-back\"\r\n                        onClick={() => setSelectedDetailCustomer(null)}\r\n                    >\r\n                        <ChevronLeft size={20} />\r\n                        Retour\r\n                    </button>\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-primary btn-select-customer\"\r\n                        onClick={() => handleSelectCustomer(selectedDetailCustomer)}\r\n                    >\r\n                        <Check size={16} />\r\n                        Select\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"customer-detail__profile\">\r\n                    <div\r\n                        className=\"customer-detail__avatar\"\r\n                        style={{\r\n                            backgroundColor: selectedDetailCustomer.category?.color || TIER_COLORS[selectedDetailCustomer.loyalty_tier] || '#6366f1'\r\n                        }}\r\n                    >\r\n                        {(selectedDetailCustomer.company_name || selectedDetailCustomer.name)[0].toUpperCase()}\r\n                    </div>\r\n                    <div className=\"customer-detail__info\">\r\n                        <h3>{selectedDetailCustomer.company_name || selectedDetailCustomer.name}</h3>\r\n                        {selectedDetailCustomer.phone && <p><Phone size={14} /> {selectedDetailCustomer.phone}</p>}\r\n                        {selectedDetailCustomer.email && <p><Mail size={14} /> {selectedDetailCustomer.email}</p>}\r\n                    </div>\r\n                    <div className=\"customer-detail__loyalty\">\r\n                        <span\r\n                            className=\"tier-badge tier-badge--large\"\r\n                            style={{ backgroundColor: TIER_COLORS[selectedDetailCustomer.loyalty_tier] }}\r\n                        >\r\n                            <Crown size={14} />\r\n                            {selectedDetailCustomer.loyalty_tier}\r\n                        </span>\r\n                        <span className=\"points-large\">\r\n                            {selectedDetailCustomer.loyalty_points.toLocaleString()} pts\r\n                        </span>\r\n                        {(selectedDetailCustomer.category?.discount_percentage ?? TIER_DISCOUNTS[selectedDetailCustomer.loyalty_tier]) > 0 && (\r\n                            <span className=\"discount-badge discount-badge--large\">\r\n                                -{selectedDetailCustomer.category?.discount_percentage || TIER_DISCOUNTS[selectedDetailCustomer.loyalty_tier]}% discount\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {loadingHistory ? (\r\n                    <div className=\"customer-detail__loading\">\r\n                        <div className=\"spinner\"></div>\r\n                        <span>Loading history...</span>\r\n                    </div>\r\n                ) : (\r\n                    <>\r\n                        {/* Frequent products (Story 7.5) */}\r\n                        {frequentProducts.length > 0 && (\r\n                            <div className=\"customer-detail__section\">\r\n                                <h4><Package size={16} /> Produits préférés</h4>\r\n                                <div className=\"frequent-products\">\r\n                                    {frequentProducts.map(product => (\r\n                                        <div key={product.product_id} className=\"frequent-product\">\r\n                                            <span className=\"frequent-product__name\">{product.product_name}</span>\r\n                                            <span className=\"frequent-product__count\">×{product.times_ordered}</span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Order history (Story 7.4) */}\r\n                        <div className=\"customer-detail__section\">\r\n                            <h4><ShoppingBag size={16} /> Order History</h4>\r\n                            {orderHistory.length === 0 ? (\r\n                                <p className=\"no-history\">No previous orders</p>\r\n                            ) : (\r\n                                <div className=\"order-history\">\r\n                                    {orderHistory.map(order => (\r\n                                        <div key={order.id} className=\"order-history__item\">\r\n                                            <div className=\"order-history__header\">\r\n                                                <span className=\"order-history__number\">{order.order_number}</span>\r\n                                                <span className=\"order-history__date\">{formatDate(order.created_at)}</span>\r\n                                                <span className=\"order-history__total\">{formatPrice(order.total)}</span>\r\n                                            </div>\r\n                                            <div className=\"order-history__items\">\r\n                                                {order.items.slice(0, 3).map(item => (\r\n                                                    <span key={item.id} className=\"order-history__product\">\r\n                                                        {item.quantity}× {item.product_name}\r\n                                                    </span>\r\n                                                ))}\r\n                                                {order.items.length > 3 && (\r\n                                                    <span className=\"order-history__more\">\r\n                                                        +{order.items.length - 3} autres\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                className=\"btn-reorder\"\r\n                                                onClick={() => handleReorder(order)}\r\n                                            >\r\n                                                <RotateCcw size={14} />\r\n                                                Recommander\r\n                                            </button>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"customer-search-modal-overlay\" onClick={onClose}>\r\n            <div className=\"customer-search-modal\" onClick={e => e.stopPropagation()}>\r\n                {/* Customer Detail View */}\r\n                {selectedDetailCustomer ? (\r\n                    renderDetailView()\r\n                ) : (\r\n                    <>\r\n                        {/* Header */}\r\n                        <div className=\"customer-search-modal__header\">\r\n                            <h2>\r\n                                {mode === 'search' && <User size={22} />}\r\n                                {mode === 'scan' && <QrCode size={22} />}\r\n                                {mode === 'create' && <UserPlus size={22} />}\r\n                                {mode === 'favorites' && <Heart size={22} />}\r\n                                {mode === 'search' && 'Select a Customer'}\r\n                                {mode === 'scan' && 'Scan Customer QR Code'}\r\n                                {mode === 'create' && 'New Customer'}\r\n                                {mode === 'favorites' && 'Favorite Customers'}\r\n                                {/* Story 6.1 AC4: Offline indicator with data age */}\r\n                                {!isOnline && (\r\n                                    <span style={{ marginLeft: '10px', fontSize: '12px', color: isStale ? '#ef4444' : '#f59e0b', display: 'inline-flex', alignItems: 'center', gap: '4px' }}>\r\n                                        <WifiOff size={14} />\r\n                                        Offline\r\n                                        {ageDisplay && (\r\n                                            <span title={isStale ? 'Data older than 24h' : 'Last sync time'}>\r\n                                                {isStale && <AlertTriangle size={12} style={{ marginLeft: '2px' }} />}\r\n                                                <Clock size={10} style={{ marginLeft: '4px' }} />\r\n                                                {ageDisplay}\r\n                                            </span>\r\n                                        )}\r\n                                    </span>\r\n                                )}\r\n                            </h2>\r\n                            <button className=\"btn-close\" onClick={onClose}>\r\n                                <X size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Mode Toggle */}\r\n                        <div className=\"customer-search-modal__modes\">\r\n                            <button\r\n                                className={`mode-btn ${mode === 'search' ? 'active' : ''}`}\r\n                                onClick={() => setMode('search')}\r\n                            >\r\n                                <Search size={16} />\r\n                                Rechercher\r\n                            </button>\r\n                            <button\r\n                                className={`mode-btn mode-btn--favorites ${mode === 'favorites' ? 'active' : ''}`}\r\n                                onClick={() => setMode('favorites')}\r\n                            >\r\n                                <Heart size={16} />\r\n                                Favoris\r\n                                {favoriteIds.length > 0 && (\r\n                                    <span className=\"mode-btn__badge\">{favoriteIds.length}</span>\r\n                                )}\r\n                            </button>\r\n                            <button\r\n                                className={`mode-btn ${mode === 'scan' ? 'active' : ''} ${!isOnline ? 'disabled' : ''}`}\r\n                                onClick={() => isOnline && setMode('scan')}\r\n                                disabled={!isOnline}\r\n                                title={!isOnline ? 'Nécessite une connexion internet' : ''}\r\n                            >\r\n                                <QrCode size={16} />\r\n                                QR\r\n                            </button>\r\n                            <button\r\n                                className={`mode-btn mode-btn--create ${mode === 'create' ? 'active' : ''} ${!isOnline ? 'disabled' : ''}`}\r\n                                onClick={() => { if (isOnline) { setMode('create'); resetCreateForm() } }}\r\n                                disabled={!isOnline}\r\n                                title={!isOnline ? 'Nécessite une connexion internet' : ''}\r\n                            >\r\n                                <UserPlus size={16} />\r\n                                Nouveau\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Content */}\r\n                        <div className=\"customer-search-modal__content\">\r\n                            {mode === 'create' ? (\r\n                                <div className=\"create-customer-form\">\r\n                                    {formError && (\r\n                                        <div className=\"form-error\">\r\n                                            <X size={16} />\r\n                                            {formError}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <div className=\"form-group\">\r\n                                        <label>\r\n                                            <User size={16} />\r\n                                            Nom *\r\n                                        </label>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={newCustomerName}\r\n                                            onChange={(e) => setNewCustomerName(e.target.value)}\r\n                                            placeholder=\"Nom du client\"\r\n                                            autoFocus\r\n                                        />\r\n                                    </div>\r\n\r\n                                    <div className=\"form-group\">\r\n                                        <label>\r\n                                            <Phone size={16} />\r\n                                            Téléphone\r\n                                        </label>\r\n                                        <input\r\n                                            type=\"tel\"\r\n                                            value={newCustomerPhone}\r\n                                            onChange={(e) => setNewCustomerPhone(e.target.value)}\r\n                                            placeholder=\"+62 812 345 6789\"\r\n                                        />\r\n                                    </div>\r\n\r\n                                    <div className=\"form-group\">\r\n                                        <label>\r\n                                            <Mail size={16} />\r\n                                            Email\r\n                                        </label>\r\n                                        <input\r\n                                            type=\"email\"\r\n                                            value={newCustomerEmail}\r\n                                            onChange={(e) => setNewCustomerEmail(e.target.value)}\r\n                                            placeholder=\"email@exemple.com\"\r\n                                        />\r\n                                    </div>\r\n\r\n                                    <div className=\"form-group\">\r\n                                        <label>\r\n                                            <Crown size={16} />\r\n                                            Catégorie\r\n                                        </label>\r\n                                        <div className=\"category-selector\">\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                className={`category-option ${!newCustomerCategoryId ? 'active' : ''}`}\r\n                                                onClick={() => setNewCustomerCategoryId(null)}\r\n                                            >\r\n                                                <User size={14} />\r\n                                                Standard\r\n                                            </button>\r\n                                            {categories.map(cat => (\r\n                                                <button\r\n                                                    key={cat.id}\r\n                                                    type=\"button\"\r\n                                                    className={`category-option ${newCustomerCategoryId === cat.id ? 'active' : ''}`}\r\n                                                    style={{\r\n                                                        '--category-color': cat.color\r\n                                                    } as React.CSSProperties}\r\n                                                    onClick={() => setNewCustomerCategoryId(cat.id)}\r\n                                                >\r\n                                                    {cat.slug === 'wholesale' && <Building2 size={14} />}\r\n                                                    {cat.slug === 'vip' && <Crown size={14} />}\r\n                                                    {cat.slug === 'staff' && <UserCheck size={14} />}\r\n                                                    {!['wholesale', 'vip', 'staff'].includes(cat.slug) && <User size={14} />}\r\n                                                    {cat.name}\r\n                                                    {cat.discount_percentage && cat.discount_percentage > 0 && (\r\n                                                        <span className=\"discount\">-{cat.discount_percentage}%</span>\r\n                                                    )}\r\n                                                </button>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <button\r\n                                        className=\"btn btn-primary btn-create-customer\"\r\n                                        onClick={handleCreateCustomer}\r\n                                        disabled={saving || !newCustomerName.trim()}\r\n                                    >\r\n                                        <Save size={18} />\r\n                                        {saving ? 'Saving...' : 'Save and Select'}\r\n                                    </button>\r\n                                </div>\r\n                            ) : mode === 'scan' ? (\r\n                                <div className=\"qr-scan-area\">\r\n                                    <div className=\"qr-scan-icon\">\r\n                                        <QrCode size={80} />\r\n                                    </div>\r\n                                    <p className=\"qr-scan-instruction\">\r\n                                        Scan customer QR code or enter member number\r\n                                    </p>\r\n                                    {qrError && (\r\n                                        <div className=\"qr-error\">\r\n                                            <X size={16} />\r\n                                            {qrError}\r\n                                        </div>\r\n                                    )}\r\n                                    <input\r\n                                        ref={qrInputRef}\r\n                                        type=\"text\"\r\n                                        className=\"qr-scan-input\"\r\n                                        value={qrInput}\r\n                                        onChange={(e) => setQrInput(e.target.value)}\r\n                                        onKeyDown={handleQrKeyDown}\r\n                                        placeholder=\"Code QR ou N° Membre...\"\r\n                                        autoFocus\r\n                                    />\r\n                                    <button\r\n                                        className=\"btn btn-primary btn-scan\"\r\n                                        onClick={handleQrScan}\r\n                                        disabled={!qrInput.trim() || loading}\r\n                                    >\r\n                                        {loading ? 'Recherche...' : 'Valider'}\r\n                                    </button>\r\n                                </div>\r\n                            ) : mode === 'favorites' ? (\r\n                                <div className=\"customer-list\">\r\n                                    {loading ? (\r\n                                        <div className=\"customer-list__loading\">\r\n                                            <div className=\"spinner\"></div>\r\n                                            <span>Loading...</span>\r\n                                        </div>\r\n                                    ) : favoriteCustomers.length === 0 ? (\r\n                                        <div className=\"customer-list__empty\">\r\n                                            <Heart size={40} />\r\n                                            <p>Aucun client favori</p>\r\n                                            <span className=\"customer-list__hint\">\r\n                                                Cliquez sur le ♥ pour ajouter des favoris\r\n                                            </span>\r\n                                        </div>\r\n                                    ) : (\r\n                                        favoriteCustomers.map(customer => renderCustomerCard(customer, true))\r\n                                    )}\r\n                                </div>\r\n                            ) : (\r\n                                <>\r\n                                    <div className=\"customer-search-input\">\r\n                                        <Search size={20} />\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={searchTerm}\r\n                                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                                            placeholder=\"Rechercher par nom, téléphone, email...\"\r\n                                            autoFocus\r\n                                        />\r\n                                    </div>\r\n\r\n                                    {selectedCustomerId && (\r\n                                        <button\r\n                                            className=\"btn btn-remove-customer\"\r\n                                            onClick={handleRemoveCustomer}\r\n                                        >\r\n                                            <X size={16} />\r\n                                            Retirer le client sélectionné\r\n                                        </button>\r\n                                    )}\r\n\r\n                                    <div className=\"customer-list\">\r\n                                        {loading ? (\r\n                                            <div className=\"customer-list__loading\">\r\n                                                <div className=\"spinner\"></div>\r\n                                                <span>Loading...</span>\r\n                                            </div>\r\n                                        ) : customers.length === 0 ? (\r\n                                            <div className=\"customer-list__empty\">\r\n                                                <User size={40} />\r\n                                                <p>\r\n                                                    {searchTerm\r\n                                                        ? 'Aucun client trouvé'\r\n                                                        : 'Aucun client récent'}\r\n                                                </p>\r\n                                            </div>\r\n                                        ) : (\r\n                                            customers.map(customer => renderCustomerCard(customer, true))\r\n                                        )}\r\n                                    </div>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\DiscountModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\HeldOrdersModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\ModifierModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\PaymentModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\PinVerificationModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2439,2442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2439,2442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { X, Lock, AlertCircle, Loader2 } from 'lucide-react'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport './PinVerificationModal.css'\r\n\r\ninterface VerifiedUser {\r\n    id: string\r\n    name: string\r\n    role: string\r\n}\r\n\r\ninterface UserForVerification {\r\n    id: string\r\n    name: string\r\n    display_name: string | null\r\n    role: string\r\n}\r\n\r\ninterface PinVerificationModalProps {\r\n    title?: string\r\n    message?: string\r\n    onVerify: (verified: boolean, user?: VerifiedUser) => void\r\n    onClose: () => void\r\n    allowedRoles?: string[]\r\n}\r\n\r\nexport default function PinVerificationModal({\r\n    title = 'Verification Required',\r\n    message = 'Enter a manager PIN to continue',\r\n    onVerify,\r\n    onClose,\r\n    allowedRoles = ['manager', 'admin']\r\n}: PinVerificationModalProps) {\r\n    const [pin, setPin] = useState('')\r\n    const [error, setError] = useState('')\r\n    const [isShaking, setIsShaking] = useState(false)\r\n    const [isVerifying, setIsVerifying] = useState(false)\r\n    const [users, setUsers] = useState<UserForVerification[]>([])\r\n    const [isLoadingUsers, setIsLoadingUsers] = useState(true)\r\n\r\n    // Fetch users with allowed roles on mount\r\n    useEffect(() => {\r\n        async function fetchUsers() {\r\n            setIsLoadingUsers(true)\r\n            try {\r\n                // Get all active users\r\n                const { data: users, error: usersError } = await supabase\r\n                    .from('user_profiles')\r\n                    .select('id, name, display_name, role')\r\n                    .eq('is_active', true)\r\n\r\n                if (usersError) {\r\n                    console.error('Error fetching users:', usersError)\r\n                    setError('Error loading users')\r\n                    return\r\n                }\r\n\r\n                // Get user_roles with role codes\r\n                const { data: userRoles, error: rolesError } = await supabase\r\n                    .from('user_roles')\r\n                    .select('user_id, roles(code)')\r\n\r\n                if (rolesError) {\r\n                    console.error('Error fetching user roles:', rolesError)\r\n                    // Continue with legacy roles only\r\n                }\r\n\r\n                // Build a map of user_id -> role codes\r\n                const userRoleMap = new Map<string, string[]>()\r\n                if (userRoles) {\r\n                    for (const ur of userRoles as any[]) {\r\n                        const roles = ur.roles\r\n                        const roleCode = Array.isArray(roles) ? roles[0]?.code : roles?.code\r\n                        if (roleCode) {\r\n                            const existing = userRoleMap.get(ur.user_id) || []\r\n                            existing.push(roleCode)\r\n                            userRoleMap.set(ur.user_id, existing)\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Normalize allowed roles to lowercase for comparison\r\n                const normalizedAllowedRoles = allowedRoles.map(r => r.toLowerCase())\r\n\r\n                // Filter users that have at least one allowed role (case-insensitive)\r\n                const filteredUsers = (users || []).filter(user => {\r\n                    // Check legacy role field (case-insensitive)\r\n                    if (user.role && normalizedAllowedRoles.includes(user.role.toLowerCase())) {\r\n                        return true\r\n                    }\r\n                    // Check user_roles map (case-insensitive)\r\n                    const roles = userRoleMap.get(user.id)\r\n                    if (roles && roles.length > 0) {\r\n                        return roles.some(r => normalizedAllowedRoles.includes(r.toLowerCase()))\r\n                    }\r\n                    return false\r\n                }).map(user => {\r\n                    // Determine the primary role\r\n                    let primaryRole: string = user.role || 'unknown'\r\n                    const roles = userRoleMap.get(user.id)\r\n                    if (roles && roles.length > 0) {\r\n                        // Use the first role that matches allowed roles (case-insensitive)\r\n                        const matchedRole = roles.find(r => normalizedAllowedRoles.includes(r.toLowerCase()))\r\n                        if (matchedRole) {\r\n                            primaryRole = matchedRole\r\n                        }\r\n                    }\r\n                    return {\r\n                        id: user.id,\r\n                        name: user.name,\r\n                        display_name: user.display_name,\r\n                        role: primaryRole\r\n                    }\r\n                })\r\n\r\n                setUsers(filteredUsers)\r\n            } catch (err) {\r\n                console.error('Error:', err)\r\n                setError('Connection error')\r\n            } finally {\r\n                setIsLoadingUsers(false)\r\n            }\r\n        }\r\n\r\n        fetchUsers()\r\n    }, [allowedRoles])\r\n\r\n    const handleKeyPress = (key: string) => {\r\n        if (isVerifying) return\r\n\r\n        if (key === 'clear') {\r\n            setPin('')\r\n            setError('')\r\n        } else if (key === 'back') {\r\n            setPin(prev => prev.slice(0, -1))\r\n            setError('')\r\n        } else if (pin.length < 6) {\r\n            setPin(prev => prev + key)\r\n            setError('')\r\n        }\r\n    }\r\n\r\n    const handleVerify = async () => {\r\n        if (pin.length < 4) {\r\n            setError('PIN too short')\r\n            return\r\n        }\r\n\r\n        if (users.length === 0) {\r\n            setError('No authorized user found')\r\n            return\r\n        }\r\n\r\n        setIsVerifying(true)\r\n        setError('')\r\n\r\n        try {\r\n            // Try to verify PIN against each allowed user\r\n            for (const user of users) {\r\n                const { data: isValid, error: verifyError } = await supabase.rpc('verify_user_pin', {\r\n                    p_user_id: user.id,\r\n                    p_pin: pin\r\n                })\r\n\r\n                if (verifyError) {\r\n                    console.error('PIN verification error for user', user.id, verifyError)\r\n                    continue\r\n                }\r\n\r\n                if (isValid) {\r\n                    // Found matching user\r\n                    onVerify(true, {\r\n                        id: user.id,\r\n                        name: user.display_name || user.name,\r\n                        role: user.role\r\n                    })\r\n                    return\r\n                }\r\n            }\r\n\r\n            // No matching user found\r\n            setError('Invalid PIN or unauthorized role')\r\n            setIsShaking(true)\r\n            setTimeout(() => setIsShaking(false), 500)\r\n            setPin('')\r\n        } catch (err) {\r\n            console.error('Verification error:', err)\r\n            setError('Verification error')\r\n        } finally {\r\n            setIsVerifying(false)\r\n        }\r\n    }\r\n\r\n    const numpadKeys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', 'clear', '0', 'back']\r\n\r\n    return (\r\n        <div className=\"modal-backdrop is-active\" onClick={(e) => e.target === e.currentTarget && onClose()}>\r\n            <div className={`modal modal-sm is-active pin-modal ${isShaking ? 'shake' : ''}`}>\r\n                <div className=\"modal__header\">\r\n                    <div className=\"pin-modal__icon\">\r\n                        <Lock size={24} />\r\n                    </div>\r\n                    <div>\r\n                        <h3 className=\"modal__title\">{title}</h3>\r\n                        <p className=\"modal__subtitle\">{message}</p>\r\n                    </div>\r\n                    <button className=\"modal__close\" onClick={onClose} title=\"Close\">\r\n                        <X size={24} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"modal__body\">\r\n                    {isLoadingUsers ? (\r\n                        <div className=\"pin-loading\">\r\n                            <Loader2 size={32} className=\"spin\" />\r\n                            <p>Loading...</p>\r\n                        </div>\r\n                    ) : (\r\n                        <>\r\n                            {/* PIN Display */}\r\n                            <div className=\"pin-entry\">\r\n                                <div className=\"pin-display\">\r\n                                    {[...Array(6)].map((_, i) => (\r\n                                        <span key={i} className={`pin-dot ${i < pin.length ? 'filled' : ''}`}>\r\n                                            {i < pin.length ? '●' : '○'}\r\n                                        </span>\r\n                                    ))}\r\n                                </div>\r\n\r\n                                {error && (\r\n                                    <div className=\"pin-error\">\r\n                                        <AlertCircle size={16} />\r\n                                        {error}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Numpad */}\r\n                            <div className=\"numpad\">\r\n                                {numpadKeys.map((key) => (\r\n                                    <button\r\n                                        key={key}\r\n                                        className={`numpad__key ${key === 'clear' || key === 'back' ? 'numpad__key--action' : ''}`}\r\n                                        onClick={() => handleKeyPress(key)}\r\n                                        disabled={isVerifying}\r\n                                    >\r\n                                        {key === 'clear' ? 'C' : key === 'back' ? '←' : key}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"modal__footer\">\r\n                    <button className=\"btn btn-secondary\" onClick={onClose} disabled={isVerifying}>\r\n                        Cancel\r\n                    </button>\r\n                    <button\r\n                        className=\"btn btn-primary\"\r\n                        onClick={handleVerify}\r\n                        disabled={pin.length < 4 || isVerifying || isLoadingUsers}\r\n                    >\r\n                        {isVerifying ? (\r\n                            <>\r\n                                <Loader2 size={16} className=\"spin\" />\r\n                                Verifying...\r\n                            </>\r\n                        ) : (\r\n                            'Verify'\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\RefundModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_user' is assigned a value but never used.","line":54,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * RefundModal Component (F2.5)\r\n *\r\n * Modal for processing full or partial refunds with method selection.\r\n * Requires PIN verification for security.\r\n *\r\n * @see docs/adr/ADR-001-payment-system-refactor.md\r\n * @see src/services/financial/refundService.ts\r\n */\r\n\r\nimport { useState, useCallback, useEffect } from 'react';\r\nimport { X, DollarSign, Loader2 } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport PinVerificationModal from './PinVerificationModal';\r\nimport { processRefund } from '@/services/financial/refundService';\r\nimport { useAuthStore } from '@/stores/authStore';\r\nimport { useNetworkStore } from '@/stores/networkStore';\r\nimport { formatPrice } from '@/utils/helpers';\r\nimport {\r\n  REFUND_REASON_OPTIONS,\r\n  type TRefundReasonCode,\r\n} from '@/services/financial/financialOperationService';\r\nimport type { TPaymentMethod } from '@/types/payment';\r\nimport './RefundModal.css';\r\n\r\ninterface RefundModalProps {\r\n  orderId: string;\r\n  orderNumber: string;\r\n  orderTotal: number;\r\n  originalPaymentMethod: TPaymentMethod;\r\n  paidAt?: string;\r\n  onRefund: () => void;\r\n  onClose: () => void;\r\n}\r\n\r\ntype RefundType = 'full' | 'partial';\r\n\r\nconst REFUND_METHODS: Array<{ id: TPaymentMethod | 'same'; label: string }> = [\r\n  { id: 'same', label: 'Same as original' },\r\n  { id: 'cash', label: 'Cash' },\r\n  { id: 'card', label: 'Card' },\r\n  { id: 'transfer', label: 'Bank Transfer' },\r\n];\r\n\r\nexport default function RefundModal({\r\n  orderId,\r\n  orderNumber,\r\n  orderTotal,\r\n  originalPaymentMethod,\r\n  paidAt,\r\n  onRefund,\r\n  onClose,\r\n}: RefundModalProps) {\r\n  const { user: _user } = useAuthStore();\r\n  const isOnline = useNetworkStore((state) => state.isOnline);\r\n\r\n  // Form state\r\n  const [refundType, setRefundType] = useState<RefundType>('full');\r\n  const [amount, setAmount] = useState<number>(orderTotal);\r\n  const [refundMethod, setRefundMethod] = useState<TPaymentMethod | 'same'>('same');\r\n  const [reasonCode, setReasonCode] = useState<TRefundReasonCode | ''>('');\r\n  const [notes, setNotes] = useState('');\r\n  const [showPinModal, setShowPinModal] = useState(false);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n  // Update amount when refund type changes\r\n  useEffect(() => {\r\n    if (refundType === 'full') {\r\n      setAmount(orderTotal);\r\n    }\r\n  }, [refundType, orderTotal]);\r\n\r\n  // Validation\r\n  const isValidAmount = amount > 0 && amount <= orderTotal;\r\n  const canSubmit = reasonCode !== '' && isValidAmount;\r\n\r\n  // Get actual refund method\r\n  const actualRefundMethod = refundMethod === 'same' ? originalPaymentMethod : refundMethod;\r\n\r\n  // Handle refund button click - show PIN modal\r\n  const handleRefundClick = useCallback(() => {\r\n    if (!canSubmit) {\r\n      if (!isValidAmount) {\r\n        toast.error('Invalid refund amount');\r\n      } else {\r\n        toast.error('Please select a reason');\r\n      }\r\n      return;\r\n    }\r\n    setShowPinModal(true);\r\n  }, [canSubmit, isValidAmount]);\r\n\r\n  // Handle PIN verification\r\n  const handlePinVerified = useCallback(\r\n    async (verified: boolean, verifiedUser?: { id: string; name: string }) => {\r\n      if (!verified || !verifiedUser) {\r\n        setShowPinModal(false);\r\n        return;\r\n      }\r\n\r\n      setShowPinModal(false);\r\n      setIsProcessing(true);\r\n\r\n      try {\r\n        // Construct reason text\r\n        const reasonLabel = REFUND_REASON_OPTIONS.find((o) => o.value === reasonCode)?.label || reasonCode;\r\n        const fullReason = notes ? `${reasonLabel}: ${notes}` : reasonLabel;\r\n\r\n        const result = await processRefund({\r\n          orderId,\r\n          amount,\r\n          reason: fullReason,\r\n          reasonCode: reasonCode as TRefundReasonCode,\r\n          method: actualRefundMethod,\r\n          refundedBy: verifiedUser.id,\r\n        });\r\n\r\n        if (result.success) {\r\n          toast.success(`Refund of ${formatPrice(amount)} processed`);\r\n          if (!isOnline) {\r\n            toast.info('Refund will sync when online');\r\n          }\r\n          onRefund();\r\n          onClose();\r\n        } else {\r\n          toast.error(result.error || 'Failed to process refund');\r\n        }\r\n      } catch (error) {\r\n        console.error('Refund error:', error);\r\n        toast.error('Failed to process refund');\r\n      } finally {\r\n        setIsProcessing(false);\r\n      }\r\n    },\r\n    [orderId, amount, reasonCode, notes, actualRefundMethod, isOnline, onRefund, onClose]\r\n  );\r\n\r\n  // Payment method display name\r\n  const paymentMethodName: string = ({\r\n    cash: 'Cash',\r\n    card: 'Card',\r\n    qris: 'QRIS',\r\n    edc: 'EDC',\r\n    transfer: 'Transfer',\r\n    store_credit: 'Store Credit',\r\n  } as Record<string, string>)[originalPaymentMethod] || originalPaymentMethod;\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        className=\"modal-backdrop is-active\"\r\n        onClick={(e) => e.target === e.currentTarget && onClose()}\r\n      >\r\n        <div className=\"modal modal-md is-active refund-modal\">\r\n          <div className=\"modal__header refund-modal__header\">\r\n            <div className=\"refund-modal__header-content\">\r\n              <DollarSign size={24} className=\"refund-modal__icon\" />\r\n              <h3 className=\"modal__title\">Process Refund</h3>\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              className=\"modal__close\"\r\n              onClick={onClose}\r\n              aria-label=\"Close\"\r\n              disabled={isProcessing}\r\n            >\r\n              <X size={24} />\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"modal__body refund-modal__body\">\r\n            {/* Order Summary */}\r\n            <div className=\"refund-modal__summary\">\r\n              <div className=\"refund-modal__summary-header\">\r\n                <span className=\"refund-modal__order-number\">Order {orderNumber}</span>\r\n              </div>\r\n              <div className=\"refund-modal__summary-details\">\r\n                <div className=\"refund-modal__detail\">\r\n                  <span className=\"refund-modal__detail-label\">Original Total</span>\r\n                  <span className=\"refund-modal__detail-value\">{formatPrice(orderTotal)}</span>\r\n                </div>\r\n                <div className=\"refund-modal__detail\">\r\n                  <span className=\"refund-modal__detail-label\">Payment Method</span>\r\n                  <span className=\"refund-modal__detail-value\">{paymentMethodName}</span>\r\n                </div>\r\n                {paidAt && (\r\n                  <div className=\"refund-modal__detail\">\r\n                    <span className=\"refund-modal__detail-label\">Paid At</span>\r\n                    <span className=\"refund-modal__detail-value\">{paidAt}</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Refund Type Toggle */}\r\n            <div className=\"refund-modal__field\">\r\n              <label className=\"refund-modal__label\">Refund Type</label>\r\n              <div className=\"refund-modal__toggle\">\r\n                <button\r\n                  type=\"button\"\r\n                  className={`refund-modal__toggle-btn ${refundType === 'full' ? 'is-active' : ''}`}\r\n                  onClick={() => setRefundType('full')}\r\n                  disabled={isProcessing}\r\n                >\r\n                  Full Refund\r\n                  <span className=\"refund-modal__toggle-amount\">{formatPrice(orderTotal)}</span>\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  className={`refund-modal__toggle-btn ${refundType === 'partial' ? 'is-active' : ''}`}\r\n                  onClick={() => setRefundType('partial')}\r\n                  disabled={isProcessing}\r\n                >\r\n                  Partial Refund\r\n                  <span className=\"refund-modal__toggle-hint\">Enter amount</span>\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Partial Amount Input */}\r\n            {refundType === 'partial' && (\r\n              <div className=\"refund-modal__field\">\r\n                <label className=\"refund-modal__label\">\r\n                  Refund Amount <span className=\"required\">*</span>\r\n                </label>\r\n                <div className=\"refund-modal__amount-input\">\r\n                  <span className=\"refund-modal__currency\">Rp</span>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={amount.toLocaleString('id-ID')}\r\n                    onChange={(e) => {\r\n                      const value = parseInt(e.target.value.replace(/\\D/g, ''), 10) || 0;\r\n                      setAmount(Math.min(value, orderTotal));\r\n                    }}\r\n                    disabled={isProcessing}\r\n                  />\r\n                </div>\r\n                <span className=\"refund-modal__hint\">Maximum: {formatPrice(orderTotal)}</span>\r\n              </div>\r\n            )}\r\n\r\n            {/* Refund Method */}\r\n            <div className=\"refund-modal__field\">\r\n              <label className=\"refund-modal__label\">Refund Method</label>\r\n              <div className=\"refund-modal__methods\">\r\n                {REFUND_METHODS.map((method) => (\r\n                  <button\r\n                    key={method.id}\r\n                    type=\"button\"\r\n                    className={`refund-modal__method-btn ${refundMethod === method.id ? 'is-active' : ''}`}\r\n                    onClick={() => setRefundMethod(method.id)}\r\n                    disabled={isProcessing}\r\n                  >\r\n                    {method.id === 'same' ? `${method.label} (${paymentMethodName})` : method.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Reason Selection */}\r\n            <div className=\"refund-modal__field\">\r\n              <label className=\"refund-modal__label\">\r\n                Reason for refund <span className=\"required\">*</span>\r\n              </label>\r\n              <select\r\n                className=\"refund-modal__select\"\r\n                value={reasonCode}\r\n                onChange={(e) => setReasonCode(e.target.value as TRefundReasonCode)}\r\n                disabled={isProcessing}\r\n              >\r\n                <option value=\"\">Select a reason...</option>\r\n                {REFUND_REASON_OPTIONS.map((option) => (\r\n                  <option key={option.value} value={option.value}>\r\n                    {option.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n\r\n            {/* Additional Notes */}\r\n            <div className=\"refund-modal__field\">\r\n              <label className=\"refund-modal__label\">Additional notes</label>\r\n              <textarea\r\n                className=\"refund-modal__textarea\"\r\n                value={notes}\r\n                onChange={(e) => setNotes(e.target.value)}\r\n                placeholder=\"Optional notes...\"\r\n                rows={2}\r\n                disabled={isProcessing}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"modal__footer refund-modal__footer\">\r\n            <button\r\n              type=\"button\"\r\n              className=\"btn btn-secondary\"\r\n              onClick={onClose}\r\n              disabled={isProcessing}\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              className=\"btn btn-refund\"\r\n              onClick={handleRefundClick}\r\n              disabled={!canSubmit || isProcessing}\r\n            >\r\n              {isProcessing ? (\r\n                <>\r\n                  <Loader2 size={18} className=\"animate-spin\" />\r\n                  Processing...\r\n                </>\r\n              ) : (\r\n                <>Process Refund ({formatPrice(amount)})</>\r\n              )}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* PIN Verification Modal */}\r\n      {showPinModal && (\r\n        <PinVerificationModal\r\n          title=\"Manager Verification\"\r\n          message={`Enter manager PIN to process ${formatPrice(amount)} refund`}\r\n          allowedRoles={['manager', 'admin']}\r\n          onVerify={handlePinVerified}\r\n          onClose={() => setShowPinModal(false)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\nexport { RefundModal };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\TableSelectionModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_loading' is assigned a value but never used.","line":25,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { Users } from 'lucide-react'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport './TableSelectionModal.css'\r\n\r\ninterface Table {\r\n    id: string\r\n    number: string\r\n    capacity: number\r\n    section: string\r\n    status: 'available' | 'occupied' | 'reserved'\r\n    x?: number\r\n    y?: number\r\n}\r\n\r\ninterface TableSelectionModalProps {\r\n    onSelectTable: (tableNumber: string) => void\r\n    onClose: () => void\r\n}\r\n\r\nexport default function TableSelectionModal({ onSelectTable, onClose: _onClose }: TableSelectionModalProps) {\r\n    const [selectedSection, setSelectedSection] = useState<string>('all')\r\n    const [selectedTable, setSelectedTable] = useState<string | null>(null)\r\n    const [tables, setTables] = useState<Table[]>([])\r\n    const [_loading, setLoading] = useState(true)\r\n\r\n    useEffect(() => {\r\n        fetchTables()\r\n    }, [])\r\n\r\n    const fetchTables = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('floor_plan_items')\r\n                .select('*')\r\n                .eq('type', 'table')\r\n                .order('number')\r\n\r\n            if (error) throw error\r\n            if (data) {\r\n                setTables(data as Table[])\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching tables:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const sections = ['all', ...Array.from(new Set(tables.map(t => t.section)))]\r\n\r\n    const filteredTables = selectedSection === 'all'\r\n        ? tables\r\n        : tables.filter(t => t.section === selectedSection)\r\n\r\n    const handleTableClick = (table: Table) => {\r\n        if (table.status === 'available') {\r\n            setSelectedTable(table.number)\r\n        }\r\n    }\r\n\r\n    const handleConfirm = () => {\r\n        if (selectedTable) {\r\n            onSelectTable(selectedTable)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"modal-backdrop is-active\">\r\n            <div className=\"modal modal-lg is-active\" onClick={e => e.stopPropagation()}>\r\n                {/* Header */}\r\n                <div className=\"modal__header\">\r\n                    <div>\r\n                        <h2 className=\"modal__title\">\r\n                            <Users size={24} />\r\n                            Select a Table\r\n                        </h2>\r\n                        <p className=\"modal__subtitle\">Select an available table for this order (required)</p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <div className=\"modal__body\">\r\n                    {/* Section Selector */}\r\n                    <div className=\"table-selection__sections\">\r\n                        {sections.map(section => (\r\n                            <button\r\n                                key={section}\r\n                                className={`section-btn ${selectedSection === section ? 'is-active' : ''}`}\r\n                                onClick={() => setSelectedSection(section)}\r\n                            >\r\n                                {section === 'all' ? 'All' : section}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Floor Plan View */}\r\n                    <div className=\"table-selection__floor-plan\">\r\n                        {filteredTables.map(table => (\r\n                            <div\r\n                                key={table.id}\r\n                                className={`table-item table-item--${table.status} ${selectedTable === table.number ? 'is-selected' : ''}`}\r\n                                style={{\r\n                                    left: `${table.x}%`,\r\n                                    top: `${table.y}%`,\r\n                                }}\r\n                                onClick={() => handleTableClick(table)}\r\n                            >\r\n                                <div className=\"table-item__number\">T{table.number}</div>\r\n                                <div className=\"table-item__capacity\">\r\n                                    <Users size={12} /> {table.capacity}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Legend */}\r\n                    <div className=\"table-selection__legend\">\r\n                        <div className=\"legend-item\">\r\n                            <span className=\"legend-dot legend-dot--available\"></span>\r\n                            Disponible\r\n                        </div>\r\n                        <div className=\"legend-item\">\r\n                            <span className=\"legend-dot legend-dot--occupied\"></span>\r\n                            Occupée\r\n                        </div>\r\n                        <div className=\"legend-item\">\r\n                            <span className=\"legend-dot legend-dot--reserved\"></span>\r\n                            Réservée\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"modal__footer\">\r\n                    <button\r\n                        className=\"btn btn-primary-lg\"\r\n                        onClick={handleConfirm}\r\n                        disabled={!selectedTable}\r\n                    >\r\n                        Confirmer Table {selectedTable}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\TransactionHistoryModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\VariantModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\VoidModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_user' is assigned a value but never used.","line":45,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * VoidModal Component (F2.4)\r\n *\r\n * Modal for voiding an order with reason selection and PIN verification.\r\n * Red warning theme to indicate destructive action.\r\n *\r\n * @see docs/adr/ADR-001-payment-system-refactor.md\r\n * @see src/services/financial/voidService.ts\r\n */\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { X, AlertTriangle, Loader2 } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport PinVerificationModal from './PinVerificationModal';\r\nimport { voidOrder } from '@/services/financial/voidService';\r\nimport { useAuthStore } from '@/stores/authStore';\r\nimport { useNetworkStore } from '@/stores/networkStore';\r\nimport { formatPrice } from '@/utils/helpers';\r\nimport {\r\n  VOID_REASON_OPTIONS,\r\n  type TVoidReasonCode,\r\n} from '@/services/financial/financialOperationService';\r\nimport type { TPaymentMethod } from '@/types/payment';\r\nimport './VoidModal.css';\r\n\r\ninterface VoidModalProps {\r\n  orderId: string;\r\n  orderNumber: string;\r\n  orderTotal: number;\r\n  paymentMethod: TPaymentMethod;\r\n  orderTime?: string;\r\n  onVoid: () => void;\r\n  onClose: () => void;\r\n}\r\n\r\nexport default function VoidModal({\r\n  orderId,\r\n  orderNumber,\r\n  orderTotal,\r\n  paymentMethod,\r\n  orderTime,\r\n  onVoid,\r\n  onClose,\r\n}: VoidModalProps) {\r\n  const { user: _user } = useAuthStore();\r\n  const isOnline = useNetworkStore((state) => state.isOnline);\r\n\r\n  // Form state\r\n  const [reasonCode, setReasonCode] = useState<TVoidReasonCode | ''>('');\r\n  const [notes, setNotes] = useState('');\r\n  const [showPinModal, setShowPinModal] = useState(false);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n  // Can submit?\r\n  const canSubmit = reasonCode !== '';\r\n\r\n  // Handle void button click - show PIN modal\r\n  const handleVoidClick = useCallback(() => {\r\n    if (!canSubmit) {\r\n      toast.error('Please select a reason');\r\n      return;\r\n    }\r\n    setShowPinModal(true);\r\n  }, [canSubmit]);\r\n\r\n  // Handle PIN verification\r\n  const handlePinVerified = useCallback(\r\n    async (verified: boolean, verifiedUser?: { id: string; name: string }) => {\r\n      if (!verified || !verifiedUser) {\r\n        setShowPinModal(false);\r\n        return;\r\n      }\r\n\r\n      setShowPinModal(false);\r\n      setIsProcessing(true);\r\n\r\n      try {\r\n        // Construct reason text\r\n        const reasonLabel = VOID_REASON_OPTIONS.find((o) => o.value === reasonCode)?.label || reasonCode;\r\n        const fullReason = notes ? `${reasonLabel}: ${notes}` : reasonLabel;\r\n\r\n        const result = await voidOrder({\r\n          orderId,\r\n          reason: fullReason,\r\n          reasonCode: reasonCode as TVoidReasonCode,\r\n          voidedBy: verifiedUser.id,\r\n        });\r\n\r\n        if (result.success) {\r\n          toast.success(`Order ${orderNumber} voided`);\r\n          if (!isOnline) {\r\n            toast.info('Void will sync when online');\r\n          }\r\n          onVoid();\r\n          onClose();\r\n        } else {\r\n          toast.error(result.error || 'Failed to void order');\r\n        }\r\n      } catch (error) {\r\n        console.error('Void error:', error);\r\n        toast.error('Failed to void order');\r\n      } finally {\r\n        setIsProcessing(false);\r\n      }\r\n    },\r\n    [orderId, orderNumber, reasonCode, notes, isOnline, onVoid, onClose]\r\n  );\r\n\r\n  // Payment method display name\r\n  const paymentMethodName: string = ({\r\n    cash: 'Cash',\r\n    card: 'Card',\r\n    qris: 'QRIS',\r\n    edc: 'EDC',\r\n    transfer: 'Transfer',\r\n    store_credit: 'Store Credit',\r\n  } as Record<string, string>)[paymentMethod] || paymentMethod;\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        className=\"modal-backdrop is-active\"\r\n        onClick={(e) => e.target === e.currentTarget && onClose()}\r\n      >\r\n        <div className=\"modal modal-md is-active void-modal\">\r\n          <div className=\"modal__header void-modal__header\">\r\n            <div className=\"void-modal__header-content\">\r\n              <AlertTriangle size={24} className=\"void-modal__icon\" />\r\n              <h3 className=\"modal__title\">Void Order</h3>\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              className=\"modal__close\"\r\n              onClick={onClose}\r\n              aria-label=\"Close\"\r\n              disabled={isProcessing}\r\n            >\r\n              <X size={24} />\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"modal__body void-modal__body\">\r\n            {/* Order Summary */}\r\n            <div className=\"void-modal__summary\">\r\n              <div className=\"void-modal__summary-header\">\r\n                <span className=\"void-modal__order-number\">Order {orderNumber}</span>\r\n              </div>\r\n              <div className=\"void-modal__summary-details\">\r\n                <div className=\"void-modal__detail\">\r\n                  <span className=\"void-modal__detail-label\">Total</span>\r\n                  <span className=\"void-modal__detail-value\">{formatPrice(orderTotal)}</span>\r\n                </div>\r\n                <div className=\"void-modal__detail\">\r\n                  <span className=\"void-modal__detail-label\">Payment</span>\r\n                  <span className=\"void-modal__detail-value\">{paymentMethodName}</span>\r\n                </div>\r\n                {orderTime && (\r\n                  <div className=\"void-modal__detail\">\r\n                    <span className=\"void-modal__detail-label\">Time</span>\r\n                    <span className=\"void-modal__detail-value\">{orderTime}</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Reason Selection */}\r\n            <div className=\"void-modal__field\">\r\n              <label className=\"void-modal__label\">\r\n                Reason for void <span className=\"required\">*</span>\r\n              </label>\r\n              <select\r\n                className=\"void-modal__select\"\r\n                value={reasonCode}\r\n                onChange={(e) => setReasonCode(e.target.value as TVoidReasonCode)}\r\n                disabled={isProcessing}\r\n              >\r\n                <option value=\"\">Select a reason...</option>\r\n                {VOID_REASON_OPTIONS.map((option) => (\r\n                  <option key={option.value} value={option.value}>\r\n                    {option.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n\r\n            {/* Additional Notes */}\r\n            <div className=\"void-modal__field\">\r\n              <label className=\"void-modal__label\">Additional notes</label>\r\n              <textarea\r\n                className=\"void-modal__textarea\"\r\n                value={notes}\r\n                onChange={(e) => setNotes(e.target.value)}\r\n                placeholder=\"Optional notes...\"\r\n                rows={3}\r\n                disabled={isProcessing}\r\n              />\r\n            </div>\r\n\r\n            {/* Warning */}\r\n            <div className=\"void-modal__warning\">\r\n              <AlertTriangle size={16} />\r\n              <span>\r\n                This action cannot be undone.\r\n                {paymentMethod === 'cash' && ' A cash refund may be required.'}\r\n              </span>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"modal__footer void-modal__footer\">\r\n            <button\r\n              type=\"button\"\r\n              className=\"btn btn-secondary\"\r\n              onClick={onClose}\r\n              disabled={isProcessing}\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              className=\"btn btn-danger\"\r\n              onClick={handleVoidClick}\r\n              disabled={!canSubmit || isProcessing}\r\n            >\r\n              {isProcessing ? (\r\n                <>\r\n                  <Loader2 size={18} className=\"animate-spin\" />\r\n                  Processing...\r\n                </>\r\n              ) : (\r\n                'Void Order'\r\n              )}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* PIN Verification Modal */}\r\n      {showPinModal && (\r\n        <PinVerificationModal\r\n          title=\"Manager Verification\"\r\n          message={`Enter manager PIN to void order ${orderNumber}`}\r\n          allowedRoles={['manager', 'admin']}\r\n          onVerify={handlePinVerified}\r\n          onClose={() => setShowPinModal(false)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\nexport { VoidModal };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\modals\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\shift\\CloseShiftModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\shift\\OpenShiftModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\shift\\ShiftHistoryModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2493,2496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2493,2496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useRef, useEffect, useState } from 'react'\r\nimport { X, Calendar, Clock, Banknote, TrendingUp, AlertCircle, CheckCircle } from 'lucide-react'\r\nimport { supabase } from '../../../lib/supabase'\r\nimport { formatCurrency, formatDateTime } from '../../../utils/helpers'\r\nimport './ShiftHistoryModal.css'\r\n\r\ninterface ShiftSession {\r\n    id: string\r\n    session_number: string\r\n    user_id: string\r\n    user_name?: string\r\n    status: 'open' | 'closed' | 'reconciled'\r\n    opened_at: string\r\n    closed_at: string | null\r\n    opening_cash: number\r\n    total_sales: number\r\n    transaction_count: number\r\n    actual_cash: number | null\r\n    actual_qris: number | null\r\n    actual_edc: number | null\r\n    cash_difference: number | null\r\n    qris_difference: number | null\r\n    edc_difference: number | null\r\n    notes: string | null\r\n}\r\n\r\ninterface ShiftHistoryModalProps {\r\n    onClose: () => void\r\n}\r\n\r\nexport default function ShiftHistoryModal({ onClose }: ShiftHistoryModalProps) {\r\n    const modalRef = useRef<HTMLDivElement>(null)\r\n    const [sessions, setSessions] = useState<ShiftSession[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [selectedSession, setSelectedSession] = useState<ShiftSession | null>(null)\r\n\r\n    useEffect(() => {\r\n        loadHistory()\r\n    }, [])\r\n\r\n    // Close on backdrop click\r\n    useEffect(() => {\r\n        const handleClick = (e: MouseEvent) => {\r\n            if (modalRef.current && !modalRef.current.contains(e.target as Node)) {\r\n                onClose()\r\n            }\r\n        }\r\n        document.addEventListener('mousedown', handleClick)\r\n        return () => document.removeEventListener('mousedown', handleClick)\r\n    }, [onClose])\r\n\r\n    // Close on escape\r\n    useEffect(() => {\r\n        const handleEsc = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') onClose()\r\n        }\r\n        document.addEventListener('keydown', handleEsc)\r\n        return () => document.removeEventListener('keydown', handleEsc)\r\n    }, [onClose])\r\n\r\n    const loadHistory = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('pos_sessions')\r\n                .select(`\r\n                    *,\r\n                    user:user_profiles(name)\r\n                `)\r\n                .neq('status', 'open')\r\n                .order('closed_at', { ascending: false })\r\n                .limit(20)\r\n\r\n            if (error) throw error\r\n\r\n            const formatted = (data || []).map((s: any) => ({\r\n                ...s,\r\n                user_name: s.user?.name || 'Inconnu'\r\n            }))\r\n\r\n            setSessions(formatted)\r\n        } catch (error) {\r\n            console.error('Error loading shift history:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const getDuration = (opened: string, closed: string | null) => {\r\n        if (!closed) return '-'\r\n        const start = new Date(opened)\r\n        const end = new Date(closed)\r\n        const minutes = Math.floor((end.getTime() - start.getTime()) / 1000 / 60)\r\n        const hours = Math.floor(minutes / 60)\r\n        const mins = minutes % 60\r\n        return `${hours}h ${mins}m`\r\n    }\r\n\r\n    const getTotalDifference = (session: ShiftSession) => {\r\n        const cash = session.cash_difference || 0\r\n        const qris = session.qris_difference || 0\r\n        const edc = session.edc_difference || 0\r\n        return cash + qris + edc\r\n    }\r\n\r\n    const getDifferenceStatus = (diff: number) => {\r\n        if (diff === 0) return 'perfect'\r\n        if (Math.abs(diff) <= 5000) return 'minor'\r\n        return 'significant'\r\n    }\r\n\r\n    return (\r\n        <div className=\"shift-history-overlay\">\r\n            <div className=\"shift-history-modal\" ref={modalRef}>\r\n                {/* Header */}\r\n                <header className=\"shift-history__header\">\r\n                    <div className=\"shift-history__title-group\">\r\n                        <Calendar className=\"shift-history__icon\" />\r\n                        <h2>Shift History</h2>\r\n                    </div>\r\n                    <button className=\"shift-history__close\" onClick={onClose}>\r\n                        <X size={24} />\r\n                    </button>\r\n                </header>\r\n\r\n                {/* Content */}\r\n                <div className=\"shift-history__content\">\r\n                    {loading ? (\r\n                        <div className=\"shift-history__loading\">\r\n                            <div className=\"shift-history__spinner\" />\r\n                            <span>Loading...</span>\r\n                        </div>\r\n                    ) : sessions.length === 0 ? (\r\n                        <div className=\"shift-history__empty\">\r\n                            <Calendar size={48} />\r\n                            <p>No shift history</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"shift-history__list\">\r\n                            {sessions.map((session) => {\r\n                                const totalDiff = getTotalDifference(session)\r\n                                const diffStatus = getDifferenceStatus(totalDiff)\r\n                                const isExpanded = selectedSession?.id === session.id\r\n\r\n                                return (\r\n                                    <div\r\n                                        key={session.id}\r\n                                        className={`shift-history__card ${isExpanded ? 'is-expanded' : ''}`}\r\n                                        onClick={() => setSelectedSession(isExpanded ? null : session)}\r\n                                    >\r\n                                        {/* Card Header */}\r\n                                        <div className=\"shift-history__card-header\">\r\n                                            <div className=\"shift-history__card-main\">\r\n                                                <span className=\"shift-history__session-number\">\r\n                                                    #{session.session_number}\r\n                                                </span>\r\n                                                <span className=\"shift-history__user\">\r\n                                                    {session.user_name}\r\n                                                </span>\r\n                                            </div>\r\n                                            <div className=\"shift-history__card-meta\">\r\n                                                <span className=\"shift-history__date\">\r\n                                                    {formatDateTime(session.closed_at || session.opened_at)}\r\n                                                </span>\r\n                                                <span className={`shift-history__status shift-history__status--${diffStatus}`}>\r\n                                                    {diffStatus === 'perfect' && <CheckCircle size={14} />}\r\n                                                    {diffStatus === 'minor' && <TrendingUp size={14} />}\r\n                                                    {diffStatus === 'significant' && <AlertCircle size={14} />}\r\n                                                    {totalDiff === 0 ? 'OK' : formatCurrency(totalDiff)}\r\n                                                </span>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* Card Summary */}\r\n                                        <div className=\"shift-history__card-summary\">\r\n                                            <div className=\"shift-history__stat\">\r\n                                                <Banknote size={16} />\r\n                                                <span>{formatCurrency(session.total_sales)}</span>\r\n                                            </div>\r\n                                            <div className=\"shift-history__stat\">\r\n                                                <TrendingUp size={16} />\r\n                                                <span>{session.transaction_count} trans.</span>\r\n                                            </div>\r\n                                            <div className=\"shift-history__stat\">\r\n                                                <Clock size={16} />\r\n                                                <span>{getDuration(session.opened_at, session.closed_at)}</span>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* Expanded Details */}\r\n                                        {isExpanded && (\r\n                                            <div className=\"shift-history__details\">\r\n                                                <div className=\"shift-history__detail-grid\">\r\n                                                    <div className=\"shift-history__detail-item\">\r\n                                                        <span className=\"shift-history__detail-label\">\r\n                                                            Opening cash\r\n                                                        </span>\r\n                                                        <span className=\"shift-history__detail-value\">\r\n                                                            {formatCurrency(session.opening_cash)}\r\n                                                        </span>\r\n                                                    </div>\r\n\r\n                                                    <div className=\"shift-history__detail-item\">\r\n                                                        <span className=\"shift-history__detail-label\">\r\n                                                            Cash collected\r\n                                                        </span>\r\n                                                        <span className=\"shift-history__detail-value\">\r\n                                                            {formatCurrency(session.actual_cash || 0)}\r\n                                                            {session.cash_difference !== 0 && session.cash_difference !== null && (\r\n                                                                <span className={`shift-history__diff ${session.cash_difference > 0 ? 'positive' : 'negative'}`}>\r\n                                                                    ({session.cash_difference > 0 ? '+' : ''}{formatCurrency(session.cash_difference)})\r\n                                                                </span>\r\n                                                            )}\r\n                                                        </span>\r\n                                                    </div>\r\n\r\n                                                    <div className=\"shift-history__detail-item\">\r\n                                                        <span className=\"shift-history__detail-label\">QRIS</span>\r\n                                                        <span className=\"shift-history__detail-value\">\r\n                                                            {formatCurrency(session.actual_qris || 0)}\r\n                                                            {session.qris_difference !== 0 && session.qris_difference !== null && (\r\n                                                                <span className={`shift-history__diff ${session.qris_difference > 0 ? 'positive' : 'negative'}`}>\r\n                                                                    ({session.qris_difference > 0 ? '+' : ''}{formatCurrency(session.qris_difference)})\r\n                                                                </span>\r\n                                                            )}\r\n                                                        </span>\r\n                                                    </div>\r\n\r\n                                                    <div className=\"shift-history__detail-item\">\r\n                                                        <span className=\"shift-history__detail-label\">EDC/Carte</span>\r\n                                                        <span className=\"shift-history__detail-value\">\r\n                                                            {formatCurrency(session.actual_edc || 0)}\r\n                                                            {session.edc_difference !== 0 && session.edc_difference !== null && (\r\n                                                                <span className={`shift-history__diff ${session.edc_difference > 0 ? 'positive' : 'negative'}`}>\r\n                                                                    ({session.edc_difference > 0 ? '+' : ''}{formatCurrency(session.edc_difference)})\r\n                                                                </span>\r\n                                                            )}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                </div>\r\n\r\n                                                {session.notes && (\r\n                                                    <div className=\"shift-history__notes\">\r\n                                                        <strong>Notes:</strong> {session.notes}\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\shift\\ShiftReconciliationModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\shift\\ShiftStatsModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\pos\\shift\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\products\\ProductImportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\products\\RecipeImportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POCancelModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\PODetailHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POHistoryTimeline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POInfoCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POItemsTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POReturnModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POReturnsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\POSummarySidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\purchasing\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\DateRangePicker\\DatePresets.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\DateRangePicker\\DateRangePicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\DateRangePicker\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\ExportButtons\\ExportButtons.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[619,622],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[619,622],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1092,1095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1092,1095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1426,1429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1426,1429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":189,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5941,5944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5941,5944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":196,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6149,6152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6149,6152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\ExportButtons\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\ReportFilters\\FilterDropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\ReportFilters\\ReportFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\reports\\ReportFilters\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\FloorPlanEditor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\ModuleSettingsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\NotificationSettingsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\POSAdvancedSettingsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\SettingField.tsx","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":145,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":145,"endColumn":74},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":166,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":168,"endColumn":33}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { RotateCcw, Eye, EyeOff } from 'lucide-react';\r\nimport type { Setting, ValidationRules } from '../../types/settings';\r\nimport './SettingField.css';\r\n\r\ninterface SettingFieldProps {\r\n  setting: Setting;\r\n  value: unknown;\r\n  onChange: (value: unknown) => void;\r\n  onReset?: () => void;\r\n  disabled?: boolean;\r\n  showReset?: boolean;\r\n}\r\n\r\nconst SettingField: React.FC<SettingFieldProps> = ({\r\n  setting,\r\n  value,\r\n  onChange,\r\n  onReset,\r\n  disabled = false,\r\n  showReset = true,\r\n}) => {\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [localValue, setLocalValue] = useState(value);\r\n\r\n  // Use English\r\n  const name = setting.name_en;\r\n  const description = setting.description_en;\r\n\r\n  // Parse value from JSONB\r\n  const parseValue = (val: unknown): unknown => {\r\n    if (typeof val === 'string') {\r\n      try {\r\n        return JSON.parse(val);\r\n      } catch {\r\n        return val;\r\n      }\r\n    }\r\n    return val;\r\n  };\r\n\r\n  const parsedValue = parseValue(localValue);\r\n\r\n  // Sync local value with prop\r\n  useEffect(() => {\r\n    setLocalValue(value);\r\n  }, [value]);\r\n\r\n  // Handle value change with validation\r\n  const handleChange = (newValue: unknown) => {\r\n    setLocalValue(newValue);\r\n    onChange(newValue);\r\n  };\r\n\r\n  // Check if value has changed from default\r\n  const hasChanged = setting.default_value !== undefined &&\r\n    JSON.stringify(parsedValue) !== JSON.stringify(parseValue(setting.default_value));\r\n\r\n  // Render based on value type\r\n  const renderField = () => {\r\n    const validation = setting.validation_rules as ValidationRules | undefined;\r\n\r\n    switch (setting.value_type) {\r\n      case 'boolean':\r\n        return (\r\n          <div\r\n            className={`setting-toggle ${parsedValue ? 'is-on' : ''} ${disabled ? 'is-disabled' : ''}`}\r\n            onClick={() => !disabled && handleChange(!parsedValue)}\r\n            role=\"switch\"\r\n            aria-checked={!!parsedValue}\r\n            tabIndex={0}\r\n            onKeyDown={(e) => e.key === 'Enter' && !disabled && handleChange(!parsedValue)}\r\n          />\r\n        );\r\n\r\n      case 'number':\r\n        return (\r\n          <input\r\n            type=\"number\"\r\n            className=\"setting-input setting-input--number\"\r\n            value={parsedValue as number ?? ''}\r\n            onChange={(e) => handleChange(e.target.value === '' ? null : Number(e.target.value))}\r\n            min={validation?.min}\r\n            max={validation?.max}\r\n            disabled={disabled}\r\n          />\r\n        );\r\n\r\n      case 'string':\r\n        // Check if it's a select from options\r\n        if (validation?.options && validation.options.length > 0) {\r\n          return (\r\n            <select\r\n              className=\"setting-input setting-input--select\"\r\n              value={parsedValue as string ?? ''}\r\n              onChange={(e) => handleChange(e.target.value)}\r\n              disabled={disabled}\r\n            >\r\n              {validation.options.map((option) => (\r\n                <option key={option} value={option}>\r\n                  {option}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          );\r\n        }\r\n\r\n        // Sensitive field (password)\r\n        if (setting.is_sensitive) {\r\n          return (\r\n            <div className=\"setting-input-wrapper\">\r\n              <input\r\n                type={showPassword ? 'text' : 'password'}\r\n                className=\"setting-input setting-input--password\"\r\n                value={parsedValue as string ?? ''}\r\n                onChange={(e) => handleChange(e.target.value)}\r\n                disabled={disabled}\r\n                autoComplete=\"off\"\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                className=\"setting-input__toggle\"\r\n                onClick={() => setShowPassword(!showPassword)}\r\n                tabIndex={-1}\r\n              >\r\n                {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}\r\n              </button>\r\n            </div>\r\n          );\r\n        }\r\n\r\n        // Regular string input\r\n        return (\r\n          <input\r\n            type=\"text\"\r\n            className=\"setting-input\"\r\n            value={parsedValue as string ?? ''}\r\n            onChange={(e) => handleChange(e.target.value)}\r\n            disabled={disabled}\r\n          />\r\n        );\r\n\r\n      case 'array':\r\n        // Render as comma-separated input for simple arrays\r\n        const arrayValue = Array.isArray(parsedValue) ? parsedValue : [];\r\n        return (\r\n          <input\r\n            type=\"text\"\r\n            className=\"setting-input\"\r\n            value={arrayValue.join(', ')}\r\n            onChange={(e) => {\r\n              const items = e.target.value.split(',').map((s) => {\r\n                const trimmed = s.trim();\r\n                const num = Number(trimmed);\r\n                return isNaN(num) ? trimmed : num;\r\n              });\r\n              handleChange(items);\r\n            }}\r\n            placeholder=\"valeur1, valeur2, valeur3\"\r\n            disabled={disabled}\r\n          />\r\n        );\r\n\r\n      case 'json':\r\n        // For JSON, render a textarea with formatted JSON\r\n        const jsonString = typeof parsedValue === 'object'\r\n          ? JSON.stringify(parsedValue, null, 2)\r\n          : String(parsedValue);\r\n        return (\r\n          <textarea\r\n            className=\"setting-input setting-input--textarea\"\r\n            value={jsonString}\r\n            onChange={(e) => {\r\n              try {\r\n                const parsed = JSON.parse(e.target.value);\r\n                handleChange(parsed);\r\n              } catch {\r\n                // Keep as string if invalid JSON\r\n              }\r\n            }}\r\n            disabled={disabled}\r\n            rows={4}\r\n          />\r\n        );\r\n\r\n      case 'file':\r\n        return (\r\n          <div className=\"setting-file\">\r\n            <input\r\n              type=\"file\"\r\n              className=\"setting-file__input\"\r\n              onChange={(e) => {\r\n                const file = e.target.files?.[0];\r\n                if (file) {\r\n                  // Handle file upload - for now just store the name\r\n                  handleChange(file.name);\r\n                }\r\n              }}\r\n              disabled={disabled}\r\n              accept=\"image/*\"\r\n            />\r\n            {parsedValue != null && (\r\n              <span className=\"setting-file__name\">{String(parsedValue)}</span>\r\n            )}\r\n          </div>\r\n        );\r\n\r\n      default:\r\n        return (\r\n          <input\r\n            type=\"text\"\r\n            className=\"setting-input\"\r\n            value={String(parsedValue ?? '')}\r\n            onChange={(e) => handleChange(e.target.value)}\r\n            disabled={disabled}\r\n          />\r\n        );\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className={`setting-field ${setting.value_type === 'boolean' ? 'setting-field--toggle' : ''}`}>\r\n      <div className=\"setting-field__header\">\r\n        <div className=\"setting-field__label-group\">\r\n          <label className=\"setting-field__label\">\r\n            {name}\r\n            {setting.requires_restart && (\r\n              <span className=\"setting-field__restart-badge\" title=\"Nécessite un redémarrage\">\r\n                Restart\r\n              </span>\r\n            )}\r\n          </label>\r\n          {description && (\r\n            <p className=\"setting-field__description\">{description}</p>\r\n          )}\r\n        </div>\r\n        {setting.value_type !== 'boolean' && (\r\n          <div className=\"setting-field__actions\">\r\n            {showReset && hasChanged && onReset && (\r\n              <button\r\n                type=\"button\"\r\n                className=\"setting-field__reset\"\r\n                onClick={onReset}\r\n                title=\"Réinitialiser\"\r\n              >\r\n                <RotateCcw size={14} />\r\n              </button>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n      <div className=\"setting-field__control\">\r\n        {renderField()}\r\n        {setting.value_type === 'boolean' && showReset && hasChanged && onReset && (\r\n          <button\r\n            type=\"button\"\r\n            className=\"setting-field__reset setting-field__reset--inline\"\r\n            onClick={onReset}\r\n            title=\"Réinitialiser\"\r\n          >\r\n            <RotateCcw size={14} />\r\n          </button>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SettingField;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\TerminalRegistrationModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\settings\\TerminalSettingsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\sync\\PendingSyncCounter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\sync\\PendingSyncItem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\sync\\PendingSyncPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\sync\\PostOfflineSyncReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\sync\\SyncStatusBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\sync\\__tests__\\PendingSyncCounter.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\Input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\NetworkIndicator.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\NetworkIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\OfflineSessionIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\SyncIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\toaster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\constants\\__tests__\\sensitivePermissions.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\constants\\inventory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\constants\\loyalty.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\constants\\offline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\constants\\sensitivePermissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\data\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\data\\mockCategories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\customers\\__tests__\\useCustomersOffline.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\customers\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\customers\\useCustomersOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\__tests__\\useInternalTransfers.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\__tests__\\useLocations.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useInternalTransfers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useInventoryAlerts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useInventoryItems.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useLocations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useProductRecipe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useSections.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useStockAdjustment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useStockMovements.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\inventory\\useStockReservations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\__tests__\\useKdsOrderQueue.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\__tests__\\useKdsOrderReceiver.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\__tests__\\useOrderAutoRemove.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\useKdsOrderQueue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\useKdsOrderReceiver.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\kds\\useOrderAutoRemove.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\lan\\__tests__\\useLanClient.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\lan\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\lan\\useLanClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\lan\\useLanHub.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\__tests__\\useCategoriesOffline.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":122,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3099,3102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3099,3102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":143,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3736,3739],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3736,3739],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4243,4246],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4243,4246],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":182,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4812,4815],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4812,4815],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":260,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":260,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7545,7548],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7545,7548],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":306,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9116,9119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9116,9119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":327,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9694,9697],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9694,9697],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * useCategoriesOffline Hook Tests (Story 2.2)\r\n *\r\n * Tests for offline categories hook functionality.\r\n */\r\n\r\nimport { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';\r\nimport { renderHook, waitFor } from '@testing-library/react';\r\nimport 'fake-indexeddb/auto';\r\n\r\n// Mock useNetworkStatus\r\nvi.mock('../useNetworkStatus', () => ({\r\n  useNetworkStatus: vi.fn(),\r\n}));\r\n\r\n// Mock useCategories\r\nvi.mock('../../products/useCategories', () => ({\r\n  useCategories: vi.fn(),\r\n}));\r\n\r\n// Mock categoriesCacheService\r\nvi.mock('@/services/offline/categoriesCacheService', () => ({\r\n  getCachedCategories: vi.fn(),\r\n  getLastCategoriesSyncAt: vi.fn(),\r\n}));\r\n\r\nimport { useNetworkStatus } from '../useNetworkStatus';\r\nimport { useCategories } from '../../products/useCategories';\r\nimport {\r\n  getCachedCategories,\r\n  getLastCategoriesSyncAt,\r\n} from '@/services/offline/categoriesCacheService';\r\nimport {\r\n  useCategoriesOffline,\r\n  useOfflineCategoriesRaw,\r\n} from '../useCategoriesOffline';\r\nimport { db } from '@/lib/db';\r\nimport type { IOfflineCategory } from '@/types/offline';\r\nimport type { Category } from '@/types/database';\r\n\r\n// Test data\r\nconst mockOfflineCategories: IOfflineCategory[] = [\r\n  {\r\n    id: 'cat-1',\r\n    name: 'Viennoiseries',\r\n    icon: 'croissant',\r\n    color: '#F5DEB3',\r\n    sort_order: 1,\r\n    dispatch_station: 'kitchen',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n  {\r\n    id: 'cat-2',\r\n    name: 'Boissons',\r\n    icon: 'coffee',\r\n    color: '#8B4513',\r\n    sort_order: 2,\r\n    dispatch_station: 'barista',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n];\r\n\r\nconst mockOnlineCategories: Category[] = [\r\n  {\r\n    id: 'cat-1',\r\n    name: 'Viennoiseries',\r\n    icon: 'croissant',\r\n    color: '#F5DEB3',\r\n    sort_order: 1,\r\n    dispatch_station: 'kitchen',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n    created_at: '2026-01-01T00:00:00Z',\r\n  },\r\n  {\r\n    id: 'cat-2',\r\n    name: 'Boissons',\r\n    icon: 'coffee',\r\n    color: '#8B4513',\r\n    sort_order: 2,\r\n    dispatch_station: 'barista',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n    created_at: '2026-01-01T00:00:00Z',\r\n  },\r\n];\r\n\r\ndescribe('useCategoriesOffline', () => {\r\n  beforeEach(async () => {\r\n    await db.offline_categories.clear();\r\n    await db.offline_sync_meta.delete('categories');\r\n    vi.clearAllMocks();\r\n  });\r\n\r\n  afterEach(() => {\r\n    vi.restoreAllMocks();\r\n  });\r\n\r\n  describe('Online mode', () => {\r\n    beforeEach(() => {\r\n      vi.mocked(useNetworkStatus).mockReturnValue({\r\n        isOnline: true,\r\n        isOffline: false,\r\n        checkNetwork: vi.fn(),\r\n      });\r\n    });\r\n\r\n    it('should use online data when online', async () => {\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: mockOnlineCategories,\r\n        isLoading: false,\r\n        error: null,\r\n        isError: false,\r\n        isSuccess: true,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isLoading).toBe(false);\r\n      });\r\n\r\n      expect(result.current.data).toEqual(mockOnlineCategories);\r\n      expect(result.current.isOffline).toBe(false);\r\n      expect(result.current.lastSyncAt).toBeNull();\r\n    });\r\n\r\n    it('should return loading state from online hook', () => {\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: undefined,\r\n        isLoading: true,\r\n        error: null,\r\n        isError: false,\r\n        isSuccess: false,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      expect(result.current.isLoading).toBe(true);\r\n      expect(result.current.data).toBeUndefined();\r\n    });\r\n\r\n    it('should return error from online hook', () => {\r\n      const error = new Error('Network error');\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: undefined,\r\n        isLoading: false,\r\n        error,\r\n        isError: true,\r\n        isSuccess: false,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      expect(result.current.error).toBe(error);\r\n    });\r\n  });\r\n\r\n  describe('Offline mode', () => {\r\n    beforeEach(() => {\r\n      vi.mocked(useNetworkStatus).mockReturnValue({\r\n        isOnline: false,\r\n        isOffline: true,\r\n        checkNetwork: vi.fn(),\r\n      });\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: undefined,\r\n        isLoading: false,\r\n        error: null,\r\n        isError: false,\r\n        isSuccess: false,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n    });\r\n\r\n    it('should use cached data when offline', async () => {\r\n      vi.mocked(getCachedCategories).mockResolvedValue(mockOfflineCategories);\r\n      vi.mocked(getLastCategoriesSyncAt).mockResolvedValue('2026-01-30T10:00:00Z');\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isLoading).toBe(false);\r\n      });\r\n\r\n      expect(result.current.isOffline).toBe(true);\r\n      expect(result.current.data).toHaveLength(2);\r\n      expect(result.current.lastSyncAt).toBe('2026-01-30T10:00:00Z');\r\n    });\r\n\r\n    it('should convert offline categories to Category type', async () => {\r\n      vi.mocked(getCachedCategories).mockResolvedValue(mockOfflineCategories);\r\n      vi.mocked(getLastCategoriesSyncAt).mockResolvedValue(null);\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.data).toBeDefined();\r\n      });\r\n\r\n      const category = result.current.data?.[0];\r\n      expect(category?.id).toBe('cat-1');\r\n      expect(category?.name).toBe('Viennoiseries');\r\n      expect(category?.dispatch_station).toBe('kitchen');\r\n      expect(category?.created_at).toBeNull(); // Not cached\r\n    });\r\n\r\n    it('should return empty array on cache error', async () => {\r\n      vi.mocked(getCachedCategories).mockRejectedValue(new Error('DB error'));\r\n      vi.mocked(getLastCategoriesSyncAt).mockResolvedValue(null);\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isLoading).toBe(false);\r\n      });\r\n\r\n      expect(result.current.data).toEqual([]);\r\n      expect(result.current.error).toBeNull();\r\n    });\r\n\r\n    it('should set error to null when offline', async () => {\r\n      vi.mocked(getCachedCategories).mockResolvedValue(mockOfflineCategories);\r\n      vi.mocked(getLastCategoriesSyncAt).mockResolvedValue(null);\r\n\r\n      const { result } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isLoading).toBe(false);\r\n      });\r\n\r\n      expect(result.current.error).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('Online/Offline transition', () => {\r\n    it('should switch from online to offline data when network changes', async () => {\r\n      // Start online\r\n      vi.mocked(useNetworkStatus).mockReturnValue({\r\n        isOnline: true,\r\n        isOffline: false,\r\n        checkNetwork: vi.fn(),\r\n      });\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: mockOnlineCategories,\r\n        isLoading: false,\r\n        error: null,\r\n        isError: false,\r\n        isSuccess: true,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n\r\n      const { result, rerender } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isOffline).toBe(false);\r\n      });\r\n\r\n      expect(result.current.data).toEqual(mockOnlineCategories);\r\n\r\n      // Go offline\r\n      vi.mocked(useNetworkStatus).mockReturnValue({\r\n        isOnline: false,\r\n        isOffline: true,\r\n        checkNetwork: vi.fn(),\r\n      });\r\n      vi.mocked(getCachedCategories).mockResolvedValue(mockOfflineCategories);\r\n      vi.mocked(getLastCategoriesSyncAt).mockResolvedValue('2026-01-30T10:00:00Z');\r\n\r\n      rerender();\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isOffline).toBe(true);\r\n      });\r\n\r\n      // Note: lastSyncAt is loaded asynchronously by useLiveQuery\r\n      // In the real app, this works correctly - the test limitation is due to mock timing\r\n      expect(result.current.isOffline).toBe(true);\r\n    });\r\n\r\n    it('should switch from offline to online data when network restored', async () => {\r\n      // Start offline\r\n      vi.mocked(useNetworkStatus).mockReturnValue({\r\n        isOnline: false,\r\n        isOffline: true,\r\n        checkNetwork: vi.fn(),\r\n      });\r\n      vi.mocked(getCachedCategories).mockResolvedValue(mockOfflineCategories);\r\n      vi.mocked(getLastCategoriesSyncAt).mockResolvedValue('2026-01-30T10:00:00Z');\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: undefined,\r\n        isLoading: false,\r\n        error: null,\r\n        isError: false,\r\n        isSuccess: false,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n\r\n      const { result, rerender } = renderHook(() => useCategoriesOffline());\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isOffline).toBe(true);\r\n      });\r\n\r\n      // Go online\r\n      vi.mocked(useNetworkStatus).mockReturnValue({\r\n        isOnline: true,\r\n        isOffline: false,\r\n        checkNetwork: vi.fn(),\r\n      });\r\n      vi.mocked(useCategories).mockReturnValue({\r\n        data: mockOnlineCategories,\r\n        isLoading: false,\r\n        error: null,\r\n        isError: false,\r\n        isSuccess: true,\r\n        refetch: vi.fn(),\r\n      } as any);\r\n\r\n      rerender();\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.isOffline).toBe(false);\r\n      });\r\n\r\n      expect(result.current.data).toEqual(mockOnlineCategories);\r\n      expect(result.current.lastSyncAt).toBeNull();\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('useOfflineCategoriesRaw', () => {\r\n  beforeEach(async () => {\r\n    await db.offline_categories.clear();\r\n    vi.clearAllMocks();\r\n  });\r\n\r\n  it('should return raw offline categories without conversion', async () => {\r\n    vi.mocked(getCachedCategories).mockResolvedValue(mockOfflineCategories);\r\n    vi.mocked(getLastCategoriesSyncAt).mockResolvedValue('2026-01-30T10:00:00Z');\r\n\r\n    const { result } = renderHook(() => useOfflineCategoriesRaw());\r\n\r\n    await waitFor(() => {\r\n      expect(result.current.isLoading).toBe(false);\r\n    });\r\n\r\n    expect(result.current.categories).toEqual(mockOfflineCategories);\r\n    expect(result.current.lastSyncAt).toBe('2026-01-30T10:00:00Z');\r\n  });\r\n\r\n  it('should handle errors gracefully', async () => {\r\n    vi.mocked(getCachedCategories).mockRejectedValue(new Error('DB error'));\r\n    vi.mocked(getLastCategoriesSyncAt).mockResolvedValue(null);\r\n\r\n    const { result } = renderHook(() => useOfflineCategoriesRaw());\r\n\r\n    await waitFor(() => {\r\n      expect(result.current.isLoading).toBe(false);\r\n    });\r\n\r\n    expect(result.current.categories).toEqual([]);\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\__tests__\\useModifiersOffline.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\__tests__\\useOfflinePayment.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\__tests__\\useProductsOffline.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\__tests__\\useSettingsOffline.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\__tests__\\useStockLevelsOffline.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useCategoriesOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useKitchenDispatch.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useModifiersOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useNetworkStatus.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useOfflineAuth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useOfflineOrder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useOfflinePayment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useOfflinePermissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useOfflineSession.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useProductsOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useRecipesOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useSettingsOffline.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_IOfflineSetting' is defined but never used.","line":19,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"_IOfflineSetting"},"fix":{"range":[645,681],"text":""},"desc":"Remove unused variable \"_IOfflineSetting\"."}]},{"ruleId":"no-extra-boolean-cast","severity":2,"message":"Redundant Boolean call.","line":116,"column":17,"nodeType":"CallExpression","messageId":"unexpectedCall","endLine":116,"endColumn":41,"fix":{"range":[3814,3838],"text":"offline.is_open"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Offline Settings Hook\r\n *\r\n * Provides transparent access to settings that works both online and offline.\r\n * When online, uses the Zustand settingsStore.\r\n * When offline, falls back to IndexedDB cache via Dexie.\r\n *\r\n * @see Story 1.5: Settings Offline Cache\r\n * @see ADR-001: Entités Synchronisées Offline\r\n */\r\n\r\nimport { useMemo, useCallback } from 'react';\r\nimport { useLiveQuery } from 'dexie-react-hooks';\r\nimport { useSettingsStore } from '@/stores/settingsStore';\r\nimport { useNetworkStatus } from '@/hooks/useNetworkStatus';\r\nimport { db } from '@/lib/db';\r\nimport type { ISyncMeta } from '@/types/offline';\r\nimport type {\r\n  IOfflineSetting as _IOfflineSetting,\r\n  IOfflineTaxRate,\r\n  IOfflinePaymentMethod,\r\n  IOfflineBusinessHours,\r\n} from '@/types/offline';\r\n// IOfflineSetting unused but kept for documentation\r\nimport type { TaxRate, PaymentMethod, BusinessHours } from '@/types/settings';\r\n\r\n// =====================================================\r\n// Value Parser\r\n// =====================================================\r\n\r\n/**\r\n * Parse a setting value from JSONB format\r\n */\r\nfunction parseSettingValue<T>(value: unknown): T {\r\n  if (typeof value === 'string') {\r\n    try {\r\n      return JSON.parse(value) as T;\r\n    } catch {\r\n      return value as T;\r\n    }\r\n  }\r\n  return value as T;\r\n}\r\n\r\n// =====================================================\r\n// Type Converters\r\n// =====================================================\r\n\r\n/**\r\n * Convert IOfflineTaxRate to TaxRate format\r\n *\r\n * Note: Dexie stores booleans as 0/1 in IndexedDB, so is_active/is_default\r\n * may be numbers when read back. We coerce them to booleans here.\r\n */\r\nfunction toTaxRate(offline: IOfflineTaxRate): TaxRate {\r\n  // Use type assertion since offline cache has simplified schema\r\n  return {\r\n    id: offline.id,\r\n    name_en: offline.name,\r\n    name_fr: offline.name,\r\n    name_id: offline.name,\r\n    rate: offline.rate,\r\n    is_default: Boolean(offline.is_default),\r\n    is_active: Boolean(offline.is_active),\r\n    created_at: offline.created_at,\r\n    updated_at: offline.updated_at,\r\n    code: offline.id.substring(0, 10), // Use ID prefix as fallback code\r\n    applies_to: null,\r\n    is_inclusive: true,\r\n    valid_from: null,\r\n    valid_until: null,\r\n  } as TaxRate;\r\n}\r\n\r\n/**\r\n * Convert IOfflinePaymentMethod to PaymentMethod format\r\n *\r\n * Note: Dexie stores booleans as 0/1 in IndexedDB, so is_active/is_default\r\n * may be numbers when read back. We coerce them to booleans here.\r\n */\r\nfunction toPaymentMethod(offline: IOfflinePaymentMethod): PaymentMethod {\r\n  // Use type assertion since offline cache has simplified schema\r\n  return {\r\n    id: offline.id,\r\n    name_en: offline.name,\r\n    name_fr: offline.name,\r\n    name_id: offline.name,\r\n    code: offline.type, // Use type as code fallback\r\n    payment_type: offline.type,\r\n    is_default: Boolean(offline.is_default),\r\n    is_active: Boolean(offline.is_active),\r\n    sort_order: offline.sort_order,\r\n    created_at: offline.created_at,\r\n    updated_at: offline.updated_at,\r\n    icon: null,\r\n    requires_reference: false,\r\n    settings: null,\r\n  } as PaymentMethod;\r\n}\r\n\r\n/**\r\n * Convert IOfflineBusinessHours to BusinessHours format\r\n *\r\n * Note: Uses static placeholder timestamps since offline cache doesn't store\r\n * created_at/updated_at for business hours (they rarely change).\r\n * Dexie stores booleans as 0/1, so we coerce is_open to boolean.\r\n */\r\nfunction toBusinessHours(offline: IOfflineBusinessHours): BusinessHours {\r\n  // Use type assertion since offline cache has simplified schema\r\n  // Note: Database uses is_closed (negated from is_open)\r\n  return {\r\n    id: `day-${offline.day_of_week}`,\r\n    day_of_week: offline.day_of_week,\r\n    open_time: offline.open_time,\r\n    close_time: offline.close_time,\r\n    is_closed: !Boolean(offline.is_open), // Negate is_open to is_closed\r\n    break_start: null,\r\n    break_end: null,\r\n    created_at: '1970-01-01T00:00:00.000Z',\r\n    updated_at: '1970-01-01T00:00:00.000Z',\r\n  } as BusinessHours;\r\n}\r\n\r\n// =====================================================\r\n// Main Hook\r\n// =====================================================\r\n\r\n/**\r\n * Hook for accessing settings with automatic online/offline handling\r\n *\r\n * @returns Settings interface compatible with settingsStore\r\n *\r\n * @example\r\n * ```tsx\r\n * const { getSetting, taxRates, isOffline } = useSettingsOffline();\r\n *\r\n * const theme = getSetting<string>('appearance.theme');\r\n * const activeTaxes = taxRates.filter(t => t.is_active);\r\n * ```\r\n */\r\nexport function useSettingsOffline() {\r\n  const { isOnline } = useNetworkStatus();\r\n  const store = useSettingsStore();\r\n\r\n  // ===== Offline Settings Query =====\r\n  // Note: useLiveQuery returns undefined while loading, null/[] on empty\r\n  const offlineSettings = useLiveQuery(\r\n    async () => {\r\n      if (isOnline) return null;\r\n      try {\r\n        return await db.offline_settings.toArray();\r\n      } catch (error) {\r\n        console.warn('[useSettingsOffline] Failed to read offline_settings:', error);\r\n        return [];\r\n      }\r\n    },\r\n    [isOnline]\r\n  );\r\n\r\n  // ===== Offline Tax Rates Query =====\r\n  const offlineTaxRates = useLiveQuery(\r\n    async () => {\r\n      if (isOnline) return null;\r\n      try {\r\n        return await db.offline_tax_rates.toArray();\r\n      } catch (error) {\r\n        console.warn('[useSettingsOffline] Failed to read offline_tax_rates:', error);\r\n        return [];\r\n      }\r\n    },\r\n    [isOnline]\r\n  );\r\n\r\n  // ===== Offline Payment Methods Query =====\r\n  const offlinePaymentMethods = useLiveQuery(\r\n    async () => {\r\n      if (isOnline) return null;\r\n      try {\r\n        return await db.offline_payment_methods.orderBy('sort_order').toArray();\r\n      } catch (error) {\r\n        console.warn('[useSettingsOffline] Failed to read offline_payment_methods:', error);\r\n        return [];\r\n      }\r\n    },\r\n    [isOnline]\r\n  );\r\n\r\n  // ===== Offline Business Hours Query =====\r\n  const offlineBusinessHours = useLiveQuery(\r\n    async () => {\r\n      if (isOnline) return null;\r\n      try {\r\n        return await db.offline_business_hours.orderBy('day_of_week').toArray();\r\n      } catch (error) {\r\n        console.warn('[useSettingsOffline] Failed to read offline_business_hours:', error);\r\n        return [];\r\n      }\r\n    },\r\n    [isOnline]\r\n  );\r\n\r\n  // ===== Sync Metadata Query (all entities) =====\r\n  const allSyncMeta = useLiveQuery(\r\n    async () => {\r\n      if (isOnline) return null;\r\n      try {\r\n        return await db.offline_sync_meta.toArray();\r\n      } catch (error) {\r\n        console.warn('[useSettingsOffline] Failed to read offline_sync_meta:', error);\r\n        return [];\r\n      }\r\n    },\r\n    [isOnline]\r\n  );\r\n\r\n  // Helper to get sync meta for a specific entity\r\n  const getSyncMetaFor = useCallback(\r\n    (entity: string): ISyncMeta | undefined => {\r\n      return allSyncMeta?.find((m) => m.entity === entity);\r\n    },\r\n    [allSyncMeta]\r\n  );\r\n\r\n  // ===== Memoized Getters =====\r\n\r\n  /**\r\n   * Get a setting value by key\r\n   */\r\n  const getSetting = useMemo(() => {\r\n    return <T = unknown>(key: string): T | null => {\r\n      if (isOnline) {\r\n        return store.getSetting<T>(key);\r\n      }\r\n\r\n      const setting = offlineSettings?.find((s) => s.key === key);\r\n      if (!setting) return null;\r\n\r\n      return parseSettingValue<T>(setting.value);\r\n    };\r\n  }, [isOnline, store, offlineSettings]);\r\n\r\n  /**\r\n   * Get all tax rates (converted to standard format)\r\n   */\r\n  const taxRates = useMemo((): TaxRate[] => {\r\n    if (isOnline) {\r\n      return store.taxRates;\r\n    }\r\n    return (offlineTaxRates || []).map(toTaxRate);\r\n  }, [isOnline, store.taxRates, offlineTaxRates]);\r\n\r\n  /**\r\n   * Get active tax rates\r\n   */\r\n  const activeTaxRates = useMemo((): TaxRate[] => {\r\n    if (isOnline) {\r\n      return store.getActiveTaxRates();\r\n    }\r\n    return taxRates.filter((t) => t.is_active);\r\n  }, [isOnline, store, taxRates]);\r\n\r\n  /**\r\n   * Get default tax rate\r\n   */\r\n  const defaultTaxRate = useMemo((): TaxRate | null => {\r\n    if (isOnline) {\r\n      return store.getDefaultTaxRate();\r\n    }\r\n    return taxRates.find((t) => t.is_active && t.is_default) || null;\r\n  }, [isOnline, store, taxRates]);\r\n\r\n  /**\r\n   * Get all payment methods (converted to standard format)\r\n   */\r\n  const paymentMethods = useMemo((): PaymentMethod[] => {\r\n    if (isOnline) {\r\n      return store.paymentMethods;\r\n    }\r\n    return (offlinePaymentMethods || []).map(toPaymentMethod);\r\n  }, [isOnline, store.paymentMethods, offlinePaymentMethods]);\r\n\r\n  /**\r\n   * Get active payment methods\r\n   */\r\n  const activePaymentMethods = useMemo((): PaymentMethod[] => {\r\n    if (isOnline) {\r\n      return store.getActivePaymentMethods();\r\n    }\r\n    return paymentMethods.filter((p) => p.is_active);\r\n  }, [isOnline, store, paymentMethods]);\r\n\r\n  /**\r\n   * Get default payment method\r\n   */\r\n  const defaultPaymentMethod = useMemo((): PaymentMethod | null => {\r\n    if (isOnline) {\r\n      return store.getDefaultPaymentMethod();\r\n    }\r\n    return paymentMethods.find((p) => p.is_active && p.is_default) || null;\r\n  }, [isOnline, store, paymentMethods]);\r\n\r\n  /**\r\n   * Get all business hours (converted to standard format)\r\n   */\r\n  const businessHours = useMemo((): BusinessHours[] => {\r\n    if (isOnline) {\r\n      return store.businessHours;\r\n    }\r\n    return (offlineBusinessHours || []).map(toBusinessHours);\r\n  }, [isOnline, store.businessHours, offlineBusinessHours]);\r\n\r\n  /**\r\n   * Get last sync timestamp for settings (primary entity)\r\n   */\r\n  const lastSyncAt = useMemo((): string | null => {\r\n    if (isOnline) {\r\n      return null; // Online doesn't track sync timestamp\r\n    }\r\n    return getSyncMetaFor('settings')?.lastSyncAt ?? null;\r\n  }, [isOnline, getSyncMetaFor]);\r\n\r\n  /**\r\n   * Get oldest sync timestamp across all cached entities\r\n   * Useful to show \"Data as of {timestamp}\" message\r\n   */\r\n  const oldestSyncAt = useMemo((): string | null => {\r\n    if (isOnline || !allSyncMeta?.length) return null;\r\n    const timestamps = allSyncMeta\r\n      .map((m) => m.lastSyncAt)\r\n      .filter(Boolean)\r\n      .sort();\r\n    return timestamps[0] ?? null;\r\n  }, [isOnline, allSyncMeta]);\r\n\r\n  return {\r\n    // State indicators\r\n    isOffline: !isOnline,\r\n    isOnline,\r\n    lastSyncAt,\r\n    oldestSyncAt,\r\n\r\n    // Settings getter\r\n    getSetting,\r\n\r\n    // Tax rates\r\n    taxRates,\r\n    activeTaxRates,\r\n    defaultTaxRate,\r\n\r\n    // Payment methods\r\n    paymentMethods,\r\n    activePaymentMethods,\r\n    defaultPaymentMethod,\r\n\r\n    // Business hours\r\n    businessHours,\r\n\r\n    // Sync metadata access (for detailed cache info)\r\n    getSyncMetaFor,\r\n\r\n    // Loading states (for compatibility)\r\n    isLoading: store.isLoading,\r\n    isInitialized: store.isInitialized,\r\n  };\r\n}\r\n\r\nexport default useSettingsOffline;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\offline\\useStockLevelsOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\__tests__\\useDisplayBroadcast.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\__tests__\\useKdsStatusListener.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\useCartPromotions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\useDisplayBroadcast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\useKdsStatusListener.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\usePOSModals.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\usePOSOrders.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_lockedItemIds' is assigned a value but never used.","line":23,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCallback } from 'react'\r\nimport { toast } from 'sonner'\r\nimport { useCartStore } from '@/stores/cartStore'\r\nimport { useOrderStore } from '@/stores/orderStore'\r\n\r\nexport interface IUsePOSOrdersReturn {\r\n    handleSendToKitchen: (hasOpenShift: boolean, onNoShift: () => void) => void\r\n    handleRestoreHeldOrder: (heldOrderId: string, onSuccess?: () => void) => void\r\n}\r\n\r\n/**\r\n * Hook to manage POS order operations (send to kitchen, hold, restore)\r\n * Extracts order logic from POSMainPage for better separation of concerns\r\n */\r\nexport function usePOSOrders(): IUsePOSOrdersReturn {\r\n    const {\r\n        items,\r\n        itemCount,\r\n        clearCart,\r\n        activeOrderId,\r\n        activeOrderNumber: _activeOrderNumber,\r\n        restoreCartState,\r\n        lockedItemIds: _lockedItemIds,\r\n        subtotal,\r\n        discountAmount,\r\n        total,\r\n        orderType,\r\n        tableNumber,\r\n        customerId,\r\n        customerName,\r\n    } = useCartStore()\r\n\r\n    const {\r\n        restoreHeldOrder,\r\n        sendToKitchenAsHeldOrder,\r\n        holdOrder,\r\n    } = useOrderStore()\r\n\r\n    // Handle send to kitchen - creates or updates a held order and clears the cart\r\n    const handleSendToKitchen = useCallback((\r\n        hasOpenShift: boolean,\r\n        onNoShift: () => void\r\n    ) => {\r\n        if (!hasOpenShift) {\r\n            onNoShift()\r\n            return\r\n        }\r\n        if (itemCount === 0) {\r\n            toast.error('No items to send')\r\n            return\r\n        }\r\n\r\n        if (activeOrderId) {\r\n            // Update existing kitchen order (handles cases where order was restored/removed)\r\n            const heldOrder = holdOrder(\r\n                items,\r\n                orderType,\r\n                tableNumber,\r\n                customerId,\r\n                customerName,\r\n                subtotal,\r\n                discountAmount,\r\n                total,\r\n                'En cuisine',\r\n                _activeOrderNumber || undefined,\r\n                activeOrderId,\r\n                true, // sentToKitchen\r\n                items.map(i => i.id) // lock all items\r\n            )\r\n            toast.success(`Order ${heldOrder.orderNumber} updated successfully!`)\r\n        } else {\r\n            // Create new kitchen order\r\n            const heldOrder = sendToKitchenAsHeldOrder(\r\n                items,\r\n                orderType,\r\n                tableNumber,\r\n                customerId,\r\n                customerName,\r\n                subtotal,\r\n                discountAmount,\r\n                total\r\n            )\r\n            toast.success(`Order ${heldOrder.orderNumber} sent to kitchen!`)\r\n        }\r\n\r\n        // Clear the cart after sending\r\n        clearCart()\r\n    }, [\r\n        itemCount,\r\n        activeOrderId,\r\n        _activeOrderNumber,\r\n        items,\r\n        subtotal,\r\n        discountAmount,\r\n        total,\r\n        orderType,\r\n        tableNumber,\r\n        customerId,\r\n        customerName,\r\n        holdOrder,\r\n        sendToKitchenAsHeldOrder,\r\n        clearCart,\r\n    ])\r\n\r\n    // Handle restore held order\r\n    const handleRestoreHeldOrder = useCallback((\r\n        heldOrderId: string,\r\n        onSuccess?: () => void\r\n    ) => {\r\n        const heldOrder = restoreHeldOrder(heldOrderId)\r\n        if (heldOrder) {\r\n            // Restore items to cart with full state (including locks and active order ID)\r\n            restoreCartState(\r\n                heldOrder.items,\r\n                heldOrder.lockedItemIds || [],\r\n                heldOrder.sentToKitchen ? heldOrder.id : null,\r\n                heldOrder.orderNumber\r\n            )\r\n\r\n            onSuccess?.()\r\n            toast.success(`Order ${heldOrder.orderNumber} restored`)\r\n        }\r\n    }, [restoreHeldOrder, restoreCartState])\r\n\r\n    return {\r\n        handleSendToKitchen,\r\n        handleRestoreHeldOrder,\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pos\\usePOSShift.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pricing\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pricing\\useCartPriceRecalculation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\pricing\\usePricingOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\__tests__\\useCombos.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[278,281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[278,281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[390,393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[390,393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[525,528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[525,528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[690,693],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[690,693],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\r\n\r\n// Mock supabase\r\nconst mockSelect = vi.fn()\r\nconst mockEq = vi.fn()\r\nconst mockOrder = vi.fn()\r\n\r\nvi.mock('../../../lib/supabase', () => ({\r\n    supabase: {\r\n        from: () => ({\r\n            select: (...args: any[]) => {\r\n                mockSelect(...args)\r\n                return {\r\n                    eq: (...eqArgs: any[]) => {\r\n                        mockEq(...eqArgs)\r\n                        return {\r\n                            eq: (...eqArgs2: any[]) => {\r\n                                mockEq(...eqArgs2)\r\n                                return {\r\n                                    order: (...orderArgs: any[]) => {\r\n                                        mockOrder(...orderArgs)\r\n                                        return Promise.resolve({\r\n                                            data: [\r\n                                                {\r\n                                                    id: 'combo-1',\r\n                                                    name: 'Breakfast Combo',\r\n                                                    combo_price: 45000,\r\n                                                    is_active: true,\r\n                                                    available_at_pos: true,\r\n                                                    sort_order: 1,\r\n                                                },\r\n                                            ],\r\n                                            error: null,\r\n                                        })\r\n                                    },\r\n                                }\r\n                            },\r\n                        }\r\n                    },\r\n                }\r\n            },\r\n        }),\r\n    },\r\n}))\r\n\r\ndescribe('usePOSCombos', () => {\r\n    beforeEach(() => {\r\n        vi.clearAllMocks()\r\n    })\r\n\r\n    it('module exports usePOSCombos function', async () => {\r\n        const mod = await import('../useCombos')\r\n        expect(typeof mod.usePOSCombos).toBe('function')\r\n    })\r\n\r\n    it('queries product_combos with correct filters', async () => {\r\n        // The hook uses react-query so we just verify the module structure\r\n        const mod = await import('../useCombos')\r\n        expect(mod.usePOSCombos).toBeDefined()\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useCategories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useCombos.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useProductDetail.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useProductList.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useProductModifiers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useProductSearch.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\products\\useProductVariants.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1843,1846],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1843,1846],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery } from '@tanstack/react-query'\r\nimport { supabase } from '@/lib/supabase'\r\n\r\nexport interface IVariantMaterial {\r\n  material_id: string\r\n  quantity: number\r\n}\r\n\r\nexport interface IVariantOption {\r\n  option_id: string\r\n  option_label: string\r\n  price_adjustment: number\r\n  is_default: boolean\r\n  materials: IVariantMaterial[]\r\n}\r\n\r\nexport interface IVariantGroup {\r\n  group_name: string\r\n  group_type: 'single' | 'multiple'\r\n  group_required: boolean\r\n  options: IVariantOption[]\r\n}\r\n\r\n/**\r\n * Hook pour charger les variants d'un produit depuis product_modifiers\r\n */\r\nexport function useProductVariants(productId: string | null) {\r\n  return useQuery({\r\n    queryKey: ['product-variants', productId],\r\n    queryFn: async (): Promise<IVariantGroup[]> => {\r\n      if (!productId) return []\r\n\r\n      const { data, error } = await supabase\r\n        .from('product_modifiers')\r\n        .select('*')\r\n        .eq('product_id', productId)\r\n        .eq('is_active', true)\r\n        .order('group_name')\r\n        .order('option_label')\r\n\r\n      if (error) {\r\n        throw error\r\n      }\r\n\r\n      // Grouper les options par groupe\r\n      const groupsMap = new Map<string, IVariantGroup>()\r\n\r\n      data?.forEach((modifier) => {\r\n        if (!groupsMap.has(modifier.group_name)) {\r\n          groupsMap.set(modifier.group_name, {\r\n            group_name: modifier.group_name,\r\n            group_type: modifier.group_type as 'single' | 'multiple',\r\n            group_required: modifier.group_required || false,\r\n            options: []\r\n          })\r\n        }\r\n\r\n        const group = groupsMap.get(modifier.group_name)!\r\n\r\n        // Parse materials from JSONB field\r\n        let materials: IVariantMaterial[] = []\r\n        if (modifier.materials && Array.isArray(modifier.materials)) {\r\n          materials = modifier.materials.map((m: any) => ({\r\n            material_id: m.material_id,\r\n            quantity: m.quantity || 0\r\n          }))\r\n        }\r\n\r\n        group.options.push({\r\n          option_id: modifier.option_id,\r\n          option_label: modifier.option_label,\r\n          price_adjustment: modifier.price_adjustment || 0,\r\n          is_default: modifier.is_default || false,\r\n          materials\r\n        })\r\n      })\r\n\r\n      return Array.from(groupsMap.values())\r\n    },\r\n    enabled: !!productId\r\n  })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\promotions\\usePromotionsOffline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\__tests__\\usePurchaseOrderReception.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\__tests__\\usePurchaseOrderWorkflow.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\__tests__\\usePurchaseOrders.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":209,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5309,5312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5309,5312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":210,"column":99,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":102,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5412,5415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5412,5415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\nimport { renderHook, waitFor } from '@testing-library/react'\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query'\nimport { createElement } from 'react'\nimport {\n  usePurchaseOrders,\n  usePurchaseOrder,\n  useSuppliers,\n  calculateLineTotal,\n  calculatePOTotals,\n  generatePONumber,\n} from '../index'\n\n// Mock Supabase\nconst mockSelect = vi.fn()\nconst mockInsert = vi.fn()\nconst mockUpdate = vi.fn()\nconst mockDelete = vi.fn()\nconst mockEq = vi.fn()\nconst mockNeq = vi.fn()\nconst mockOrder = vi.fn()\nconst mockLike = vi.fn()\nconst mockLimit = vi.fn()\nconst mockSingle = vi.fn()\n\nvi.mock('@/lib/supabase', () => ({\n  supabase: {\n    from: vi.fn(() => ({\n      select: mockSelect,\n      insert: mockInsert,\n      update: mockUpdate,\n      delete: mockDelete,\n    })),\n  },\n}))\n\n// Create wrapper for React Query\nfunction createWrapper() {\n  const queryClient = new QueryClient({\n    defaultOptions: {\n      queries: {\n        retry: false,\n      },\n    },\n  })\n\n  return function Wrapper({ children }: { children: React.ReactNode }) {\n    return createElement(QueryClientProvider, { client: queryClient }, children)\n  }\n}\n\ndescribe('Purchase Orders Hooks', () => {\n  beforeEach(() => {\n    vi.clearAllMocks()\n\n    // Setup chain mocks\n    mockSelect.mockReturnValue({\n      eq: mockEq,\n      neq: mockNeq,\n      order: mockOrder,\n      like: mockLike,\n      single: mockSingle,\n    })\n\n    mockEq.mockReturnValue({\n      select: mockSelect,\n      single: mockSingle,\n      order: mockOrder,\n      eq: mockEq,\n      gte: mockEq,\n      lte: mockEq,\n    })\n\n    mockNeq.mockReturnValue({\n      order: mockOrder,\n    })\n\n    mockOrder.mockReturnValue({\n      limit: mockLimit,\n    })\n\n    mockLike.mockReturnValue({\n      order: mockOrder,\n    })\n\n    mockLimit.mockReturnValue(\n      Promise.resolve({ data: [], error: null })\n    )\n  })\n\n  describe('usePurchaseOrders', () => {\n    it('returns list of purchase orders', async () => {\n      const mockData = [\n        {\n          id: '1',\n          po_number: 'PO-202602-0001',\n          supplier_id: 'sup-1',\n          supplier: { name: 'Test Supplier' },\n          status: 'draft',\n          total_amount: 100000,\n        },\n      ]\n\n      mockOrder.mockResolvedValue({ data: mockData, error: null })\n\n      const { result } = renderHook(() => usePurchaseOrders(), {\n        wrapper: createWrapper(),\n      })\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true)\n      })\n\n      expect(result.current.data).toEqual(mockData)\n    })\n\n    it('has correct query key structure', () => {\n      const filters = { status: 'draft' as const }\n      const { result } = renderHook(() => usePurchaseOrders(filters), {\n        wrapper: createWrapper(),\n      })\n\n      // The hook should use the correct query key format\n      expect(result.current).toBeDefined()\n    })\n  })\n\n  describe('usePurchaseOrder', () => {\n    it('returns undefined when no ID provided (disabled query)', async () => {\n      const { result } = renderHook(() => usePurchaseOrder(null), {\n        wrapper: createWrapper(),\n      })\n\n      // Query is disabled when no ID, so data should be undefined\n      expect(result.current.data).toBeUndefined()\n      expect(result.current.isFetching).toBe(false)\n    })\n  })\n\n  describe('useSuppliers', () => {\n    it('hook is properly initialized', async () => {\n      const mockSuppliers = [\n        { id: '1', name: 'Supplier A', is_active: true },\n        { id: '2', name: 'Supplier B', is_active: true },\n      ]\n\n      mockOrder.mockResolvedValue({ data: mockSuppliers, error: null })\n\n      const { result } = renderHook(() => useSuppliers(), {\n        wrapper: createWrapper(),\n      })\n\n      // Hook should be defined and return expected structure\n      expect(result.current).toBeDefined()\n      expect(result.current.isLoading).toBeDefined()\n    })\n  })\n})\n\ndescribe('Utility Functions', () => {\n  describe('calculateLineTotal', () => {\n    it('calculates line total correctly without discount', () => {\n      const result = calculateLineTotal({\n        quantity: 10,\n        unit_price: 1000,\n        discount_amount: 0,\n        discount_percentage: null,\n      })\n\n      expect(result).toBe(10000)\n    })\n\n    it('calculates line total with fixed discount', () => {\n      const result = calculateLineTotal({\n        quantity: 10,\n        unit_price: 1000,\n        discount_amount: 500,\n        discount_percentage: null,\n      })\n\n      expect(result).toBe(9500)\n    })\n\n    it('calculates line total with percentage discount', () => {\n      const result = calculateLineTotal({\n        quantity: 10,\n        unit_price: 1000,\n        discount_amount: 0,\n        discount_percentage: 10, // 10%\n      })\n\n      expect(result).toBe(9000) // 10000 - 10% = 9000\n    })\n\n    it('percentage discount takes precedence over fixed discount', () => {\n      const result = calculateLineTotal({\n        quantity: 10,\n        unit_price: 1000,\n        discount_amount: 500, // Should be ignored\n        discount_percentage: 10, // 10%\n      })\n\n      expect(result).toBe(9000)\n    })\n  })\n\n  describe('calculatePOTotals', () => {\n    const mockItems = [\n      { product_name: 'Item 1', quantity: 1, unit_price: 1000, line_total: 1000, tax_rate: 10 } as any,\n      { product_name: 'Item 2', quantity: 2, unit_price: 500, line_total: 1000, tax_rate: 10 } as any,\n    ]\n\n    it('calculates subtotal as sum of line totals', () => {\n      const result = calculatePOTotals(mockItems, 0, null)\n\n      expect(result.subtotal).toBe(2000)\n    })\n\n    it('calculates tax amount correctly', () => {\n      const result = calculatePOTotals(mockItems, 0, null)\n\n      // (1000 * 10%) + (1000 * 10%) = 100 + 100 = 200\n      expect(result.tax_amount).toBe(200)\n    })\n\n    it('calculates total with no global discount', () => {\n      const result = calculatePOTotals(mockItems, 0, null)\n\n      // subtotal (2000) + tax (200) = 2200\n      expect(result.total_amount).toBe(2200)\n    })\n\n    it('applies fixed global discount', () => {\n      const result = calculatePOTotals(mockItems, 500, null)\n\n      expect(result.discount_amount).toBe(500)\n      // subtotal (2000) - discount (500) + tax (200) = 1700\n      expect(result.total_amount).toBe(1700)\n    })\n\n    it('applies percentage global discount', () => {\n      const result = calculatePOTotals(mockItems, 0, 10) // 10%\n\n      // 2000 * 10% = 200\n      expect(result.discount_amount).toBe(200)\n      // subtotal (2000) - discount (200) + tax (200) = 2000\n      expect(result.total_amount).toBe(2000)\n    })\n  })\n\n  describe('generatePONumber', () => {\n    it('generates correct format PO-YYYYMM-XXXX', async () => {\n      const now = new Date()\n      const yearMonth = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`\n\n      mockLike.mockReturnValue({\n        order: () => ({\n          limit: () => Promise.resolve({ data: [], error: null }),\n        }),\n      })\n\n      const result = await generatePONumber()\n\n      expect(result).toMatch(new RegExp(`^PO-${yearMonth}-\\\\d{4}$`))\n    })\n\n    it('generates first PO number as 0001 when no existing POs', async () => {\n      const now = new Date()\n      const yearMonth = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`\n\n      mockLike.mockReturnValue({\n        order: () => ({\n          limit: () => Promise.resolve({ data: [], error: null }),\n        }),\n      })\n\n      const result = await generatePONumber()\n\n      expect(result).toBe(`PO-${yearMonth}-0001`)\n    })\n\n    it('increments PO number from last existing', async () => {\n      const now = new Date()\n      const yearMonth = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`\n\n      mockLike.mockReturnValue({\n        order: () => ({\n          limit: () =>\n            Promise.resolve({\n              data: [{ po_number: `PO-${yearMonth}-0005` }],\n              error: null,\n            }),\n        }),\n      })\n\n      const result = await generatePONumber()\n\n      expect(result).toBe(`PO-${yearMonth}-0006`)\n    })\n  })\n})\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\usePurchaseOrderDetail.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\usePurchaseOrderReception.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\usePurchaseOrderWorkflow.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\usePurchaseOrders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\purchasing\\useSuppliers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\reports\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\reports\\useDateRange.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\reports\\useReportFilters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\reports\\useReportPermissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\settings\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\settings\\settingsKeys.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\settings\\useBusinessSettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\settings\\usePaymentSettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\settings\\useSettingsCore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\settings\\useTaxSettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\shift\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\sync\\__tests__\\usePendingSyncItems.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\sync\\usePendingSyncItems.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\use-toast.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'actionTypes' is assigned a value but only used as a type.","line":18,"column":7,"nodeType":"Identifier","messageId":"usedOnlyAsType","endLine":18,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useLanDevices.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useNetworkAlerts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useNetworkStatus.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useNetworkStatus.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useOfflineData.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useOfflineData.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useOfflineOrder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useOrders.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[653,656],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[653,656],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient } from '@tanstack/react-query'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../stores/authStore'\r\nimport { useCartStore } from '../stores/cartStore'\r\nimport type { Insertable } from '../types/database'\r\n\r\nexport function useOrders() {\r\n    const queryClient = useQueryClient()\r\n    const { user, sessionId } = useAuthStore()\r\n    const { items, orderType, tableNumber, customerId, customerName, subtotal, discountType, discountValue, discountAmount, total, clearCart } = useCartStore()\r\n\r\n    const createOrderMutation = useMutation({\r\n        mutationFn: async (paymentData: { method: any, cashReceived?: number, changeGiven?: number }) => {\r\n            if (!user) throw new Error('Utilisateur non connecté')\r\n\r\n            // 1. Create Order\r\n            const orderData = {\r\n                order_number: `ORD-${Date.now()}`, // Will be overwritten by trigger if setup\r\n                order_type: orderType,\r\n                table_number: tableNumber,\r\n                customer_id: customerId,\r\n                customer_name: customerName,\r\n                status: 'new', // Start as 'new' for KDS workflow (new → preparing → ready → served)\r\n                payment_status: 'paid',\r\n                subtotal: subtotal,\r\n                discount_type: discountType === 'percent' ? 'percentage' : (discountType === 'amount' ? 'fixed' : null),\r\n                discount_value: discountValue,\r\n                discount_amount: discountAmount,\r\n                total: total,\r\n                payment_method: paymentData.method,\r\n                cash_received: paymentData.cashReceived,\r\n                change_given: paymentData.changeGiven,\r\n                staff_id: user.id,\r\n                session_id: sessionId,\r\n                completed_at: new Date().toISOString()\r\n            }\r\n\r\n            const { data: order, error: orderError } = await supabase\r\n                .from('orders')\r\n                .insert(orderData as Insertable<'orders'>)\r\n                .select()\r\n                .single()\r\n\r\n            if (orderError) {\r\n                console.error('Supabase Order Error:', orderError)\r\n                throw orderError\r\n            }\r\n\r\n            // 2. Create Order Items\r\n            const itemsData = items.map(item => ({\r\n                order_id: order.id,\r\n                product_id: item.product?.id || item.combo?.id,\r\n                product_name: item.product?.name || item.combo?.name || 'Unknown',\r\n                product_sku: item.product?.sku || `COMBO-${item.combo?.id?.slice(0, 8) || 'UNKNOWN'}`,\r\n                quantity: item.quantity,\r\n                unit_price: item.unitPrice,\r\n                total_price: item.totalPrice,\r\n                modifiers: item.modifiers,\r\n                modifiers_total: item.modifiersTotal,\r\n                notes: item.notes,\r\n                selected_variants: item.selectedVariants ? { variants: item.selectedVariants } : null,\r\n                dispatch_station: (item.product as { category?: { dispatch_station?: string } })?.category?.dispatch_station || 'none',\r\n                item_status: 'new' as const\r\n            })) as unknown as Insertable<'order_items'>[]\r\n\r\n            const { error: itemsError } = await supabase\r\n                .from('order_items')\r\n                .insert(itemsData)\r\n\r\n            if (itemsError) {\r\n                console.error('Supabase Items Error:', itemsError)\r\n                throw itemsError\r\n            }\r\n\r\n            return order\r\n        },\r\n        onSuccess: () => {\r\n            clearCart()\r\n            queryClient.invalidateQueries({ queryKey: ['products'] }) // Refresh stock\r\n            queryClient.invalidateQueries({ queryKey: ['orders'] })\r\n        }\r\n    })\r\n\r\n    return {\r\n        createOrder: createOrderMutation.mutateAsync,\r\n        isCreating: createOrderMutation.isPending,\r\n        error: createOrderMutation.error\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\usePWAInstall.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1546,1549],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1546,1549],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1846,1849],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1846,1849],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2871,2874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2871,2874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\usePermissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\usePermissionsUnified.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useProduction.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3622,3625],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3622,3625],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3705,3708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3705,3708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":287,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":287,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10768,10771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10768,10771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":321,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":321,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12419,12422],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12419,12422],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":369,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":369,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14098,14101],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14098,14101],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../stores/authStore'\r\nimport { Product, Section, ProductionRecord } from '../types/database'\r\nimport { toast } from 'sonner'\r\n\r\n// Generate UUID using native crypto API\r\nconst generateUUID = (): string => crypto.randomUUID()\r\n\r\nexport interface ProductionItem {\r\n    productId: string\r\n    name: string\r\n    category: string\r\n    icon: string\r\n    unit: string\r\n    quantity: number\r\n    wasted: number\r\n    wasteReason: string\r\n}\r\n\r\ninterface ProductUOM {\r\n    id: string\r\n    unit_name: string\r\n    conversion_factor: number\r\n    is_consumption_unit: boolean\r\n}\r\n\r\nexport interface ProductWithSection extends Product {\r\n    category?: { name: string; icon: string }\r\n    product_uoms?: ProductUOM[]\r\n}\r\n\r\nexport interface ProductionRecordWithProduct extends ProductionRecord {\r\n    product?: {\r\n        name: string\r\n        sku: string\r\n        unit: string\r\n        product_uoms?: { id: string; unit_name: string; is_consumption_unit: boolean }[]\r\n    }\r\n}\r\n\r\nexport function useProduction() {\r\n    const { user } = useAuthStore()\r\n    const isAdmin = user?.role === 'admin' || user?.role === 'manager'\r\n\r\n    const [selectedDate, setSelectedDate] = useState(new Date())\r\n    const [sections, setSections] = useState<Section[]>([])\r\n    const [selectedSectionId, setSelectedSectionId] = useState<string | null>(null)\r\n    const [sectionProducts, setSectionProducts] = useState<ProductWithSection[]>([])\r\n    const [productionItems, setProductionItems] = useState<ProductionItem[]>([])\r\n    const [todayHistory, setTodayHistory] = useState<ProductionRecordWithProduct[]>([])\r\n    const [isLoading, setIsLoading] = useState(true)\r\n    const [isSaving, setIsSaving] = useState(false)\r\n\r\n    const selectedSection = sections.find(s => s.id === selectedSectionId)\r\n    const isToday = selectedDate.toDateString() === new Date().toDateString()\r\n\r\n    // Fetch sections on mount\r\n    useEffect(() => {\r\n        fetchSections()\r\n    }, [])\r\n\r\n    // Fetch products when section or date changes\r\n    useEffect(() => {\r\n        if (selectedSectionId) {\r\n            fetchSectionProducts()\r\n            fetchTodayHistory()\r\n        }\r\n    }, [selectedSectionId, selectedDate])\r\n\r\n    const fetchSections = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('sections')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .eq('section_type', 'production')\r\n                .order('sort_order')\r\n\r\n            if (error) throw error\r\n            setSections(data || [])\r\n\r\n            if (data && data.length > 0 && !selectedSectionId) {\r\n                setSelectedSectionId(data[0].id)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching sections:', error)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const fetchSectionProducts = async () => {\r\n        if (!selectedSectionId) return\r\n\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('product_sections')\r\n                .select(`\r\n                    product:products(\r\n                        *,\r\n                        category:categories(name, icon),\r\n                        product_uoms(id, unit_name, conversion_factor, is_consumption_unit)\r\n                    )\r\n                `)\r\n                .eq('section_id', selectedSectionId)\r\n\r\n            if (error) throw error\r\n\r\n            const products = data\r\n                ?.map((ps: any) => ps.product)\r\n                .filter(Boolean)\r\n                .filter((p: any) => p.product_type === 'finished' || p.product_type === 'semi_finished')\r\n\r\n            setSectionProducts(products || [])\r\n        } catch (error) {\r\n            console.error('Error fetching section products:', error)\r\n        }\r\n    }\r\n\r\n    const fetchTodayHistory = async () => {\r\n        if (!selectedSectionId) return\r\n\r\n        try {\r\n            const dateStr = selectedDate.toISOString().split('T')[0]\r\n\r\n            const { data, error } = await supabase\r\n                .from('production_records')\r\n                .select(`\r\n                    *,\r\n                    product:products(\r\n                        name, sku, unit,\r\n                        product_uoms(id, unit_name, is_consumption_unit)\r\n                    )\r\n                `)\r\n                .eq('section_id', selectedSectionId)\r\n                .eq('production_date', dateStr)\r\n                .order('created_at', { ascending: false })\r\n\r\n            if (error) throw error\r\n            setTodayHistory((data || []) as unknown as ProductionRecordWithProduct[])\r\n        } catch (error) {\r\n            console.error('Error fetching history:', error)\r\n        }\r\n    }\r\n\r\n    const getProductionUnit = useCallback((product: ProductWithSection): string => {\r\n        const consumptionUom = product.product_uoms?.find(u => u.is_consumption_unit)\r\n        return consumptionUom?.unit_name || product.unit || 'pcs'\r\n    }, [])\r\n\r\n    const addProduct = useCallback((product: ProductWithSection) => {\r\n        setProductionItems(prev => [...prev, {\r\n            productId: product.id,\r\n            name: product.name,\r\n            category: product.category?.name || 'General',\r\n            icon: product.category?.icon || '📦',\r\n            unit: getProductionUnit(product),\r\n            quantity: 1,\r\n            wasted: 0,\r\n            wasteReason: ''\r\n        }])\r\n    }, [getProductionUnit])\r\n\r\n    const updateQuantity = useCallback((productId: string, field: 'quantity' | 'wasted', delta: number) => {\r\n        setProductionItems(items =>\r\n            items.map(item =>\r\n                item.productId === productId\r\n                    ? { ...item, [field]: Math.max(0, item[field] + delta) }\r\n                    : item\r\n            )\r\n        )\r\n    }, [])\r\n\r\n    const updateReason = useCallback((productId: string, reason: string) => {\r\n        setProductionItems(items =>\r\n            items.map(item =>\r\n                item.productId === productId\r\n                    ? { ...item, wasteReason: reason }\r\n                    : item\r\n            )\r\n        )\r\n    }, [])\r\n\r\n    const removeItem = useCallback((productId: string) => {\r\n        setProductionItems(items => items.filter(item => item.productId !== productId))\r\n    }, [])\r\n\r\n    const clearItems = useCallback(() => {\r\n        setProductionItems([])\r\n    }, [])\r\n\r\n    const restoreFromReminder = useCallback((items: ProductionItem[]) => {\r\n        setProductionItems(items)\r\n    }, [])\r\n\r\n    const navigateDate = useCallback((direction: number) => {\r\n        const newDate = new Date(selectedDate)\r\n        newDate.setDate(newDate.getDate() + direction)\r\n        setSelectedDate(newDate)\r\n    }, [selectedDate])\r\n\r\n    const handleSave = async () => {\r\n        if (productionItems.length === 0 || !selectedSectionId) return\r\n        setIsSaving(true)\r\n\r\n        try {\r\n            const dateStr = selectedDate.toISOString().split('T')[0]\r\n\r\n            for (const item of productionItems) {\r\n                const productionId = generateUUID()\r\n                const { data: prodRecord, error: prodError } = await supabase\r\n                    .from('production_records')\r\n                    .insert({\r\n                        production_id: productionId,\r\n                        product_id: item.productId,\r\n                        section_id: selectedSectionId,\r\n                        quantity_produced: item.quantity,\r\n                        quantity_waste: item.wasted,\r\n                        production_date: dateStr,\r\n                        created_by: user?.id,\r\n                        notes: item.wasteReason ? `Waste: ${item.wasteReason}` : null,\r\n                        stock_updated: true\r\n                    })\r\n                    .select()\r\n                    .single()\r\n\r\n                if (prodError) throw prodError\r\n\r\n                const { data: productData } = await supabase\r\n                    .from('products')\r\n                    .select('current_stock')\r\n                    .eq('id', item.productId)\r\n                    .single()\r\n\r\n                const currentStock = productData?.current_stock || 0\r\n                const netChange = item.quantity - item.wasted\r\n\r\n                if (item.quantity > 0) {\r\n                    await supabase\r\n                        .from('stock_movements')\r\n                        .insert({\r\n                            movement_id: generateUUID(),\r\n                            product_id: item.productId,\r\n                            movement_type: 'production_in',\r\n                            quantity: item.quantity,\r\n                            stock_before: currentStock,\r\n                            stock_after: currentStock + item.quantity,\r\n                            unit: item.unit,\r\n                            reason: `Production ${selectedSection?.name || ''} - ${dateStr}`,\r\n                            reference_id: prodRecord.id,\r\n                            staff_id: user?.id\r\n                        })\r\n                }\r\n\r\n                if (item.wasted > 0) {\r\n                    const stockAfterProduction = currentStock + item.quantity\r\n                    await supabase\r\n                        .from('stock_movements')\r\n                        .insert({\r\n                            movement_id: generateUUID(),\r\n                            product_id: item.productId,\r\n                            movement_type: 'waste',\r\n                            quantity: -item.wasted,\r\n                            stock_before: stockAfterProduction,\r\n                            stock_after: stockAfterProduction - item.wasted,\r\n                            unit: item.unit,\r\n                            reason: item.wasteReason || `Production waste ${dateStr}`,\r\n                            reference_id: prodRecord.id,\r\n                            staff_id: user?.id\r\n                        })\r\n                }\r\n\r\n                await supabase\r\n                    .from('products')\r\n                    .update({ current_stock: currentStock + netChange })\r\n                    .eq('id', item.productId)\r\n\r\n                // Deduct recipe ingredients\r\n                const { data: recipeItems } = await supabase\r\n                    .from('recipes')\r\n                    .select(`id, material_id, quantity, unit, material:products!material_id(id, name, current_stock)`)\r\n                    .eq('product_id', item.productId)\r\n                    .eq('is_active', true)\r\n\r\n                if (recipeItems && recipeItems.length > 0) {\r\n                    for (const recipe of recipeItems as any[]) {\r\n                        const rawMaterial = recipe.material\r\n                        const material = Array.isArray(rawMaterial) ? rawMaterial[0] : rawMaterial\r\n                        if (!material) continue\r\n\r\n                        const qtyToDeduct = recipe.quantity * item.quantity\r\n\r\n                        const materialStock = material.current_stock || 0\r\n                        await supabase\r\n                            .from('stock_movements')\r\n                            .insert({\r\n                                movement_id: generateUUID(),\r\n                                product_id: recipe.material_id,\r\n                                movement_type: 'production_out',\r\n                                quantity: -qtyToDeduct,\r\n                                stock_before: materialStock,\r\n                                stock_after: materialStock - qtyToDeduct,\r\n                                unit: recipe.unit || 'pcs',\r\n                                reason: `Used for: ${item.name} (×${item.quantity}) - ${dateStr}`,\r\n                                reference_id: prodRecord.id,\r\n                                staff_id: user?.id\r\n                            })\r\n\r\n                        await supabase\r\n                            .from('products')\r\n                            .update({ current_stock: (material.current_stock || 0) - qtyToDeduct })\r\n                            .eq('id', recipe.material_id)\r\n                    }\r\n                }\r\n            }\r\n\r\n            toast.success('Production saved')\r\n            setProductionItems([])\r\n            fetchTodayHistory()\r\n        } catch (error: any) {\r\n            console.error('Error saving:', error)\r\n            toast.error('Error: ' + error.message)\r\n        } finally {\r\n            setIsSaving(false)\r\n        }\r\n    }\r\n\r\n    const handleDeleteRecord = async (recordId: string) => {\r\n        if (!isAdmin) return\r\n        if (!confirm('Delete this entry and its stock movements?')) return\r\n\r\n        try {\r\n            const { data: record } = await supabase\r\n                .from('production_records')\r\n                .select('product_id, quantity_produced, quantity_waste')\r\n                .eq('id', recordId)\r\n                .single()\r\n\r\n            if (record) {\r\n                const { data: productData } = await supabase\r\n                    .from('products')\r\n                    .select('current_stock')\r\n                    .eq('id', record.product_id)\r\n                    .single()\r\n\r\n                const currentStock = productData?.current_stock || 0\r\n                const netChange = record.quantity_produced - (record.quantity_waste || 0)\r\n\r\n                await supabase\r\n                    .from('products')\r\n                    .update({ current_stock: currentStock - netChange })\r\n                    .eq('id', record.product_id)\r\n            }\r\n\r\n            await supabase\r\n                .from('stock_movements')\r\n                .delete()\r\n                .eq('reference_id', recordId)\r\n\r\n            const { error } = await supabase\r\n                .from('production_records')\r\n                .delete()\r\n                .eq('id', recordId)\r\n\r\n            if (error) throw error\r\n            toast.success('Entry deleted')\r\n            fetchTodayHistory()\r\n        } catch (error: any) {\r\n            toast.error('Error: ' + error.message)\r\n        }\r\n    }\r\n\r\n    const totalProduced = todayHistory.reduce((sum, r) => sum + r.quantity_produced, 0)\r\n    const totalWaste = todayHistory.reduce((sum, r) => sum + (r.quantity_waste || 0), 0)\r\n\r\n    return {\r\n        // State\r\n        selectedDate,\r\n        sections,\r\n        selectedSectionId,\r\n        selectedSection,\r\n        sectionProducts,\r\n        productionItems,\r\n        todayHistory,\r\n        isLoading,\r\n        isSaving,\r\n        isAdmin,\r\n        isToday,\r\n        totalProduced,\r\n        totalWaste,\r\n\r\n        // Actions\r\n        setSelectedSectionId,\r\n        navigateDate,\r\n        addProduct,\r\n        updateQuantity,\r\n        updateReason,\r\n        removeItem,\r\n        clearItems,\r\n        restoreFromReminder,\r\n        handleSave,\r\n        handleDeleteRecord,\r\n        getProductionUnit,\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useProducts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useSettings.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[844,847],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[844,847],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1013,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1013,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30551,30554],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30551,30554],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useShift.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":294,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":294,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11221,11224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11221,11224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":329,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":329,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12614,12617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12614,12617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useEffect } from 'react'\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\r\nimport { supabase } from '../lib/supabase'\r\nimport { useAuthStore } from '../stores/authStore'\r\nimport { toast } from 'sonner'\r\n\r\nexport interface PosSession {\r\n    id: string\r\n    session_number: string\r\n    user_id: string\r\n    user_name?: string\r\n    terminal_id: string | null\r\n    status: 'open' | 'closed' | 'reconciled'\r\n    opened_at: string\r\n    closed_at: string | null\r\n    opening_cash: number\r\n    expected_cash: number\r\n    expected_qris: number\r\n    expected_edc: number\r\n    actual_cash: number | null\r\n    actual_qris: number | null\r\n    actual_edc: number | null\r\n    cash_difference: number | null\r\n    qris_difference: number | null\r\n    edc_difference: number | null\r\n    total_sales: number\r\n    transaction_count: number\r\n    notes: string | null\r\n    closed_by: string | null\r\n    created_at: string\r\n    updated_at: string\r\n}\r\n\r\nexport interface ShiftTransaction {\r\n    id: string\r\n    order_number: string\r\n    total: number\r\n    payment_method: string\r\n    status: string\r\n    created_at: string\r\n    staff_id?: string\r\n}\r\n\r\nexport interface ReconciliationData {\r\n    cash: { expected: number; actual: number; difference: number }\r\n    qris: { expected: number; actual: number; difference: number }\r\n    edc: { expected: number; actual: number; difference: number }\r\n}\r\n\r\nexport interface CloseShiftResult {\r\n    session_id: string\r\n    status: string\r\n    total_sales: number\r\n    transaction_count: number\r\n    reconciliation: ReconciliationData\r\n}\r\n\r\nexport interface ShiftUser {\r\n    id: string\r\n    name: string\r\n    role: string\r\n}\r\n\r\n// Get or generate a terminal ID for this browser/device\r\nfunction getTerminalId(): string {\r\n    let terminalId = localStorage.getItem('pos_terminal_id')\r\n    if (!terminalId) {\r\n        terminalId = `TERM-${Date.now().toString(36).toUpperCase()}`\r\n        localStorage.setItem('pos_terminal_id', terminalId)\r\n    }\r\n    return terminalId\r\n}\r\n\r\n// Get or set active shift user ID from localStorage\r\nfunction getStoredActiveShiftUserId(): string | null {\r\n    return localStorage.getItem('pos_active_shift_user_id')\r\n}\r\n\r\nfunction setStoredActiveShiftUserId(userId: string | null) {\r\n    if (userId) {\r\n        localStorage.setItem('pos_active_shift_user_id', userId)\r\n    } else {\r\n        localStorage.removeItem('pos_active_shift_user_id')\r\n    }\r\n}\r\n\r\nexport function useShift() {\r\n    const queryClient = useQueryClient()\r\n    const { user } = useAuthStore()\r\n    const [reconciliationData, setReconciliationData] = useState<ReconciliationData | null>(null)\r\n    const [activeShiftUserId, setActiveShiftUserIdState] = useState<string | null>(getStoredActiveShiftUserId())\r\n\r\n    // Wrapper to persist activeShiftUserId\r\n    const setActiveShiftUserId = (userId: string | null) => {\r\n        setActiveShiftUserIdState(userId)\r\n        setStoredActiveShiftUserId(userId)\r\n    }\r\n\r\n    const terminalId = getTerminalId()\r\n\r\n    // Fetch current user's open session using RPC (bypasses RLS)\r\n    const {\r\n        data: currentSession,\r\n        isLoading: isLoadingSession,\r\n        refetch: refetchSession\r\n    } = useQuery({\r\n        queryKey: ['current-shift', activeShiftUserId || user?.id],\r\n        queryFn: async () => {\r\n            const userId = activeShiftUserId || user?.id\r\n            if (!userId) return null\r\n\r\n            // Use RPC to bypass RLS\r\n            const { data, error } = await supabase.rpc('get_user_open_shift', {\r\n                p_user_id: userId\r\n            })\r\n\r\n            if (error) {\r\n                console.error('Error fetching session:', error)\r\n                return null\r\n            }\r\n\r\n            // RPC returns an array, get first element\r\n            const session = Array.isArray(data) ? data[0] : data\r\n            return session as unknown as PosSession | null\r\n        },\r\n        enabled: !!(activeShiftUserId || user?.id)\r\n    })\r\n\r\n    // Fetch ALL open sessions on this terminal (multi-user support) using RPC\r\n    const {\r\n        data: terminalSessions = [],\r\n        isLoading: isLoadingTerminalSessions,\r\n        refetch: refetchTerminalSessions\r\n    } = useQuery({\r\n        queryKey: ['terminal-shifts', terminalId],\r\n        queryFn: async () => {\r\n            // Use RPC to bypass RLS\r\n            const { data, error } = await supabase.rpc('get_terminal_open_shifts', {\r\n                p_terminal_id: terminalId\r\n            })\r\n\r\n            if (error) {\r\n                console.error('Error fetching terminal sessions:', error)\r\n                return []\r\n            }\r\n\r\n            return (data || []) as unknown as PosSession[]\r\n        }\r\n    })\r\n\r\n    // Auto-recover shift: check for open sessions on terminal OR for the logged-in user\r\n    useEffect(() => {\r\n        async function autoRecoverShift() {\r\n            const storedUserId = getStoredActiveShiftUserId()\r\n\r\n            // If we have terminal sessions, check those first\r\n            if (!isLoadingTerminalSessions && terminalSessions.length > 0) {\r\n                const storedUserHasShift = storedUserId && terminalSessions.some(s => s.user_id === storedUserId)\r\n                if (!storedUserHasShift) {\r\n                    // Auto-select the first open shift on this terminal\r\n                    setActiveShiftUserId(terminalSessions[0].user_id)\r\n                    return\r\n                }\r\n            }\r\n\r\n            // If no terminal sessions but we have a logged-in user, check for their shifts using RPC\r\n            if (user?.id && !storedUserId) {\r\n                const { data, error } = await supabase.rpc('get_user_open_shift', {\r\n                    p_user_id: user.id\r\n                })\r\n\r\n                if (!error && data) {\r\n                    const userShift = Array.isArray(data) ? data[0] : data\r\n                    if (userShift) {\r\n                        console.log('Auto-recovered shift for logged-in user:', userShift.id)\r\n                        setActiveShiftUserId(user.id)\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        autoRecoverShift()\r\n    }, [terminalSessions, isLoadingTerminalSessions, user?.id])\r\n\r\n    // Fetch transactions for current session\r\n    const {\r\n        data: sessionTransactions = [],\r\n        isLoading: isLoadingTransactions,\r\n        refetch: refetchTransactions\r\n    } = useQuery({\r\n        queryKey: ['shift-transactions', currentSession?.id],\r\n        queryFn: async () => {\r\n            if (!currentSession?.id) return []\r\n\r\n            const { data, error } = await supabase\r\n                .from('orders')\r\n                .select('id, order_number, total, payment_method, status, created_at, staff_id')\r\n                .eq('pos_session_id', currentSession.id)\r\n                .eq('status', 'completed')\r\n                .order('created_at', { ascending: false })\r\n\r\n            if (error) {\r\n                // Fallback: query by time range if pos_session_id doesn't exist yet\r\n                const { data: fallbackData, error: fallbackError } = await supabase\r\n                    .from('orders')\r\n                    .select('id, order_number, total, payment_method, status, created_at')\r\n                    .gte('created_at', currentSession.opened_at)\r\n                    .eq('status', 'completed')\r\n                    .order('created_at', { ascending: false })\r\n\r\n                if (fallbackError) {\r\n                    console.error('Error fetching transactions:', fallbackError)\r\n                    return []\r\n                }\r\n                return fallbackData as unknown as ShiftTransaction[]\r\n            }\r\n\r\n            return data as unknown as ShiftTransaction[]\r\n        },\r\n        enabled: !!currentSession?.id\r\n    })\r\n\r\n    // Calculate session statistics\r\n    const sessionStats = {\r\n        totalSales: sessionTransactions.reduce((sum, t) => sum + t.total, 0),\r\n        transactionCount: sessionTransactions.length,\r\n        cashTotal: sessionTransactions.filter(t => t.payment_method === 'cash').reduce((sum, t) => sum + t.total, 0),\r\n        qrisTotal: sessionTransactions.filter(t => t.payment_method === 'qris').reduce((sum, t) => sum + t.total, 0),\r\n        edcTotal: sessionTransactions.filter(t => ['card', 'edc'].includes(t.payment_method)).reduce((sum, t) => sum + t.total, 0),\r\n        duration: currentSession ? Math.floor((Date.now() - new Date(currentSession.opened_at).getTime()) / 1000 / 60) : 0\r\n    }\r\n\r\n    // Open shift mutation - now accepts a specific user\r\n    const openShiftMutation = useMutation({\r\n        mutationFn: async ({ openingCash, userId, userName, notes }: {\r\n            openingCash: number\r\n            userId: string\r\n            userName: string\r\n            notes?: string\r\n        }) => {\r\n            // FIRST: Check if this user already has an open shift using RPC (bypasses RLS)\r\n            const { data: existingData, error: checkError } = await supabase.rpc('get_user_open_shift', {\r\n                p_user_id: userId\r\n            })\r\n\r\n            const existingShift = Array.isArray(existingData) ? existingData[0] : existingData\r\n\r\n            if (!checkError && existingShift) {\r\n                // User already has an open shift - recover it\r\n                console.log('Found existing shift for user, recovering:', existingShift.id)\r\n                setActiveShiftUserId(userId)\r\n                return { recovered: true, userName, session: existingShift }\r\n            }\r\n\r\n            // No existing shift found, try to open a new one\r\n            const { data, error } = await supabase.rpc('open_shift', {\r\n                p_user_id: userId,\r\n                p_opening_cash: openingCash,\r\n                p_terminal_id: terminalId,\r\n                p_notes: notes ?? undefined\r\n            })\r\n\r\n            if (error) {\r\n                console.error('Error opening shift:', error.message)\r\n                // If RPC fails for any reason, try one more time to find existing shift using RPC\r\n                const { data: retryData } = await supabase.rpc('get_user_open_shift', {\r\n                    p_user_id: userId\r\n                })\r\n\r\n                const retryShift = Array.isArray(retryData) ? retryData[0] : retryData\r\n\r\n                if (retryShift) {\r\n                    console.log('Found existing shift on retry:', retryShift.id)\r\n                    setActiveShiftUserId(userId)\r\n                    return { recovered: true, userName, session: retryShift }\r\n                }\r\n                throw error\r\n            }\r\n\r\n            // Set the active shift user\r\n            setActiveShiftUserId(userId)\r\n\r\n            return { ...(data as unknown as Record<string, unknown>), userName, recovered: false }\r\n        },\r\n        onSuccess: (data) => {\r\n            if (data.recovered) {\r\n                toast.success(`Shift récupéré pour ${data.userName}`)\r\n            } else {\r\n                toast.success(`Shift ouvert pour ${data.userName}`)\r\n            }\r\n            queryClient.invalidateQueries({ queryKey: ['current-shift'] })\r\n            queryClient.invalidateQueries({ queryKey: ['terminal-shifts'] })\r\n        },\r\n        onError: (error: any) => {\r\n            toast.error(error.message || 'Erreur lors de l\\'ouverture du shift')\r\n        }\r\n    })\r\n\r\n    // Close shift mutation\r\n    const closeShiftMutation = useMutation({\r\n        mutationFn: async ({ sessionId, actualCash, actualQris, actualEdc, closedBy, notes }: {\r\n            sessionId: string\r\n            actualCash: number\r\n            actualQris: number\r\n            actualEdc: number\r\n            closedBy: string\r\n            notes?: string\r\n        }) => {\r\n            const { data, error } = await supabase.rpc('close_shift', {\r\n                p_session_id: sessionId,\r\n                p_actual_cash: actualCash,\r\n                p_actual_qris: actualQris,\r\n                p_actual_edc: actualEdc,\r\n                p_closed_by: closedBy,\r\n                p_notes: notes ?? undefined\r\n            })\r\n\r\n            if (error) throw error\r\n            return data as unknown as CloseShiftResult\r\n        },\r\n        onSuccess: (data) => {\r\n            toast.success('Shift fermé avec succès')\r\n            setReconciliationData(data.reconciliation)\r\n            setActiveShiftUserId(null)\r\n            queryClient.invalidateQueries({ queryKey: ['current-shift'] })\r\n            queryClient.invalidateQueries({ queryKey: ['terminal-shifts'] })\r\n            queryClient.invalidateQueries({ queryKey: ['shift-transactions'] })\r\n        },\r\n        onError: (error: any) => {\r\n            toast.error(error.message || 'Erreur lors de la fermeture du shift')\r\n        }\r\n    })\r\n\r\n    // Fetch recent closed sessions\r\n    const {\r\n        data: recentSessions = [],\r\n        isLoading: isLoadingHistory\r\n    } = useQuery({\r\n        queryKey: ['shift-history', terminalId],\r\n        queryFn: async () => {\r\n            const { data, error } = await supabase\r\n                .from('pos_sessions')\r\n                .select('*')\r\n                .eq('terminal_id_str', terminalId)\r\n                .neq('status', 'open')\r\n                .order('closed_at', { ascending: false })\r\n                .limit(10)\r\n\r\n            if (error) {\r\n                console.error('Error fetching history:', error)\r\n                return []\r\n            }\r\n\r\n            return data as unknown as PosSession[]\r\n        }\r\n    })\r\n\r\n    // Open shift for a specific user (after PIN verification)\r\n    const openShift = useCallback((openingCash: number, userId: string, userName: string, notes?: string) => {\r\n        return openShiftMutation.mutateAsync({ openingCash, userId, userName, notes })\r\n    }, [openShiftMutation])\r\n\r\n    // Close shift\r\n    const closeShift = useCallback((actualCash: number, actualQris: number, actualEdc: number, closedBy: string, notes?: string) => {\r\n        if (!currentSession?.id) throw new Error('No active session')\r\n        return closeShiftMutation.mutateAsync({\r\n            sessionId: currentSession.id,\r\n            actualCash,\r\n            actualQris,\r\n            actualEdc,\r\n            closedBy,\r\n            notes\r\n        })\r\n    }, [closeShiftMutation, currentSession])\r\n\r\n    // Switch to a different user's shift on this terminal\r\n    const switchToShift = useCallback((userId: string) => {\r\n        setActiveShiftUserId(userId)\r\n    }, [])\r\n\r\n    // Manual recovery: find and activate any open shift for a user using RPC (bypasses RLS)\r\n    const recoverShift = useCallback(async (userId: string) => {\r\n        console.log('Attempting to recover shift for user:', userId)\r\n\r\n        const { data, error } = await supabase.rpc('get_user_open_shift', {\r\n            p_user_id: userId\r\n        })\r\n\r\n        console.log('Recovery RPC result:', { data, error })\r\n\r\n        if (error) {\r\n            console.error('Error recovering shift:', error)\r\n            // Show more specific error message\r\n            if (error.message?.includes('function') || error.code === '42883') {\r\n                toast.error('Fonction RPC manquante - appliquez la migration SQL')\r\n            } else {\r\n                toast.error(`Erreur: ${error.message || 'Récupération impossible'}`)\r\n            }\r\n            return null\r\n        }\r\n\r\n        const existingShift = Array.isArray(data) ? data[0] : data\r\n\r\n        if (existingShift) {\r\n            setActiveShiftUserId(userId)\r\n            queryClient.invalidateQueries({ queryKey: ['current-shift'] })\r\n            queryClient.invalidateQueries({ queryKey: ['terminal-shifts'] })\r\n            toast.success('Shift récupéré')\r\n            return existingShift\r\n        }\r\n\r\n        // No shift found - show info message\r\n        toast.error('Aucun shift ouvert trouvé pour cet utilisateur')\r\n        return null\r\n    }, [queryClient])\r\n\r\n    const clearReconciliation = useCallback(() => {\r\n        setReconciliationData(null)\r\n    }, [])\r\n\r\n    return {\r\n        // State\r\n        currentSession,\r\n        hasOpenShift: !!currentSession,\r\n        isLoadingSession,\r\n        terminalSessions,\r\n        isLoadingTerminalSessions,\r\n        terminalId,\r\n        activeShiftUserId,\r\n        sessionTransactions,\r\n        isLoadingTransactions,\r\n        sessionStats,\r\n        recentSessions,\r\n        isLoadingHistory,\r\n        reconciliationData,\r\n\r\n        // Actions\r\n        openShift,\r\n        closeShift,\r\n        switchToShift,\r\n        recoverShift,\r\n        clearReconciliation,\r\n        refetchSession,\r\n        refetchTransactions,\r\n        refetchTerminalSessions,\r\n\r\n        // Mutation states\r\n        isOpeningShift: openShiftMutation.isPending,\r\n        isClosingShift: closeShiftMutation.isPending\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useSyncQueue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useSyncReport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\hooks\\useTerminal.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2460,2463],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2460,2463],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2745,2748],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2745,2748],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3240,3243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3240,3243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3945,3948],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3945,3948],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":154,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4595,4598],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4595,4598],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":178,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5217,5220],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5217,5220],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\layouts\\BackOfficeLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\lib\\db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\auth\\LoginPage.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'user' is never reassigned. Use 'const' instead.","line":196,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":196,"endColumn":13,"fix":{"range":[6876,6926],"text":"const user = users.find(u => u.id === selectedUser);"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useAuthStore } from '../../stores/authStore';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { toast } from 'sonner';\r\nimport './LoginPage.css';\r\nimport { UserProfile } from '../../types/database';\r\nimport type { Role } from '../../types/auth';\r\n// Offline authentication imports (Story 1.2)\r\nimport { useNetworkStatus, useOfflineAuth } from '../../hooks/offline';\r\n\r\nexport default function LoginPage() {\r\n  const navigate = useNavigate();\r\n  const { loginWithPin, isLoading: authLoading, isAuthenticated } = useAuthStore();\r\n\r\n  // Offline authentication hooks (Story 1.2)\r\n  const { isOffline } = useNetworkStatus();\r\n  const {\r\n    loginOffline,\r\n    isRateLimited,\r\n    cooldownSeconds,\r\n    clearError: clearOfflineError,\r\n  } = useOfflineAuth();\r\n\r\n  const [users, setUsers] = useState<UserProfile[]>([]);\r\n  const [selectedUser, setSelectedUser] = useState<string>('');\r\n  const [pin, setPin] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const [attemptsRemaining, setAttemptsRemaining] = useState<number | null>(null);\r\n  const [lockedUntil, setLockedUntil] = useState<string | null>(null);\r\n\r\n  // Redirect if already authenticated\r\n  useEffect(() => {\r\n    if (isAuthenticated) {\r\n      navigate('/pos');\r\n    }\r\n  }, [isAuthenticated, navigate]);\r\n\r\n  // Demo users fallback - ONLY enabled in development mode\r\n  // In production, this should be empty to prevent credential exposure\r\n  const isDevelopment = import.meta.env.DEV;\r\n  const DEMO_USERS: UserProfile[] = isDevelopment ? [\r\n    { id: 'a1110000-0000-0000-0000-000000000001', name: 'Apni', role: 'cashier', pin_code: import.meta.env.VITE_DEMO_PIN_CASHIER || '', is_active: true } as UserProfile,\r\n    { id: 'a1110000-0000-0000-0000-000000000002', name: 'Dani', role: 'manager', pin_code: import.meta.env.VITE_DEMO_PIN_MANAGER || '', is_active: true } as UserProfile,\r\n    { id: 'a1110000-0000-0000-0000-000000000004', name: 'Bayu', role: 'barista', pin_code: import.meta.env.VITE_DEMO_PIN_BARISTA || '', is_active: true } as UserProfile,\r\n    { id: 'a1110000-0000-0000-0000-000000000005', name: 'Admin', role: 'admin', pin_code: import.meta.env.VITE_DEMO_PIN_ADMIN || '', is_active: true } as UserProfile,\r\n  ] : [];\r\n\r\n  // Load real users from Supabase (with demo fallback)\r\n  useEffect(() => {\r\n    async function loadUsers() {\r\n      try {\r\n        const { data, error } = await supabase\r\n          .from('user_profiles')\r\n          .select('id, name, display_name, role, is_active, avatar_url, employee_code, pin_code')\r\n          .eq('is_active', true)\r\n          .order('name');\r\n\r\n        if (error) throw error;\r\n\r\n        // If Supabase returns empty (RLS blocking), use demo users\r\n        if (data && data.length > 0) {\r\n          setUsers(data as UserProfile[]);\r\n        } else {\r\n          console.warn('No users from Supabase, using demo fallback');\r\n          setUsers(DEMO_USERS);\r\n        }\r\n      } catch (err) {\r\n        console.error('Error loading users:', err);\r\n        // Fallback to demo users on error\r\n        setUsers(DEMO_USERS);\r\n        toast.error('Demo mode activated (database inaccessible)');\r\n      }\r\n    }\r\n    loadUsers();\r\n  }, []);\r\n\r\n  const handleNumpadKey = (key: string) => {\r\n    setError('');\r\n    setAttemptsRemaining(null);\r\n\r\n    if (key === 'clear') {\r\n      setPin('');\r\n    } else if (key === 'backspace') {\r\n      setPin(prev => prev.slice(0, -1));\r\n    } else if (pin.length < 6) {\r\n      setPin(prev => prev + key);\r\n    }\r\n  };\r\n\r\n  const handleLogin = async () => {\r\n    if (!selectedUser) {\r\n      setError('Select a user');\r\n      return;\r\n    }\r\n    if (pin.length < 4) {\r\n      setError('PIN too short');\r\n      return;\r\n    }\r\n\r\n    // Check rate limiting for offline auth (Story 1.2)\r\n    if (isRateLimited) {\r\n      setError(`Too many attempts. Please wait ${cooldownSeconds} seconds`);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError('');\r\n    clearOfflineError();\r\n    setAttemptsRemaining(null);\r\n    setLockedUntil(null);\r\n\r\n    // OFFLINE MODE: Use offline authentication (Story 1.2)\r\n    if (isOffline) {\r\n      try {\r\n        await loginOffline(selectedUser, pin);\r\n        const user = users.find(u => u.id === selectedUser);\r\n        toast.success(`Welcome, ${user?.display_name || user?.name}! (Offline Mode)`);\r\n        navigate('/pos');\r\n        return;\r\n      } catch (offlineErr) {\r\n        const errCode = (offlineErr as Error).message;\r\n        if (errCode === 'CACHE_EXPIRED') {\r\n          setError('Session expired. Online login required.');\r\n        } else if (errCode === 'RATE_LIMITED') {\r\n          setError(`Too many attempts. Please wait ${cooldownSeconds} seconds`);\r\n        } else {\r\n          // Generic error for security (don't reveal cache state)\r\n          setError('Incorrect PIN');\r\n        }\r\n        setIsLoading(false);\r\n        return;\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n\r\n    // ONLINE MODE: Standard authentication flow\r\n    try {\r\n      // Try the new auth system first\r\n      const result = await loginWithPin(selectedUser, pin);\r\n\r\n      if (result.success) {\r\n        const user = users.find(u => u.id === selectedUser);\r\n        toast.success(`Welcome, ${user?.display_name || user?.name}!`);\r\n        navigate('/pos');\r\n        return;\r\n      }\r\n\r\n      // Handle specific errors\r\n      if (result.error === 'account_locked') {\r\n        setLockedUntil(result.error);\r\n        setError('Account locked. Try again in 15 minutes.');\r\n      } else {\r\n        // Fallback to legacy login for all other errors (demo mode)\r\n        await handleLegacyLogin();\r\n      }\r\n    } catch (err) {\r\n      console.error('Login error:', err);\r\n      // Fallback to legacy login\r\n      await handleLegacyLogin();\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Demo login fallback - only for when bcrypt RPC is unavailable\r\n  const handleDemoLogin = async (user: UserProfile) => {\r\n    // Try to get plaintext PIN from demo users\r\n    const demoUser = DEMO_USERS.find(u =>\r\n      u.name.toLowerCase() === user?.name?.toLowerCase() ||\r\n      u.id === user.id\r\n    );\r\n\r\n    if (!demoUser?.pin_code) {\r\n      setError('No PIN set (demo mode)');\r\n      return;\r\n    }\r\n\r\n    if (demoUser.pin_code !== pin) {\r\n      setError('Invalid PIN');\r\n      return;\r\n    }\r\n\r\n    // Demo login successful - load basic permissions\r\n    const { login } = useAuthStore.getState();\r\n    login(user);\r\n    toast.success(`Welcome, ${user.display_name || user.name}! (Demo)`);\r\n    navigate('/pos');\r\n  };\r\n\r\n  // Legacy login for demo mode or when Edge Functions are unavailable\r\n  const handleLegacyLogin = async () => {\r\n    // First check if we have PIN in current users list\r\n    let user = users.find(u => u.id === selectedUser);\r\n\r\n    if (!user) {\r\n      setError('User not found');\r\n      return;\r\n    }\r\n\r\n    // Use secure bcrypt verification via RPC (preferred method)\r\n    try {\r\n      const { data: isValid, error: verifyError } = await supabase.rpc('verify_user_pin', {\r\n        p_user_id: selectedUser,\r\n        p_pin: pin\r\n      });\r\n\r\n      if (verifyError) {\r\n        console.error('PIN verification error:', verifyError);\r\n        // Fall back to plaintext check for demo mode\r\n        await handleDemoLogin(user);\r\n        return;\r\n      }\r\n\r\n      if (!isValid) {\r\n        setError('Invalid PIN');\r\n        return;\r\n      }\r\n    } catch (rpcError) {\r\n      console.error('RPC error, falling back to demo:', rpcError);\r\n      await handleDemoLogin(user);\r\n      return;\r\n    }\r\n\r\n    // Load roles and permissions from database for legacy login\r\n    try {\r\n      // Get user roles\r\n      const { data: userRoles } = await supabase\r\n        .from('user_roles')\r\n        .select(`\r\n          id,\r\n          is_primary,\r\n          role:roles (id, code, name_fr, name_en, name_id, hierarchy_level)\r\n        `)\r\n        .eq('user_id', user.id) as { data: Array<{ id: string; is_primary: boolean; role: { id: string; code: string; name_fr: string; name_en: string; name_id: string; hierarchy_level: number } | null }> | null };\r\n\r\n      const roles: Role[] = (userRoles?.map(ur => ur.role).filter((r): r is NonNullable<typeof r> => r !== null) || []).map(r => ({\r\n        id: r.id,\r\n        code: r.code,\r\n        name_fr: r.name_fr,\r\n        name_en: r.name_en,\r\n        name_id: r.name_id,\r\n        description: null,\r\n        is_system: false,\r\n        is_active: true,\r\n        hierarchy_level: r.hierarchy_level,\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString(),\r\n      }));\r\n\r\n      // Get permissions from role_permissions\r\n      const roleIds = roles.map((r) => (r as { id: string }).id);\r\n      let permissions: { permission_code: string; permission_module: string; permission_action: string; is_granted: boolean; is_sensitive: boolean; source: 'direct' | 'role' }[] = [];\r\n\r\n      if (roleIds.length > 0) {\r\n        const { data: rolePerms } = await supabase\r\n          .from('role_permissions')\r\n          .select(`\r\n            permission:permissions (code, module, action, is_sensitive)\r\n          `)\r\n          .in('role_id', roleIds) as { data: Array<{ permission: { code: string; module: string; action: string; is_sensitive: boolean } | null }> | null };\r\n\r\n        permissions = rolePerms?.map(rp => ({\r\n          permission_code: rp.permission?.code || '',\r\n          permission_module: rp.permission?.module || '',\r\n          permission_action: rp.permission?.action || '',\r\n          is_granted: true,\r\n          is_sensitive: rp.permission?.is_sensitive || false,\r\n          source: 'role' as const,\r\n        })).filter(p => p.permission_code) || [];\r\n      }\r\n\r\n      // Update auth store with roles and permissions\r\n      useAuthStore.setState({\r\n        user,\r\n        roles,\r\n        permissions,\r\n        isAuthenticated: true,\r\n        isLoading: false,\r\n      });\r\n\r\n      toast.success(`Welcome, ${user.display_name || user.name}!`);\r\n      navigate('/pos');\r\n    } catch (err) {\r\n      console.error('Error loading permissions:', err);\r\n      // Fallback to basic login without permissions\r\n      const { login } = useAuthStore.getState();\r\n      login(user);\r\n      toast.success(`Welcome, ${user.display_name || user.name}!`);\r\n      navigate('/pos');\r\n    }\r\n  };\r\n\r\n  const selectedUserData = users.find(u => u.id === selectedUser);\r\n\r\n  return (\r\n    <div className=\"login-page\">\r\n      <div className=\"login-card\">\r\n        {/* Logo */}\r\n        <div className=\"login-logo\">\r\n          <span className=\"login-logo__icon\">🥐</span>\r\n          <h1 className=\"login-logo__text\">The Breakery</h1>\r\n          <p className=\"login-logo__subtitle\">Login</p>\r\n        </div>\r\n\r\n        {/* Offline Mode Indicator (Story 1.2) */}\r\n        {isOffline && (\r\n          <div className=\"login-offline-indicator\">\r\n            <span>📶</span>\r\n            <span>Offline Mode</span>\r\n          </div>\r\n        )}\r\n\r\n        {/* Rate Limit Cooldown Display (Story 1.2) */}\r\n        {isRateLimited && (\r\n          <div className=\"login-cooldown\">\r\n            <span>Please wait...</span>\r\n            <span className=\"login-cooldown__timer\">{cooldownSeconds}s</span>\r\n          </div>\r\n        )}\r\n\r\n        {/* User Selection */}\r\n        <div className=\"login-section\">\r\n          <label className=\"login-label\">\r\n            Select a user\r\n          </label>\r\n          <select\r\n            className=\"login-select\"\r\n            value={selectedUser}\r\n            onChange={(e) => {\r\n              setSelectedUser(e.target.value);\r\n              setPin('');\r\n              setError('');\r\n              setAttemptsRemaining(null);\r\n              setLockedUntil(null);\r\n            }}\r\n            title=\"Select a user\"\r\n            aria-label=\"User profile selection\"\r\n          >\r\n            <option value=\"\">-- Choose --</option>\r\n            {users.map(user => (\r\n              <option key={user.id} value={user.id}>\r\n                {user.display_name || user.name}\r\n                {user.employee_code ? ` (${user.employee_code})` : ` (${user.role})`}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        {/* Selected User Avatar */}\r\n        {selectedUserData && (\r\n          <div className=\"login-avatar\">\r\n            {selectedUserData.avatar_url ? (\r\n              <img\r\n                src={selectedUserData.avatar_url}\r\n                alt={selectedUserData.name}\r\n                className=\"login-avatar__img\"\r\n              />\r\n            ) : (\r\n              <div className=\"login-avatar__placeholder\">\r\n                {(selectedUserData.display_name || selectedUserData.name).charAt(0).toUpperCase()}\r\n              </div>\r\n            )}\r\n            <span className=\"login-avatar__name\">\r\n              {selectedUserData.display_name || selectedUserData.name}\r\n            </span>\r\n          </div>\r\n        )}\r\n\r\n        {/* PIN Entry */}\r\n        {selectedUser && (\r\n          <div className=\"login-section\">\r\n            <label className=\"login-label\">\r\n              PIN Code\r\n            </label>\r\n            <div className=\"pin-display\">\r\n              {[...Array(6)].map((_, i) => (\r\n                <span key={i} className={`pin-dot ${i < pin.length ? 'filled' : ''}`} />\r\n              ))}\r\n            </div>\r\n\r\n            {/* Numpad */}\r\n            <div className=\"numpad login-numpad\">\r\n              {['1', '2', '3', '4', '5', '6', '7', '8', '9', 'clear', '0', 'backspace'].map(key => (\r\n                <button\r\n                  key={key}\r\n                  className={`numpad__key ${key === 'clear' ? 'clear' : ''} ${key === 'backspace' ? 'backspace' : ''}`}\r\n                  onClick={() => handleNumpadKey(key)}\r\n                  disabled={isLoading || authLoading}\r\n                >\r\n                  {key === 'clear' ? 'C' : key === 'backspace' ? '⌫' : key}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Error Message */}\r\n        {error && (\r\n          <div className=\"login-error\">\r\n            {error}\r\n            {attemptsRemaining !== null && attemptsRemaining > 0 && (\r\n              <span className=\"login-error__attempts\">\r\n                {' '}({attemptsRemaining} attempts remaining)\r\n              </span>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Locked Message */}\r\n        {lockedUntil && (\r\n          <div className=\"login-locked\">\r\n            Account temporarily locked\r\n          </div>\r\n        )}\r\n\r\n        {/* Login Button */}\r\n        <button\r\n          type=\"button\"\r\n          className=\"btn btn-primary btn-block login-btn\"\r\n          onClick={handleLogin}\r\n          disabled={!selectedUser || pin.length < 4 || isLoading || authLoading}\r\n        >\r\n          {isLoading || authLoading ? 'Loading...' : 'Sign in'}\r\n        </button>\r\n\r\n        {/* Demo hint - only shown in development */}\r\n        {isDevelopment && import.meta.env.VITE_SHOW_DEMO_HINT === 'true' && (\r\n          <p className=\"login-hint\">\r\n            Demo mode - check .env for PINs\r\n          </p>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\b2b\\B2BOrderDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2435,2438],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2435,2438],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":275,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":275,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9351,9354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9351,9354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":290,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9788,9791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9788,9791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":337,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11601,11604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11601,11604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { useNavigate, useParams } from 'react-router-dom'\r\nimport {\r\n    ArrowLeft, Edit2, Printer, Truck, CreditCard, Clock,\r\n    CheckCircle, Package, AlertCircle, FileText, MapPin,\r\n    Phone, Mail, Calendar, Plus, X, User\r\n} from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { formatCurrency } from '../../utils/helpers'\r\nimport PinVerificationModal from '../../components/pos/modals/PinVerificationModal'\r\nimport './B2BOrderDetailPage.css'\r\n\r\ninterface B2BOrder {\r\n    id: string\r\n    order_number: string\r\n    customer_id: string\r\n    customer?: {\r\n        id: string\r\n        name: string\r\n        company_name: string | null\r\n        phone: string | null\r\n        email: string | null\r\n        address: string | null\r\n    }\r\n    status: 'draft' | 'confirmed' | 'processing' | 'ready' | 'partially_delivered' | 'delivered' | 'cancelled'\r\n    order_date: string\r\n    requested_delivery_date: string | null\r\n    actual_delivery_date: string | null\r\n    delivery_address: string | null\r\n    delivery_notes: string | null\r\n    subtotal: number\r\n    discount_type: string | null\r\n    discount_value: number\r\n    discount_amount: number\r\n    tax_rate: number\r\n    tax_amount: number\r\n    total_amount: number\r\n    payment_status: 'unpaid' | 'partial' | 'paid'\r\n    payment_terms: string | null\r\n    due_date: string | null\r\n    amount_paid: number\r\n    amount_due: number\r\n    notes: string | null\r\n    internal_notes: string | null\r\n    created_at: string\r\n}\r\n\r\ninterface OrderItem {\r\n    id: string\r\n    product_id: string | null\r\n    product_name: string\r\n    product_sku: string | null\r\n    quantity: number\r\n    unit: string\r\n    unit_price: number\r\n    discount_percentage: number\r\n    discount_amount: number\r\n    line_total: number\r\n    quantity_delivered: number\r\n    quantity_remaining: number\r\n}\r\n\r\ninterface Payment {\r\n    id: string\r\n    payment_number: string\r\n    amount: number\r\n    payment_method: string\r\n    payment_date: string\r\n    reference_number: string | null\r\n    status: string\r\n}\r\n\r\ninterface Delivery {\r\n    id: string\r\n    delivery_number: string\r\n    status: string\r\n    scheduled_date: string | null\r\n    actual_date: string | null\r\n    driver_name: string | null\r\n    received_by: string | null\r\n}\r\n\r\ninterface HistoryEntry {\r\n    id: string\r\n    action_type: string\r\n    description: string\r\n    created_at: string\r\n    metadata: any\r\n}\r\n\r\nconst STATUS_CONFIG = {\r\n    draft: { label: 'Brouillon', color: 'gray', icon: FileText },\r\n    confirmed: { label: 'Confirmée', color: 'blue', icon: CheckCircle },\r\n    processing: { label: 'En préparation', color: 'yellow', icon: Clock },\r\n    ready: { label: 'Prête', color: 'purple', icon: Package },\r\n    partially_delivered: { label: 'Livr. partielle', color: 'orange', icon: Truck },\r\n    delivered: { label: 'Livrée', color: 'green', icon: CheckCircle },\r\n    cancelled: { label: 'Annulée', color: 'red', icon: AlertCircle }\r\n}\r\n\r\nconst PAYMENT_METHODS = {\r\n    cash: 'Espèces',\r\n    transfer: 'Virement',\r\n    check: 'Chèque',\r\n    card: 'Carte',\r\n    qris: 'QRIS',\r\n    credit: 'Crédit'\r\n}\r\n\r\nexport default function B2BOrderDetailPage() {\r\n    const navigate = useNavigate()\r\n    const { id } = useParams()\r\n\r\n    const [order, setOrder] = useState<B2BOrder | null>(null)\r\n    const [items, setItems] = useState<OrderItem[]>([])\r\n    const [payments, setPayments] = useState<Payment[]>([])\r\n    const [deliveries, setDeliveries] = useState<Delivery[]>([])\r\n    const [history, setHistory] = useState<HistoryEntry[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [activeTab, setActiveTab] = useState<'items' | 'payments' | 'deliveries' | 'history'>('items')\r\n\r\n    // Payment modal\r\n    const [showPaymentModal, setShowPaymentModal] = useState(false)\r\n    const [paymentForm, setPaymentForm] = useState({\r\n        amount: 0,\r\n        payment_method: 'transfer',\r\n        reference_number: '',\r\n        notes: ''\r\n    })\r\n\r\n    // PIN verification modal for editing delivered orders\r\n    const [showPinModal, setShowPinModal] = useState(false)\r\n\r\n    useEffect(() => {\r\n        if (id) {\r\n            fetchOrder()\r\n            fetchItems()\r\n            fetchPayments()\r\n            fetchDeliveries()\r\n            fetchHistory()\r\n        }\r\n    }, [id])\r\n\r\n    const fetchOrder = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('b2b_orders')\r\n                .select(`\r\n                    *,\r\n                    customer:customers(id, name, company_name, phone, email, address)\r\n                `)\r\n                .eq('id', id!)\r\n                .single()\r\n\r\n            if (error) throw error\r\n            // Map database fields to UI expected fields\r\n            if (data) {\r\n                // Convert tax_rate from decimal (0.10) to percentage (10)\r\n                const dbTaxRate = data.tax_rate ?? 0.1\r\n                const displayTaxRate = dbTaxRate < 1 ? dbTaxRate * 100 : dbTaxRate\r\n\r\n                const mappedOrder = {\r\n                    ...data,\r\n                    total_amount: data.total ?? data.total_amount ?? 0,\r\n                    amount_paid: data.paid_amount ?? data.amount_paid ?? 0,\r\n                    amount_due: (data.total ?? data.total_amount ?? 0) - (data.paid_amount ?? data.amount_paid ?? 0),\r\n                    requested_delivery_date: data.delivery_date,\r\n                    actual_delivery_date: data.delivered_at,\r\n                    discount_type: data.discount_percent ? 'percentage' : null,\r\n                    discount_value: data.discount_percent ?? 0,\r\n                    payment_status: data.payment_status ?? 'unpaid',\r\n                    tax_rate: displayTaxRate,\r\n                } as unknown as B2BOrder\r\n                setOrder(mappedOrder)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching order:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const fetchItems = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('b2b_order_items')\r\n                .select('*')\r\n                .eq('order_id', id!)\r\n                .order('created_at')\r\n\r\n            if (error) throw error\r\n            if (data) {\r\n                // Map database fields to UI expected fields\r\n                const mappedItems = data.map(item => ({\r\n                    id: item.id,\r\n                    product_id: item.product_id,\r\n                    product_name: item.product_name,\r\n                    product_sku: item.product_sku,\r\n                    quantity: item.quantity,\r\n                    unit: 'pcs', // Default unit since DB doesn't have it\r\n                    unit_price: item.unit_price,\r\n                    discount_percentage: item.discount_percent ?? 0,\r\n                    discount_amount: (item.unit_price * item.quantity * (item.discount_percent ?? 0)) / 100,\r\n                    line_total: item.total,\r\n                    quantity_delivered: 0, // Not tracked in DB\r\n                    quantity_remaining: item.quantity,\r\n                })) as unknown as OrderItem[]\r\n                setItems(mappedItems)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching items:', error)\r\n        }\r\n    }\r\n\r\n    const fetchPayments = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('b2b_payments')\r\n                .select('*')\r\n                .eq('order_id', id!)\r\n                .order('payment_date', { ascending: false })\r\n\r\n            if (error) throw error\r\n            if (data) setPayments(data as unknown as Payment[])\r\n        } catch (error) {\r\n            console.error('Error fetching payments:', error)\r\n        }\r\n    }\r\n\r\n    const fetchDeliveries = async () => {\r\n        try {\r\n            // Note: b2b_deliveries table may not exist in DB schema\r\n            // Wrapping in try-catch to handle gracefully\r\n            const { data, error } = await supabase\r\n                .from('b2b_deliveries')\r\n                .select('*')\r\n                .eq('order_id', id!)\r\n                .order('scheduled_date', { ascending: false })\r\n\r\n            if (error) {\r\n                // Table might not exist, set empty array\r\n                setDeliveries([])\r\n                return\r\n            }\r\n            if (data) setDeliveries(data as unknown as Delivery[])\r\n        } catch (error) {\r\n            console.error('Error fetching deliveries:', error)\r\n            setDeliveries([])\r\n        }\r\n    }\r\n\r\n    const fetchHistory = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('b2b_order_history')\r\n                .select('*')\r\n                .eq('order_id', id!)\r\n                .order('created_at', { ascending: false })\r\n\r\n            if (error) {\r\n                setHistory([])\r\n                return\r\n            }\r\n            if (data) setHistory(data as unknown as HistoryEntry[])\r\n        } catch (error) {\r\n            console.error('Error fetching history:', error)\r\n            setHistory([])\r\n        }\r\n    }\r\n\r\n    const updateOrderStatus = async (newStatus: string) => {\r\n        if (!order) return\r\n\r\n        try {\r\n            const updateData: any = { status: newStatus }\r\n\r\n            if (newStatus === 'delivered') {\r\n                updateData.delivered_at = new Date().toISOString()\r\n            }\r\n\r\n            const { error } = await supabase\r\n                .from('b2b_orders')\r\n                .update(updateData)\r\n                .eq('id', order.id)\r\n\r\n            if (error) throw error\r\n\r\n            fetchOrder()\r\n            fetchHistory()\r\n        } catch (error: any) {\r\n            console.error('Error updating status:', error)\r\n            alert(`Erreur lors de la mise à jour du statut: ${error?.message || 'Erreur inconnue'}`)\r\n        }\r\n    }\r\n\r\n    const handleAddPayment = async () => {\r\n        if (!order) {\r\n            alert('Erreur: Commande non chargée')\r\n            return\r\n        }\r\n        if (paymentForm.amount <= 0) {\r\n            alert('Erreur: Le montant doit être supérieur à 0')\r\n            return\r\n        }\r\n\r\n        try {\r\n            const paymentNumber = `PAY-${Date.now()}-${Math.random().toString(36).substring(2, 7).toUpperCase()}`\r\n            console.log('Inserting payment:', {\r\n                order_id: order.id,\r\n                customer_id: order.customer_id,\r\n                amount: paymentForm.amount,\r\n                payment_method: paymentForm.payment_method,\r\n                payment_number: paymentNumber,\r\n            })\r\n\r\n            const { data, error } = await supabase\r\n                .from('b2b_payments')\r\n                .insert({\r\n                    order_id: order.id,\r\n                    customer_id: order.customer_id,\r\n                    amount: paymentForm.amount,\r\n                    payment_method: paymentForm.payment_method,\r\n                    payment_number: paymentNumber,\r\n                    reference_number: paymentForm.reference_number || null,\r\n                    notes: paymentForm.notes || null\r\n                })\r\n                .select()\r\n\r\n            if (error) throw error\r\n\r\n            console.log('Payment inserted:', data)\r\n            setShowPaymentModal(false)\r\n            setPaymentForm({ amount: 0, payment_method: 'transfer', reference_number: '', notes: '' })\r\n            fetchOrder()\r\n            fetchPayments()\r\n            fetchHistory()\r\n        } catch (error: any) {\r\n            console.error('Error adding payment:', error)\r\n            alert(`Erreur: ${error?.message || JSON.stringify(error)}`)\r\n        }\r\n    }\r\n\r\n    const formatDate = (dateString: string | null) => {\r\n        if (!dateString) return '-'\r\n        return new Date(dateString).toLocaleDateString('fr-FR', {\r\n            day: '2-digit',\r\n            month: 'short',\r\n            year: 'numeric'\r\n        })\r\n    }\r\n\r\n    const formatDateTime = (dateString: string) => {\r\n        return new Date(dateString).toLocaleString('fr-FR', {\r\n            day: '2-digit',\r\n            month: 'short',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        })\r\n    }\r\n\r\n    const getStatusBadge = (status: keyof typeof STATUS_CONFIG) => {\r\n        const config = STATUS_CONFIG[status]\r\n        const Icon = config.icon\r\n        return (\r\n            <span className={`b2b-detail-status b2b-detail-status--${config.color}`}>\r\n                <Icon size={16} />\r\n                {config.label}\r\n            </span>\r\n        )\r\n    }\r\n\r\n    const getPaymentStatusBadge = (status: string) => {\r\n        const config = {\r\n            unpaid: { label: 'Non payé', color: 'red' },\r\n            partial: { label: 'Partiel', color: 'orange' },\r\n            paid: { label: 'Payé', color: 'green' },\r\n            overdue: { label: 'En retard', color: 'red' }\r\n        }[status] || { label: status, color: 'gray' }\r\n\r\n        return (\r\n            <span className={`b2b-payment-status b2b-payment-status--${config.color}`}>\r\n                {config.label}\r\n            </span>\r\n        )\r\n    }\r\n\r\n    // Check if order requires PIN to edit (delivered or partially delivered)\r\n    const requiresPinToEdit = order?.status === 'delivered' || order?.status === 'partially_delivered'\r\n\r\n    const handleEditClick = () => {\r\n        if (requiresPinToEdit) {\r\n            setShowPinModal(true)\r\n        } else {\r\n            navigate(`/b2b/orders/${id}/edit`)\r\n        }\r\n    }\r\n\r\n    const handlePinVerify = (verified: boolean) => {\r\n        setShowPinModal(false)\r\n        if (verified) {\r\n            navigate(`/b2b/orders/${id}/edit`)\r\n        }\r\n    }\r\n\r\n    const handlePrint = () => {\r\n        if (!order) return\r\n\r\n        const printWindow = window.open('', '_blank')\r\n        if (!printWindow) {\r\n            alert('Impossible d\\'ouvrir la fenêtre d\\'impression. Vérifiez que les popups ne sont pas bloqués.')\r\n            return\r\n        }\r\n\r\n        const printContent = `\r\n            <!DOCTYPE html>\r\n            <html>\r\n            <head>\r\n                <title>Commande ${order.order_number}</title>\r\n                <style>\r\n                    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }\r\n                    h1 { font-size: 24px; margin-bottom: 5px; }\r\n                    .order-info { color: #666; margin-bottom: 20px; }\r\n                    .section { margin-bottom: 20px; }\r\n                    .section-title { font-size: 14px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; }\r\n                    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }\r\n                    .card { border: 1px solid #ddd; padding: 15px; border-radius: 4px; }\r\n                    .card h3 { margin: 0 0 10px; font-size: 14px; color: #666; }\r\n                    .card p { margin: 5px 0; font-size: 13px; }\r\n                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }\r\n                    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; font-size: 13px; }\r\n                    th { background: #f5f5f5; font-weight: bold; }\r\n                    .text-right { text-align: right; }\r\n                    .summary { margin-left: auto; width: 250px; }\r\n                    .summary-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 13px; }\r\n                    .summary-row.total { font-weight: bold; font-size: 16px; border-top: 2px solid #333; padding-top: 10px; margin-top: 5px; }\r\n                    .status { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; }\r\n                    .status-delivered { background: #d4edda; color: #155724; }\r\n                    .status-confirmed { background: #cce5ff; color: #004085; }\r\n                    .status-draft { background: #e2e3e5; color: #383d41; }\r\n                    @media print { body { padding: 0; } }\r\n                </style>\r\n            </head>\r\n            <body>\r\n                <h1>Commande ${order.order_number}</h1>\r\n                <p class=\"order-info\">\r\n                    Créée le ${formatDate(order.order_date)} |\r\n                    Statut: <span class=\"status status-${order.status}\">${STATUS_CONFIG[order.status]?.label || order.status}</span>\r\n                </p>\r\n\r\n                <div class=\"grid\">\r\n                    <div class=\"card\">\r\n                        <h3>Client</h3>\r\n                        <p><strong>${order.customer?.company_name || order.customer?.name || '-'}</strong></p>\r\n                        ${order.customer?.company_name ? `<p>${order.customer.name}</p>` : ''}\r\n                        ${order.customer?.phone ? `<p>Tél: ${order.customer.phone}</p>` : ''}\r\n                        ${order.customer?.email ? `<p>Email: ${order.customer.email}</p>` : ''}\r\n                    </div>\r\n                    <div class=\"card\">\r\n                        <h3>Livraison</h3>\r\n                        ${order.requested_delivery_date ? `<p>Date demandée: ${formatDate(order.requested_delivery_date)}</p>` : ''}\r\n                        ${order.actual_delivery_date ? `<p>Date livrée: ${formatDate(order.actual_delivery_date)}</p>` : ''}\r\n                        ${order.delivery_address ? `<p>Adresse: ${order.delivery_address}</p>` : ''}\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"section\">\r\n                    <div class=\"section-title\">Articles</div>\r\n                    <table>\r\n                        <thead>\r\n                            <tr>\r\n                                <th>Produit</th>\r\n                                <th class=\"text-right\">Qté</th>\r\n                                <th class=\"text-right\">Prix Unit.</th>\r\n                                <th class=\"text-right\">Remise</th>\r\n                                <th class=\"text-right\">Total</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            ${items.map(item => `\r\n                                <tr>\r\n                                    <td>\r\n                                        ${item.product_name}\r\n                                        ${item.product_sku ? `<br><small style=\"color:#666\">${item.product_sku}</small>` : ''}\r\n                                    </td>\r\n                                    <td class=\"text-right\">${item.quantity} ${item.unit}</td>\r\n                                    <td class=\"text-right\">${formatCurrency(item.unit_price)}</td>\r\n                                    <td class=\"text-right\">${item.discount_percentage > 0 ? `${item.discount_percentage}%` : '-'}</td>\r\n                                    <td class=\"text-right\">${formatCurrency(item.line_total)}</td>\r\n                                </tr>\r\n                            `).join('')}\r\n                        </tbody>\r\n                    </table>\r\n\r\n                    <div class=\"summary\">\r\n                        <div class=\"summary-row\">\r\n                            <span>Sous-total</span>\r\n                            <span>${formatCurrency(order.subtotal)}</span>\r\n                        </div>\r\n                        ${order.discount_amount > 0 ? `\r\n                        <div class=\"summary-row\">\r\n                            <span>Remise</span>\r\n                            <span>-${formatCurrency(order.discount_amount)}</span>\r\n                        </div>\r\n                        ` : ''}\r\n                        <div class=\"summary-row\">\r\n                            <span>TVA (${order.tax_rate}%)</span>\r\n                            <span>${formatCurrency(order.tax_amount)}</span>\r\n                        </div>\r\n                        <div class=\"summary-row total\">\r\n                            <span>Total</span>\r\n                            <span>${formatCurrency(order.total_amount)}</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                ${order.notes ? `\r\n                <div class=\"section\">\r\n                    <div class=\"section-title\">Notes</div>\r\n                    <p>${order.notes}</p>\r\n                </div>\r\n                ` : ''}\r\n\r\n                <script>\r\n                    window.onload = function() { window.print(); }\r\n                </script>\r\n            </body>\r\n            </html>\r\n        `\r\n\r\n        printWindow.document.write(printContent)\r\n        printWindow.document.close()\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"b2b-detail-loading\">\r\n                <div className=\"spinner\"></div>\r\n                <span>Chargement de la commande...</span>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (!order) {\r\n        return (\r\n            <div className=\"b2b-detail-error\">\r\n                <AlertCircle size={48} />\r\n                <h3>Commande introuvable</h3>\r\n                <button className=\"btn btn-primary\" onClick={() => navigate('/b2b/orders')}>\r\n                    Retour aux commandes\r\n                </button>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"b2b-order-detail-page\">\r\n            {/* Header */}\r\n            <div className=\"b2b-detail-header\">\r\n                <div className=\"b2b-detail-header__left\">\r\n                    <button className=\"btn btn-ghost\" onClick={() => navigate('/b2b/orders')}>\r\n                        <ArrowLeft size={20} />\r\n                    </button>\r\n                    <div>\r\n                        <div className=\"b2b-detail-header__number\">\r\n                            <span className=\"order-number\">{order.order_number}</span>\r\n                            {getStatusBadge(order.status)}\r\n                        </div>\r\n                        <p className=\"b2b-detail-header__date\">\r\n                            Créée le {formatDate(order.order_date)}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n                <div className=\"b2b-detail-header__actions\">\r\n                    {/* Show edit button for all orders - PIN required for delivered orders */}\r\n                    {order.status !== 'cancelled' && (\r\n                        <button className=\"btn btn-secondary\" onClick={handleEditClick}>\r\n                            <Edit2 size={18} />\r\n                            Modifier\r\n                        </button>\r\n                    )}\r\n                    <button className=\"btn btn-secondary\" onClick={handlePrint}>\r\n                        <Printer size={18} />\r\n                        Imprimer\r\n                    </button>\r\n                    {order.status === 'draft' && (\r\n                        <button className=\"btn btn-primary\" onClick={() => updateOrderStatus('confirmed')}>\r\n                            <CheckCircle size={18} />\r\n                            Confirmer\r\n                        </button>\r\n                    )}\r\n                    {order.status === 'confirmed' && (\r\n                        <button className=\"btn btn-primary\" onClick={() => updateOrderStatus('processing')}>\r\n                            <Clock size={18} />\r\n                            En préparation\r\n                        </button>\r\n                    )}\r\n                    {order.status === 'processing' && (\r\n                        <button className=\"btn btn-primary\" onClick={() => updateOrderStatus('ready')}>\r\n                            <Package size={18} />\r\n                            Prêt\r\n                        </button>\r\n                    )}\r\n                    {(order.status === 'ready' || order.status === 'partially_delivered') && (\r\n                        <button className=\"btn btn-primary\" onClick={() => updateOrderStatus('delivered')}>\r\n                            <Truck size={18} />\r\n                            Livré\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"b2b-detail-content\">\r\n                {/* Main Content */}\r\n                <div className=\"b2b-detail-main\">\r\n                    {/* Customer & Delivery Info */}\r\n                    <div className=\"b2b-detail-cards\">\r\n                        <div className=\"b2b-detail-card\">\r\n                            <h3><User size={18} /> Client</h3>\r\n                            <div className=\"b2b-detail-card__content\">\r\n                                <p className=\"company-name\">\r\n                                    {order.customer?.company_name || order.customer?.name}\r\n                                </p>\r\n                                {order.customer?.company_name && (\r\n                                    <p className=\"contact-name\">{order.customer.name}</p>\r\n                                )}\r\n                                {order.customer?.phone && (\r\n                                    <p className=\"contact-info\">\r\n                                        <Phone size={14} /> {order.customer.phone}\r\n                                    </p>\r\n                                )}\r\n                                {order.customer?.email && (\r\n                                    <p className=\"contact-info\">\r\n                                        <Mail size={14} /> {order.customer.email}\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"b2b-detail-card\">\r\n                            <h3><Truck size={18} /> Livraison</h3>\r\n                            <div className=\"b2b-detail-card__content\">\r\n                                {order.requested_delivery_date && (\r\n                                    <p className=\"delivery-date\">\r\n                                        <Calendar size={14} />\r\n                                        <span>Demandée: {formatDate(order.requested_delivery_date)}</span>\r\n                                    </p>\r\n                                )}\r\n                                {order.actual_delivery_date && (\r\n                                    <p className=\"delivery-date delivered\">\r\n                                        <CheckCircle size={14} />\r\n                                        <span>Livrée: {formatDate(order.actual_delivery_date)}</span>\r\n                                    </p>\r\n                                )}\r\n                                {order.delivery_address && (\r\n                                    <p className=\"delivery-address\">\r\n                                        <MapPin size={14} />\r\n                                        <span>{order.delivery_address}</span>\r\n                                    </p>\r\n                                )}\r\n                                {order.delivery_notes && (\r\n                                    <p className=\"delivery-notes\">{order.delivery_notes}</p>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"b2b-detail-card\">\r\n                            <h3><CreditCard size={18} /> Paiement</h3>\r\n                            <div className=\"b2b-detail-card__content\">\r\n                                <div className=\"payment-status-row\">\r\n                                    {getPaymentStatusBadge(order.payment_status)}\r\n                                </div>\r\n                                {order.payment_terms && (\r\n                                    <p className=\"payment-terms\">\r\n                                        Conditions: {order.payment_terms === 'cod' ? 'Paiement à la livraison' : `Net ${order.payment_terms.replace('net', '')} jours`}\r\n                                    </p>\r\n                                )}\r\n                                {order.due_date && (\r\n                                    <p className=\"due-date\">\r\n                                        Échéance: {formatDate(order.due_date)}\r\n                                    </p>\r\n                                )}\r\n                                <div className=\"payment-amounts\">\r\n                                    <div className=\"payment-amount\">\r\n                                        <span>Payé</span>\r\n                                        <span className=\"amount paid\">{formatCurrency(order.amount_paid)}</span>\r\n                                    </div>\r\n                                    <div className=\"payment-amount\">\r\n                                        <span>Reste dû</span>\r\n                                        <span className=\"amount due\">{formatCurrency(order.amount_due)}</span>\r\n                                    </div>\r\n                                </div>\r\n                                {order.amount_due > 0 && (\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        className=\"btn btn-primary btn-sm btn-block b2b-payment-btn\"\r\n                                        onClick={() => {\r\n                                            setPaymentForm(prev => ({ ...prev, amount: order.amount_due }))\r\n                                            setShowPaymentModal(true)\r\n                                        }}\r\n                                    >\r\n                                        <Plus size={16} />\r\n                                        Enregistrer un paiement\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Tabs */}\r\n                    <div className=\"b2b-detail-tabs\">\r\n                        <button\r\n                            className={`b2b-detail-tab ${activeTab === 'items' ? 'active' : ''}`}\r\n                            onClick={() => setActiveTab('items')}\r\n                        >\r\n                            <Package size={16} />\r\n                            Articles ({items.length})\r\n                        </button>\r\n                        <button\r\n                            className={`b2b-detail-tab ${activeTab === 'payments' ? 'active' : ''}`}\r\n                            onClick={() => setActiveTab('payments')}\r\n                        >\r\n                            <CreditCard size={16} />\r\n                            Paiements ({payments.length})\r\n                        </button>\r\n                        <button\r\n                            className={`b2b-detail-tab ${activeTab === 'deliveries' ? 'active' : ''}`}\r\n                            onClick={() => setActiveTab('deliveries')}\r\n                        >\r\n                            <Truck size={16} />\r\n                            Livraisons ({deliveries.length})\r\n                        </button>\r\n                        <button\r\n                            className={`b2b-detail-tab ${activeTab === 'history' ? 'active' : ''}`}\r\n                            onClick={() => setActiveTab('history')}\r\n                        >\r\n                            <Clock size={16} />\r\n                            Historique\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Tab Content */}\r\n                    <div className=\"b2b-detail-tab-content\">\r\n                        {activeTab === 'items' && (\r\n                            <div className=\"b2b-items-list\">\r\n                                <table>\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th>Produit</th>\r\n                                            <th>Qté</th>\r\n                                            <th>Prix Unit.</th>\r\n                                            <th>Remise</th>\r\n                                            <th>Total</th>\r\n                                            <th>Livré</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {items.map(item => (\r\n                                            <tr key={item.id}>\r\n                                                <td>\r\n                                                    <div className=\"item-product\">\r\n                                                        <span className=\"item-name\">{item.product_name}</span>\r\n                                                        {item.product_sku && (\r\n                                                            <span className=\"item-sku\">{item.product_sku}</span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td>{item.quantity} {item.unit}</td>\r\n                                                <td>{formatCurrency(item.unit_price)}</td>\r\n                                                <td>\r\n                                                    {item.discount_percentage > 0\r\n                                                        ? `${item.discount_percentage}%`\r\n                                                        : '-'\r\n                                                    }\r\n                                                </td>\r\n                                                <td><strong>{formatCurrency(item.line_total)}</strong></td>\r\n                                                <td>\r\n                                                    <span className={`delivery-progress ${item.quantity_delivered >= item.quantity ? 'complete' : ''}`}>\r\n                                                        {item.quantity_delivered}/{item.quantity}\r\n                                                    </span>\r\n                                                </td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        )}\r\n\r\n                        {activeTab === 'payments' && (\r\n                            <div className=\"b2b-payments-list\">\r\n                                {payments.length === 0 ? (\r\n                                    <div className=\"empty-state\">\r\n                                        <CreditCard size={32} />\r\n                                        <p>Aucun paiement enregistré</p>\r\n                                    </div>\r\n                                ) : (\r\n                                    <table>\r\n                                        <thead>\r\n                                            <tr>\r\n                                                <th>N° Paiement</th>\r\n                                                <th>Date</th>\r\n                                                <th>Méthode</th>\r\n                                                <th>Référence</th>\r\n                                                <th>Montant</th>\r\n                                                <th>Statut</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {payments.map(payment => (\r\n                                                <tr key={payment.id}>\r\n                                                    <td><span className=\"payment-number\">{payment.payment_number}</span></td>\r\n                                                    <td>{formatDate(payment.payment_date)}</td>\r\n                                                    <td>{PAYMENT_METHODS[payment.payment_method as keyof typeof PAYMENT_METHODS] || payment.payment_method}</td>\r\n                                                    <td>{payment.reference_number || '-'}</td>\r\n                                                    <td><strong>{formatCurrency(payment.amount)}</strong></td>\r\n                                                    <td>\r\n                                                        <span className={`payment-badge payment-badge--${payment.status}`}>\r\n                                                            {payment.status === 'completed' ? 'Complété' : payment.status}\r\n                                                        </span>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {activeTab === 'deliveries' && (\r\n                            <div className=\"b2b-deliveries-list\">\r\n                                {deliveries.length === 0 ? (\r\n                                    <div className=\"empty-state\">\r\n                                        <Truck size={32} />\r\n                                        <p>Aucune livraison enregistrée</p>\r\n                                    </div>\r\n                                ) : (\r\n                                    <table>\r\n                                        <thead>\r\n                                            <tr>\r\n                                                <th>N° Livraison</th>\r\n                                                <th>Prévue</th>\r\n                                                <th>Livrée</th>\r\n                                                <th>Chauffeur</th>\r\n                                                <th>Reçu par</th>\r\n                                                <th>Statut</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {deliveries.map(delivery => (\r\n                                                <tr key={delivery.id}>\r\n                                                    <td><span className=\"delivery-number\">{delivery.delivery_number}</span></td>\r\n                                                    <td>{formatDate(delivery.scheduled_date)}</td>\r\n                                                    <td>{formatDate(delivery.actual_date)}</td>\r\n                                                    <td>{delivery.driver_name || '-'}</td>\r\n                                                    <td>{delivery.received_by || '-'}</td>\r\n                                                    <td>\r\n                                                        <span className={`delivery-badge delivery-badge--${delivery.status}`}>\r\n                                                            {delivery.status}\r\n                                                        </span>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {activeTab === 'history' && (\r\n                            <div className=\"b2b-history-list\">\r\n                                {history.map(entry => (\r\n                                    <div key={entry.id} className=\"history-entry\">\r\n                                        <div className=\"history-entry__icon\">\r\n                                            <Clock size={16} />\r\n                                        </div>\r\n                                        <div className=\"history-entry__content\">\r\n                                            <p className=\"history-entry__description\">{entry.description}</p>\r\n                                            <span className=\"history-entry__date\">{formatDateTime(entry.created_at)}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Sidebar - Summary */}\r\n                <div className=\"b2b-detail-sidebar\">\r\n                    <div className=\"b2b-detail-summary\">\r\n                        <h3>Résumé</h3>\r\n\r\n                        <div className=\"summary-line\">\r\n                            <span>Sous-total</span>\r\n                            <span>{formatCurrency(order.subtotal)}</span>\r\n                        </div>\r\n\r\n                        {order.discount_amount > 0 && (\r\n                            <div className=\"summary-line summary-line--discount\">\r\n                                <span>Remise {order.discount_type === 'percentage' ? `(${order.discount_value}%)` : ''}</span>\r\n                                <span>-{formatCurrency(order.discount_amount)}</span>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"summary-line\">\r\n                            <span>TVA ({order.tax_rate}%)</span>\r\n                            <span>{formatCurrency(order.tax_amount)}</span>\r\n                        </div>\r\n\r\n                        <div className=\"summary-divider\"></div>\r\n\r\n                        <div className=\"summary-total\">\r\n                            <span>Total</span>\r\n                            <span>{formatCurrency(order.total_amount)}</span>\r\n                        </div>\r\n\r\n                        {order.notes && (\r\n                            <div className=\"summary-notes\">\r\n                                <h4>Notes</h4>\r\n                                <p>{order.notes}</p>\r\n                            </div>\r\n                        )}\r\n\r\n                        {order.internal_notes && (\r\n                            <div className=\"summary-notes internal\">\r\n                                <h4>Notes internes</h4>\r\n                                <p>{order.internal_notes}</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Payment Modal */}\r\n            {showPaymentModal && (\r\n                <div className=\"b2b-payment-modal-backdrop\" onClick={(e) => e.target === e.currentTarget && setShowPaymentModal(false)}>\r\n                    <div className=\"b2b-payment-modal\">\r\n                        <div className=\"modal__header\">\r\n                            <h2 className=\"modal__title\">Enregistrer un paiement</h2>\r\n                            <button\r\n                                type=\"button\"\r\n                                className=\"modal__close\"\r\n                                onClick={() => setShowPaymentModal(false)}\r\n                                aria-label=\"Fermer\"\r\n                                title=\"Fermer\"\r\n                            >\r\n                                <X size={20} />\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"modal__body\">\r\n                            <div className=\"form-group\">\r\n                                <label htmlFor=\"payment-amount\">Montant *</label>\r\n                                <input\r\n                                    id=\"payment-amount\"\r\n                                    type=\"number\"\r\n                                    min=\"0\"\r\n                                    value={paymentForm.amount}\r\n                                    onChange={(e) => setPaymentForm({ ...paymentForm, amount: parseFloat(e.target.value) || 0 })}\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label htmlFor=\"payment-method\">Méthode de paiement *</label>\r\n                                <select\r\n                                    id=\"payment-method\"\r\n                                    value={paymentForm.payment_method}\r\n                                    onChange={(e) => setPaymentForm({ ...paymentForm, payment_method: e.target.value })}\r\n                                >\r\n                                    <option value=\"transfer\">Virement</option>\r\n                                    <option value=\"cash\">Espèces</option>\r\n                                    <option value=\"check\">Chèque</option>\r\n                                    <option value=\"card\">Carte</option>\r\n                                    <option value=\"qris\">QRIS</option>\r\n                                </select>\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label htmlFor=\"payment-reference\">Référence (optionnel)</label>\r\n                                <input\r\n                                    id=\"payment-reference\"\r\n                                    type=\"text\"\r\n                                    value={paymentForm.reference_number}\r\n                                    onChange={(e) => setPaymentForm({ ...paymentForm, reference_number: e.target.value })}\r\n                                    placeholder=\"N° de transaction, chèque...\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label htmlFor=\"payment-notes\">Notes</label>\r\n                                <textarea\r\n                                    id=\"payment-notes\"\r\n                                    rows={2}\r\n                                    value={paymentForm.notes}\r\n                                    onChange={(e) => setPaymentForm({ ...paymentForm, notes: e.target.value })}\r\n                                    placeholder=\"Notes optionnelles...\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"modal__footer\">\r\n                            <button\r\n                                type=\"button\"\r\n                                className=\"btn btn-secondary\"\r\n                                onClick={() => setShowPaymentModal(false)}\r\n                            >\r\n                                Annuler\r\n                            </button>\r\n                            <button\r\n                                type=\"button\"\r\n                                className=\"btn btn-primary\"\r\n                                onClick={handleAddPayment}\r\n                            >\r\n                                <CreditCard size={18} />\r\n                                Enregistrer\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* PIN Verification Modal for editing delivered orders */}\r\n            {showPinModal && (\r\n                <PinVerificationModal\r\n                    title=\"Autorisation requise\"\r\n                    message=\"Cette commande a déjà été livrée. Entrez un PIN manager pour modifier.\"\r\n                    onVerify={handlePinVerify}\r\n                    onClose={() => setShowPinModal(false)}\r\n                    allowedRoles={['manager', 'admin']}\r\n                />\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\b2b\\B2BOrderFormPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7391,7394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7391,7394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":356,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13168,13171],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13168,13171],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { useNavigate, useParams } from 'react-router-dom'\r\nimport {\r\n    ArrowLeft, Plus, Trash2, Save, Send, Search,\r\n    User, Calendar, Percent, Package\r\n} from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { formatCurrency } from '../../utils/helpers'\r\nimport './B2BOrderFormPage.css'\r\n\r\ninterface Customer {\r\n    id: string\r\n    name: string\r\n    company_name: string | null\r\n    phone: string | null\r\n    email: string | null\r\n    address: string | null\r\n    payment_terms: 'cod' | 'net15' | 'net30' | 'net60' | null\r\n    customer_type: 'retail' | 'wholesale'\r\n}\r\n\r\ninterface Product {\r\n    id: string\r\n    name: string\r\n    sku: string\r\n    retail_price: number | null\r\n    wholesale_price: number | null\r\n    unit: string\r\n    current_stock: number\r\n}\r\n\r\ninterface OrderItem {\r\n    id?: string\r\n    product_id: string | null\r\n    product_name: string\r\n    product_sku: string\r\n    quantity: number\r\n    unit: string\r\n    unit_price: number\r\n    discount_percentage: number\r\n    discount_amount: number\r\n    line_total: number\r\n}\r\n\r\nexport default function B2BOrderFormPage() {\r\n    const navigate = useNavigate()\r\n    const { id } = useParams()\r\n    const isEditing = !!id\r\n\r\n    const [customers, setCustomers] = useState<Customer[]>([])\r\n    const [products, setProducts] = useState<Product[]>([])\r\n    const [loading, setLoading] = useState(false)\r\n    const [saving, setSaving] = useState(false)\r\n\r\n    const [formData, setFormData] = useState({\r\n        customer_id: '',\r\n        requested_delivery_date: '',\r\n        delivery_address: '',\r\n        delivery_notes: '',\r\n        notes: '',\r\n        internal_notes: '',\r\n        discount_type: '' as '' | 'percentage' | 'fixed',\r\n        discount_value: 0,\r\n        tax_rate: 10,\r\n        payment_terms: '' as '' | 'cod' | 'net15' | 'net30' | 'net60'\r\n    })\r\n\r\n    const [items, setItems] = useState<OrderItem[]>([{\r\n        product_id: null,\r\n        product_name: '',\r\n        product_sku: '',\r\n        quantity: 1,\r\n        unit: 'pcs',\r\n        unit_price: 0,\r\n        discount_percentage: 0,\r\n        discount_amount: 0,\r\n        line_total: 0\r\n    }])\r\n\r\n    const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null)\r\n    const [productSearch, setProductSearch] = useState('')\r\n    const [showProductSearch, setShowProductSearch] = useState<number | null>(null)\r\n\r\n    useEffect(() => {\r\n        fetchCustomers()\r\n        fetchProducts()\r\n        if (isEditing) {\r\n            fetchOrder()\r\n        }\r\n    }, [id])\r\n\r\n    const fetchCustomers = async () => {\r\n        try {\r\n            // Fetch all active customers for B2B orders\r\n            // This includes wholesale and retail customers who may need formal orders/invoices\r\n            const { data, error } = await supabase\r\n                .from('customers')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .order('company_name', { ascending: true, nullsFirst: false })\r\n                .order('name')\r\n\r\n            if (error) throw error\r\n            if (data) setCustomers(data as unknown as Customer[])\r\n        } catch (error) {\r\n            console.error('Error fetching customers:', error)\r\n        }\r\n    }\r\n\r\n    const fetchProducts = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('products')\r\n                .select('id, name, sku, retail_price, wholesale_price, unit, current_stock')\r\n                .eq('is_active', true)\r\n                .eq('product_type', 'finished')\r\n                .eq('available_for_sale', true)\r\n                .order('name')\r\n\r\n            if (error) throw error\r\n            if (data) setProducts(data as unknown as Product[])\r\n        } catch (error) {\r\n            console.error('Error fetching products:', error)\r\n        }\r\n    }\r\n\r\n    const fetchOrder = async () => {\r\n        setLoading(true)\r\n        try {\r\n            const { data: order, error: orderError } = await supabase\r\n                .from('b2b_orders')\r\n                .select(`\r\n                    *,\r\n                    customer:customers(*)\r\n                `)\r\n                .eq('id', id!)\r\n                .single()\r\n\r\n            if (orderError) throw orderError\r\n\r\n            const { data: orderItems, error: itemsError } = await supabase\r\n                .from('b2b_order_items')\r\n                .select('*')\r\n                .eq('order_id', id!)\r\n\r\n            if (itemsError) throw itemsError\r\n\r\n            const typedOrder = order as Record<string, unknown>\r\n            setFormData({\r\n                customer_id: typedOrder.customer_id as string,\r\n                requested_delivery_date: ((typedOrder.requested_delivery_date as string)?.split('T')[0]) || '',\r\n                delivery_address: (typedOrder.delivery_address as string) || '',\r\n                delivery_notes: (typedOrder.delivery_notes as string) || '',\r\n                notes: (typedOrder.notes as string) || '',\r\n                internal_notes: (typedOrder.internal_notes as string) || '',\r\n                discount_type: (typedOrder.discount_type as '' | 'percentage' | 'fixed') || '',\r\n                discount_value: (typedOrder.discount_value as number) || 0,\r\n                tax_rate: (typedOrder.tax_rate as number) || 10,\r\n                payment_terms: (typedOrder.payment_terms as '' | 'cod' | 'net15' | 'net30' | 'net60') || ''\r\n            })\r\n\r\n            setSelectedCustomer(typedOrder.customer as Customer)\r\n\r\n            if (orderItems && orderItems.length > 0) {\r\n                const typedItems = orderItems as Record<string, unknown>[]\r\n                setItems(typedItems.map(item => ({\r\n                    id: item.id as string,\r\n                    product_id: item.product_id as string | null,\r\n                    product_name: item.product_name as string,\r\n                    product_sku: (item.product_sku as string) || '',\r\n                    quantity: parseFloat(String(item.quantity)),\r\n                    unit: item.unit as string,\r\n                    unit_price: parseFloat(String(item.unit_price)),\r\n                    discount_percentage: parseFloat(String(item.discount_percentage || 0)),\r\n                    discount_amount: parseFloat(String(item.discount_amount)),\r\n                    line_total: parseFloat(String(item.line_total))\r\n                })))\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching order:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleCustomerChange = (customerId: string) => {\r\n        const customer = customers.find(c => c.id === customerId)\r\n        setSelectedCustomer(customer || null)\r\n        setFormData({\r\n            ...formData,\r\n            customer_id: customerId,\r\n            delivery_address: customer?.address || '',\r\n            payment_terms: customer?.payment_terms || ''\r\n        })\r\n    }\r\n\r\n    const calculateLineTotal = (item: OrderItem): number => {\r\n        const subtotal = item.quantity * item.unit_price\r\n        const discountAmount = item.discount_percentage > 0\r\n            ? subtotal * (item.discount_percentage / 100)\r\n            : item.discount_amount\r\n        return subtotal - discountAmount\r\n    }\r\n\r\n    const handleItemChange = (index: number, field: keyof OrderItem, value: any) => {\r\n        const newItems = [...items]\r\n        newItems[index] = { ...newItems[index], [field]: value }\r\n\r\n        // Recalculate discount and line total\r\n        if (['quantity', 'unit_price', 'discount_percentage'].includes(field)) {\r\n            const subtotal = newItems[index].quantity * newItems[index].unit_price\r\n            newItems[index].discount_amount = subtotal * (newItems[index].discount_percentage / 100)\r\n            newItems[index].line_total = calculateLineTotal(newItems[index])\r\n        }\r\n\r\n        setItems(newItems)\r\n    }\r\n\r\n    const handleProductSelect = (index: number, product: Product) => {\r\n        const newItems = [...items]\r\n        newItems[index] = {\r\n            ...newItems[index],\r\n            product_id: product.id,\r\n            product_name: product.name,\r\n            product_sku: product.sku,\r\n            unit: product.unit,\r\n            unit_price: product.wholesale_price || product.retail_price || 0,\r\n            line_total: (product.wholesale_price || product.retail_price || 0) * newItems[index].quantity\r\n        }\r\n        setItems(newItems)\r\n        setShowProductSearch(null)\r\n        setProductSearch('')\r\n    }\r\n\r\n    const addItem = () => {\r\n        setItems([...items, {\r\n            product_id: null,\r\n            product_name: '',\r\n            product_sku: '',\r\n            quantity: 1,\r\n            unit: 'pcs',\r\n            unit_price: 0,\r\n            discount_percentage: 0,\r\n            discount_amount: 0,\r\n            line_total: 0\r\n        }])\r\n    }\r\n\r\n    const removeItem = (index: number) => {\r\n        if (items.length > 1) {\r\n            setItems(items.filter((_, i) => i !== index))\r\n        }\r\n    }\r\n\r\n    const calculateTotals = () => {\r\n        const subtotal = items.reduce((sum, item) => sum + item.line_total, 0)\r\n        let discountAmount = 0\r\n        if (formData.discount_type === 'percentage') {\r\n            discountAmount = subtotal * (formData.discount_value / 100)\r\n        } else if (formData.discount_type === 'fixed') {\r\n            discountAmount = formData.discount_value\r\n        }\r\n        const taxableAmount = subtotal - discountAmount\r\n        const taxAmount = taxableAmount * (formData.tax_rate / 100)\r\n        const total = taxableAmount + taxAmount\r\n\r\n        return { subtotal, discountAmount, taxAmount, total }\r\n    }\r\n\r\n    const handleSubmit = async (status: 'draft' | 'confirmed' = 'draft') => {\r\n        if (!formData.customer_id) {\r\n            alert('Veuillez sélectionner un client')\r\n            return\r\n        }\r\n\r\n        if (items.some(item => !item.product_name || item.quantity <= 0)) {\r\n            alert('Veuillez remplir tous les articles correctement')\r\n            return\r\n        }\r\n\r\n        setSaving(true)\r\n        try {\r\n            const totals = calculateTotals()\r\n\r\n            // Map UI status to DB status (must match CHECK constraint)\r\n            const dbStatus = status === 'draft' ? 'draft' : 'confirmed'\r\n\r\n            // Map UI fields to database column names\r\n            // Use type assertion to bypass strict type checking for dynamic insert\r\n            // Note: tax_rate in DB is stored as decimal (0.10 = 10%), not percentage\r\n            const orderData = {\r\n                customer_id: formData.customer_id,\r\n                status: dbStatus,\r\n                order_number: `B2B-${Date.now()}`, // Generate order number\r\n                delivery_date: formData.requested_delivery_date || null,\r\n                subtotal: totals.subtotal,\r\n                discount_percent: formData.discount_type === 'percentage' ? formData.discount_value : null,\r\n                discount_amount: totals.discountAmount,\r\n                tax_rate: formData.tax_rate / 100, // Convert percentage to decimal (10% -> 0.10)\r\n                tax_amount: totals.taxAmount,\r\n                total: totals.total,\r\n                paid_amount: 0,\r\n                payment_status: 'unpaid' as const,\r\n                notes: formData.notes || null,\r\n            }\r\n\r\n            let orderId: string | undefined = id\r\n\r\n            if (isEditing) {\r\n                const { error } = await supabase\r\n                    .from('b2b_orders')\r\n                    .update(orderData as never)\r\n                    .eq('id', id!)\r\n\r\n                if (error) throw error\r\n\r\n                // Delete existing items\r\n                await supabase\r\n                    .from('b2b_order_items')\r\n                    .delete()\r\n                    .eq('order_id', id!)\r\n            } else {\r\n                const { data: newOrder, error } = await supabase\r\n                    .from('b2b_orders')\r\n                    .insert(orderData as never)\r\n                    .select()\r\n                    .single()\r\n\r\n                if (error) throw error\r\n                orderId = newOrder.id\r\n            }\r\n\r\n            if (!orderId) {\r\n                throw new Error('Failed to get order ID')\r\n            }\r\n\r\n            // Insert items - map UI fields to database column names\r\n            const itemsToInsert = items.map(item => ({\r\n                order_id: orderId as string,\r\n                product_id: item.product_id || '', // product_id is required in DB\r\n                product_name: item.product_name,\r\n                product_sku: item.product_sku || null,\r\n                quantity: item.quantity,\r\n                unit_price: item.unit_price,\r\n                discount_percent: item.discount_percentage || null,\r\n                total: item.line_total\r\n            }))\r\n\r\n            const { error: itemsError } = await supabase\r\n                .from('b2b_order_items')\r\n                .insert(itemsToInsert as never)\r\n\r\n            if (itemsError) throw itemsError\r\n\r\n            navigate('/b2b/orders')\r\n        } catch (error: any) {\r\n            console.error('Error saving order:', error)\r\n            alert(`Erreur lors de l'enregistrement: ${error?.message || 'Erreur inconnue'}`)\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    const totals = calculateTotals()\r\n\r\n    const filteredProducts = products.filter(p =>\r\n        p.name.toLowerCase().includes(productSearch.toLowerCase()) ||\r\n        p.sku.toLowerCase().includes(productSearch.toLowerCase())\r\n    )\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"b2b-form-loading\">\r\n                <div className=\"spinner\"></div>\r\n                <span>Chargement de la commande...</span>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"b2b-order-form-page\">\r\n            {/* Header */}\r\n            <div className=\"b2b-order-form__header\">\r\n                <button className=\"btn btn-ghost\" onClick={() => navigate('/b2b/orders')}>\r\n                    <ArrowLeft size={20} />\r\n                    Retour\r\n                </button>\r\n                <h1 className=\"b2b-order-form__title\">\r\n                    {isEditing ? 'Modifier la Commande' : 'Nouvelle Commande B2B'}\r\n                </h1>\r\n            </div>\r\n\r\n            <div className=\"b2b-order-form__content\">\r\n                {/* Main Form */}\r\n                <div className=\"b2b-order-form__main\">\r\n                    {/* Customer Section */}\r\n                    <div className=\"b2b-form-section\">\r\n                        <h2 className=\"b2b-form-section__title\">\r\n                            <User size={20} />\r\n                            Client\r\n                        </h2>\r\n                        <div className=\"b2b-form-grid\">\r\n                            <div className=\"form-group form-group--full\">\r\n                                <label>Client B2B *</label>\r\n                                <select\r\n                                    value={formData.customer_id}\r\n                                    onChange={(e) => handleCustomerChange(e.target.value)}\r\n                                    required\r\n                                >\r\n                                    <option value=\"\">Sélectionner un client...</option>\r\n                                    {customers.map(customer => (\r\n                                        <option key={customer.id} value={customer.id}>\r\n                                            {customer.company_name || customer.name}\r\n                                            {customer.company_name && ` (${customer.name})`}\r\n                                        </option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                            {selectedCustomer && (\r\n                                <div className=\"b2b-customer-info\">\r\n                                    <div className=\"b2b-customer-info__item\">\r\n                                        <span className=\"label\">Contact:</span>\r\n                                        <span>{selectedCustomer.name}</span>\r\n                                    </div>\r\n                                    {selectedCustomer.phone && (\r\n                                        <div className=\"b2b-customer-info__item\">\r\n                                            <span className=\"label\">Téléphone:</span>\r\n                                            <span>{selectedCustomer.phone}</span>\r\n                                        </div>\r\n                                    )}\r\n                                    {selectedCustomer.email && (\r\n                                        <div className=\"b2b-customer-info__item\">\r\n                                            <span className=\"label\">Email:</span>\r\n                                            <span>{selectedCustomer.email}</span>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Delivery Section */}\r\n                    <div className=\"b2b-form-section\">\r\n                        <h2 className=\"b2b-form-section__title\">\r\n                            <Calendar size={20} />\r\n                            Livraison\r\n                        </h2>\r\n                        <div className=\"b2b-form-grid\">\r\n                            <div className=\"form-group\">\r\n                                <label>Date de livraison souhaitée</label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    value={formData.requested_delivery_date}\r\n                                    onChange={(e) => setFormData({ ...formData, requested_delivery_date: e.target.value })}\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label>Conditions de paiement</label>\r\n                                <select\r\n                                    value={formData.payment_terms}\r\n                                    onChange={(e) => setFormData({ ...formData, payment_terms: e.target.value as '' | 'cod' | 'net15' | 'net30' | 'net60' })}\r\n                                >\r\n                                    <option value=\"\">Sélectionner...</option>\r\n                                    <option value=\"cod\">Paiement à la livraison</option>\r\n                                    <option value=\"net15\">Net 15 jours</option>\r\n                                    <option value=\"net30\">Net 30 jours</option>\r\n                                    <option value=\"net60\">Net 60 jours</option>\r\n                                </select>\r\n                            </div>\r\n                            <div className=\"form-group form-group--full\">\r\n                                <label>Adresse de livraison</label>\r\n                                <textarea\r\n                                    rows={2}\r\n                                    value={formData.delivery_address}\r\n                                    onChange={(e) => setFormData({ ...formData, delivery_address: e.target.value })}\r\n                                    placeholder=\"Adresse complète de livraison...\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group form-group--full\">\r\n                                <label>Instructions de livraison</label>\r\n                                <textarea\r\n                                    rows={2}\r\n                                    value={formData.delivery_notes}\r\n                                    onChange={(e) => setFormData({ ...formData, delivery_notes: e.target.value })}\r\n                                    placeholder=\"Instructions spéciales pour la livraison...\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Items Section */}\r\n                    <div className=\"b2b-form-section\">\r\n                        <div className=\"b2b-form-section__header\">\r\n                            <h2 className=\"b2b-form-section__title\">\r\n                                <Package size={20} />\r\n                                Articles\r\n                            </h2>\r\n                            <button className=\"btn btn-secondary btn-sm\" onClick={addItem}>\r\n                                <Plus size={16} />\r\n                                Ajouter\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"b2b-items-table\">\r\n                            <table>\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th>Produit</th>\r\n                                        <th style={{ width: '80px' }}>Qté</th>\r\n                                        <th style={{ width: '100px' }}>Prix Unit.</th>\r\n                                        <th style={{ width: '80px' }}>Remise %</th>\r\n                                        <th style={{ width: '120px' }}>Total</th>\r\n                                        <th style={{ width: '50px' }}></th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {items.map((item, index) => (\r\n                                        <tr key={index}>\r\n                                            <td>\r\n                                                <div className=\"b2b-product-selector\">\r\n                                                    <div\r\n                                                        className=\"b2b-product-selector__input\"\r\n                                                        onClick={() => setShowProductSearch(showProductSearch === index ? null : index)}\r\n                                                    >\r\n                                                        {item.product_name || (\r\n                                                            <span className=\"placeholder\">Rechercher un produit...</span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    {showProductSearch === index && (\r\n                                                        <div className=\"b2b-product-dropdown\">\r\n                                                            <div className=\"b2b-product-dropdown__search\">\r\n                                                                <Search size={16} />\r\n                                                                <input\r\n                                                                    type=\"text\"\r\n                                                                    placeholder=\"Rechercher...\"\r\n                                                                    value={productSearch}\r\n                                                                    onChange={(e) => setProductSearch(e.target.value)}\r\n                                                                    autoFocus\r\n                                                                />\r\n                                                            </div>\r\n                                                            <div className=\"b2b-product-dropdown__list\">\r\n                                                                {filteredProducts.map(product => (\r\n                                                                    <div\r\n                                                                        key={product.id}\r\n                                                                        className=\"b2b-product-dropdown__item\"\r\n                                                                        onClick={() => handleProductSelect(index, product)}\r\n                                                                    >\r\n                                                                        <div className=\"b2b-product-dropdown__name\">\r\n                                                                            {product.name}\r\n                                                                        </div>\r\n                                                                        <div className=\"b2b-product-dropdown__meta\">\r\n                                                                            <span>{product.sku}</span>\r\n                                                                            <span>{formatCurrency(product.wholesale_price || product.retail_price || 0)}</span>\r\n                                                                            <span>Stock: {product.current_stock}</span>\r\n                                                                        </div>\r\n                                                                    </div>\r\n                                                                ))}\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"1\"\r\n                                                    value={item.quantity}\r\n                                                    onChange={(e) => handleItemChange(index, 'quantity', parseFloat(e.target.value) || 1)}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"0\"\r\n                                                    value={item.unit_price}\r\n                                                    onChange={(e) => handleItemChange(index, 'unit_price', parseFloat(e.target.value) || 0)}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"0\"\r\n                                                    max=\"100\"\r\n                                                    value={item.discount_percentage}\r\n                                                    onChange={(e) => handleItemChange(index, 'discount_percentage', parseFloat(e.target.value) || 0)}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <strong>{formatCurrency(item.line_total)}</strong>\r\n                                            </td>\r\n                                            <td>\r\n                                                <button\r\n                                                    className=\"btn-icon btn-icon--danger\"\r\n                                                    onClick={() => removeItem(index)}\r\n                                                    disabled={items.length === 1}\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Notes Section */}\r\n                    <div className=\"b2b-form-section\">\r\n                        <h2 className=\"b2b-form-section__title\">Notes</h2>\r\n                        <div className=\"b2b-form-grid\">\r\n                            <div className=\"form-group\">\r\n                                <label>Notes (visibles sur le bon de commande)</label>\r\n                                <textarea\r\n                                    rows={3}\r\n                                    value={formData.notes}\r\n                                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\r\n                                    placeholder=\"Notes pour le client...\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label>Notes internes</label>\r\n                                <textarea\r\n                                    rows={3}\r\n                                    value={formData.internal_notes}\r\n                                    onChange={(e) => setFormData({ ...formData, internal_notes: e.target.value })}\r\n                                    placeholder=\"Notes internes (non visibles par le client)...\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Sidebar - Summary */}\r\n                <div className=\"b2b-order-form__sidebar\">\r\n                    <div className=\"b2b-order-summary\">\r\n                        <h3>Résumé</h3>\r\n\r\n                        <div className=\"b2b-summary-line\">\r\n                            <span>Sous-total</span>\r\n                            <span>{formatCurrency(totals.subtotal)}</span>\r\n                        </div>\r\n\r\n                        {/* Discount */}\r\n                        <div className=\"b2b-summary-discount\">\r\n                            <div className=\"b2b-discount-type\">\r\n                                <button\r\n                                    className={`btn-chip ${formData.discount_type === 'percentage' ? 'active' : ''}`}\r\n                                    onClick={() => setFormData({ ...formData, discount_type: 'percentage' })}\r\n                                >\r\n                                    <Percent size={14} />\r\n                                    %\r\n                                </button>\r\n                                <button\r\n                                    className={`btn-chip ${formData.discount_type === 'fixed' ? 'active' : ''}`}\r\n                                    onClick={() => setFormData({ ...formData, discount_type: 'fixed' })}\r\n                                >\r\n                                    Fixe\r\n                                </button>\r\n                                {formData.discount_type && (\r\n                                    <button\r\n                                        className=\"btn-chip btn-chip--clear\"\r\n                                        onClick={() => setFormData({ ...formData, discount_type: '', discount_value: 0 })}\r\n                                    >\r\n                                        ×\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                            {formData.discount_type && (\r\n                                <input\r\n                                    type=\"number\"\r\n                                    min=\"0\"\r\n                                    value={formData.discount_value}\r\n                                    onChange={(e) => setFormData({ ...formData, discount_value: parseFloat(e.target.value) || 0 })}\r\n                                    placeholder={formData.discount_type === 'percentage' ? '% remise' : 'Montant'}\r\n                                />\r\n                            )}\r\n                        </div>\r\n\r\n                        {totals.discountAmount > 0 && (\r\n                            <div className=\"b2b-summary-line b2b-summary-line--discount\">\r\n                                <span>Remise</span>\r\n                                <span>-{formatCurrency(totals.discountAmount)}</span>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"b2b-summary-line\">\r\n                            <span>TVA ({formData.tax_rate}%)</span>\r\n                            <span>{formatCurrency(totals.taxAmount)}</span>\r\n                        </div>\r\n\r\n                        <div className=\"b2b-summary-divider\"></div>\r\n\r\n                        <div className=\"b2b-summary-total\">\r\n                            <span>Total</span>\r\n                            <span>{formatCurrency(totals.total)}</span>\r\n                        </div>\r\n\r\n                        <div className=\"b2b-summary-actions\">\r\n                            <button\r\n                                className=\"btn btn-secondary btn-block\"\r\n                                onClick={() => handleSubmit('draft')}\r\n                                disabled={saving}\r\n                            >\r\n                                <Save size={18} />\r\n                                Enregistrer Brouillon\r\n                            </button>\r\n                            <button\r\n                                className=\"btn btn-primary btn-block\"\r\n                                onClick={() => handleSubmit('confirmed')}\r\n                                disabled={saving}\r\n                            >\r\n                                <Send size={18} />\r\n                                Confirmer Commande\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\b2b\\B2BOrdersPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\b2b\\B2BPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\b2b\\B2BPaymentsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\customers\\CustomerCategoriesPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\customers\\CustomerDetailPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\customers\\CustomerFormPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\customers\\CustomersPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\display\\CustomerDisplayPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\IncomingStockPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\InternalTransfersPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":228,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8167,8170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8167,8170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":228,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8206,8209],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8206,8209],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":232,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8482,8485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8482,8485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":232,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8519,8522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8519,8522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { Plus, ArrowRightLeft, Clock, CheckCircle, XCircle, Eye, Filter, WifiOff } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\nimport { useInternalTransfers } from '@/hooks/inventory'\r\nimport { useNetworkStatus } from '@/hooks/offline/useNetworkStatus'\r\nimport type { TTransferStatus } from '@/types/database'\r\nimport './InternalTransfersPage.css'\r\n\r\n// Status icons mapping\r\nconst STATUS_ICONS = {\r\n  draft: Clock,\r\n  pending: Clock,\r\n  in_transit: ArrowRightLeft,\r\n  received: CheckCircle,\r\n  cancelled: XCircle\r\n} as const\r\n\r\n// Status colors\r\nconst STATUS_COLORS = {\r\n  draft: '#6b7280',\r\n  pending: '#f59e0b',\r\n  in_transit: '#3b82f6',\r\n  received: '#10b981',\r\n  cancelled: '#ef4444'\r\n} as const\r\n\r\nexport default function InternalTransfersPage() {\r\n  const navigate = useNavigate()\r\n  const { isOnline } = useNetworkStatus()\r\n  const [statusFilter, setStatusFilter] = useState<TTransferStatus | 'all'>('all')\r\n\r\n  // Use the hook instead of direct Supabase calls\r\n  const { data: transfers = [], isLoading, error } = useInternalTransfers(\r\n    statusFilter !== 'all' ? { status: statusFilter } : undefined\r\n  )\r\n\r\n  // Handle new transfer button click\r\n  const handleNewTransfer = () => {\r\n    if (!isOnline) {\r\n      toast.error('Transfers are not available offline')\r\n      return\r\n    }\r\n    navigate('/inventory/transfers/new')\r\n  }\r\n\r\n  // Calculate stats using useMemo\r\n  const stats = useMemo(() => ({\r\n    total: transfers.length,\r\n    pending: transfers.filter(t => t.status === 'pending' || t.status === 'in_transit').length,\r\n    received: transfers.filter(t => t.status === 'received').length,\r\n    totalValue: transfers.reduce((sum, t) => sum + (t.total_value ?? 0), 0)\r\n  }), [transfers])\r\n\r\n  // Get status label\r\n  const getStatusLabel = (status: string): string => {\r\n    const statusLabels: Record<string, string> = {\r\n      all: 'All statuses',\r\n      draft: 'Draft',\r\n      pending: 'Pending',\r\n      in_transit: 'In Transit',\r\n      received: 'Received',\r\n      cancelled: 'Cancelled'\r\n    }\r\n    return statusLabels[status] || status\r\n  }\r\n\r\n  // Get status config for display\r\n  const getStatusConfig = (status: string) => {\r\n    const key = status as keyof typeof STATUS_ICONS\r\n    return {\r\n      label: getStatusLabel(status),\r\n      color: STATUS_COLORS[key] ?? '#6b7280',\r\n      icon: STATUS_ICONS[key] ?? Clock\r\n    }\r\n  }\r\n\r\n  // Show error toast only once when error occurs\r\n  useEffect(() => {\r\n    if (error) {\r\n      toast.error('Error loading transfers')\r\n    }\r\n  }, [error])\r\n\r\n  return (\r\n    <div className=\"internal-transfers-page\">\r\n      {/* Offline indicator */}\r\n      {!isOnline && (\r\n        <div className=\"offline-banner\" style={{\r\n          background: 'rgba(245, 158, 11, 0.1)',\r\n          border: '1px solid #f59e0b',\r\n          borderRadius: '8px',\r\n          padding: '12px 16px',\r\n          marginBottom: '16px',\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          gap: '8px',\r\n          color: '#b45309'\r\n        }}>\r\n          <WifiOff size={18} />\r\n          <span>Transfers are not available offline</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Header */}\r\n      <header className=\"transfers-header\">\r\n        <div>\r\n          <h1 className=\"transfers-title\">\r\n            <ArrowRightLeft size={28} />\r\n            Internal Transfers\r\n          </h1>\r\n          <p className=\"transfers-subtitle\">\r\n            Manage transfers between warehouse and sections\r\n          </p>\r\n        </div>\r\n        <button\r\n          className=\"btn btn-primary\"\r\n          onClick={handleNewTransfer}\r\n          disabled={!isOnline}\r\n          title={!isOnline ? 'Transfers are not available offline' : undefined}\r\n        >\r\n          <Plus size={18} />\r\n          New Transfer\r\n        </button>\r\n      </header>\r\n\r\n      {/* Stats */}\r\n      <div className=\"transfers-stats\">\r\n        <div className=\"transfer-stat\">\r\n          <div className=\"transfer-stat__icon\" style={{ background: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' }}>\r\n            <ArrowRightLeft size={24} />\r\n          </div>\r\n          <div className=\"transfer-stat__content\">\r\n            <div className=\"transfer-stat__value\">{stats.total}</div>\r\n            <div className=\"transfer-stat__label\">Total</div>\r\n          </div>\r\n        </div>\r\n        <div className=\"transfer-stat\">\r\n          <div className=\"transfer-stat__icon\" style={{ background: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' }}>\r\n            <Clock size={24} />\r\n          </div>\r\n          <div className=\"transfer-stat__content\">\r\n            <div className=\"transfer-stat__value\">{stats.pending}</div>\r\n            <div className=\"transfer-stat__label\">Pending</div>\r\n          </div>\r\n        </div>\r\n        <div className=\"transfer-stat\">\r\n          <div className=\"transfer-stat__icon\" style={{ background: 'rgba(16, 185, 129, 0.15)', color: '#10b981' }}>\r\n            <CheckCircle size={24} />\r\n          </div>\r\n          <div className=\"transfer-stat__content\">\r\n            <div className=\"transfer-stat__value\">{stats.received}</div>\r\n            <div className=\"transfer-stat__label\">Completed</div>\r\n          </div>\r\n        </div>\r\n        <div className=\"transfer-stat\">\r\n          <div className=\"transfer-stat__icon\" style={{ background: 'rgba(139, 92, 246, 0.15)', color: '#8b5cf6' }}>\r\n            <Filter size={24} />\r\n          </div>\r\n          <div className=\"transfer-stat__content\">\r\n            <div className=\"transfer-stat__value\">Rp{stats.totalValue.toLocaleString('id-ID')}</div>\r\n            <div className=\"transfer-stat__label\">Total Value</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"transfers-filters\">\r\n        <select\r\n          value={statusFilter}\r\n          onChange={(e) => setStatusFilter(e.target.value as TTransferStatus | 'all')}\r\n          className=\"status-filter\"\r\n        >\r\n          <option value=\"all\">All statuses</option>\r\n          <option value=\"draft\">Draft</option>\r\n          <option value=\"pending\">Pending</option>\r\n          <option value=\"in_transit\">In Transit</option>\r\n          <option value=\"received\">Received</option>\r\n          <option value=\"cancelled\">Cancelled</option>\r\n        </select>\r\n      </div>\r\n\r\n      {/* Transfers List */}\r\n      {isLoading ? (\r\n        <div className=\"transfers-loading\">Loading...</div>\r\n      ) : transfers.length === 0 ? (\r\n        <div className=\"transfers-empty\">\r\n          <ArrowRightLeft size={64} />\r\n          <h3>No transfers yet</h3>\r\n          <p>Create your first internal transfer to move stock between locations</p>\r\n          <button\r\n            className=\"btn btn-primary\"\r\n            onClick={handleNewTransfer}\r\n            disabled={!isOnline}\r\n          >\r\n            <Plus size={18} />\r\n            New Transfer\r\n          </button>\r\n        </div>\r\n      ) : (\r\n        <div className=\"transfers-grid\">\r\n          {transfers.map(transfer => {\r\n            const statusConfig = getStatusConfig(transfer.status ?? 'draft')\r\n            const StatusIcon = statusConfig.icon\r\n\r\n            return (\r\n              <div key={transfer.id} className=\"transfer-card\">\r\n                <div className=\"transfer-card__header\">\r\n                  <div className=\"transfer-card__number\">\r\n                    <ArrowRightLeft size={18} />\r\n                    {transfer.transfer_number}\r\n                  </div>\r\n                  <span\r\n                    className=\"transfer-card__status\"\r\n                    style={{\r\n                      background: `${statusConfig.color}20`,\r\n                      color: statusConfig.color\r\n                    }}\r\n                  >\r\n                    <StatusIcon size={14} />\r\n                    {statusConfig.label}\r\n                  </span>\r\n                </div>\r\n\r\n                <div className=\"transfer-card__route\">\r\n                  <div className=\"transfer-card__location from\">\r\n                    {/* Support both section-based and location-based transfers */}\r\n                    {(transfer as any).from_section?.icon} {(transfer as any).from_section?.name ?? transfer.from_location?.name ?? 'Unknown'}\r\n                  </div>\r\n                  <ArrowRightLeft size={20} className=\"transfer-card__arrow\" />\r\n                  <div className=\"transfer-card__location to\">\r\n                    {(transfer as any).to_section?.icon} {(transfer as any).to_section?.name ?? transfer.to_location?.name ?? 'Unknown'}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"transfer-card__info\">\r\n                  <div className=\"transfer-card__info-item\">\r\n                    <span className=\"label\">Date:</span>\r\n                    <span className=\"value\">\r\n                      {transfer.transfer_date ? new Date(transfer.transfer_date).toLocaleDateString('en-US') : '-'}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"transfer-card__info-item\">\r\n                    <span className=\"label\">Responsible:</span>\r\n                    <span className=\"value\">{transfer.responsible_person}</span>\r\n                  </div>\r\n                  <div className=\"transfer-card__info-item\">\r\n                    <span className=\"label\">Total Items:</span>\r\n                    <span className=\"value\">{transfer.total_items ?? 0}</span>\r\n                  </div>\r\n                  <div className=\"transfer-card__info-item\">\r\n                    <span className=\"label\">Total Value:</span>\r\n                    <span className=\"value\">Rp{(transfer.total_value ?? 0).toLocaleString('id-ID')}</span>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"transfer-card__actions\">\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"btn btn-secondary btn-sm\"\r\n                    onClick={() => navigate(`/inventory/transfers/${transfer.id}`)}\r\n                  >\r\n                    <Eye size={16} />\r\n                    View Details\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\InventoryLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\ProductDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1672,1675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1672,1675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":219,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9076,9079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9076,9079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":248,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":248,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10036,10039],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10036,10039],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":259,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10467,10470],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10467,10470],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":282,"column":13,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":282,"endColumn":26,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[11229,11242],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { useState, useEffect } from 'react'\r\nimport { useParams, useNavigate } from 'react-router-dom'\r\nimport {\r\n    ArrowLeft, Save, DollarSign,\r\n    Layers, Settings, Scale, AlertTriangle\r\n} from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport type { Product, Recipe, ProductUOM, Category, Section } from '../../types/database'\r\nimport { MOCK_PRODUCTS, MOCK_CATEGORIES } from '../../hooks/products'\r\nimport './ProductDetailPage.css'\r\n\r\n// Tabs\r\nimport { GeneralTab } from './tabs/GeneralTab'\r\nimport { UnitsTab } from './tabs/UnitsTab'\r\nimport { RecipeTab } from './tabs/RecipeTab'\r\nimport { CostingTab } from './tabs/CostingTab'\r\nimport { PricesTab } from './tabs/PricesTab'\r\nimport { VariantsTab } from './tabs/VariantsTab'\r\n\r\ntype Tab = 'general' | 'units' | 'recipe' | 'costing' | 'prices' | 'variants'\r\n\r\nexport default function ProductDetailPage() {\r\n    const { id } = useParams<{ id: string }>()\r\n    const navigate = useNavigate()\r\n    const [activeTab, setActiveTab] = useState<Tab>('general')\r\n    const [loading, setLoading] = useState(true)\r\n    const [saving, setSaving] = useState(false)\r\n\r\n    // Data states\r\n    const [product, setProduct] = useState<Product | null>(null)\r\n    const [categories, setCategories] = useState<Category[]>([])\r\n    const [sections, setSections] = useState<Section[]>([])\r\n    const [productSections, setProductSections] = useState<string[]>([]) // Selected section IDs\r\n    const [primarySectionId, setPrimarySectionId] = useState<string | null>(null)\r\n    const [recipeItems, setRecipeItems] = useState<(Recipe & { material: Product })[]>([])\r\n    const [priceHistory, setPriceHistory] = useState<any[]>([])\r\n    const [uoms, setUoms] = useState<ProductUOM[]>([])\r\n\r\n    // Derived state for ingredient search\r\n    const [allIngredients, setAllIngredients] = useState<Product[]>([])\r\n    const [showIngredientSearch, setShowIngredientSearch] = useState(false)\r\n\r\n    useEffect(() => {\r\n        if (id) fetchProductData()\r\n    }, [id])\r\n\r\n    async function fetchProductData() {\r\n        if (!id) return\r\n        setLoading(true)\r\n        try {\r\n            // 1. Fetch Product\r\n            const { data: prod, error: pError } = await supabase\r\n                .from('products')\r\n                .select('*')\r\n                .eq('id', id)\r\n                .single()\r\n\r\n            // Handle Mock Data Fallback\r\n            if (pError || !prod) {\r\n                const mockRaw = MOCK_PRODUCTS.find(p => p.id === id)\r\n                if (mockRaw) {\r\n                    const mockIndex = MOCK_PRODUCTS.findIndex(p => p.id === id)\r\n                    const mockProduct = {\r\n                        ...mockRaw,\r\n                        description: 'Mock Product Description',\r\n                        product_type: mockIndex % 3 === 0 ? 'raw_material' : (mockIndex % 3 === 1 ? 'finished' : 'semi_finished'),\r\n                        cost_price: 0,\r\n                        wholesale_price: 0,\r\n                        current_stock: 50 - (mockIndex % 20),\r\n                        min_stock_level: 10,\r\n                        unit: 'pcs',\r\n                        pos_visible: true,\r\n                        available_for_sale: true,\r\n                        is_active: true,\r\n                        created_at: new Date().toISOString(),\r\n                        updated_at: new Date().toISOString(),\r\n                        deduct_ingredients: null,\r\n                        deleted_at: null,\r\n                        is_made_to_order: false,\r\n                        section_id: null,\r\n                    } as unknown as Product\r\n                    setProduct(mockProduct)\r\n                    setCategories(MOCK_CATEGORIES)\r\n                    setSections([])\r\n                    setRecipeItems([])\r\n                    setUoms([])\r\n                    setAllIngredients(MOCK_PRODUCTS.filter((_, i) => i % 3 === 0).map((p) => ({\r\n                        ...p,\r\n                        description: '',\r\n                        product_type: 'raw_material' as const,\r\n                        cost_price: 0,\r\n                        wholesale_price: 0,\r\n                        current_stock: 50,\r\n                        min_stock_level: 10,\r\n                        unit: 'pcs',\r\n                        pos_visible: true,\r\n                        available_for_sale: false,\r\n                        is_active: true,\r\n                        created_at: new Date().toISOString(),\r\n                        updated_at: new Date().toISOString(),\r\n                        deduct_ingredients: null,\r\n                    } as unknown as Product)))\r\n                    return\r\n                }\r\n                if (pError) throw pError\r\n            }\r\n\r\n            setProduct(prod)\r\n\r\n            // 2. Fetch Categories\r\n            const { data: cats } = await supabase.from('categories').select('*').order('name')\r\n            if (cats) setCategories(cats)\r\n\r\n            // 3. Fetch Sections (only active ones)\r\n            const { data: sects } = await supabase\r\n                .from('sections')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .order('sort_order')\r\n            if (sects) setSections(sects)\r\n\r\n            // 3b. Fetch Product Sections (many-to-many)\r\n            const { data: prodSects } = await supabase\r\n                .from('product_sections')\r\n                .select('*')\r\n                .eq('product_id', id)\r\n            if (prodSects) {\r\n                const typedSects = prodSects as { section_id: string; is_primary?: boolean }[]\r\n                setProductSections(typedSects.map(ps => ps.section_id))\r\n                const primary = typedSects.find(ps => ps.is_primary)\r\n                setPrimarySectionId(primary?.section_id || (typedSects[0]?.section_id || null))\r\n            }\r\n\r\n            // 4. Fetch Recipe\r\n            const { data: recipes, error: rError } = await supabase\r\n                .from('recipes')\r\n                .select('*, material:products!material_id(*)')\r\n                .eq('product_id', id)\r\n            if (rError) throw rError\r\n            setRecipeItems(recipes || [])\r\n\r\n            // 5. Fetch UOMs\r\n            const { data: uomData } = await supabase\r\n                .from('product_uoms')\r\n                .select('*')\r\n                .eq('product_id', id)\r\n            if (uomData) setUoms(uomData as ProductUOM[])\r\n\r\n            // 7. Fetch Potential Ingredients\r\n            const { data: ingredients } = await supabase\r\n                .from('products')\r\n                .select('*')\r\n                .eq('product_type', 'raw_material')\r\n                .neq('id', id)\r\n                .order('name')\r\n            if (ingredients) setAllIngredients(ingredients)\r\n\r\n            // 8. Fetch Price History (PO Items)\r\n            const { data: prices } = await supabase\r\n                .from('purchase_order_items')\r\n                .select('*, purchase_order:purchase_orders(order_date, supplier:suppliers(name))')\r\n                .eq('product_id', id)\r\n                .order('created_at', { ascending: false })\r\n            if (prices) setPriceHistory(prices)\r\n\r\n        } catch (error) {\r\n            console.error('Error fetching product details:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    async function handleSave() {\r\n        if (!product) return\r\n        setSaving(true)\r\n        try {\r\n            // 1. Update product\r\n            const { error } = await supabase\r\n                .from('products')\r\n                .update({\r\n                    name: product.name,\r\n                    sku: product.sku,\r\n                    category_id: product.category_id,\r\n                    retail_price: product.retail_price,\r\n                    cost_price: product.cost_price,\r\n                    min_stock_level: product.min_stock_level,\r\n                    description: product.description,\r\n                    pos_visible: product.pos_visible,\r\n                    is_active: product.is_active,\r\n                    deduct_ingredients: product.deduct_ingredients,\r\n                    unit: product.unit\r\n                })\r\n                .eq('id', product.id)\r\n\r\n            if (error) throw error\r\n\r\n            // 2. Save product sections (delete existing, insert new)\r\n            await supabase\r\n                .from('product_sections')\r\n                .delete()\r\n                .eq('product_id', product.id)\r\n\r\n            if (productSections.length > 0) {\r\n                const sectionsToInsert = productSections.map(sectionId => ({\r\n                    product_id: product.id,\r\n                    section_id: sectionId,\r\n                    is_primary: sectionId === primarySectionId\r\n                }))\r\n\r\n                const { error: sectError } = await supabase\r\n                    .from('product_sections')\r\n                    .insert(sectionsToInsert)\r\n\r\n                if (sectError) throw sectError\r\n            }\r\n\r\n            alert('Product updated successfully')\r\n        } catch (error: any) {\r\n            alert('Error saving product: ' + error.message)\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    async function addUOM() {\r\n        if (!product) return\r\n        const unitName = prompt(\"Nom de l'unité (ex: Carton):\")\r\n        if (!unitName) return\r\n        const factorStr = prompt(`Combien de ${product.unit} dans 1 ${unitName}?`)\r\n        if (!factorStr) return\r\n        const factor = parseFloat(factorStr)\r\n\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('product_uoms')\r\n                .insert({\r\n                    product_id: product.id,\r\n                    unit_name: unitName,\r\n                    conversion_factor: factor,\r\n                    is_consumption_unit: true\r\n                })\r\n                .select()\r\n                .single()\r\n\r\n            if (error) throw error\r\n            if (data) setUoms([...uoms, data])\r\n        } catch (error: any) {\r\n            alert('Error adding unit: ' + error.message)\r\n        }\r\n    }\r\n\r\n    async function deleteUOM(uomId: string) {\r\n        if (!confirm('Are you sure you want to delete this unit?')) return\r\n        try {\r\n            const { error } = await supabase.from('product_uoms').delete().eq('id', uomId)\r\n            if (error) throw error\r\n            setUoms(uoms.filter(u => u.id !== uomId))\r\n        } catch (error: any) {\r\n            alert('Error deleting unit: ' + error.message)\r\n        }\r\n    }\r\n\r\n    async function addIngredient(materialId: string) {\r\n        if (!product) return\r\n        try {\r\n            const material = allIngredients.find(i => i.id === materialId)\r\n            const defaultUnit = material?.unit || 'pcs'\r\n\r\n            const { data, error } = await supabase\r\n                .from('recipes')\r\n                .insert({\r\n                    product_id: product.id,\r\n                    material_id: materialId,\r\n                    quantity: 1,\r\n                    unit: defaultUnit\r\n                })\r\n                .select('*, material:products!material_id(*)')\r\n                .single()\r\n\r\n            if (error) throw error\r\n            // @ts-ignore\r\n            setRecipeItems([...recipeItems, data])\r\n            setShowIngredientSearch(false)\r\n        } catch (error) {\r\n            console.error('Error adding ingredient:', error)\r\n        }\r\n    }\r\n\r\n    async function removeIngredient(recipeId: string) {\r\n        try {\r\n            const { error } = await supabase\r\n                .from('recipes')\r\n                .delete()\r\n                .eq('id', recipeId)\r\n\r\n            if (error) throw error\r\n            setRecipeItems(recipeItems.filter(r => r.id !== recipeId))\r\n        } catch (error) {\r\n            console.error('Error deleting ingredient:', error)\r\n        }\r\n    }\r\n\r\n    async function updateRecipeQuantity(recipeId: string, quantity: number, unit: string) {\r\n        setRecipeItems(recipeItems.map(r =>\r\n            r.id === recipeId ? { ...r, quantity, unit } : r\r\n        ))\r\n\r\n        try {\r\n            await supabase\r\n                .from('recipes')\r\n                .update({ quantity, unit })\r\n                .eq('id', recipeId)\r\n        } catch (error) {\r\n            console.error('Error updating recipe:', error)\r\n        }\r\n    }\r\n\r\n    if (loading) return <div className=\"product-detail-page flex items-center justify-center text-gray-500 h-screen\">Loading...</div>\r\n\r\n    if (!product) return (\r\n        <div className=\"product-detail-page flex items-center justify-center p-8\">\r\n            <div className=\"card max-w-md w-full flex flex-col items-center p-8\">\r\n                <AlertTriangle size={64} className=\"mb-6 text-orange-500 opacity-80\" />\r\n                <h2 className=\"text-2xl font-bold mb-2 text-gray-800 text-center\">Product not found</h2>\r\n                <p className=\"mb-8 text-center text-gray-500 font-mono text-sm bg-gray-50 px-4 py-2 rounded\">\r\n                    ID: {id}\r\n                </p>\r\n                <button\r\n                    onClick={() => navigate('/inventory')}\r\n                    className=\"btn-secondary flex items-center gap-2\"\r\n                >\r\n                    <ArrowLeft size={18} />\r\n                    Back to list\r\n                </button>\r\n            </div>\r\n        </div>\r\n    )\r\n\r\n    return (\r\n        <div className=\"product-detail-page\">\r\n            {/* Header */}\r\n            <header className=\"detail-header\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <button onClick={() => navigate('/inventory')} className=\"btn-icon\" title=\"Back\">\r\n                        <ArrowLeft />\r\n                    </button>\r\n                    <div>\r\n                        <h1 className=\"text-2xl font-bold\">{product.name}</h1>\r\n                        <span className=\"sku-badge\">SKU: {product.sku}</span>\r\n                    </div>\r\n                </div>\r\n                <button\r\n                    onClick={handleSave}\r\n                    disabled={saving}\r\n                    className=\"btn-primary\"\r\n                    title=\"Save changes\"\r\n                >\r\n                    <Save size={18} />\r\n                    {saving ? 'Saving...' : 'Save'}\r\n                </button>\r\n            </header>\r\n\r\n            {/* Tabs */}\r\n            <div className=\"detail-tabs\">\r\n                <button className={`tab-btn ${activeTab === 'general' ? 'active' : ''}`} onClick={() => setActiveTab('general')}>\r\n                    <Settings size={16} /> General\r\n                </button>\r\n                <button className={`tab-btn ${activeTab === 'units' ? 'active' : ''}`} onClick={() => setActiveTab('units')}>\r\n                    <Scale size={16} /> Units\r\n                </button>\r\n                <button className={`tab-btn ${activeTab === 'recipe' ? 'active' : ''}`} onClick={() => setActiveTab('recipe')}>\r\n                    <Layers size={16} /> Recipe\r\n                </button>\r\n                <button className={`tab-btn ${activeTab === 'variants' ? 'active' : ''}`} onClick={() => setActiveTab('variants')}>\r\n                    <Layers size={16} /> Variants\r\n                </button>\r\n                <button className={`tab-btn ${activeTab === 'costing' ? 'active' : ''}`} onClick={() => setActiveTab('costing')}>\r\n                    <DollarSign size={16} /> Costing\r\n                </button>\r\n                <button className={`tab-btn ${activeTab === 'prices' ? 'active' : ''}`} onClick={() => setActiveTab('prices')}>\r\n                    <DollarSign size={16} /> Prices\r\n                </button>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"detail-content\">\r\n                {activeTab === 'general' && (\r\n                    <GeneralTab\r\n                        product={product}\r\n                        categories={categories}\r\n                        sections={sections}\r\n                        selectedSections={productSections}\r\n                        primarySectionId={primarySectionId}\r\n                        uoms={uoms}\r\n                        onSectionsChange={setProductSections}\r\n                        onPrimarySectionChange={setPrimarySectionId}\r\n                        onChange={setProduct}\r\n                    />\r\n                )}\r\n                {activeTab === 'units' && (\r\n                    <UnitsTab product={product} uoms={uoms} onProductChange={setProduct} onAddUOM={addUOM} onDeleteUOM={deleteUOM} />\r\n                )}\r\n                {activeTab === 'recipe' && (\r\n                    <RecipeTab\r\n                        recipeItems={recipeItems}\r\n                        allIngredients={allIngredients}\r\n                        showIngredientSearch={showIngredientSearch}\r\n                        setShowIngredientSearch={setShowIngredientSearch}\r\n                        onAddIngredient={addIngredient}\r\n                        onRemoveIngredient={removeIngredient}\r\n                        onUpdateQuantity={updateRecipeQuantity}\r\n                        productType={product.product_type ?? undefined}\r\n                    />\r\n                )}\r\n                {activeTab === 'costing' && (\r\n                    <CostingTab product={product} recipeItems={recipeItems} />\r\n                )}\r\n                {activeTab === 'prices' && (\r\n                    <PricesTab product={product} priceHistory={priceHistory} />\r\n                )}\r\n                {activeTab === 'variants' && id && (\r\n                    <VariantsTab productId={id} />\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\StockByLocationPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\StockMovementsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\StockOpnameForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\StockOpnameList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\StockPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\StockProductionPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":426,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":426,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16412,16415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16412,16415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":480,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":480,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18995,18998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18995,18998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":514,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":514,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20243,20246],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20243,20246],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":515,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":515,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20339,20342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20339,20342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport {\r\n    Calendar, ChevronLeft, ChevronRight, Search,\r\n    Trash2, Save, Clock, Package, Lock, Eye, Layers\r\n} from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { useAuthStore } from '../../stores/authStore'\r\nimport { Product, Section, ProductionRecord } from '../../types/database'\r\nimport { toast } from 'sonner'\r\nimport './StockProductionPage.css'\r\n\r\n// Format number with thousand separators (French locale uses spaces)\r\nconst formatNumber = (num: number): string => {\r\n    return num.toLocaleString('fr-FR')\r\n}\r\n\r\ninterface AvailableUnit {\r\n    name: string\r\n    conversionFactor: number\r\n    isBase: boolean\r\n}\r\n\r\ninterface ProductionItem {\r\n    productId: string\r\n    name: string\r\n    category: string\r\n    icon: string\r\n    unit: string\r\n    selectedUnit: string\r\n    conversionFactor: number\r\n    availableUnits: AvailableUnit[]\r\n    quantity: number\r\n    wasted: number\r\n    wasteReason: string\r\n}\r\n\r\ninterface ProductUOM {\r\n    id: string\r\n    unit_name: string\r\n    conversion_factor: number\r\n    is_consumption_unit: boolean\r\n}\r\n\r\ninterface ProductWithSection extends Product {\r\n    category?: { name: string; icon: string }\r\n    product_uoms?: ProductUOM[]\r\n}\r\n\r\nexport default function StockProductionPage() {\r\n    const { user } = useAuthStore()\r\n    // Check admin status via permissions hook would be better, but for now just allow\r\n    const isAdmin = true\r\n\r\n    // State\r\n    const [selectedDate, setSelectedDate] = useState(new Date())\r\n    const [sections, setSections] = useState<Section[]>([])\r\n    const [selectedSectionId, setSelectedSectionId] = useState<string | null>(null)\r\n    const [sectionProducts, setSectionProducts] = useState<ProductWithSection[]>([])\r\n    const [productionItems, setProductionItems] = useState<ProductionItem[]>([])\r\n    const [todayHistory, setTodayHistory] = useState<(ProductionRecord & { product?: Product })[]>([])\r\n    const [searchQuery, setSearchQuery] = useState('')\r\n    const [isLoading, setIsLoading] = useState(true)\r\n    const [isSaving, setIsSaving] = useState(false)\r\n\r\n    // Fetch sections on mount\r\n    useEffect(() => {\r\n        fetchSections()\r\n    }, [])\r\n\r\n    // Fetch products when section changes\r\n    useEffect(() => {\r\n        if (selectedSectionId) {\r\n            fetchSectionProducts()\r\n            fetchTodayHistory()\r\n        }\r\n    }, [selectedSectionId, selectedDate])\r\n\r\n    const fetchSections = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('sections')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .eq('section_type', 'production')\r\n                .order('sort_order')\r\n\r\n            if (error) throw error\r\n            setSections(data || [])\r\n\r\n            if (data && data.length > 0 && !selectedSectionId) {\r\n                setSelectedSectionId(data[0].id)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching sections:', error)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const fetchSectionProducts = async () => {\r\n        if (!selectedSectionId) return\r\n\r\n        try {\r\n            console.log('📦 [StockProduction] Fetching products for section:', selectedSectionId)\r\n\r\n            // First, get all product_sections for this section\r\n            const { data: psData, error: psError } = await supabase\r\n                .from('product_sections')\r\n                .select('product_id')\r\n                .eq('section_id', selectedSectionId)\r\n\r\n            console.log('📦 [StockProduction] Product IDs:', psData)\r\n\r\n            if (psError) {\r\n                console.error('❌ [StockProduction] Error fetching product_sections:', psError)\r\n                throw psError\r\n            }\r\n\r\n            if (!psData || psData.length === 0) {\r\n                console.log('📦 [StockProduction] No products found for this section')\r\n                setSectionProducts([])\r\n                return\r\n            }\r\n\r\n            const productIds = psData.map(ps => ps.product_id)\r\n            console.log('📦 [StockProduction] Product IDs to fetch:', productIds.length)\r\n\r\n            // Then fetch the full product details\r\n            const { data, error } = await supabase\r\n                .from('products')\r\n                .select(`\r\n                    *,\r\n                    category:categories(name, icon)\r\n                `)\r\n                .in('id', productIds)\r\n                .in('product_type', ['finished', 'semi_finished'])\r\n                .neq('is_active', false)\r\n\r\n            console.log('📦 [StockProduction] Products fetched:', data?.length)\r\n            console.log('📦 [StockProduction] Error:', error)\r\n\r\n            if (error) throw error\r\n\r\n            // Fetch UOMs separately for each product\r\n            const productsWithUoms = await Promise.all(\r\n                (data || []).map(async (product) => {\r\n                    const { data: uoms } = await supabase\r\n                        .from('product_uoms')\r\n                        .select('id, unit_name, conversion_factor, is_consumption_unit')\r\n                        .eq('product_id', product.id)\r\n\r\n                    return {\r\n                        ...product,\r\n                        product_uoms: uoms || []\r\n                    }\r\n                })\r\n            )\r\n\r\n            const products = productsWithUoms as unknown as ProductWithSection[]\r\n            console.log('📦 [StockProduction] Final products:', products.length, products.slice(0, 5).map(p => p.name))\r\n\r\n            setSectionProducts(products)\r\n        } catch (error) {\r\n            console.error('❌ [StockProduction] Error fetching section products:', error)\r\n        }\r\n    }\r\n\r\n    const fetchTodayHistory = async () => {\r\n        if (!selectedSectionId) return\r\n\r\n        try {\r\n            const dateStr = selectedDate.toISOString().split('T')[0]\r\n\r\n            const { data, error } = await supabase\r\n                .from('production_records')\r\n                .select(`\r\n                    *,\r\n                    products!product_id(\r\n                        name,\r\n                        sku,\r\n                        unit\r\n                    )\r\n                `)\r\n                .eq('production_date', dateStr)\r\n                .order('created_at', { ascending: false })\r\n\r\n            if (error) throw error\r\n            setTodayHistory((data || []) as never)\r\n        } catch (error) {\r\n            console.error('Error fetching history:', error)\r\n        }\r\n    }\r\n\r\n    const formatDate = (date: Date) => {\r\n        return date.toLocaleDateString('fr-FR', {\r\n            weekday: 'long',\r\n            day: 'numeric',\r\n            month: 'long',\r\n            year: 'numeric'\r\n        })\r\n    }\r\n\r\n    const navigateDate = (direction: number) => {\r\n        const newDate = new Date(selectedDate)\r\n        newDate.setDate(newDate.getDate() + direction)\r\n        setSelectedDate(newDate)\r\n    }\r\n\r\n    const isToday = selectedDate.toDateString() === new Date().toDateString()\r\n\r\n    const filteredProducts = sectionProducts.filter(p =>\r\n        p.name.toLowerCase().includes(searchQuery.toLowerCase()) &&\r\n        !productionItems.find(item => item.productId === p.id)\r\n    )\r\n\r\n    const getAvailableUnits = (product: ProductWithSection): AvailableUnit[] => {\r\n        const baseUnit = product.unit || 'pcs'\r\n        const units: AvailableUnit[] = [\r\n            { name: baseUnit, conversionFactor: 1, isBase: true }\r\n        ]\r\n\r\n        if (product.product_uoms) {\r\n            product.product_uoms.forEach(uom => {\r\n                units.push({\r\n                    name: uom.unit_name,\r\n                    conversionFactor: uom.conversion_factor,\r\n                    isBase: false\r\n                })\r\n            })\r\n        }\r\n\r\n        return units\r\n    }\r\n\r\n    const getDefaultUnit = (product: ProductWithSection): { name: string; conversionFactor: number } => {\r\n        const consumptionUom = product.product_uoms?.find(u => u.is_consumption_unit)\r\n        if (consumptionUom) {\r\n            return { name: consumptionUom.unit_name, conversionFactor: consumptionUom.conversion_factor }\r\n        }\r\n        return { name: product.unit || 'pcs', conversionFactor: 1 }\r\n    }\r\n\r\n    type RecordWithProduct = { product?: { unit?: string; product_uoms?: ProductUOM[] } };\r\n    const getRecordUnit = (record: RecordWithProduct): string => {\r\n        const product = record.product\r\n        if (!product) return 'pcs'\r\n        const consumptionUom = product.product_uoms?.find((u) => u.is_consumption_unit)\r\n        return consumptionUom?.unit_name || product.unit || 'pcs'\r\n    }\r\n\r\n    const addProduct = (product: ProductWithSection) => {\r\n        const availableUnits = getAvailableUnits(product)\r\n        const defaultUnit = getDefaultUnit(product)\r\n\r\n        setProductionItems([...productionItems, {\r\n            productId: product.id,\r\n            name: product.name,\r\n            category: product.category?.name || 'General',\r\n            icon: product.category?.icon || '',\r\n            unit: product.unit || 'pcs',\r\n            selectedUnit: defaultUnit.name,\r\n            conversionFactor: defaultUnit.conversionFactor,\r\n            availableUnits,\r\n            quantity: 1,\r\n            wasted: 0,\r\n            wasteReason: ''\r\n        }])\r\n        setSearchQuery('')\r\n    }\r\n\r\n    const updateQuantity = (productId: string, field: 'quantity' | 'wasted', value: number) => {\r\n        setProductionItems(items =>\r\n            items.map(item =>\r\n                item.productId === productId\r\n                    ? { ...item, [field]: Math.max(0, value) }\r\n                    : item\r\n            )\r\n        )\r\n    }\r\n\r\n    const updateUnit = (productId: string, unitName: string) => {\r\n        setProductionItems(items =>\r\n            items.map(item => {\r\n                if (item.productId !== productId) return item\r\n                const unit = item.availableUnits.find(u => u.name === unitName)\r\n                return {\r\n                    ...item,\r\n                    selectedUnit: unitName,\r\n                    conversionFactor: unit?.conversionFactor || 1\r\n                }\r\n            })\r\n        )\r\n    }\r\n\r\n    const updateReason = (productId: string, reason: string) => {\r\n        setProductionItems(items =>\r\n            items.map(item =>\r\n                item.productId === productId\r\n                    ? { ...item, wasteReason: reason }\r\n                    : item\r\n            )\r\n        )\r\n    }\r\n\r\n    const removeItem = (productId: string) => {\r\n        setProductionItems(items => items.filter(item => item.productId !== productId))\r\n    }\r\n\r\n    const selectedSection = sections.find(s => s.id === selectedSectionId)\r\n\r\n    const handleSave = async () => {\r\n        if (productionItems.length === 0 || !selectedSectionId) return\r\n        setIsSaving(true)\r\n\r\n        try {\r\n            const dateStr = selectedDate.toISOString().split('T')[0]\r\n\r\n            for (const item of productionItems) {\r\n                // Convert quantity to base unit using conversion factor\r\n                const quantityInBaseUnit = item.quantity * item.conversionFactor\r\n                const wastedInBaseUnit = item.wasted * item.conversionFactor\r\n\r\n                // Validate numeric overflow (DECIMAL(10,3) max = 9,999,999.999)\r\n                const MAX_DECIMAL = 9999999.999\r\n                if (quantityInBaseUnit > MAX_DECIMAL || wastedInBaseUnit > MAX_DECIMAL) {\r\n                    throw new Error(`Quantité trop grande (${quantityInBaseUnit.toLocaleString()}). Maximum: ${MAX_DECIMAL.toLocaleString()}. Utilisez une unité plus grande.`)\r\n                }\r\n\r\n                // Generate production number\r\n                const productionNumber = `PROD-${Date.now()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`\r\n\r\n                // Build notes with unit info\r\n                const unitNote = item.selectedUnit !== item.unit\r\n                    ? `Saisi: ${item.quantity} ${item.selectedUnit} (= ${quantityInBaseUnit} ${item.unit})`\r\n                    : ''\r\n                const wasteNote = item.wasteReason ? `Perte: ${item.wasteReason}` : ''\r\n                const sectionNote = `Section: ${selectedSection?.name || ''}`\r\n                const notes = [unitNote, wasteNote, sectionNote].filter(Boolean).join('. ')\r\n\r\n                const productionData = {\r\n                    production_id: productionNumber,\r\n                    product_id: item.productId,\r\n                    quantity_produced: quantityInBaseUnit,\r\n                    quantity_waste: wastedInBaseUnit,\r\n                    production_date: dateStr,\r\n                    staff_id: user?.id,\r\n                    notes\r\n                }\r\n\r\n                const { data: prodRecord, error: prodError } = await supabase\r\n                    .from('production_records')\r\n                    .insert(productionData as never)\r\n                    .select()\r\n                    .single()\r\n\r\n                if (prodError) throw prodError\r\n\r\n                const { data: productData } = await supabase\r\n                    .from('products')\r\n                    .select('current_stock')\r\n                    .eq('id', item.productId)\r\n                    .single()\r\n\r\n                const currentStock = productData?.current_stock || 0\r\n\r\n                if (quantityInBaseUnit > 0) {\r\n                    const movementId = `MV-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`\r\n                    const stockData = {\r\n                        movement_id: movementId,\r\n                        product_id: item.productId,\r\n                        movement_type: 'production_in' as const,\r\n                        quantity: quantityInBaseUnit,\r\n                        stock_before: currentStock,\r\n                        stock_after: currentStock + quantityInBaseUnit,\r\n                        reason: `Production ${selectedSection?.name || ''} - ${dateStr}`,\r\n                        reference_type: 'production',\r\n                        reference_id: prodRecord.id,\r\n                        staff_id: user?.id\r\n                    }\r\n\r\n                    const { error: stockError } = await supabase\r\n                        .from('stock_movements')\r\n                        .insert(stockData as never)\r\n\r\n                    if (stockError) throw stockError\r\n                }\r\n\r\n                if (wastedInBaseUnit > 0) {\r\n                    const wasteMovementId = `MV-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`\r\n                    const stockAfterProduction = currentStock + quantityInBaseUnit\r\n                    const wasteData = {\r\n                        movement_id: wasteMovementId,\r\n                        product_id: item.productId,\r\n                        movement_type: 'waste' as const,\r\n                        quantity: wastedInBaseUnit, // Positive value - trigger handles subtraction for 'waste' type\r\n                        stock_before: stockAfterProduction,\r\n                        stock_after: stockAfterProduction - wastedInBaseUnit,\r\n                        reason: item.wasteReason || `Production waste ${dateStr}`,\r\n                        reference_type: 'production',\r\n                        reference_id: prodRecord.id,\r\n                        staff_id: user?.id\r\n                    }\r\n\r\n                    const { error: wasteError } = await supabase\r\n                        .from('stock_movements')\r\n                        .insert(wasteData as never)\r\n\r\n                    if (wasteError) throw wasteError\r\n                }\r\n\r\n                // Note: Stock update is handled automatically by the database trigger 'tr_stock_update'\r\n                // when stock_movements are inserted, so no manual update needed here\r\n\r\n                const { data: recipeItems } = await supabase\r\n                    .from('recipes')\r\n                    .select(`\r\n                        id,\r\n                        material_id,\r\n                        quantity,\r\n                        unit,\r\n                        material:products!material_id(id, name, current_stock, cost_price, unit)\r\n                    `)\r\n                    .eq('product_id', item.productId)\r\n\r\n                if (recipeItems && recipeItems.length > 0) {\r\n                    for (const recipe of recipeItems as any[]) {\r\n                        const material = recipe.material as { id: string; name: string; current_stock: number | null; cost_price: number | null; unit: string | null } | null\r\n                        if (!material) continue\r\n\r\n                        // Use quantity in base unit for recipe deduction\r\n                        const qtyToDeduct = recipe.quantity * quantityInBaseUnit\r\n                        const materialCurrentStock = material.current_stock || 0\r\n\r\n                        const materialMovementId = `MV-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`\r\n                        const movementData = {\r\n                            movement_id: materialMovementId,\r\n                            product_id: recipe.material_id,\r\n                            movement_type: 'production_out' as const,\r\n                            quantity: qtyToDeduct, // Positive value - trigger handles subtraction for 'production_out' type\r\n                            stock_before: materialCurrentStock,\r\n                            stock_after: materialCurrentStock - qtyToDeduct,\r\n                            reason: `Used for: ${item.name} (x${item.quantity}) - ${dateStr}`,\r\n                            reference_type: 'production',\r\n                            reference_id: prodRecord.id,\r\n                            staff_id: user?.id\r\n                        }\r\n\r\n                        await supabase\r\n                            .from('stock_movements')\r\n                            .insert(movementData as never)\r\n\r\n                        // Note: Material stock update is handled automatically by the database trigger 'tr_stock_update'\r\n                    }\r\n                }\r\n            }\r\n\r\n            toast.success('Production enregistree')\r\n            setProductionItems([])\r\n            fetchTodayHistory()\r\n        } catch (error) {\r\n            console.error('Error saving:', error)\r\n            toast.error('Erreur: ' + (error instanceof Error ? error.message : 'Erreur inconnue'))\r\n        } finally {\r\n            setIsSaving(false)\r\n        }\r\n    }\r\n\r\n    const handleDeleteRecord = async (recordId: string) => {\r\n        if (!isAdmin) return\r\n        if (!confirm('Supprimer cette entree et ses mouvements de stock?')) return\r\n\r\n        try {\r\n            const { data: record } = await supabase\r\n                .from('production_records')\r\n                .select('product_id, quantity_produced')\r\n                .eq('id', recordId)\r\n                .single()\r\n\r\n            if (record) {\r\n                const rec = record as any\r\n                const { data: productData } = await supabase\r\n                    .from('products')\r\n                    .select('current_stock')\r\n                    .eq('id', rec.product_id)\r\n                    .single()\r\n\r\n                const currentStock = productData?.current_stock || 0\r\n                const netChange = rec.quantity_produced - (rec.quantity_waste || 0)\r\n\r\n                await supabase\r\n                    .from('products')\r\n                    .update({ current_stock: currentStock - netChange })\r\n                    .eq('id', rec.product_id)\r\n            }\r\n\r\n            await supabase\r\n                .from('stock_movements')\r\n                .delete()\r\n                .eq('reference_id', recordId)\r\n\r\n            const { error } = await supabase\r\n                .from('production_records')\r\n                .delete()\r\n                .eq('id', recordId)\r\n\r\n            if (error) throw error\r\n            toast.success('Entree et mouvements supprimes')\r\n            fetchTodayHistory()\r\n        } catch (error) {\r\n            toast.error('Erreur: ' + (error instanceof Error ? error.message : 'Erreur inconnue'))\r\n        }\r\n    }\r\n\r\n    const totalProduced = todayHistory.reduce((sum, r) => sum + (r as any).quantity_produced, 0)\r\n    const totalWaste = todayHistory.reduce((sum, r) => sum + ((r as any).quantity_waste || 0), 0)\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"production-loading\">\r\n                <div className=\"spinner\" />\r\n                <p>Chargement...</p>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"stock-production-page\">\r\n            {/* Section & Date Selectors */}\r\n            <div className=\"production-selectors\">\r\n                {/* Section Selector */}\r\n                <div className=\"selector-card\">\r\n                    <div className=\"selector-header\">\r\n                        <Layers size={18} />\r\n                        <span>Section</span>\r\n                    </div>\r\n                    <div className=\"selector-options\">\r\n                        {sections.map(section => (\r\n                            <button\r\n                                key={section.id}\r\n                                onClick={() => setSelectedSectionId(section.id)}\r\n                                className={`selector-btn ${selectedSectionId === section.id ? 'active' : ''}`}\r\n                            >\r\n                                {section.name}\r\n                            </button>\r\n                        ))}\r\n                        {sections.length === 0 && (\r\n                            <p className=\"no-sections\">Aucune section de production configuree</p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Date Selector */}\r\n                <div className=\"selector-card\">\r\n                    <div className=\"selector-header\">\r\n                        <Calendar size={18} />\r\n                        <span>Date</span>\r\n                    </div>\r\n                    <div className=\"date-nav\">\r\n                        <button onClick={() => navigateDate(-1)} className=\"date-nav-btn\" title=\"Jour précédent\" aria-label=\"Jour précédent\">\r\n                            <ChevronLeft size={20} />\r\n                        </button>\r\n                        <div className={`date-display ${isToday ? 'today' : ''}`}>\r\n                            {isToday ? \"Aujourd'hui\" : formatDate(selectedDate)}\r\n                        </div>\r\n                        <button onClick={() => navigateDate(1)} className=\"date-nav-btn\" title=\"Jour suivant\" aria-label=\"Jour suivant\">\r\n                            <ChevronRight size={20} />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content */}\r\n            {!selectedSectionId ? (\r\n                <div className=\"production-empty-state\">\r\n                    <Layers size={48} />\r\n                    <h3>Selectionnez une section</h3>\r\n                    <p>Choisissez une section de production pour commencer</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"production-content\">\r\n                    {/* Left - Production Entry */}\r\n                    <div className=\"production-entry-card\">\r\n                        <h2>Saisie Production - {selectedSection?.name}</h2>\r\n\r\n                        {/* Product Search */}\r\n                        <div className=\"product-search-wrapper\">\r\n                            <Search size={20} className=\"search-icon\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder=\"Rechercher un produit...\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                                className=\"product-search-input\"\r\n                            />\r\n\r\n                            {/* Search Results */}\r\n                            {searchQuery && filteredProducts.length > 0 && (\r\n                                <div className=\"product-search-dropdown\">\r\n                                    {filteredProducts.map(product => (\r\n                                        <button\r\n                                            key={product.id}\r\n                                            onClick={() => addProduct(product)}\r\n                                            className=\"product-search-item\"\r\n                                        >\r\n                                            <div className=\"product-info\">\r\n                                                <div className=\"product-name\">{product.name}</div>\r\n                                                <div className=\"product-category\">{product.category?.name}</div>\r\n                                            </div>\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n\r\n                            {searchQuery && filteredProducts.length === 0 && (\r\n                                <div className=\"product-search-empty\">\r\n                                    Aucun produit trouve dans cette section\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Production Items Table */}\r\n                        {productionItems.length > 0 ? (\r\n                            <div className=\"production-table-wrapper\">\r\n                                <table className=\"production-table\">\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th>Produit</th>\r\n                                            <th className=\"text-center\">Quantite</th>\r\n                                            <th className=\"text-center\">Perte</th>\r\n                                            <th>Note</th>\r\n                                            <th></th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {productionItems.map(item => (\r\n                                            <tr key={item.productId}>\r\n                                                <td>\r\n                                                    <div className=\"product-cell\">\r\n                                                        <div className=\"product-name\">{item.name}</div>\r\n                                                        <div className=\"product-category\">{item.category}</div>\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td>\r\n                                                    <div className=\"quantity-input-group\">\r\n                                                        <input\r\n                                                            type=\"number\"\r\n                                                            value={item.quantity}\r\n                                                            onChange={(e) => updateQuantity(item.productId, 'quantity', parseFloat(e.target.value) || 0)}\r\n                                                            className=\"qty-input\"\r\n                                                            min=\"0\"\r\n                                                            step=\"0.1\"\r\n                                                            placeholder=\"0\"\r\n                                                        />\r\n                                                        {item.availableUnits.length > 1 ? (\r\n                                                            <select\r\n                                                                value={item.selectedUnit}\r\n                                                                onChange={(e) => updateUnit(item.productId, e.target.value)}\r\n                                                                className=\"unit-select\"\r\n                                                                title=\"Sélectionner l'unité\"\r\n                                                                aria-label=\"Sélectionner l'unité\"\r\n                                                            >\r\n                                                                {item.availableUnits.map(u => (\r\n                                                                    <option key={u.name} value={u.name}>\r\n                                                                        {u.name}\r\n                                                                    </option>\r\n                                                                ))}\r\n                                                            </select>\r\n                                                        ) : (\r\n                                                            <span className=\"unit-label\">{item.selectedUnit}</span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td>\r\n                                                    <div className=\"quantity-input-group waste\">\r\n                                                        <input\r\n                                                            type=\"number\"\r\n                                                            value={item.wasted}\r\n                                                            onChange={(e) => updateQuantity(item.productId, 'wasted', parseFloat(e.target.value) || 0)}\r\n                                                            className={`qty-input ${item.wasted > 0 ? 'waste-active' : ''}`}\r\n                                                            min=\"0\"\r\n                                                            step=\"0.1\"\r\n                                                            placeholder=\"0\"\r\n                                                        />\r\n                                                        <span className={`unit-label ${item.wasted > 0 ? 'text-red' : ''}`}>{item.selectedUnit}</span>\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td>\r\n                                                    {item.wasted > 0 && (\r\n                                                        <input\r\n                                                            type=\"text\"\r\n                                                            placeholder=\"Raison...\"\r\n                                                            value={item.wasteReason}\r\n                                                            onChange={(e) => updateReason(item.productId, e.target.value)}\r\n                                                            className=\"waste-reason-input\"\r\n                                                        />\r\n                                                    )}\r\n                                                </td>\r\n                                                <td>\r\n                                                    <button onClick={() => removeItem(item.productId)} className=\"btn-remove\" title=\"Supprimer la ligne\" aria-label=\"Supprimer la ligne\">\r\n                                                        <Trash2 size={18} />\r\n                                                    </button>\r\n                                                </td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"production-items-empty\">\r\n                                <Package size={40} />\r\n                                <p>Aucun produit ajoute</p>\r\n                                <span>Recherchez un produit pour l'ajouter a la production</span>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Save Button */}\r\n                        {productionItems.length > 0 && (\r\n                            <div className=\"production-actions\">\r\n                                <button\r\n                                    onClick={() => setProductionItems([])}\r\n                                    disabled={isSaving}\r\n                                    className=\"btn-cancel\"\r\n                                >\r\n                                    Annuler\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleSave}\r\n                                    disabled={isSaving}\r\n                                    className=\"btn-save\"\r\n                                >\r\n                                    <Save size={18} />\r\n                                    {isSaving ? 'Enregistrement...' : 'Enregistrer'}\r\n                                </button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Right - Summary & History */}\r\n                    <div className=\"production-sidebar\">\r\n                        {/* Summary Card */}\r\n                        <div className=\"summary-card\">\r\n                            <h3>Resume du jour</h3>\r\n                            <div className=\"summary-grid\">\r\n                                <div className=\"summary-item produced\">\r\n                                    <div className=\"summary-value\">{formatNumber(totalProduced)}</div>\r\n                                    <div className=\"summary-label\">Produit</div>\r\n                                </div>\r\n                                <div className=\"summary-item waste\">\r\n                                    <div className=\"summary-value\">{formatNumber(totalWaste)}</div>\r\n                                    <div className=\"summary-label\">Perte</div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* History Card */}\r\n                        <div className=\"history-card\">\r\n                            <div className=\"history-header\">\r\n                                <h3>Production du jour ({todayHistory.length})</h3>\r\n                                {!isAdmin && (\r\n                                    <div className=\"read-only-badge\">\r\n                                        <Eye size={14} />\r\n                                        Lecture seule\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"history-list\">\r\n                                {todayHistory.length > 0 ? (\r\n                                    todayHistory.map(record => (\r\n                                        <div key={record.id} className=\"history-item\">\r\n                                            <div className=\"history-item-info\">\r\n                                                <div className=\"history-product\">{record.product?.name}</div>\r\n                                                <div className=\"history-time\">\r\n                                                    <Clock size={12} />\r\n                                                    {record.created_at ? new Date(record.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : ''}\r\n                                                </div>\r\n                                            </div>\r\n                                            <div className=\"history-item-actions\">\r\n                                                <span className=\"badge-produced\">\r\n                                                    +{formatNumber(record.quantity_produced)} {getRecordUnit(record as RecordWithProduct)}\r\n                                                </span>\r\n                                                {(record as unknown as { quantity_waste?: number }).quantity_waste && (record as unknown as { quantity_waste: number }).quantity_waste > 0 && (\r\n                                                    <span className=\"badge-waste\">\r\n                                                        -{formatNumber((record as unknown as { quantity_waste: number }).quantity_waste)} {getRecordUnit(record as RecordWithProduct)}\r\n                                                    </span>\r\n                                                )}\r\n                                                {isAdmin && (\r\n                                                    <button\r\n                                                        onClick={() => handleDeleteRecord(record.id)}\r\n                                                        className=\"btn-delete-record\"\r\n                                                        title=\"Supprimer\"\r\n                                                    >\r\n                                                        <Trash2 size={14} />\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    ))\r\n                                ) : (\r\n                                    <div className=\"history-empty\">\r\n                                        <Clock size={32} />\r\n                                        <p>Aucune production enregistree</p>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {!isAdmin && todayHistory.length > 0 && (\r\n                                <div className=\"admin-notice\">\r\n                                    <Lock size={16} />\r\n                                    <span>Seul un administrateur peut modifier les entrees</span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\TransferDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3966,3969],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3966,3969],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from 'react'\r\nimport { useParams, useNavigate } from 'react-router-dom'\r\nimport { ArrowLeft, ArrowRightLeft, CheckCircle, Clock, Package, AlertTriangle, WifiOff } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\nimport { useTransfer, useReceiveTransfer } from '@/hooks/inventory'\r\nimport { useNetworkStatus } from '@/hooks/offline/useNetworkStatus'\r\nimport './TransferDetailPage.css'\r\n\r\n// Status colors\r\nconst STATUS_COLORS = {\r\n  draft: '#6b7280',\r\n  pending: '#f59e0b',\r\n  in_transit: '#3b82f6',\r\n  received: '#10b981',\r\n  cancelled: '#ef4444'\r\n} as const\r\n\r\nexport default function TransferDetailPage() {\r\n  const { id } = useParams<{ id: string }>()\r\n  const navigate = useNavigate()\r\n  const { isOnline } = useNetworkStatus()\r\n\r\n  const { data: transfer, isLoading, error } = useTransfer(id ?? null)\r\n  const receiveTransferMutation = useReceiveTransfer()\r\n\r\n  // State for editable quantities\r\n  const [itemQuantities, setItemQuantities] = useState<Map<string, number>>(new Map())\r\n  const [receptionNotes, setReceptionNotes] = useState('')\r\n  const [validationErrors, setValidationErrors] = useState<Map<string, string>>(new Map())\r\n\r\n  // Initialize quantities from transfer items\r\n  useEffect(() => {\r\n    if (transfer?.items) {\r\n      const initialQuantities = new Map<string, number>()\r\n      transfer.items.forEach(item => {\r\n        initialQuantities.set(item.id, item.quantity_requested)\r\n      })\r\n      setItemQuantities(initialQuantities)\r\n    }\r\n  }, [transfer])\r\n\r\n  // Check if transfer can be received\r\n  const canReceive = useMemo(() => {\r\n    return isOnline\r\n      && transfer\r\n      && (transfer.status === 'pending' || transfer.status === 'in_transit')\r\n  }, [isOnline, transfer])\r\n\r\n  // Calculate variance for each item\r\n  const getVariance = (itemId: string, quantityRequested: number): number => {\r\n    const received = itemQuantities.get(itemId) ?? quantityRequested\r\n    return received - quantityRequested\r\n  }\r\n\r\n  // Check if there are any variances\r\n  const hasVariances = useMemo(() => {\r\n    if (!transfer?.items) return false\r\n    return transfer.items.some(item => {\r\n      const variance = getVariance(item.id, item.quantity_requested)\r\n      return variance !== 0\r\n    })\r\n  }, [transfer, itemQuantities])\r\n\r\n  // Validate form\r\n  const validateForm = (): boolean => {\r\n    const errors = new Map<string, string>()\r\n\r\n    if (!transfer?.items) return false\r\n\r\n    for (const item of transfer.items) {\r\n      const quantity = itemQuantities.get(item.id) ?? 0\r\n\r\n      if (quantity < 0) {\r\n        errors.set(item.id, 'Quantity cannot be negative')\r\n      }\r\n\r\n      if (quantity > item.quantity_requested && !receptionNotes.trim()) {\r\n        errors.set(item.id, 'Receiving more than requested requires a note')\r\n      }\r\n    }\r\n\r\n    setValidationErrors(errors)\r\n    return errors.size === 0\r\n  }\r\n\r\n  // Handle quantity change\r\n  const handleQuantityChange = (itemId: string, value: string) => {\r\n    const numValue = parseFloat(value) || 0\r\n    setItemQuantities(prev => new Map(prev).set(itemId, numValue))\r\n    // Clear validation error for this item\r\n    setValidationErrors(prev => {\r\n      const newErrors = new Map(prev)\r\n      newErrors.delete(itemId)\r\n      return newErrors\r\n    })\r\n  }\r\n\r\n  // Handle reception\r\n  const handleReceive = async () => {\r\n    if (!canReceive || !transfer) return\r\n\r\n    if (!validateForm()) {\r\n      toast.error('Please fix the errors before proceeding')\r\n      return\r\n    }\r\n\r\n    const items = transfer.items.map(item => ({\r\n      itemId: item.id,\r\n      quantityReceived: itemQuantities.get(item.id) ?? item.quantity_requested\r\n    }))\r\n\r\n    try {\r\n      await receiveTransferMutation.mutateAsync({\r\n        transferId: transfer.id,\r\n        items,\r\n        receptionNotes: receptionNotes.trim() || undefined\r\n      })\r\n      toast.success('Transfer received successfully')\r\n      navigate('/inventory/transfers')\r\n    } catch (err: any) {\r\n      console.error('Reception error:', err)\r\n      const message = err?.message || 'Error receiving transfer'\r\n      if (message.includes('already been received') || message.includes('another user')) {\r\n        toast.error(message)\r\n      } else {\r\n        toast.error('Error receiving transfer. Please try again.')\r\n      }\r\n    }\r\n  }\r\n\r\n  // Show error toast\r\n  useEffect(() => {\r\n    if (error) {\r\n      toast.error('Error loading transfer')\r\n    }\r\n  }, [error])\r\n\r\n  // Loading state\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"transfer-detail-page\">\r\n        <div className=\"transfer-detail-loading\">Loading...</div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Not found state\r\n  if (!transfer) {\r\n    return (\r\n      <div className=\"transfer-detail-page\">\r\n        <div className=\"transfer-detail-error\">\r\n          <AlertTriangle size={48} />\r\n          <h3>Error</h3>\r\n          <p>Transfer not found</p>\r\n          <button className=\"btn btn-primary\" onClick={() => navigate('/inventory/transfers')}>\r\n            Back\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const statusColor = STATUS_COLORS[transfer.status as keyof typeof STATUS_COLORS] ?? '#6b7280'\r\n  const isReceived = transfer.status === 'received'\r\n\r\n  // Get status label\r\n  const getStatusLabel = (status: string): string => {\r\n    const statusLabels: Record<string, string> = {\r\n      draft: 'Draft',\r\n      pending: 'Pending',\r\n      in_transit: 'In Transit',\r\n      received: 'Received',\r\n      cancelled: 'Cancelled'\r\n    }\r\n    return statusLabels[status] || status\r\n  }\r\n\r\n  return (\r\n    <div className=\"transfer-detail-page\">\r\n      {/* Offline Banner */}\r\n      {!isOnline && (\r\n        <div className=\"offline-banner\">\r\n          <WifiOff size={18} />\r\n          <span>Reception is blocked while offline</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Header */}\r\n      <header className=\"transfer-detail-header\">\r\n        <div className=\"transfer-detail-header__left\">\r\n          <button className=\"btn btn-ghost\" onClick={() => navigate('/inventory/transfers')}>\r\n            <ArrowLeft size={20} />\r\n            Back\r\n          </button>\r\n          <div className=\"transfer-detail-header__info\">\r\n            <h1 className=\"transfer-detail-title\">\r\n              <ArrowRightLeft size={28} />\r\n              {transfer.transfer_number}\r\n            </h1>\r\n            <span\r\n              className=\"transfer-detail-status\"\r\n              style={{ background: `${statusColor}20`, color: statusColor }}\r\n            >\r\n              {isReceived ? <CheckCircle size={14} /> : <Clock size={14} />}\r\n              {getStatusLabel(transfer.status ?? 'draft')}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      {/* Route Information */}\r\n      <div className=\"transfer-detail-route\">\r\n        <div className=\"route-location from\">\r\n          <span className=\"route-label\">From</span>\r\n          <span className=\"route-name\">{transfer.from_location?.name ?? 'Unknown'}</span>\r\n        </div>\r\n        <ArrowRightLeft size={32} className=\"route-arrow\" />\r\n        <div className=\"route-location to\">\r\n          <span className=\"route-label\">To</span>\r\n          <span className=\"route-name\">{transfer.to_location?.name ?? 'Unknown'}</span>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Transfer Info */}\r\n      <div className=\"transfer-detail-info\">\r\n        <div className=\"info-item\">\r\n          <span className=\"info-label\">Date</span>\r\n          <span className=\"info-value\">\r\n            {transfer.transfer_date ? new Date(transfer.transfer_date).toLocaleDateString('en-US') : '-'}\r\n          </span>\r\n        </div>\r\n        <div className=\"info-item\">\r\n          <span className=\"info-label\">Responsible</span>\r\n          <span className=\"info-value\">{transfer.responsible_person}</span>\r\n        </div>\r\n        {isReceived && transfer.approved_at && (\r\n          <div className=\"info-item\">\r\n            <span className=\"info-label\">Received On</span>\r\n            <span className=\"info-value\">\r\n              {new Date(transfer.approved_at).toLocaleDateString('en-US')}\r\n            </span>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Already Received Notice */}\r\n      {isReceived && (\r\n        <div className=\"already-received-notice\">\r\n          <CheckCircle size={20} />\r\n          <span>This transfer has already been received</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Variance Warning */}\r\n      {hasVariances && !isReceived && (\r\n        <div className=\"variance-warning\">\r\n          <AlertTriangle size={20} />\r\n          <span>There are variances between requested and received quantities</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Items Table */}\r\n      <div className=\"transfer-detail-items\">\r\n        <h2 className=\"items-title\">\r\n          <Package size={20} />\r\n          Items ({transfer.items.length})\r\n        </h2>\r\n\r\n        <div className=\"items-table-wrapper\">\r\n          <table className=\"items-table\">\r\n            <thead>\r\n              <tr>\r\n                <th>Product</th>\r\n                <th className=\"text-center\">Qty Requested</th>\r\n                <th className=\"text-center\">Qty Received</th>\r\n                <th className=\"text-center\">Variance</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {transfer.items.map(item => {\r\n                const quantityReceived = isReceived\r\n                  ? item.quantity_received\r\n                  : (itemQuantities.get(item.id) ?? item.quantity_requested)\r\n                const variance = isReceived\r\n                  ? (item.quantity_received ?? 0) - item.quantity_requested\r\n                  : getVariance(item.id, item.quantity_requested)\r\n                const hasError = validationErrors.has(item.id)\r\n\r\n                return (\r\n                  <tr key={item.id} className={hasError ? 'has-error' : ''}>\r\n                    <td>\r\n                      <div className=\"product-cell\">\r\n                        <span className=\"product-name\">{item.product?.name ?? 'Unknown'}</span>\r\n                        {item.product?.sku && (\r\n                          <span className=\"product-sku\">{item.product.sku}</span>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"text-center\">\r\n                      <span className=\"quantity-requested\">{item.quantity_requested}</span>\r\n                    </td>\r\n                    <td className=\"text-center\">\r\n                      {isReceived ? (\r\n                        <span className=\"quantity-received\">{item.quantity_received ?? 0}</span>\r\n                      ) : (\r\n                        <div className=\"quantity-input-wrapper\">\r\n                          <input\r\n                            type=\"number\"\r\n                            className={`quantity-input ${hasError ? 'input-error' : ''}`}\r\n                            value={quantityReceived ?? ''}\r\n                            onChange={(e) => handleQuantityChange(item.id, e.target.value)}\r\n                            min=\"0\"\r\n                            step=\"0.01\"\r\n                            disabled={!canReceive}\r\n                          />\r\n                          {hasError && (\r\n                            <span className=\"error-message\">{validationErrors.get(item.id)}</span>\r\n                          )}\r\n                        </div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"text-center\">\r\n                      <span className={`variance ${variance > 0 ? 'positive' : variance < 0 ? 'negative' : ''}`}>\r\n                        {variance > 0 ? '+' : ''}{variance}\r\n                      </span>\r\n                    </td>\r\n                  </tr>\r\n                )\r\n              })}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Reception Notes */}\r\n      {!isReceived && (\r\n        <div className=\"reception-notes-section\">\r\n          <label className=\"notes-label\">\r\n            Reception Notes\r\n            {hasVariances && <span className=\"required\">*</span>}\r\n          </label>\r\n          <textarea\r\n            className=\"reception-notes-input\"\r\n            value={receptionNotes}\r\n            onChange={(e) => setReceptionNotes(e.target.value)}\r\n            placeholder=\"Add any notes about the reception...\"\r\n            rows={3}\r\n            disabled={!canReceive}\r\n          />\r\n        </div>\r\n      )}\r\n\r\n      {/* Existing Notes */}\r\n      {transfer.notes && (\r\n        <div className=\"existing-notes-section\">\r\n          <label className=\"notes-label\">Notes</label>\r\n          <div className=\"existing-notes\">{transfer.notes}</div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Actions */}\r\n      {!isReceived && (\r\n        <div className=\"transfer-detail-actions\">\r\n          <button\r\n            className=\"btn btn-secondary\"\r\n            onClick={() => navigate('/inventory/transfers')}\r\n          >\r\n            Cancel\r\n          </button>\r\n          <button\r\n            className=\"btn btn-primary\"\r\n            onClick={handleReceive}\r\n            disabled={!canReceive || receiveTransferMutation.isPending}\r\n          >\r\n            <CheckCircle size={18} />\r\n            {receiveTransferMutation.isPending\r\n              ? 'Loading...'\r\n              : 'Receive Transfer'\r\n            }\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\TransferFormPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\WastedPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\CostingTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\GeneralTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2202,2205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2202,2205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2277,2280],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2277,2280],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2384,2387],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2384,2387],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2495,2498],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2495,2498],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2762,2765],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2762,2765],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2837,2840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2837,2840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2977,2980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2977,2980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3116,3119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3116,3119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":310,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":310,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16127,16130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16127,16130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":310,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":310,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16177,16180],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16177,16180],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":322,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17008,17011],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17008,17011],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":322,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17053,17056],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17053,17056],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":334,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":334,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17874,17877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17874,17877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":334,"column":104,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":334,"endColumn":107,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17923,17926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17923,17926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { Product, Category, Section } from '../../../types/database'\r\nimport { Star, Factory, ShoppingCart, Warehouse, Check, Layers } from 'lucide-react'\r\n\r\n// Extended ProductUOM with UI-specific fields\r\ninterface ProductUOMLocal {\r\n    id: string\r\n    product_id: string\r\n    uom_name: string\r\n    uom_code?: string\r\n    conversion_factor: number\r\n    is_purchase_uom?: boolean | null\r\n    is_sale_uom?: boolean | null\r\n}\r\n\r\ninterface GeneralTabProps {\r\n    product: Product\r\n    categories: Category[]\r\n    sections: Section[]\r\n    selectedSections: string[]\r\n    primarySectionId: string | null\r\n    uoms?: ProductUOMLocal[]\r\n    onSectionsChange: (sectionIds: string[]) => void\r\n    onPrimarySectionChange: (sectionId: string | null) => void\r\n    onChange: (product: Product) => void\r\n}\r\n\r\nexport const GeneralTab: React.FC<GeneralTabProps> = ({\r\n    product,\r\n    categories,\r\n    sections,\r\n    selectedSections,\r\n    primarySectionId,\r\n    uoms = [],\r\n    onSectionsChange,\r\n    onPrimarySectionChange,\r\n    onChange\r\n}) => {\r\n    // Get the purchase unit for cost display\r\n    const purchaseUnit = uoms.find(u => u.is_purchase_uom) || uoms[0]\r\n    const costUnitLabel = purchaseUnit?.uom_name || product.unit || 'unit'\r\n    const handleSectionToggle = (sectionId: string) => {\r\n        if (selectedSections.includes(sectionId)) {\r\n            const newSections = selectedSections.filter(id => id !== sectionId)\r\n            onSectionsChange(newSections)\r\n            if (primarySectionId === sectionId) {\r\n                onPrimarySectionChange(newSections[0] || null)\r\n            }\r\n        } else {\r\n            const newSections = [...selectedSections, sectionId]\r\n            onSectionsChange(newSections)\r\n            if (!primarySectionId) {\r\n                onPrimarySectionChange(sectionId)\r\n            }\r\n        }\r\n    }\r\n\r\n    const handlePrimaryChange = (sectionId: string, e: React.MouseEvent) => {\r\n        e.stopPropagation()\r\n        onPrimarySectionChange(sectionId)\r\n    }\r\n\r\n    const getSectionIcon = (section: Section) => {\r\n        // Use section_type (new schema) with fallback to old boolean flags\r\n        const sectionType = (section as any).section_type\r\n        if (sectionType === 'production' || (section as any).is_production_point) return <Factory size={20} />\r\n        if (sectionType === 'sales' || (section as any).is_sales_point) return <ShoppingCart size={20} />\r\n        if (sectionType === 'warehouse' || (section as any).is_warehouse) return <Warehouse size={20} />\r\n        return <Layers size={20} />\r\n    }\r\n\r\n    const getSectionColor = (section: Section) => {\r\n        // Use section_type (new schema) with fallback to old boolean flags\r\n        const sectionType = (section as any).section_type\r\n        if (sectionType === 'production' || (section as any).is_production_point) return { bg: '#FEF3C7', color: '#D97706', border: '#FCD34D' }\r\n        if (sectionType === 'sales' || (section as any).is_sales_point) return { bg: '#D1FAE5', color: '#059669', border: '#6EE7B7' }\r\n        if (sectionType === 'warehouse' || (section as any).is_warehouse) return { bg: '#DBEAFE', color: '#2563EB', border: '#93C5FD' }\r\n        return { bg: '#F3F4F6', color: '#6B7280', border: '#D1D5DB' }\r\n    }\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-2 gap-6\">\r\n            <div className=\"card\">\r\n                <h3 className=\"card-title\">Product Identity</h3>\r\n                <div className=\"form-section\">\r\n                    <div className=\"form-group\">\r\n                        <label htmlFor=\"prod-name\">Product Name</label>\r\n                        <input\r\n                            id=\"prod-name\"\r\n                            className=\"form-input\"\r\n                            value={product.name}\r\n                            onChange={e => onChange({ ...product, name: e.target.value })}\r\n                            placeholder=\"Ex: Tradition Baguette\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"prod-sku\">SKU</label>\r\n                            <input\r\n                                id=\"prod-sku\"\r\n                                className=\"form-input font-mono\"\r\n                                value={product.sku}\r\n                                onChange={e => onChange({ ...product, sku: e.target.value })}\r\n                            />\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"prod-cat\">Category</label>\r\n                            <select\r\n                                id=\"prod-cat\"\r\n                                className=\"form-select\"\r\n                                value={product.category_id || ''}\r\n                                onChange={e => onChange({ ...product, category_id: e.target.value })}\r\n                            >\r\n                                <option value=\"\">Select...</option>\r\n                                {categories.map(c => (\r\n                                    <option key={c.id} value={c.id}>{c.name}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"form-group\">\r\n                        <label htmlFor=\"prod-desc\">Description</label>\r\n                        <textarea\r\n                            id=\"prod-desc\"\r\n                            className=\"form-textarea\"\r\n                            rows={3}\r\n                            value={product.description || ''}\r\n                            onChange={e => onChange({ ...product, description: e.target.value })}\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"card\">\r\n                <h3 className=\"card-title\">Finance & POS</h3>\r\n                <div className=\"form-section\">\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"prod-price\">Retail Price</label>\r\n                            <div className=\"form-input-prefix\">\r\n                                <span>Rp</span>\r\n                                <input\r\n                                    id=\"prod-price\"\r\n                                    type=\"number\"\r\n                                    className=\"form-input\"\r\n                                    value={product.retail_price || 0}\r\n                                    onChange={e => onChange({ ...product, retail_price: parseFloat(e.target.value) })}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"prod-cost\">Fixed Cost <span className=\"label-unit-suffix\">/ {costUnitLabel}</span></label>\r\n                            <div className=\"form-input-prefix\">\r\n                                <span>Rp</span>\r\n                                <input\r\n                                    id=\"prod-cost\"\r\n                                    type=\"number\"\r\n                                    className=\"form-input\"\r\n                                    value={product.cost_price || 0}\r\n                                    onChange={e => onChange({ ...product, cost_price: parseFloat(e.target.value) })}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <hr className=\"border-gray-200\" />\r\n\r\n                    <div className=\"form-group\">\r\n                        <label className=\"flex items-center gap-3 cursor-pointer p-4 border rounded-lg hover:bg-gray-50 transition-colors\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                className=\"w-5 h-5 text-blue-600 rounded\"\r\n                                checked={product.pos_visible ?? false}\r\n                                onChange={e => onChange({ ...product, pos_visible: e.target.checked })}\r\n                            />\r\n                            <div>\r\n                                <span className=\"font-medium text-gray-900\">Visible on POS</span>\r\n                                <p className=\"text-xs text-gray-500 mt-1\">If unchecked, the product will not be available in POS.</p>\r\n                            </div>\r\n                        </label>\r\n                    </div>\r\n\r\n                    <div className=\"form-group\">\r\n                        <label className=\"flex items-center gap-3 cursor-pointer p-4 border rounded-lg hover:bg-gray-50 transition-colors\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                className=\"w-5 h-5 text-blue-600 rounded\"\r\n                                checked={product.deduct_ingredients ?? false}\r\n                                onChange={e => onChange({ ...product, deduct_ingredients: e.target.checked })}\r\n                            />\r\n                            <div>\r\n                                <span className=\"font-medium text-gray-900\">Deduct ingredients on sale</span>\r\n                                <p className=\"text-xs text-gray-500 mt-1\">For products made to order (coffee, sandwiches, etc.). Recipe ingredients will be automatically deducted from stock upon each sale.</p>\r\n                            </div>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Sections Card - Full Width */}\r\n            <div className=\"card col-span-2\">\r\n                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem' }}>\r\n                    <div>\r\n                        <h3 className=\"card-title\" style={{ marginBottom: '0.25rem' }}>Usage Sections</h3>\r\n                        <p style={{ fontSize: '0.8125rem', color: '#8B7355', margin: 0 }}>\r\n                            Select where this product can be used. Click the star to set the primary section.\r\n                        </p>\r\n                    </div>\r\n                    {selectedSections.length > 0 && (\r\n                        <div style={{\r\n                            padding: '0.5rem 1rem',\r\n                            background: 'linear-gradient(135deg, #BA90A2 0%, #D4A5B5 100%)',\r\n                            borderRadius: '2rem',\r\n                            color: 'white',\r\n                            fontSize: '0.875rem',\r\n                            fontWeight: 600\r\n                        }}>\r\n                            {selectedSections.length} section{selectedSections.length > 1 ? 's' : ''} selected\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {sections?.length === 0 ? (\r\n                    <div style={{\r\n                        textAlign: 'center',\r\n                        padding: '3rem',\r\n                        background: '#F9FAFB',\r\n                        borderRadius: '0.75rem',\r\n                        border: '2px dashed #E5E7EB'\r\n                    }}>\r\n                        <Layers size={48} style={{ color: '#D1D5DB', margin: '0 auto 1rem' }} />\r\n                        <p style={{ color: '#6B7280', margin: 0 }}>No sections configured.</p>\r\n                        <p style={{ color: '#9CA3AF', fontSize: '0.875rem', marginTop: '0.5rem' }}>\r\n                            Create sections in Settings → Sections\r\n                        </p>\r\n                    </div>\r\n                ) : (\r\n                    <div style={{\r\n                        display: 'grid',\r\n                        gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',\r\n                        gap: '1rem'\r\n                    }}>\r\n                        {sections?.map(section => {\r\n                            const isSelected = selectedSections.includes(section.id)\r\n                            const isPrimary = primarySectionId === section.id\r\n                            const colors = getSectionColor(section)\r\n\r\n                            return (\r\n                                <div\r\n                                    key={section.id}\r\n                                    onClick={() => handleSectionToggle(section.id)}\r\n                                    style={{\r\n                                        position: 'relative',\r\n                                        padding: '1.25rem',\r\n                                        borderRadius: '1rem',\r\n                                        border: `2px solid ${isSelected ? '#BA90A2' : '#E5E7EB'}`,\r\n                                        background: isSelected ? 'linear-gradient(135deg, rgba(186,144,162,0.08) 0%, rgba(212,165,181,0.08) 100%)' : 'white',\r\n                                        cursor: 'pointer',\r\n                                        transition: 'all 0.2s ease',\r\n                                        transform: isSelected ? 'scale(1.02)' : 'scale(1)',\r\n                                        boxShadow: isSelected ? '0 4px 12px rgba(186,144,162,0.2)' : 'none'\r\n                                    }}\r\n                                >\r\n                                    {/* Selection indicator */}\r\n                                    <div style={{\r\n                                        position: 'absolute',\r\n                                        top: '0.75rem',\r\n                                        right: '0.75rem',\r\n                                        width: '24px',\r\n                                        height: '24px',\r\n                                        borderRadius: '50%',\r\n                                        border: `2px solid ${isSelected ? '#BA90A2' : '#D1D5DB'}`,\r\n                                        background: isSelected ? '#BA90A2' : 'white',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center',\r\n                                        transition: 'all 0.2s ease'\r\n                                    }}>\r\n                                        {isSelected && <Check size={14} color=\"white\" strokeWidth={3} />}\r\n                                    </div>\r\n\r\n                                    {/* Icon */}\r\n                                    <div style={{\r\n                                        width: '48px',\r\n                                        height: '48px',\r\n                                        borderRadius: '12px',\r\n                                        background: colors.bg,\r\n                                        color: colors.color,\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center',\r\n                                        marginBottom: '0.75rem'\r\n                                    }}>\r\n                                        {getSectionIcon(section)}\r\n                                    </div>\r\n\r\n                                    {/* Name */}\r\n                                    <h4 style={{\r\n                                        margin: '0 0 0.5rem 0',\r\n                                        fontSize: '1rem',\r\n                                        fontWeight: 600,\r\n                                        color: '#4A3728'\r\n                                    }}>\r\n                                        {section.name}\r\n                                    </h4>\r\n\r\n                                    {/* Type badges - using section_type */}\r\n                                    <div style={{ display: 'flex', gap: '0.375rem', flexWrap: 'wrap', marginBottom: '0.75rem' }}>\r\n                                        {((section as any).section_type === 'production' || (section as any).is_production_point) && (\r\n                                            <span style={{\r\n                                                fontSize: '0.625rem',\r\n                                                padding: '0.125rem 0.5rem',\r\n                                                borderRadius: '1rem',\r\n                                                background: '#FEF3C7',\r\n                                                color: '#D97706',\r\n                                                fontWeight: 600,\r\n                                                textTransform: 'uppercase',\r\n                                                letterSpacing: '0.025em'\r\n                                            }}>Production</span>\r\n                                        )}\r\n                                        {((section as any).section_type === 'sales' || (section as any).is_sales_point) && (\r\n                                            <span style={{\r\n                                                fontSize: '0.625rem',\r\n                                                padding: '0.125rem 0.5rem',\r\n                                                borderRadius: '1rem',\r\n                                                background: '#D1FAE5',\r\n                                                color: '#059669',\r\n                                                fontWeight: 600,\r\n                                                textTransform: 'uppercase',\r\n                                                letterSpacing: '0.025em'\r\n                                            }}>Sales</span>\r\n                                        )}\r\n                                        {((section as any).section_type === 'warehouse' || (section as any).is_warehouse) && (\r\n                                            <span style={{\r\n                                                fontSize: '0.625rem',\r\n                                                padding: '0.125rem 0.5rem',\r\n                                                borderRadius: '1rem',\r\n                                                background: '#DBEAFE',\r\n                                                color: '#2563EB',\r\n                                                fontWeight: 600,\r\n                                                textTransform: 'uppercase',\r\n                                                letterSpacing: '0.025em'\r\n                                            }}>Warehouse</span>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    {/* Primary star button */}\r\n                                    {isSelected && (\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={(e) => handlePrimaryChange(section.id, e)}\r\n                                            style={{\r\n                                                display: 'flex',\r\n                                                alignItems: 'center',\r\n                                                gap: '0.375rem',\r\n                                                padding: '0.5rem 0.75rem',\r\n                                                borderRadius: '0.5rem',\r\n                                                border: 'none',\r\n                                                background: isPrimary ? 'linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%)' : '#F3F4F6',\r\n                                                color: isPrimary ? 'white' : '#6B7280',\r\n                                                fontSize: '0.75rem',\r\n                                                fontWeight: 600,\r\n                                                cursor: 'pointer',\r\n                                                transition: 'all 0.2s ease',\r\n                                                width: '100%',\r\n                                                justifyContent: 'center'\r\n                                            }}\r\n                                        >\r\n                                            <Star size={14} fill={isPrimary ? 'white' : 'none'} />\r\n                                            {isPrimary ? 'Primary Section' : 'Set as primary'}\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n                            )\r\n                        })}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\ModifiersTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\PricesTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[148,151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[148,151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react'\r\nimport { Product } from '../../../types/database'\r\n\r\ninterface PricesTabProps {\r\n    product: Product\r\n    priceHistory: any[]\r\n}\r\n\r\nexport const PricesTab: React.FC<PricesTabProps> = ({ product, priceHistory }) => {\r\n    const formattedPrice = (amount: number) => {\r\n        return new Intl.NumberFormat('id-ID', {\r\n            style: 'currency',\r\n            currency: 'IDR',\r\n            minimumFractionDigits: 0\r\n        }).format(amount)\r\n    }\r\n\r\n    return (\r\n        <div className=\"card\">\r\n            <div className=\"flex justify-between items-center mb-6\">\r\n                <h3 className=\"card-title\">Price History</h3>\r\n                <div className=\"bg-green-50 px-4 py-2 rounded-lg border border-green-100\">\r\n                    <span className=\"text-green-700 text-sm\">Estimated current price: </span>\r\n                    <span className=\"font-bold text-lg text-green-900 ml-2\">{formattedPrice(product.cost_price || 0)}</span>\r\n                </div>\r\n            </div>\r\n            <div className=\"overflow-hidden rounded-lg border border-gray-200\">\r\n                <table className=\"detail-table\">\r\n                    <thead>\r\n                        <tr>\r\n                            <th>Order Date</th>\r\n                            <th>Supplier</th>\r\n                            <th className=\"text-right\">Quantity</th>\r\n                            <th className=\"text-right\">Unit Price</th>\r\n                            <th className=\"text-right\">Line Total</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {priceHistory.map((item, index) => {\r\n                            const prevItem = priceHistory[index + 1]\r\n                            const priceDiff = prevItem ? item.unit_price - prevItem.unit_price : 0\r\n\r\n                            return (\r\n                                <tr key={item.id}>\r\n                                    <td className=\"text-gray-600\">\r\n                                        {new Date(item.purchase_order?.order_date || item.created_at).toLocaleDateString()}\r\n                                    </td>\r\n                                    <td className=\"font-medium text-gray-800\">\r\n                                        {item.purchase_order?.supplier?.name || 'Unknown Supplier'}\r\n                                    </td>\r\n                                    <td className=\"text-right font-mono\">\r\n                                        {item.quantity_ordered} {product.unit}\r\n                                    </td>\r\n                                    <td className=\"text-right font-medium\">\r\n                                        <div className=\"flex items-center justify-end gap-2\">\r\n                                            {formattedPrice(item.unit_price)}\r\n                                            {priceDiff !== 0 && (\r\n                                                <span className={`text-xs ${priceDiff > 0 ? 'text-red-500' : 'text-green-500'}`}>\r\n                                                    {priceDiff > 0 ? '▲' : '▼'}\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                    </td>\r\n                                    <td className=\"text-right text-gray-500\">\r\n                                        {formattedPrice(item.total)}\r\n                                    </td>\r\n                                </tr>\r\n                            )\r\n                        })}\r\n                        {priceHistory.length === 0 && (\r\n                            <tr>\r\n                                <td colSpan={5} className=\"p-8 text-center text-gray-400\">\r\n                                    No purchase history found.\r\n                                </td>\r\n                            </tr>\r\n                        )}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\RecipeTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\StockTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\UnitsTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3393,3396],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3393,3396],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { Plus, Trash2, Package, Scale, ClipboardList, ShoppingCart } from 'lucide-react'\r\nimport { Product, ProductUOM } from '../../../types/database'\r\nimport { supabase } from '../../../lib/supabase'\r\n\r\n// Extended UOM type with UI-specific fields\r\ninterface ExtendedUOM extends ProductUOM {\r\n    is_stock_opname_unit?: boolean\r\n    is_consumption_unit?: boolean\r\n}\r\n\r\ninterface UnitsTabProps {\r\n    product: Product\r\n    uoms: ProductUOM[]\r\n    onProductChange: (product: Product) => void\r\n    onAddUOM?: () => void\r\n    onDeleteUOM: (id: string) => void\r\n}\r\n\r\ntype UOMContext = 'stock_opname' | 'recipe' | 'purchase'\r\n\r\nexport const UnitsTab: React.FC<UnitsTabProps> = ({ product, uoms, onProductChange, onDeleteUOM }) => {\r\n    const [showAddModal, setShowAddModal] = useState(false)\r\n    const [newUOM, setNewUOM] = useState({ uom_name: '', uom_code: '', conversion_factor: 1 })\r\n    const [saving, setSaving] = useState(false)\r\n\r\n    // Cast uoms to extended type for UI fields that may not exist yet in DB\r\n    const extendedUoms = uoms as ExtendedUOM[]\r\n\r\n    // Get currently selected unit for each context\r\n    const getContextUnit = (context: UOMContext): ExtendedUOM | null => {\r\n        return extendedUoms.find(u => {\r\n            if (context === 'stock_opname') return u.is_stock_opname_unit\r\n            if (context === 'recipe') return u.is_consumption_unit\r\n            if (context === 'purchase') return u.is_purchase_uom\r\n            return false\r\n        }) || null\r\n    }\r\n\r\n    // Set preferred unit for a context\r\n    const setContextUnit = async (context: UOMContext, uomId: string | null) => {\r\n        setSaving(true)\r\n        try {\r\n            // First, unset all units for this context\r\n            const field = context === 'stock_opname' ? 'is_stock_opname_unit'\r\n                : context === 'recipe' ? 'is_consumption_unit'\r\n                    : 'is_purchase_uom'\r\n\r\n            // Unset all\r\n            await supabase\r\n                .from('product_uoms')\r\n                .update({ [field]: false })\r\n                .eq('product_id', product.id)\r\n\r\n            // Set the selected one\r\n            if (uomId) {\r\n                await supabase\r\n                    .from('product_uoms')\r\n                    .update({ [field]: true })\r\n                    .eq('id', uomId)\r\n            }\r\n\r\n            // Refresh - this would need to be passed from parent\r\n            window.location.reload()\r\n        } catch (error) {\r\n            console.error('Error setting context unit:', error)\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    const handleAddUOM = async () => {\r\n        if (!newUOM.uom_name || newUOM.conversion_factor <= 0) return\r\n        setSaving(true)\r\n        try {\r\n            const { error } = await supabase\r\n                .from('product_uoms')\r\n                .insert({\r\n                    product_id: product.id,\r\n                    uom_name: newUOM.uom_name,\r\n                    uom_code: newUOM.uom_code || newUOM.uom_name.substring(0, 10).toUpperCase(),\r\n                    conversion_factor: newUOM.conversion_factor\r\n                })\r\n\r\n            if (error) throw error\r\n            setShowAddModal(false)\r\n            setNewUOM({ uom_name: '', uom_code: '', conversion_factor: 1 })\r\n            window.location.reload()\r\n        } catch (error: any) {\r\n            alert('Error: ' + error.message)\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    // All available units (base + UOMs) - kept for future use\r\n    const _allUnits = [\r\n        { id: 'base', uom_name: product.unit, conversion_factor: 1, isBase: true },\r\n        ...uoms.map(u => ({ ...u, isBase: false }))\r\n    ]\r\n    void _allUnits // Prevent unused variable warning\r\n\r\n    const contexts = [\r\n        {\r\n            id: 'stock_opname' as UOMContext,\r\n            label: 'Stock Opname',\r\n            description: 'Unit used for inventory counting',\r\n            icon: ClipboardList,\r\n            color: '#3B82F6',\r\n            bgColor: '#EFF6FF'\r\n        },\r\n        {\r\n            id: 'recipe' as UOMContext,\r\n            label: 'Recipes',\r\n            description: 'Unit used in production recipes',\r\n            icon: Scale,\r\n            color: '#F59E0B',\r\n            bgColor: '#FFFBEB'\r\n        },\r\n        {\r\n            id: 'purchase' as UOMContext,\r\n            label: 'Purchases (PO)',\r\n            description: 'Unit used for supplier orders',\r\n            icon: ShoppingCart,\r\n            color: '#10B981',\r\n            bgColor: '#ECFDF5'\r\n        }\r\n    ]\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Base Unit Card */}\r\n            <div className=\"card\">\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                    <div style={{\r\n                        width: '48px',\r\n                        height: '48px',\r\n                        borderRadius: '12px',\r\n                        background: 'linear-gradient(135deg, #BA90A2 0%, #D4A5B5 100%)',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center'\r\n                    }}>\r\n                        <Package size={24} color=\"white\" />\r\n                    </div>\r\n                    <div style={{ flex: 1 }}>\r\n                        <h3 style={{ margin: 0, fontSize: '1rem', fontWeight: 600, color: '#4A3728' }}>\r\n                            Base Unit (Stock)\r\n                        </h3>\r\n                        <p style={{ margin: '0.25rem 0 0 0', fontSize: '0.8125rem', color: '#8B7355' }}>\r\n                            All conversions are done relative to this unit\r\n                        </p>\r\n                    </div>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                        <input\r\n                            value={product.unit ?? ''}\r\n                            onChange={e => onProductChange({ ...product, unit: e.target.value })}\r\n                            style={{\r\n                                width: '100px',\r\n                                padding: '0.75rem',\r\n                                border: '2px solid #BA90A2',\r\n                                borderRadius: '0.5rem',\r\n                                textAlign: 'center',\r\n                                fontWeight: 700,\r\n                                fontSize: '1rem'\r\n                            }}\r\n                            title=\"Base unit\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* UOM List Card */}\r\n            <div className=\"card\">\r\n                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem' }}>\r\n                    <div>\r\n                        <h3 className=\"card-title\" style={{ marginBottom: '0.25rem' }}>Alternative Units</h3>\r\n                        <p style={{ margin: 0, fontSize: '0.8125rem', color: '#8B7355' }}>\r\n                            Define purchase or consumption units\r\n                        </p>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => setShowAddModal(true)}\r\n                        style={{\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            gap: '0.5rem',\r\n                            padding: '0.625rem 1rem',\r\n                            background: 'linear-gradient(135deg, #BA90A2 0%, #D4A5B5 100%)',\r\n                            color: 'white',\r\n                            border: 'none',\r\n                            borderRadius: '0.5rem',\r\n                            fontWeight: 600,\r\n                            cursor: 'pointer'\r\n                        }}\r\n                    >\r\n                        <Plus size={18} /> New Unit\r\n                    </button>\r\n                </div>\r\n\r\n                {uoms.length === 0 ? (\r\n                    <div style={{\r\n                        textAlign: 'center',\r\n                        padding: '2rem',\r\n                        background: '#F9FAFB',\r\n                        borderRadius: '0.75rem',\r\n                        border: '2px dashed #E5E7EB'\r\n                    }}>\r\n                        <Package size={40} style={{ color: '#D1D5DB', margin: '0 auto 0.75rem' }} />\r\n                        <p style={{ margin: 0, color: '#6B7280' }}>No alternative unit</p>\r\n                        <p style={{ margin: '0.25rem 0 0 0', fontSize: '0.8125rem', color: '#9CA3AF' }}>\r\n                            Add units like \"Bag 5kg\", \"Box\", etc.\r\n                        </p>\r\n                    </div>\r\n                ) : (\r\n                    <div style={{ display: 'grid', gap: '0.75rem' }}>\r\n                        {extendedUoms.map(uom => (\r\n                            <div\r\n                                key={uom.id}\r\n                                style={{\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    gap: '1rem',\r\n                                    padding: '1rem',\r\n                                    background: '#F9FAFB',\r\n                                    borderRadius: '0.75rem',\r\n                                    border: '1px solid #E5E7EB'\r\n                                }}\r\n                            >\r\n                                <div style={{\r\n                                    width: '40px',\r\n                                    height: '40px',\r\n                                    borderRadius: '8px',\r\n                                    background: '#E5E7EB',\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    justifyContent: 'center',\r\n                                    fontWeight: 700,\r\n                                    color: '#4B5563',\r\n                                    fontSize: '0.75rem'\r\n                                }}>\r\n                                    {uom.uom_name.substring(0, 3).toUpperCase()}\r\n                                </div>\r\n                                <div style={{ flex: 1 }}>\r\n                                    <div style={{ fontWeight: 600, color: '#1F2937' }}>{uom.uom_name}</div>\r\n                                    <div style={{ fontSize: '0.8125rem', color: '#6B7280' }}>\r\n                                        1 {uom.uom_name} = <strong>{uom.conversion_factor}</strong> {product.unit}\r\n                                    </div>\r\n                                </div>\r\n                                <div style={{ display: 'flex', gap: '0.375rem' }}>\r\n                                    {uom.is_stock_opname_unit && (\r\n                                        <span style={{ padding: '0.25rem 0.5rem', background: '#DBEAFE', color: '#1D4ED8', borderRadius: '0.25rem', fontSize: '0.625rem', fontWeight: 600 }}>STOCK</span>\r\n                                    )}\r\n                                    {uom.is_consumption_unit && (\r\n                                        <span style={{ padding: '0.25rem 0.5rem', background: '#FEF3C7', color: '#B45309', borderRadius: '0.25rem', fontSize: '0.625rem', fontWeight: 600 }}>RECIPE</span>\r\n                                    )}\r\n                                    {uom.is_purchase_uom && (\r\n                                        <span style={{ padding: '0.25rem 0.5rem', background: '#D1FAE5', color: '#047857', borderRadius: '0.25rem', fontSize: '0.625rem', fontWeight: 600 }}>PURCHASE</span>\r\n                                    )}\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => onDeleteUOM(uom.id)}\r\n                                    style={{\r\n                                        padding: '0.5rem',\r\n                                        background: 'transparent',\r\n                                        border: 'none',\r\n                                        color: '#EF4444',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '0.375rem'\r\n                                    }}\r\n                                    title=\"Delete\"\r\n                                >\r\n                                    <Trash2 size={18} />\r\n                                </button>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Context Preferences Card */}\r\n            <div className=\"card\">\r\n                <h3 className=\"card-title\" style={{ marginBottom: '0.5rem' }}>Unités par Contexte</h3>\r\n                <p style={{ margin: '0 0 1.5rem 0', fontSize: '0.8125rem', color: '#8B7355' }}>\r\n                    Choisissez l'unité à utiliser dans chaque contexte de l'application\r\n                </p>\r\n\r\n                <div style={{ display: 'grid', gap: '1rem' }}>\r\n                    {contexts.map(ctx => {\r\n                        const Icon = ctx.icon\r\n                        const currentUnit = getContextUnit(ctx.id)\r\n\r\n                        return (\r\n                            <div\r\n                                key={ctx.id}\r\n                                style={{\r\n                                    padding: '1.25rem',\r\n                                    background: ctx.bgColor,\r\n                                    borderRadius: '0.75rem',\r\n                                    border: `1px solid ${ctx.color}20`\r\n                                }}\r\n                            >\r\n                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '1rem' }}>\r\n                                    <div style={{\r\n                                        width: '40px',\r\n                                        height: '40px',\r\n                                        borderRadius: '10px',\r\n                                        background: 'white',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center',\r\n                                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'\r\n                                    }}>\r\n                                        <Icon size={20} style={{ color: ctx.color }} />\r\n                                    </div>\r\n                                    <div style={{ flex: 1 }}>\r\n                                        <h4 style={{ margin: 0, fontSize: '0.9375rem', fontWeight: 600, color: '#1F2937' }}>\r\n                                            {ctx.label}\r\n                                        </h4>\r\n                                        <p style={{ margin: '0.25rem 0 0.75rem 0', fontSize: '0.75rem', color: '#6B7280' }}>\r\n                                            {ctx.description}\r\n                                        </p>\r\n                                        <select\r\n                                            value={currentUnit?.id || 'base'}\r\n                                            onChange={(e) => setContextUnit(ctx.id, e.target.value === 'base' ? null : e.target.value)}\r\n                                            disabled={saving}\r\n                                            style={{\r\n                                                width: '100%',\r\n                                                padding: '0.625rem 1rem',\r\n                                                border: '2px solid #E5E7EB',\r\n                                                borderRadius: '0.5rem',\r\n                                                background: 'white',\r\n                                                fontWeight: 500,\r\n                                                fontSize: '0.875rem',\r\n                                                cursor: 'pointer'\r\n                                            }}\r\n                                        >\r\n                                            <option value=\"base\">{product.unit} (Base unit)</option>\r\n                                            {uoms.map(uom => (\r\n                                                <option key={uom.id} value={uom.id}>\r\n                                                    {uom.uom_name} (1 = {uom.conversion_factor} {product.unit})\r\n                                                </option>\r\n                                            ))}\r\n                                        </select>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )\r\n                    })}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Add UOM Modal */}\r\n            {showAddModal && (\r\n                <div style={{\r\n                    position: 'fixed',\r\n                    inset: 0,\r\n                    background: 'rgba(0,0,0,0.5)',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    zIndex: 9999\r\n                }} onClick={() => setShowAddModal(false)}>\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '1rem',\r\n                        padding: '1.5rem',\r\n                        width: '400px',\r\n                        maxWidth: '90vw'\r\n                    }} onClick={e => e.stopPropagation()}>\r\n                        <h3 style={{ margin: '0 0 1.5rem 0', fontSize: '1.125rem', fontWeight: 600 }}>\r\n                            New Unit\r\n                        </h3>\r\n\r\n                        <div style={{ marginBottom: '1rem' }}>\r\n                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.875rem' }}>\r\n                                Unit name\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={newUOM.uom_name}\r\n                                onChange={e => setNewUOM({ ...newUOM, uom_name: e.target.value })}\r\n                                placeholder=\"Ex: Bag 5kg, Box, Pack\"\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '0.75rem',\r\n                                    border: '2px solid #E5E7EB',\r\n                                    borderRadius: '0.5rem',\r\n                                    fontSize: '1rem'\r\n                                }}\r\n                            />\r\n                        </div>\r\n\r\n                        <div style={{ marginBottom: '1.5rem' }}>\r\n                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, fontSize: '0.875rem' }}>\r\n                                Conversion factor\r\n                            </label>\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                                <span style={{ color: '#6B7280' }}>1 {newUOM.uom_name || 'unit'} =</span>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    value={newUOM.conversion_factor}\r\n                                    onChange={e => setNewUOM({ ...newUOM, conversion_factor: parseFloat(e.target.value) || 0 })}\r\n                                    step=\"0.01\"\r\n                                    min=\"0.01\"\r\n                                    style={{\r\n                                        width: '100px',\r\n                                        padding: '0.75rem',\r\n                                        border: '2px solid #E5E7EB',\r\n                                        borderRadius: '0.5rem',\r\n                                        fontSize: '1rem',\r\n                                        textAlign: 'center'\r\n                                    }}\r\n                                />\r\n                                <span style={{ fontWeight: 600 }}>{product.unit}</span>\r\n                            </div>\r\n                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.75rem', color: '#9CA3AF' }}>\r\n                                Ex: If 1 Bag = 5000g, enter 5000\r\n                            </p>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'flex', gap: '0.75rem' }}>\r\n                            <button\r\n                                onClick={() => setShowAddModal(false)}\r\n                                style={{\r\n                                    flex: 1,\r\n                                    padding: '0.75rem',\r\n                                    border: '1px solid #E5E7EB',\r\n                                    borderRadius: '0.5rem',\r\n                                    background: 'white',\r\n                                    fontWeight: 500,\r\n                                    cursor: 'pointer'\r\n                                }}\r\n                            >\r\n                                Cancel\r\n                            </button>\r\n                            <button\r\n                                onClick={handleAddUOM}\r\n                                disabled={saving || !newUOM.uom_name}\r\n                                style={{\r\n                                    flex: 1,\r\n                                    padding: '0.75rem',\r\n                                    border: 'none',\r\n                                    borderRadius: '0.5rem',\r\n                                    background: 'linear-gradient(135deg, #BA90A2 0%, #D4A5B5 100%)',\r\n                                    color: 'white',\r\n                                    fontWeight: 600,\r\n                                    cursor: 'pointer',\r\n                                    opacity: saving || !newUOM.uom_name ? 0.5 : 1\r\n                                }}\r\n                            >\r\n                                {saving ? 'Saving...' : 'Add'}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\inventory\\tabs\\VariantsTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3038,3041],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3038,3041],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":225,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":225,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7794,7797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7794,7797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { Plus, X, Trash2 } from 'lucide-react'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { toast } from 'sonner'\r\n\r\ninterface VariantMaterial {\r\n    material_id: string\r\n    quantity: number\r\n}\r\n\r\ninterface VariantGroup {\r\n    group_name: string\r\n    group_type: 'single' | 'multiple'\r\n    group_required: boolean\r\n    group_sort_order: number\r\n    options: VariantOption[]\r\n}\r\n\r\ninterface VariantOption {\r\n    id?: string\r\n    option_id: string\r\n    option_label: string\r\n    price_adjustment: number\r\n    is_default: boolean\r\n    option_sort_order: number\r\n    is_active: boolean\r\n    materials: VariantMaterial[]\r\n}\r\n\r\ninterface VariantsTabProps {\r\n    productId: string\r\n}\r\n\r\nexport const VariantsTab: React.FC<VariantsTabProps> = ({ productId }) => {\r\n    const [variantGroups, setVariantGroups] = useState<VariantGroup[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [newGroupName, setNewGroupName] = useState('')\r\n    const [newGroupType, setNewGroupType] = useState<'single' | 'multiple'>('single')\r\n    const [newGroupRequired, setNewGroupRequired] = useState(false)\r\n    const [showAddGroup, setShowAddGroup] = useState(false)\r\n    const [availableProducts, setAvailableProducts] = useState<Array<{ id: string; name: string; sku: string; unit: string | null }>>([])\r\n\r\n    useEffect(() => {\r\n        loadVariants()\r\n        loadAvailableProducts()\r\n    }, [productId])\r\n\r\n    async function loadAvailableProducts() {\r\n        try {\r\n            const { data, error} = await supabase\r\n                .from('products')\r\n                .select('id, name, sku, unit')\r\n                .order('name')\r\n\r\n            if (error) throw error\r\n            setAvailableProducts(data || [])\r\n        } catch (error) {\r\n            console.error('Error loading products:', error)\r\n        }\r\n    }\r\n\r\n    async function loadVariants() {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('product_modifiers')\r\n                .select('*')\r\n                .eq('product_id', productId)\r\n                .order('group_sort_order', { ascending: true })\r\n                .order('option_sort_order', { ascending: true })\r\n\r\n            if (error) throw error\r\n\r\n            // Group by group_name\r\n            const groups: Record<string, VariantGroup> = {}\r\n\r\n            data?.forEach(mod => {\r\n                if (!groups[mod.group_name]) {\r\n                    groups[mod.group_name] = {\r\n                        group_name: mod.group_name,\r\n                        group_type: mod.group_type || 'single',\r\n                        group_required: mod.group_required || false,\r\n                        group_sort_order: mod.group_sort_order || 0,\r\n                        options: []\r\n                    }\r\n                }\r\n\r\n                // Parse materials from JSONB\r\n                const materials: VariantMaterial[] = mod.materials && Array.isArray(mod.materials)\r\n                    ? mod.materials.map((m: any) => ({\r\n                        material_id: m.material_id,\r\n                        quantity: m.quantity || 0\r\n                    }))\r\n                    : []\r\n\r\n                groups[mod.group_name].options.push({\r\n                    id: mod.id,\r\n                    option_id: mod.option_id,\r\n                    option_label: mod.option_label,\r\n                    price_adjustment: mod.price_adjustment || 0,\r\n                    is_default: mod.is_default || false,\r\n                    option_sort_order: mod.option_sort_order || 0,\r\n                    is_active: mod.is_active !== false,\r\n                    materials\r\n                })\r\n            })\r\n\r\n            setVariantGroups(Object.values(groups))\r\n        } catch (error) {\r\n            console.error('Error loading variants:', error)\r\n            toast.error('Erreur lors du chargement des variants')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    async function handleAddGroup() {\r\n        if (!newGroupName.trim()) {\r\n            toast.error('Nom de catégorie requis')\r\n            return\r\n        }\r\n\r\n        try {\r\n            const { error } = await supabase\r\n                .from('product_modifiers')\r\n                .insert({\r\n                    product_id: productId,\r\n                    group_name: newGroupName,\r\n                    group_type: newGroupType,\r\n                    group_required: newGroupRequired,\r\n                    group_sort_order: variantGroups.length,\r\n                    option_id: `opt_${Date.now()}`,\r\n                    option_label: 'Option 1',\r\n                    price_adjustment: 0,\r\n                    is_default: true,\r\n                    option_sort_order: 0,\r\n                    is_active: true,\r\n                    materials: []\r\n                })\r\n\r\n            if (error) throw error\r\n\r\n            toast.success('Catégorie ajoutée')\r\n            setNewGroupName('')\r\n            setNewGroupType('single')\r\n            setNewGroupRequired(false)\r\n            setShowAddGroup(false)\r\n            loadVariants()\r\n        } catch (error) {\r\n            console.error('Error adding variant group:', error)\r\n            toast.error('Erreur lors de l\\'ajout de la catégorie')\r\n        }\r\n    }\r\n\r\n    async function handleAddOption(groupName: string) {\r\n        const group = variantGroups.find(g => g.group_name === groupName)\r\n        if (!group) return\r\n\r\n        try {\r\n            const { error } = await supabase\r\n                .from('product_modifiers')\r\n                .insert({\r\n                    product_id: productId,\r\n                    group_name: groupName,\r\n                    group_type: group.group_type,\r\n                    group_required: group.group_required,\r\n                    group_sort_order: group.group_sort_order,\r\n                    option_id: `opt_${Date.now()}`,\r\n                    option_label: `Option ${group.options.length + 1}`,\r\n                    price_adjustment: 0,\r\n                    is_default: false,\r\n                    option_sort_order: group.options.length,\r\n                    is_active: true,\r\n                    materials: []\r\n                })\r\n\r\n            if (error) throw error\r\n\r\n            toast.success('Option ajoutée')\r\n            loadVariants()\r\n        } catch (error) {\r\n            console.error('Error adding option:', error)\r\n            toast.error('Erreur lors de l\\'ajout de l\\'option')\r\n        }\r\n    }\r\n\r\n    async function handleDeleteOption(optionId: string) {\r\n        if (!confirm('Supprimer cette option ?')) return\r\n\r\n        try {\r\n            const { error } = await supabase\r\n                .from('product_modifiers')\r\n                .delete()\r\n                .eq('id', optionId)\r\n\r\n            if (error) throw error\r\n\r\n            toast.success('Option supprimée')\r\n            loadVariants()\r\n        } catch (error) {\r\n            console.error('Error deleting option:', error)\r\n            toast.error('Erreur lors de la suppression')\r\n        }\r\n    }\r\n\r\n    async function handleDeleteGroup(groupName: string) {\r\n        if (!confirm('Supprimer toute la catégorie et ses options ?')) return\r\n\r\n        try {\r\n            const { error } = await supabase\r\n                .from('product_modifiers')\r\n                .delete()\r\n                .eq('product_id', productId)\r\n                .eq('group_name', groupName)\r\n\r\n            if (error) throw error\r\n\r\n            toast.success('Catégorie supprimée')\r\n            loadVariants()\r\n        } catch (error) {\r\n            console.error('Error deleting group:', error)\r\n            toast.error('Erreur lors de la suppression')\r\n        }\r\n    }\r\n\r\n    async function handleUpdateOption(optionId: string, field: string, value: any) {\r\n        // Update local state immediately for responsive UI\r\n        setVariantGroups(prevGroups => {\r\n            return prevGroups.map(group => ({\r\n                ...group,\r\n                options: group.options.map(opt =>\r\n                    opt.id === optionId ? { ...opt, [field]: value } : opt\r\n                )\r\n            }))\r\n        })\r\n\r\n        // Then update database\r\n        try {\r\n            const { error } = await supabase\r\n                .from('product_modifiers')\r\n                .update({ [field]: value })\r\n                .eq('id', optionId)\r\n\r\n            if (error) throw error\r\n        } catch (error) {\r\n            console.error('Error updating option:', error)\r\n            toast.error('Erreur lors de la mise à jour')\r\n            // Reload to get correct state on error\r\n            loadVariants()\r\n        }\r\n    }\r\n\r\n    function handleAddMaterial(groupName: string, optionId: string) {\r\n        const newGroups = [...variantGroups]\r\n        const groupIndex = newGroups.findIndex(g => g.group_name === groupName)\r\n        const optionIndex = newGroups[groupIndex].options.findIndex(o => o.id === optionId)\r\n\r\n        newGroups[groupIndex].options[optionIndex].materials.push({\r\n            material_id: '',\r\n            quantity: 0\r\n        })\r\n\r\n        setVariantGroups(newGroups)\r\n    }\r\n\r\n    function handleRemoveMaterial(groupName: string, optionId: string, materialIndex: number) {\r\n        const newGroups = [...variantGroups]\r\n        const groupIndex = newGroups.findIndex(g => g.group_name === groupName)\r\n        const optionIndex = newGroups[groupIndex].options.findIndex(o => o.id === optionId)\r\n\r\n        newGroups[groupIndex].options[optionIndex].materials.splice(materialIndex, 1)\r\n\r\n        setVariantGroups(newGroups)\r\n\r\n        // Update in database\r\n        const option = newGroups[groupIndex].options[optionIndex]\r\n        handleUpdateOption(option.id!, 'materials', option.materials)\r\n    }\r\n\r\n    function handleUpdateMaterial(groupName: string, optionId: string, materialIndex: number, field: 'material_id' | 'quantity', value: string | number) {\r\n        const newGroups = [...variantGroups]\r\n        const groupIndex = newGroups.findIndex(g => g.group_name === groupName)\r\n        const optionIndex = newGroups[groupIndex].options.findIndex(o => o.id === optionId)\r\n\r\n        const materials = [...newGroups[groupIndex].options[optionIndex].materials]\r\n        materials[materialIndex] = {\r\n            ...materials[materialIndex],\r\n            [field]: value\r\n        }\r\n        newGroups[groupIndex].options[optionIndex].materials = materials\r\n\r\n        setVariantGroups(newGroups)\r\n\r\n        // Update in database\r\n        const option = newGroups[groupIndex].options[optionIndex]\r\n        handleUpdateOption(option.id!, 'materials', option.materials)\r\n    }\r\n\r\n    if (loading) {\r\n        return <div style={{ padding: '2rem', textAlign: 'center' }}>Chargement...</div>\r\n    }\r\n\r\n    return (\r\n        <div style={{ padding: '1.5rem' }}>\r\n            <div style={{ marginBottom: '2rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                <div>\r\n                    <h2 style={{ margin: 0, fontSize: '1.25rem', fontWeight: 600 }}>Variants du produit</h2>\r\n                    <p style={{ margin: '0.5rem 0 0', color: '#6B7280', fontSize: '0.875rem' }}>\r\n                        Créez des catégories de variants avec plusieurs ingrédients par option\r\n                    </p>\r\n                </div>\r\n                <button\r\n                    onClick={() => setShowAddGroup(true)}\r\n                    style={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        gap: '0.5rem',\r\n                        padding: '0.75rem 1.25rem',\r\n                        background: '#3B82F6',\r\n                        color: 'white',\r\n                        border: 'none',\r\n                        borderRadius: '8px',\r\n                        cursor: 'pointer',\r\n                        fontWeight: 500\r\n                    }}\r\n                >\r\n                    <Plus size={18} />\r\n                    Nouvelle catégorie\r\n                </button>\r\n            </div>\r\n\r\n            {/* Add Group Modal */}\r\n            {showAddGroup && (\r\n                <div style={{\r\n                    position: 'fixed',\r\n                    inset: 0,\r\n                    background: 'rgba(0,0,0,0.5)',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    zIndex: 1000\r\n                }}>\r\n                    <div style={{\r\n                        background: 'white',\r\n                        borderRadius: '12px',\r\n                        padding: '2rem',\r\n                        width: '90%',\r\n                        maxWidth: '500px'\r\n                    }}>\r\n                        <h3 style={{ margin: '0 0 1.5rem', fontSize: '1.125rem', fontWeight: 600 }}>\r\n                            Nouvelle catégorie de variants\r\n                        </h3>\r\n\r\n                        <div style={{ marginBottom: '1rem' }}>\r\n                            <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: 500 }}>\r\n                                Nom de la catégorie *\r\n                            </label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={newGroupName}\r\n                                onChange={(e) => setNewGroupName(e.target.value)}\r\n                                placeholder=\"Ex: Lait, Taille, Topping...\"\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '0.75rem',\r\n                                    border: '1px solid #D1D5DB',\r\n                                    borderRadius: '6px',\r\n                                    fontSize: '0.875rem'\r\n                                }}\r\n                            />\r\n                        </div>\r\n\r\n                        <div style={{ marginBottom: '1rem' }}>\r\n                            <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: 500 }}>\r\n                                Type de sélection\r\n                            </label>\r\n                            <select\r\n                                value={newGroupType}\r\n                                onChange={(e) => setNewGroupType(e.target.value as 'single' | 'multiple')}\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '0.75rem',\r\n                                    border: '1px solid #D1D5DB',\r\n                                    borderRadius: '6px',\r\n                                    fontSize: '0.875rem'\r\n                                }}\r\n                            >\r\n                                <option value=\"single\">Choix unique</option>\r\n                                <option value=\"multiple\">Choix multiple</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div style={{ marginBottom: '1.5rem' }}>\r\n                            <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>\r\n                                <input\r\n                                    type=\"checkbox\"\r\n                                    checked={newGroupRequired}\r\n                                    onChange={(e) => setNewGroupRequired(e.target.checked)}\r\n                                />\r\n                                <span style={{ fontSize: '0.875rem' }}>Obligatoire</span>\r\n                            </label>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>\r\n                            <button\r\n                                onClick={() => {\r\n                                    setShowAddGroup(false)\r\n                                    setNewGroupName('')\r\n                                    setNewGroupType('single')\r\n                                    setNewGroupRequired(false)\r\n                                }}\r\n                                style={{\r\n                                    padding: '0.75rem 1.25rem',\r\n                                    background: '#F3F4F6',\r\n                                    border: 'none',\r\n                                    borderRadius: '6px',\r\n                                    cursor: 'pointer',\r\n                                    fontSize: '0.875rem',\r\n                                    fontWeight: 500\r\n                                }}\r\n                            >\r\n                                Annuler\r\n                            </button>\r\n                            <button\r\n                                onClick={handleAddGroup}\r\n                                style={{\r\n                                    padding: '0.75rem 1.25rem',\r\n                                    background: '#3B82F6',\r\n                                    color: 'white',\r\n                                    border: 'none',\r\n                                    borderRadius: '6px',\r\n                                    cursor: 'pointer',\r\n                                    fontSize: '0.875rem',\r\n                                    fontWeight: 500\r\n                                }}\r\n                            >\r\n                                Créer\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Variant Groups List */}\r\n            {variantGroups.length === 0 ? (\r\n                <div style={{\r\n                    padding: '3rem',\r\n                    textAlign: 'center',\r\n                    background: '#F9FAFB',\r\n                    borderRadius: '8px',\r\n                    border: '1px dashed #D1D5DB'\r\n                }}>\r\n                    <p style={{ color: '#6B7280', marginBottom: '1rem' }}>\r\n                        Aucune catégorie de variant définie\r\n                    </p>\r\n                    <p style={{ color: '#9CA3AF', fontSize: '0.875rem' }}>\r\n                        Cliquez sur \"Nouvelle catégorie\" pour commencer\r\n                    </p>\r\n                </div>\r\n            ) : (\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                    {variantGroups.map((group) => (\r\n                        <div\r\n                            key={group.group_name}\r\n                            style={{\r\n                                background: 'white',\r\n                                border: '1px solid #E5E7EB',\r\n                                borderRadius: '8px',\r\n                                padding: '1.5rem'\r\n                            }}\r\n                        >\r\n                            {/* Group Header */}\r\n                            <div style={{\r\n                                display: 'flex',\r\n                                justifyContent: 'space-between',\r\n                                alignItems: 'flex-start',\r\n                                marginBottom: '1rem',\r\n                                paddingBottom: '1rem',\r\n                                borderBottom: '1px solid #E5E7EB'\r\n                            }}>\r\n                                <div>\r\n                                    <h3 style={{ margin: 0, fontSize: '1.125rem', fontWeight: 600 }}>\r\n                                        {group.group_name}\r\n                                    </h3>\r\n                                    <div style={{ display: 'flex', gap: '0.75rem', marginTop: '0.5rem' }}>\r\n                                        <span style={{\r\n                                            padding: '0.25rem 0.75rem',\r\n                                            background: '#EFF6FF',\r\n                                            color: '#1E40AF',\r\n                                            fontSize: '0.75rem',\r\n                                            borderRadius: '12px',\r\n                                            fontWeight: 500\r\n                                        }}>\r\n                                            {group.group_type === 'single' ? 'Choix unique' : 'Choix multiple'}\r\n                                        </span>\r\n                                        {group.group_required && (\r\n                                            <span style={{\r\n                                                padding: '0.25rem 0.75rem',\r\n                                                background: '#FEF3C7',\r\n                                                color: '#92400E',\r\n                                                fontSize: '0.75rem',\r\n                                                borderRadius: '12px',\r\n                                                fontWeight: 500\r\n                                            }}>\r\n                                                Obligatoire\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => handleDeleteGroup(group.group_name)}\r\n                                    style={{\r\n                                        padding: '0.5rem',\r\n                                        background: 'transparent',\r\n                                        border: 'none',\r\n                                        color: '#EF4444',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '4px'\r\n                                    }}\r\n                                    title=\"Supprimer la catégorie\"\r\n                                >\r\n                                    <Trash2 size={18} />\r\n                                </button>\r\n                            </div>\r\n\r\n                            {/* Options List */}\r\n                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>\r\n                                {group.options.map((option, optIndex) => (\r\n                                    <div\r\n                                        key={option.id || optIndex}\r\n                                        style={{\r\n                                            background: '#F9FAFB',\r\n                                            padding: '1rem',\r\n                                            borderRadius: '6px',\r\n                                            border: '1px solid #E5E7EB'\r\n                                        }}\r\n                                    >\r\n                                        {/* Option Header */}\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.75rem' }}>\r\n                                            <input\r\n                                                type=\"text\"\r\n                                                value={option.option_label}\r\n                                                onChange={(e) => handleUpdateOption(option.id!, 'option_label', e.target.value)}\r\n                                                style={{\r\n                                                    flex: 1,\r\n                                                    padding: '0.5rem',\r\n                                                    border: '1px solid #D1D5DB',\r\n                                                    borderRadius: '4px',\r\n                                                    fontSize: '0.875rem',\r\n                                                    background: 'white'\r\n                                                }}\r\n                                            />\r\n                                            <input\r\n                                                type=\"number\"\r\n                                                value={option.price_adjustment}\r\n                                                onChange={(e) => handleUpdateOption(option.id!, 'price_adjustment', parseFloat(e.target.value) || 0)}\r\n                                                placeholder=\"Prix\"\r\n                                                style={{\r\n                                                    width: '100px',\r\n                                                    padding: '0.5rem',\r\n                                                    border: '1px solid #D1D5DB',\r\n                                                    borderRadius: '4px',\r\n                                                    fontSize: '0.875rem',\r\n                                                    background: 'white'\r\n                                                }}\r\n                                            />\r\n                                            <label style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', fontSize: '0.75rem' }}>\r\n                                                <input\r\n                                                    type=\"checkbox\"\r\n                                                    checked={option.is_default}\r\n                                                    onChange={(e) => handleUpdateOption(option.id!, 'is_default', e.target.checked)}\r\n                                                />\r\n                                                Défaut\r\n                                            </label>\r\n                                            <button\r\n                                                onClick={() => handleDeleteOption(option.id!)}\r\n                                                style={{\r\n                                                    padding: '0.5rem',\r\n                                                    background: 'transparent',\r\n                                                    border: 'none',\r\n                                                    color: '#EF4444',\r\n                                                    cursor: 'pointer'\r\n                                                }}\r\n                                                title=\"Supprimer l'option\"\r\n                                            >\r\n                                                <Trash2 size={16} />\r\n                                            </button>\r\n                                        </div>\r\n\r\n                                        {/* Materials Section */}\r\n                                        <div style={{\r\n                                            marginTop: '0.75rem',\r\n                                            paddingTop: '0.75rem',\r\n                                            borderTop: '1px solid #E5E7EB'\r\n                                        }}>\r\n                                            <div style={{\r\n                                                display: 'flex',\r\n                                                justifyContent: 'space-between',\r\n                                                alignItems: 'center',\r\n                                                marginBottom: '0.5rem'\r\n                                            }}>\r\n                                                <span style={{ fontSize: '0.75rem', fontWeight: 600, color: '#6B7280' }}>\r\n                                                    Ingrédients à déduire\r\n                                                </span>\r\n                                                <button\r\n                                                    onClick={() => handleAddMaterial(group.group_name, option.id!)}\r\n                                                    style={{\r\n                                                        display: 'flex',\r\n                                                        alignItems: 'center',\r\n                                                        gap: '0.25rem',\r\n                                                        padding: '0.25rem 0.5rem',\r\n                                                        background: '#3B82F6',\r\n                                                        color: 'white',\r\n                                                        border: 'none',\r\n                                                        borderRadius: '4px',\r\n                                                        cursor: 'pointer',\r\n                                                        fontSize: '0.75rem',\r\n                                                        fontWeight: 500\r\n                                                    }}\r\n                                                >\r\n                                                    <Plus size={14} />\r\n                                                    Ajouter\r\n                                                </button>\r\n                                            </div>\r\n\r\n                                            {/* Materials List */}\r\n                                            {option.materials.length === 0 ? (\r\n                                                <p style={{\r\n                                                    fontSize: '0.75rem',\r\n                                                    color: '#9CA3AF',\r\n                                                    fontStyle: 'italic',\r\n                                                    margin: '0.5rem 0'\r\n                                                }}>\r\n                                                    Aucun ingrédient configuré\r\n                                                </p>\r\n                                            ) : (\r\n                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>\r\n                                                    {option.materials.map((material, matIndex) => {\r\n                                                        const selectedProduct = availableProducts.find(p => p.id === material.material_id)\r\n                                                        return (\r\n                                                            <div\r\n                                                                key={matIndex}\r\n                                                                style={{\r\n                                                                    display: 'flex',\r\n                                                                    alignItems: 'center',\r\n                                                                    gap: '0.5rem',\r\n                                                                    background: 'white',\r\n                                                                    padding: '0.5rem',\r\n                                                                    borderRadius: '4px',\r\n                                                                    border: '1px solid #E5E7EB'\r\n                                                                }}\r\n                                                            >\r\n                                                                <select\r\n                                                                    value={material.material_id}\r\n                                                                    onChange={(e) => handleUpdateMaterial(\r\n                                                                        group.group_name,\r\n                                                                        option.id!,\r\n                                                                        matIndex,\r\n                                                                        'material_id',\r\n                                                                        e.target.value\r\n                                                                    )}\r\n                                                                    style={{\r\n                                                                        flex: 1,\r\n                                                                        padding: '0.375rem',\r\n                                                                        border: '1px solid #D1D5DB',\r\n                                                                        borderRadius: '4px',\r\n                                                                        fontSize: '0.75rem'\r\n                                                                    }}\r\n                                                                >\r\n                                                                    <option value=\"\">Sélectionner un produit...</option>\r\n                                                                    {availableProducts.map(prod => (\r\n                                                                        <option key={prod.id} value={prod.id}>\r\n                                                                            {prod.name} ({prod.sku})\r\n                                                                        </option>\r\n                                                                    ))}\r\n                                                                </select>\r\n\r\n                                                                <input\r\n                                                                    type=\"number\"\r\n                                                                    value={material.quantity}\r\n                                                                    onChange={(e) => handleUpdateMaterial(\r\n                                                                        group.group_name,\r\n                                                                        option.id!,\r\n                                                                        matIndex,\r\n                                                                        'quantity',\r\n                                                                        parseFloat(e.target.value) || 0\r\n                                                                    )}\r\n                                                                    placeholder=\"Qté\"\r\n                                                                    disabled={!material.material_id}\r\n                                                                    style={{\r\n                                                                        width: '80px',\r\n                                                                        padding: '0.375rem',\r\n                                                                        border: '1px solid #D1D5DB',\r\n                                                                        borderRadius: '4px',\r\n                                                                        fontSize: '0.75rem',\r\n                                                                        background: material.material_id ? 'white' : '#F3F4F6'\r\n                                                                    }}\r\n                                                                />\r\n\r\n                                                                {selectedProduct && (\r\n                                                                    <span style={{\r\n                                                                        fontSize: '0.75rem',\r\n                                                                        color: '#6B7280',\r\n                                                                        minWidth: '40px'\r\n                                                                    }}>\r\n                                                                        {selectedProduct.unit}\r\n                                                                    </span>\r\n                                                                )}\r\n\r\n                                                                <button\r\n                                                                    onClick={() => handleRemoveMaterial(group.group_name, option.id!, matIndex)}\r\n                                                                    style={{\r\n                                                                        padding: '0.25rem',\r\n                                                                        background: 'transparent',\r\n                                                                        border: 'none',\r\n                                                                        color: '#EF4444',\r\n                                                                        cursor: 'pointer'\r\n                                                                    }}\r\n                                                                    title=\"Supprimer l'ingrédient\"\r\n                                                                >\r\n                                                                    <X size={14} />\r\n                                                                </button>\r\n                                                            </div>\r\n                                                        )\r\n                                                    })}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n\r\n                                {/* Add Option Button */}\r\n                                <button\r\n                                    onClick={() => handleAddOption(group.group_name)}\r\n                                    style={{\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center',\r\n                                        gap: '0.5rem',\r\n                                        padding: '0.75rem',\r\n                                        background: 'white',\r\n                                        border: '1px dashed #D1D5DB',\r\n                                        borderRadius: '6px',\r\n                                        cursor: 'pointer',\r\n                                        color: '#6B7280',\r\n                                        fontSize: '0.875rem',\r\n                                        fontWeight: 500\r\n                                    }}\r\n                                >\r\n                                    <Plus size={16} />\r\n                                    Ajouter une option\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\kds\\KDSMainPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\kds\\KDSStationSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\mobile\\MobileCartPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\mobile\\MobileCatalogPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\mobile\\MobileHomePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\mobile\\MobileLoginPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\mobile\\MobileOrdersPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\mobile\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\orders\\OrdersPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1042,1045],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1042,1045],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useEffect, useCallback, useRef } from 'react';\r\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\r\nimport { toast } from 'sonner';\r\nimport {\r\n    Search, Download, ChevronLeft, ChevronRight, Check, Clock,\r\n    RefreshCw, X, ShoppingBag, User, Hash, CreditCard, Banknote, QrCode,\r\n    Calendar, Filter, Eye\r\n} from 'lucide-react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { formatCurrency } from '../../utils/helpers';\r\nimport { playOrderReadySound } from '../../utils/audio';\r\nimport { useKdsStatusListener } from '../../hooks/pos/useKdsStatusListener';\r\nimport { useModuleSettings } from '../../hooks/useSettings';\r\nimport { OrderItemStatusBadge, type TItemStatus } from '../../components/orders/OrderItemStatusBadge';\r\nimport type { TKitchenStation } from '../../types/offline';\r\nimport './OrdersPage.css';\r\n\r\ninterface OrderItem {\r\n    id: string;\r\n    product_name: string;\r\n    quantity: number;\r\n    unit_price: number;\r\n    total_price: number;\r\n    modifiers: Record<string, any> | null;\r\n    modifiers_total: number;\r\n    item_status: TItemStatus;\r\n    dispatch_station?: string;\r\n}\r\n\r\ninterface Order {\r\n    id: string;\r\n    order_number: string;\r\n    order_type: string;\r\n    table_number: string | null;\r\n    customer_name: string | null;\r\n    status: string;\r\n    payment_status: string;\r\n    subtotal: number;\r\n    discount_amount: number;\r\n    tax_amount: number;\r\n    total: number;\r\n    payment_method: string | null;\r\n    cash_received: number | null;\r\n    change_given: number | null;\r\n    created_at: string;\r\n    completed_at: string | null;\r\n    items: OrderItem[];\r\n}\r\n\r\ntype OrderStatus = 'all' | 'pending' | 'preparing' | 'ready' | 'completed' | 'cancelled';\r\ntype OrderType = 'all' | 'dine_in' | 'takeaway' | 'delivery' | 'b2b';\r\ntype PaymentStatus = 'all' | 'paid' | 'unpaid';\r\n\r\nconst ITEMS_PER_PAGE = 20;\r\n\r\nconst OrdersPage = () => {\r\n    const queryClient = useQueryClient();\r\n    const { data: moduleSettings } = useModuleSettings();\r\n\r\n    const [statusFilter, setStatusFilter] = useState<OrderStatus>('all');\r\n    const [typeFilter, setTypeFilter] = useState<OrderType>('all');\r\n    const [paymentFilter, setPaymentFilter] = useState<PaymentStatus>('all');\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [dateFrom, setDateFrom] = useState(() => {\r\n        const today = new Date();\r\n        today.setHours(0, 0, 0, 0);\r\n        return today.toISOString().split('T')[0];\r\n    });\r\n    const [dateTo, setDateTo] = useState(() => {\r\n        const today = new Date();\r\n        return today.toISOString().split('T')[0];\r\n    });\r\n    const [currentPage, setCurrentPage] = useState(1);\r\n    const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);\r\n\r\n    // Fetch orders from Supabase\r\n    const { data: ordersData, isLoading, refetch, isFetching } = useQuery({\r\n        queryKey: ['orders-backoffice', dateFrom, dateTo],\r\n        queryFn: async () => {\r\n            let query = supabase\r\n                .from('orders')\r\n                .select(`\r\n                    id,\r\n                    order_number,\r\n                    order_type,\r\n                    table_number,\r\n                    customer_name,\r\n                    status,\r\n                    payment_status,\r\n                    subtotal,\r\n                    discount_amount,\r\n                    tax_amount,\r\n                    total,\r\n                    payment_method,\r\n                    cash_received,\r\n                    change_given,\r\n                    created_at,\r\n                    completed_at,\r\n                    order_items (\r\n                        id,\r\n                        product_name,\r\n                        quantity,\r\n                        unit_price,\r\n                        total_price,\r\n                        modifiers,\r\n                        modifiers_total,\r\n                        item_status,\r\n                        dispatch_station\r\n                    )\r\n                `)\r\n                .order('created_at', { ascending: false });\r\n\r\n            // Date filtering\r\n            if (dateFrom) {\r\n                query = query.gte('created_at', `${dateFrom}T00:00:00`);\r\n            }\r\n            if (dateTo) {\r\n                query = query.lte('created_at', `${dateTo}T23:59:59`);\r\n            }\r\n\r\n            const { data, error } = await query.limit(500);\r\n\r\n            if (error) {\r\n                console.error('Error fetching orders:', error);\r\n                return [];\r\n            }\r\n\r\n            // Type for raw Supabase response\r\n            type RawOrderItem = Omit<OrderItem, 'item_status'> & { item_status?: string };\r\n            type RawOrder = Omit<Order, 'items'> & { order_items?: RawOrderItem[] };\r\n\r\n            const rawOrders = data as unknown as RawOrder[];\r\n            return rawOrders.map((order) => ({\r\n                ...order,\r\n                items: (order.order_items || []).map(item => ({\r\n                    ...item,\r\n                    item_status: (item.item_status || 'new') as TItemStatus,\r\n                })),\r\n            })) as Order[];\r\n        },\r\n        refetchInterval: 30000 // Refresh every 30 seconds\r\n    });\r\n\r\n    const orders = ordersData || [];\r\n\r\n    // Real-time subscription for live updates\r\n    useEffect(() => {\r\n        const channel = supabase\r\n            .channel('orders-realtime')\r\n            .on(\r\n                'postgres_changes',\r\n                {\r\n                    event: '*',\r\n                    schema: 'public',\r\n                    table: 'orders'\r\n                },\r\n                () => {\r\n                    // Invalidate and refetch orders on any change\r\n                    queryClient.invalidateQueries({ queryKey: ['orders-backoffice'] });\r\n                }\r\n            )\r\n            .subscribe();\r\n\r\n        return () => {\r\n            supabase.removeChannel(channel);\r\n        };\r\n    }, [queryClient]);\r\n\r\n    // Story 4.7: Track recently updated items for animation\r\n    const recentlyUpdatedItemsRef = useRef<Set<string>>(new Set());\r\n    // Track timeouts for cleanup to prevent memory leaks\r\n    const animationTimeoutsRef = useRef<Set<ReturnType<typeof setTimeout>>>(new Set());\r\n\r\n    // Story 4.7: Update local item status when KDS sends updates via LAN\r\n    const handleItemPreparing = useCallback((_orderId: string, itemIds: string[], _station: TKitchenStation) => {\r\n        // Mark items as recently updated for animation\r\n        itemIds.forEach(id => recentlyUpdatedItemsRef.current.add(id));\r\n\r\n        // Track timeout for cleanup to prevent memory leaks\r\n        const timeoutId = setTimeout(() => {\r\n            itemIds.forEach(id => recentlyUpdatedItemsRef.current.delete(id));\r\n            animationTimeoutsRef.current.delete(timeoutId);\r\n        }, 2000);\r\n        animationTimeoutsRef.current.add(timeoutId);\r\n\r\n        // Invalidate query to refetch with updated statuses\r\n        queryClient.invalidateQueries({ queryKey: ['orders-backoffice'] });\r\n    }, [queryClient]);\r\n\r\n    const handleItemReady = useCallback((orderId: string, itemIds: string[], _station: TKitchenStation, _preparedAt: string) => {\r\n        // Mark items as recently updated for animation\r\n        itemIds.forEach(id => recentlyUpdatedItemsRef.current.add(id));\r\n\r\n        // Track timeout for cleanup to prevent memory leaks\r\n        const timeoutId = setTimeout(() => {\r\n            itemIds.forEach(id => recentlyUpdatedItemsRef.current.delete(id));\r\n            animationTimeoutsRef.current.delete(timeoutId);\r\n        }, 2000);\r\n        animationTimeoutsRef.current.add(timeoutId);\r\n\r\n        // Invalidate query to refetch with updated statuses\r\n        queryClient.invalidateQueries({ queryKey: ['orders-backoffice'] });\r\n\r\n        // Check if all items in order are now ready - show notification\r\n        // Note: Using orders from closure - may be slightly stale but acceptable for notification\r\n        const order = orders.find(o => o.id === orderId);\r\n        if (order) {\r\n            const allItemsReady = order.items.every(item =>\r\n                itemIds.includes(item.id) || item.item_status === 'ready' || item.item_status === 'served'\r\n            );\r\n            if (allItemsReady) {\r\n                // Play notification sound if enabled in settings (AC3)\r\n                const soundEnabled = moduleSettings?.kds?.sound_new_order ?? true;\r\n                if (soundEnabled) {\r\n                    playOrderReadySound();\r\n                }\r\n\r\n                // Show toast notification\r\n                toast.success(`Order #${order.order_number} is ready!`, {\r\n                    duration: 5000,\r\n                    position: 'top-right',\r\n                });\r\n            }\r\n        }\r\n    }, [orders, queryClient, moduleSettings]);\r\n\r\n    // Story 4.7: KDS Status Listener for real-time item updates via LAN\r\n    useKdsStatusListener({\r\n        onItemPreparing: handleItemPreparing,\r\n        onItemReady: handleItemReady,\r\n        enabled: true,\r\n    });\r\n\r\n    // Cleanup animation timeouts on unmount to prevent memory leaks\r\n    useEffect(() => {\r\n        return () => {\r\n            animationTimeoutsRef.current.forEach(timeoutId => clearTimeout(timeoutId));\r\n            animationTimeoutsRef.current.clear();\r\n        };\r\n    }, []);\r\n\r\n    // Filter orders\r\n    const filteredOrders = useMemo(() => {\r\n        return orders.filter(order => {\r\n            if (statusFilter !== 'all' && order.status !== statusFilter) return false;\r\n            if (typeFilter !== 'all' && order.order_type !== typeFilter) return false;\r\n            if (paymentFilter !== 'all' && order.payment_status !== paymentFilter) return false;\r\n            if (searchQuery) {\r\n                const query = searchQuery.toLowerCase();\r\n                const matchesNumber = order.order_number?.toLowerCase().includes(query);\r\n                const matchesCustomer = order.customer_name?.toLowerCase().includes(query);\r\n                const matchesId = order.id.toLowerCase().includes(query);\r\n                if (!matchesNumber && !matchesCustomer && !matchesId) return false;\r\n            }\r\n            return true;\r\n        });\r\n    }, [orders, statusFilter, typeFilter, paymentFilter, searchQuery]);\r\n\r\n    // Pagination\r\n    const totalPages = Math.ceil(filteredOrders.length / ITEMS_PER_PAGE);\r\n    const paginatedOrders = useMemo(() => {\r\n        const start = (currentPage - 1) * ITEMS_PER_PAGE;\r\n        return filteredOrders.slice(start, start + ITEMS_PER_PAGE);\r\n    }, [filteredOrders, currentPage]);\r\n\r\n    // Reset page when filters change\r\n    useEffect(() => {\r\n        setCurrentPage(1);\r\n    }, [statusFilter, typeFilter, paymentFilter, searchQuery, dateFrom, dateTo]);\r\n\r\n    // Stats\r\n    const stats = useMemo(() => {\r\n        const today = filteredOrders;\r\n        return {\r\n            total: today.length,\r\n            totalAmount: today.reduce((sum, o) => sum + o.total, 0),\r\n            paid: today.filter(o => o.payment_status === 'paid').length,\r\n            unpaid: today.filter(o => o.payment_status === 'unpaid' || o.payment_status === 'pending').length,\r\n            paidAmount: today.filter(o => o.payment_status === 'paid').reduce((sum, o) => sum + o.total, 0),\r\n            unpaidAmount: today.filter(o => o.payment_status === 'unpaid' || o.payment_status === 'pending').reduce((sum, o) => sum + o.total, 0)\r\n        };\r\n    }, [filteredOrders]);\r\n\r\n    const formatTime = (dateString: string) => {\r\n        const date = new Date(dateString);\r\n        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });\r\n    };\r\n\r\n    const formatDate = (dateString: string) => {\r\n        const date = new Date(dateString);\r\n        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });\r\n    };\r\n\r\n    const formatFullDate = (dateString: string) => {\r\n        const date = new Date(dateString);\r\n        return date.toLocaleDateString('fr-FR', {\r\n            day: '2-digit',\r\n            month: 'long',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n    };\r\n\r\n    const getOrderTypeLabel = (type: string) => {\r\n        switch (type) {\r\n            case 'dine_in': return 'Sur place';\r\n            case 'takeaway': return 'À emporter';\r\n            case 'delivery': return 'Livraison';\r\n            case 'b2b': return 'B2B';\r\n            default: return type;\r\n        }\r\n    };\r\n\r\n    const getOrderTypeIcon = (type: string) => {\r\n        switch (type) {\r\n            case 'dine_in': return '🍽️';\r\n            case 'takeaway': return '📦';\r\n            case 'delivery': return '🚗';\r\n            case 'b2b': return '🏢';\r\n            default: return '📋';\r\n        }\r\n    };\r\n\r\n    const getStatusLabel = (status: string) => {\r\n        switch (status) {\r\n            case 'pending': return 'En attente';\r\n            case 'preparing': return 'En prépa.';\r\n            case 'ready': return 'Prêt';\r\n            case 'completed': return 'Terminé';\r\n            case 'cancelled': return 'Annulé';\r\n            default: return status;\r\n        }\r\n    };\r\n\r\n    const getPaymentIcon = (method: string | null) => {\r\n        switch (method) {\r\n            case 'cash': return <Banknote size={14} className=\"payment-method-icon payment-method-icon--cash\" />;\r\n            case 'qris': return <QrCode size={14} className=\"payment-method-icon payment-method-icon--qris\" />;\r\n            case 'card':\r\n            case 'edc': return <CreditCard size={14} className=\"payment-method-icon payment-method-icon--card\" />;\r\n            default: return <CreditCard size={14} />;\r\n        }\r\n    };\r\n\r\n    const getPaymentMethodLabel = (method: string | null) => {\r\n        switch (method) {\r\n            case 'cash': return 'Espèces';\r\n            case 'qris': return 'QRIS';\r\n            case 'card': return 'Carte';\r\n            case 'edc': return 'EDC';\r\n            case 'transfer': return 'Virement';\r\n            default: return method || '-';\r\n        }\r\n    };\r\n\r\n    const handleExport = () => {\r\n        // Export filtered orders as CSV\r\n        const headers = ['N° Commande', 'Date', 'Type', 'Client', 'Montant', 'Statut', 'Paiement', 'Méthode'];\r\n        const rows = filteredOrders.map(order => [\r\n            order.order_number,\r\n            formatFullDate(order.created_at),\r\n            getOrderTypeLabel(order.order_type),\r\n            order.customer_name || '-',\r\n            order.total,\r\n            getStatusLabel(order.status),\r\n            order.payment_status === 'paid' ? 'Payé' : 'Impayé',\r\n            getPaymentMethodLabel(order.payment_method)\r\n        ]);\r\n\r\n        const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');\r\n        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\r\n        const url = URL.createObjectURL(blob);\r\n        const link = document.createElement('a');\r\n        link.href = url;\r\n        link.download = `commandes_${dateFrom}_${dateTo}.csv`;\r\n        link.click();\r\n        URL.revokeObjectURL(url);\r\n    };\r\n\r\n    return (\r\n        <div className=\"orders-page\">\r\n            <header className=\"orders-page__header\">\r\n                <h1 className=\"orders-page__title\">Commandes en Direct</h1>\r\n                <div className=\"orders-page__actions\">\r\n                    <button\r\n                        className=\"btn-secondary\"\r\n                        onClick={() => refetch()}\r\n                        disabled={isFetching}\r\n                    >\r\n                        <RefreshCw size={18} className={isFetching ? 'spinning' : ''} />\r\n                        Actualiser\r\n                    </button>\r\n                    <button className=\"btn-secondary\" onClick={handleExport}>\r\n                        <Download size={18} />\r\n                        Exporter\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Stats Summary */}\r\n            <div className=\"orders-stats\">\r\n                <div className=\"orders-stat\">\r\n                    <span className=\"orders-stat__label\">Total commandes</span>\r\n                    <span className=\"orders-stat__value\">{stats.total}</span>\r\n                </div>\r\n                <div className=\"orders-stat\">\r\n                    <span className=\"orders-stat__label\">Montant total</span>\r\n                    <span className=\"orders-stat__value\">{formatCurrency(stats.totalAmount)}</span>\r\n                </div>\r\n                <div className=\"orders-stat orders-stat--success\">\r\n                    <Check size={16} />\r\n                    <span className=\"orders-stat__label\">Payées</span>\r\n                    <span className=\"orders-stat__value\">{stats.paid}</span>\r\n                    <span className=\"orders-stat__amount\">{formatCurrency(stats.paidAmount)}</span>\r\n                </div>\r\n                <div className=\"orders-stat orders-stat--warning\">\r\n                    <Clock size={16} />\r\n                    <span className=\"orders-stat__label\">Impayées</span>\r\n                    <span className=\"orders-stat__value\">{stats.unpaid}</span>\r\n                    <span className=\"orders-stat__amount\">{formatCurrency(stats.unpaidAmount)}</span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <div className=\"orders-filters\">\r\n                <div className=\"filter-group\">\r\n                    <label className=\"filter-group__label\">Rechercher</label>\r\n                    <div className=\"filter-group__search-wrapper\">\r\n                        <input\r\n                            type=\"text\"\r\n                            className=\"filter-group__input filter-group__input--with-icon\"\r\n                            placeholder=\"N° commande, client...\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                        />\r\n                        <Search size={16} className=\"filter-group__input-icon\" />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"filter-group\">\r\n                    <label className=\"filter-group__label\" htmlFor=\"date-from\">\r\n                        <Calendar size={12} /> Date début\r\n                    </label>\r\n                    <input\r\n                        id=\"date-from\"\r\n                        type=\"date\"\r\n                        className=\"filter-group__input\"\r\n                        value={dateFrom}\r\n                        onChange={(e) => setDateFrom(e.target.value)}\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"filter-group\">\r\n                    <label className=\"filter-group__label\" htmlFor=\"date-to\">\r\n                        <Calendar size={12} /> Date fin\r\n                    </label>\r\n                    <input\r\n                        id=\"date-to\"\r\n                        type=\"date\"\r\n                        className=\"filter-group__input\"\r\n                        value={dateTo}\r\n                        onChange={(e) => setDateTo(e.target.value)}\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"filter-group\">\r\n                    <label className=\"filter-group__label\" htmlFor=\"order-type\">\r\n                        <Filter size={12} /> Type\r\n                    </label>\r\n                    <select\r\n                        id=\"order-type\"\r\n                        className=\"filter-group__input\"\r\n                        value={typeFilter}\r\n                        onChange={(e) => setTypeFilter(e.target.value as OrderType)}\r\n                    >\r\n                        <option value=\"all\">Tous</option>\r\n                        <option value=\"dine_in\">Sur place</option>\r\n                        <option value=\"takeaway\">À emporter</option>\r\n                        <option value=\"delivery\">Livraison</option>\r\n                        <option value=\"b2b\">B2B</option>\r\n                    </select>\r\n                </div>\r\n\r\n                <div className=\"filter-group\">\r\n                    <label className=\"filter-group__label\" htmlFor=\"payment-status\">\r\n                        <CreditCard size={12} /> Paiement\r\n                    </label>\r\n                    <select\r\n                        id=\"payment-status\"\r\n                        className=\"filter-group__input\"\r\n                        value={paymentFilter}\r\n                        onChange={(e) => setPaymentFilter(e.target.value as PaymentStatus)}\r\n                    >\r\n                        <option value=\"all\">Tous</option>\r\n                        <option value=\"paid\">Payé</option>\r\n                        <option value=\"unpaid\">Impayé</option>\r\n                    </select>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Status Filter Pills */}\r\n            <div className=\"status-filters status-filters--mb\">\r\n                {(['all', 'pending', 'preparing', 'ready', 'completed', 'cancelled'] as OrderStatus[]).map(status => (\r\n                    <button\r\n                        key={status}\r\n                        className={`status-pill ${statusFilter === status ? 'is-active' : ''}`}\r\n                        onClick={() => setStatusFilter(status)}\r\n                    >\r\n                        {status === 'all' ? 'Tous' : getStatusLabel(status)}\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Orders Table */}\r\n            <div className=\"orders-table-container\">\r\n                {isLoading ? (\r\n                    <div className=\"orders-loading\">\r\n                        <RefreshCw size={32} className=\"spinning\" />\r\n                        <p>Chargement des commandes...</p>\r\n                    </div>\r\n                ) : paginatedOrders.length > 0 ? (\r\n                    <>\r\n                        <table className=\"orders-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>N° Commande</th>\r\n                                    <th>Heure</th>\r\n                                    <th>Type</th>\r\n                                    <th>Client</th>\r\n                                    <th>Articles</th>\r\n                                    <th>Montant</th>\r\n                                    <th>Statut</th>\r\n                                    <th>Paiement</th>\r\n                                    <th></th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {paginatedOrders.map(order => (\r\n                                    <tr\r\n                                        key={order.id}\r\n                                        className={order.payment_status !== 'paid' ? 'is-unpaid' : ''}\r\n                                        onClick={() => setSelectedOrder(order)}\r\n                                    >\r\n                                        <td>\r\n                                            <span className=\"order-number\">#{order.order_number}</span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <div>{formatTime(order.created_at)}</div>\r\n                                            <div className=\"order-date-sub\">\r\n                                                {formatDate(order.created_at)}\r\n                                            </div>\r\n                                        </td>\r\n                                        <td>\r\n                                            <span className={`order-type-badge ${order.order_type}`}>\r\n                                                {getOrderTypeIcon(order.order_type)} {getOrderTypeLabel(order.order_type)}\r\n                                                {order.table_number && ` - T${order.table_number}`}\r\n                                            </span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <span className=\"order-customer\">\r\n                                                {order.customer_name || '-'}\r\n                                            </span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <span className=\"order-items-count\">\r\n                                                {order.items.reduce((sum, item) => sum + item.quantity, 0)} articles\r\n                                            </span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <span className=\"order-amount\">{formatCurrency(order.total)}</span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <span className={`order-status ${order.status}`}>\r\n                                                {getStatusLabel(order.status)}\r\n                                            </span>\r\n                                        </td>\r\n                                        <td>\r\n                                            <div className=\"payment-info\">\r\n                                                <span className={`payment-status ${order.payment_status}`}>\r\n                                                    {order.payment_status === 'paid' ? (\r\n                                                        <><Check size={14} /> Payé</>\r\n                                                    ) : (\r\n                                                        <><Clock size={14} /> Impayé</>\r\n                                                    )}\r\n                                                </span>\r\n                                                {order.payment_status === 'paid' && order.payment_method && (\r\n                                                    <span className=\"payment-method\">\r\n                                                        {getPaymentIcon(order.payment_method)}\r\n                                                        {getPaymentMethodLabel(order.payment_method)}\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n                                        </td>\r\n                                        <td>\r\n                                            <button\r\n                                                className=\"btn-view-order\"\r\n                                                onClick={(e) => {\r\n                                                    e.stopPropagation();\r\n                                                    setSelectedOrder(order);\r\n                                                }}\r\n                                            >\r\n                                                <Eye size={14} /> Détails\r\n                                            </button>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n\r\n                        {/* Pagination */}\r\n                        <div className=\"orders-pagination\">\r\n                            <div className=\"pagination-info\">\r\n                                Affichage {((currentPage - 1) * ITEMS_PER_PAGE) + 1}-{Math.min(currentPage * ITEMS_PER_PAGE, filteredOrders.length)} sur {filteredOrders.length} commandes\r\n                            </div>\r\n                            <div className=\"pagination-buttons\">\r\n                                <button\r\n                                    className=\"pagination-btn\"\r\n                                    disabled={currentPage === 1}\r\n                                    onClick={() => setCurrentPage(p => p - 1)}\r\n                                    aria-label=\"Page précédente\"\r\n                                >\r\n                                    <ChevronLeft size={18} />\r\n                                </button>\r\n                                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\r\n                                    let pageNum: number;\r\n                                    if (totalPages <= 5) {\r\n                                        pageNum = i + 1;\r\n                                    } else if (currentPage <= 3) {\r\n                                        pageNum = i + 1;\r\n                                    } else if (currentPage >= totalPages - 2) {\r\n                                        pageNum = totalPages - 4 + i;\r\n                                    } else {\r\n                                        pageNum = currentPage - 2 + i;\r\n                                    }\r\n                                    return (\r\n                                        <button\r\n                                            key={pageNum}\r\n                                            className={`pagination-btn ${currentPage === pageNum ? 'is-active' : ''}`}\r\n                                            onClick={() => setCurrentPage(pageNum)}\r\n                                        >\r\n                                            {pageNum}\r\n                                        </button>\r\n                                    );\r\n                                })}\r\n                                <button\r\n                                    className=\"pagination-btn\"\r\n                                    disabled={currentPage === totalPages}\r\n                                    onClick={() => setCurrentPage(p => p + 1)}\r\n                                    aria-label=\"Page suivante\"\r\n                                >\r\n                                    <ChevronRight size={18} />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </>\r\n                ) : (\r\n                    <div className=\"orders-empty\">\r\n                        <div className=\"orders-empty__icon\">📋</div>\r\n                        <div className=\"orders-empty__text\">Aucune commande trouvée</div>\r\n                        <div className=\"orders-empty__subtext\">Modifiez vos filtres pour voir plus de résultats</div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Order Detail Modal */}\r\n            {selectedOrder && (\r\n                <div className=\"order-detail-overlay\" onClick={() => setSelectedOrder(null)}>\r\n                    <div className=\"order-detail-modal\" onClick={e => e.stopPropagation()}>\r\n                        <div className=\"order-detail__header\">\r\n                            <div className=\"order-detail__title-group\">\r\n                                <h2 className=\"order-detail__title\">\r\n                                    <Hash size={20} />\r\n                                    Commande #{selectedOrder.order_number}\r\n                                </h2>\r\n                                <span className={`order-status ${selectedOrder.status}`}>\r\n                                    {getStatusLabel(selectedOrder.status)}\r\n                                </span>\r\n                            </div>\r\n                            <button className=\"order-detail__close\" onClick={() => setSelectedOrder(null)}>\r\n                                <X size={24} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"order-detail__content\">\r\n                            {/* Order Info */}\r\n                            <div className=\"order-detail__info-grid\">\r\n                                <div className=\"order-detail__info-item\">\r\n                                    <span className=\"order-detail__info-label\">ID Transaction</span>\r\n                                    <span className=\"order-detail__info-value order-detail__info-value--mono\">\r\n                                        {selectedOrder.id.slice(0, 8)}...\r\n                                    </span>\r\n                                </div>\r\n                                <div className=\"order-detail__info-item\">\r\n                                    <span className=\"order-detail__info-label\">Date & Heure</span>\r\n                                    <span className=\"order-detail__info-value\">\r\n                                        {formatFullDate(selectedOrder.created_at)}\r\n                                    </span>\r\n                                </div>\r\n                                <div className=\"order-detail__info-item\">\r\n                                    <span className=\"order-detail__info-label\">Type</span>\r\n                                    <span className=\"order-detail__info-value\">\r\n                                        {getOrderTypeIcon(selectedOrder.order_type)} {getOrderTypeLabel(selectedOrder.order_type)}\r\n                                        {selectedOrder.table_number && ` - Table ${selectedOrder.table_number}`}\r\n                                    </span>\r\n                                </div>\r\n                                {selectedOrder.customer_name && (\r\n                                    <div className=\"order-detail__info-item\">\r\n                                        <span className=\"order-detail__info-label\">\r\n                                            <User size={12} /> Client\r\n                                        </span>\r\n                                        <span className=\"order-detail__info-value\">\r\n                                            {selectedOrder.customer_name}\r\n                                        </span>\r\n                                    </div>\r\n                                )}\r\n                                <div className=\"order-detail__info-item\">\r\n                                    <span className=\"order-detail__info-label\">Statut Paiement</span>\r\n                                    <span className={`payment-status ${selectedOrder.payment_status}`}>\r\n                                        {selectedOrder.payment_status === 'paid' ? (\r\n                                            <><Check size={14} /> Payé</>\r\n                                        ) : (\r\n                                            <><Clock size={14} /> Impayé</>\r\n                                        )}\r\n                                    </span>\r\n                                </div>\r\n                                {selectedOrder.payment_method && (\r\n                                    <div className=\"order-detail__info-item\">\r\n                                        <span className=\"order-detail__info-label\">Méthode Paiement</span>\r\n                                        <span className=\"order-detail__info-value\">\r\n                                            {getPaymentIcon(selectedOrder.payment_method)}\r\n                                            {getPaymentMethodLabel(selectedOrder.payment_method)}\r\n                                        </span>\r\n                                    </div>\r\n                                )}\r\n                                {selectedOrder.completed_at && (\r\n                                    <div className=\"order-detail__info-item\">\r\n                                        <span className=\"order-detail__info-label\">Heure Paiement</span>\r\n                                        <span className=\"order-detail__info-value\">\r\n                                            {formatFullDate(selectedOrder.completed_at)}\r\n                                        </span>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Order Items */}\r\n                            <div className=\"order-detail__items\">\r\n                                <div className=\"order-detail__items-header\">\r\n                                    <ShoppingBag size={16} />\r\n                                    <span>Articles ({selectedOrder.items.length})</span>\r\n                                </div>\r\n                                <div className=\"order-detail__items-list\">\r\n                                    {selectedOrder.items.map(item => (\r\n                                        <div key={item.id} className=\"order-detail__item\">\r\n                                            <div className=\"order-detail__item-info\">\r\n                                                <span className=\"order-detail__item-qty\">{item.quantity}x</span>\r\n                                                <span className=\"order-detail__item-name\">{item.product_name}</span>\r\n                                                {item.modifiers && Object.keys(item.modifiers).length > 0 && (\r\n                                                    <span className=\"order-detail__item-mods\">\r\n                                                        + options ({formatCurrency(item.modifiers_total)})\r\n                                                    </span>\r\n                                                )}\r\n                                            </div>\r\n                                            {/* Story 4.7: Item status badge with animation */}\r\n                                            <OrderItemStatusBadge\r\n                                                status={item.item_status}\r\n                                                animate={recentlyUpdatedItemsRef.current.has(item.id)}\r\n                                                size=\"sm\"\r\n                                            />\r\n                                            <span className=\"order-detail__item-price\">\r\n                                                {formatCurrency(item.total_price + (item.modifiers_total || 0))}\r\n                                            </span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Order Totals */}\r\n                            <div className=\"order-detail__totals\">\r\n                                <div className=\"order-detail__total-row\">\r\n                                    <span>Sous-total</span>\r\n                                    <span>{formatCurrency(selectedOrder.subtotal)}</span>\r\n                                </div>\r\n                                {selectedOrder.discount_amount > 0 && (\r\n                                    <div className=\"order-detail__total-row order-detail__total-row--discount\">\r\n                                        <span>Remise</span>\r\n                                        <span>-{formatCurrency(selectedOrder.discount_amount)}</span>\r\n                                    </div>\r\n                                )}\r\n                                <div className=\"order-detail__total-row\">\r\n                                    <span>TVA (10%)</span>\r\n                                    <span>{formatCurrency(selectedOrder.tax_amount)}</span>\r\n                                </div>\r\n                                <div className=\"order-detail__total-row order-detail__total-row--final\">\r\n                                    <span>Total</span>\r\n                                    <span>{formatCurrency(selectedOrder.total)}</span>\r\n                                </div>\r\n                                {selectedOrder.payment_method === 'cash' && selectedOrder.cash_received && (\r\n                                    <>\r\n                                        <div className=\"order-detail__total-row\">\r\n                                            <span>Espèces reçues</span>\r\n                                            <span>{formatCurrency(selectedOrder.cash_received)}</span>\r\n                                        </div>\r\n                                        <div className=\"order-detail__total-row\">\r\n                                            <span>Rendu</span>\r\n                                            <span>{formatCurrency(selectedOrder.change_given || 0)}</span>\r\n                                        </div>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default OrdersPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\pos\\POSMainPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5249,5252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5249,5252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5269,5272],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5269,5272],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useCallback, useEffect } from 'react'\r\nimport { Search, CheckCircle, Clock, Users, User } from 'lucide-react'\r\n\r\nimport { useCartStore, CartItem } from '../../stores/cartStore'\r\nimport { useAuthStore } from '../../stores/authStore'\r\nimport { useProducts, useCategories, usePOSCombos } from '../../hooks/products'\r\nimport { useNetworkAlerts } from '../../hooks/useNetworkAlerts'\r\nimport { useSyncReport } from '../../hooks/useSyncReport'\r\nimport { useLanHub } from '../../hooks/lan'\r\nimport { useCartPriceRecalculation } from '../../hooks/pricing'\r\nimport { usePOSModals, usePOSShift, usePOSOrders, useCartPromotions } from '../../hooks/pos'\r\nimport { PostOfflineSyncReport } from '../../components/sync/PostOfflineSyncReport'\r\nimport CategoryNav from '../../components/pos/CategoryNav'\r\nimport ProductGrid from '../../components/pos/ProductGrid'\r\nimport ComboGrid from '../../components/pos/ComboGrid'\r\nimport Cart from '../../components/pos/Cart'\r\nimport POSMenu from '../../components/pos/POSMenu'\r\nimport {\r\n    ModifierModal,\r\n    PaymentModal,\r\n    VariantModal,\r\n    HeldOrdersModal,\r\n    PinVerificationModal,\r\n    TransactionHistoryModal,\r\n    CashierAnalyticsModal,\r\n    ComboSelectorModal,\r\n} from '../../components/pos/modals'\r\nimport {\r\n    OpenShiftModal,\r\n    CloseShiftModal,\r\n    ShiftReconciliationModal,\r\n    ShiftHistoryModal,\r\n    ShiftStatsModal,\r\n} from '../../components/pos/shift'\r\nimport type { Product, ProductCombo } from '../../types/database'\r\nimport './POSMainPage.css'\r\n\r\nexport default function POSMainPage() {\r\n    // Enable network status alerts (Story 3.2)\r\n    useNetworkAlerts()\r\n\r\n    // Enable post-offline sync report modal (Story 3.3)\r\n    const { showReport: showSyncReport, period: syncPeriod, dismissReport: dismissSyncReport, retryFailed: retrySyncFailed } = useSyncReport()\r\n\r\n    // Enable automatic cart price recalculation on customer change (Story 6.2)\r\n    useCartPriceRecalculation()\r\n\r\n    // Enable automatic promotion evaluation on cart changes (Story 6.5)\r\n    useCartPromotions()\r\n\r\n    // Enable LAN Hub for KDS communication (Story 4.1)\r\n    const { isRunning: lanHubRunning, error: lanHubError } = useLanHub({\r\n        deviceName: 'Main Terminal',\r\n        autoStart: true,\r\n    })\r\n\r\n    useEffect(() => {\r\n        if (lanHubError) console.error('[POS] LAN Hub error:', lanHubError)\r\n    }, [lanHubError])\r\n\r\n    useEffect(() => {\r\n        console.log('[POS] LAN Hub running:', lanHubRunning)\r\n    }, [lanHubRunning])\r\n\r\n    // Cart state\r\n    const { itemCount } = useCartStore()\r\n    const { user } = useAuthStore()\r\n\r\n    // UI state\r\n    const [selectedCategory, setSelectedCategory] = useState<string | null>(null)\r\n    const [searchQuery, setSearchQuery] = useState('')\r\n    const [selectedProduct, setSelectedProduct] = useState<Product | null>(null)\r\n    const [selectedComboId, setSelectedComboId] = useState<string | null>(null)\r\n    const [editItem, setEditItem] = useState<CartItem | undefined>(undefined)\r\n\r\n    // Consolidated modal management\r\n    const { modals, openModal, closeModal } = usePOSModals()\r\n\r\n    // Shift management\r\n    const {\r\n        hasOpenShift,\r\n        currentSession,\r\n        terminalSessions,\r\n        shiftStats,\r\n        sessionTransactions,\r\n        reconciliationData,\r\n        clearReconciliation,\r\n        isOpeningShift,\r\n        isClosingShift,\r\n        activeShiftUserId,\r\n        verifiedUser,\r\n        setVerifiedUser,\r\n        pinModalAction,\r\n        setPinModalAction,\r\n        isRecoveringShift,\r\n        handlePinVerified,\r\n        handleOpenShift,\r\n        handleCloseShift,\r\n        handleSwitchShift,\r\n        handleRecoverShift,\r\n    } = usePOSShift()\r\n\r\n    // Order management\r\n    const { handleSendToKitchen, handleRestoreHeldOrder } = usePOSOrders()\r\n\r\n    // Data fetching\r\n    const { data: categories = [], isLoading: categoriesLoading } = useCategories()\r\n    const { data: products = [], isLoading: productsLoading } = useProducts(selectedCategory)\r\n    const { data: combos = [], isLoading: combosLoading } = usePOSCombos()\r\n\r\n    // Filter products by search\r\n    const filteredProducts = useMemo(() =>\r\n        products.filter(product =>\r\n            searchQuery === '' ||\r\n            product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n            product.sku.toLowerCase().includes(searchQuery.toLowerCase())\r\n        ),\r\n        [products, searchQuery]\r\n    )\r\n\r\n    // Handle product click\r\n    const handleProductClick = useCallback((product: Product) => {\r\n        setEditItem(undefined)\r\n        setSelectedProduct(product)\r\n        openModal('variant')\r\n    }, [openModal])\r\n\r\n    const handleCartItemClick = useCallback((item: CartItem) => {\r\n        setEditItem(item)\r\n        setSelectedProduct(item.product || null)\r\n        openModal('modifier')\r\n    }, [openModal])\r\n\r\n    const handleVariantClose = useCallback(() => {\r\n        closeModal('variant')\r\n        setSelectedProduct(null)\r\n    }, [closeModal])\r\n\r\n    // Combo handlers (Story 6.6)\r\n    const handleComboClick = useCallback((combo: ProductCombo) => {\r\n        setSelectedComboId(combo.id)\r\n        openModal('combo')\r\n    }, [openModal])\r\n\r\n    const handleComboConfirm = useCallback((_combo: any, selectedItems: any[], totalPrice: number) => {\r\n        const combo = combos.find(c => c.id === selectedComboId)\r\n        if (combo) {\r\n            const { addCombo } = useCartStore.getState()\r\n            addCombo(combo, 1, selectedItems, totalPrice, '')\r\n        }\r\n        closeModal('combo')\r\n        setSelectedComboId(null)\r\n    }, [selectedComboId, combos, closeModal])\r\n\r\n    // Shift request handlers\r\n    const handleOpenShiftRequest = useCallback(() => {\r\n        setPinModalAction('open')\r\n        openModal('pin')\r\n    }, [setPinModalAction, openModal])\r\n\r\n    const handleCloseShiftRequest = useCallback(() => {\r\n        setPinModalAction('close')\r\n        openModal('pin')\r\n    }, [setPinModalAction, openModal])\r\n\r\n    // Handle checkout\r\n    const handleCheckout = useCallback(() => {\r\n        if (!hasOpenShift) {\r\n            openModal('noShift')\r\n            return\r\n        }\r\n        if (itemCount > 0) {\r\n            openModal('payment')\r\n        }\r\n    }, [hasOpenShift, itemCount, openModal])\r\n\r\n    return (\r\n        <div className=\"pos-app\">\r\n            <main className=\"pos-main\">\r\n                <CategoryNav\r\n                    categories={categories}\r\n                    selectedCategory={selectedCategory}\r\n                    onSelectCategory={setSelectedCategory}\r\n                    isLoading={categoriesLoading}\r\n                    onOpenMenu={() => openModal('menu')}\r\n                />\r\n\r\n                {/* Shift Indicator Banner (F2.9) */}\r\n                {hasOpenShift && currentSession && (\r\n                    <div className=\"pos-shift-banner\">\r\n                        <div className=\"pos-shift-banner__info\">\r\n                            <Clock size={16} />\r\n                            <span className=\"pos-shift-banner__session\">Shift #{currentSession.session_number}</span>\r\n                            <span className=\"pos-shift-banner__divider\">|</span>\r\n                            <User size={14} />\r\n                            <span className=\"pos-shift-banner__user\">\r\n                                {currentSession.user_name || 'Cashier'}\r\n                            </span>\r\n                        </div>\r\n                        <span className=\"pos-shift-banner__time\">\r\n                            Since {new Date(currentSession.opened_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                        </span>\r\n                    </div>\r\n                )}\r\n\r\n                <section className=\"pos-products\">\r\n                    <div className=\"pos-products__header\">\r\n                        <h2 className=\"pos-products__title\">\r\n                            {selectedCategory\r\n                                ? categories.find(c => c.id === selectedCategory)?.name || 'All Products'\r\n                                : 'All Products'}\r\n                        </h2>\r\n                        <div className=\"pos-products__search search-input\">\r\n                            <Search className=\"search-input__icon\" size={20} />\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder=\"Search a product...\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"pos-products__grid\">\r\n                        {/* Combo deals (Story 6.6) */}\r\n                        {!selectedCategory && (\r\n                            <ComboGrid\r\n                                combos={combos}\r\n                                onComboClick={handleComboClick}\r\n                                isLoading={combosLoading}\r\n                            />\r\n                        )}\r\n                        <ProductGrid\r\n                            products={filteredProducts}\r\n                            onProductClick={handleProductClick}\r\n                            isLoading={productsLoading}\r\n                        />\r\n                    </div>\r\n                </section>\r\n\r\n                <Cart\r\n                    onCheckout={handleCheckout}\r\n                    onSendToKitchen={() => handleSendToKitchen(hasOpenShift, () => openModal('noShift'))}\r\n                    onShowPendingOrders={() => openModal('heldOrders')}\r\n                    onItemClick={handleCartItemClick}\r\n                />\r\n            </main>\r\n\r\n            <POSMenu\r\n                isOpen={modals.menu}\r\n                onClose={() => closeModal('menu')}\r\n                onShowHeldOrders={() => openModal('heldOrders')}\r\n                onShowTransactionHistory={() => openModal('transactionHistory')}\r\n                onShowAnalytics={() => openModal('analytics')}\r\n                onShowShiftHistory={() => openModal('shiftHistory')}\r\n                onShowShiftStats={() => openModal('shiftStats')}\r\n                hasOpenShift={hasOpenShift}\r\n                onOpenShift={handleOpenShiftRequest}\r\n                onCloseShift={handleCloseShiftRequest}\r\n            />\r\n\r\n            {modals.variant && selectedProduct && (\r\n                <VariantModal baseProduct={selectedProduct} onClose={handleVariantClose} />\r\n            )}\r\n\r\n            {modals.modifier && selectedProduct && (\r\n                <ModifierModal\r\n                    product={selectedProduct}\r\n                    editItem={editItem}\r\n                    onClose={() => {\r\n                        closeModal('modifier')\r\n                        setSelectedProduct(null)\r\n                        setEditItem(undefined)\r\n                    }}\r\n                />\r\n            )}\r\n\r\n            {modals.combo && selectedComboId && (\r\n                <ComboSelectorModal\r\n                    comboId={selectedComboId}\r\n                    onClose={() => { closeModal('combo'); setSelectedComboId(null) }}\r\n                    onConfirm={handleComboConfirm}\r\n                />\r\n            )}\r\n\r\n            {modals.payment && <PaymentModal onClose={() => closeModal('payment')} />}\r\n\r\n            {modals.heldOrders && (\r\n                <HeldOrdersModal\r\n                    onClose={() => closeModal('heldOrders')}\r\n                    onRestore={(id) => handleRestoreHeldOrder(id, () => closeModal('heldOrders'))}\r\n                />\r\n            )}\r\n\r\n            {modals.pin && (\r\n                <PinVerificationModal\r\n                    title={pinModalAction === 'open' ? 'Open a Shift' : 'Close Shift'}\r\n                    message={pinModalAction === 'open' ? 'Enter your PIN to open your shift' : 'Enter your PIN to close the shift'}\r\n                    allowedRoles={['cashier', 'manager', 'admin', 'barista']}\r\n                    onVerify={(verified, user) => handlePinVerified(verified, user, () => closeModal('pin'), () => openModal('openShift'), () => openModal('closeShift'))}\r\n                    onClose={() => { closeModal('pin'); setVerifiedUser(null) }}\r\n                />\r\n            )}\r\n\r\n            {modals.openShift && verifiedUser && (\r\n                <OpenShiftModal\r\n                    onOpen={async (cash, terminal, notes) => { await handleOpenShift(cash, terminal, notes); closeModal('openShift') }}\r\n                    onClose={() => { closeModal('openShift'); setVerifiedUser(null) }}\r\n                    isLoading={isOpeningShift}\r\n                />\r\n            )}\r\n\r\n            {modals.closeShift && currentSession && verifiedUser && (\r\n                <CloseShiftModal\r\n                    sessionStats={shiftStats}\r\n                    openingCash={currentSession.opening_cash}\r\n                    onClose={() => { closeModal('closeShift'); setVerifiedUser(null) }}\r\n                    onConfirm={async (cash, qris, edc, notes) => { await handleCloseShift(cash, qris, edc, notes); closeModal('closeShift') }}\r\n                    isLoading={isClosingShift}\r\n                />\r\n            )}\r\n\r\n            {reconciliationData && (\r\n                <ShiftReconciliationModal\r\n                    reconciliation={reconciliationData}\r\n                    totalSales={shiftStats.totalSales}\r\n                    transactionCount={shiftStats.transactionCount}\r\n                    onClose={clearReconciliation}\r\n                />\r\n            )}\r\n\r\n            {modals.transactionHistory && currentSession && (\r\n                <TransactionHistoryModal\r\n                    sessionId={currentSession.id}\r\n                    sessionOpenedAt={currentSession.opened_at}\r\n                    onClose={() => closeModal('transactionHistory')}\r\n                />\r\n            )}\r\n\r\n            {modals.analytics && (\r\n                <CashierAnalyticsModal onClose={() => closeModal('analytics')} sessionId={currentSession?.id} />\r\n            )}\r\n\r\n            {modals.shiftHistory && <ShiftHistoryModal onClose={() => closeModal('shiftHistory')} />}\r\n\r\n            {modals.shiftStats && currentSession && (\r\n                <ShiftStatsModal session={currentSession} transactions={sessionTransactions} stats={shiftStats} onClose={() => closeModal('shiftStats')} />\r\n            )}\r\n\r\n            {modals.shiftSelector && (\r\n                <div className=\"shift-selector-overlay\" onClick={() => closeModal('shiftSelector')}>\r\n                    <div className=\"shift-selector\" onClick={e => e.stopPropagation()}>\r\n                        <h3 className=\"shift-selector__title\"><Users size={20} />Select a terminal</h3>\r\n                        <div className=\"shift-selector__list\">\r\n                            {terminalSessions.map(session => (\r\n                                <button\r\n                                    key={session.id}\r\n                                    className={`shift-selector__item ${session.user_id === activeShiftUserId ? 'is-active' : ''}`}\r\n                                    onClick={() => handleSwitchShift(session.user_id, () => closeModal('shiftSelector'))}\r\n                                >\r\n                                    <div className=\"shift-selector__user\">\r\n                                        <span className=\"shift-selector__name\">{session.user_name || `Cashier ${session.session_number}`}</span>\r\n                                        <span className=\"shift-selector__session\">#{session.session_number}</span>\r\n                                    </div>\r\n                                    {session.user_id === activeShiftUserId && <CheckCircle size={18} className=\"shift-selector__check\" />}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                        <button className=\"shift-selector__add\" onClick={() => { closeModal('shiftSelector'); handleOpenShiftRequest() }}>\r\n                            <Clock size={18} />Open a new shift\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {modals.noShift && (\r\n                <div className=\"pos-no-shift-modal-overlay\">\r\n                    <div className=\"pos-no-shift-modal\">\r\n                        <div className=\"pos-no-shift-modal__icon\"><Clock size={48} /></div>\r\n                        <h3 className=\"pos-no-shift-modal__title\">No shift open</h3>\r\n                        <p className=\"pos-no-shift-modal__message\">You must open a shift to perform this action.</p>\r\n                        <div className=\"pos-no-shift-modal__actions\">\r\n                            <button type=\"button\" className=\"pos-no-shift-modal__btn pos-no-shift-modal__btn--secondary\" onClick={() => closeModal('noShift')}>Cancel</button>\r\n                            {user?.id && (\r\n                                <button type=\"button\" className=\"pos-no-shift-modal__btn pos-no-shift-modal__btn--secondary\" disabled={isRecoveringShift} onClick={() => handleRecoverShift(user.id, () => closeModal('noShift'))}>\r\n                                    {isRecoveringShift ? 'Searching...' : 'Recover my shift'}\r\n                                </button>\r\n                            )}\r\n                            <button type=\"button\" className=\"pos-no-shift-modal__btn pos-no-shift-modal__btn--primary\" onClick={() => { closeModal('noShift'); handleOpenShiftRequest() }}>Open a Shift</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {showSyncReport && syncPeriod && (\r\n                <PostOfflineSyncReport period={syncPeriod} onClose={dismissSyncReport} onRetryFailed={retrySyncFailed} />\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\production\\ProductionPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\ComboFormPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\CombosPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\ProductCategoryPricingPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":208,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7181,7184],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7181,7184],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { useNavigate, useParams } from 'react-router-dom'\r\nimport {\r\n    ArrowLeft, Save, DollarSign, Users, Tag,\r\n    Building2, Crown, UserCheck, Plus, Trash2\r\n} from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { saveProductCategoryPrice } from '@/services/products/catalogSyncService'\r\nimport { formatCurrency } from '../../utils/helpers'\r\nimport { toast } from 'sonner'\r\nimport './ProductCategoryPricingPage.css'\r\n\r\ninterface Product {\r\n    id: string\r\n    name: string\r\n    sku: string\r\n    retail_price: number\r\n    wholesale_price: number | null\r\n}\r\n\r\ninterface CustomerCategory {\r\n    id: string\r\n    name: string\r\n    slug: string\r\n    color: string\r\n    price_modifier_type: string\r\n    discount_percentage: number | null\r\n}\r\n\r\ninterface CategoryPrice {\r\n    id?: string\r\n    customer_category_id: string\r\n    price: number\r\n    is_active: boolean\r\n    isNew?: boolean\r\n    isModified?: boolean\r\n}\r\n\r\nexport default function ProductCategoryPricingPage() {\r\n    const navigate = useNavigate()\r\n    const { id } = useParams()\r\n    const [loading, setLoading] = useState(true)\r\n    const [saving, setSaving] = useState(false)\r\n    const [product, setProduct] = useState<Product | null>(null)\r\n    const [categories, setCategories] = useState<CustomerCategory[]>([])\r\n    const [categoryPrices, setCategoryPrices] = useState<CategoryPrice[]>([])\r\n\r\n    useEffect(() => {\r\n        if (id) fetchData()\r\n    }, [id])\r\n\r\n    const fetchData = async () => {\r\n        setLoading(true)\r\n        try {\r\n            const [productRes, categoriesRes, pricesRes] = await Promise.all([\r\n                supabase\r\n                    .from('products')\r\n                    .select('id, name, sku, retail_price, wholesale_price')\r\n                    .eq('id', id!)\r\n                    .single(),\r\n                supabase\r\n                    .from('customer_categories')\r\n                    .select('*')\r\n                    .eq('is_active', true)\r\n                    .order('name'),\r\n                supabase\r\n                    .from('product_category_prices')\r\n                    .select('*')\r\n                    .eq('product_id', id!)\r\n            ])\r\n\r\n            if (productRes.error) throw productRes.error\r\n            if (productRes.data) setProduct({\r\n                id: productRes.data.id,\r\n                name: productRes.data.name,\r\n                sku: productRes.data.sku ?? '',\r\n                retail_price: productRes.data.retail_price ?? 0,\r\n                wholesale_price: productRes.data.wholesale_price ?? null\r\n            })\r\n            if (categoriesRes.data) setCategories(categoriesRes.data as unknown as CustomerCategory[])\r\n\r\n            if (pricesRes.data) {\r\n                setCategoryPrices(pricesRes.data.map(p => ({\r\n                    id: p.id,\r\n                    customer_category_id: p.customer_category_id,\r\n                    price: p.price,\r\n                    is_active: p.is_active ?? true\r\n                })))\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching data:', error)\r\n            toast.error('Error during loading')\r\n            navigate('/products')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const getCategoryIcon = (slug: string) => {\r\n        switch (slug) {\r\n            case 'wholesale': return <Building2 size={18} />\r\n            case 'vip': return <Crown size={18} />\r\n            case 'staff': return <UserCheck size={18} />\r\n            default: return <Users size={18} />\r\n        }\r\n    }\r\n\r\n    const getCalculatedPrice = (category: CustomerCategory) => {\r\n        if (!product) return 0\r\n\r\n        switch (category.price_modifier_type) {\r\n            case 'wholesale':\r\n                return product.wholesale_price || product.retail_price\r\n            case 'discount_percentage':\r\n                return product.retail_price * (1 - (category.discount_percentage || 0) / 100)\r\n            default:\r\n                return product.retail_price\r\n        }\r\n    }\r\n\r\n    const getCategoryPrice = (categoryId: string) => {\r\n        return categoryPrices.find(p => p.customer_category_id === categoryId)\r\n    }\r\n\r\n    const handlePriceChange = (categoryId: string, price: number) => {\r\n        const existing = categoryPrices.find(p => p.customer_category_id === categoryId)\r\n\r\n        if (existing) {\r\n            setCategoryPrices(categoryPrices.map(p =>\r\n                p.customer_category_id === categoryId\r\n                    ? { ...p, price, isModified: true }\r\n                    : p\r\n            ))\r\n        } else {\r\n            setCategoryPrices([\r\n                ...categoryPrices,\r\n                {\r\n                    customer_category_id: categoryId,\r\n                    price,\r\n                    is_active: true,\r\n                    isNew: true\r\n                }\r\n            ])\r\n        }\r\n    }\r\n\r\n    const handleToggleActive = (categoryId: string) => {\r\n        const existing = categoryPrices.find(p => p.customer_category_id === categoryId)\r\n\r\n        if (existing) {\r\n            setCategoryPrices(categoryPrices.map(p =>\r\n                p.customer_category_id === categoryId\r\n                    ? { ...p, is_active: !p.is_active, isModified: true }\r\n                    : p\r\n            ))\r\n        }\r\n    }\r\n\r\n    const handleRemovePrice = (categoryId: string) => {\r\n        const existing = categoryPrices.find(p => p.customer_category_id === categoryId)\r\n        if (existing?.isNew) {\r\n            setCategoryPrices(categoryPrices.filter(p => p.customer_category_id !== categoryId))\r\n        } else if (existing?.id) {\r\n            // Mark for deletion\r\n            setCategoryPrices(categoryPrices.map(p =>\r\n                p.customer_category_id === categoryId\r\n                    ? { ...p, is_active: false, isModified: true }\r\n                    : p\r\n            ))\r\n        }\r\n    }\r\n\r\n    const handleAddCategory = (categoryId: string) => {\r\n        const category = categories.find(c => c.id === categoryId)\r\n        if (!category || !product) return\r\n\r\n        const calculatedPrice = getCalculatedPrice(category)\r\n\r\n        setCategoryPrices([\r\n            ...categoryPrices,\r\n            {\r\n                customer_category_id: categoryId,\r\n                price: calculatedPrice,\r\n                is_active: true,\r\n                isNew: true\r\n            }\r\n        ])\r\n    }\r\n\r\n    const handleSave = async () => {\r\n        if (!product) return\r\n\r\n        setSaving(true)\r\n        try {\r\n            // Process each category price\r\n            for (const cp of categoryPrices) {\r\n                if ((cp.isNew && cp.is_active) || cp.isModified) {\r\n                    const priceId = cp.id || crypto.randomUUID()\r\n\r\n                    const priceData = {\r\n                        id: priceId,\r\n                        product_id: product.id,\r\n                        customer_category_id: cp.customer_category_id,\r\n                        price: cp.price,\r\n                        is_active: cp.is_active\r\n                    }\r\n\r\n                    const result = await saveProductCategoryPrice(priceData as any)\r\n\r\n                    if (!result.success) {\r\n                        throw new Error(result.error)\r\n                    }\r\n                }\r\n            }\r\n\r\n            toast.success('Prices saved successfully')\r\n            fetchData() // Refresh\r\n        } catch (error) {\r\n            console.error('Error saving prices:', error)\r\n            toast.error('Error during save')\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    const categoriesWithPrices = categories.filter(c =>\r\n        categoryPrices.some(p => p.customer_category_id === c.id)\r\n    )\r\n\r\n    const categoriesWithoutPrices = categories.filter(c =>\r\n        !categoryPrices.some(p => p.customer_category_id === c.id)\r\n    )\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"pricing-page\">\r\n                <div className=\"pricing-loading\">\r\n                    <div className=\"spinner\"></div>\r\n                    <span>Loading...</span>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (!product) return null\r\n\r\n    return (\r\n        <div className=\"pricing-page\">\r\n            {/* Header */}\r\n            <header className=\"pricing-header\">\r\n                <div className=\"pricing-header__left\">\r\n                    <button\r\n                        className=\"btn btn-ghost\"\r\n                        onClick={() => navigate('/products')}\r\n                    >\r\n                        <ArrowLeft size={20} />\r\n                    </button>\r\n                    <div>\r\n                        <h1 className=\"pricing-header__title\">\r\n                            <DollarSign size={28} />\r\n                            Customer Category Pricing\r\n                        </h1>\r\n                        <p className=\"pricing-header__product\">\r\n                            <Tag size={14} />\r\n                            {product.name}\r\n                            <span className=\"sku\">({product.sku})</span>\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n                <button\r\n                    className=\"btn btn-primary\"\r\n                    onClick={handleSave}\r\n                    disabled={saving}\r\n                >\r\n                    <Save size={18} />\r\n                    {saving ? 'Saving...' : 'Save'}\r\n                </button>\r\n            </header>\r\n\r\n            {/* Reference Prices */}\r\n            <div className=\"reference-prices\">\r\n                <h2>Reference Prices</h2>\r\n                <div className=\"reference-grid\">\r\n                    <div className=\"reference-card\">\r\n                        <span className=\"reference-label\">Retail Price</span>\r\n                        <span className=\"reference-value\">{formatCurrency(product.retail_price)}</span>\r\n                    </div>\r\n                    <div className=\"reference-card\">\r\n                        <span className=\"reference-label\">Wholesale Price</span>\r\n                        <span className=\"reference-value\">\r\n                            {product.wholesale_price\r\n                                ? formatCurrency(product.wholesale_price)\r\n                                : 'Not defined'}\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Category Prices */}\r\n            <div className=\"category-prices-section\">\r\n                <h2>Pricing by Category</h2>\r\n                <p className=\"section-description\">\r\n                    Define specific prices for each customer category.\r\n                    If no price is defined, the system will use the category logic\r\n                    (wholesale price, % discount, etc.)\r\n                </p>\r\n\r\n                {categoriesWithPrices.length > 0 ? (\r\n                    <div className=\"category-prices-list\">\r\n                        {categoriesWithPrices.map(category => {\r\n                            const cp = getCategoryPrice(category.id)\r\n                            if (!cp) return null\r\n\r\n                            const calculatedPrice = getCalculatedPrice(category)\r\n                            const difference = cp.price - calculatedPrice\r\n                            const percentDiff = ((cp.price - calculatedPrice) / calculatedPrice) * 100\r\n\r\n                            return (\r\n                                <div\r\n                                    key={category.id}\r\n                                    className={`category-price-card ${!cp.is_active ? 'inactive' : ''}`}\r\n                                >\r\n                                    <div className=\"category-price-card__header\">\r\n                                        <div\r\n                                            className=\"category-icon\"\r\n                                            style={{ backgroundColor: category.color }}\r\n                                        >\r\n                                            {getCategoryIcon(category.slug)}\r\n                                        </div>\r\n                                        <div className=\"category-info\">\r\n                                            <span className=\"category-name\">{category.name}</span>\r\n                                            <span className=\"category-type\">\r\n                                                {category.price_modifier_type === 'retail' && 'Standard Price'}\r\n                                                {category.price_modifier_type === 'wholesale' && 'Wholesale Price'}\r\n                                                {category.price_modifier_type === 'discount_percentage' &&\r\n                                                    `${category.discount_percentage}% discount`}\r\n                                                {category.price_modifier_type === 'custom' && 'Custom Price'}\r\n                                            </span>\r\n                                        </div>\r\n                                        <div className=\"category-actions\">\r\n                                            <button\r\n                                                className={`btn-toggle ${cp.is_active ? 'active' : ''}`}\r\n                                                onClick={() => handleToggleActive(category.id)}\r\n                                            >\r\n                                                {cp.is_active ? 'Active' : 'Inactive'}\r\n                                            </button>\r\n                                            <button\r\n                                                className=\"btn-icon btn-danger\"\r\n                                                onClick={() => handleRemovePrice(category.id)}\r\n                                                title=\"Delete\"\r\n                                            >\r\n                                                <Trash2 size={16} />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"category-price-card__content\">\r\n                                        <div className=\"price-input-group\">\r\n                                            <label>Custom Price</label>\r\n                                            <div className=\"price-input\">\r\n                                                <span className=\"currency\">Rp</span>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    value={cp.price}\r\n                                                    onChange={(e) => handlePriceChange(category.id, Number(e.target.value))}\r\n                                                    min=\"0\"\r\n                                                    step=\"1000\"\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"price-comparison\">\r\n                                            <div className=\"comparison-item\">\r\n                                                <span className=\"comparison-label\">Auto price:</span>\r\n                                                <span className=\"comparison-value\">{formatCurrency(calculatedPrice)}</span>\r\n                                            </div>\r\n                                            <div className=\"comparison-item\">\r\n                                                <span className=\"comparison-label\">Difference:</span>\r\n                                                <span className={`comparison-value ${difference > 0 ? 'positive' : difference < 0 ? 'negative' : ''}`}>\r\n                                                    {difference > 0 ? '+' : ''}{formatCurrency(difference)}\r\n                                                    <span className=\"percent\">\r\n                                                        ({percentDiff > 0 ? '+' : ''}{percentDiff.toFixed(1)}%)\r\n                                                    </span>\r\n                                                </span>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )\r\n                        })}\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"no-prices\">\r\n                        <DollarSign size={48} />\r\n                        <h3>No custom price</h3>\r\n                        <p>Add specific prices for each customer category</p>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Add Category */}\r\n                {categoriesWithoutPrices.length > 0 && (\r\n                    <div className=\"add-category-section\">\r\n                        <h3>\r\n                            <Plus size={18} />\r\n                            Add a Category\r\n                        </h3>\r\n                        <div className=\"available-categories\">\r\n                            {categoriesWithoutPrices.map(category => (\r\n                                <button\r\n                                    key={category.id}\r\n                                    className=\"category-add-btn\"\r\n                                    onClick={() => handleAddCategory(category.id)}\r\n                                    style={{ '--category-color': category.color } as React.CSSProperties}\r\n                                >\r\n                                    <div\r\n                                        className=\"category-add-icon\"\r\n                                        style={{ backgroundColor: category.color }}\r\n                                    >\r\n                                        {getCategoryIcon(category.slug)}\r\n                                    </div>\r\n                                    <div className=\"category-add-info\">\r\n                                        <span className=\"category-add-name\">{category.name}</span>\r\n                                        <span className=\"category-add-price\">\r\n                                            Auto price: {formatCurrency(getCalculatedPrice(category))}\r\n                                        </span>\r\n                                    </div>\r\n                                    <Plus size={16} />\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\ProductFormPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":210,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7133,7136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7133,7136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Product Form Page\r\n * Epic 10: Story 10.9\r\n *\r\n * Create and edit products with full form\r\n */\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useNavigate, useParams } from 'react-router-dom'\r\nimport {\r\n    ArrowLeft, Save, Package, DollarSign, Warehouse,\r\n    Tag, Image as ImageIcon, Upload, X, FileText\r\n} from 'lucide-react'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { saveProduct } from '@/services/products/catalogSyncService'\r\nimport { formatCurrency } from '@/utils/helpers'\r\nimport { toast } from 'sonner'\r\nimport './ProductFormPage.css'\r\n\r\ninterface Category {\r\n    id: string\r\n    name: string\r\n}\r\n\r\ninterface ProductForm {\r\n    sku: string\r\n    name: string\r\n    description: string\r\n    category_id: string\r\n    product_type: 'finished' | 'semi_finished' | 'raw_material'\r\n    unit: string\r\n    cost_price: number\r\n    sale_price: number\r\n    retail_price: number\r\n    wholesale_price: number\r\n    min_stock_level: number\r\n    stock_quantity: number\r\n    pos_visible: boolean\r\n    is_active: boolean\r\n    deduct_ingredients: boolean\r\n    image_url: string\r\n}\r\n\r\nconst PRODUCT_TYPES = [\r\n    { value: 'finished', label: 'Finished product', description: 'Product sold as is' },\r\n    { value: 'semi_finished', label: 'Semi-finished', description: 'Intermediate product' },\r\n    { value: 'raw_material', label: 'Raw material', description: 'Basic ingredient' }\r\n]\r\n\r\nconst UNITS = [\r\n    'piece', 'kg', 'g', 'L', 'mL', 'unit', 'portion', 'box', 'pouch'\r\n]\r\n\r\nexport default function ProductFormPage() {\r\n    const navigate = useNavigate()\r\n    const { id } = useParams()\r\n    const isEditing = Boolean(id)\r\n\r\n    const [loading, setLoading] = useState(true)\r\n    const [saving, setSaving] = useState(false)\r\n    const [categories, setCategories] = useState<Category[]>([])\r\n\r\n    const [form, setForm] = useState<ProductForm>({\r\n        sku: '',\r\n        name: '',\r\n        description: '',\r\n        category_id: '',\r\n        product_type: 'finished',\r\n        unit: 'piece',\r\n        cost_price: 0,\r\n        sale_price: 0,\r\n        retail_price: 0,\r\n        wholesale_price: 0,\r\n        min_stock_level: 0,\r\n        stock_quantity: 0,\r\n        pos_visible: true,\r\n        is_active: true,\r\n        deduct_ingredients: false,\r\n        image_url: ''\r\n    })\r\n\r\n    const [errors, setErrors] = useState<Record<string, string>>({})\r\n\r\n    useEffect(() => {\r\n        loadData()\r\n    }, [id])\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            // Load categories\r\n            const { data: cats } = await supabase\r\n                .from('categories')\r\n                .select('id, name')\r\n                .order('name')\r\n\r\n            if (cats) setCategories(cats)\r\n\r\n            // Load product if editing\r\n            if (id) {\r\n                const { data: product, error } = await supabase\r\n                    .from('products')\r\n                    .select('*')\r\n                    .eq('id', id)\r\n                    .single()\r\n\r\n                if (error) throw error\r\n                if (product) {\r\n                    setForm({\r\n                        sku: product.sku || '',\r\n                        name: product.name || '',\r\n                        description: product.description || '',\r\n                        category_id: product.category_id || '',\r\n                        product_type: product.product_type || 'finished',\r\n                        unit: product.unit || 'piece',\r\n                        cost_price: product.cost_price || 0,\r\n                        sale_price: product.retail_price || 0,\r\n                        retail_price: product.retail_price || 0,\r\n                        wholesale_price: product.wholesale_price || 0,\r\n                        min_stock_level: product.min_stock_level || 0,\r\n                        stock_quantity: product.current_stock || 0,\r\n                        pos_visible: product.pos_visible !== false,\r\n                        is_active: product.is_active !== false,\r\n                        deduct_ingredients: product.deduct_ingredients === true,\r\n                        image_url: product.image_url || ''\r\n                    })\r\n                }\r\n            } else {\r\n                // Generate SKU for new product\r\n                const { data: lastProduct } = await supabase\r\n                    .from('products')\r\n                    .select('sku')\r\n                    .order('created_at', { ascending: false })\r\n                    .limit(1)\r\n                    .single()\r\n\r\n                if (lastProduct?.sku) {\r\n                    const match = lastProduct.sku.match(/PRD-(\\d+)/)\r\n                    if (match) {\r\n                        const nextNum = parseInt(match[1]) + 1\r\n                        setForm(prev => ({\r\n                            ...prev,\r\n                            sku: `PRD-${String(nextNum).padStart(4, '0')}`\r\n                        }))\r\n                    }\r\n                } else {\r\n                    setForm(prev => ({ ...prev, sku: 'PRD-0001' }))\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error('Error loading data:', error)\r\n            toast.error('Error loading data')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const validate = (): boolean => {\r\n        const newErrors: Record<string, string> = {}\r\n\r\n        if (!form.sku.trim()) {\r\n            newErrors.sku = 'SKU required'\r\n        }\r\n        if (!form.name.trim()) {\r\n            newErrors.name = 'Name required'\r\n        }\r\n        if (!form.unit.trim()) {\r\n            newErrors.unit = 'Unit required'\r\n        }\r\n        if (form.sale_price < 0) {\r\n            newErrors.sale_price = 'Invalid price'\r\n        }\r\n        if (form.cost_price < 0) {\r\n            newErrors.cost_price = 'Invalid cost'\r\n        }\r\n\r\n        setErrors(newErrors)\r\n        return Object.keys(newErrors).length === 0\r\n    }\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n\r\n        if (!validate()) {\r\n            toast.error('Please correct the errors')\r\n            return\r\n        }\r\n\r\n        setSaving(true)\r\n        try {\r\n            const productId = id || crypto.randomUUID()\r\n            const productData = {\r\n                id: productId,\r\n                sku: form.sku.trim(),\r\n                name: form.name.trim(),\r\n                description: form.description.trim() || null,\r\n                category_id: form.category_id || null,\r\n                product_type: form.product_type,\r\n                unit: form.unit,\r\n                cost_price: form.cost_price,\r\n                retail_price: form.retail_price || form.sale_price,\r\n                wholesale_price: form.wholesale_price || null,\r\n                current_stock: form.stock_quantity,\r\n                min_stock_level: form.min_stock_level || null,\r\n                pos_visible: form.pos_visible,\r\n                is_active: form.is_active,\r\n                image_url: form.image_url || null,\r\n                updated_at: new Date().toISOString()\r\n            }\r\n\r\n            const result = await saveProduct(productData as any)\r\n\r\n            if (!result.success) {\r\n                throw new Error(result.error)\r\n            }\r\n\r\n            if (result.synced) {\r\n                toast.success(isEditing ? 'Product updated' : 'Product created')\r\n            } else {\r\n                toast.success(isEditing ? 'Product updated locally (pending sync)' : 'Product created locally (pending sync)')\r\n            }\r\n\r\n            navigate('/products')\r\n        } catch (error) {\r\n            console.error('Error saving product:', error)\r\n            toast.error('Error during save')\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0]\r\n        if (!file) return\r\n\r\n        try {\r\n            const fileExt = file.name.split('.').pop()\r\n            const fileName = `${form.sku || Date.now()}.${fileExt}`\r\n            const filePath = `products/${fileName}`\r\n\r\n            const { error: uploadError } = await supabase.storage\r\n                .from('images')\r\n                .upload(filePath, file, { upsert: true })\r\n\r\n            if (uploadError) throw uploadError\r\n\r\n            const { data: { publicUrl } } = supabase.storage\r\n                .from('images')\r\n                .getPublicUrl(filePath)\r\n\r\n            setForm(prev => ({ ...prev, image_url: publicUrl }))\r\n            toast.success('Image uploaded')\r\n        } catch (error) {\r\n            console.error('Error uploading image:', error)\r\n            toast.error('Error during upload')\r\n        }\r\n    }\r\n\r\n    const calculateMargin = (): number => {\r\n        if (form.cost_price <= 0 || form.sale_price <= 0) return 0\r\n        return ((form.sale_price - form.cost_price) / form.sale_price) * 100\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"product-form-page loading\">\r\n                <div className=\"spinner\" />\r\n                <span>Loading...</span>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"product-form-page\">\r\n            <header className=\"product-form-page__header\">\r\n                <button className=\"btn btn-ghost\" onClick={() => navigate('/products')}>\r\n                    <ArrowLeft size={20} />\r\n                </button>\r\n                <h1>{isEditing ? 'Edit Product' : 'New Product'}</h1>\r\n            </header>\r\n\r\n            <form className=\"product-form\" onSubmit={handleSubmit}>\r\n                {/* Basic Info Section */}\r\n                <section className=\"form-section\">\r\n                    <h2><Package size={20} /> Basic information</h2>\r\n\r\n                    <div className=\"form-row\">\r\n                        <div className=\"form-group\">\r\n                            <label>SKU *</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={form.sku}\r\n                                onChange={e => setForm({ ...form, sku: e.target.value.toUpperCase() })}\r\n                                placeholder=\"PRD-0001\"\r\n                                className={errors.sku ? 'error' : ''}\r\n                            />\r\n                            {errors.sku && <span className=\"error-text\">{errors.sku}</span>}\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label>Name *</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={form.name}\r\n                                onChange={e => setForm({ ...form, name: e.target.value })}\r\n                                placeholder=\"Product name\"\r\n                                className={errors.name ? 'error' : ''}\r\n                            />\r\n                            {errors.name && <span className=\"error-text\">{errors.name}</span>}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"form-group\">\r\n                        <label>Description</label>\r\n                        <textarea\r\n                            value={form.description}\r\n                            onChange={e => setForm({ ...form, description: e.target.value })}\r\n                            placeholder=\"Product description...\"\r\n                            rows={3}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"form-row\">\r\n                        <div className=\"form-group\">\r\n                            <label>Category</label>\r\n                            <select\r\n                                value={form.category_id}\r\n                                onChange={e => setForm({ ...form, category_id: e.target.value })}\r\n                            >\r\n                                <option value=\"\">No category</option>\r\n                                {categories.map(cat => (\r\n                                    <option key={cat.id} value={cat.id}>{cat.name}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label>Product Type</label>\r\n                            <select\r\n                                value={form.product_type}\r\n                                onChange={e => setForm({ ...form, product_type: e.target.value as ProductForm['product_type'] })}\r\n                            >\r\n                                {PRODUCT_TYPES.map(type => (\r\n                                    <option key={type.value} value={type.value}>{type.label}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label>Unit *</label>\r\n                            <select\r\n                                value={form.unit}\r\n                                onChange={e => setForm({ ...form, unit: e.target.value })}\r\n                                className={errors.unit ? 'error' : ''}\r\n                            >\r\n                                {UNITS.map(unit => (\r\n                                    <option key={unit} value={unit}>{unit}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n\r\n                {/* Pricing Section */}\r\n                <section className=\"form-section\">\r\n                    <h2><DollarSign size={20} /> Price</h2>\r\n\r\n                    <div className=\"form-row\">\r\n                        <div className=\"form-group\">\r\n                            <label>Retail price</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={form.sale_price}\r\n                                onChange={e => setForm({ ...form, sale_price: parseFloat(e.target.value) || 0 })}\r\n                                min=\"0\"\r\n                                step=\"100\"\r\n                                className={errors.sale_price ? 'error' : ''}\r\n                            />\r\n                            <small>{formatCurrency(form.sale_price)}</small>\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label>Wholesale price</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={form.wholesale_price}\r\n                                onChange={e => setForm({ ...form, wholesale_price: parseFloat(e.target.value) || 0 })}\r\n                                min=\"0\"\r\n                                step=\"100\"\r\n                            />\r\n                            <small>{formatCurrency(form.wholesale_price)}</small>\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label>Cost price</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={form.cost_price}\r\n                                onChange={e => setForm({ ...form, cost_price: parseFloat(e.target.value) || 0 })}\r\n                                min=\"0\"\r\n                                step=\"100\"\r\n                                className={errors.cost_price ? 'error' : ''}\r\n                            />\r\n                            <small>{formatCurrency(form.cost_price)}</small>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {form.cost_price > 0 && form.sale_price > 0 && (\r\n                        <div className=\"margin-display\">\r\n                            <Tag size={16} />\r\n                            <span>Margin: {calculateMargin().toFixed(1)}%</span>\r\n                            <span className=\"margin-amount\">\r\n                                ({formatCurrency(form.sale_price - form.cost_price)})\r\n                            </span>\r\n                        </div>\r\n                    )}\r\n                </section>\r\n\r\n                {/* Stock Section */}\r\n                <section className=\"form-section\">\r\n                    <h2><Warehouse size={20} /> Stock</h2>\r\n\r\n                    <div className=\"form-row\">\r\n                        <div className=\"form-group\">\r\n                            <label>Current stock</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={form.stock_quantity}\r\n                                onChange={e => setForm({ ...form, stock_quantity: parseFloat(e.target.value) || 0 })}\r\n                                step=\"0.01\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"form-group\">\r\n                            <label>Minimum stock</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={form.min_stock_level}\r\n                                onChange={e => setForm({ ...form, min_stock_level: parseFloat(e.target.value) || 0 })}\r\n                                min=\"0\"\r\n                                step=\"1\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n\r\n                {/* Image Section */}\r\n                <section className=\"form-section\">\r\n                    <h2><ImageIcon size={20} /> Image</h2>\r\n\r\n                    <div className=\"image-upload\">\r\n                        {form.image_url ? (\r\n                            <div className=\"image-preview\">\r\n                                <img src={form.image_url} alt=\"Product\" />\r\n                                <button\r\n                                    type=\"button\"\r\n                                    className=\"btn-remove-image\"\r\n                                    onClick={() => setForm({ ...form, image_url: '' })}\r\n                                >\r\n                                    <X size={16} />\r\n                                </button>\r\n                            </div>\r\n                        ) : (\r\n                            <label className=\"image-upload-zone\">\r\n                                <Upload size={24} />\r\n                                <span>Click to add an image</span>\r\n                                <input\r\n                                    type=\"file\"\r\n                                    accept=\"image/*\"\r\n                                    onChange={handleImageUpload}\r\n                                    hidden\r\n                                />\r\n                            </label>\r\n                        )}\r\n                    </div>\r\n                </section>\r\n\r\n                {/* Options Section */}\r\n                <section className=\"form-section\">\r\n                    <h2><FileText size={20} /> Options</h2>\r\n\r\n                    <div className=\"form-options\">\r\n                        <label className=\"checkbox-option\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={form.pos_visible}\r\n                                onChange={e => setForm({ ...form, pos_visible: e.target.checked })}\r\n                            />\r\n                            <span>Visible on POS</span>\r\n                        </label>\r\n                        <label className=\"checkbox-option\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={form.is_active}\r\n                                onChange={e => setForm({ ...form, is_active: e.target.checked })}\r\n                            />\r\n                            <span>Product active</span>\r\n                        </label>\r\n                        <label className=\"checkbox-option\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={form.deduct_ingredients}\r\n                                onChange={e => setForm({ ...form, deduct_ingredients: e.target.checked })}\r\n                            />\r\n                            <span>Deduct ingredients on sale</span>\r\n                            <small style={{ display: 'block', marginTop: '4px', color: '#6b7280' }}>\r\n                                For products made to order (coffee, sandwiches, etc.)\r\n                            </small>\r\n                        </label>\r\n                    </div>\r\n                </section>\r\n\r\n                {/* Actions */}\r\n                <div className=\"form-actions\">\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-secondary\"\r\n                        onClick={() => navigate('/products')}\r\n                    >\r\n                        Cancel\r\n                    </button>\r\n                    <button\r\n                        type=\"submit\"\r\n                        className=\"btn btn-primary\"\r\n                        disabled={saving}\r\n                    >\r\n                        <Save size={18} />\r\n                        {saving ? 'Saving...' : 'Save'}\r\n                    </button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\ProductsLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\ProductsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":103,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":119,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":119,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":142,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":142,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { formatCurrency } from '../../utils/helpers'\r\nimport { exportProducts, pushLocalProductsToCloud } from '@/services/products/productImportExport'\r\nimport { exportRecipes } from '@/services/products/recipeImportExport'\r\nimport { db } from '@/lib/db'\r\nimport {\r\n    Cloud, Package, Coffee, Croissant, Search, Plus,\r\n    Eye, Edit, Tag, DollarSign, LayoutGrid, List,\r\n    Upload, Download, ChefHat\r\n} from 'lucide-react'\r\nimport ProductImportModal from '@/components/products/ProductImportModal'\r\nimport RecipeImportModal from '@/components/products/RecipeImportModal'\r\nimport { toast } from 'sonner'\r\nimport './ProductsPage.css'\r\n\r\ninterface Category {\r\n    id: string\r\n    name: string\r\n    color: string | null\r\n}\r\n\r\ninterface Product {\r\n    id: string\r\n    name: string\r\n    sku: string\r\n    category_id: string | null\r\n    category?: Category\r\n    product_type: string\r\n    retail_price: number\r\n    wholesale_price: number | null\r\n    cost_price: number\r\n    pos_visible: boolean\r\n    is_active: boolean\r\n    image_url: string | null\r\n}\r\n\r\ntype ViewMode = 'grid' | 'list'\r\ntype TabType = 'all' | 'finished' | 'semi_finished' | 'raw_material'\r\n\r\nexport default function ProductsPage() {\r\n    const navigate = useNavigate()\r\n    const [products, setProducts] = useState<Product[]>([])\r\n    const [categories, setCategories] = useState<Category[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [categoryFilter, setCategoryFilter] = useState<string>('all')\r\n    const [activeTab, setActiveTab] = useState<TabType>('all')\r\n    const [viewMode, setViewMode] = useState<ViewMode>('list')\r\n    const [showImportModal, setShowImportModal] = useState(false)\r\n    const [showRecipeImportModal, setShowRecipeImportModal] = useState(false)\r\n    const [exporting, setExporting] = useState(false)\r\n    const [exportingRecipes, setExportingRecipes] = useState(false)\r\n    const [syncingToCloud, setSyncingToCloud] = useState(false)\r\n    const [localCount, setLocalCount] = useState(0)\r\n\r\n    useEffect(() => {\r\n        const checkLocalData = async () => {\r\n            const count = await db.offline_products.count()\r\n            setLocalCount(count)\r\n        }\r\n        checkLocalData()\r\n        fetchData()\r\n    }, [])\r\n\r\n    const fetchData = async () => {\r\n        try {\r\n            const [productsRes, categoriesRes] = await Promise.all([\r\n                supabase\r\n                    .from('products')\r\n                    .select(`\r\n                        id, name, sku, category_id, product_type,\r\n                        retail_price, wholesale_price, cost_price,\r\n                        pos_visible, is_active, image_url,\r\n                        category:categories(id, name, color)\r\n                    `)\r\n                    .order('name'),\r\n                supabase\r\n                    .from('categories')\r\n                    .select('id, name, color')\r\n                    .order('name')\r\n            ])\r\n\r\n            if (productsRes.data) setProducts(productsRes.data as unknown as Product[])\r\n            if (categoriesRes.data) setCategories(categoriesRes.data)\r\n        } catch (error) {\r\n            console.error('Error fetching products:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleExport = async () => {\r\n        setExporting(true)\r\n        try {\r\n            const result = await exportProducts()\r\n            if (result.success) {\r\n                toast.success('Export successful')\r\n            } else {\r\n                toast.error(result.error || 'Error during export')\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error during export')\r\n        } finally {\r\n            setExporting(false)\r\n        }\r\n    }\r\n\r\n    const handleExportRecipes = async () => {\r\n        setExportingRecipes(true)\r\n        try {\r\n            const result = await exportRecipes()\r\n            if (result.success) {\r\n                toast.success('Recipes export successful')\r\n            } else {\r\n                toast.error(result.error || 'Error during recipes export')\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error during recipes export')\r\n        } finally {\r\n            setExportingRecipes(false)\r\n        }\r\n    }\r\n\r\n    const handleSyncToCloud = async () => {\r\n        if (syncingToCloud) return\r\n        setSyncingToCloud(true)\r\n        const loadingToast = toast.loading('Syncing products to cloud...')\r\n\r\n        try {\r\n            const result = await pushLocalProductsToCloud()\r\n            toast.dismiss(loadingToast)\r\n\r\n            if (result.success) {\r\n                toast.success(`${result.created} products synced successfully`)\r\n                // Refresh data to show what's now in Supabase\r\n                fetchData()\r\n            } else {\r\n                toast.error(result.errors[0]?.error || 'Error during synchronization')\r\n            }\r\n        } catch (error) {\r\n            toast.dismiss(loadingToast)\r\n            toast.error('Unexpected error during synchronization')\r\n        } finally {\r\n            setSyncingToCloud(false)\r\n        }\r\n    }\r\n\r\n    const stats = useMemo(() => {\r\n        const all = products.length\r\n        const finished = products.filter((p: Product) => p.product_type === 'finished').length\r\n        const semiFinished = products.filter((p: Product) => p.product_type === 'semi_finished').length\r\n        const rawMaterial = products.filter((p: Product) => p.product_type === 'raw_material').length\r\n        return { all, finished, semiFinished, rawMaterial }\r\n    }, [products])\r\n\r\n    const filteredProducts = useMemo(() => {\r\n        return products.filter((product: Product) => {\r\n            const matchesSearch =\r\n                product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                product.sku?.toLowerCase().includes(searchTerm.toLowerCase())\r\n\r\n            const matchesCategory = categoryFilter === 'all' || product.category_id === categoryFilter\r\n\r\n            const matchesTab = activeTab === 'all' || product.product_type === activeTab\r\n\r\n            return matchesSearch && matchesCategory && matchesTab\r\n        })\r\n    }, [products, searchTerm, categoryFilter, activeTab])\r\n\r\n    const getProductTypeIcon = (type: string) => {\r\n        switch (type) {\r\n            case 'finished': return <Coffee size={16} />\r\n            case 'semi_finished': return <Croissant size={16} />\r\n            case 'raw_material': return <Package size={16} />\r\n            default: return <Package size={16} />\r\n        }\r\n    }\r\n\r\n    const getProductTypeLabel = (type: string) => {\r\n        switch (type) {\r\n            case 'finished': return 'Finished Product'\r\n            case 'semi_finished': return 'Semi-Finished'\r\n            case 'raw_material': return 'Raw Material'\r\n            default: return type\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"products-page\">\r\n            {/* Header */}\r\n            <header className=\"products-header\">\r\n                <div className=\"products-header__info\">\r\n                    <h1 className=\"products-header__title\">\r\n                        <Package size={28} />\r\n                        Product Management\r\n                    </h1>\r\n                    <p className=\"products-header__subtitle\">\r\n                        Manage your products, prices and customer category pricing\r\n                    </p>\r\n                </div>\r\n                <div className=\"products-header__actions\">\r\n                    {localCount > 0 && products.length === 0 && (\r\n                        <button\r\n                            type=\"button\"\r\n                            className=\"btn btn-warning\"\r\n                            onClick={handleSyncToCloud}\r\n                            disabled={syncingToCloud}\r\n                            title=\"Push local products to Supabase\"\r\n                        >\r\n                            <Cloud size={18} className={syncingToCloud ? 'animate-spin' : ''} />\r\n                            {syncingToCloud ? 'Sync in progress...' : 'Push to Cloud'}\r\n                        </button>\r\n                    )}\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-outline\"\r\n                        onClick={handleExport}\r\n                        disabled={exporting}\r\n                        title=\"Export products\"\r\n                    >\r\n                        <Download size={18} />\r\n                        {exporting ? 'Export...' : 'Products'}\r\n                    </button>\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-outline\"\r\n                        onClick={() => setShowImportModal(true)}\r\n                        title=\"Import products\"\r\n                    >\r\n                        <Upload size={18} />\r\n                        Products\r\n                    </button>\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-outline\"\r\n                        onClick={handleExportRecipes}\r\n                        disabled={exportingRecipes}\r\n                        title=\"Export recipes\"\r\n                    >\r\n                        <ChefHat size={18} />\r\n                        {exportingRecipes ? 'Export...' : 'Recipes'}\r\n                    </button>\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-outline\"\r\n                        onClick={() => setShowRecipeImportModal(true)}\r\n                        title=\"Import recipes\"\r\n                    >\r\n                        <ChefHat size={18} />\r\n                        <Upload size={14} style={{ marginLeft: -4 }} />\r\n                    </button>\r\n                    <button\r\n                        type=\"button\"\r\n                        className=\"btn btn-primary\"\r\n                        onClick={() => navigate('/products/new')}\r\n                    >\r\n                        <Plus size={18} />\r\n                        New Product\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Stats */}\r\n            <div className=\"products-stats\">\r\n                <div\r\n                    className={`stat-card ${activeTab === 'all' ? 'active' : ''}`}\r\n                    onClick={() => setActiveTab('all')}\r\n                >\r\n                    <Package size={24} />\r\n                    <div className=\"stat-content\">\r\n                        <span className=\"stat-value\">{stats.all}</span>\r\n                        <span className=\"stat-label\">All Products</span>\r\n                    </div>\r\n                </div>\r\n                <div\r\n                    className={`stat-card ${activeTab === 'finished' ? 'active' : ''}`}\r\n                    onClick={() => setActiveTab('finished')}\r\n                >\r\n                    <Coffee size={24} />\r\n                    <div className=\"stat-content\">\r\n                        <span className=\"stat-value\">{stats.finished}</span>\r\n                        <span className=\"stat-label\">Finished Products</span>\r\n                    </div>\r\n                </div>\r\n                <div\r\n                    className={`stat-card ${activeTab === 'semi_finished' ? 'active' : ''}`}\r\n                    onClick={() => setActiveTab('semi_finished')}\r\n                >\r\n                    <Croissant size={24} />\r\n                    <div className=\"stat-content\">\r\n                        <span className=\"stat-value\">{stats.semiFinished}</span>\r\n                        <span className=\"stat-label\">Semi-Finished</span>\r\n                    </div>\r\n                </div>\r\n                <div\r\n                    className={`stat-card ${activeTab === 'raw_material' ? 'active' : ''}`}\r\n                    onClick={() => setActiveTab('raw_material')}\r\n                >\r\n                    <Package size={24} />\r\n                    <div className=\"stat-content\">\r\n                        <span className=\"stat-value\">{stats.rawMaterial}</span>\r\n                        <span className=\"stat-label\">Raw Materials</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <div className=\"products-filters\">\r\n                <div className=\"products-search\">\r\n                    <Search size={20} />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Search by name or SKU...\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                    />\r\n                </div>\r\n                <select\r\n                    value={categoryFilter}\r\n                    onChange={(e) => setCategoryFilter(e.target.value)}\r\n                    className=\"products-filter\"\r\n                    aria-label=\"Filter by category\"\r\n                >\r\n                    <option value=\"all\">All categories</option>\r\n                    {categories.map(cat => (\r\n                        <option key={cat.id} value={cat.id}>{cat.name}</option>\r\n                    ))}\r\n                </select>\r\n                <div className=\"view-toggle\">\r\n                    <button\r\n                        className={`view-btn ${viewMode === 'grid' ? 'active' : ''}`}\r\n                        onClick={() => setViewMode('grid')}\r\n                        title=\"Grid view\"\r\n                        aria-label=\"Grid view\"\r\n                    >\r\n                        <LayoutGrid size={18} />\r\n                    </button>\r\n                    <button\r\n                        className={`view-btn ${viewMode === 'list' ? 'active' : ''}`}\r\n                        onClick={() => setViewMode('list')}\r\n                        title=\"List view\"\r\n                        aria-label=\"List view\"\r\n                    >\r\n                        <List size={18} />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Products List */}\r\n            {loading ? (\r\n                <div className=\"products-loading\">\r\n                    <div className=\"spinner\"></div>\r\n                    <span>Loading products...</span>\r\n                </div>\r\n            ) : filteredProducts.length === 0 ? (\r\n                <div className=\"products-empty\">\r\n                    <Package size={64} />\r\n                    <h3>No product found</h3>\r\n                    <p>\r\n                        {searchTerm || categoryFilter !== 'all'\r\n                            ? 'Try modifying your filters'\r\n                            : 'Start by adding your first product'}\r\n                    </p>\r\n                </div>\r\n            ) : viewMode === 'grid' ? (\r\n                <div className=\"products-grid\">\r\n                    {filteredProducts.map(product => (\r\n                        <div\r\n                            key={product.id}\r\n                            className={`product-card ${!product.is_active ? 'inactive' : ''}`}\r\n                            onClick={() => navigate(`/products/${product.id}`)}\r\n                        >\r\n                            <div className=\"product-card__image\">\r\n                                {product.image_url ? (\r\n                                    <img src={product.image_url} alt={product.name} />\r\n                                ) : (\r\n                                    <div className=\"product-card__placeholder\">\r\n                                        {getProductTypeIcon(product.product_type)}\r\n                                    </div>\r\n                                )}\r\n                                <span className={`product-type-badge ${product.product_type}`}>\r\n                                    {getProductTypeIcon(product.product_type)}\r\n                                    {getProductTypeLabel(product.product_type)}\r\n                                </span>\r\n                            </div>\r\n                            <div className=\"product-card__content\">\r\n                                <h3 className=\"product-card__name\">{product.name}</h3>\r\n                                <span className=\"product-card__sku\">{product.sku}</span>\r\n                                {product.category && (\r\n                                    <span\r\n                                        className=\"product-card__category\"\r\n                                        style={{ backgroundColor: product.category.color || '#6366f1' }}\r\n                                    >\r\n                                        <Tag size={12} />\r\n                                        {product.category.name}\r\n                                    </span>\r\n                                )}\r\n                                <div className=\"product-card__prices\">\r\n                                    <div className=\"price\">\r\n                                        <span className=\"price-label\">Retail</span>\r\n                                        <span className=\"price-value\">{formatCurrency(product.retail_price)}</span>\r\n                                    </div>\r\n                                    {product.wholesale_price && (\r\n                                        <div className=\"price\">\r\n                                            <span className=\"price-label\">Wholesale</span>\r\n                                            <span className=\"price-value\">{formatCurrency(product.wholesale_price)}</span>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"product-card__footer\">\r\n                                <span className={`status-badge ${product.is_active ? 'active' : 'inactive'}`}>\r\n                                    {product.is_active ? 'Active' : 'Inactive'}\r\n                                </span>\r\n                                <span className={`pos-badge ${product.pos_visible ? 'visible' : ''}`}>\r\n                                    {product.pos_visible ? 'POS' : 'Hidden'}\r\n                                </span>\r\n                            </div>\r\n                            <div className=\"product-card__actions\">\r\n                                <button\r\n                                    className=\"btn-icon\"\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation()\r\n                                        navigate(`/products/${product.id}`)\r\n                                    }}\r\n                                    title=\"View details\"\r\n                                    aria-label=\"View details\"\r\n                                >\r\n                                    <Eye size={16} />\r\n                                </button>\r\n                                <button\r\n                                    className=\"btn-icon\"\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation()\r\n                                        navigate(`/products/${product.id}/edit`)\r\n                                    }}\r\n                                    title=\"Edit\"\r\n                                    aria-label=\"Edit\"\r\n                                >\r\n                                    <Edit size={16} />\r\n                                </button>\r\n                                <button\r\n                                    className=\"btn-icon\"\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation()\r\n                                        navigate(`/products/${product.id}/pricing`)\r\n                                    }}\r\n                                    title=\"Price by category\"\r\n                                    aria-label=\"Price by category\"\r\n                                >\r\n                                    <DollarSign size={16} />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            ) : (\r\n                <div className=\"products-table\">\r\n                    <table>\r\n                        <thead>\r\n                            <tr>\r\n                                <th>Product</th>\r\n                                <th>SKU</th>\r\n                                <th>Type</th>\r\n                                <th>Category</th>\r\n                                <th className=\"text-right\">Retail Price</th>\r\n                                <th className=\"text-right\">Wholesale Price</th>\r\n                                <th>Status</th>\r\n                                <th>Actions</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {filteredProducts.map(product => (\r\n                                <tr\r\n                                    key={product.id}\r\n                                    className={!product.is_active ? 'inactive' : ''}\r\n                                    onClick={() => navigate(`/products/${product.id}`)}\r\n                                >\r\n                                    <td className=\"product-name-cell\">\r\n                                        <span className=\"product-name\">{product.name}</span>\r\n                                    </td>\r\n                                    <td className=\"sku-cell\">{product.sku}</td>\r\n                                    <td>\r\n                                        <span className={`type-badge ${product.product_type}`}>\r\n                                            {getProductTypeIcon(product.product_type)}\r\n                                            {getProductTypeLabel(product.product_type)}\r\n                                        </span>\r\n                                    </td>\r\n                                    <td>\r\n                                        {product.category && (\r\n                                            <span\r\n                                                className=\"category-badge\"\r\n                                                style={{ backgroundColor: product.category.color || '#6366f1' }}\r\n                                            >\r\n                                                {product.category.name}\r\n                                            </span>\r\n                                        )}\r\n                                    </td>\r\n                                    <td className=\"text-right price-cell\">\r\n                                        {formatCurrency(product.retail_price)}\r\n                                    </td>\r\n                                    <td className=\"text-right price-cell\">\r\n                                        {product.wholesale_price ? formatCurrency(product.wholesale_price) : '-'}\r\n                                    </td>\r\n                                    <td>\r\n                                        <span className={`status-badge ${product.is_active ? 'active' : 'inactive'}`}>\r\n                                            {product.is_active ? 'Active' : 'Inactive'}\r\n                                        </span>\r\n                                    </td>\r\n                                    <td className=\"actions-cell\">\r\n                                        <button\r\n                                            className=\"btn-icon\"\r\n                                            onClick={(e) => {\r\n                                                e.stopPropagation()\r\n                                                navigate(`/products/${product.id}`)\r\n                                            }}\r\n                                            title=\"View\"\r\n                                            aria-label=\"View\"\r\n                                        >\r\n                                            <Eye size={16} />\r\n                                        </button>\r\n                                        <button\r\n                                            className=\"btn-icon\"\r\n                                            onClick={(e) => {\r\n                                                e.stopPropagation()\r\n                                                navigate(`/products/${product.id}/pricing`)\r\n                                            }}\r\n                                            title=\"Prices\"\r\n                                            aria-label=\"Prices\"\r\n                                        >\r\n                                            <DollarSign size={16} />\r\n                                        </button>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            )}\r\n\r\n            {/* Import Modal */}\r\n            {showImportModal && (\r\n                <ProductImportModal\r\n                    onClose={() => setShowImportModal(false)}\r\n                    onSuccess={() => {\r\n                        fetchData()\r\n                    }}\r\n                />\r\n            )}\r\n\r\n            {/* Recipe Import Modal */}\r\n            {showRecipeImportModal && (\r\n                <RecipeImportModal\r\n                    onClose={() => setShowRecipeImportModal(false)}\r\n                    onSuccess={() => {\r\n                        toast.success('Recipes imported successfully')\r\n                    }}\r\n                />\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\PromotionFormPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":108,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":108,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4141,4144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4141,4144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":171,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":171,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":307,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":307,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11979,11982],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11979,11982],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":317,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":317,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12341,12344],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12341,12344],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate, useParams } from 'react-router-dom'\r\nimport {\r\n    ArrowLeft, Save, Tag, Percent, Gift, ShoppingBag,\r\n    Calendar, Clock, Search, X, Plus, Sparkles, Info\r\n} from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { Product, PromotionType } from '../../types/database'\r\nimport { formatCurrency } from '../../utils/helpers'\r\nimport { toast } from 'sonner'\r\nimport './PromotionFormPage.css'\r\n\r\ninterface PromotionFormData {\r\n    code: string\r\n    name: string\r\n    description: string\r\n    promotion_type: PromotionType\r\n    discount_percentage: number\r\n    discount_amount: number\r\n    buy_quantity: number\r\n    get_quantity: number\r\n    min_purchase_amount: number\r\n    max_uses_total: number | null\r\n    max_uses_per_customer: number | null\r\n    start_date: string\r\n    end_date: string\r\n    days_of_week: number[]\r\n    time_start: string\r\n    time_end: string\r\n    priority: number\r\n    is_stackable: boolean\r\n    is_active: boolean\r\n}\r\n\r\nconst PROMOTION_TYPES: { type: PromotionType; label: string; desc: string; icon: typeof Percent }[] = [\r\n    { type: 'percentage', label: 'Discount %', desc: 'Percentage discount', icon: Percent },\r\n    { type: 'fixed_amount', label: 'Fixed amount', desc: 'Discount in Rupiah', icon: Tag },\r\n    { type: 'buy_x_get_y', label: 'Buy X, Get Y', desc: 'Quantity offer', icon: ShoppingBag },\r\n    { type: 'free_product', label: 'Free product', desc: 'Gift with purchase', icon: Gift }\r\n]\r\n\r\nconst DAYS_OF_WEEK = [\r\n    { value: 0, label: 'Sun', full: 'Sunday' },\r\n    { value: 1, label: 'Mon', full: 'Monday' },\r\n    { value: 2, label: 'Tue', full: 'Tuesday' },\r\n    { value: 3, label: 'Wed', full: 'Wednesday' },\r\n    { value: 4, label: 'Thu', full: 'Thursday' },\r\n    { value: 5, label: 'Fri', full: 'Friday' },\r\n    { value: 6, label: 'Sat', full: 'Saturday' }\r\n]\r\n\r\nconst initialFormData: PromotionFormData = {\r\n    code: '',\r\n    name: '',\r\n    description: '',\r\n    promotion_type: 'percentage',\r\n    discount_percentage: 10,\r\n    discount_amount: 0,\r\n    buy_quantity: 2,\r\n    get_quantity: 1,\r\n    min_purchase_amount: 0,\r\n    max_uses_total: null,\r\n    max_uses_per_customer: null,\r\n    start_date: '',\r\n    end_date: '',\r\n    days_of_week: [],\r\n    time_start: '',\r\n    time_end: '',\r\n    priority: 0,\r\n    is_stackable: false,\r\n    is_active: true\r\n}\r\n\r\nexport default function PromotionFormPage() {\r\n    const { id } = useParams()\r\n    const navigate = useNavigate()\r\n    const isEditing = !!id\r\n\r\n    const [loading, setLoading] = useState(false)\r\n    const [saving, setSaving] = useState(false)\r\n    const [form, setForm] = useState<PromotionFormData>(initialFormData)\r\n    const [errors, setErrors] = useState<Partial<Record<keyof PromotionFormData, string>>>({})\r\n\r\n    // Product selection\r\n    const [products, setProducts] = useState<Product[]>([])\r\n    const [selectedProducts, setSelectedProducts] = useState<Product[]>([])\r\n    const [freeProducts, setFreeProducts] = useState<Product[]>([])\r\n    const [showProductSearch, setShowProductSearch] = useState<'applicable' | 'free' | null>(null)\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n\r\n    useEffect(() => {\r\n        fetchProducts()\r\n        if (isEditing) {\r\n            fetchPromotion()\r\n        }\r\n    }, [id])\r\n\r\n    const fetchProducts = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('products')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .order('name')\r\n\r\n            if (error) throw error\r\n            if (data) setProducts(data)\r\n        } catch (error) {\r\n            toast.error('Error loading products')\r\n        }\r\n    }\r\n\r\n    const fetchPromotion = async () => {\r\n        if (!id) return\r\n        setLoading(true)\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('promotions')\r\n                .select('*')\r\n                .eq('id', id)\r\n                .single()\r\n\r\n            if (error) throw error\r\n            if (data) {\r\n                const d = data as any\r\n                setForm({\r\n                    code: d.code || '',\r\n                    name: data.name,\r\n                    description: data.description || '',\r\n                    promotion_type: data.promotion_type as PromotionType,\r\n                    discount_percentage: data.discount_percentage || 0,\r\n                    discount_amount: data.discount_amount || 0,\r\n                    buy_quantity: data.buy_quantity || 2,\r\n                    get_quantity: data.get_quantity || 1,\r\n                    min_purchase_amount: data.min_purchase_amount || 0,\r\n                    max_uses_total: d.max_uses_total || null,\r\n                    max_uses_per_customer: d.max_uses_per_customer || null,\r\n                    start_date: data.start_date || '',\r\n                    end_date: data.end_date || '',\r\n                    days_of_week: data.days_of_week || [],\r\n                    time_start: d.time_start || '',\r\n                    time_end: d.time_end || '',\r\n                    priority: data.priority || 0,\r\n                    is_stackable: d.is_stackable ?? false,\r\n                    is_active: data.is_active ?? true\r\n                })\r\n\r\n                // Fetch associated products\r\n                const { data: promoProducts } = await supabase\r\n                    .from('promotion_products')\r\n                    .select('product:products(*)')\r\n                    .eq('promotion_id', id)\r\n\r\n                if (promoProducts) {\r\n                    type PromoProductRow = { product: Product | null };\r\n                    const rawData = promoProducts as unknown as PromoProductRow[];\r\n                    setSelectedProducts(rawData.map((pp) => pp.product).filter((p): p is Product => p !== null))\r\n                }\r\n\r\n                const { data: promoFreeProducts } = await supabase\r\n                    .from('promotion_free_products')\r\n                    .select('product:products(*)')\r\n                    .eq('promotion_id', id)\r\n\r\n                if (promoFreeProducts) {\r\n                    type PromoFreeProductRow = { product: Product | null };\r\n                    const rawFreeData = promoFreeProducts as unknown as PromoFreeProductRow[];\r\n                    setFreeProducts(rawFreeData.map((pp) => pp.product).filter((p): p is Product => p !== null))\r\n                }\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error loading promotion')\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const updateField = useCallback(<K extends keyof PromotionFormData>(\r\n        field: K,\r\n        value: PromotionFormData[K]\r\n    ) => {\r\n        setForm(prev => ({ ...prev, [field]: value }))\r\n        if (errors[field]) {\r\n            setErrors(prev => ({ ...prev, [field]: undefined }))\r\n        }\r\n    }, [errors])\r\n\r\n    const toggleDay = (day: number) => {\r\n        setForm(prev => ({\r\n            ...prev,\r\n            days_of_week: prev.days_of_week.includes(day)\r\n                ? prev.days_of_week.filter(d => d !== day)\r\n                : [...prev.days_of_week, day].sort()\r\n        }))\r\n    }\r\n\r\n    const addProduct = (product: Product, type: 'applicable' | 'free') => {\r\n        if (type === 'applicable') {\r\n            if (!selectedProducts.find(p => p.id === product.id)) {\r\n                setSelectedProducts(prev => [...prev, product])\r\n            }\r\n        } else {\r\n            if (!freeProducts.find(p => p.id === product.id)) {\r\n                setFreeProducts(prev => [...prev, product])\r\n            }\r\n        }\r\n        setShowProductSearch(null)\r\n        setSearchTerm('')\r\n    }\r\n\r\n    const removeProduct = (productId: string, type: 'applicable' | 'free') => {\r\n        if (type === 'applicable') {\r\n            setSelectedProducts(prev => prev.filter(p => p.id !== productId))\r\n        } else {\r\n            setFreeProducts(prev => prev.filter(p => p.id !== productId))\r\n        }\r\n    }\r\n\r\n    const filteredProducts = products.filter(p =>\r\n        p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        p.sku?.toLowerCase().includes(searchTerm.toLowerCase())\r\n    )\r\n\r\n    const validate = (): boolean => {\r\n        const newErrors: Partial<Record<keyof PromotionFormData, string>> = {}\r\n\r\n        if (!form.code.trim()) newErrors.code = 'Code required'\r\n        if (!form.name.trim()) newErrors.name = 'Name required'\r\n\r\n        if (form.promotion_type === 'percentage' && (form.discount_percentage <= 0 || form.discount_percentage > 100)) {\r\n            newErrors.discount_percentage = 'Between 1% and 100%'\r\n        }\r\n        if (form.promotion_type === 'fixed_amount' && form.discount_amount <= 0) {\r\n            newErrors.discount_amount = 'Amount required'\r\n        }\r\n        if (form.promotion_type === 'buy_x_get_y' && (form.buy_quantity < 1 || form.get_quantity < 1)) {\r\n            newErrors.buy_quantity = 'Quantities required'\r\n        }\r\n\r\n        if (form.start_date && form.end_date && new Date(form.start_date) > new Date(form.end_date)) {\r\n            newErrors.end_date = 'End date after start date'\r\n        }\r\n\r\n        setErrors(newErrors)\r\n        return Object.keys(newErrors).length === 0\r\n    }\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n        if (!validate()) return\r\n\r\n        setSaving(true)\r\n        try {\r\n            const promotionData = {\r\n                code: form.code,\r\n                name: form.name,\r\n                description: form.description || null,\r\n                promotion_type: form.promotion_type,\r\n                discount_percentage: form.promotion_type === 'percentage' ? form.discount_percentage : null,\r\n                discount_amount: form.promotion_type === 'fixed_amount' ? form.discount_amount : null,\r\n                buy_quantity: form.promotion_type === 'buy_x_get_y' ? form.buy_quantity : null,\r\n                get_quantity: form.promotion_type === 'buy_x_get_y' ? form.get_quantity : null,\r\n                min_purchase_amount: form.min_purchase_amount || null,\r\n                start_date: form.start_date || null,\r\n                end_date: form.end_date || null,\r\n                days_of_week: form.days_of_week.length > 0 ? form.days_of_week : null,\r\n                time_start: form.time_start || null,\r\n                time_end: form.time_end || null,\r\n                max_uses_total: form.max_uses_total,\r\n                max_uses_per_customer: form.max_uses_per_customer,\r\n                priority: form.priority,\r\n                is_stackable: form.is_stackable,\r\n                is_active: form.is_active\r\n            }\r\n\r\n            let promotionId: string\r\n\r\n            if (isEditing) {\r\n                const { error } = await supabase\r\n                    .from('promotions')\r\n                    .update(promotionData as never)\r\n                    .eq('id', id!)\r\n\r\n                if (error) throw error\r\n                promotionId = id!\r\n\r\n                // Clean up existing relations\r\n                await supabase.from('promotion_products').delete().eq('promotion_id', promotionId)\r\n                await supabase.from('promotion_free_products').delete().eq('promotion_id', promotionId)\r\n            } else {\r\n                const { data, error } = await supabase\r\n                    .from('promotions')\r\n                    .insert(promotionData as never)\r\n                    .select()\r\n                    .single()\r\n\r\n                if (error) throw error\r\n                promotionId = data.id\r\n            }\r\n\r\n            // Insert product relations\r\n            if (selectedProducts.length > 0) {\r\n                await supabase.from('promotion_products').insert(\r\n                    selectedProducts.map(p => ({\r\n                        promotion_id: promotionId,\r\n                        product_id: p.id\r\n                    })) as any\r\n                )\r\n            }\r\n\r\n            if (freeProducts.length > 0) {\r\n                await supabase.from('promotion_free_products').insert(\r\n                    freeProducts.map(p => ({\r\n                        promotion_id: promotionId,\r\n                        product_id: p.id,\r\n                        quantity: 1\r\n                    })) as any\r\n                )\r\n            }\r\n\r\n            toast.success(isEditing ? 'Promotion updated' : 'Promotion created')\r\n            navigate('/products/promotions')\r\n        } catch (error) {\r\n            toast.error(error instanceof Error ? error.message : 'Error saving promotion')\r\n        } finally {\r\n            setSaving(false)\r\n        }\r\n    }\r\n\r\n    const getPreviewValue = (): string => {\r\n        switch (form.promotion_type) {\r\n            case 'percentage':\r\n                return `-${form.discount_percentage}%`\r\n            case 'fixed_amount':\r\n                return `-${formatCurrency(form.discount_amount)}`\r\n            case 'buy_x_get_y':\r\n                return `${form.buy_quantity} + ${form.get_quantity} free`\r\n            case 'free_product':\r\n                return 'Free gift'\r\n            default:\r\n                return ''\r\n        }\r\n    }\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"promo-form-page\">\r\n                <div className=\"promo-loading\">\r\n                    <div className=\"promo-loading-spinner\" />\r\n                    <span className=\"promo-loading-text\">Loading promotion...</span>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"promo-form-page\">\r\n            {/* Header */}\r\n            <header className=\"promo-form-header\">\r\n                <button\r\n                    type=\"button\"\r\n                    className=\"btn-back-promo\"\r\n                    onClick={() => navigate('/products/promotions')}\r\n                >\r\n                    <ArrowLeft size={18} />\r\n                    Back\r\n                </button>\r\n                <div className=\"promo-form-title\">\r\n                    <h1>\r\n                        <Sparkles size={28} />\r\n                        {isEditing ? 'Edit Promotion' : 'New Promotion'}\r\n                    </h1>\r\n                    <span>Create irresistible offers for your customers</span>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Form Container */}\r\n            <div className=\"promo-form-container\">\r\n                <form onSubmit={handleSubmit} className=\"promo-form\">\r\n                    {/* Left Column - Basic Info */}\r\n                    <div className=\"promo-section\">\r\n                        <h2 className=\"promo-section-title\">\r\n                            <Tag size={20} />\r\n                            Basic Information\r\n                        </h2>\r\n\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label promo-label-required\">Promotion code</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                className={`promo-input ${errors.code ? 'error' : ''}`}\r\n                                value={form.code}\r\n                                onChange={(e) => updateField('code', e.target.value.toUpperCase())}\r\n                                placeholder=\"Ex: CROISSANT20\"\r\n                                maxLength={20}\r\n                            />\r\n                            {errors.code && <span className=\"promo-error-text\"><Info size={12} />{errors.code}</span>}\r\n                            <span className=\"promo-hint\">Unique code to apply the promotion</span>\r\n                        </div>\r\n\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label promo-label-required\">Offer Name</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                className={`promo-input ${errors.name ? 'error' : ''}`}\r\n                                value={form.name}\r\n                                onChange={(e) => updateField('name', e.target.value)}\r\n                                placeholder=\"Ex: Baker's Breakfast Special\"\r\n                            />\r\n                            {errors.name && <span className=\"promo-error-text\"><Info size={12} />{errors.name}</span>}\r\n                        </div>\r\n\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label\">Description</label>\r\n                            <textarea\r\n                                className=\"promo-textarea\"\r\n                                value={form.description}\r\n                                onChange={(e) => updateField('description', e.target.value)}\r\n                                placeholder=\"Describe your promotional offer...\"\r\n                                rows={3}\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Promotion Type Selection */}\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label promo-label-required\">Promotion type</label>\r\n                            <div className=\"promo-type-grid\">\r\n                                {PROMOTION_TYPES.map(({ type, label, desc, icon: Icon }) => (\r\n                                    <div\r\n                                        key={type}\r\n                                        className={`promo-type-card ${form.promotion_type === type ? 'selected' : ''}`}\r\n                                        onClick={() => updateField('promotion_type', type)}\r\n                                    >\r\n                                        <div className=\"promo-type-icon\">\r\n                                            <Icon size={24} />\r\n                                        </div>\r\n                                        <div className=\"promo-type-name\">{label}</div>\r\n                                        <div className=\"promo-type-desc\">{desc}</div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Conditional Fields based on type */}\r\n                        <div className=\"promo-conditional\">\r\n                            <div className=\"promo-conditional-title\">\r\n                                <Sparkles size={16} />\r\n                                Discount settings\r\n                            </div>\r\n\r\n                            {form.promotion_type === 'percentage' && (\r\n                                <div className=\"promo-field\">\r\n                                    <label className=\"promo-label promo-label-required\">Discount percentage</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        className={`promo-input ${errors.discount_percentage ? 'error' : ''}`}\r\n                                        value={form.discount_percentage}\r\n                                        onChange={(e) => updateField('discount_percentage', Number(e.target.value))}\r\n                                        min={1}\r\n                                        max={100}\r\n                                    />\r\n                                    {errors.discount_percentage && (\r\n                                        <span className=\"promo-error-text\"><Info size={12} />{errors.discount_percentage}</span>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n\r\n                            {form.promotion_type === 'fixed_amount' && (\r\n                                <div className=\"promo-field\">\r\n                                    <label className=\"promo-label promo-label-required\">Discount amount (IDR)</label>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        className={`promo-input ${errors.discount_amount ? 'error' : ''}`}\r\n                                        value={form.discount_amount}\r\n                                        onChange={(e) => updateField('discount_amount', Number(e.target.value))}\r\n                                        min={0}\r\n                                        step={1000}\r\n                                    />\r\n                                    {errors.discount_amount && (\r\n                                        <span className=\"promo-error-text\"><Info size={12} />{errors.discount_amount}</span>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n\r\n                            {form.promotion_type === 'buy_x_get_y' && (\r\n                                <div className=\"promo-row\">\r\n                                    <div className=\"promo-field\">\r\n                                        <label className=\"promo-label promo-label-required\">Buy (X)</label>\r\n                                        <input\r\n                                            type=\"number\"\r\n                                            className={`promo-input ${errors.buy_quantity ? 'error' : ''}`}\r\n                                            value={form.buy_quantity}\r\n                                            onChange={(e) => updateField('buy_quantity', Number(e.target.value))}\r\n                                            min={1}\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"promo-field\">\r\n                                        <label className=\"promo-label promo-label-required\">Get free (Y)</label>\r\n                                        <input\r\n                                            type=\"number\"\r\n                                            className=\"promo-input\"\r\n                                            value={form.get_quantity}\r\n                                            onChange={(e) => updateField('get_quantity', Number(e.target.value))}\r\n                                            min={1}\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {form.promotion_type === 'free_product' && (\r\n                                <div className=\"promo-products-panel\">\r\n                                    <div className=\"promo-products-header\">\r\n                                        <div>\r\n                                            <div className=\"promo-products-title\">Free products</div>\r\n                                            <div className=\"promo-products-subtitle\">Select gifts</div>\r\n                                        </div>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            className=\"btn-add-product\"\r\n                                            onClick={() => setShowProductSearch('free')}\r\n                                        >\r\n                                            <Plus size={16} />\r\n                                            Add\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {showProductSearch === 'free' && (\r\n                                        <div className=\"promo-product-search\">\r\n                                            <div className=\"promo-search-input-wrap\">\r\n                                                <Search size={18} />\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    className=\"promo-search-input\"\r\n                                                    value={searchTerm}\r\n                                                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                                                    placeholder=\"Search for a product...\"\r\n                                                    autoFocus\r\n                                                />\r\n                                            </div>\r\n                                            {searchTerm && (\r\n                                                <div className=\"promo-search-results\">\r\n                                                    {filteredProducts.slice(0, 8).map(product => (\r\n                                                        <div\r\n                                                            key={product.id}\r\n                                                            className=\"promo-search-item\"\r\n                                                            onClick={() => addProduct(product, 'free')}\r\n                                                        >\r\n                                                            <div>\r\n                                                                <div className=\"promo-search-item-name\">{product.name}</div>\r\n                                                                <div className=\"promo-search-item-sku\">{product.sku}</div>\r\n                                                            </div>\r\n                                                            <div className=\"promo-search-item-price\">\r\n                                                                {formatCurrency(product.retail_price || 0)}\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    ))}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <div className=\"promo-selected-products\">\r\n                                        {freeProducts.length === 0 ? (\r\n                                            <div className=\"promo-no-products\">\r\n                                                No free product selected\r\n                                            </div>\r\n                                        ) : (\r\n                                            freeProducts.map(product => (\r\n                                                <div key={product.id} className=\"promo-selected-item\">\r\n                                                    <div className=\"promo-selected-item-info\">\r\n                                                        <div className=\"promo-selected-item-name\">{product.name}</div>\r\n                                                        <div className=\"promo-selected-item-sku\">{product.sku}</div>\r\n                                                    </div>\r\n                                                    <button\r\n                                                        type=\"button\"\r\n                                                        className=\"btn-remove-product\"\r\n                                                        onClick={() => removeProduct(product.id, 'free')}\r\n                                                    >\r\n                                                        <X size={18} />\r\n                                                    </button>\r\n                                                </div>\r\n                                            ))\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Right Column - Constraints & Limits */}\r\n                    <div className=\"promo-section\">\r\n                        <h2 className=\"promo-section-title\">\r\n                            <Calendar size={20} />\r\n                            Time Constraints\r\n                        </h2>\r\n\r\n                        <div className=\"promo-row\">\r\n                            <div className=\"promo-field\">\r\n                                <label className=\"promo-label\">Start date</label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    className=\"promo-input\"\r\n                                    value={form.start_date}\r\n                                    onChange={(e) => updateField('start_date', e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <div className=\"promo-field\">\r\n                                <label className=\"promo-label\">End date</label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    className={`promo-input ${errors.end_date ? 'error' : ''}`}\r\n                                    value={form.end_date}\r\n                                    onChange={(e) => updateField('end_date', e.target.value)}\r\n                                />\r\n                                {errors.end_date && (\r\n                                    <span className=\"promo-error-text\"><Info size={12} />{errors.end_date}</span>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label\">Days of the week</label>\r\n                            <div className=\"promo-days-grid\">\r\n                                {DAYS_OF_WEEK.map(day => (\r\n                                    <button\r\n                                        key={day.value}\r\n                                        type=\"button\"\r\n                                        className={`promo-day-btn ${form.days_of_week.includes(day.value) ? 'active' : ''}`}\r\n                                        onClick={() => toggleDay(day.value)}\r\n                                        title={day.full}\r\n                                    >\r\n                                        {day.label}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                            <span className=\"promo-hint\">Leave blank for all days</span>\r\n                        </div>\r\n\r\n                        <div className=\"promo-row\">\r\n                            <div className=\"promo-field\">\r\n                                <label className=\"promo-label\">Start time</label>\r\n                                <input\r\n                                    type=\"time\"\r\n                                    className=\"promo-input\"\r\n                                    value={form.time_start}\r\n                                    onChange={(e) => updateField('time_start', e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <div className=\"promo-field\">\r\n                                <label className=\"promo-label\">End time</label>\r\n                                <input\r\n                                    type=\"time\"\r\n                                    className=\"promo-input\"\r\n                                    value={form.time_end}\r\n                                    onChange={(e) => updateField('time_end', e.target.value)}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <h2 className=\"promo-section-title\" style={{ marginTop: '2rem' }}>\r\n                            <Clock size={20} />\r\n                            Usage Limits\r\n                        </h2>\r\n\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label\">Minimum purchase (IDR)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                className=\"promo-input\"\r\n                                value={form.min_purchase_amount}\r\n                                onChange={(e) => updateField('min_purchase_amount', Number(e.target.value))}\r\n                                min={0}\r\n                                step={1000}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"promo-row\">\r\n                            <div className=\"promo-field\">\r\n                                <label className=\"promo-label\">Max uses (total)</label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    className=\"promo-input\"\r\n                                    value={form.max_uses_total || ''}\r\n                                    onChange={(e) => updateField('max_uses_total', e.target.value ? Number(e.target.value) : null)}\r\n                                    min={0}\r\n                                    placeholder=\"Unlimited\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"promo-field\">\r\n                                <label className=\"promo-label\">Max per customer</label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    className=\"promo-input\"\r\n                                    value={form.max_uses_per_customer || ''}\r\n                                    onChange={(e) => updateField('max_uses_per_customer', e.target.value ? Number(e.target.value) : null)}\r\n                                    min={0}\r\n                                    placeholder=\"Unlimited\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"promo-field\">\r\n                            <label className=\"promo-label\">Priority</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                className=\"promo-input\"\r\n                                value={form.priority}\r\n                                onChange={(e) => updateField('priority', Number(e.target.value))}\r\n                                min={0}\r\n                            />\r\n                            <span className=\"promo-hint\">Higher priority promotions apply first</span>\r\n                        </div>\r\n\r\n                        {/* Toggles */}\r\n                        <div\r\n                            className={`promo-toggle ${form.is_stackable ? 'active' : ''}`}\r\n                            onClick={() => updateField('is_stackable', !form.is_stackable)}\r\n                        >\r\n                            <div className=\"promo-toggle-track\">\r\n                                <div className=\"promo-toggle-thumb\" />\r\n                            </div>\r\n                            <div>\r\n                                <div className=\"promo-toggle-label\">Stackable</div>\r\n                                <div className=\"promo-toggle-desc\">Can be combined with other promotions</div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div\r\n                            className={`promo-toggle ${form.is_active ? 'active' : ''}`}\r\n                            onClick={() => updateField('is_active', !form.is_active)}\r\n                        >\r\n                            <div className=\"promo-toggle-track\">\r\n                                <div className=\"promo-toggle-thumb\" />\r\n                            </div>\r\n                            <div>\r\n                                <div className=\"promo-toggle-label\">Active</div>\r\n                                <div className=\"promo-toggle-desc\">Promotion is available for customers</div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Applicable Products */}\r\n                        <div className=\"promo-products-panel\" style={{ marginTop: '1.5rem' }}>\r\n                            <div className=\"promo-products-header\">\r\n                                <div>\r\n                                    <div className=\"promo-products-title\">Applicable products</div>\r\n                                    <div className=\"promo-products-subtitle\">Leave blank for all products</div>\r\n                                </div>\r\n                                <button\r\n                                    type=\"button\"\r\n                                    className=\"btn-add-product\"\r\n                                    onClick={() => setShowProductSearch('applicable')}\r\n                                >\r\n                                    <Plus size={16} />\r\n                                    Add\r\n                                </button>\r\n                            </div>\r\n\r\n                            {showProductSearch === 'applicable' && (\r\n                                <div className=\"promo-product-search\">\r\n                                    <div className=\"promo-search-input-wrap\">\r\n                                        <Search size={18} />\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            className=\"promo-search-input\"\r\n                                            value={searchTerm}\r\n                                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                                            placeholder=\"Search for a product...\"\r\n                                            autoFocus\r\n                                        />\r\n                                    </div>\r\n                                    {searchTerm && (\r\n                                        <div className=\"promo-search-results\">\r\n                                            {filteredProducts.slice(0, 8).map(product => (\r\n                                                <div\r\n                                                    key={product.id}\r\n                                                    className=\"promo-search-item\"\r\n                                                    onClick={() => addProduct(product, 'applicable')}\r\n                                                >\r\n                                                    <div>\r\n                                                        <div className=\"promo-search-item-name\">{product.name}</div>\r\n                                                        <div className=\"promo-search-item-sku\">{product.sku}</div>\r\n                                                    </div>\r\n                                                    <div className=\"promo-search-item-price\">\r\n                                                        {formatCurrency(product.retail_price || 0)}\r\n                                                    </div>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n\r\n                            <div className=\"promo-selected-products\">\r\n                                {selectedProducts.length === 0 ? (\r\n                                    <div className=\"promo-no-products\">\r\n                                        All products are eligible\r\n                                    </div>\r\n                                ) : (\r\n                                    selectedProducts.map(product => (\r\n                                        <div key={product.id} className=\"promo-selected-item\">\r\n                                            <div className=\"promo-selected-item-info\">\r\n                                                <div className=\"promo-selected-item-name\">{product.name}</div>\r\n                                                <div className=\"promo-selected-item-sku\">{product.sku}</div>\r\n                                            </div>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                className=\"btn-remove-product\"\r\n                                                onClick={() => removeProduct(product.id, 'applicable')}\r\n                                            >\r\n                                                <X size={18} />\r\n                                            </button>\r\n                                        </div>\r\n                                    ))\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Preview Section */}\r\n                    {form.name && (\r\n                        <div className=\"promo-preview-section promo-section\">\r\n                            <div className=\"promo-preview-card\">\r\n                                <div className=\"promo-preview-badge\">{form.code || 'CODE'}</div>\r\n                                <div className=\"promo-preview-value\">{getPreviewValue()}</div>\r\n                                <div className=\"promo-preview-desc\">{form.name}</div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Form Actions */}\r\n                    <div className=\"promo-form-actions\">\r\n                        <button\r\n                            type=\"button\"\r\n                            className=\"btn-promo-secondary\"\r\n                            onClick={() => navigate('/products/promotions')}\r\n                            disabled={saving}\r\n                        >\r\n                            Cancel\r\n                        </button>\r\n                        <button\r\n                            type=\"submit\"\r\n                            className=\"btn-promo-primary\"\r\n                            disabled={saving}\r\n                        >\r\n                            {saving ? (\r\n                                <>\r\n                                    <div className=\"promo-spinner-sm\" />\r\n                                    Saving...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Save size={18} />\r\n                                    {isEditing ? 'Update' : 'Create Promotion'}\r\n                                </>\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\products\\PromotionsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\profile\\ProfilePage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":272,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":272,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8967,8970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8967,8970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":501,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":501,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18942,18945],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18942,18945],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport {\r\n  User, Key, Shield, Clock, LogOut, Save,\r\n  RefreshCw, Check, X, Camera, Smartphone, Monitor\r\n} from 'lucide-react';\r\nimport { useAuthStore } from '../../stores/authStore';\r\nimport { usePermissions } from '../../hooks/usePermissions';\r\nimport { authService } from '../../services/authService';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { format } from 'date-fns';\r\nimport { enUS } from 'date-fns/locale';\r\nimport { toast } from 'sonner';\r\n\r\ninterface UserSession {\r\n  id: string;\r\n  device_type: string;\r\n  device_name: string;\r\n  ip_address: string;\r\n  created_at: string;\r\n  expires_at: string;\r\n  is_active: boolean;\r\n}\r\n\r\nexport default function ProfilePage() {\r\n  const { user, roles, permissions, logout, sessionId } = useAuthStore();\r\n  const { primaryRole, isAdmin, isSuperAdmin } = usePermissions();\r\n\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [showPinModal, setShowPinModal] = useState(false);\r\n  const [sessions, setSessions] = useState<UserSession[]>([]);\r\n  const [loadingSessions, setLoadingSessions] = useState(false);\r\n\r\n  // Form state\r\n  const [formData, setFormData] = useState({\r\n    display_name: '',\r\n    phone: '',\r\n  });\r\n\r\n  // PIN change state\r\n  const [pinForm, setPinForm] = useState({\r\n    current_pin: '',\r\n    new_pin: '',\r\n    confirm_pin: '',\r\n  });\r\n  const [changingPin, setChangingPin] = useState(false);\r\n\r\n  const getLocale = () => enUS;\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      setFormData({\r\n        display_name: user.display_name || '',\r\n        phone: user.phone || '',\r\n      });\r\n      loadSessions();\r\n    }\r\n  }, [user]);\r\n\r\n  const loadSessions = async () => {\r\n    if (!user) return;\r\n    setLoadingSessions(true);\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('user_sessions')\r\n        .select('*')\r\n        .eq('user_id', user.id)\r\n        .is('ended_at', null)\r\n        .order('started_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      // Map the database fields to our interface\r\n      type SessionRow = {\r\n        id: string;\r\n        device_info?: { type?: string; name?: string } | null;\r\n        ip_address?: string | null;\r\n        started_at: string;\r\n        ended_at?: string | null;\r\n      };\r\n      const rawData = data as unknown as SessionRow[];\r\n      const mapped = rawData.map((s) => ({\r\n        id: s.id,\r\n        device_type: (s.device_info as { type?: string })?.type || 'unknown',\r\n        device_name: (s.device_info as { name?: string })?.name || 'Unknown Device',\r\n        ip_address: s.ip_address || '',\r\n        created_at: s.started_at,\r\n        expires_at: s.ended_at || '',\r\n        is_active: !s.ended_at,\r\n      }));\r\n      setSessions(mapped);\r\n    } catch (error) {\r\n      console.error('Error loading sessions:', error);\r\n    } finally {\r\n      setLoadingSessions(false);\r\n    }\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    if (!user) return;\r\n    setIsSaving(true);\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_profiles')\r\n        .update({\r\n          display_name: formData.display_name,\r\n          phone: formData.phone,\r\n        } as never)\r\n        .eq('id', user.id);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Profile updated');\r\n      setIsEditing(false);\r\n    } catch (error) {\r\n      console.error('Error updating profile:', error);\r\n      toast.error(error instanceof Error ? error.message : 'Error');\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleChangePin = async () => {\r\n    if (!user) return;\r\n\r\n    if (pinForm.new_pin.length < 4) {\r\n      toast.error('PIN must be at least 4 digits');\r\n      return;\r\n    }\r\n\r\n    if (pinForm.new_pin !== pinForm.confirm_pin) {\r\n      toast.error('PINs do not match');\r\n      return;\r\n    }\r\n\r\n    setChangingPin(true);\r\n    try {\r\n      const result = await authService.changePin(user.id, pinForm.current_pin, pinForm.new_pin);\r\n\r\n      if (result.success) {\r\n        toast.success('PIN changed');\r\n        setShowPinModal(false);\r\n        setPinForm({ current_pin: '', new_pin: '', confirm_pin: '' });\r\n      } else {\r\n        toast.error(result.error || 'Error');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error changing PIN:', error);\r\n      toast.error(error instanceof Error ? error.message : 'Error');\r\n    } finally {\r\n      setChangingPin(false);\r\n    }\r\n  };\r\n\r\n  const handleTerminateSession = async (sessionIdToTerminate: string) => {\r\n    if (!user) return;\r\n    if (sessionIdToTerminate === sessionId) {\r\n      toast.error('Cannot terminate current session');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_sessions')\r\n        .update({ ended_at: new Date().toISOString() } as never)\r\n        .eq('id', sessionIdToTerminate);\r\n\r\n      if (error) throw error;\r\n\r\n      toast.success('Session terminated');\r\n      loadSessions();\r\n    } catch (error) {\r\n      console.error('Error terminating session:', error);\r\n      toast.error(error instanceof Error ? error.message : 'Error');\r\n    }\r\n  };\r\n\r\n  const handleLogout = async () => {\r\n    await logout();\r\n    window.location.href = '/login';\r\n  };\r\n\r\n  const getRoleName = () => {\r\n    if (!primaryRole) return '-';\r\n    const role = primaryRole as { name_fr?: string; name_en?: string; name_id?: string; code: string };\r\n    return role.name_en || role.name_fr || role.code;\r\n  };\r\n\r\n  const getDeviceIcon = (deviceType: string) => {\r\n    if (deviceType?.toLowerCase().includes('mobile')) return <Smartphone className=\"w-5 h-5\" />;\r\n    return <Monitor className=\"w-5 h-5\" />;\r\n  };\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <RefreshCw className=\"w-8 h-8 animate-spin text-blue-500\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-4xl mx-auto\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900 flex items-center gap-2\">\r\n            <User className=\"w-7 h-7 text-blue-600\" />\r\n            My Profile\r\n          </h1>\r\n          <p className=\"text-gray-500 mt-1\">\r\n            Manage your personal information\r\n          </p>\r\n        </div>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleLogout}\r\n          className=\"flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n        >\r\n          <LogOut className=\"w-5 h-5\" />\r\n          Logout\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Profile Card */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          {/* Personal Info */}\r\n          <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\r\n            <div className=\"p-6 border-b border-gray-100 flex items-center justify-between\">\r\n              <h2 className=\"text-lg font-semibold text-gray-900\">\r\n                Personal Information\r\n              </h2>\r\n              {!isEditing && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setIsEditing(true)}\r\n                  className=\"text-sm text-blue-600 hover:text-blue-700\"\r\n                >\r\n                  Edit\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"p-6\">\r\n              {/* Avatar */}\r\n              <div className=\"flex items-center gap-4 mb-6\">\r\n                <div className=\"relative\">\r\n                  {user.avatar_url ? (\r\n                    <img\r\n                      src={user.avatar_url}\r\n                      alt={user.display_name || 'User'}\r\n                      className=\"w-20 h-20 rounded-full object-cover border-4 border-white shadow\"\r\n                    />\r\n                  ) : (\r\n                    <div className=\"w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-3xl font-bold text-white shadow\">\r\n                      {(user.display_name || user.first_name || 'U').charAt(0).toUpperCase()}\r\n                    </div>\r\n                  )}\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"absolute bottom-0 right-0 p-2 bg-white rounded-full shadow-md hover:bg-gray-50 transition-colors\"\r\n                    title=\"Change avatar\"\r\n                  >\r\n                    <Camera className=\"w-4 h-4 text-gray-600\" />\r\n                  </button>\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-xl font-semibold text-gray-900\">\r\n                    {user.display_name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'User'}\r\n                  </h3>\r\n                  <p className=\"text-gray-500\">{(user as any).employee_code || '-'}</p>\r\n                </div>\r\n              </div>\r\n\r\n              {isEditing ? (\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Display Name\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.display_name}\r\n                      onChange={(e) => setFormData({ ...formData, display_name: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                      placeholder={user.display_name || `${user.first_name || ''} ${user.last_name || ''}`.trim()}\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Phone\r\n                    </label>\r\n                    <input\r\n                      type=\"tel\"\r\n                      value={formData.phone}\r\n                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500\"\r\n                      placeholder=\"+62...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center justify-end gap-3 pt-4\">\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setIsEditing(false)}\r\n                      className=\"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                    >\r\n                      Cancel\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={handleSave}\r\n                      disabled={isSaving}\r\n                      className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors\"\r\n                    >\r\n                      {isSaving ? (\r\n                        <RefreshCw className=\"w-4 h-4 animate-spin\" />\r\n                      ) : (\r\n                        <Save className=\"w-4 h-4\" />\r\n                      )}\r\n                      Save\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div>\r\n                      <label className=\"text-sm text-gray-500\">Name</label>\r\n                      <p className=\"font-medium\">{`${user.first_name || ''} ${user.last_name || ''}`.trim() || '-'}</p>\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"text-sm text-gray-500\">Display Name</label>\r\n                      <p className=\"font-medium\">{user.display_name || '-'}</p>\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"text-sm text-gray-500\">Phone</label>\r\n                      <p className=\"font-medium\">{user.phone || '-'}</p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Security */}\r\n          <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\r\n            <div className=\"p-6 border-b border-gray-100\">\r\n              <h2 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                <Key className=\"w-5 h-5 text-gray-400\" />\r\n                Security\r\n              </h2>\r\n            </div>\r\n\r\n            <div className=\"p-6\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"font-medium text-gray-900\">PIN Code</p>\r\n                  <p className=\"text-sm text-gray-500\">\r\n                    Used to log in to the POS\r\n                  </p>\r\n                </div>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowPinModal(true)}\r\n                  className=\"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors\"\r\n                >\r\n                  Change PIN\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Active Sessions */}\r\n          <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\r\n            <div className=\"p-6 border-b border-gray-100 flex items-center justify-between\">\r\n              <h2 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                <Clock className=\"w-5 h-5 text-gray-400\" />\r\n                Active Sessions\r\n              </h2>\r\n              <button\r\n                type=\"button\"\r\n                onClick={loadSessions}\r\n                className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                title=\"Refresh\"\r\n              >\r\n                <RefreshCw className={`w-4 h-4 text-gray-600 ${loadingSessions ? 'animate-spin' : ''}`} />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"divide-y divide-gray-100\">\r\n              {sessions.length === 0 ? (\r\n                <div className=\"p-6 text-center text-gray-500\">\r\n                  No active sessions\r\n                </div>\r\n              ) : (\r\n                sessions.map(session => (\r\n                  <div key={session.id} className=\"p-4 flex items-center justify-between hover:bg-gray-50\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <div className=\"p-2 bg-gray-100 rounded-lg\">\r\n                        {getDeviceIcon(session.device_type)}\r\n                      </div>\r\n                      <div>\r\n                        <p className=\"font-medium text-gray-900 flex items-center gap-2\">\r\n                          {session.device_name || session.device_type || 'Unknown'}\r\n                          {session.id === sessionId && (\r\n                            <span className=\"px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full\">\r\n                              Current session\r\n                            </span>\r\n                          )}\r\n                        </p>\r\n                        <p className=\"text-sm text-gray-500\">\r\n                          {session.ip_address} • {format(new Date(session.created_at), 'Pp', { locale: getLocale() })}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                    {session.id !== sessionId && (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => handleTerminateSession(session.id)}\r\n                        className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                        title=\"Terminate this session\"\r\n                      >\r\n                        <X className=\"w-5 h-5\" />\r\n                      </button>\r\n                    )}\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Sidebar */}\r\n        <div className=\"space-y-6\">\r\n          {/* Role Card */}\r\n          <div className=\"bg-white rounded-xl border border-gray-200 p-6\">\r\n            <h3 className=\"text-sm font-medium text-gray-500 mb-4 flex items-center gap-2\">\r\n              <Shield className=\"w-4 h-4\" />\r\n              Role and Permissions\r\n            </h3>\r\n\r\n            <div className=\"mb-4\">\r\n              <span className=\"inline-flex items-center gap-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium\">\r\n                <Shield className=\"w-4 h-4\" />\r\n                {getRoleName()}\r\n              </span>\r\n            </div>\r\n\r\n            {roles.length > 1 && (\r\n              <div className=\"mb-4\">\r\n                <p className=\"text-sm text-gray-500 mb-2\">All roles</p>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {roles.map(role => {\r\n                    const r = role as { id: string; name_fr?: string; name_en?: string; name_id?: string; code: string };\r\n                    return (\r\n                      <span\r\n                        key={r.id}\r\n                        className=\"px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-full\"\r\n                      >\r\n                        {r.name_en || r.name_fr || r.code}\r\n                      </span>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            <div>\r\n              <p className=\"text-sm text-gray-500 mb-2\">\r\n                {permissions.length} permissions\r\n              </p>\r\n              <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                {isAdmin && (\r\n                  <span className=\"flex items-center gap-1 text-amber-600\">\r\n                    <Check className=\"w-4 h-4\" />\r\n                    Admin\r\n                  </span>\r\n                )}\r\n                {isSuperAdmin && (\r\n                  <span className=\"flex items-center gap-1 text-red-600\">\r\n                    <Check className=\"w-4 h-4\" />\r\n                    Super Admin\r\n                  </span>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Account Info */}\r\n          <div className=\"bg-white rounded-xl border border-gray-200 p-6\">\r\n            <h3 className=\"text-sm font-medium text-gray-500 mb-4\">\r\n              Account Information\r\n            </h3>\r\n\r\n            <div className=\"space-y-3 text-sm\">\r\n              <div className=\"flex justify-between\">\r\n                <span className=\"text-gray-500\">Employee Code</span>\r\n                <span className=\"font-mono\">{(user as any).employee_code || '-'}</span>\r\n              </div>\r\n              <div className=\"flex justify-between\">\r\n                <span className=\"text-gray-500\">Created</span>\r\n                <span>{user.created_at ? format(new Date(user.created_at), 'P', { locale: getLocale() }) : '-'}</span>\r\n              </div>\r\n              <div className=\"flex justify-between\">\r\n                <span className=\"text-gray-500\">Status</span>\r\n                <span className={`flex items-center gap-1 ${user.is_active ? 'text-green-600' : 'text-red-600'}`}>\r\n                  {user.is_active ? (\r\n                    <>\r\n                      <Check className=\"w-4 h-4\" />\r\n                      Active\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <X className=\"w-4 h-4\" />\r\n                      Inactive\r\n                    </>\r\n                  )}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* PIN Change Modal */}\r\n      {showPinModal && (\r\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-xl max-w-md w-full shadow-xl\">\r\n            <div className=\"p-6 border-b border-gray-100 flex items-center justify-between\">\r\n              <h2 className=\"text-xl font-semibold text-gray-900\">\r\n                Change PIN\r\n              </h2>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowPinModal(false)}\r\n                className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                title=\"Close\"\r\n                aria-label=\"Close\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"p-6 space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Current PIN\r\n                </label>\r\n                <input\r\n                  type=\"password\"\r\n                  value={pinForm.current_pin}\r\n                  onChange={(e) => setPinForm({ ...pinForm, current_pin: e.target.value.replace(/\\D/g, '').slice(0, 6) })}\r\n                  className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono tracking-widest text-center text-2xl\"\r\n                  placeholder=\"••••\"\r\n                  maxLength={6}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  New PIN\r\n                </label>\r\n                <input\r\n                  type=\"password\"\r\n                  value={pinForm.new_pin}\r\n                  onChange={(e) => setPinForm({ ...pinForm, new_pin: e.target.value.replace(/\\D/g, '').slice(0, 6) })}\r\n                  className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono tracking-widest text-center text-2xl\"\r\n                  placeholder=\"••••\"\r\n                  maxLength={6}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Confirm PIN\r\n                </label>\r\n                <input\r\n                  type=\"password\"\r\n                  value={pinForm.confirm_pin}\r\n                  onChange={(e) => setPinForm({ ...pinForm, confirm_pin: e.target.value.replace(/\\D/g, '').slice(0, 6) })}\r\n                  className=\"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono tracking-widest text-center text-2xl\"\r\n                  placeholder=\"••••\"\r\n                  maxLength={6}\r\n                />\r\n                {pinForm.new_pin && pinForm.confirm_pin && pinForm.new_pin !== pinForm.confirm_pin && (\r\n                  <p className=\"text-sm text-red-600 mt-1\">\r\n                    PINs do not match\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"p-6 border-t border-gray-100 flex items-center justify-end gap-3\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowPinModal(false)}\r\n                className=\"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleChangePin}\r\n                disabled={changingPin || !pinForm.current_pin || pinForm.new_pin.length < 4 || pinForm.new_pin !== pinForm.confirm_pin}\r\n                className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors\"\r\n              >\r\n                {changingPin ? (\r\n                  <RefreshCw className=\"w-4 h-4 animate-spin\" />\r\n                ) : (\r\n                  <Key className=\"w-4 h-4\" />\r\n                )}\r\n                Change PIN\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\purchasing\\PurchaseOrderDetailPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\purchasing\\PurchaseOrderFormPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":228,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8679,8682],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8679,8682],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo, useRef } from 'react'\r\nimport { useNavigate, useParams } from 'react-router-dom'\r\nimport { ArrowLeft, Plus, Trash2, Save, Send, Percent, WifiOff } from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport { formatCurrency } from '@/utils/helpers'\r\nimport { useNetworkStatus } from '@/hooks/useNetworkStatus'\r\nimport { useSuppliers } from '@/hooks/purchasing/useSuppliers'\r\nimport {\r\n    usePurchaseOrder,\r\n    useCreatePurchaseOrder,\r\n    useUpdatePurchaseOrder,\r\n    calculateLineTotal,\r\n    type IPOItem\r\n} from '@/hooks/purchasing/usePurchaseOrders'\r\nimport { toast } from 'sonner'\r\nimport './PurchaseOrderFormPage.css'\r\n\r\ninterface Product {\r\n    id: string\r\n    name: string\r\n    cost_price: number | null\r\n    unit: string | null\r\n    product_type?: string | null\r\n}\r\n\r\nconst DEFAULT_ITEM: IPOItem = {\r\n    product_id: null,\r\n    product_name: '',\r\n    description: '',\r\n    quantity: 1,\r\n    unit: 'kg',\r\n    unit_price: 0,\r\n    discount_amount: 0,\r\n    discount_percentage: null,\r\n    tax_rate: 10,\r\n    line_total: 0\r\n}\r\n\r\nexport default function PurchaseOrderFormPage() {\r\n    const navigate = useNavigate()\r\n    const { id } = useParams()\r\n    const isEditing = !!id\r\n    const { isOnline } = useNetworkStatus()\r\n    const hasCheckedInitialOnlineStatus = useRef(false)\r\n\r\n    // React Query hooks\r\n    const { data: suppliers = [], isLoading: suppliersLoading } = useSuppliers({ isActive: true })\r\n    const { data: purchaseOrder, isLoading: poLoading } = usePurchaseOrder(id || null)\r\n    const createMutation = useCreatePurchaseOrder()\r\n    const updateMutation = useUpdatePurchaseOrder()\r\n\r\n    // Local state for products (raw materials only)\r\n    const [products, setProducts] = useState<Product[]>([])\r\n    const [productsLoading, setProductsLoading] = useState(true)\r\n\r\n    const [formData, setFormData] = useState({\r\n        supplier_id: '',\r\n        expected_delivery_date: '',\r\n        notes: '',\r\n        discount_amount: 0,\r\n        discount_percentage: null as number | null,\r\n        status: 'draft' as const\r\n    })\r\n\r\n    const [items, setItems] = useState<IPOItem[]>([{ ...DEFAULT_ITEM }])\r\n    const [showDiscountModal, setShowDiscountModal] = useState(false)\r\n\r\n    // Check online status on mount\r\n    useEffect(() => {\r\n        if (!hasCheckedInitialOnlineStatus.current) {\r\n            hasCheckedInitialOnlineStatus.current = true\r\n            if (!isOnline) {\r\n                toast.error('This feature requires an internet connection')\r\n            }\r\n        }\r\n    }, [isOnline])\r\n\r\n    // Load products (raw materials only)\r\n    useEffect(() => {\r\n        const fetchProducts = async () => {\r\n            try {\r\n                const { data, error } = await supabase\r\n                    .from('products')\r\n                    .select('id, name, cost_price, product_type, unit')\r\n                    .neq('is_active', false)\r\n                    .order('name')\r\n\r\n                if (error) throw error\r\n\r\n                // Filter raw materials in JavaScript\r\n                if (data && data.length > 0) {\r\n                    const filtered = data.filter(p => p.product_type === 'raw_material')\r\n                    setProducts(filtered as Product[])\r\n                } else if (data) {\r\n                    setProducts(data as Product[])\r\n                }\r\n            } catch (error) {\r\n                console.error('Error fetching products:', error)\r\n            } finally {\r\n                setProductsLoading(false)\r\n            }\r\n        }\r\n        fetchProducts()\r\n    }, [])\r\n\r\n    // Populate form when editing\r\n    useEffect(() => {\r\n        if (purchaseOrder && isEditing) {\r\n            setFormData({\r\n                supplier_id: purchaseOrder.supplier_id,\r\n                expected_delivery_date: (purchaseOrder.expected_delivery_date || '').split('T')[0],\r\n                notes: purchaseOrder.notes || '',\r\n                discount_amount: purchaseOrder.discount_amount ?? 0,\r\n                discount_percentage: purchaseOrder.discount_percentage ?? null,\r\n                status: purchaseOrder.status as 'draft'\r\n            })\r\n\r\n            if (purchaseOrder.items && purchaseOrder.items.length > 0) {\r\n                setItems(purchaseOrder.items.map(item => ({\r\n                    ...item,\r\n                    quantity: parseFloat(String(item.quantity || 0)),\r\n                    unit_price: parseFloat(String(item.unit_price || 0)),\r\n                    discount_amount: parseFloat(String(item.discount_amount || 0)),\r\n                    tax_rate: parseFloat(String(item.tax_rate || 10)),\r\n                    line_total: parseFloat(String(item.line_total || 0))\r\n                })))\r\n            }\r\n        }\r\n    }, [purchaseOrder, isEditing])\r\n\r\n    // Calculate line total for a single item\r\n    const calculateItemLineTotal = (item: IPOItem): number => {\r\n        return calculateLineTotal(item)\r\n    }\r\n\r\n    const handleItemChange = (index: number, field: keyof IPOItem, value: string | number | null) => {\r\n        const newItems = [...items]\r\n        newItems[index] = { ...newItems[index], [field]: value }\r\n\r\n        // If product selected, auto-fill details\r\n        if (field === 'product_id' && value) {\r\n            const product = products.find(p => p.id === value)\r\n            if (product) {\r\n                newItems[index].product_name = product.name\r\n                newItems[index].unit = product.unit ?? 'kg'\r\n                newItems[index].unit_price = product.cost_price || 0\r\n            }\r\n        }\r\n\r\n        // Recalculate line total\r\n        newItems[index].line_total = calculateItemLineTotal(newItems[index])\r\n\r\n        setItems(newItems)\r\n    }\r\n\r\n    const handleAddItem = () => {\r\n        setItems([...items, { ...DEFAULT_ITEM }])\r\n    }\r\n\r\n    const handleRemoveItem = (index: number) => {\r\n        if (items.length > 1) {\r\n            setItems(items.filter((_, i) => i !== index))\r\n        }\r\n    }\r\n\r\n    // Memoized totals calculation\r\n    const totals = useMemo(() => {\r\n        const subtotal = items.reduce((sum, item) => sum + item.line_total, 0)\r\n        const orderDiscount = formData.discount_percentage\r\n            ? subtotal * (formData.discount_percentage / 100)\r\n            : formData.discount_amount\r\n        const afterDiscount = subtotal - orderDiscount\r\n        const tax = items.reduce((sum, item) => sum + (item.line_total * item.tax_rate / 100), 0)\r\n        const total = afterDiscount + tax\r\n\r\n        return { subtotal, orderDiscount, tax, total }\r\n    }, [items, formData.discount_amount, formData.discount_percentage])\r\n\r\n    const handleSubmit = async (sendToSupplier: boolean = false) => {\r\n        if (!isOnline) {\r\n            toast.error('This feature requires an internet connection')\r\n            return\r\n        }\r\n\r\n        if (!formData.supplier_id) {\r\n            toast.error('Please fill in all required fields')\r\n            return\r\n        }\r\n\r\n        if (items.some(item => !item.product_name || item.quantity <= 0 || item.unit_price < 0)) {\r\n            toast.error('Please fill in all required fields')\r\n            return\r\n        }\r\n\r\n        try {\r\n            // Prepare items with recalculated line totals\r\n            const preparedItems = items.map(item => ({\r\n                ...item,\r\n                line_total: calculateItemLineTotal(item)\r\n            }))\r\n\r\n            if (isEditing) {\r\n                await updateMutation.mutateAsync({\r\n                    id: id!,\r\n                    supplier_id: formData.supplier_id,\r\n                    expected_delivery_date: formData.expected_delivery_date || null,\r\n                    notes: formData.notes,\r\n                    discount_amount: formData.discount_amount,\r\n                    discount_percentage: formData.discount_percentage,\r\n                    items: preparedItems,\r\n                    status: sendToSupplier ? 'sent' : formData.status\r\n                })\r\n                toast.success('Purchase order updated successfully')\r\n            } else {\r\n                await createMutation.mutateAsync({\r\n                    supplier_id: formData.supplier_id,\r\n                    expected_delivery_date: formData.expected_delivery_date || null,\r\n                    notes: formData.notes,\r\n                    discount_amount: formData.discount_amount,\r\n                    discount_percentage: formData.discount_percentage,\r\n                    items: preparedItems,\r\n                    sendToSupplier\r\n                })\r\n                toast.success('Purchase order created successfully')\r\n            }\r\n\r\n            navigate('/purchasing/purchase-orders')\r\n        } catch (error: any) {\r\n            console.error('Error saving purchase order:', error)\r\n            toast.error(isEditing ? 'Failed to update purchase order' : 'Failed to create purchase order')\r\n        }\r\n    }\r\n\r\n    const applyGlobalDiscount = () => {\r\n        setFormData({\r\n            ...formData,\r\n            discount_amount: formData.discount_percentage\r\n                ? totals.subtotal * (formData.discount_percentage / 100)\r\n                : formData.discount_amount\r\n        })\r\n        setShowDiscountModal(false)\r\n    }\r\n\r\n    const isLoading = suppliersLoading || productsLoading || (isEditing && poLoading)\r\n    const isSaving = createMutation.isPending || updateMutation.isPending\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"po-form-page\">\r\n                <div className=\"po-form-page__loading\">Loading...</div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"po-form-page\">\r\n            {/* Offline Warning Banner */}\r\n            {!isOnline && (\r\n                <div className=\"po-form-page__offline-banner\">\r\n                    <WifiOff size={20} />\r\n                    <span>This feature requires an internet connection</span>\r\n                </div>\r\n            )}\r\n\r\n            {/* Header */}\r\n            <div className=\"po-form-page__header\">\r\n                <button className=\"btn btn-secondary\" onClick={() => navigate('/purchasing/purchase-orders')}>\r\n                    <ArrowLeft size={20} />\r\n                    Cancel\r\n                </button>\r\n                <h1 className=\"po-form-page__title\">\r\n                    {isEditing ? 'Edit Purchase Order' : 'New Purchase Order'}\r\n                </h1>\r\n            </div>\r\n\r\n            <div className=\"po-form-page__content\">\r\n                {/* Main Form */}\r\n                <div className=\"po-form-page__main\">\r\n                    {/* Supplier & Dates */}\r\n                    <div className=\"po-form-section\">\r\n                        <h2>Supplier</h2>\r\n                        <div className=\"po-form-grid\">\r\n                            <div className=\"form-group\">\r\n                                <label>Supplier *</label>\r\n                                <select\r\n                                    required\r\n                                    value={formData.supplier_id}\r\n                                    onChange={e => setFormData({ ...formData, supplier_id: e.target.value })}\r\n                                    disabled={!isOnline}\r\n                                    aria-label=\"Select supplier\"\r\n                                >\r\n                                    <option value=\"\">Select a supplier</option>\r\n                                    {suppliers.map(supplier => (\r\n                                        <option key={supplier.id} value={supplier.id}>\r\n                                            {supplier.name}\r\n                                        </option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label>Expected Delivery</label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    value={formData.expected_delivery_date}\r\n                                    onChange={e => setFormData({ ...formData, expected_delivery_date: e.target.value })}\r\n                                    disabled={!isOnline}\r\n                                    aria-label=\"Expected delivery date\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group form-group--full\">\r\n                                <label>Notes</label>\r\n                                <textarea\r\n                                    rows={2}\r\n                                    value={formData.notes}\r\n                                    onChange={e => setFormData({ ...formData, notes: e.target.value })}\r\n                                    placeholder=\"Add any notes...\"\r\n                                    disabled={!isOnline}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Items */}\r\n                    <div className=\"po-form-section\">\r\n                        <div className=\"po-form-section__header\">\r\n                            <h2>Items</h2>\r\n                            <button\r\n                                className=\"btn btn-secondary btn-sm\"\r\n                                onClick={handleAddItem}\r\n                                disabled={!isOnline}\r\n                            >\r\n                                <Plus size={16} />\r\n                                Add Item\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"po-items-table\">\r\n                            <table>\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th>Product</th>\r\n                                        <th>Description</th>\r\n                                        <th style={{ width: '100px' }}>Quantity</th>\r\n                                        <th style={{ width: '80px' }}>Unit</th>\r\n                                        <th style={{ width: '120px' }}>Unit Price</th>\r\n                                        <th style={{ width: '100px' }}>Discount</th>\r\n                                        <th style={{ width: '80px' }}>Tax %</th>\r\n                                        <th style={{ width: '120px' }}>Line Total</th>\r\n                                        <th style={{ width: '50px' }}></th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {items.map((item, index) => (\r\n                                        <tr key={index}>\r\n                                            <td>\r\n                                                <select\r\n                                                    value={item.product_id || ''}\r\n                                                    onChange={e => handleItemChange(index, 'product_id', e.target.value || null)}\r\n                                                    disabled={!isOnline}\r\n                                                    aria-label=\"Select product\"\r\n                                                >\r\n                                                    <option value=\"\">Produit personnalisé</option>\r\n                                                    {products.map(product => (\r\n                                                        <option key={product.id} value={product.id}>\r\n                                                            {product.name}\r\n                                                        </option>\r\n                                                    ))}\r\n                                                </select>\r\n                                                {!item.product_id && (\r\n                                                    <input\r\n                                                        type=\"text\"\r\n                                                        placeholder=\"Nom du produit\"\r\n                                                        value={item.product_name}\r\n                                                        onChange={e => handleItemChange(index, 'product_name', e.target.value)}\r\n                                                        style={{ marginTop: '4px' }}\r\n                                                        disabled={!isOnline}\r\n                                                    />\r\n                                                )}\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    placeholder=\"Description\"\r\n                                                    value={item.description}\r\n                                                    onChange={e => handleItemChange(index, 'description', e.target.value)}\r\n                                                    aria-label=\"Description\"\r\n                                                    disabled={!isOnline}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"0.01\"\r\n                                                    step=\"0.01\"\r\n                                                    value={item.quantity}\r\n                                                    onChange={e => handleItemChange(index, 'quantity', parseFloat(e.target.value) || 0)}\r\n                                                    aria-label=\"Quantity\"\r\n                                                    disabled={!isOnline}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <select\r\n                                                    value={item.unit}\r\n                                                    onChange={e => handleItemChange(index, 'unit', e.target.value)}\r\n                                                    aria-label=\"Unité\"\r\n                                                    disabled={!isOnline}\r\n                                                >\r\n                                                    <option value=\"kg\">kg</option>\r\n                                                    <option value=\"g\">g</option>\r\n                                                    <option value=\"L\">L</option>\r\n                                                    <option value=\"mL\">mL</option>\r\n                                                    <option value=\"pcs\">pcs</option>\r\n                                                    <option value=\"box\">box</option>\r\n                                                    <option value=\"bag\">bag</option>\r\n                                                </select>\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"0\"\r\n                                                    step=\"100\"\r\n                                                    value={item.unit_price}\r\n                                                    onChange={e => handleItemChange(index, 'unit_price', parseFloat(e.target.value) || 0)}\r\n                                                    aria-label=\"Unit price\"\r\n                                                    disabled={!isOnline}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"0\"\r\n                                                    step=\"0.01\"\r\n                                                    value={item.discount_amount}\r\n                                                    onChange={e => handleItemChange(index, 'discount_amount', parseFloat(e.target.value) || 0)}\r\n                                                    aria-label=\"Discount\"\r\n                                                    disabled={!isOnline}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    min=\"0\"\r\n                                                    max=\"100\"\r\n                                                    step=\"0.01\"\r\n                                                    value={item.tax_rate}\r\n                                                    onChange={e => handleItemChange(index, 'tax_rate', parseFloat(e.target.value) || 0)}\r\n                                                    aria-label=\"Tax rate\"\r\n                                                    disabled={!isOnline}\r\n                                                />\r\n                                            </td>\r\n                                            <td>\r\n                                                <strong>{formatCurrency(item.line_total)}</strong>\r\n                                            </td>\r\n                                            <td>\r\n                                                <button\r\n                                                    className=\"btn-icon btn-icon--danger\"\r\n                                                    onClick={() => handleRemoveItem(index)}\r\n                                                    disabled={items.length === 1 || !isOnline}\r\n                                                    aria-label=\"Delete\"\r\n                                                    title=\"Delete\"\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Summary Sidebar */}\r\n                <div className=\"po-form-page__sidebar\">\r\n                    <div className=\"po-summary\">\r\n                        <h3>Summary</h3>\r\n\r\n                        <div className=\"po-summary__line\">\r\n                            <span>Subtotal</span>\r\n                            <span>{formatCurrency(totals.subtotal)}</span>\r\n                        </div>\r\n\r\n                        <button\r\n                            className=\"po-summary__discount-btn\"\r\n                            onClick={() => setShowDiscountModal(true)}\r\n                            disabled={!isOnline}\r\n                        >\r\n                            <Percent size={16} />\r\n                            Discount\r\n                        </button>\r\n\r\n                        {totals.orderDiscount > 0 && (\r\n                            <div className=\"po-summary__line po-summary__line--discount\">\r\n                                <span>Discount Amount</span>\r\n                                <span>-{formatCurrency(totals.orderDiscount)}</span>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"po-summary__line\">\r\n                            <span>Tax Amount</span>\r\n                            <span>{formatCurrency(totals.tax)}</span>\r\n                        </div>\r\n\r\n                        <div className=\"po-summary__divider\"></div>\r\n\r\n                        <div className=\"po-summary__total\">\r\n                            <span>Total Amount</span>\r\n                            <span>{formatCurrency(totals.total)}</span>\r\n                        </div>\r\n\r\n                        <div className=\"po-summary__actions\">\r\n                            <button\r\n                                className=\"btn btn-secondary btn-block\"\r\n                                onClick={() => handleSubmit(false)}\r\n                                disabled={isSaving || !isOnline}\r\n                            >\r\n                                <Save size={18} />\r\n                                Save as Draft\r\n                            </button>\r\n                            <button\r\n                                className=\"btn btn-primary btn-block\"\r\n                                onClick={() => handleSubmit(true)}\r\n                                disabled={isSaving || !isOnline}\r\n                            >\r\n                                <Send size={18} />\r\n                                Save & Send\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Discount Modal */}\r\n            {showDiscountModal && (\r\n                <div className=\"modal-backdrop is-active\" onClick={() => setShowDiscountModal(false)}>\r\n                    <div className=\"modal is-active\" onClick={e => e.stopPropagation()}>\r\n                        <div className=\"modal__header\">\r\n                            <h2 className=\"modal__title\">Discount</h2>\r\n                        </div>\r\n                        <div className=\"modal__body\">\r\n                            <div className=\"form-group\">\r\n                                <label>Fixed Amount (IDR)</label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    min=\"0\"\r\n                                    step=\"100\"\r\n                                    value={formData.discount_amount}\r\n                                    onChange={e => setFormData({\r\n                                        ...formData,\r\n                                        discount_amount: parseFloat(e.target.value) || 0,\r\n                                        discount_percentage: null\r\n                                    })}\r\n                                    aria-label=\"Fixed discount amount\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"form-group\">\r\n                                <label>Percentage (%)</label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    min=\"0\"\r\n                                    max=\"100\"\r\n                                    step=\"0.01\"\r\n                                    value={formData.discount_percentage || ''}\r\n                                    onChange={e => setFormData({\r\n                                        ...formData,\r\n                                        discount_percentage: parseFloat(e.target.value) || null,\r\n                                        discount_amount: 0\r\n                                    })}\r\n                                    aria-label=\"Discount percentage\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"modal__footer\">\r\n                            <button className=\"btn btn-secondary\" onClick={() => setShowDiscountModal(false)}>\r\n                                Cancel\r\n                            </button>\r\n                            <button className=\"btn btn-primary\" onClick={applyGlobalDiscount}>\r\n                                Apply\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\purchasing\\PurchaseOrdersPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\purchasing\\SuppliersPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":135,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4030,4033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4030,4033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\r\nimport { Plus, Search, Edit2, Trash2, Building2, Phone, Mail, MapPin, CheckCircle, XCircle } from 'lucide-react'\r\nimport { supabase } from '../../lib/supabase'\r\nimport './SuppliersPage.css'\r\n\r\ninterface Supplier {\r\n    id: string\r\n    name: string\r\n    contact_person: string | null\r\n    email: string | null\r\n    phone: string | null\r\n    address: string | null\r\n    city: string | null\r\n    postal_code: string | null\r\n    country: string | null\r\n    tax_id: string | null\r\n    payment_terms: string | null\r\n    notes: string | null\r\n    is_active: boolean\r\n    created_at: string\r\n    updated_at: string\r\n}\r\n\r\n// Helper function to format payment terms for display\r\nconst formatPaymentTerms = (term: string | null): string => {\r\n    if (!term) return ''\r\n    const termMap: Record<string, string> = {\r\n        'cod': 'Comptant (COD)',\r\n        'net15': 'Net 15 jours',\r\n        'net30': 'Net 30 jours',\r\n        'net60': 'Net 60 jours'\r\n    }\r\n    return termMap[term] || term\r\n}\r\n\r\nexport default function SuppliersPage() {\r\n    const [suppliers, setSuppliers] = useState<Supplier[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [showModal, setShowModal] = useState(false)\r\n    const [editingSupplier, setEditingSupplier] = useState<Supplier | null>(null)\r\n    const [formData, setFormData] = useState<Partial<Supplier>>({\r\n        name: '',\r\n        contact_person: '',\r\n        email: '',\r\n        phone: '',\r\n        address: '',\r\n        city: '',\r\n        postal_code: '',\r\n        country: 'France',\r\n        tax_id: '',\r\n        payment_terms: 'net30',\r\n        notes: '',\r\n        is_active: true\r\n    })\r\n\r\n    useEffect(() => {\r\n        fetchSuppliers()\r\n    }, [])\r\n\r\n    const fetchSuppliers = async () => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('suppliers')\r\n                .select('*')\r\n                .order('name')\r\n\r\n            if (error) throw error\r\n            if (data) {\r\n                setSuppliers(data)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching suppliers:', error)\r\n        } finally {\r\n            setLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleOpenModal = (supplier?: Supplier) => {\r\n        if (supplier) {\r\n            setEditingSupplier(supplier)\r\n            setFormData(supplier)\r\n        } else {\r\n            setEditingSupplier(null)\r\n            setFormData({\r\n                name: '',\r\n                contact_person: '',\r\n                email: '',\r\n                phone: '',\r\n                address: '',\r\n                city: '',\r\n                postal_code: '',\r\n                country: 'France',\r\n                tax_id: '',\r\n                payment_terms: 'net30',\r\n                notes: '',\r\n                is_active: true\r\n            })\r\n        }\r\n        setShowModal(true)\r\n    }\r\n\r\n    const handleCloseModal = () => {\r\n        setShowModal(false)\r\n        setEditingSupplier(null)\r\n    }\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n\r\n        try {\r\n            if (editingSupplier) {\r\n                // Update existing supplier\r\n                const { error } = await supabase\r\n                    .from('suppliers')\r\n                    .update(formData as never)\r\n                    .eq('id', editingSupplier.id)\r\n\r\n                if (error) throw error\r\n            } else {\r\n                // Create new supplier - ensure required fields\r\n                const insertData = {\r\n                    ...formData,\r\n                    name: formData.name || 'Nouveau fournisseur'\r\n                }\r\n                const { error } = await supabase\r\n                    .from('suppliers')\r\n                    .insert([insertData] as never)\r\n\r\n                if (error) throw error\r\n            }\r\n\r\n            await fetchSuppliers()\r\n            handleCloseModal()\r\n        } catch (error: any) {\r\n            console.error('Error saving supplier:', error)\r\n            const errorMessage = error?.message || error?.error_description || 'Erreur inconnue'\r\n            alert(`Erreur lors de l'enregistrement du fournisseur:\\n${errorMessage}`)\r\n        }\r\n    }\r\n\r\n    const handleDelete = async (id: string) => {\r\n        if (!confirm('Êtes-vous sûr de vouloir supprimer ce fournisseur ?')) {\r\n            return\r\n        }\r\n\r\n        try {\r\n            const { error } = await supabase\r\n                .from('suppliers')\r\n                .delete()\r\n                .eq('id', id)\r\n\r\n            if (error) throw error\r\n            await fetchSuppliers()\r\n        } catch (error) {\r\n            console.error('Error deleting supplier:', error)\r\n            alert('Erreur lors de la suppression du fournisseur')\r\n        }\r\n    }\r\n\r\n    const handleToggleActive = async (supplier: Supplier) => {\r\n        try {\r\n            const { error } = await supabase\r\n                .from('suppliers')\r\n                .update({ is_active: !supplier.is_active })\r\n                .eq('id', supplier.id)\r\n\r\n            if (error) throw error\r\n            await fetchSuppliers()\r\n        } catch (error) {\r\n            console.error('Error toggling supplier status:', error)\r\n        }\r\n    }\r\n\r\n    const filteredSuppliers = suppliers.filter(supplier =>\r\n        supplier.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        supplier.contact_person?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        supplier.email?.toLowerCase().includes(searchTerm.toLowerCase())\r\n    )\r\n\r\n    const activeSuppliers = filteredSuppliers.filter(s => s.is_active)\r\n    const inactiveSuppliers = filteredSuppliers.filter(s => !s.is_active)\r\n\r\n    return (\r\n        <div className=\"suppliers-page\">\r\n            {/* Header */}\r\n            <div className=\"suppliers-page__header\">\r\n                <div>\r\n                    <h1 className=\"suppliers-page__title\">\r\n                        <Building2 size={32} />\r\n                        Fournisseurs\r\n                    </h1>\r\n                    <p className=\"suppliers-page__subtitle\">\r\n                        Gérez vos fournisseurs et leurs informations de contact\r\n                    </p>\r\n                </div>\r\n                <button className=\"btn btn-primary\" onClick={() => handleOpenModal()}>\r\n                    <Plus size={20} />\r\n                    Nouveau Fournisseur\r\n                </button>\r\n            </div>\r\n\r\n            {/* Stats */}\r\n            <div className=\"suppliers-stats\">\r\n                <div className=\"suppliers-stat\">\r\n                    <div className=\"suppliers-stat__icon suppliers-stat__icon--primary\">\r\n                        <Building2 size={24} />\r\n                    </div>\r\n                    <div className=\"suppliers-stat__content\">\r\n                        <div className=\"suppliers-stat__value\">{suppliers.length}</div>\r\n                        <div className=\"suppliers-stat__label\">Total Fournisseurs</div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"suppliers-stat\">\r\n                    <div className=\"suppliers-stat__icon suppliers-stat__icon--success\">\r\n                        <CheckCircle size={24} />\r\n                    </div>\r\n                    <div className=\"suppliers-stat__content\">\r\n                        <div className=\"suppliers-stat__value\">{activeSuppliers.length}</div>\r\n                        <div className=\"suppliers-stat__label\">Actifs</div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"suppliers-stat\">\r\n                    <div className=\"suppliers-stat__icon suppliers-stat__icon--gray\">\r\n                        <XCircle size={24} />\r\n                    </div>\r\n                    <div className=\"suppliers-stat__content\">\r\n                        <div className=\"suppliers-stat__value\">{inactiveSuppliers.length}</div>\r\n                        <div className=\"suppliers-stat__label\">Inactifs</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Search */}\r\n            <div className=\"suppliers-search\">\r\n                <Search size={20} />\r\n                <input\r\n                    type=\"text\"\r\n                    placeholder=\"Rechercher un fournisseur...\"\r\n                    value={searchTerm}\r\n                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                    aria-label=\"Rechercher\"\r\n                />\r\n            </div>\r\n\r\n            {/* Suppliers List */}\r\n            {loading ? (\r\n                <div className=\"suppliers-loading\">Chargement...</div>\r\n            ) : filteredSuppliers.length === 0 ? (\r\n                <div className=\"suppliers-empty\">\r\n                    <Building2 size={48} />\r\n                    <h3>Aucun fournisseur</h3>\r\n                    <p>Commencez par ajouter votre premier fournisseur</p>\r\n                    <button className=\"btn btn-primary\" onClick={() => handleOpenModal()}>\r\n                        <Plus size={20} />\r\n                        Nouveau Fournisseur\r\n                    </button>\r\n                </div>\r\n            ) : (\r\n                <div className=\"suppliers-grid\">\r\n                    {filteredSuppliers.map(supplier => (\r\n                        <div key={supplier.id} className={`supplier-card ${!supplier.is_active ? 'supplier-card--inactive' : ''}`}>\r\n                            <div className=\"supplier-card__header\">\r\n                                <div className=\"supplier-card__name\">\r\n                                    <Building2 size={20} />\r\n                                    {supplier.name}\r\n                                </div>\r\n                                <div className=\"supplier-card__actions\">\r\n                                    <button\r\n                                        className=\"btn-icon\"\r\n                                        onClick={() => handleToggleActive(supplier)}\r\n                                        title={supplier.is_active ? 'Désactiver' : 'Activer'}\r\n                                        aria-label={supplier.is_active ? 'Désactiver' : 'Activer'}\r\n                                    >\r\n                                        {supplier.is_active ? <CheckCircle size={18} /> : <XCircle size={18} />}\r\n                                    </button>\r\n                                    <button\r\n                                        className=\"btn-icon\"\r\n                                        onClick={() => handleOpenModal(supplier)}\r\n                                        aria-label=\"Modifier\"\r\n                                    >\r\n                                        <Edit2 size={18} />\r\n                                    </button>\r\n                                    <button\r\n                                        className=\"btn-icon btn-icon--danger\"\r\n                                        onClick={() => handleDelete(supplier.id)}\r\n                                        aria-label=\"Supprimer\"\r\n                                    >\r\n                                        <Trash2 size={18} />\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"supplier-card__body\">\r\n                                {supplier.contact_person && (\r\n                                    <div className=\"supplier-card__info\">\r\n                                        <strong>Contact:</strong> {supplier.contact_person}\r\n                                    </div>\r\n                                )}\r\n                                {supplier.email && (\r\n                                    <div className=\"supplier-card__info\">\r\n                                        <Mail size={16} />\r\n                                        {supplier.email}\r\n                                    </div>\r\n                                )}\r\n                                {supplier.phone && (\r\n                                    <div className=\"supplier-card__info\">\r\n                                        <Phone size={16} />\r\n                                        {supplier.phone}\r\n                                    </div>\r\n                                )}\r\n                                {supplier.city && (\r\n                                    <div className=\"supplier-card__info\">\r\n                                        <MapPin size={16} />\r\n                                        {supplier.city}, {supplier.country}\r\n                                    </div>\r\n                                )}\r\n                                {supplier.payment_terms && (\r\n                                    <div className=\"supplier-card__info\">\r\n                                        <strong>Conditions:</strong> {formatPaymentTerms(supplier.payment_terms)}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* Modal */}\r\n            {showModal && (\r\n                <div className=\"modal-backdrop is-active\" onClick={handleCloseModal}>\r\n                    <div className=\"modal modal-lg is-active\" onClick={e => e.stopPropagation()}>\r\n                        <div className=\"modal__header\">\r\n                            <h2 className=\"modal__title\">\r\n                                {editingSupplier ? 'Modifier Fournisseur' : 'Nouveau Fournisseur'}\r\n                            </h2>\r\n                        </div>\r\n\r\n                        <form onSubmit={handleSubmit}>\r\n                            <div className=\"modal__body\">\r\n                                <div className=\"supplier-form\">\r\n                                    {/* Basic Info */}\r\n                                    <div className=\"supplier-form__section\">\r\n                                        <h3>Informations de base</h3>\r\n                                        <div className=\"supplier-form__grid\">\r\n                                            <div className=\"form-group form-group--full\">\r\n                                                <label>Nom du fournisseur *</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    required\r\n                                                    value={formData.name}\r\n                                                    onChange={e => setFormData({ ...formData, name: e.target.value })}\r\n                                                    aria-label=\"Nom du fournisseur\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Personne de contact</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={formData.contact_person || ''}\r\n                                                    onChange={e => setFormData({ ...formData, contact_person: e.target.value })}\r\n                                                    aria-label=\"Personne de contact\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Email</label>\r\n                                                <input\r\n                                                    type=\"email\"\r\n                                                    value={formData.email || ''}\r\n                                                    onChange={e => setFormData({ ...formData, email: e.target.value })}\r\n                                                    aria-label=\"Email\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Téléphone</label>\r\n                                                <input\r\n                                                    type=\"tel\"\r\n                                                    value={formData.phone || ''}\r\n                                                    onChange={e => setFormData({ ...formData, phone: e.target.value })}\r\n                                                    aria-label=\"Téléphone\"\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Address */}\r\n                                    <div className=\"supplier-form__section\">\r\n                                        <h3>Adresse</h3>\r\n                                        <div className=\"supplier-form__grid\">\r\n                                            <div className=\"form-group form-group--full\">\r\n                                                <label>Adresse</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={formData.address || ''}\r\n                                                    onChange={e => setFormData({ ...formData, address: e.target.value })}\r\n                                                    aria-label=\"Adresse\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Ville</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={formData.city || ''}\r\n                                                    onChange={e => setFormData({ ...formData, city: e.target.value })}\r\n                                                    aria-label=\"Ville\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Code Postal</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={formData.postal_code || ''}\r\n                                                    onChange={e => setFormData({ ...formData, postal_code: e.target.value })}\r\n                                                    aria-label=\"Code Postal\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Pays</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={formData.country || ''}\r\n                                                    onChange={e => setFormData({ ...formData, country: e.target.value })}\r\n                                                    aria-label=\"Pays\"\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Business Info */}\r\n                                    <div className=\"supplier-form__section\">\r\n                                        <h3>Informations commerciales</h3>\r\n                                        <div className=\"supplier-form__grid\">\r\n                                            <div className=\"form-group\">\r\n                                                <label>Numéro de TVA</label>\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={formData.tax_id || ''}\r\n                                                    onChange={e => setFormData({ ...formData, tax_id: e.target.value })}\r\n                                                    aria-label=\"Numéro de TVA\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group\">\r\n                                                <label>Conditions de paiement</label>\r\n                                                <select\r\n                                                    value={formData.payment_terms || ''}\r\n                                                    onChange={e => setFormData({ ...formData, payment_terms: e.target.value })}\r\n                                                    aria-label=\"Conditions de paiement\"\r\n                                                >\r\n                                                    <option value=\"cod\">Comptant (COD)</option>\r\n                                                    <option value=\"net15\">Net 15 jours</option>\r\n                                                    <option value=\"net30\">Net 30 jours</option>\r\n                                                    <option value=\"net60\">Net 60 jours</option>\r\n                                                </select>\r\n                                            </div>\r\n                                            <div className=\"form-group form-group--full\">\r\n                                                <label>Notes</label>\r\n                                                <textarea\r\n                                                    rows={3}\r\n                                                    value={formData.notes || ''}\r\n                                                    onChange={e => setFormData({ ...formData, notes: e.target.value })}\r\n                                                    aria-label=\"Notes\"\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"form-group form-group--full\">\r\n                                                <label className=\"checkbox-label\">\r\n                                                    <input\r\n                                                        type=\"checkbox\"\r\n                                                        checked={formData.is_active}\r\n                                                        onChange={e => setFormData({ ...formData, is_active: e.target.checked })}\r\n                                                    />\r\n                                                    Fournisseur actif\r\n                                                </label>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"modal__footer\">\r\n                                <button type=\"button\" className=\"btn btn-secondary\" onClick={handleCloseModal}>\r\n                                    Annuler\r\n                                </button>\r\n                                <button type=\"submit\" className=\"btn btn-primary\">\r\n                                    {editingSupplier ? 'Enregistrer' : 'Créer Fournisseur'}\r\n                                </button>\r\n                            </div>\r\n                        </form>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\ReportsConfig.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[399,402],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[399,402],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[526,529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[526,529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n    LayoutGrid,\r\n    DollarSign,\r\n    Package,\r\n    ShieldAlert,\r\n    ShoppingCart,\r\n    FileText,\r\n    TrendingUp,\r\n    TrendingDown,\r\n    Calendar,\r\n    Users,\r\n    AlertTriangle,\r\n    History,\r\n    ClipboardList,\r\n    Clock,\r\n    CreditCard,\r\n    List\r\n} from 'lucide-react';\r\n\r\nexport type ReportDefinition = {\r\n    id: string;\r\n    title: string;\r\n    description: string;\r\n    icon: any;\r\n    component?: React.ReactNode;\r\n};\r\n\r\n\r\nexport type ReportCategory = {\r\n    id: string;\r\n    title: string;\r\n    icon: any;\r\n    reports: ReportDefinition[];\r\n};\r\n\r\nexport const REPORT_CATEGORIES: ReportCategory[] = [\r\n    {\r\n        id: 'overview',\r\n        title: 'Overview',\r\n        icon: LayoutGrid,\r\n        reports: [\r\n            {\r\n                id: 'dashboard',\r\n                title: 'General Dashboard',\r\n                description: 'High-level business performance metrics',\r\n                icon: LayoutGrid\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'sales',\r\n        title: 'Sales',\r\n        icon: DollarSign,\r\n        reports: [\r\n            {\r\n                id: 'sales_dashboard',\r\n                title: 'All in 1 Sales Summary',\r\n                description: 'Comprehensive sales overview',\r\n                icon: FileText\r\n            },\r\n            {\r\n                id: 'daily_sales',\r\n                title: 'Daily Sales',\r\n                description: 'Sales breakdown by day',\r\n                icon: Calendar\r\n            },\r\n            {\r\n                id: 'sales_by_date',\r\n                title: 'Sales By Date',\r\n                description: 'Detailed sales log by date',\r\n                icon: Calendar\r\n            },\r\n            {\r\n                id: 'sales_items_by_date',\r\n                title: 'Sales Items By Date',\r\n                description: 'Itemized sales log',\r\n                icon: List\r\n            },\r\n            {\r\n                id: 'product_performance',\r\n                title: 'Product Sales By SKU',\r\n                description: 'Revenue and quantity per product',\r\n                icon: Package\r\n            },\r\n            {\r\n                id: 'sales_by_category',\r\n                title: 'Product Sales By Category',\r\n                description: 'Performance by product category',\r\n                icon: LayoutGrid\r\n            },\r\n            {\r\n                id: 'sales_by_brand',\r\n                title: 'Product Sales By Brand',\r\n                description: 'Performance by brand',\r\n                icon: LayoutGrid\r\n            },\r\n            {\r\n                id: 'sales_by_customer',\r\n                title: 'Sales By Customer',\r\n                description: 'Revenue per customer',\r\n                icon: Users\r\n            },\r\n            {\r\n                id: 'sales_by_hour',\r\n                title: 'Sales Details By Hours',\r\n                description: 'Peak hour analysis',\r\n                icon: Clock\r\n            },\r\n            {\r\n                id: 'sales_cancellation',\r\n                title: 'Sales Cancellation Details',\r\n                description: 'Voided and cancelled orders',\r\n                icon: AlertTriangle\r\n            },\r\n            {\r\n                id: 'profit_loss',\r\n                title: 'Profit Loss',\r\n                description: 'Income vs Expense analysis',\r\n                icon: TrendingUp\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'inventory',\r\n        title: 'Inventory',\r\n        icon: Package,\r\n        reports: [\r\n            {\r\n                id: 'inventory_dashboard',\r\n                title: 'Product Stock Balance',\r\n                description: 'Current stock levels and valuation',\r\n                icon: LayoutGrid\r\n            },\r\n            {\r\n                id: 'stock_movement',\r\n                title: 'Stock Movement',\r\n                description: 'History of all stock changes',\r\n                icon: History\r\n            },\r\n            {\r\n                id: 'incoming_stock',\r\n                title: 'Incoming Stocks',\r\n                description: 'Purchases and internal transfers in',\r\n                icon: TrendingUp\r\n            },\r\n            {\r\n                id: 'outgoing_stock',\r\n                title: 'Outgoing Stocks',\r\n                description: 'Sales, wastage, and transfers out',\r\n                icon: TrendingDown\r\n            },\r\n            {\r\n                id: 'stock_warning',\r\n                title: 'Product Stock Warning',\r\n                description: 'Low stock and reorder alerts',\r\n                icon: AlertTriangle\r\n            },\r\n            {\r\n                id: 'unsold_products',\r\n                title: 'Product Unsold',\r\n                description: 'Items with no sales in period',\r\n                icon: AlertTriangle\r\n            },\r\n            {\r\n                id: 'expired_stock',\r\n                title: 'Expired Stock',\r\n                description: 'tracked lots that have expired',\r\n                icon: AlertTriangle\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'purchase',\r\n        title: 'Purchases',\r\n        icon: ShoppingCart,\r\n        reports: [\r\n            {\r\n                id: 'purchase_details',\r\n                title: 'Purchase Details',\r\n                description: 'Detailed purchase logs',\r\n                icon: ClipboardList\r\n            },\r\n            {\r\n                id: 'purchase_by_date',\r\n                title: 'Purchase By Date',\r\n                description: 'Purchase history timeline',\r\n                icon: Calendar\r\n            },\r\n            {\r\n                id: 'purchase_by_supplier',\r\n                title: 'Purchase By Supplier',\r\n                description: 'Supplier performance and costs',\r\n                icon: Users\r\n            },\r\n            {\r\n                id: 'purchase_returns',\r\n                title: 'Purchase Returns',\r\n                description: 'Items returned to suppliers',\r\n                icon: TrendingDown\r\n            },\r\n            {\r\n                id: 'outstanding_purchase_payment',\r\n                title: 'Outstanding Payment',\r\n                description: 'Unpaid purchase invoices',\r\n                icon: DollarSign\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'finance',\r\n        title: 'Finance & Payments',\r\n        icon: CreditCard,\r\n        reports: [\r\n            {\r\n                id: 'payment_by_method',\r\n                title: 'Payment By Method',\r\n                description: 'Cash, Card, QRIS, etc.',\r\n                icon: CreditCard\r\n            },\r\n            {\r\n                id: 'cash_balance',\r\n                title: 'Sales Cash Balance',\r\n                description: 'Cash drawer reconciliation',\r\n                icon: DollarSign\r\n            },\r\n            {\r\n                id: 'receivables',\r\n                title: 'Receivables',\r\n                description: 'Customer debts and credit',\r\n                icon: FileText\r\n            },\r\n            {\r\n                id: 'expenses',\r\n                title: 'Expenses by Date',\r\n                description: 'Operational expenses',\r\n                icon: TrendingDown\r\n            },\r\n            {\r\n                id: 'discounts_voids',\r\n                title: 'Discounts & Voids',\r\n                description: 'Analysis of discounts, voids and refunds',\r\n                icon: AlertTriangle\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        id: 'logs',\r\n        title: 'Logs & Audit',\r\n        icon: ShieldAlert,\r\n        reports: [\r\n            {\r\n                id: 'price_changes',\r\n                title: 'Price Changes',\r\n                description: 'History of product price updates',\r\n                icon: DollarSign\r\n            },\r\n            {\r\n                id: 'deleted_products',\r\n                title: 'Product Deleted',\r\n                description: 'Log of removed items',\r\n                icon: FileText\r\n            },\r\n            {\r\n                id: 'audit_log',\r\n                title: 'General Audit Log',\r\n                description: 'System-wide security events',\r\n                icon: ShieldAlert\r\n            },\r\n            {\r\n                id: 'alerts_dashboard',\r\n                title: 'Alerts Dashboard',\r\n                description: 'Smart anomaly detection alerts',\r\n                icon: ShieldAlert\r\n            }\r\n        ]\r\n    }\r\n];\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\ReportsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\SalesReportsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":193,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10429,10432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10429,10432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';\r\nimport { Calendar, Download, TrendingUp, TrendingDown, ArrowUpRight, DollarSign, ShoppingBag, CreditCard, Award } from 'lucide-react';\r\nimport { Card } from '../../components/ui/Card';\r\nimport { Button } from '../../components/ui/Button';\r\nimport { Badge } from '../../components/ui/Badge';\r\n\r\n// Mock Data for the chart\r\nconst chartData = [\r\n    { name: 'Mon', revenue: 4000 },\r\n    { name: 'Tue', revenue: 3000 },\r\n    { name: 'Wed', revenue: 2000 },\r\n    { name: 'Thu', revenue: 2780 },\r\n    { name: 'Fri', revenue: 1890 },\r\n    { name: 'Sat', revenue: 2390 },\r\n    { name: 'Sun', revenue: 3490 },\r\n];\r\n\r\n// Mock Data for transactions\r\nconst recentTransactions = [\r\n    { id: '#ORD-7829', time: '10:24 AM', customer: 'Walk-in Customer', items: '2x Croissant, 1x Latte', total: '€12.50', status: 'completed' },\r\n    { id: '#ORD-7828', time: '10:15 AM', customer: 'John Doe', items: '1x Sourdough Loaf', total: '€6.00', status: 'completed' },\r\n    { id: '#ORD-7827', time: '09:45 AM', customer: 'Alice Smith', items: 'Birthday Cake (Custom)', total: '€45.00', status: 'pending' },\r\n    { id: '#ORD-7826', time: '09:30 AM', customer: 'Walk-in Customer', items: '3x Cookies, 2x Coffee', total: '€18.20', status: 'completed' },\r\n    { id: '#ORD-7825', time: '09:12 AM', customer: 'Bob & Co', items: 'Catering Order (Small)', total: '€120.00', status: 'completed' },\r\n];\r\n\r\nexport default function SalesReportsPage() {\r\n    const [dateRange] = useState('Oct 1, 2023 - Oct 31, 2023');\r\n\r\n    return (\r\n        <div className=\"p-8 max-w-[1600px] mx-auto space-y-8\">\r\n            {/* Header Section */}\r\n            <header className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">Sales Report</h1>\r\n                    <p className=\"text-gray-500 mt-1\">Overview of your bakery's performance.</p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3\">\r\n                    <div className=\"relative group\">\r\n                        <button className=\"flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition-colors\">\r\n                            <Calendar className=\"w-4 h-4 text-gray-500\" />\r\n                            {dateRange}\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"h-6 w-px bg-gray-200 mx-1\"></div>\r\n\r\n                    <Button variant=\"secondary\">\r\n                        <Download className=\"w-4 h-4\" />\r\n                        Export PDF\r\n                    </Button>\r\n                    <Button variant=\"secondary\">\r\n                        <Download className=\"w-4 h-4\" />\r\n                        Export CSV\r\n                    </Button>\r\n                </div>\r\n            </header>\r\n\r\n            {/* KPI Cards Row */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n                <MetricCard\r\n                    title=\"Total Revenue\"\r\n                    value=\"€124,500\"\r\n                    trend=\"+12.5%\"\r\n                    isPositive={true}\r\n                    icon={<DollarSign className=\"w-5 h-5 text-blue-600\" />}\r\n                />\r\n                <MetricCard\r\n                    title=\"Total Orders\"\r\n                    value=\"1,542\"\r\n                    trend=\"+8.2%\"\r\n                    isPositive={true}\r\n                    icon={<ShoppingBag className=\"w-5 h-5 text-purple-600\" />}\r\n                />\r\n                <MetricCard\r\n                    title=\"Avg. Order Value\"\r\n                    value=\"€80.74\"\r\n                    trend=\"-2.1%\"\r\n                    isPositive={false}\r\n                    icon={<CreditCard className=\"w-5 h-5 text-orange-600\" />}\r\n                />\r\n                <MetricCard\r\n                    title=\"Top Product\"\r\n                    value=\"Sourdough\"\r\n                    subValue=\"405 units sold\"\r\n                    icon={<Award className=\"w-5 h-5 text-yellow-600\" />}\r\n                />\r\n            </div>\r\n\r\n            {/* Main Chart Section */}\r\n            <Card className=\"p-1\">\r\n                <div className=\"px-6 py-5 border-b border-gray-100 flex justify-between items-center\">\r\n                    <div>\r\n                        <h3 className=\"text-lg font-semibold text-gray-900\">Revenue Over Time</h3>\r\n                        <p className=\"text-sm text-gray-500\">Gross revenue generated from all sales channels.</p>\r\n                    </div>\r\n                    <select\r\n                        title=\"Select Time Period\"\r\n                        aria-label=\"Select Time Period\"\r\n                        className=\"bg-gray-50 border-none text-sm font-medium text-gray-600 rounded-md py-1.5 pl-3 pr-8 focus:ring-1 focus:ring-blue-500\"\r\n                    >\r\n                        <option>Last 7 Days</option>\r\n                        <option>Last 30 Days</option>\r\n                        <option>This Year</option>\r\n                    </select>\r\n                </div>\r\n                <div className=\"h-[400px] w-full p-6\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <AreaChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>\r\n                            <defs>\r\n                                <linearGradient id=\"colorRevenue\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                    <stop offset=\"5%\" stopColor=\"#3B82F6\" stopOpacity={0.1} />\r\n                                    <stop offset=\"95%\" stopColor=\"#3B82F6\" stopOpacity={0} />\r\n                                </linearGradient>\r\n                            </defs>\r\n                            <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#F1F5F9\" />\r\n                            <XAxis\r\n                                dataKey=\"name\"\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                tick={{ fill: '#64748B', fontSize: 12 }}\r\n                                dy={10}\r\n                            />\r\n                            <YAxis\r\n                                axisLine={false}\r\n                                tickLine={false}\r\n                                tick={{ fill: '#64748B', fontSize: 12 }}\r\n                                tickFormatter={(value) => `€${value}`}\r\n                            />\r\n                            <Tooltip\r\n                                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}\r\n                                itemStyle={{ color: '#1E293B', fontWeight: 600 }}\r\n                            />\r\n                            <Area\r\n                                type=\"monotone\"\r\n                                dataKey=\"revenue\"\r\n                                stroke=\"#3B82F6\"\r\n                                strokeWidth={2}\r\n                                fillOpacity={1}\r\n                                fill=\"url(#colorRevenue)\"\r\n                            />\r\n                        </AreaChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n            </Card>\r\n\r\n            {/* Recent Transactions Table */}\r\n            <Card title=\"Recent Transactions\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full\">\r\n                        <thead>\r\n                            <tr className=\"border-b border-gray-100 bg-gray-50/50\">\r\n                                <th className=\"text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Order ID</th>\r\n                                <th className=\"text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Time</th>\r\n                                <th className=\"text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Customer</th>\r\n                                <th className=\"text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Items</th>\r\n                                <th className=\"text-right py-3 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Amount</th>\r\n                                <th className=\"text-center py-3 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Status</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-gray-100\">\r\n                            {recentTransactions.map((tx) => (\r\n                                <tr key={tx.id} className=\"hover:bg-gray-50/50 transition-colors\">\r\n                                    <td className=\"py-3 px-4 text-sm font-medium text-gray-900\">{tx.id}</td>\r\n                                    <td className=\"py-3 px-4 text-sm text-gray-500\">{tx.time}</td>\r\n                                    <td className=\"py-3 px-4 text-sm text-gray-700\">{tx.customer}</td>\r\n                                    <td className=\"py-3 px-4 text-sm text-gray-600\">{tx.items}</td>\r\n                                    <td className=\"py-3 px-4 text-sm font-semibold text-right text-gray-900\">{tx.total}</td>\r\n                                    <td className=\"py-3 px-4 text-center\">\r\n                                        <Badge variant={tx.status === 'completed' ? 'success' : 'warning'}>\r\n                                            {tx.status}\r\n                                        </Badge>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                <div className=\"border-t border-gray-100 p-4 flex justify-center\">\r\n                    <Button variant=\"ghost\" size=\"sm\">\r\n                        View All Transactions\r\n                        <ArrowUpRight className=\"w-4 h-4\" />\r\n                    </Button>\r\n                </div>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n\r\n// Sub-component for KPI Cards to keep main clean\r\nfunction MetricCard({ title, value, trend, isPositive, subValue, icon }: any) {\r\n    return (\r\n        <div className=\"bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-[140px] relative overflow-hidden group hover:shadow-md transition-shadow\">\r\n            <div className=\"flex justify-between items-start mb-2\">\r\n                <span className=\"text-sm font-medium text-gray-500\">{title}</span>\r\n                <div className=\"p-2 bg-gray-50 rounded-lg group-hover:bg-blue-50 transition-colors\">\r\n                    {icon}\r\n                </div>\r\n            </div>\r\n\r\n            <div>\r\n                <div className=\"text-2xl font-bold text-gray-900\">{value}</div>\r\n                {subValue && <div className=\"text-sm text-gray-500 mt-1\">{subValue}</div>}\r\n            </div>\r\n\r\n            {trend && (\r\n                <div className={`flex items-center gap-1 text-sm font-medium mt-auto ${isPositive ? 'text-green-600' : 'text-red-600'}`}>\r\n                    {isPositive ? <TrendingUp className=\"w-4 h-4\" /> : <TrendingDown className=\"w-4 h-4\" />}\r\n                    {trend}\r\n                    <span className=\"text-gray-400 font-normal ml-1\">vs last month</span>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\AuditTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\B2BReceivablesTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\DailySalesTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4767,4770],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4767,4770],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4778,4781],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4778,4781],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo } from 'react';\r\nimport { useQuery } from '@tanstack/react-query';\r\nimport {\r\n  BarChart,\r\n  Bar,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  Legend,\r\n} from 'recharts';\r\nimport { DollarSign, ShoppingCart, TrendingUp, Loader2 } from 'lucide-react';\r\nimport { ReportingService } from '@/services/ReportingService';\r\nimport { DateRangePicker } from '@/components/reports/DateRangePicker';\r\nimport { ExportButtons, ExportConfig } from '@/components/reports/ExportButtons';\r\nimport { useDateRange } from '@/hooks/reports/useDateRange';\r\nimport { formatCurrency } from '@/utils/helpers';\r\nimport type { DailySalesStat } from '@/types/reporting';\r\n\r\nexport const DailySalesTab = () => {\r\n  const { dateRange } = useDateRange({ defaultPreset: 'last30days' });\r\n\r\n  const { data = [], isLoading, error } = useQuery({\r\n    queryKey: ['dailySales', dateRange.from, dateRange.to],\r\n    queryFn: () => ReportingService.getDailySales(dateRange.from, dateRange.to),\r\n    staleTime: 5 * 60 * 1000,\r\n  });\r\n\r\n  // KPI totals\r\n  const totals = useMemo(() => {\r\n    if (data.length === 0) {\r\n      return { revenue: 0, orders: 0, avgDaily: 0, avgBasket: 0 };\r\n    }\r\n    const revenue = data.reduce((s, d) => s + (d.total_sales || 0), 0);\r\n    const orders = data.reduce((s, d) => s + (d.total_orders || 0), 0);\r\n    return {\r\n      revenue,\r\n      orders,\r\n      avgDaily: revenue / data.length,\r\n      avgBasket: orders > 0 ? revenue / orders : 0,\r\n    };\r\n  }, [data]);\r\n\r\n  // Export config\r\n  const exportConfig: ExportConfig<DailySalesStat> = useMemo(() => ({\r\n    data,\r\n    columns: [\r\n      { key: 'date', header: 'Date', format: (v) => new Date(v as string).toLocaleDateString() },\r\n      { key: 'total_orders', header: 'Orders' },\r\n      { key: 'total_sales', header: 'Revenue', format: (v) => formatCurrency(v as number) },\r\n      { key: 'net_revenue', header: 'Net Revenue', format: (v) => formatCurrency(v as number) },\r\n      { key: 'avg_basket', header: 'Avg Basket', format: (v) => formatCurrency(v as number) },\r\n    ],\r\n    filename: 'daily-sales',\r\n    title: 'Daily Sales Report',\r\n    dateRange: { from: dateRange.from, to: dateRange.to },\r\n  }), [data, dateRange]);\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"p-8 text-center text-red-600\">\r\n        Error loading daily sales data. Please try again.\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header: DateRangePicker + ExportButtons */}\r\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\r\n        <DateRangePicker defaultPreset=\"last30days\" />\r\n        <ExportButtons config={exportConfig} />\r\n      </div>\r\n\r\n      {/* KPI Summary Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        <KpiCard icon={<DollarSign className=\"w-5 h-5 text-blue-600\" />} bg=\"bg-blue-50\"\r\n          label=\"Total Revenue\" value={isLoading ? null : formatCurrency(totals.revenue)} />\r\n        <KpiCard icon={<ShoppingCart className=\"w-5 h-5 text-green-600\" />} bg=\"bg-green-50\"\r\n          label=\"Total Orders\" value={isLoading ? null : totals.orders.toLocaleString()} />\r\n        <KpiCard icon={<TrendingUp className=\"w-5 h-5 text-purple-600\" />} bg=\"bg-purple-50\"\r\n          label=\"Avg Daily Revenue\" value={isLoading ? null : formatCurrency(totals.avgDaily)} />\r\n        <KpiCard icon={<DollarSign className=\"w-5 h-5 text-amber-600\" />} bg=\"bg-amber-50\"\r\n          label=\"Avg Basket\" value={isLoading ? null : formatCurrency(totals.avgBasket)} />\r\n      </div>\r\n\r\n      {/* Chart */}\r\n      <div className=\"bg-white rounded-xl border border-gray-200 shadow-sm p-6\">\r\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Daily Sales Performance</h3>\r\n        {isLoading ? (\r\n          <div className=\"h-80 flex items-center justify-center\">\r\n            <Loader2 className=\"w-8 h-8 animate-spin text-gray-400\" />\r\n          </div>\r\n        ) : data.length === 0 ? (\r\n          <div className=\"h-80 flex items-center justify-center text-gray-500\">\r\n            No data available for this period.\r\n          </div>\r\n        ) : (\r\n          <ResponsiveContainer width=\"100%\" height={320}>\r\n            <BarChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>\r\n              <CartesianGrid strokeDasharray=\"3 3\" vertical={false} />\r\n              <XAxis\r\n                dataKey=\"date\"\r\n                tickFormatter={(v) => new Date(v).toLocaleDateString(undefined, { day: '2-digit', month: 'short' })}\r\n              />\r\n              <YAxis yAxisId=\"left\" orientation=\"left\" stroke=\"#8884d8\" />\r\n              <YAxis yAxisId=\"right\" orientation=\"right\" stroke=\"#82ca9d\" />\r\n              <Tooltip\r\n                formatter={(value: any, name: any) => {\r\n                  if (name === 'Revenue' || name === 'Net Revenue') return formatCurrency(value);\r\n                  return value;\r\n                }}\r\n                labelFormatter={(label) => new Date(label).toLocaleDateString()}\r\n              />\r\n              <Legend />\r\n              <Bar yAxisId=\"left\" dataKey=\"total_sales\" name=\"Revenue\" fill=\"#8884d8\" radius={[4, 4, 0, 0]} />\r\n              <Bar yAxisId=\"right\" dataKey=\"total_orders\" name=\"Orders\" fill=\"#82ca9d\" radius={[4, 4, 0, 0]} />\r\n            </BarChart>\r\n          </ResponsiveContainer>\r\n        )}\r\n      </div>\r\n\r\n      {/* Data Table */}\r\n      <div className=\"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden\">\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"min-w-full divide-y divide-gray-200\">\r\n            <thead className=\"bg-gray-50\">\r\n              <tr>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Date</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Orders</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Revenue</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Net (ex. Tax)</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Avg Basket</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"bg-white divide-y divide-gray-200\">\r\n              {isLoading ? (\r\n                <tr>\r\n                  <td colSpan={5} className=\"px-6 py-8 text-center\">\r\n                    <Loader2 className=\"w-6 h-6 animate-spin mx-auto text-gray-400\" />\r\n                  </td>\r\n                </tr>\r\n              ) : data.length === 0 ? (\r\n                <tr>\r\n                  <td colSpan={5} className=\"px-6 py-12 text-center text-gray-400\">\r\n                    No data available.\r\n                  </td>\r\n                </tr>\r\n              ) : (\r\n                data.map((row) => (\r\n                  <tr key={row.date} className=\"hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\r\n                      {new Date(row.date).toLocaleDateString()}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right\">\r\n                      {row.total_orders}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right\">\r\n                      {formatCurrency(row.total_sales)}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right\">\r\n                      {formatCurrency(row.net_revenue)}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right\">\r\n                      {formatCurrency(row.avg_basket)}\r\n                    </td>\r\n                  </tr>\r\n                ))\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nfunction KpiCard({ icon, bg, label, value }: {\r\n  icon: React.ReactNode; bg: string; label: string; value: string | null;\r\n}) {\r\n  return (\r\n    <div className=\"bg-white rounded-xl p-5 border border-gray-200 shadow-sm\">\r\n      <div className=\"flex items-center gap-3 mb-2\">\r\n        <div className={`p-2 ${bg} rounded-lg`}>{icon}</div>\r\n        <span className=\"text-sm text-gray-600\">{label}</span>\r\n      </div>\r\n      <p className=\"text-2xl font-bold text-gray-900\">\r\n        {value === null ? <Loader2 className=\"w-6 h-6 animate-spin\" /> : value}\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\DeletedProductsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\ExpensesTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\ExpiredStockTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\InventoryTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\OutstandingPurchasePaymentTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\OverviewTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\PaymentMethodTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\PriceChangesTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\ProductPerformanceTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\ProfitLossTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\PurchaseByDateTab.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'itemsByPo' is never reassigned. Use 'const' instead.","line":46,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":46,"endColumn":16,"fix":{"range":[1649,1691],"text":"const itemsByPo = new Map<string, number>();"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { useMemo } from 'react';\r\nimport { useQuery } from '@tanstack/react-query';\r\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';\r\nimport { ShoppingCart, Calendar, Loader2, DollarSign, Package } from 'lucide-react';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { DateRangePicker } from '@/components/reports/DateRangePicker';\r\nimport { ExportButtons, ExportConfig } from '@/components/reports/ExportButtons';\r\nimport { useDateRange } from '@/hooks/reports/useDateRange';\r\nimport { formatCurrency as formatCurrencyPdf } from '@/services/reports/pdfExport';\r\n\r\ninterface PurchaseByDate {\r\n  date: string;\r\n  order_count: number;\r\n  total_amount: number;\r\n  items_count: number;\r\n}\r\n\r\n// Types for Supabase query results\r\ninterface PurchaseOrderQueryResult {\r\n  id: string;\r\n  order_date: string;\r\n  total_amount: number | null;\r\n}\r\n\r\ninterface POItemQueryResult {\r\n  purchase_order_id: string;\r\n  quantity: number;\r\n}\r\n\r\nasync function getPurchasesByDate(from: Date, to: Date): Promise<PurchaseByDate[]> {\r\n  // Fetch purchase orders\r\n  const { data: orders, error: ordersError } = await supabase\r\n    .from('purchase_orders')\r\n    .select('id, order_date, total_amount')\r\n    .gte('order_date', from.toISOString().split('T')[0])\r\n    .lte('order_date', to.toISOString().split('T')[0])\r\n    .in('status', ['received', 'partial'])\r\n    .order('order_date', { ascending: true });\r\n\r\n  if (ordersError) throw ordersError;\r\n\r\n  const purchaseOrders = (orders || []) as PurchaseOrderQueryResult[];\r\n  const poIds = purchaseOrders.map((po) => po.id);\r\n\r\n  // Fetch items count for these POs\r\n  let itemsByPo = new Map<string, number>();\r\n  if (poIds.length > 0) {\r\n    const { data: items } = await supabase\r\n      .from('purchase_order_items')\r\n      .select('purchase_order_id, quantity')\r\n      .in('purchase_order_id', poIds);\r\n\r\n    // Group items by PO\r\n    ((items || []) as POItemQueryResult[]).forEach((item) => {\r\n      const current = itemsByPo.get(item.purchase_order_id) || 0;\r\n      itemsByPo.set(item.purchase_order_id, current + (item.quantity || 0));\r\n    });\r\n  }\r\n\r\n  // Group by date\r\n  const dateMap = new Map<string, { orders: number; amount: number; items: number }>();\r\n\r\n  purchaseOrders.forEach((po) => {\r\n    const date = po.order_date;\r\n    const existing = dateMap.get(date) || { orders: 0, amount: 0, items: 0 };\r\n    const poItemsCount = itemsByPo.get(po.id) || 0;\r\n\r\n    dateMap.set(date, {\r\n      orders: existing.orders + 1,\r\n      amount: existing.amount + (po.total_amount || 0),\r\n      items: existing.items + poItemsCount,\r\n    });\r\n  });\r\n\r\n  return Array.from(dateMap.entries()).map(([date, stats]) => ({\r\n    date,\r\n    order_count: stats.orders,\r\n    total_amount: stats.amount,\r\n    items_count: stats.items,\r\n  }));\r\n}\r\n\r\nexport function PurchaseByDateTab() {\r\n  const { dateRange } = useDateRange({ defaultPreset: 'thisMonth' });\r\n\r\n  const { data, isLoading, error } = useQuery({\r\n    queryKey: ['purchases-by-date', dateRange.from, dateRange.to],\r\n    queryFn: () => getPurchasesByDate(dateRange.from, dateRange.to),\r\n    staleTime: 5 * 60 * 1000,\r\n  });\r\n\r\n  // Chart data\r\n  const chartData = useMemo(() => {\r\n    if (!data) return [];\r\n    return data.map((d) => ({\r\n      date: new Date(d.date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }),\r\n      amount: d.total_amount,\r\n      orders: d.order_count,\r\n    }));\r\n  }, [data]);\r\n\r\n  // Summary stats\r\n  const summary = useMemo(() => {\r\n    if (!data || data.length === 0) {\r\n      return { totalOrders: 0, totalAmount: 0, totalItems: 0 };\r\n    }\r\n\r\n    return {\r\n      totalOrders: data.reduce((sum, d) => sum + d.order_count, 0),\r\n      totalAmount: data.reduce((sum, d) => sum + d.total_amount, 0),\r\n      totalItems: data.reduce((sum, d) => sum + d.items_count, 0),\r\n    };\r\n  }, [data]);\r\n\r\n  // Export config\r\n  const exportConfig: ExportConfig<PurchaseByDate> = useMemo(() => ({\r\n    data: data || [],\r\n    columns: [\r\n      { key: 'date', header: 'Date', format: (v) => new Date(v as string).toLocaleDateString('fr-FR') },\r\n      { key: 'order_count', header: 'Commandes', align: 'right' as const },\r\n      { key: 'items_count', header: 'Articles', align: 'right' as const },\r\n      { key: 'total_amount', header: 'Montant', align: 'right' as const, format: (v) => formatCurrencyPdf(v as number) },\r\n    ],\r\n    filename: 'achats_par_date',\r\n    title: 'Achats par Date',\r\n    dateRange,\r\n    summaries: [\r\n      { label: 'Total commandes', value: summary.totalOrders.toString() },\r\n      { label: 'Total achats', value: formatCurrencyPdf(summary.totalAmount) },\r\n    ],\r\n  }), [data, dateRange, summary]);\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 0 }).format(value) + ' IDR';\r\n  };\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"p-8 text-center text-red-600\">\r\n        Error loading data\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\r\n        <DateRangePicker defaultPreset=\"thisMonth\" />\r\n        <ExportButtons config={exportConfig} />\r\n      </div>\r\n\r\n      {/* Summary Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n        <div className=\"bg-white rounded-xl p-5 border border-gray-200 shadow-sm\">\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <div className=\"p-2 bg-blue-50 rounded-lg\">\r\n              <ShoppingCart className=\"w-5 h-5 text-blue-600\" />\r\n            </div>\r\n            <span className=\"text-sm text-gray-600\">Total commandes</span>\r\n          </div>\r\n          <p className=\"text-2xl font-bold text-gray-900\">\r\n            {isLoading ? <Loader2 className=\"w-6 h-6 animate-spin\" /> : summary.totalOrders}\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-xl p-5 border border-gray-200 shadow-sm\">\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <div className=\"p-2 bg-green-50 rounded-lg\">\r\n              <DollarSign className=\"w-5 h-5 text-green-600\" />\r\n            </div>\r\n            <span className=\"text-sm text-gray-600\">Total achats</span>\r\n          </div>\r\n          <p className=\"text-2xl font-bold text-gray-900\">\r\n            {isLoading ? <Loader2 className=\"w-6 h-6 animate-spin\" /> : formatCurrency(summary.totalAmount)}\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-xl p-5 border border-gray-200 shadow-sm\">\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <div className=\"p-2 bg-purple-50 rounded-lg\">\r\n              <Package className=\"w-5 h-5 text-purple-600\" />\r\n            </div>\r\n            <span className=\"text-sm text-gray-600\">Total articles</span>\r\n          </div>\r\n          <p className=\"text-2xl font-bold text-gray-900\">\r\n            {isLoading ? <Loader2 className=\"w-6 h-6 animate-spin\" /> : summary.totalItems}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Chart */}\r\n      <div className=\"bg-white rounded-xl border border-gray-200 shadow-sm p-6\">\r\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-6\">Évolution des achats</h3>\r\n\r\n        {isLoading ? (\r\n          <div className=\"h-80 flex items-center justify-center\">\r\n            <Loader2 className=\"w-8 h-8 animate-spin text-gray-400\" />\r\n          </div>\r\n        ) : chartData.length === 0 ? (\r\n          <div className=\"h-80 flex items-center justify-center text-gray-500\">\r\n            Aucun achat sur cette période\r\n          </div>\r\n        ) : (\r\n          <ResponsiveContainer width=\"100%\" height={320}>\r\n            <BarChart data={chartData}>\r\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#E5E7EB\" />\r\n              <XAxis dataKey=\"date\" tick={{ fontSize: 11 }} />\r\n              <YAxis tickFormatter={(v) => `${(v / 1000000).toFixed(1)}M`} tick={{ fontSize: 12 }} />\r\n              <Tooltip formatter={(value) => [formatCurrency(value as number), 'Achats']} />\r\n              <Bar dataKey=\"amount\" fill=\"#3B82F6\" radius={[4, 4, 0, 0]} />\r\n            </BarChart>\r\n          </ResponsiveContainer>\r\n        )}\r\n      </div>\r\n\r\n      {/* Data Table */}\r\n      <div className=\"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden\">\r\n        <div className=\"px-6 py-4 border-b border-gray-200\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900\">Détail par date</h3>\r\n        </div>\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"w-full\">\r\n            <thead className=\"bg-gray-50\">\r\n              <tr>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Date</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase\">Commandes</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase\">Articles</th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase\">Montant</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"divide-y divide-gray-200\">\r\n              {isLoading ? (\r\n                <tr>\r\n                  <td colSpan={4} className=\"px-6 py-8 text-center\">\r\n                    <Loader2 className=\"w-6 h-6 animate-spin mx-auto text-gray-400\" />\r\n                  </td>\r\n                </tr>\r\n              ) : data && data.length > 0 ? (\r\n                data.map((row) => (\r\n                  <tr key={row.date} className=\"hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-4 text-sm font-medium text-gray-900\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Calendar className=\"w-4 h-4 text-gray-400\" />\r\n                        {new Date(row.date).toLocaleDateString('fr-FR', {\r\n                          weekday: 'short',\r\n                          day: '2-digit',\r\n                          month: 'short',\r\n                          year: 'numeric',\r\n                        })}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4 text-sm text-gray-600 text-right\">{row.order_count}</td>\r\n                    <td className=\"px-6 py-4 text-sm text-gray-600 text-right\">{row.items_count}</td>\r\n                    <td className=\"px-6 py-4 text-sm text-gray-900 text-right font-medium\">\r\n                      {formatCurrency(row.total_amount)}\r\n                    </td>\r\n                  </tr>\r\n                ))\r\n              ) : (\r\n                <tr>\r\n                  <td colSpan={4} className=\"px-6 py-8 text-center text-gray-500\">\r\n                    Aucun achat sur cette période\r\n                  </td>\r\n                </tr>\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\PurchaseBySupplierTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[560,563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[560,563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport {\r\n    BarChart,\r\n    Bar,\r\n    XAxis,\r\n    YAxis,\r\n    CartesianGrid,\r\n    Tooltip,\r\n    Legend,\r\n    ResponsiveContainer,\r\n    Cell\r\n} from 'recharts';\r\nimport { ReportingService } from '../../../services/ReportingService';\r\nimport { formatCurrency } from '../../../utils/helpers';\r\n\r\nconst COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];\r\n\r\nexport const PurchaseBySupplierTab = () => {\r\n    const [loading, setLoading] = useState(true);\r\n    const [data, setData] = useState<any[]>([]);\r\n    const [dateRange] = useState({\r\n        start: new Date(new Date().setDate(new Date().getDate() - 30)),\r\n        end: new Date()\r\n    });\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, [dateRange]);\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            const result = await ReportingService.getPurchaseBySupplier(dateRange.start, dateRange.end);\r\n            setData(result);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    if (loading) return <div className=\"p-8 text-center text-gray-500\">Loading...</div>;\r\n\r\n    const totalValue = data.reduce((acc, curr) => acc + curr.total_value, 0);\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <h3 className=\"text-lg font-medium text-gray-900\">\r\n                Purchase By Supplier\r\n            </h3>\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                {/* Chart */}\r\n                <div className=\"bg-white p-6 rounded-lg border border-gray-200 shadow-sm h-80\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <BarChart\r\n                            data={data}\r\n                            layout=\"vertical\"\r\n                            margin={{\r\n                                top: 5,\r\n                                right: 30,\r\n                                left: 20,\r\n                                bottom: 5,\r\n                            }}\r\n                        >\r\n                            <CartesianGrid strokeDasharray=\"3 3\" />\r\n                            <XAxis type=\"number\" tickFormatter={(value) => formatCurrency(value)} />\r\n                            <YAxis dataKey=\"supplier_name\" type=\"category\" width={100} />\r\n                            <Tooltip formatter={(value) => formatCurrency(value as number)} />\r\n                            <Legend />\r\n                            <Bar dataKey=\"total_value\" name=\"Total Purchase Value\" fill=\"#8884d8\">\r\n                                {data.map((_, index) => (\r\n                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\r\n                                ))}\r\n                            </Bar>\r\n                        </BarChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n\r\n                {/* Summary Cards */}\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"bg-blue-50 p-4 rounded-lg\">\r\n                        <p className=\"text-sm text-blue-600 font-medium\">Total Purchase Value</p>\r\n                        <p className=\"text-2xl font-bold text-blue-900\">{formatCurrency(totalValue)}</p>\r\n                    </div>\r\n                    <div className=\"bg-green-50 p-4 rounded-lg\">\r\n                        <p className=\"text-sm text-green-600 font-medium\">Top Supplier</p>\r\n                        <p className=\"text-lg font-bold text-green-900\">\r\n                            {data.length > 0 ? data[0].supplier_name : '-'}\r\n                        </p>\r\n                        <p className=\"text-xs text-green-700\">\r\n                            {data.length > 0 ? formatCurrency(data[0].total_value) : ''}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Table */}\r\n            <div className=\"bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm\">\r\n                <table className=\"min-w-full divide-y divide-gray-200\">\r\n                    <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Supplier Name</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Transactions</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Total Quantity</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Total Value</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">% Total</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                        {data.map((row) => (\r\n                            <tr key={row.supplier_name} className=\"hover:bg-gray-50\">\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">\r\n                                    {row.supplier_name}\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right\">\r\n                                    {row.transaction_count}\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right\">\r\n                                    {row.total_quantity}\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right\">\r\n                                    {formatCurrency(row.total_value)}\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right\">\r\n                                    {totalValue > 0 ? ((row.total_value / totalValue) * 100).toFixed(1) + '%' : '0%'}\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                        {data.length === 0 && (\r\n                            <tr>\r\n                                <td colSpan={5} className=\"px-6 py-12 text-center text-gray-400\">\r\n                                    No data available.\r\n                                </td>\r\n                            </tr>\r\n                        )}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\PurchaseDetailsTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[349,352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[349,352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { Search } from 'lucide-react';\r\nimport { ReportingService } from '../../../services/ReportingService';\r\nimport { formatCurrency } from '../../../utils/helpers';\r\n\r\nexport const PurchaseDetailsTab = () => {\r\n    const [loading, setLoading] = useState(true);\r\n    const [data, setData] = useState<any[]>([]);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [dateRange] = useState({\r\n        start: new Date(new Date().setDate(new Date().getDate() - 30)),\r\n        end: new Date()\r\n    });\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, [dateRange]);\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            const result = await ReportingService.getPurchaseDetails(dateRange.start, dateRange.end);\r\n            setData(result);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const filteredData = data.filter(item =>\r\n        item.product?.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        item.product?.sku?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        item.reference_id?.toLowerCase().includes(searchTerm.toLowerCase())\r\n    );\r\n\r\n    const totalCost = filteredData.reduce((acc, curr) => {\r\n        const cost = curr.product?.cost_price || 0;\r\n        return acc + (cost * curr.quantity);\r\n    }, 0);\r\n\r\n    if (loading) return <div className=\"p-8 text-center text-gray-500\">Loading...</div>;\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex justify-between items-end\">\r\n                <div>\r\n                    <h3 className=\"text-lg font-medium text-gray-900\">\r\n                        Purchase Details\r\n                    </h3>\r\n                    <p className=\"text-sm text-gray-500 mt-1\">\r\n                        History of all incoming stock marked as purchase\r\n                    </p>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                    <p className=\"text-sm text-gray-500\">Total Purchase Value (Est.)</p>\r\n                    <p className=\"text-2xl font-bold text-gray-900\">{formatCurrency(totalCost)}</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"flex justify-between items-center gap-4\">\r\n                <div className=\"relative flex-1 max-w-md\">\r\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Search product, SKU or Ref...\"\r\n                        className=\"pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm\">\r\n                <table className=\"min-w-full divide-y divide-gray-200\">\r\n                    <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Date</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Product</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Supplier</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Reference (PO#)</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Quantity</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Unit Cost (Est.)</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Total Value</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Staff</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                        {filteredData.map((row) => {\r\n                            const unitCost = row.product?.cost_price || 0;\r\n                            const totalValue = unitCost * row.quantity;\r\n                            return (\r\n                                <tr key={row.id} className=\"hover:bg-gray-50\">\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                                        {new Date(row.created_at).toLocaleDateString()}\r\n                                        <div className=\"text-xs text-gray-400\">\r\n                                            {new Date(row.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                                        </div>\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">\r\n                                        {row.product?.name || 'Unknown Product'}\r\n                                        <div className=\"text-xs text-gray-400 font-mono\">{row.product?.sku}</div>\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                                        {row.supplier?.name || '-'}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                                        {row.reference_id ? (\r\n                                            <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800\">\r\n                                                {row.reference_id}\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"text-gray-300\">-</span>\r\n                                        )}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-gray-900\">\r\n                                        {row.quantity} {row.product?.unit}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500\">\r\n                                        {formatCurrency(unitCost)}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-gray-900\">\r\n                                        {formatCurrency(totalValue)}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                                        {row.staff?.name || '-'}\r\n                                    </td>\r\n                                </tr>\r\n                            );\r\n                        })}\r\n                        {filteredData.length === 0 && (\r\n                            <tr>\r\n                                <td colSpan={8} className=\"px-6 py-12 text-center text-gray-400\">\r\n                                    No data available.\r\n                                </td>\r\n                            </tr>\r\n                        )}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\SalesByCategoryTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\SalesByCustomerTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\SalesByHourTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\SalesCancellationTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\SalesTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\SessionCashBalanceTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\StockMovementTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[249,252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[249,252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { ReportingService } from '../../../services/ReportingService';\r\n\r\nexport const StockMovementTab = () => {\r\n    const [loading, setLoading] = useState(true);\r\n    const [data, setData] = useState<any[]>([]);\r\n    const [dateRange] = useState({\r\n        start: new Date(new Date().setDate(new Date().getDate() - 30)),\r\n        end: new Date()\r\n    });\r\n\r\n    useEffect(() => {\r\n        loadData();\r\n    }, [dateRange]);\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            const movements = await ReportingService.getStockMovements(dateRange.start, dateRange.end);\r\n            setData(movements);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    if (loading) return <div className=\"p-8 text-center text-gray-500\">Loading...</div>;\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex justify-between items-center\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">\r\n                    Stock Movement History\r\n                </h3>\r\n            </div>\r\n\r\n            <div className=\"bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm\">\r\n                <table className=\"min-w-full divide-y divide-gray-200\">\r\n                    <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Date</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Product</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Type</th>\r\n                            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">Quantity</th>\r\n                            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Reason/Ref</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                        {data.map((row) => (\r\n                            <tr key={row.id} className=\"hover:bg-gray-50\">\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                                    {new Date(row.created_at).toLocaleDateString()}\r\n                                    <div className=\"text-xs text-gray-400\">\r\n                                        {new Date(row.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                                    </div>\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">\r\n                                    {row.product?.name || 'Unknown Product'}\r\n                                    <div className=\"text-xs text-gray-400 font-mono\">{row.product?.sku}</div>\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm\">\r\n                                    <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full\r\n                                        ${row.movement_type === 'sale' ? 'bg-green-100 text-green-800' :\r\n                                            row.movement_type === 'waste' ? 'bg-red-100 text-red-800' :\r\n                                                row.movement_type === 'purchase' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>\r\n                                        {row.movement_type}\r\n                                    </span>\r\n                                </td>\r\n                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-right font-bold ${row.quantity > 0 ? 'text-blue-600' : 'text-orange-600'}`}>\r\n                                    {row.quantity > 0 ? '+' : ''}{row.quantity} {row.product?.unit}\r\n                                </td>\r\n                                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                                    {row.reason ? (\r\n                                        <div className=\"max-w-xs truncate\" title={row.reason}>{row.reason}</div>\r\n                                    ) : (\r\n                                        <span className=\"text-gray-300\">-</span>\r\n                                    )}\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                        {data.length === 0 && (\r\n                            <tr>\r\n                                <td colSpan={5} className=\"px-6 py-12 text-center text-gray-400\">\r\n                                    No data available.\r\n                                </td>\r\n                            </tr>\r\n                        )}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\StockWarningTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\reports\\components\\UnsoldProductsTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\AuditPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\BusinessHoursPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":73,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { Save, Clock, AlertCircle } from 'lucide-react';\r\nimport { useBusinessHours, useUpdateBusinessHours } from '../../hooks/settings';\r\nimport type { BusinessHours } from '../../types/settings';\r\nimport { toast } from 'sonner';\r\n\r\nconst DAY_NAMES: Record<string, string[]> = {\r\n  fr: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],\r\n  en: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],\r\n  id: ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'],\r\n};\r\n\r\nconst BusinessHoursPage = () => {\r\n  const { data: businessHours, isLoading } = useBusinessHours();\r\n  const updateHours = useUpdateBusinessHours();\r\n\r\n  const [localHours, setLocalHours] = useState<BusinessHours[]>([]);\r\n  const [pendingChanges, setPendingChanges] = useState<Set<number>>(new Set());\r\n  const [isSaving, setIsSaving] = useState(false);\r\n\r\n  // Use English day names\r\n  const dayNames = DAY_NAMES.en;\r\n\r\n  // Initialize local state\r\n  useEffect(() => {\r\n    if (businessHours) {\r\n      setLocalHours([...businessHours].sort((a, b) => a.day_of_week - b.day_of_week));\r\n      setPendingChanges(new Set());\r\n    }\r\n  }, [businessHours]);\r\n\r\n  // Handle change\r\n  const handleChange = (dayOfWeek: number, field: keyof BusinessHours, value: unknown) => {\r\n    setLocalHours((prev) =>\r\n      prev.map((h) =>\r\n        h.day_of_week === dayOfWeek ? { ...h, [field]: value } : h\r\n      )\r\n    );\r\n    setPendingChanges((prev) => new Set(prev).add(dayOfWeek));\r\n  };\r\n\r\n  // Handle toggle closed\r\n  const handleToggleClosed = (dayOfWeek: number) => {\r\n    const hours = localHours.find((h) => h.day_of_week === dayOfWeek);\r\n    if (hours) {\r\n      handleChange(dayOfWeek, 'is_closed', !hours.is_closed);\r\n    }\r\n  };\r\n\r\n  // Save all changes\r\n  const handleSaveAll = async () => {\r\n    if (pendingChanges.size === 0) return;\r\n\r\n    setIsSaving(true);\r\n    const errors: number[] = [];\r\n\r\n    try {\r\n      for (const dayOfWeek of pendingChanges) {\r\n        const hours = localHours.find((h) => h.day_of_week === dayOfWeek);\r\n        if (!hours) continue;\r\n\r\n        try {\r\n          await updateHours.mutateAsync({\r\n            dayOfWeek,\r\n            updates: {\r\n              open_time: hours.open_time,\r\n              close_time: hours.close_time,\r\n              is_closed: hours.is_closed,\r\n              break_start: hours.break_start,\r\n              break_end: hours.break_end,\r\n            },\r\n          });\r\n        } catch (error) {\r\n          errors.push(dayOfWeek);\r\n        }\r\n      }\r\n\r\n      if (errors.length === 0) {\r\n        toast.success('Business hours saved');\r\n        setPendingChanges(new Set());\r\n      } else {\r\n        toast.error(`Error on ${errors.length} day(s)`);\r\n      }\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  // Apply to all days\r\n  const applyToAll = (sourceDay: BusinessHours) => {\r\n    setLocalHours((prev) =>\r\n      prev.map((h) => ({\r\n        ...h,\r\n        open_time: sourceDay.open_time,\r\n        close_time: sourceDay.close_time,\r\n        is_closed: sourceDay.is_closed,\r\n        break_start: sourceDay.break_start,\r\n        break_end: sourceDay.break_end,\r\n      }))\r\n    );\r\n    setPendingChanges(new Set([0, 1, 2, 3, 4, 5, 6]));\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"settings-section\">\r\n        <div className=\"settings-section__body settings-section__loading\">\r\n          <div className=\"spinner\" />\r\n          <span>Loading...</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"settings-section\">\r\n      <div className=\"settings-section__header\">\r\n        <div className=\"settings-section__header-content\">\r\n          <div>\r\n            <h2 className=\"settings-section__title\">Business Hours</h2>\r\n            <p className=\"settings-section__description\">\r\n              Configure the opening hours of your establishment\r\n            </p>\r\n          </div>\r\n          {pendingChanges.size > 0 && (\r\n            <button\r\n              className=\"btn-primary\"\r\n              onClick={handleSaveAll}\r\n              disabled={isSaving}\r\n            >\r\n              <Save size={16} />\r\n              {isSaving ? 'Saving...' : `Save (${pendingChanges.size})`}\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"settings-section__body\">\r\n        <div className=\"business-hours-list\">\r\n          {localHours.map((hours) => (\r\n            <div\r\n              key={hours.day_of_week}\r\n              className={`business-hours-item ${hours.is_closed ? 'is-closed' : ''} ${\r\n                pendingChanges.has(hours.day_of_week) ? 'has-changes' : ''\r\n              }`}\r\n            >\r\n              <div className=\"business-hours-item__day\">\r\n                <span className=\"business-hours-item__day-name\">\r\n                  {dayNames[hours.day_of_week]}\r\n                </span>\r\n                <button\r\n                  className={`toggle-mini ${!hours.is_closed ? 'is-on' : ''}`}\r\n                  onClick={() => handleToggleClosed(hours.day_of_week)}\r\n                  title={hours.is_closed ? 'Open' : 'Close'}\r\n                />\r\n              </div>\r\n\r\n              {!hours.is_closed ? (\r\n                <div className=\"business-hours-item__times\">\r\n                  <div className=\"business-hours-item__time-group\">\r\n                    <label>Opening</label>\r\n                    <input\r\n                      type=\"time\"\r\n                      className=\"business-hours-input\"\r\n                      value={hours.open_time || ''}\r\n                      onChange={(e) => handleChange(hours.day_of_week, 'open_time', e.target.value || null)}\r\n                    />\r\n                  </div>\r\n                  <span className=\"business-hours-item__separator\">-</span>\r\n                  <div className=\"business-hours-item__time-group\">\r\n                    <label>Closing</label>\r\n                    <input\r\n                      type=\"time\"\r\n                      className=\"business-hours-input\"\r\n                      value={hours.close_time || ''}\r\n                      onChange={(e) => handleChange(hours.day_of_week, 'close_time', e.target.value || null)}\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"business-hours-item__break\">\r\n                    <span className=\"business-hours-item__break-label\">Break:</span>\r\n                    <input\r\n                      type=\"time\"\r\n                      className=\"business-hours-input business-hours-input--small\"\r\n                      value={hours.break_start || ''}\r\n                      onChange={(e) => handleChange(hours.day_of_week, 'break_start', e.target.value || null)}\r\n                      placeholder=\"Start\"\r\n                    />\r\n                    <span>-</span>\r\n                    <input\r\n                      type=\"time\"\r\n                      className=\"business-hours-input business-hours-input--small\"\r\n                      value={hours.break_end || ''}\r\n                      onChange={(e) => handleChange(hours.day_of_week, 'break_end', e.target.value || null)}\r\n                      placeholder=\"End\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div className=\"business-hours-item__closed\">\r\n                  <Clock size={16} />\r\n                  Closed\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"business-hours-item__actions\">\r\n                <button\r\n                  className=\"btn-ghost btn-ghost--small\"\r\n                  onClick={() => applyToAll(hours)}\r\n                  title=\"Apply to all days\"\r\n                >\r\n                  Apply to all\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {pendingChanges.size > 0 && (\r\n        <div className=\"settings-section__footer\">\r\n          <div className=\"settings-unsaved-notice\">\r\n            <AlertCircle size={16} />\r\n            <span>\r\n              {pendingChanges.size} unsaved change{pendingChanges.size > 1 ? 's' : ''}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default BusinessHoursPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\CategorySettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":62,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":81,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":81,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useLocation } from 'react-router-dom';\r\nimport { Save, RotateCcw, AlertCircle } from 'lucide-react';\r\nimport { useSettingsByCategory, useUpdateSetting, useResetSetting } from '../../hooks/settings';\r\nimport { useSettingsStore } from '../../stores/settingsStore';\r\nimport SettingField from '../../components/settings/SettingField';\r\nimport { toast } from 'sonner';\r\n\r\nconst CategorySettingsPage = () => {\r\n  const location = useLocation();\r\n\r\n  // Extract category from URL path (e.g., /settings/company -> company)\r\n  // Default to 'company' when at /settings root\r\n  const pathParts = location.pathname.split('/').filter(Boolean);\r\n  const category = pathParts.length > 1 ? pathParts[pathParts.length - 1] : 'company';\r\n\r\n  const { data: settings, isLoading, error } = useSettingsByCategory(category);\r\n  const updateSettingMutation = useUpdateSetting();\r\n  const resetSettingMutation = useResetSetting();\r\n  const categories = useSettingsStore((state) => state.categories);\r\n\r\n  // Local state for form values\r\n  const [formValues, setFormValues] = useState<Record<string, unknown>>({});\r\n  const [pendingChanges, setPendingChanges] = useState<Set<string>>(new Set());\r\n  const [isSaving, setIsSaving] = useState(false);\r\n\r\n  // Get category info\r\n  const categoryInfo = categories.find((c) => c.code === category);\r\n\r\n  // Use English\r\n  const nameKey = 'name_en' as const;\r\n  const descKey = 'description_en' as const;\r\n\r\n  // Initialize form values from settings\r\n  useEffect(() => {\r\n    if (settings) {\r\n      const values: Record<string, unknown> = {};\r\n      settings.forEach((setting) => {\r\n        values[setting.key] = setting.value;\r\n      });\r\n      setFormValues(values);\r\n      setPendingChanges(new Set());\r\n    }\r\n  }, [settings]);\r\n\r\n  // Handle value change\r\n  const handleChange = (key: string, value: unknown) => {\r\n    setFormValues((prev) => ({ ...prev, [key]: value }));\r\n    setPendingChanges((prev) => new Set(prev).add(key));\r\n  };\r\n\r\n  // Handle reset single setting\r\n  const handleReset = async (key: string) => {\r\n    try {\r\n      await resetSettingMutation.mutateAsync(key);\r\n      toast.success('Setting reset');\r\n      setPendingChanges((prev) => {\r\n        const next = new Set(prev);\r\n        next.delete(key);\r\n        return next;\r\n      });\r\n    } catch (error) {\r\n      toast.error('Error resetting setting');\r\n    }\r\n  };\r\n\r\n  // Handle save all changes\r\n  const handleSaveAll = async () => {\r\n    if (pendingChanges.size === 0) return;\r\n\r\n    setIsSaving(true);\r\n    const errors: string[] = [];\r\n\r\n    try {\r\n      for (const key of pendingChanges) {\r\n        try {\r\n          await updateSettingMutation.mutateAsync({\r\n            key,\r\n            value: formValues[key],\r\n          });\r\n        } catch (error) {\r\n          errors.push(key);\r\n        }\r\n      }\r\n\r\n      if (errors.length === 0) {\r\n        toast.success('Settings saved');\r\n        setPendingChanges(new Set());\r\n      } else {\r\n        toast.error(`Error on ${errors.length} setting(s)`);\r\n      }\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  // Handle reset all\r\n  const handleResetAll = () => {\r\n    if (!settings) return;\r\n\r\n    // Restore original values\r\n    const values: Record<string, unknown> = {};\r\n    settings.forEach((setting) => {\r\n      values[setting.key] = setting.value;\r\n    });\r\n    setFormValues(values);\r\n    setPendingChanges(new Set());\r\n    toast.success('Changes discarded');\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"settings-section\">\r\n        <div className=\"settings-section__body settings-section__loading\">\r\n          <div className=\"spinner\" />\r\n          <span>Loading settings...</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error || !settings) {\r\n    return (\r\n      <div className=\"settings-section\">\r\n        <div className=\"settings-section__body settings-section__error\">\r\n          <AlertCircle size={24} />\r\n          <span>Error loading settings</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const categoryName = categoryInfo?.[nameKey] || categoryInfo?.name_en || category;\r\n  const categoryDescription = categoryInfo?.[descKey] || categoryInfo?.description_en;\r\n\r\n  return (\r\n    <div className=\"settings-section\">\r\n      <div className=\"settings-section__header\">\r\n        <div className=\"settings-section__header-content\">\r\n          <div>\r\n            <h2 className=\"settings-section__title\">{categoryName}</h2>\r\n            {categoryDescription && (\r\n              <p className=\"settings-section__description\">{categoryDescription}</p>\r\n            )}\r\n          </div>\r\n          {pendingChanges.size > 0 && (\r\n            <div className=\"settings-section__actions\">\r\n              <button\r\n                className=\"btn-secondary\"\r\n                onClick={handleResetAll}\r\n                disabled={isSaving}\r\n              >\r\n                <RotateCcw size={16} />\r\n                Cancel\r\n              </button>\r\n              <button\r\n                className=\"btn-primary\"\r\n                onClick={handleSaveAll}\r\n                disabled={isSaving}\r\n              >\r\n                <Save size={16} />\r\n                {isSaving ? 'Saving...' : `Save (${pendingChanges.size})`}\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"settings-section__body\">\r\n        {settings.length === 0 ? (\r\n          <div className=\"settings-section__empty\">\r\n            <p>No settings in this category.</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"settings-list\">\r\n            {settings.map((setting) => (\r\n              <SettingField\r\n                key={setting.key}\r\n                setting={setting}\r\n                value={formValues[setting.key]}\r\n                onChange={(value) => handleChange(setting.key, value)}\r\n                onReset={() => handleReset(setting.key)}\r\n                disabled={(setting.is_readonly ?? false) || (setting.is_system ?? false)}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {pendingChanges.size > 0 && (\r\n        <div className=\"settings-section__footer\">\r\n          <div className=\"settings-unsaved-notice\">\r\n            <AlertCircle size={16} />\r\n            <span>\r\n              {pendingChanges.size} unsaved change{pendingChanges.size > 1 ? 's' : ''}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CategorySettingsPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\CompanySettingsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\LanMonitoringPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\NotificationSettingsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\PaymentMethodsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":137,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":137,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":154,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":167,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":167,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":191,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":191,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport {\r\n  Plus,\r\n  Edit2,\r\n  Trash2,\r\n  Save,\r\n  X,\r\n  CheckCircle,\r\n  GripVertical,\r\n  Banknote,\r\n  CreditCard,\r\n  Building,\r\n  Wallet,\r\n  QrCode,\r\n} from 'lucide-react';\r\nimport {\r\n  usePaymentMethods,\r\n  useCreatePaymentMethod,\r\n  useUpdatePaymentMethod,\r\n  useDeletePaymentMethod,\r\n} from '../../hooks/settings';\r\nimport type { PaymentMethod, PaymentType } from '../../types/settings';\r\nimport { toast } from 'sonner';\r\n\r\ninterface PaymentMethodFormData {\r\n  code: string;\r\n  name_fr: string;\r\n  name_en: string;\r\n  name_id: string;\r\n  payment_type: PaymentType;\r\n  icon: string;\r\n  is_active: boolean;\r\n  is_default: boolean;\r\n  requires_reference: boolean;\r\n  sort_order: number;\r\n  settings: object;\r\n}\r\n\r\nconst emptyForm: PaymentMethodFormData = {\r\n  code: '',\r\n  name_fr: '',\r\n  name_en: '',\r\n  name_id: '',\r\n  payment_type: 'cash',\r\n  icon: 'Banknote',\r\n  is_active: true,\r\n  is_default: false,\r\n  requires_reference: false,\r\n  sort_order: 0,\r\n  settings: {},\r\n};\r\n\r\nconst PAYMENT_TYPES: { value: PaymentType; label: string; icon: React.ReactNode }[] = [\r\n  { value: 'cash', label: 'Cash', icon: <Banknote size={16} /> },\r\n  { value: 'card', label: 'Card', icon: <CreditCard size={16} /> },\r\n  { value: 'transfer', label: 'Transfer', icon: <Building size={16} /> },\r\n  { value: 'ewallet', label: 'E-Wallet', icon: <Wallet size={16} /> },\r\n  { value: 'other', label: 'Other', icon: <QrCode size={16} /> },\r\n];\r\n\r\nconst ICONS = [\r\n  'Banknote', 'CreditCard', 'Building', 'Wallet', 'QrCode', 'Smartphone', 'Globe', 'DollarSign',\r\n];\r\n\r\nconst getPaymentIcon = (iconName: string) => {\r\n  switch (iconName) {\r\n    case 'Banknote': return <Banknote size={20} />;\r\n    case 'CreditCard': return <CreditCard size={20} />;\r\n    case 'Building': return <Building size={20} />;\r\n    case 'Wallet': return <Wallet size={20} />;\r\n    case 'QrCode': return <QrCode size={20} />;\r\n    default: return <Wallet size={20} />;\r\n  }\r\n};\r\n\r\nconst PaymentMethodsPage = () => {\r\n  const { data: methods, isLoading } = usePaymentMethods();\r\n  const createMethod = useCreatePaymentMethod();\r\n  const updateMethod = useUpdatePaymentMethod();\r\n  const deleteMethod = useDeletePaymentMethod();\r\n\r\n  const [showModal, setShowModal] = useState(false);\r\n  const [editingMethod, setEditingMethod] = useState<PaymentMethod | null>(null);\r\n  const [formData, setFormData] = useState<PaymentMethodFormData>(emptyForm);\r\n\r\n  // Use English\r\n  const nameKey = 'name_en' as const;\r\n\r\n  // Open create modal\r\n  const openCreateModal = () => {\r\n    setEditingMethod(null);\r\n    setFormData({\r\n      ...emptyForm,\r\n      sort_order: (methods?.length || 0) * 10 + 10,\r\n    });\r\n    setShowModal(true);\r\n  };\r\n\r\n  // Open edit modal\r\n  const openEditModal = (method: PaymentMethod) => {\r\n    setEditingMethod(method);\r\n    setFormData({\r\n      code: method.code,\r\n      name_fr: method.name_fr,\r\n      name_en: method.name_en,\r\n      name_id: method.name_id,\r\n      payment_type: method.payment_type as PaymentType,\r\n      icon: method.icon ?? '',\r\n      is_active: method.is_active ?? true,\r\n      is_default: method.is_default ?? false,\r\n      requires_reference: method.requires_reference ?? false,\r\n      sort_order: method.sort_order ?? 0,\r\n      settings: method.settings as object ?? {},\r\n    });\r\n    setShowModal(true);\r\n  };\r\n\r\n  // Handle save\r\n  const handleSave = async () => {\r\n    if (!formData.code || !formData.name_fr) {\r\n      toast.error('Code and name are required');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (editingMethod) {\r\n        await updateMethod.mutateAsync({\r\n          id: editingMethod.id,\r\n          updates: formData as never,\r\n        });\r\n        toast.success('Payment method updated');\r\n      } else {\r\n        await createMethod.mutateAsync(formData as never);\r\n        toast.success('Payment method created');\r\n      }\r\n      setShowModal(false);\r\n    } catch (error) {\r\n      toast.error('Error saving');\r\n    }\r\n  };\r\n\r\n  // Handle delete\r\n  const handleDelete = async (method: PaymentMethod) => {\r\n    if (method.is_default) {\r\n      toast.error('Cannot delete default payment method');\r\n      return;\r\n    }\r\n\r\n    if (!confirm(`Delete \"${method[nameKey]}\"?`)) return;\r\n\r\n    try {\r\n      await deleteMethod.mutateAsync(method.id);\r\n      toast.success('Payment method deleted');\r\n    } catch (error) {\r\n      toast.error('Error deleting');\r\n    }\r\n  };\r\n\r\n  // Toggle active\r\n  const handleToggleActive = async (method: PaymentMethod) => {\r\n    try {\r\n      await updateMethod.mutateAsync({\r\n        id: method.id,\r\n        updates: { is_active: !method.is_active },\r\n      });\r\n      toast.success(method.is_active ? 'Disabled' : 'Enabled');\r\n    } catch (error) {\r\n      toast.error('Error');\r\n    }\r\n  };\r\n\r\n  // Set as default\r\n  const handleSetDefault = async (method: PaymentMethod) => {\r\n    try {\r\n      // Unset previous default\r\n      const currentDefault = methods?.find((m) => m.is_default);\r\n      if (currentDefault) {\r\n        await updateMethod.mutateAsync({\r\n          id: currentDefault.id,\r\n          updates: { is_default: false },\r\n        });\r\n      }\r\n\r\n      // Set new default\r\n      await updateMethod.mutateAsync({\r\n        id: method.id,\r\n        updates: { is_default: true },\r\n      });\r\n\r\n      toast.success(`${method[nameKey]} set as default`);\r\n    } catch (error) {\r\n      toast.error('Error');\r\n    }\r\n  };\r\n\r\n  // Group methods by type\r\n  const groupedMethods = methods?.reduce((acc: Record<string, PaymentMethod[]>, method: PaymentMethod) => {\r\n    const type = method.payment_type;\r\n    if (!acc[type]) acc[type] = [];\r\n    acc[type].push(method);\r\n    return acc;\r\n  }, {} as Record<string, PaymentMethod[]>) || {};\r\n\r\n  return (\r\n    <>\r\n      <div className=\"settings-section\">\r\n        <div className=\"settings-section__header\">\r\n          <div className=\"settings-section__header-content\">\r\n            <div>\r\n              <h2 className=\"settings-section__title\">Payment Methods</h2>\r\n              <p className=\"settings-section__description\">\r\n                Configure payment methods accepted at POS\r\n              </p>\r\n            </div>\r\n            <button className=\"btn-primary\" onClick={openCreateModal}>\r\n              <Plus size={16} />\r\n              New Payment Method\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"settings-section__body\">\r\n          {isLoading ? (\r\n            <div className=\"settings-section__loading\">\r\n              <div className=\"spinner\" />\r\n              <span>Loading...</span>\r\n            </div>\r\n          ) : methods?.length === 0 ? (\r\n            <div className=\"settings-section__empty\">\r\n              <Wallet size={48} />\r\n              <h3>No payment methods</h3>\r\n              <p>Create your first payment method.</p>\r\n              <button className=\"btn-primary\" onClick={openCreateModal}>\r\n                <Plus size={16} />\r\n                Create Payment Method\r\n              </button>\r\n            </div>\r\n          ) : (\r\n            <div className=\"payment-methods-grid\">\r\n              {PAYMENT_TYPES.map((type) => {\r\n                const typeMethods = groupedMethods?.[type.value] || [];\r\n                if (typeMethods.length === 0) return null;\r\n\r\n                return (\r\n                  <div key={type.value} className=\"payment-methods-group\">\r\n                    <h3 className=\"payment-methods-group__title\">\r\n                      {type.icon}\r\n                      {type.label}\r\n                    </h3>\r\n                    <div className=\"payment-methods-list\">\r\n                      {typeMethods.map((method: PaymentMethod) => (\r\n                        <div\r\n                          key={method.id}\r\n                          className={`payment-method-item ${!method.is_active ? 'is-inactive' : ''}`}\r\n                        >\r\n                          <div className=\"payment-method-item__drag\">\r\n                            <GripVertical size={16} />\r\n                          </div>\r\n                          <div className=\"payment-method-item__icon\">\r\n                            {getPaymentIcon(method.icon ?? '')}\r\n                          </div>\r\n                          <div className=\"payment-method-item__info\">\r\n                            <div className=\"payment-method-item__name\">\r\n                              {method[nameKey]}\r\n                              {method.is_default && (\r\n                                <span className=\"payment-method-item__default\">\r\n                                  <CheckCircle size={12} />\r\n                                </span>\r\n                              )}\r\n                            </div>\r\n                            <div className=\"payment-method-item__code\">{method.code}</div>\r\n                          </div>\r\n                          <div className=\"payment-method-item__actions\">\r\n                            <button\r\n                              className={`toggle-mini ${method.is_active ? 'is-on' : ''}`}\r\n                              onClick={() => handleToggleActive(method)}\r\n                              title={method.is_active ? 'Disable' : 'Enable'}\r\n                            />\r\n                            {!method.is_default && method.is_active && (\r\n                              <button\r\n                                className=\"btn-icon\"\r\n                                onClick={() => handleSetDefault(method)}\r\n                                title=\"Set as default\"\r\n                              >\r\n                                <CheckCircle size={14} />\r\n                              </button>\r\n                            )}\r\n                            <button\r\n                              className=\"btn-icon\"\r\n                              onClick={() => openEditModal(method)}\r\n                              title=\"Edit\"\r\n                            >\r\n                              <Edit2 size={14} />\r\n                            </button>\r\n                            <button\r\n                              className=\"btn-icon btn-icon--danger\"\r\n                              onClick={() => handleDelete(method)}\r\n                              title=\"Delete\"\r\n                              disabled={method.is_default ?? false}\r\n                            >\r\n                              <Trash2 size={14} />\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modal */}\r\n      {showModal && (\r\n        <div className=\"settings-modal-overlay\" onClick={() => setShowModal(false)}>\r\n          <div className=\"settings-modal\" onClick={(e) => e.stopPropagation()}>\r\n            <div className=\"settings-modal__header\">\r\n              <h2 className=\"settings-modal__title\">\r\n                {editingMethod ? 'Edit Payment Method' : 'New Payment Method'}\r\n              </h2>\r\n              <button className=\"settings-modal__close\" onClick={() => setShowModal(false)}>\r\n                <X size={20} />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"settings-modal__body\">\r\n              <div className=\"form-row\">\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Code *</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"form-input\"\r\n                    value={formData.code}\r\n                    onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}\r\n                    placeholder=\"CASH\"\r\n                    disabled={!!editingMethod}\r\n                  />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Type *</label>\r\n                  <select\r\n                    className=\"form-input form-select\"\r\n                    value={formData.payment_type}\r\n                    onChange={(e) => setFormData({ ...formData, payment_type: e.target.value as PaymentType })}\r\n                  >\r\n                    {PAYMENT_TYPES.map((type) => (\r\n                      <option key={type.value} value={type.value}>\r\n                        {type.label}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-label\">Name (French) *</label>\r\n                <input\r\n                  type=\"text\"\r\n                  className=\"form-input\"\r\n                  value={formData.name_fr}\r\n                  onChange={(e) => setFormData({ ...formData, name_fr: e.target.value })}\r\n                  placeholder=\"Espèces\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"form-row\">\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Name (English)</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"form-input\"\r\n                    value={formData.name_en}\r\n                    onChange={(e) => setFormData({ ...formData, name_en: e.target.value })}\r\n                    placeholder=\"Cash\"\r\n                  />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Name (Indonesian)</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"form-input\"\r\n                    value={formData.name_id}\r\n                    onChange={(e) => setFormData({ ...formData, name_id: e.target.value })}\r\n                    placeholder=\"Tunai\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-label\">Icon</label>\r\n                <select\r\n                  className=\"form-input form-select\"\r\n                  value={formData.icon}\r\n                  onChange={(e) => setFormData({ ...formData, icon: e.target.value })}\r\n                >\r\n                  {ICONS.map((icon) => (\r\n                    <option key={icon} value={icon}>\r\n                      {icon}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-checkbox\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={formData.requires_reference}\r\n                    onChange={(e) => setFormData({ ...formData, requires_reference: e.target.checked })}\r\n                  />\r\n                  <span>Requires reference (transaction number)</span>\r\n                </label>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-checkbox\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={formData.is_active}\r\n                    onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}\r\n                  />\r\n                  <span>Active</span>\r\n                </label>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"settings-modal__footer\">\r\n              <button className=\"btn-secondary\" onClick={() => setShowModal(false)}>\r\n                Cancel\r\n              </button>\r\n              <button\r\n                className=\"btn-primary\"\r\n                onClick={handleSave}\r\n                disabled={createMethod.isPending || updateMethod.isPending}\r\n              >\r\n                <Save size={16} />\r\n                {editingMethod ? 'Update' : 'Create'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default PaymentMethodsPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\PrintingSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3466,3469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3466,3469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":113,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":113,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":125,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":125,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport {\r\n    Plus,\r\n    Edit2,\r\n    Trash2,\r\n    Save,\r\n    X,\r\n    CheckCircle,\r\n    Printer,\r\n    Wifi,\r\n    Usb,\r\n    AlertCircle,\r\n    Activity,\r\n} from 'lucide-react';\r\nimport {\r\n    usePrinters,\r\n    useCreatePrinter,\r\n    useUpdatePrinter,\r\n    useDeletePrinter,\r\n} from '../../hooks/settings';\r\nimport { usePermissions } from '../../hooks/usePermissions';\r\nimport type { PrinterConfiguration } from '../../types/settings';\r\nimport { toast } from 'sonner';\r\n\r\ninterface IPrinterFormData {\r\n    name: string;\r\n    printer_type: string;\r\n    connection_type: string;\r\n    connection_string: string;\r\n    paper_width: number;\r\n    is_active: boolean;\r\n    is_default: boolean;\r\n}\r\n\r\nconst emptyForm: IPrinterFormData = {\r\n    name: '',\r\n    printer_type: 'receipt',\r\n    connection_type: 'network',\r\n    connection_string: '',\r\n    paper_width: 80,\r\n    is_active: true,\r\n    is_default: false,\r\n};\r\n\r\nconst PrintingSettingsPage = () => {\r\n    const { data: printers, isLoading: loadingPrinters } = usePrinters();\r\n    const createPrinter = useCreatePrinter();\r\n    const updatePrinter = useUpdatePrinter();\r\n    const deletePrinter = useDeletePrinter();\r\n    const { hasPermission, isAdmin } = usePermissions();\r\n\r\n    const [showModal, setShowModal] = useState(false);\r\n    const [editingPrinter, setEditingPrinter] = useState<PrinterConfiguration | null>(null);\r\n    const [formData, setFormData] = useState<IPrinterFormData>(emptyForm);\r\n    const [testingId, setTestingId] = useState<string | null>(null);\r\n\r\n    const canUpdate = hasPermission('settings.update') || isAdmin;\r\n\r\n    // Open create modal\r\n    const openCreateModal = () => {\r\n        setEditingPrinter(null);\r\n        setFormData(emptyForm);\r\n        setShowModal(true);\r\n    };\r\n\r\n    // Open edit modal\r\n    const openEditModal = (printer: PrinterConfiguration) => {\r\n        setEditingPrinter(printer);\r\n        setFormData({\r\n            name: printer.name,\r\n            printer_type: printer.printer_type,\r\n            connection_type: printer.connection_type,\r\n            connection_string: printer.connection_string || '',\r\n            paper_width: printer.paper_width || 80,\r\n            is_active: printer.is_active ?? true,\r\n            is_default: printer.is_default ?? false,\r\n        });\r\n        setShowModal(true);\r\n    };\r\n\r\n    // Handle save\r\n    const handleSave = async () => {\r\n        if (!formData.name.trim()) {\r\n            toast.error('Printer name is required');\r\n            return;\r\n        }\r\n\r\n        if (formData.connection_type === 'network' && !formData.connection_string.trim()) {\r\n            toast.error('IP address:port is required for network connection');\r\n            return;\r\n        }\r\n\r\n        if (formData.connection_type === 'network' && formData.connection_string) {\r\n            const ipPortRegex = /^(\\d{1,3}\\.){3}\\d{1,3}:\\d{1,5}$/;\r\n            if (!ipPortRegex.test(formData.connection_string)) {\r\n                toast.error('Invalid format. Expected: 192.168.1.100:9100');\r\n                return;\r\n            }\r\n        }\r\n\r\n        try {\r\n            if (editingPrinter) {\r\n                await updatePrinter.mutateAsync({\r\n                    id: editingPrinter.id,\r\n                    updates: formData as Partial<PrinterConfiguration>,\r\n                });\r\n                toast.success('Printer updated');\r\n            } else {\r\n                await createPrinter.mutateAsync(formData as any);\r\n                toast.success('Printer created');\r\n            }\r\n            setShowModal(false);\r\n        } catch (error) {\r\n            toast.error('Error saving printer');\r\n        }\r\n    };\r\n\r\n    // Handle delete\r\n    const handleDelete = async (printer: PrinterConfiguration) => {\r\n        if (!confirm(`Delete printer \"${printer.name}\"?`)) return;\r\n\r\n        try {\r\n            await deletePrinter.mutateAsync(printer.id);\r\n            toast.success('Printer deleted');\r\n        } catch (error) {\r\n            toast.error('Error deleting printer');\r\n        }\r\n    };\r\n\r\n    // Test printer connection\r\n    const handleTestPrint = async (printer: PrinterConfiguration) => {\r\n        setTestingId(printer.id);\r\n        const PRINT_SERVER_URL = 'http://localhost:3001';\r\n\r\n        try {\r\n            // First check if print server is running\r\n            const healthCheck = await fetch(`${PRINT_SERVER_URL}/health`, {\r\n                method: 'GET',\r\n                signal: AbortSignal.timeout(3000), // 3s timeout\r\n            });\r\n\r\n            if (!healthCheck.ok) {\r\n                throw new Error('Print server is not responding');\r\n            }\r\n\r\n            // Determine endpoint based on printer type\r\n            const endpoint = printer.printer_type === 'receipt'\r\n                ? '/print/receipt'\r\n                : printer.printer_type === 'kitchen'\r\n                    ? '/print/kitchen'\r\n                    : printer.printer_type === 'barista'\r\n                        ? '/print/barista'\r\n                        : '/print/receipt';\r\n\r\n            // Send test print\r\n            const response = await fetch(`${PRINT_SERVER_URL}${endpoint}`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    test: true,\r\n                    printer_name: printer.name,\r\n                    connection_string: printer.connection_string,\r\n                    message: `Print test - ${new Date().toLocaleString()}`,\r\n                }),\r\n                signal: AbortSignal.timeout(5000), // 5s timeout\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const error = await response.json();\r\n                throw new Error(error.message || 'Print test failed');\r\n            }\r\n\r\n            toast.success('Print test successful');\r\n        } catch (error) {\r\n            console.error('Print test error:', error);\r\n            if (error instanceof TypeError && (error.message.includes('fetch') || error.message.includes('Failed to fetch') || error.name === 'TypeError')) {\r\n                toast.error('Print server unreachable. Is it running on port 3001?');\r\n            } else if (error instanceof Error && error.name === 'TimeoutError') {\r\n                toast.error('Timeout. Print server is not responding.');\r\n            } else {\r\n                toast.error((error as Error).message);\r\n            }\r\n        } finally {\r\n            setTestingId(null);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <div className=\"settings-section\">\r\n                <div className=\"settings-section__header\">\r\n                    <div className=\"settings-section__header-content\">\r\n                        <div>\r\n                            <h2 className=\"settings-section__title\">Printer Configuration</h2>\r\n                            <p className=\"settings-section__description\">\r\n                                Manage thermal printers for receipts and kitchen tickets\r\n                            </p>\r\n                        </div>\r\n                        {canUpdate && (\r\n                            <button className=\"btn-primary\" onClick={openCreateModal}>\r\n                                <Plus size={16} />\r\n                                New Printer\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"settings-section__body\">\r\n                    {!canUpdate && (\r\n                        <div className=\"settings-section__readonly-notice\">\r\n                            <AlertCircle size={16} />\r\n                            <span>You do not have permission to modify these settings</span>\r\n                        </div>\r\n                    )}\r\n                    {loadingPrinters ? (\r\n                        <div className=\"settings-section__loading\">\r\n                            <div className=\"spinner\" />\r\n                            <span>Loading...</span>\r\n                        </div>\r\n                    ) : !printers || printers.length === 0 ? (\r\n                        <div className=\"settings-section__empty\">\r\n                            <Printer size={48} />\r\n                            <h3>No printers configured</h3>\r\n                            <p>Add a printer to start printing tickets.</p>\r\n                            {canUpdate && (\r\n                                <button className=\"btn-primary\" onClick={openCreateModal}>\r\n                                    <Plus size={16} />\r\n                                    Add a printer\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"tax-rates-list\">\r\n                            {printers.map((printer) => (\r\n                                <div\r\n                                    key={printer.id}\r\n                                    className={`tax-rate-item ${!printer.is_active ? 'is-inactive' : ''}`}\r\n                                >\r\n                                    <div className=\"tax-rate-item__info\">\r\n                                        <div className=\"tax-rate-item__header\">\r\n                                            <span className=\"tax-rate-item__code u-capitalize\">\r\n                                                {printer.printer_type}\r\n                                            </span>\r\n                                            {printer.is_default && (\r\n                                                <span className=\"tax-rate-item__default-badge\">\r\n                                                    <CheckCircle size={12} />\r\n                                                    Default\r\n                                                </span>\r\n                                            )}\r\n                                            {!printer.is_active && (\r\n                                                <span className=\"tax-rate-item__inactive-badge\">\r\n                                                    Inactive\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                        <div className=\"tax-rate-item__name\">{printer.name}</div>\r\n                                        <div className=\"tax-rate-item__details\">\r\n                                            <span className=\"flex items-center gap-1\">\r\n                                                {printer.connection_type === 'network' ? <Wifi size={14} /> : <Usb size={14} />}\r\n                                                {printer.connection_type === 'network' ? printer.connection_string : 'USB'}\r\n                                            </span>\r\n                                            <span className=\"tax-rate-item__type\">\r\n                                                {printer.paper_width}mm\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className=\"tax-rate-item__actions\">\r\n                                        <button\r\n                                            className={`btn-ghost ${testingId === printer.id ? 'opacity-50 cursor-not-allowed' : ''}`}\r\n                                            onClick={() => handleTestPrint(printer)}\r\n                                            title=\"Test print\"\r\n                                            disabled={testingId === printer.id}\r\n                                        >\r\n                                            {testingId === printer.id ? (\r\n                                                <Activity size={16} className=\"animate-spin\" />\r\n                                            ) : (\r\n                                                <Printer size={16} />\r\n                                            )}\r\n                                        </button>\r\n                                        {canUpdate && (\r\n                                            <>\r\n                                                <button\r\n                                                    className=\"btn-ghost\"\r\n                                                    onClick={() => openEditModal(printer)}\r\n                                                    title=\"Edit\"\r\n                                                >\r\n                                                    <Edit2 size={16} />\r\n                                                </button>\r\n                                                <button\r\n                                                    className=\"btn-ghost btn-ghost--danger\"\r\n                                                    onClick={() => handleDelete(printer)}\r\n                                                    title=\"Delete\"\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            </>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {showModal && (\r\n                <div className=\"settings-modal-overlay\" onClick={() => setShowModal(false)}>\r\n                    <div className=\"settings-modal\" onClick={(e) => e.stopPropagation()}>\r\n                        <div className=\"settings-modal__header\">\r\n                            <h2 className=\"settings-modal__title\">\r\n                                {editingPrinter ? 'Edit Printer' : 'New Printer'}\r\n                            </h2>\r\n                            <button className=\"settings-modal__close\" onClick={() => setShowModal(false)} title=\"Close\">\r\n                                <X size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"settings-modal__body\">\r\n                            <div className=\"form-group\">\r\n                                <label className=\"form-label\">Printer name *</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"form-input\"\r\n                                    value={formData.name}\r\n                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                                    placeholder=\"e.g. Cash Register Printer\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"form-row\">\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-label\">Type *</label>\r\n                                    <select\r\n                                        className=\"form-input\"\r\n                                        value={formData.printer_type}\r\n                                        onChange={(e) => setFormData({ ...formData, printer_type: e.target.value })}\r\n                                        title=\"Printer type\"\r\n                                    >\r\n                                        <option value=\"receipt\">Receipt (POS)</option>\r\n                                        <option value=\"kitchen\">Kitchen</option>\r\n                                        <option value=\"barista\">Barista</option>\r\n                                        <option value=\"label\">Labels</option>\r\n                                        <option value=\"report\">Reports</option>\r\n                                    </select>\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-label\">Paper width (mm)</label>\r\n                                    <select\r\n                                        className=\"form-input\"\r\n                                        value={formData.paper_width}\r\n                                        onChange={(e) => setFormData({ ...formData, paper_width: Number(e.target.value) })}\r\n                                        title=\"Paper width\"\r\n                                    >\r\n                                        <option value={80}>80mm (Standard)</option>\r\n                                        <option value={58}>58mm (Mobile/Compact)</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"form-row\">\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-label\">Connection *</label>\r\n                                    <select\r\n                                        className=\"form-input\"\r\n                                        value={formData.connection_type}\r\n                                        onChange={(e) => setFormData({ ...formData, connection_type: e.target.value })}\r\n                                        title=\"Connection type\"\r\n                                    >\r\n                                        <option value=\"network\">Network (Ethernet/WiFi)</option>\r\n                                        <option value=\"usb\">USB</option>\r\n                                        <option value=\"bluetooth\">Bluetooth</option>\r\n                                    </select>\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-label\">\r\n                                        {formData.connection_type === 'network' ? 'IP Address:Port *' : 'Connection string'}\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        className=\"form-input\"\r\n                                        value={formData.connection_string}\r\n                                        onChange={(e) => setFormData({ ...formData, connection_string: e.target.value })}\r\n                                        placeholder={formData.connection_type === 'network' ? '192.168.1.100:9100' : '/dev/usb/lp0'}\r\n                                    />\r\n                                    {formData.connection_type === 'network' && (\r\n                                        <span className=\"text-[10px] text-[var(--color-gris-chaud)] mt-1 flex items-center gap-1\">\r\n                                            <AlertCircle size={10} />\r\n                                            Expected format: IP:PORT (e.g. 192.168.1.100:9100)\r\n                                        </span>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"form-row mt-4\">\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-checkbox\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            checked={formData.is_default}\r\n                                            onChange={(e) => setFormData({ ...formData, is_default: e.target.checked })}\r\n                                        />\r\n                                        <span>Use as default for this type</span>\r\n                                    </label>\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-checkbox\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            checked={formData.is_active}\r\n                                            onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}\r\n                                        />\r\n                                        <span>Active</span>\r\n                                    </label>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"settings-modal__footer\">\r\n                            <button className=\"btn-secondary\" onClick={() => setShowModal(false)}>\r\n                                Cancel\r\n                            </button>\r\n                            <button\r\n                                className=\"btn-primary\"\r\n                                onClick={handleSave}\r\n                                disabled={createPrinter.isPending || updatePrinter.isPending}\r\n                            >\r\n                                <Save size={16} />\r\n                                {editingPrinter ? 'Update' : 'Create'}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </>\r\n    );\r\n};\r\n\r\nexport default PrintingSettingsPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\RolesPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\SettingsHistoryPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\SettingsLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\SettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5996,5999],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5996,5999],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport {\r\n    Store, Printer, Bell, Shield, Save, Plus, Settings, RefreshCw, Layers,\r\n    Edit2, Trash2, X, ShoppingCart, Factory, Warehouse, ChefHat, Coffee, Monitor, Grid, Wifi, Sliders, Package\r\n} from 'lucide-react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { saveCategory } from '../../services/products/catalogSyncService';\r\nimport FloorPlanEditor from '../../components/settings/FloorPlanEditor';\r\nimport TerminalSettingsSection from '../../components/settings/TerminalSettingsSection';\r\nimport POSAdvancedSettingsSection from '../../components/settings/POSAdvancedSettingsSection';\r\nimport ModuleSettingsSection from '../../components/settings/ModuleSettingsSection';\r\nimport NotificationSettingsSection from '../../components/settings/NotificationSettingsSection';\r\nimport './SettingsPage.css';\r\n\r\ntype SettingsTab = 'general' | 'terminal' | 'pos_advanced' | 'modules' | 'printers' | 'notifications' | 'security' | 'sections' | 'kds' | 'floorplan';\r\n\r\ntype TSectionType = 'warehouse' | 'production' | 'sales';\r\n\r\ninterface Section {\r\n    id: string;\r\n    name: string;\r\n    code: string;\r\n    description: string | null;\r\n    section_type: TSectionType | null;\r\n    icon: string | null;\r\n    is_active: boolean;\r\n    sort_order: number;\r\n    created_at: string;\r\n}\r\n\r\ninterface Category {\r\n    id: string;\r\n    name: string;\r\n    icon: string;\r\n    dispatch_station: 'barista' | 'kitchen' | 'display' | 'none' | null;\r\n    is_active: boolean;\r\n}\r\n\r\nconst DISPATCH_STATIONS = [\r\n    { value: 'kitchen', label: 'Hot Kitchen', icon: <ChefHat size={16} />, color: '#EF4444' },\r\n    { value: 'barista', label: 'Barista', icon: <Coffee size={16} />, color: '#8B5CF6' },\r\n    { value: 'display', label: 'Display', icon: <Monitor size={16} />, color: '#10B981' },\r\n    { value: 'none', label: 'No Station', icon: <X size={16} />, color: '#6B7280' }\r\n];\r\n\r\nconst SettingsPage = () => {\r\n    const [activeTab, setActiveTab] = useState<SettingsTab>('general');\r\n    const [sections, setSections] = useState<Section[]>([]);\r\n    const [loadingSections, setLoadingSections] = useState(false);\r\n\r\n    // KDS Categories state\r\n    const [categories, setCategories] = useState<Category[]>([]);\r\n    const [loadingCategories, setLoadingCategories] = useState(false);\r\n    const [savingCategory, setSavingCategory] = useState<string | null>(null);\r\n\r\n    // Section modal state\r\n    const [showSectionModal, setShowSectionModal] = useState(false);\r\n    const [editingSection, setEditingSection] = useState<Section | null>(null);\r\n    const [sectionForm, setSectionForm] = useState({\r\n        name: '',\r\n        code: '',\r\n        description: '',\r\n        section_type: 'production' as TSectionType,\r\n        icon: ''\r\n    });\r\n    const [savingSection, setSavingSection] = useState(false);\r\n\r\n    // Section type options for the form\r\n    const SECTION_TYPES = [\r\n        { value: 'warehouse' as const, label: 'Warehouse / Storage', icon: <Warehouse size={20} />, color: '#3B82F6' },\r\n        { value: 'production' as const, label: 'Production', icon: <Factory size={20} />, color: '#10B981' },\r\n        { value: 'sales' as const, label: 'Point of Sale', icon: <ShoppingCart size={20} />, color: '#F59E0B' }\r\n    ];\r\n\r\n    const [settings, setSettings] = useState({\r\n        storeName: 'The Breakery',\r\n        storeAddress: 'Jl. Selong, Kuta Utara, Lombok',\r\n        storePhone: '+62 812 3456 7890',\r\n        timezone: 'Asia/Makassar',\r\n        currency: 'IDR',\r\n        autoLogout: true,\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (activeTab === 'sections') {\r\n            fetchSections();\r\n        }\r\n        if (activeTab === 'kds') {\r\n            fetchCategories();\r\n        }\r\n    }, [activeTab]);\r\n\r\n    const fetchSections = async () => {\r\n        setLoadingSections(true);\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('sections')\r\n                .select('*')\r\n                .eq('is_active', true)\r\n                .order('sort_order');\r\n            if (error) throw error;\r\n            if (data) {\r\n                // Map database fields to interface\r\n                const mapped = data.map((s) => ({\r\n                    id: s.id,\r\n                    name: s.name,\r\n                    code: s.code || '',\r\n                    description: s.description || null,\r\n                    section_type: s.section_type as TSectionType | null,\r\n                    icon: s.icon || null,\r\n                    is_active: s.is_active ?? true,\r\n                    sort_order: s.sort_order ?? 0,\r\n                    created_at: s.created_at,\r\n                }));\r\n                setSections(mapped);\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching sections:', error);\r\n        } finally {\r\n            setLoadingSections(false);\r\n        }\r\n    };\r\n\r\n    const fetchCategories = async () => {\r\n        setLoadingCategories(true);\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('categories')\r\n                .select('id, name, icon, dispatch_station, is_active')\r\n                .eq('is_active', true)\r\n                .order('name');\r\n            if (error) throw error;\r\n            if (data) {\r\n                const mapped = data.map(c => ({\r\n                    ...c,\r\n                    icon: c.icon || '',\r\n                    is_active: c.is_active ?? true,\r\n                }));\r\n                setCategories(mapped as Category[]);\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fetching categories:', error);\r\n        } finally {\r\n            setLoadingCategories(false);\r\n        }\r\n    };\r\n\r\n    const updateCategoryStation = async (categoryId: string, newStation: string) => {\r\n        setSavingCategory(categoryId);\r\n        try {\r\n            const result = await saveCategory({\r\n                id: categoryId,\r\n                dispatch_station: newStation as any\r\n            });\r\n\r\n            if (!result.success) {\r\n                throw new Error(result.error);\r\n            }\r\n\r\n            // Update local state\r\n            setCategories(prev => prev.map(cat =>\r\n                cat.id === categoryId\r\n                    ? { ...cat, dispatch_station: newStation as Category['dispatch_station'] }\r\n                    : cat\r\n            ));\r\n        } catch (error) {\r\n            console.error('Error updating category station:', error);\r\n            alert('Error updating station');\r\n        } finally {\r\n            setSavingCategory(null);\r\n        }\r\n    };\r\n\r\n    const generateCode = (name: string) => {\r\n        return name\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '') // Remove accents\r\n            .replace(/[^a-z0-9]+/g, '_')\r\n            .replace(/(^_|_$)/g, '');\r\n    };\r\n\r\n    const openCreateModal = () => {\r\n        setEditingSection(null);\r\n        setSectionForm({\r\n            name: '',\r\n            code: '',\r\n            description: '',\r\n            section_type: 'production',\r\n            icon: ''\r\n        });\r\n        setShowSectionModal(true);\r\n    };\r\n\r\n    const openEditModal = (section: Section) => {\r\n        setEditingSection(section);\r\n        setSectionForm({\r\n            name: section.name,\r\n            code: section.code,\r\n            description: section.description || '',\r\n            section_type: section.section_type || 'production',\r\n            icon: section.icon || ''\r\n        });\r\n        setShowSectionModal(true);\r\n    };\r\n\r\n    const handleSectionNameChange = (name: string) => {\r\n        setSectionForm(prev => ({\r\n            ...prev,\r\n            name,\r\n            code: editingSection ? prev.code : generateCode(name)\r\n        }));\r\n    };\r\n\r\n    const handleSaveSection = async () => {\r\n        if (!sectionForm.name.trim()) {\r\n            alert('Section name is required');\r\n            return;\r\n        }\r\n\r\n        setSavingSection(true);\r\n        try {\r\n            // Map interface fields to database schema\r\n            const sectionData = {\r\n                name: sectionForm.name,\r\n                code: sectionForm.code || generateCode(sectionForm.name),\r\n                description: sectionForm.description || null,\r\n                section_type: sectionForm.section_type,\r\n                icon: sectionForm.icon || null,\r\n                is_active: true,\r\n            };\r\n\r\n            if (editingSection) {\r\n                const { error } = await supabase\r\n                    .from('sections')\r\n                    .update(sectionData)\r\n                    .eq('id', editingSection.id);\r\n\r\n                if (error) throw error;\r\n            } else {\r\n                // Get max sort_order for new sections\r\n                const { data: maxSortData } = await supabase\r\n                    .from('sections')\r\n                    .select('sort_order')\r\n                    .order('sort_order', { ascending: false })\r\n                    .limit(1);\r\n\r\n                const nextSortOrder = (maxSortData?.[0]?.sort_order ?? 0) + 1;\r\n\r\n                const { error } = await supabase\r\n                    .from('sections')\r\n                    .insert({ ...sectionData, sort_order: nextSortOrder });\r\n\r\n                if (error) throw error;\r\n            }\r\n\r\n            setShowSectionModal(false);\r\n            fetchSections();\r\n        } catch (error) {\r\n            console.error('Error saving section:', error);\r\n            alert('Error saving section: ' + (error instanceof Error ? error.message : 'Unknown error'));\r\n        } finally {\r\n            setSavingSection(false);\r\n        }\r\n    };\r\n\r\n    const handleDeleteSection = async (section: Section) => {\r\n        if (!confirm(`Are you sure you want to delete section \"${section.name}\"?\\n\\nThis action is irreversible and may affect products linked to this section.`)) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const { error } = await supabase\r\n                .from('sections')\r\n                .delete()\r\n                .eq('id', section.id);\r\n\r\n            if (error) throw error;\r\n            fetchSections();\r\n        } catch (error) {\r\n            console.error('Error deleting section:', error);\r\n            alert('Error deleting section: ' + (error instanceof Error ? error.message : 'Unknown error'));\r\n        }\r\n    };\r\n\r\n    const toggleSetting = (key: keyof typeof settings) => {\r\n        setSettings(prev => ({\r\n            ...prev,\r\n            [key]: !prev[key]\r\n        }));\r\n    };\r\n\r\n    const printers = [\r\n        { id: 1, name: 'Imprimante Caisse', type: 'Receipt', status: 'connected', ip: '192.168.1.100' },\r\n        { id: 2, name: 'Imprimante Cuisine', type: 'Kitchen', status: 'connected', ip: '192.168.1.101' },\r\n        { id: 3, name: 'Imprimante Barista', type: 'Kitchen', status: 'disconnected', ip: '192.168.1.102' },\r\n    ];\r\n\r\n    const tabs = [\r\n        { id: 'general' as const, label: 'General', icon: <Store size={18} /> },\r\n        { id: 'terminal' as const, label: 'POS Terminal', icon: <Wifi size={18} /> },\r\n        { id: 'pos_advanced' as const, label: 'POS Advanced', icon: <Sliders size={18} /> },\r\n        { id: 'modules' as const, label: 'Modules', icon: <Package size={18} /> },\r\n        { id: 'sections' as const, label: 'Sections', icon: <Layers size={18} /> },\r\n        { id: 'floorplan' as const, label: 'Floor Plan', icon: <Grid size={18} /> },\r\n        { id: 'kds' as const, label: 'KDS Stations', icon: <ChefHat size={18} /> },\r\n        { id: 'printers' as const, label: 'Printers', icon: <Printer size={18} /> },\r\n        { id: 'notifications' as const, label: 'Notifications', icon: <Bell size={18} /> },\r\n        { id: 'security' as const, label: 'Security', icon: <Shield size={18} /> },\r\n    ];\r\n\r\n    return (\r\n        <div className=\"settings-page\">\r\n            <header className=\"settings-page__header\">\r\n                <h1 className=\"settings-page__title\">Settings</h1>\r\n            </header>\r\n\r\n            <div className=\"settings-grid\">\r\n                {/* Navigation */}\r\n                <nav className=\"settings-nav\">\r\n                    {tabs.map(tab => (\r\n                        <button\r\n                            key={tab.id}\r\n                            className={`settings-nav__item ${activeTab === tab.id ? 'is-active' : ''}`}\r\n                            onClick={() => setActiveTab(tab.id)}\r\n                        >\r\n                            <span className=\"settings-nav__icon\">{tab.icon}</span>\r\n                            {tab.label}\r\n                        </button>\r\n                    ))}\r\n                </nav>\r\n\r\n                {/* Content */}\r\n                <div className=\"settings-content\">\r\n                    {activeTab === 'general' && (\r\n                        <div className=\"settings-section\">\r\n                            <div className=\"settings-section__header\">\r\n                                <h2 className=\"settings-section__title\">Store Information</h2>\r\n                                <p className=\"settings-section__description\">\r\n                                    General settings for your establishment\r\n                                </p>\r\n                            </div>\r\n                            <div className=\"settings-section__body\">\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-label\" htmlFor=\"store-name\">Store Name</label>\r\n                                    <input\r\n                                        id=\"store-name\"\r\n                                        type=\"text\"\r\n                                        className=\"form-input\"\r\n                                        value={settings.storeName}\r\n                                        onChange={(e) => setSettings({ ...settings, storeName: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                                <div className=\"form-group\">\r\n                                    <label className=\"form-label\" htmlFor=\"store-address\">Address</label>\r\n                                    <input\r\n                                        id=\"store-address\"\r\n                                        type=\"text\"\r\n                                        className=\"form-input\"\r\n                                        value={settings.storeAddress}\r\n                                        onChange={(e) => setSettings({ ...settings, storeAddress: e.target.value })}\r\n                                    />\r\n                                </div>\r\n                                <div className=\"form-row\">\r\n                                    <div className=\"form-group\">\r\n                                        <label className=\"form-label\" htmlFor=\"store-phone\">Phone</label>\r\n                                        <input\r\n                                            id=\"store-phone\"\r\n                                            type=\"tel\"\r\n                                            className=\"form-input\"\r\n                                            value={settings.storePhone}\r\n                                            onChange={(e) => setSettings({ ...settings, storePhone: e.target.value })}\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"form-group\">\r\n                                        <label className=\"form-label\" htmlFor=\"store-timezone\">Timezone</label>\r\n                                        <select\r\n                                            id=\"store-timezone\"\r\n                                            className=\"form-input form-select\"\r\n                                            value={settings.timezone}\r\n                                            onChange={(e) => setSettings({ ...settings, timezone: e.target.value })}\r\n                                            aria-label=\"Timezone\"\r\n                                        >\r\n                                            <option value=\"Asia/Jakarta\">Jakarta (WIB)</option>\r\n                                            <option value=\"Asia/Makassar\">Makassar (WITA)</option>\r\n                                            <option value=\"Asia/Jayapura\">Jayapura (WIT)</option>\r\n                                        </select>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"form-footer\">\r\n                                    <button className=\"btn-secondary\">Cancel</button>\r\n                                    <button className=\"btn-primary\">\r\n                                        <Save size={18} />\r\n                                        Save\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'terminal' && (\r\n                        <TerminalSettingsSection />\r\n                    )}\r\n\r\n                    {activeTab === 'pos_advanced' && (\r\n                        <POSAdvancedSettingsSection />\r\n                    )}\r\n\r\n                    {activeTab === 'modules' && (\r\n                        <ModuleSettingsSection />\r\n                    )}\r\n\r\n                    {activeTab === 'sections' && (\r\n                        <div className=\"settings-section\">\r\n                            <div className=\"settings-section__header\">\r\n                                <div className=\"settings-section__header-content\">\r\n                                    <div>\r\n                                        <h2 className=\"settings-section__title\">Establishment Sections</h2>\r\n                                        <p className=\"settings-section__description\">\r\n                                            Manage the different sections of your establishment (kitchen, bar, warehouse, etc.)\r\n                                        </p>\r\n                                    </div>\r\n                                    <button className=\"btn-primary\" onClick={openCreateModal}>\r\n                                        <Plus size={18} />\r\n                                        New Section\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"settings-section__body\">\r\n                                {loadingSections ? (\r\n                                    <div className=\"sections-loading\">\r\n                                        <RefreshCw size={24} className=\"spinning\" />\r\n                                        <span>Loading...</span>\r\n                                    </div>\r\n                                ) : sections.length === 0 ? (\r\n                                    <div className=\"sections-empty\">\r\n                                        <Layers size={48} />\r\n                                        <h3>No sections configured</h3>\r\n                                        <p>Create sections to organize your stock and production.</p>\r\n                                        <button className=\"btn-primary\" onClick={openCreateModal}>\r\n                                            <Plus size={18} />\r\n                                            Create a section\r\n                                        </button>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"sections-list\">\r\n                                        {sections.map(section => {\r\n                                            const sectionTypeInfo = SECTION_TYPES.find(t => t.value === section.section_type);\r\n                                            return (\r\n                                                <div key={section.id} className=\"section-item\">\r\n                                                    <div className=\"section-item__icon-wrapper\" style={{ color: sectionTypeInfo?.color }}>\r\n                                                        {section.icon || sectionTypeInfo?.icon || <Layers size={20} />}\r\n                                                    </div>\r\n                                                    <div className=\"section-item__info\">\r\n                                                        <h3 className=\"section-item__name\">{section.name}</h3>\r\n                                                        <div className=\"section-item__badges\">\r\n                                                            {section.section_type === 'sales' && (\r\n                                                                <span className=\"section-badge section-badge--sales\">\r\n                                                                    <ShoppingCart size={12} />\r\n                                                                    Point of Sale\r\n                                                                </span>\r\n                                                            )}\r\n                                                            {section.section_type === 'production' && (\r\n                                                                <span className=\"section-badge section-badge--production\">\r\n                                                                    <Factory size={12} />\r\n                                                                    Production\r\n                                                                </span>\r\n                                                            )}\r\n                                                            {section.section_type === 'warehouse' && (\r\n                                                                <span className=\"section-badge section-badge--warehouse\">\r\n                                                                    <Warehouse size={12} />\r\n                                                                    Warehouse\r\n                                                                </span>\r\n                                                            )}\r\n                                                        </div>\r\n                                                        {section.description && (\r\n                                                            <p className=\"section-item__description\">{section.description}</p>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    <div className=\"section-item__code\">\r\n                                                        {section.code}\r\n                                                    </div>\r\n                                                    <div className=\"section-item__actions\">\r\n                                                        <button\r\n                                                            className=\"btn-icon\"\r\n                                                            onClick={() => openEditModal(section)}\r\n                                                            title=\"Edit\"\r\n                                                            aria-label=\"Edit\"\r\n                                                        >\r\n                                                            <Edit2 size={16} />\r\n                                                        </button>\r\n                                                        <button\r\n                                                            className=\"btn-icon btn-icon--danger\"\r\n                                                            onClick={() => handleDeleteSection(section)}\r\n                                                            title=\"Delete\"\r\n                                                            aria-label=\"Delete\"\r\n                                                        >\r\n                                                            <Trash2 size={16} />\r\n                                                        </button>\r\n                                                    </div>\r\n                                                </div>\r\n                                            );\r\n                                        })}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'kds' && (\r\n                        <div className=\"settings-section\">\r\n                            <div className=\"settings-section__header\">\r\n                                <div className=\"settings-section__header-content\">\r\n                                    <div>\r\n                                        <h2 className=\"settings-section__title\">KDS Station Configuration</h2>\r\n                                        <p className=\"settings-section__description\">\r\n                                            Assign each product category to a specific KDS station\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"settings-section__body\">\r\n                                {/* Station Legend */}\r\n                                <div className=\"kds-stations-legend\">\r\n                                    {DISPATCH_STATIONS.map(station => (\r\n                                        <div key={station.value} className=\"kds-station-legend-item\">\r\n                                            <span\r\n                                                className=\"kds-station-dot\"\r\n                                                style={{ backgroundColor: station.color }}\r\n                                            />\r\n                                            <span className=\"kds-station-icon\" style={{ color: station.color }}>\r\n                                                {station.icon}\r\n                                            </span>\r\n                                            <span>{station.label}</span>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n\r\n                                {loadingCategories ? (\r\n                                    <div className=\"sections-loading\">\r\n                                        <RefreshCw size={24} className=\"spinning\" />\r\n                                        <span>Loading categories...</span>\r\n                                    </div>\r\n                                ) : categories.length === 0 ? (\r\n                                    <div className=\"sections-empty\">\r\n                                        <ChefHat size={48} />\r\n                                        <h3>No categories found</h3>\r\n                                        <p>Product categories will appear here.</p>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"kds-categories-list\">\r\n                                        {categories.map(category => {\r\n                                            const currentStation = DISPATCH_STATIONS.find(\r\n                                                s => s.value === (category.dispatch_station || 'none')\r\n                                            );\r\n                                            return (\r\n                                                <div key={category.id} className=\"kds-category-item\">\r\n                                                    <div className=\"kds-category-item__info\">\r\n                                                        <span className=\"kds-category-item__icon\">{category.icon}</span>\r\n                                                        <span className=\"kds-category-item__name\">{category.name}</span>\r\n                                                    </div>\r\n                                                    <div className=\"kds-category-item__station\">\r\n                                                        <select\r\n                                                            className=\"kds-station-select\"\r\n                                                            value={category.dispatch_station || 'none'}\r\n                                                            onChange={(e) => updateCategoryStation(category.id, e.target.value)}\r\n                                                            aria-label={`Station pour ${category.name}`}\r\n                                                            disabled={savingCategory === category.id}\r\n                                                            style={{\r\n                                                                borderColor: currentStation?.color,\r\n                                                                backgroundColor: `${currentStation?.color}15`\r\n                                                            }}\r\n                                                        >\r\n                                                            {DISPATCH_STATIONS.map(station => (\r\n                                                                <option key={station.value} value={station.value}>\r\n                                                                    {station.label}\r\n                                                                </option>\r\n                                                            ))}\r\n                                                        </select>\r\n                                                        {savingCategory === category.id && (\r\n                                                            <RefreshCw size={16} className=\"spinning kds-saving-icon\" />\r\n                                                        )}\r\n                                                    </div>\r\n                                                </div>\r\n                                            );\r\n                                        })}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'printers' && (\r\n                        <div className=\"settings-section\">\r\n                            <div className=\"settings-section__header\">\r\n                                <h2 className=\"settings-section__title\">Printers</h2>\r\n                                <p className=\"settings-section__description\">\r\n                                    Manage your receipt and kitchen printers\r\n                                </p>\r\n                            </div>\r\n                            <div className=\"settings-section__body\">\r\n                                <div className=\"printer-list\">\r\n                                    {printers.map(printer => (\r\n                                        <div key={printer.id} className=\"printer-item\">\r\n                                            <div className=\"printer-item__icon\">🖨️</div>\r\n                                            <div className=\"printer-item__info\">\r\n                                                <div className=\"printer-item__name\">{printer.name}</div>\r\n                                                <div className=\"printer-item__status\">\r\n                                                    <span className={`status-dot ${printer.status}`} />\r\n                                                    {printer.status === 'connected' ? 'Connected' : 'Disconnected'}\r\n                                                    <span className=\"printer-ip\">\r\n                                                        • {printer.ip}\r\n                                                    </span>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div className=\"printer-item__actions\">\r\n                                                <button className=\"btn-secondary\">\r\n                                                    <RefreshCw size={16} />\r\n                                                    Test\r\n                                                </button>\r\n                                                <button className=\"btn-secondary\" title=\"Settings\" aria-label=\"Printer settings\">\r\n                                                    <Settings size={16} />\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n\r\n                                <div className=\"form-footer\">\r\n                                    <button className=\"btn-primary\">\r\n                                        <Plus size={18} />\r\n                                        Add Printer\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'notifications' && (\r\n                        <NotificationSettingsSection />\r\n                    )}\r\n\r\n                    {activeTab === 'floorplan' && (\r\n                        <div className=\"settings-section\">\r\n                            <div className=\"settings-section__header\">\r\n                                <h2 className=\"settings-section__title\">Floor Plan</h2>\r\n                                <p className=\"settings-section__description\">\r\n                                    Configure the floor plan for Dine In orders\r\n                                </p>\r\n                            </div>\r\n                            <div className=\"settings-section__body\">\r\n                                <FloorPlanEditor />\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === 'security' && (\r\n                        <div className=\"settings-section\">\r\n                            <div className=\"settings-section__header\">\r\n                                <h2 className=\"settings-section__title\">Security</h2>\r\n                                <p className=\"settings-section__description\">\r\n                                    Security options and access control\r\n                                </p>\r\n                            </div>\r\n                            <div className=\"settings-section__body\">\r\n                                <div className=\"toggle-group\">\r\n                                    <div className=\"toggle-group__info\">\r\n                                        <span className=\"toggle-group__label\">Auto Logout</span>\r\n                                        <span className=\"toggle-group__description\">\r\n                                            Disconnect after 30 minutes of inactivity\r\n                                        </span>\r\n                                    </div>\r\n                                    <div\r\n                                        className={`toggle-switch ${settings.autoLogout ? 'is-on' : ''}`}\r\n                                        onClick={() => toggleSetting('autoLogout')}\r\n                                    />\r\n                                </div>\r\n\r\n                                <div className=\"form-group form-group--mt-lg\">\r\n                                    <label className=\"form-label\" htmlFor=\"manager-pin\">Manager PIN Code</label>\r\n                                    <input\r\n                                        id=\"manager-pin\"\r\n                                        type=\"password\"\r\n                                        className=\"form-input form-input--narrow\"\r\n                                        placeholder=\"••••\"\r\n                                    />\r\n                                </div>\r\n\r\n                                <div className=\"form-footer\">\r\n                                    <button className=\"btn-primary\">\r\n                                        <Save size={18} />\r\n                                        Change PIN\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Section Modal */}\r\n            {showSectionModal && (\r\n                <div className=\"section-modal-overlay\" onClick={() => setShowSectionModal(false)}>\r\n                    <div className=\"section-modal\" onClick={e => e.stopPropagation()}>\r\n                        <div className=\"section-modal__header\">\r\n                            <div className=\"section-modal__header-icon\">\r\n                                <Layers size={24} />\r\n                            </div>\r\n                            <div>\r\n                                <h2 className=\"section-modal__title\">\r\n                                    {editingSection ? 'Edit Section' : 'New Section'}\r\n                                </h2>\r\n                                <p className=\"section-modal__subtitle\">\r\n                                    {editingSection ? 'Edit section information' : 'Create a new section to organize your stock'}\r\n                                </p>\r\n                            </div>\r\n                            <button className=\"section-modal__close\" onClick={() => setShowSectionModal(false)} aria-label=\"Close\">\r\n                                <X size={24} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"section-modal__content\">\r\n                            <div className=\"section-form__group\">\r\n                                <label className=\"section-form__label\">\r\n                                    Section Name *\r\n                                </label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"section-form__input\"\r\n                                    value={sectionForm.name}\r\n                                    onChange={(e) => handleSectionNameChange(e.target.value)}\r\n                                    placeholder=\"e.g. Kitchen, Bar, Warehouse...\"\r\n                                    autoFocus\r\n                                    aria-label=\"Section name\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"section-form__row\">\r\n                                <div className=\"section-form__group\">\r\n                                    <label className=\"section-form__label\">\r\n                                        Code\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        className=\"section-form__input section-form__input--mono\"\r\n                                        value={sectionForm.code}\r\n                                        onChange={(e) => setSectionForm({ ...sectionForm, code: e.target.value })}\r\n                                        placeholder=\"kitchen\"\r\n                                        aria-label=\"Section code\"\r\n                                    />\r\n                                    <p className=\"section-form__hint\">\r\n                                        Unique identifier. Auto-generated.\r\n                                    </p>\r\n                                </div>\r\n                                <div className=\"section-form__group\">\r\n                                    <label className=\"section-form__label\">\r\n                                        Icon (emoji)\r\n                                    </label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        className=\"section-form__input section-form__input--icon\"\r\n                                        value={sectionForm.icon}\r\n                                        onChange={(e) => setSectionForm({ ...sectionForm, icon: e.target.value })}\r\n                                        placeholder=\"🍳\"\r\n                                        maxLength={4}\r\n                                        aria-label=\"Section icon\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"section-form__group\">\r\n                                <label className=\"section-form__label\">\r\n                                    Description\r\n                                </label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    className=\"section-form__input\"\r\n                                    value={sectionForm.description}\r\n                                    onChange={(e) => setSectionForm({ ...sectionForm, description: e.target.value })}\r\n                                    placeholder=\"Section description...\"\r\n                                    aria-label=\"Section description\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"section-form__group\">\r\n                                <label className=\"section-form__label\">Section Type *</label>\r\n                                <div className=\"section-form__types\">\r\n                                    {SECTION_TYPES.map(type => (\r\n                                        <label\r\n                                            key={type.value}\r\n                                            className={`section-type-card ${sectionForm.section_type === type.value ? 'is-selected' : ''}`}\r\n                                        >\r\n                                            <input\r\n                                                type=\"radio\"\r\n                                                name=\"section_type\"\r\n                                                value={type.value}\r\n                                                checked={sectionForm.section_type === type.value}\r\n                                                onChange={() => setSectionForm({ ...sectionForm, section_type: type.value })}\r\n                                            />\r\n                                            <div\r\n                                                className={`section-type-card__icon section-type-card__icon--${type.value}`}\r\n                                            >\r\n                                                {type.icon}\r\n                                            </div>\r\n                                            <div className=\"section-type-card__content\">\r\n                                                <span className=\"section-type-card__title\">{type.label}</span>\r\n                                            </div>\r\n                                        </label>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"section-modal__footer\">\r\n                            <button className=\"btn-secondary\" onClick={() => setShowSectionModal(false)}>\r\n                                Cancel\r\n                            </button>\r\n                            <button\r\n                                className=\"btn-primary\"\r\n                                onClick={handleSaveSection}\r\n                                disabled={savingSection || !sectionForm.name.trim()}\r\n                            >\r\n                                <Save size={18} />\r\n                                {savingSection ? 'Saving...' : (editingSection ? 'Update' : 'Create')}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SettingsPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\SyncStatusPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\TaxSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":103,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":120,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":120,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":150,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":150,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":160,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport {\r\n  Plus,\r\n  Edit2,\r\n  Trash2,\r\n  Save,\r\n  X,\r\n  CheckCircle,\r\n  Percent,\r\n} from 'lucide-react';\r\nimport {\r\n  useTaxRates,\r\n  useCreateTaxRate,\r\n  useUpdateTaxRate,\r\n  useDeleteTaxRate,\r\n  useSettingsByCategory,\r\n  useUpdateSetting,\r\n} from '../../hooks/settings';\r\nimport SettingField from '../../components/settings/SettingField';\r\nimport type { TaxRate } from '../../types/settings';\r\nimport { toast } from 'sonner';\r\n\r\ninterface TaxRateFormData {\r\n  code: string;\r\n  name_fr: string;\r\n  name_en: string;\r\n  name_id: string;\r\n  rate: number;\r\n  is_inclusive: boolean;\r\n  is_default: boolean;\r\n  is_active: boolean;\r\n}\r\n\r\nconst emptyForm: TaxRateFormData = {\r\n  code: '',\r\n  name_fr: '',\r\n  name_en: '',\r\n  name_id: '',\r\n  rate: 0,\r\n  is_inclusive: true,\r\n  is_default: false,\r\n  is_active: true,\r\n};\r\n\r\nconst TaxSettingsPage = () => {\r\n  const { data: taxRates, isLoading: loadingRates } = useTaxRates();\r\n  const { data: settings, isLoading: loadingSettings } = useSettingsByCategory('tax');\r\n  const createTaxRate = useCreateTaxRate();\r\n  const updateTaxRate = useUpdateTaxRate();\r\n  const deleteTaxRate = useDeleteTaxRate();\r\n  const updateSetting = useUpdateSetting();\r\n\r\n  const [showModal, setShowModal] = useState(false);\r\n  const [editingRate, setEditingRate] = useState<TaxRate | null>(null);\r\n  const [formData, setFormData] = useState<TaxRateFormData>(emptyForm);\r\n  const [settingValues, setSettingValues] = useState<Record<string, unknown>>({});\r\n\r\n  // Use English\r\n  const nameKey = 'name_en' as const;\r\n\r\n  // Open create modal\r\n  const openCreateModal = () => {\r\n    setEditingRate(null);\r\n    setFormData(emptyForm);\r\n    setShowModal(true);\r\n  };\r\n\r\n  // Open edit modal\r\n  const openEditModal = (rate: TaxRate) => {\r\n    setEditingRate(rate);\r\n    setFormData({\r\n      code: rate.code,\r\n      name_fr: rate.name_fr,\r\n      name_en: rate.name_en,\r\n      name_id: rate.name_id,\r\n      rate: rate.rate,\r\n      is_inclusive: rate.is_inclusive ?? false,\r\n      is_default: rate.is_default ?? false,\r\n      is_active: rate.is_active ?? true,\r\n    });\r\n    setShowModal(true);\r\n  };\r\n\r\n  // Handle save\r\n  const handleSave = async () => {\r\n    if (!formData.code || !formData.name_fr) {\r\n      toast.error('Code and name are required');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (editingRate) {\r\n        await updateTaxRate.mutateAsync({\r\n          id: editingRate.id,\r\n          updates: formData,\r\n        });\r\n        toast.success('Tax rate updated');\r\n      } else {\r\n        await createTaxRate.mutateAsync(formData as Omit<TaxRate, 'id' | 'created_at' | 'updated_at'>);\r\n        toast.success('Tax rate created');\r\n      }\r\n      setShowModal(false);\r\n    } catch (error) {\r\n      toast.error('Error saving');\r\n    }\r\n  };\r\n\r\n  // Handle delete\r\n  const handleDelete = async (rate: TaxRate) => {\r\n    if (rate.is_default) {\r\n      toast.error('Cannot delete default tax rate');\r\n      return;\r\n    }\r\n\r\n    if (!confirm(`Delete rate \"${rate[nameKey]}\"?`)) return;\r\n\r\n    try {\r\n      await deleteTaxRate.mutateAsync(rate.id);\r\n      toast.success('Tax rate deleted');\r\n    } catch (error) {\r\n      toast.error('Error deleting');\r\n    }\r\n  };\r\n\r\n  // Set as default\r\n  const handleSetDefault = async (rate: TaxRate) => {\r\n    try {\r\n      // Unset previous default\r\n      const currentDefault = taxRates?.find((r) => r.is_default);\r\n      if (currentDefault) {\r\n        await updateTaxRate.mutateAsync({\r\n          id: currentDefault.id,\r\n          updates: { is_default: false },\r\n        });\r\n      }\r\n\r\n      // Set new default\r\n      await updateTaxRate.mutateAsync({\r\n        id: rate.id,\r\n        updates: { is_default: true },\r\n      });\r\n\r\n      // Update the setting\r\n      await updateSetting.mutateAsync({\r\n        key: 'tax.default_rate',\r\n        value: rate.code,\r\n      });\r\n\r\n      toast.success(`${rate[nameKey]} set as default`);\r\n    } catch (error) {\r\n      toast.error('Error updating');\r\n    }\r\n  };\r\n\r\n  // Handle setting change\r\n  const handleSettingChange = async (key: string, value: unknown) => {\r\n    try {\r\n      await updateSetting.mutateAsync({ key, value });\r\n      toast.success('Setting saved');\r\n    } catch (error) {\r\n      toast.error('Error saving');\r\n    }\r\n  };\r\n\r\n  const isLoading = loadingRates || loadingSettings;\r\n\r\n  return (\r\n    <>\r\n      {/* Tax Rates Section */}\r\n      <div className=\"settings-section\">\r\n        <div className=\"settings-section__header\">\r\n          <div className=\"settings-section__header-content\">\r\n            <div>\r\n              <h2 className=\"settings-section__title\">Tax Rates (PPN)</h2>\r\n              <p className=\"settings-section__description\">\r\n                Manage applicable VAT rates for products\r\n              </p>\r\n            </div>\r\n            <button className=\"btn-primary\" onClick={openCreateModal}>\r\n              <Plus size={16} />\r\n              New Rate\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"settings-section__body\">\r\n          {isLoading ? (\r\n            <div className=\"settings-section__loading\">\r\n              <div className=\"spinner\" />\r\n              <span>Loading...</span>\r\n            </div>\r\n          ) : taxRates?.length === 0 ? (\r\n            <div className=\"settings-section__empty\">\r\n              <Percent size={48} />\r\n              <h3>No tax rates</h3>\r\n              <p>Create your first tax rate to get started.</p>\r\n              <button className=\"btn-primary\" onClick={openCreateModal}>\r\n                <Plus size={16} />\r\n                Create Rate\r\n              </button>\r\n            </div>\r\n          ) : (\r\n            <div className=\"tax-rates-list\">\r\n              {taxRates?.map((rate) => (\r\n                <div\r\n                  key={rate.id}\r\n                  className={`tax-rate-item ${!rate.is_active ? 'is-inactive' : ''}`}\r\n                >\r\n                  <div className=\"tax-rate-item__info\">\r\n                    <div className=\"tax-rate-item__header\">\r\n                      <span className=\"tax-rate-item__code\">{rate.code}</span>\r\n                      {rate.is_default && (\r\n                        <span className=\"tax-rate-item__default-badge\">\r\n                          <CheckCircle size={12} />\r\n                          Default\r\n                        </span>\r\n                      )}\r\n                      {!rate.is_active && (\r\n                        <span className=\"tax-rate-item__inactive-badge\">\r\n                          Inactive\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"tax-rate-item__name\">{rate[nameKey]}</div>\r\n                    <div className=\"tax-rate-item__details\">\r\n                      <span className=\"tax-rate-item__rate\">{rate.rate}%</span>\r\n                      <span className=\"tax-rate-item__type\">\r\n                        {rate.is_inclusive ? 'TTC' : 'HT'}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"tax-rate-item__actions\">\r\n                    {!rate.is_default && rate.is_active && (\r\n                      <button\r\n                        className=\"btn-ghost\"\r\n                        onClick={() => handleSetDefault(rate)}\r\n                        title=\"Set as default\"\r\n                      >\r\n                        <CheckCircle size={16} />\r\n                      </button>\r\n                    )}\r\n                    <button\r\n                      className=\"btn-ghost\"\r\n                      onClick={() => openEditModal(rate)}\r\n                      title=\"Edit\"\r\n                    >\r\n                      <Edit2 size={16} />\r\n                    </button>\r\n                    <button\r\n                      className=\"btn-ghost btn-ghost--danger\"\r\n                      onClick={() => handleDelete(rate)}\r\n                      title=\"Delete\"\r\n                      disabled={rate.is_default ?? false}\r\n                    >\r\n                      <Trash2 size={16} />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Tax Settings Section */}\r\n      <div className=\"settings-section\">\r\n        <div className=\"settings-section__header\">\r\n          <h2 className=\"settings-section__title\">Billing Settings</h2>\r\n          <p className=\"settings-section__description\">\r\n            Configure tax display and calculation\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"settings-section__body\">\r\n          {loadingSettings ? (\r\n            <div className=\"settings-section__loading\">\r\n              <div className=\"spinner\" />\r\n            </div>\r\n          ) : (\r\n            <div className=\"settings-list\">\r\n              {settings?.map((setting) => (\r\n                <SettingField\r\n                  key={setting.key}\r\n                  setting={setting}\r\n                  value={settingValues[setting.key] ?? setting.value}\r\n                  onChange={(value) => {\r\n                    setSettingValues((prev) => ({ ...prev, [setting.key]: value }));\r\n                    handleSettingChange(setting.key, value);\r\n                  }}\r\n                />\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modal */}\r\n      {showModal && (\r\n        <div className=\"settings-modal-overlay\" onClick={() => setShowModal(false)}>\r\n          <div className=\"settings-modal\" onClick={(e) => e.stopPropagation()}>\r\n            <div className=\"settings-modal__header\">\r\n              <h2 className=\"settings-modal__title\">\r\n                {editingRate ? 'Edit Tax Rate' : 'New Tax Rate'}\r\n              </h2>\r\n              <button className=\"settings-modal__close\" onClick={() => setShowModal(false)}>\r\n                <X size={20} />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"settings-modal__body\">\r\n              <div className=\"form-row\">\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Code *</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"form-input\"\r\n                    value={formData.code}\r\n                    onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}\r\n                    placeholder=\"PPN_10\"\r\n                    disabled={!!editingRate}\r\n                  />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Rate (%) *</label>\r\n                  <input\r\n                    type=\"number\"\r\n                    className=\"form-input\"\r\n                    value={formData.rate}\r\n                    onChange={(e) => setFormData({ ...formData, rate: Number(e.target.value) })}\r\n                    min={0}\r\n                    max={100}\r\n                    step={0.01}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-label\">Name (French) *</label>\r\n                <input\r\n                  type=\"text\"\r\n                  className=\"form-input\"\r\n                  value={formData.name_fr}\r\n                  onChange={(e) => setFormData({ ...formData, name_fr: e.target.value })}\r\n                  placeholder=\"PPN 10%\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"form-row\">\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Name (English)</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"form-input\"\r\n                    value={formData.name_en}\r\n                    onChange={(e) => setFormData({ ...formData, name_en: e.target.value })}\r\n                    placeholder=\"VAT 10%\"\r\n                  />\r\n                </div>\r\n                <div className=\"form-group\">\r\n                  <label className=\"form-label\">Name (Indonesian)</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"form-input\"\r\n                    value={formData.name_id}\r\n                    onChange={(e) => setFormData({ ...formData, name_id: e.target.value })}\r\n                    placeholder=\"PPN 10%\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-checkbox\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={formData.is_inclusive}\r\n                    onChange={(e) => setFormData({ ...formData, is_inclusive: e.target.checked })}\r\n                  />\r\n                  <span>Tax-inclusive price (tax included in displayed price)</span>\r\n                </label>\r\n              </div>\r\n\r\n              <div className=\"form-group\">\r\n                <label className=\"form-checkbox\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={formData.is_active}\r\n                    onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}\r\n                  />\r\n                  <span>Active</span>\r\n                </label>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"settings-modal__footer\">\r\n              <button className=\"btn-secondary\" onClick={() => setShowModal(false)}>\r\n                Cancel\r\n              </button>\r\n              <button\r\n                className=\"btn-primary\"\r\n                onClick={handleSave}\r\n                disabled={createTaxRate.isPending || updateTaxRate.isPending}\r\n              >\r\n                <Save size={16} />\r\n                {editingRate ? 'Update' : 'Create'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default TaxSettingsPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\__tests__\\CompanySettingsPage.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\settings\\__tests__\\PrintingSettingsPage.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\users\\PermissionsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\pages\\users\\UsersPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\ClaudeService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\ReportingService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1037,1040],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1037,1040],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1647,1650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1647,1650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":222,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7847,7850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7847,7850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":235,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8261,8264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8261,8264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":288,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10109,10112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10109,10112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":309,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10826,10829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10826,10829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase';\r\nimport { StockMovement } from '../types/database';\r\nimport {\r\n    SalesComparison,\r\n    PaymentMethodStat,\r\n    DailySalesStat,\r\n    ProductPerformanceStat,\r\n    CategorySalesStat,\r\n    StockWaste,\r\n    SessionDiscrepancy,\r\n    InventoryValuation,\r\n    DashboardSummary,\r\n    AuditLogEntry,\r\n    // Epic 3: New report types\r\n    IProfitLossReport,\r\n    ISalesByCustomerReport,\r\n    ISalesByHourReport,\r\n    ISessionCashBalanceReport,\r\n    IB2BReceivablesReport,\r\n    IStockWarningReport,\r\n    IExpiredStockReport,\r\n    IUnsoldProductsReport,\r\n    ICancellationsReport,\r\n} from '../types/reporting';\r\n\r\nexport const ReportingService = {\r\n    /**\r\n     * Get Sales Comparison between two periods (e.g. This Week vs Last Week)\r\n     */\r\n    async getSalesComparison(\r\n        currentStart: Date,\r\n        currentEnd: Date,\r\n        previousStart: Date,\r\n        previousEnd: Date\r\n    ): Promise<SalesComparison[]> {\r\n        const { data, error } = await supabase.rpc('get_sales_comparison' as any, {\r\n            current_start: currentStart.toISOString(),\r\n            current_end: currentEnd.toISOString(),\r\n            previous_start: previousStart.toISOString(),\r\n            previous_end: previousEnd.toISOString(),\r\n        });\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as SalesComparison[];\r\n    },\r\n\r\n    /**\r\n     * Get Holistic Dashboard Summary\r\n     */\r\n    async getDashboardSummary(\r\n        startDate: Date,\r\n        endDate: Date\r\n    ): Promise<DashboardSummary> {\r\n        const { data, error } = await supabase.rpc('get_reporting_dashboard_summary' as any, {\r\n            start_date: startDate.toISOString(),\r\n            end_date: endDate.toISOString(),\r\n        });\r\n\r\n        if (error) throw error;\r\n        return data as unknown as DashboardSummary;\r\n    },\r\n\r\n    /**\r\n     * Get Payment Method Statistics\r\n     */\r\n    async getPaymentMethodStats(): Promise<PaymentMethodStat[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_payment_method_stats' as never)\r\n            .select('*') as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as PaymentMethodStat[];\r\n    },\r\n\r\n    /**\r\n     * Get Daily Sales Statistics\r\n     */\r\n    async getDailySales(startDate: Date, endDate: Date): Promise<DailySalesStat[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_daily_kpis' as never)\r\n            .select('*')\r\n            .gte('date', startDate.toISOString())\r\n            .lte('date', endDate.toISOString())\r\n            .order('date', { ascending: true }) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n\r\n        type KpiRow = {\r\n            date: string | null;\r\n            total_revenue: number | null;\r\n            total_orders: number | null;\r\n            avg_order_value: number | null;\r\n            total_tax: number | null;\r\n        };\r\n        const rawData = (data || []) as KpiRow[];\r\n        return rawData.map((row) => ({\r\n            date: row.date || '',\r\n            total_sales: row.total_revenue || 0,\r\n            total_orders: row.total_orders || 0,\r\n            avg_basket: row.avg_order_value || 0,\r\n            net_revenue: (row.total_revenue || 0) - (row.total_tax || 0)\r\n        }));\r\n    },\r\n\r\n    /**\r\n     * Get Product Performance\r\n     */\r\n    async getProductPerformance(startDate: Date, endDate: Date): Promise<ProductPerformanceStat[]> {\r\n        const { data, error } = await supabase\r\n            .from('order_items')\r\n            .select('product_id, product_name, quantity, total_price, product:products(cost_price, category:categories(name))')\r\n            .gte('created_at', startDate.toISOString())\r\n            .lte('created_at', endDate.toISOString())\r\n            .eq('item_status', 'served');\r\n\r\n        if (error) throw error;\r\n\r\n        const map = new Map<string, ProductPerformanceStat>();\r\n\r\n        type OrderItemRow = {\r\n            product_id: string | null;\r\n            product_name: string;\r\n            quantity: number;\r\n            total_price: number;\r\n            product?: { cost_price?: number; category?: { name?: string } };\r\n        };\r\n        const rawData = data as unknown as OrderItemRow[];\r\n        rawData?.forEach((item) => {\r\n            const key = item.product_id ?? item.product_name;\r\n            if (!map.has(key)) {\r\n                map.set(key, {\r\n                    product_id: item.product_id ?? '',\r\n                    product_name: item.product_name,\r\n                    category_name: item.product?.category?.name || 'Uncategorized',\r\n                    quantity_sold: 0,\r\n                    total_revenue: 0,\r\n                    avg_price: 0,\r\n                    cost_price: item.product?.cost_price || 0,\r\n                });\r\n            }\r\n            const stat = map.get(key)!;\r\n            stat.quantity_sold += item.quantity;\r\n            stat.total_revenue += item.total_price;\r\n        });\r\n\r\n        const result = Array.from(map.values()).map(stat => ({\r\n            ...stat,\r\n            avg_price: stat.quantity_sold > 0 ? stat.total_revenue / stat.quantity_sold : 0,\r\n            margin_percentage: stat.total_revenue > 0\r\n                ? ((stat.total_revenue - stat.quantity_sold * (stat.cost_price || 0)) / stat.total_revenue) * 100\r\n                : 0,\r\n        }));\r\n\r\n        return result.sort((a, b) => b.total_revenue - a.total_revenue);\r\n    },\r\n\r\n    async getStockMovements(startDate: Date, endDate: Date): Promise<StockMovement[]> {\r\n        const { data, error } = await supabase\r\n            .from('stock_movements')\r\n            .select(`\r\n                *,\r\n                product:products(name, sku, unit)\r\n            `)\r\n            .gte('created_at', startDate.toISOString())\r\n            .lte('created_at', endDate.toISOString())\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n        return data || [];\r\n    },\r\n\r\n    /**\r\n     * Get Sales By Category\r\n     */\r\n    async getSalesByCategory(startDate: Date, endDate: Date): Promise<CategorySalesStat[]> {\r\n        const { data, error } = await supabase\r\n            .from('order_items')\r\n            .select(`\r\n                quantity, \r\n                total_price, \r\n                product:products(category:categories(id, name))\r\n            `)\r\n            .gte('created_at', startDate.toISOString())\r\n            .lte('created_at', endDate.toISOString())\r\n            .eq('item_status', 'served');\r\n\r\n        if (error) throw error;\r\n\r\n        const map = new Map<string, CategorySalesStat>();\r\n\r\n        type CategoryItemRow = {\r\n            quantity: number;\r\n            total_price: number;\r\n            product?: { category?: { id: string; name: string } };\r\n        };\r\n        const rawData = data as unknown as CategoryItemRow[];\r\n        rawData?.forEach((item) => {\r\n            const category = item.product?.category;\r\n            const key = category?.id || 'uncategorized';\r\n            const name = category?.name || 'Uncategorized';\r\n\r\n            if (!map.has(key)) {\r\n                map.set(key, {\r\n                    category_id: key,\r\n                    category_name: name,\r\n                    total_revenue: 0,\r\n                    transaction_count: 0\r\n                });\r\n            }\r\n            const stat = map.get(key)!;\r\n            stat.transaction_count += item.quantity;\r\n            stat.total_revenue += item.total_price;\r\n        });\r\n\r\n        return Array.from(map.values()).sort((a, b) => b.total_revenue - a.total_revenue);\r\n    },\r\n\r\n    /**\r\n     * Get Stock Waste Report\r\n     */\r\n    async getStockWasteReport(): Promise<StockWaste[]> {\r\n        const { data, error } = await (supabase as any)\r\n            .from('view_stock_waste')\r\n            .select('*')\r\n            .order('waste_date', { ascending: false });\r\n\r\n        if (error) throw error;\r\n        return (data || []) as StockWaste[];\r\n    },\r\n\r\n    /**\r\n     * Get Session Discrepancies (Cashier Performance)\r\n     */\r\n    async getSessionDiscrepancies(): Promise<SessionDiscrepancy[]> {\r\n        const { data, error } = await (supabase as any)\r\n            .from('view_session_discrepancies')\r\n            .select('*')\r\n            .order('closed_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n        return (data || []) as SessionDiscrepancy[];\r\n    },\r\n\r\n    /**\r\n     * Get Real-time Inventory Valuation\r\n     */\r\n    async getInventoryValuation(): Promise<InventoryValuation> {\r\n        // This view may not exist in the schema, calculate from products table\r\n        const { data, error } = await supabase\r\n            .from('products')\r\n            .select('current_stock, cost_price, retail_price')\r\n            .eq('is_active', true);\r\n\r\n        if (error) throw error;\r\n\r\n        // Aggregate the results\r\n        type InventoryRow = {\r\n            current_stock: number | null;\r\n            cost_price: number | null;\r\n            retail_price: number | null;\r\n        };\r\n        const items = (data || []) as InventoryRow[];\r\n        return {\r\n            total_skus: items.length,\r\n            total_items_in_stock: items.reduce((sum, i) => sum + (i.current_stock || 0), 0),\r\n            total_valuation_cost: items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.cost_price || 0)), 0),\r\n            total_valuation_retail: items.reduce((sum, i) => sum + ((i.current_stock || 0) * (i.retail_price || 0)), 0),\r\n        };\r\n    },\r\n\r\n    /**\r\n     * Get Audit Logs\r\n     */\r\n    async getAuditLogs(limit = 50): Promise<AuditLogEntry[]> {\r\n        const { data, error } = await supabase\r\n            .from('audit_logs')\r\n            .select('*')\r\n            .order('created_at', { ascending: false })\r\n            .limit(limit);\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as AuditLogEntry[];\r\n    },\r\n\r\n    /**\r\n     * Get Purchase Details\r\n     */\r\n    async getPurchaseDetails(startDate: Date, endDate: Date): Promise<any[]> {\r\n        const { data, error } = await supabase\r\n            .from('stock_movements')\r\n            .select(`\r\n                *,\r\n                product:products(name, sku, unit, cost_price),\r\n                staff:user_profiles(name),\r\n                supplier:suppliers(name)\r\n            `)\r\n            .eq('movement_type', 'purchase')\r\n            .gte('created_at', startDate.toISOString())\r\n            .lte('created_at', endDate.toISOString())\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n        return data || [];\r\n    },\r\n\r\n    /**\r\n     * Get Purchase By Supplier\r\n     */\r\n    async getPurchaseBySupplier(startDate: Date, endDate: Date): Promise<any[]> {\r\n        const { data, error } = await supabase\r\n            .from('stock_movements')\r\n            .select(`\r\n                *,\r\n                product:products(name, sku, unit, cost_price),\r\n                supplier:suppliers(name)\r\n            `)\r\n            .eq('movement_type', 'purchase')\r\n            .gte('created_at', startDate.toISOString())\r\n            .lte('created_at', endDate.toISOString());\r\n\r\n        if (error) throw error;\r\n\r\n        // Aggregate by supplier\r\n        const map = new Map<string, { supplier_name: string, total_quantity: number, total_value: number, transaction_count: number }>();\r\n\r\n        type SupplierMovementRow = {\r\n            quantity: number;\r\n            supplier?: { name?: string };\r\n            product?: { cost_price?: number };\r\n        };\r\n        const rawData = data as unknown as SupplierMovementRow[];\r\n        rawData?.forEach((item) => {\r\n            const supplierName = item.supplier?.name || 'Unknown Supplier';\r\n            const key = supplierName;\r\n\r\n            if (!map.has(key)) {\r\n                map.set(key, {\r\n                    supplier_name: supplierName,\r\n                    total_quantity: 0,\r\n                    total_value: 0,\r\n                    transaction_count: 0\r\n                });\r\n            }\r\n            const stat = map.get(key)!;\r\n            stat.transaction_count += 1;\r\n            stat.total_quantity += item.quantity;\r\n            stat.total_value += (item.product?.cost_price || 0) * item.quantity;\r\n        });\r\n\r\n        return Array.from(map.values()).sort((a, b) => b.total_value - a.total_value);\r\n    },\r\n\r\n    // =============================================================\r\n    // Epic 3: New Report Methods (Story 3.3)\r\n    // =============================================================\r\n\r\n    /**\r\n     * Get Profit/Loss Report (FR35)\r\n     */\r\n    async getProfitLoss(startDate: Date, endDate: Date): Promise<IProfitLossReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_profit_loss' as never)\r\n            .select('*')\r\n            .gte('report_date', startDate.toISOString().split('T')[0])\r\n            .lte('report_date', endDate.toISOString().split('T')[0])\r\n            .order('report_date', { ascending: false }) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as IProfitLossReport[];\r\n    },\r\n\r\n    /**\r\n     * Get Sales by Customer Report (FR36)\r\n     */\r\n    async getSalesByCustomer(startDate: Date, endDate: Date): Promise<ISalesByCustomerReport[]> {\r\n        // Query from orders with customer join and filter by date\r\n        const { data, error } = await supabase\r\n            .from('view_sales_by_customer' as never)\r\n            .select('*') as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n\r\n        // Filter by date range if last_order_at is within range\r\n        const filtered = (data || []) as ISalesByCustomerReport[];\r\n        return filtered.filter(c =>\r\n            c.last_order_at &&\r\n            new Date(c.last_order_at) >= startDate &&\r\n            new Date(c.last_order_at) <= endDate\r\n        );\r\n    },\r\n\r\n    /**\r\n     * Get Sales by Hour Report (FR37)\r\n     */\r\n    async getSalesByHour(startDate: Date, endDate: Date): Promise<ISalesByHourReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_sales_by_hour' as never)\r\n            .select('*')\r\n            .gte('report_date', startDate.toISOString().split('T')[0])\r\n            .lte('report_date', endDate.toISOString().split('T')[0])\r\n            .order('hour_of_day', { ascending: true }) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as ISalesByHourReport[];\r\n    },\r\n\r\n    /**\r\n     * Get Session Cash Balance Report (FR44)\r\n     */\r\n    async getSessionCashBalance(startDate: Date, endDate: Date): Promise<ISessionCashBalanceReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_session_cash_balance' as never)\r\n            .select('*')\r\n            .gte('started_at', startDate.toISOString())\r\n            .lte('started_at', endDate.toISOString())\r\n            .order('started_at', { ascending: false }) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as ISessionCashBalanceReport[];\r\n    },\r\n\r\n    /**\r\n     * Get B2B Receivables Report (FR45)\r\n     */\r\n    async getB2BReceivables(): Promise<IB2BReceivablesReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_b2b_receivables' as never)\r\n            .select('*')\r\n            .gt('outstanding_amount', 0)\r\n            .order('outstanding_amount', { ascending: false }) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as IB2BReceivablesReport[];\r\n    },\r\n\r\n    /**\r\n     * Get Stock Warning Report (FR40, FR41)\r\n     */\r\n    async getStockWarning(): Promise<IStockWarningReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_stock_warning' as never)\r\n            .select('*') as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as IStockWarningReport[];\r\n    },\r\n\r\n    /**\r\n     * Get Expired Stock Report (FR42)\r\n     */\r\n    async getExpiredStock(): Promise<IExpiredStockReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_expired_stock' as never)\r\n            .select('*')\r\n            .in('expiry_status', ['expired', 'expiring_soon', 'expiring']) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as IExpiredStockReport[];\r\n    },\r\n\r\n    /**\r\n     * Get Unsold Products Report (FR43)\r\n     */\r\n    async getUnsoldProducts(daysSinceLastSale: number = 30): Promise<IUnsoldProductsReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('view_unsold_products' as never)\r\n            .select('*')\r\n            .gte('days_since_sale', daysSinceLastSale)\r\n            .order('days_since_sale', { ascending: false }) as { data: unknown[] | null; error: Error | null };\r\n\r\n        if (error) throw error;\r\n        return (data || []) as unknown as IUnsoldProductsReport[];\r\n    },\r\n\r\n    /**\r\n     * Get Cancellations Report (FR38)\r\n     */\r\n    async getCancellations(startDate: Date, endDate: Date): Promise<ICancellationsReport[]> {\r\n        const { data, error } = await supabase\r\n            .from('orders')\r\n            .select(`\r\n                id,\r\n                order_number,\r\n                cancelled_at,\r\n                total,\r\n                cancellation_reason,\r\n                staff:user_profiles!orders_staff_id_fkey(name),\r\n                order_items(id)\r\n            `)\r\n            .eq('status', 'cancelled')\r\n            .gte('cancelled_at', startDate.toISOString())\r\n            .lte('cancelled_at', endDate.toISOString())\r\n            .order('cancelled_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        type CancellationRow = {\r\n            id: string;\r\n            order_number: string;\r\n            cancelled_at: string;\r\n            total: number;\r\n            cancellation_reason: string | null;\r\n            staff: { name: string } | null;\r\n            order_items: { id: string }[];\r\n        };\r\n\r\n        return ((data || []) as unknown as CancellationRow[]).map(o => ({\r\n            order_id: o.id,\r\n            order_number: o.order_number,\r\n            cancelled_at: o.cancelled_at,\r\n            cashier_name: o.staff?.name || null,\r\n            order_total: o.total,\r\n            cancel_reason: o.cancellation_reason,\r\n            items_count: o.order_items?.length || 0,\r\n        }));\r\n    },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\anthropicService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\authService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\b2b\\__tests__\\arService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[643,646],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[643,646],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[767,770],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[767,770],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[915,918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[915,918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1093,1096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1093,1096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1471,1474],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1471,1474],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1763,1766],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1763,1766],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1970,1973],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1970,1973],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\r\nimport {\r\n    allocatePaymentFIFO,\r\n    exportOutstandingCSV,\r\n    type IOutstandingOrder,\r\n} from '../arService'\r\n\r\n// Mock supabase for the async functions\r\nconst mockFrom = vi.fn()\r\nconst mockSelect = vi.fn()\r\nconst mockIn = vi.fn()\r\nconst mockNeq = vi.fn()\r\nconst mockOrder = vi.fn()\r\nconst mockEq = vi.fn()\r\nconst mockSingle = vi.fn()\r\nconst mockUpdate = vi.fn()\r\nconst mockInsert = vi.fn()\r\n\r\nvi.mock('../../../lib/supabase', () => ({\r\n    supabase: {\r\n        from: (table: string) => {\r\n            mockFrom(table)\r\n            return {\r\n                select: (...args: any[]) => {\r\n                    mockSelect(...args)\r\n                    return {\r\n                        in: (...inArgs: any[]) => {\r\n                            mockIn(...inArgs)\r\n                            return {\r\n                                neq: (...neqArgs: any[]) => {\r\n                                    mockNeq(...neqArgs)\r\n                                    return {\r\n                                        order: (...orderArgs: any[]) => {\r\n                                            mockOrder(...orderArgs)\r\n                                            return { data: [], error: null }\r\n                                        },\r\n                                    }\r\n                                },\r\n                            }\r\n                        },\r\n                        eq: (...eqArgs: any[]) => {\r\n                            mockEq(...eqArgs)\r\n                            return {\r\n                                single: () => mockSingle(),\r\n                            }\r\n                        },\r\n                    }\r\n                },\r\n                update: (data: any) => {\r\n                    mockUpdate(data)\r\n                    return {\r\n                        eq: () => ({ error: null }),\r\n                    }\r\n                },\r\n                insert: (data: any) => {\r\n                    mockInsert(data)\r\n                    return { error: null }\r\n                },\r\n            }\r\n        },\r\n    },\r\n}))\r\n\r\ndescribe('arService', () => {\r\n    beforeEach(() => {\r\n        vi.clearAllMocks()\r\n    })\r\n\r\n    describe('allocatePaymentFIFO', () => {\r\n        const baseOrders: IOutstandingOrder[] = [\r\n            {\r\n                id: 'order-1',\r\n                order_number: 'B2B-001',\r\n                customer_id: 'cust-1',\r\n                customer_name: 'John',\r\n                company_name: 'Acme Corp',\r\n                total: 500000,\r\n                paid_amount: 0,\r\n                amount_due: 500000,\r\n                due_date: '2026-01-01',\r\n                order_date: '2025-12-15',\r\n                payment_status: 'unpaid',\r\n                days_overdue: 36,\r\n            },\r\n            {\r\n                id: 'order-2',\r\n                order_number: 'B2B-002',\r\n                customer_id: 'cust-1',\r\n                customer_name: 'John',\r\n                company_name: 'Acme Corp',\r\n                total: 300000,\r\n                paid_amount: 100000,\r\n                amount_due: 200000,\r\n                due_date: '2026-01-15',\r\n                order_date: '2026-01-01',\r\n                payment_status: 'partial',\r\n                days_overdue: 22,\r\n            },\r\n            {\r\n                id: 'order-3',\r\n                order_number: 'B2B-003',\r\n                customer_id: 'cust-1',\r\n                customer_name: 'John',\r\n                company_name: 'Acme Corp',\r\n                total: 400000,\r\n                paid_amount: 0,\r\n                amount_due: 400000,\r\n                due_date: '2026-02-01',\r\n                order_date: '2026-01-10',\r\n                payment_status: 'unpaid',\r\n                days_overdue: 5,\r\n            },\r\n        ]\r\n\r\n        it('allocates to oldest order first', () => {\r\n            const result = allocatePaymentFIFO(baseOrders, 300000)\r\n\r\n            expect(result.allocations).toHaveLength(1)\r\n            expect(result.allocations[0].orderId).toBe('order-1')\r\n            expect(result.allocations[0].allocatedAmount).toBe(300000)\r\n            expect(result.allocations[0].isFullyPaid).toBe(false)\r\n            expect(result.totalAllocated).toBe(300000)\r\n            expect(result.remainingAmount).toBe(0)\r\n        })\r\n\r\n        it('fully pays oldest then allocates remainder to next', () => {\r\n            const result = allocatePaymentFIFO(baseOrders, 600000)\r\n\r\n            expect(result.allocations).toHaveLength(2)\r\n            // First order fully paid\r\n            expect(result.allocations[0].orderId).toBe('order-1')\r\n            expect(result.allocations[0].allocatedAmount).toBe(500000)\r\n            expect(result.allocations[0].isFullyPaid).toBe(true)\r\n            // Remainder to second order\r\n            expect(result.allocations[1].orderId).toBe('order-2')\r\n            expect(result.allocations[1].allocatedAmount).toBe(100000)\r\n            expect(result.allocations[1].isFullyPaid).toBe(false)\r\n            expect(result.totalAllocated).toBe(600000)\r\n            expect(result.remainingAmount).toBe(0)\r\n        })\r\n\r\n        it('pays all orders and returns remaining', () => {\r\n            const totalDue = 500000 + 200000 + 400000 // 1,100,000\r\n            const result = allocatePaymentFIFO(baseOrders, 1500000)\r\n\r\n            expect(result.allocations).toHaveLength(3)\r\n            expect(result.totalAllocated).toBe(totalDue)\r\n            expect(result.remainingAmount).toBe(400000) // 1,500,000 - 1,100,000\r\n            expect(result.allocations[0].isFullyPaid).toBe(true)\r\n            expect(result.allocations[1].isFullyPaid).toBe(true)\r\n            expect(result.allocations[2].isFullyPaid).toBe(true)\r\n        })\r\n\r\n        it('handles zero payment amount', () => {\r\n            const result = allocatePaymentFIFO(baseOrders, 0)\r\n\r\n            expect(result.allocations).toHaveLength(0)\r\n            expect(result.totalAllocated).toBe(0)\r\n            expect(result.remainingAmount).toBe(0)\r\n        })\r\n\r\n        it('handles empty orders array', () => {\r\n            const result = allocatePaymentFIFO([], 100000)\r\n\r\n            expect(result.allocations).toHaveLength(0)\r\n            expect(result.totalAllocated).toBe(0)\r\n            expect(result.remainingAmount).toBe(100000)\r\n        })\r\n\r\n        it('sorts by order date regardless of input order', () => {\r\n            // Reversed input order\r\n            const reversedOrders = [...baseOrders].reverse()\r\n            const result = allocatePaymentFIFO(reversedOrders, 500000)\r\n\r\n            // Should still allocate to order-1 (oldest) first\r\n            expect(result.allocations[0].orderId).toBe('order-1')\r\n            expect(result.allocations[0].allocatedAmount).toBe(500000)\r\n        })\r\n\r\n        it('updates newPaidAmount correctly for partial orders', () => {\r\n            const result = allocatePaymentFIFO(baseOrders, 700000)\r\n\r\n            // order-2 had paid_amount: 100000, gets 200000 allocated\r\n            const order2Allocation = result.allocations.find(a => a.orderId === 'order-2')\r\n            expect(order2Allocation).toBeDefined()\r\n            expect(order2Allocation!.newPaidAmount).toBe(300000) // 100000 + 200000\r\n            expect(order2Allocation!.isFullyPaid).toBe(true)\r\n        })\r\n\r\n        it('exactly matches amount_due for full payment', () => {\r\n            const result = allocatePaymentFIFO(baseOrders, 500000)\r\n\r\n            expect(result.allocations[0].allocatedAmount).toBe(500000)\r\n            expect(result.allocations[0].isFullyPaid).toBe(true)\r\n            expect(result.allocations[0].newPaidAmount).toBe(500000) // 0 + 500000\r\n            expect(result.remainingAmount).toBe(0)\r\n        })\r\n    })\r\n\r\n    describe('exportOutstandingCSV', () => {\r\n        it('generates valid CSV headers', () => {\r\n            const csv = exportOutstandingCSV([])\r\n            const lines = csv.split('\\n')\r\n\r\n            expect(lines[0]).toBe(\r\n                'Order Number,Customer,Company,Order Date,Due Date,Total,Paid,Amount Due,Days Overdue,Status'\r\n            )\r\n        })\r\n\r\n        it('generates CSV rows with quoted fields', () => {\r\n            const orders: IOutstandingOrder[] = [\r\n                {\r\n                    id: '1',\r\n                    order_number: 'B2B-001',\r\n                    customer_id: 'c1',\r\n                    customer_name: 'Test Customer',\r\n                    company_name: 'Test Corp',\r\n                    total: 500000,\r\n                    paid_amount: 200000,\r\n                    amount_due: 300000,\r\n                    due_date: '2026-01-15',\r\n                    order_date: '2026-01-01',\r\n                    payment_status: 'partial',\r\n                    days_overdue: 22,\r\n                },\r\n            ]\r\n\r\n            const csv = exportOutstandingCSV(orders)\r\n            const lines = csv.split('\\n')\r\n\r\n            expect(lines).toHaveLength(2) // header + 1 row\r\n            expect(lines[1]).toContain('\"B2B-001\"')\r\n            expect(lines[1]).toContain('\"Test Customer\"')\r\n            expect(lines[1]).toContain('\"Test Corp\"')\r\n            expect(lines[1]).toContain('\"300000\"')\r\n            expect(lines[1]).toContain('\"partial\"')\r\n        })\r\n\r\n        it('handles null company name', () => {\r\n            const orders: IOutstandingOrder[] = [\r\n                {\r\n                    id: '1',\r\n                    order_number: 'B2B-001',\r\n                    customer_id: 'c1',\r\n                    customer_name: 'Solo',\r\n                    company_name: null,\r\n                    total: 100000,\r\n                    paid_amount: 0,\r\n                    amount_due: 100000,\r\n                    due_date: null,\r\n                    order_date: '2026-01-01',\r\n                    payment_status: 'unpaid',\r\n                    days_overdue: 0,\r\n                },\r\n            ]\r\n\r\n            const csv = exportOutstandingCSV(orders)\r\n            const lines = csv.split('\\n')\r\n\r\n            // Company field should be empty string quoted\r\n            expect(lines[1]).toContain('\"\"')\r\n        })\r\n\r\n        it('handles multiple orders', () => {\r\n            const orders: IOutstandingOrder[] = [\r\n                {\r\n                    id: '1',\r\n                    order_number: 'B2B-001',\r\n                    customer_id: 'c1',\r\n                    customer_name: 'A',\r\n                    company_name: null,\r\n                    total: 100000,\r\n                    paid_amount: 0,\r\n                    amount_due: 100000,\r\n                    due_date: null,\r\n                    order_date: '2026-01-01',\r\n                    payment_status: 'unpaid',\r\n                    days_overdue: 0,\r\n                },\r\n                {\r\n                    id: '2',\r\n                    order_number: 'B2B-002',\r\n                    customer_id: 'c2',\r\n                    customer_name: 'B',\r\n                    company_name: 'Corp B',\r\n                    total: 200000,\r\n                    paid_amount: 50000,\r\n                    amount_due: 150000,\r\n                    due_date: '2026-01-15',\r\n                    order_date: '2026-01-05',\r\n                    payment_status: 'partial',\r\n                    days_overdue: 22,\r\n                },\r\n            ]\r\n\r\n            const csv = exportOutstandingCSV(orders)\r\n            const lines = csv.split('\\n')\r\n\r\n            expect(lines).toHaveLength(3) // header + 2 rows\r\n        })\r\n    })\r\n\r\n    describe('module exports', () => {\r\n        it('exports all expected functions', async () => {\r\n            const mod = await import('../arService')\r\n            expect(typeof mod.getOutstandingOrders).toBe('function')\r\n            expect(typeof mod.generateAgingReport).toBe('function')\r\n            expect(typeof mod.allocatePaymentFIFO).toBe('function')\r\n            expect(typeof mod.applyFIFOPayment).toBe('function')\r\n            expect(typeof mod.exportOutstandingCSV).toBe('function')\r\n            expect(typeof mod.downloadCSV).toBe('function')\r\n        })\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\b2b\\__tests__\\b2bPosOrderService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[482,485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[482,485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[606,609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[606,609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[870,873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[870,873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1028,1031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1028,1031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1425,1428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1425,1428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1706,1709],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1706,1709],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\r\n\r\n// Mock supabase\r\nconst mockFrom = vi.fn()\r\nconst mockInsert = vi.fn()\r\nconst mockSelect = vi.fn()\r\nconst mockEq = vi.fn()\r\nconst mockSingle = vi.fn()\r\nconst mockOrder = vi.fn()\r\nconst mockLimit = vi.fn()\r\nconst mockUpdate = vi.fn()\r\n\r\nvi.mock('../../../lib/supabase', () => ({\r\n    supabase: {\r\n        from: (table: string) => {\r\n            mockFrom(table)\r\n            return {\r\n                select: (...args: any[]) => {\r\n                    mockSelect(...args)\r\n                    return {\r\n                        eq: (...eqArgs: any[]) => {\r\n                            mockEq(...eqArgs)\r\n                            return {\r\n                                single: () => mockSingle(),\r\n                            }\r\n                        },\r\n                        order: (...orderArgs: any[]) => {\r\n                            mockOrder(...orderArgs)\r\n                            return {\r\n                                limit: (...limitArgs: any[]) => {\r\n                                    mockLimit(...limitArgs)\r\n                                    return {\r\n                                        single: () => mockSingle(),\r\n                                    }\r\n                                },\r\n                            }\r\n                        },\r\n                    }\r\n                },\r\n                insert: (data: any) => {\r\n                    mockInsert(data)\r\n                    return {\r\n                        select: () => ({\r\n                            single: () => mockSingle(),\r\n                        }),\r\n                    }\r\n                },\r\n                update: (data: any) => {\r\n                    mockUpdate(data)\r\n                    return {\r\n                        eq: () => ({ error: null }),\r\n                    }\r\n                },\r\n            }\r\n        },\r\n    },\r\n}))\r\n\r\nimport { checkCustomerCredit } from '../b2bPosOrderService'\r\n\r\ndescribe('b2bPosOrderService', () => {\r\n    beforeEach(() => {\r\n        vi.clearAllMocks()\r\n    })\r\n\r\n    describe('checkCustomerCredit', () => {\r\n        it('returns no credit when customer not found', async () => {\r\n            mockSingle.mockResolvedValueOnce({ data: null, error: null })\r\n\r\n            const result = await checkCustomerCredit('cust-1', 50000)\r\n            expect(result.hasCredit).toBe(false)\r\n            expect(result.availableCredit).toBe(0)\r\n            expect(result.creditStatus).toBe('none')\r\n        })\r\n\r\n        it('returns credit info for approved customer', async () => {\r\n            mockSingle.mockResolvedValueOnce({\r\n                data: {\r\n                    credit_limit: 1000000,\r\n                    credit_balance: 200000,\r\n                    credit_status: 'approved',\r\n                },\r\n                error: null,\r\n            })\r\n\r\n            const result = await checkCustomerCredit('cust-1', 50000)\r\n            expect(result.hasCredit).toBe(true)\r\n            expect(result.availableCredit).toBe(800000)\r\n            expect(result.creditStatus).toBe('approved')\r\n        })\r\n\r\n        it('returns false when credit insufficient', async () => {\r\n            mockSingle.mockResolvedValueOnce({\r\n                data: {\r\n                    credit_limit: 100000,\r\n                    credit_balance: 80000,\r\n                    credit_status: 'approved',\r\n                },\r\n                error: null,\r\n            })\r\n\r\n            const result = await checkCustomerCredit('cust-1', 50000)\r\n            expect(result.hasCredit).toBe(false)\r\n            expect(result.availableCredit).toBe(20000)\r\n        })\r\n\r\n        it('returns false when credit suspended', async () => {\r\n            mockSingle.mockResolvedValueOnce({\r\n                data: {\r\n                    credit_limit: 1000000,\r\n                    credit_balance: 0,\r\n                    credit_status: 'suspended',\r\n                },\r\n                error: null,\r\n            })\r\n\r\n            const result = await checkCustomerCredit('cust-1', 50000)\r\n            expect(result.hasCredit).toBe(false)\r\n            expect(result.creditStatus).toBe('suspended')\r\n        })\r\n\r\n        it('handles null credit fields', async () => {\r\n            mockSingle.mockResolvedValueOnce({\r\n                data: {\r\n                    credit_limit: null,\r\n                    credit_balance: null,\r\n                    credit_status: null,\r\n                },\r\n                error: null,\r\n            })\r\n\r\n            const result = await checkCustomerCredit('cust-1', 50000)\r\n            expect(result.hasCredit).toBe(false)\r\n            expect(result.availableCredit).toBe(0)\r\n            expect(result.creditStatus).toBe('none')\r\n        })\r\n    })\r\n})\r\n\r\ndescribe('b2bPosOrderService module', () => {\r\n    it('exports createB2BPosOrder', async () => {\r\n        const mod = await import('../b2bPosOrderService')\r\n        expect(typeof mod.createB2BPosOrder).toBe('function')\r\n    })\r\n\r\n    it('exports checkCustomerCredit', async () => {\r\n        const mod = await import('../b2bPosOrderService')\r\n        expect(typeof mod.checkCustomerCredit).toBe('function')\r\n    })\r\n\r\n    it('exports IB2BPosOrderInput type', async () => {\r\n        // Type-only check - module loads without error\r\n        const mod = await import('../b2bPosOrderService')\r\n        expect(mod).toBeDefined()\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\b2b\\arService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2146,2149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2146,2149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Accounts Receivable Service (Story 6.8)\r\n *\r\n * Handles FIFO payment allocation, aging reports, and CSV export\r\n * for B2B outstanding orders.\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase'\r\n\r\nexport interface IOutstandingOrder {\r\n    id: string\r\n    order_number: string\r\n    customer_id: string\r\n    customer_name: string\r\n    company_name: string | null\r\n    total: number\r\n    paid_amount: number\r\n    amount_due: number\r\n    due_date: string | null\r\n    order_date: string\r\n    payment_status: string\r\n    days_overdue: number\r\n}\r\n\r\nexport interface IAgingBucket {\r\n    label: string\r\n    minDays: number\r\n    maxDays: number | null\r\n    orders: IOutstandingOrder[]\r\n    totalDue: number\r\n    count: number\r\n}\r\n\r\nexport interface IAgingReport {\r\n    buckets: IAgingBucket[]\r\n    totalOutstanding: number\r\n    totalOrders: number\r\n    generatedAt: string\r\n}\r\n\r\nexport interface IFIFOAllocationResult {\r\n    allocations: Array<{\r\n        orderId: string\r\n        orderNumber: string\r\n        allocatedAmount: number\r\n        newPaidAmount: number\r\n        isFullyPaid: boolean\r\n    }>\r\n    totalAllocated: number\r\n    remainingAmount: number\r\n}\r\n\r\n/**\r\n * Fetch all outstanding B2B orders\r\n */\r\nexport async function getOutstandingOrders(): Promise<IOutstandingOrder[]> {\r\n    const { data, error } = await supabase\r\n        .from('b2b_orders')\r\n        .select(`\r\n            id, order_number, customer_id, total, paid_amount,\r\n            delivery_date, order_date, payment_status,\r\n            customer:customers(name, company_name)\r\n        `)\r\n        .in('payment_status', ['unpaid', 'partial'])\r\n        .neq('status', 'cancelled')\r\n        .order('order_date', { ascending: true })\r\n\r\n    if (error) {\r\n        console.error('Error fetching outstanding orders:', error)\r\n        return []\r\n    }\r\n\r\n    const now = new Date()\r\n\r\n    return (data || []).map(order => {\r\n        const dueDate = order.delivery_date ? new Date(order.delivery_date) : null\r\n        const daysOverdue = dueDate ? Math.max(0, Math.floor((now.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24))) : 0\r\n        const customer = order.customer as any\r\n\r\n        return {\r\n            id: order.id,\r\n            order_number: order.order_number,\r\n            customer_id: order.customer_id,\r\n            customer_name: customer?.name || 'Unknown',\r\n            company_name: customer?.company_name || null,\r\n            total: order.total || 0,\r\n            paid_amount: order.paid_amount || 0,\r\n            amount_due: (order.total || 0) - (order.paid_amount || 0),\r\n            due_date: order.delivery_date,\r\n            order_date: order.order_date,\r\n            payment_status: order.payment_status || 'unpaid',\r\n            days_overdue: daysOverdue,\r\n        }\r\n    })\r\n}\r\n\r\n/**\r\n * Generate aging report with standard buckets\r\n */\r\nexport async function generateAgingReport(): Promise<IAgingReport> {\r\n    const orders = await getOutstandingOrders()\r\n\r\n    const bucketDefs = [\r\n        { label: 'Current (0-30 days)', minDays: 0, maxDays: 30 },\r\n        { label: 'Overdue (31-60 days)', minDays: 31, maxDays: 60 },\r\n        { label: 'Critical (60+ days)', minDays: 61, maxDays: null },\r\n    ]\r\n\r\n    const buckets: IAgingBucket[] = bucketDefs.map(def => {\r\n        const bucketOrders = orders.filter(o => {\r\n            if (def.maxDays === null) return o.days_overdue >= def.minDays\r\n            return o.days_overdue >= def.minDays && o.days_overdue <= def.maxDays\r\n        })\r\n\r\n        return {\r\n            ...def,\r\n            orders: bucketOrders,\r\n            totalDue: bucketOrders.reduce((sum, o) => sum + o.amount_due, 0),\r\n            count: bucketOrders.length,\r\n        }\r\n    })\r\n\r\n    return {\r\n        buckets,\r\n        totalOutstanding: orders.reduce((sum, o) => sum + o.amount_due, 0),\r\n        totalOrders: orders.length,\r\n        generatedAt: new Date().toISOString(),\r\n    }\r\n}\r\n\r\n/**\r\n * Allocate a payment amount across orders using FIFO (oldest first)\r\n */\r\nexport function allocatePaymentFIFO(\r\n    orders: IOutstandingOrder[],\r\n    paymentAmount: number\r\n): IFIFOAllocationResult {\r\n    // Sort by order date (oldest first)\r\n    const sortedOrders = [...orders].sort(\r\n        (a, b) => new Date(a.order_date).getTime() - new Date(b.order_date).getTime()\r\n    )\r\n\r\n    let remaining = paymentAmount\r\n    const allocations: IFIFOAllocationResult['allocations'] = []\r\n\r\n    for (const order of sortedOrders) {\r\n        if (remaining <= 0) break\r\n\r\n        const allocatedAmount = Math.min(remaining, order.amount_due)\r\n        const newPaidAmount = order.paid_amount + allocatedAmount\r\n        const isFullyPaid = newPaidAmount >= order.total\r\n\r\n        allocations.push({\r\n            orderId: order.id,\r\n            orderNumber: order.order_number,\r\n            allocatedAmount,\r\n            newPaidAmount,\r\n            isFullyPaid,\r\n        })\r\n\r\n        remaining -= allocatedAmount\r\n    }\r\n\r\n    return {\r\n        allocations,\r\n        totalAllocated: paymentAmount - remaining,\r\n        remainingAmount: Math.max(0, remaining),\r\n    }\r\n}\r\n\r\n/**\r\n * Apply FIFO payment allocations to orders in database\r\n */\r\nexport async function applyFIFOPayment(\r\n    customerId: string,\r\n    paymentAmount: number,\r\n    paymentMethod: string,\r\n    reference: string | null,\r\n    createdBy: string\r\n): Promise<{ success: boolean; error?: string; allocations?: IFIFOAllocationResult }> {\r\n    // Get customer's outstanding orders\r\n    const allOrders = await getOutstandingOrders()\r\n    const customerOrders = allOrders.filter(o => o.customer_id === customerId)\r\n\r\n    if (customerOrders.length === 0) {\r\n        return { success: false, error: 'No outstanding orders for this customer' }\r\n    }\r\n\r\n    const result = allocatePaymentFIFO(customerOrders, paymentAmount)\r\n\r\n    if (result.allocations.length === 0) {\r\n        return { success: false, error: 'No allocations could be made' }\r\n    }\r\n\r\n    // Apply each allocation — stop on first error to prevent inconsistent state\r\n    const appliedAllocations: typeof result.allocations = []\r\n\r\n    for (const allocation of result.allocations) {\r\n        // Update order paid_amount and payment_status\r\n        const newStatus = allocation.isFullyPaid ? 'paid' : 'partial'\r\n        const { error: updateError } = await supabase\r\n            .from('b2b_orders')\r\n            .update({\r\n                paid_amount: allocation.newPaidAmount,\r\n                payment_status: newStatus,\r\n                ...(allocation.isFullyPaid ? { paid_at: new Date().toISOString() } : {}),\r\n            })\r\n            .eq('id', allocation.orderId)\r\n\r\n        if (updateError) {\r\n            console.error(`Error updating order ${allocation.orderNumber}:`, updateError)\r\n            return {\r\n                success: false,\r\n                error: `Failed to update order ${allocation.orderNumber}: ${updateError.message}. ${appliedAllocations.length} allocation(s) were already applied.`,\r\n            }\r\n        }\r\n\r\n        // Create payment record\r\n        const { error: paymentError } = await supabase\r\n            .from('b2b_payments')\r\n            .insert({\r\n                order_id: allocation.orderId,\r\n                customer_id: customerId,\r\n                payment_date: new Date().toISOString(),\r\n                payment_method: paymentMethod,\r\n                amount: allocation.allocatedAmount,\r\n                reference_number: reference,\r\n                status: 'completed',\r\n                created_by: createdBy,\r\n            })\r\n\r\n        if (paymentError) {\r\n            console.error(`Error creating payment for ${allocation.orderNumber}:`, paymentError)\r\n            return {\r\n                success: false,\r\n                error: `Failed to record payment for ${allocation.orderNumber}: ${paymentError.message}. Order was updated but payment record missing.`,\r\n            }\r\n        }\r\n\r\n        appliedAllocations.push(allocation)\r\n    }\r\n\r\n    // Reduce customer credit balance\r\n    const { data: customer } = await supabase\r\n        .from('customers')\r\n        .select('credit_balance')\r\n        .eq('id', customerId)\r\n        .single()\r\n\r\n    if (customer) {\r\n        const totalApplied = appliedAllocations.reduce((sum, a) => sum + a.allocatedAmount, 0)\r\n        const newBalance = Math.max(0, (customer.credit_balance || 0) - totalApplied)\r\n        const { error: balanceError } = await supabase\r\n            .from('customers')\r\n            .update({ credit_balance: newBalance })\r\n            .eq('id', customerId)\r\n\r\n        if (balanceError) {\r\n            console.error('Error updating credit balance:', balanceError)\r\n            return {\r\n                success: false,\r\n                error: `Payments applied but credit balance update failed: ${balanceError.message}`,\r\n            }\r\n        }\r\n    }\r\n\r\n    return { success: true, allocations: result }\r\n}\r\n\r\n/**\r\n * Export outstanding orders as CSV string\r\n */\r\nexport function exportOutstandingCSV(orders: IOutstandingOrder[]): string {\r\n    const headers = [\r\n        'Order Number',\r\n        'Customer',\r\n        'Company',\r\n        'Order Date',\r\n        'Due Date',\r\n        'Total',\r\n        'Paid',\r\n        'Amount Due',\r\n        'Days Overdue',\r\n        'Status',\r\n    ]\r\n\r\n    const rows = orders.map(o => [\r\n        o.order_number,\r\n        o.customer_name,\r\n        o.company_name || '',\r\n        o.order_date ? new Date(o.order_date).toLocaleDateString() : '',\r\n        o.due_date ? new Date(o.due_date).toLocaleDateString() : '',\r\n        o.total.toString(),\r\n        o.paid_amount.toString(),\r\n        o.amount_due.toString(),\r\n        o.days_overdue.toString(),\r\n        o.payment_status,\r\n    ])\r\n\r\n    const csvContent = [\r\n        headers.join(','),\r\n        ...rows.map(row => row.map(cell => `\"${cell}\"`).join(',')),\r\n    ].join('\\n')\r\n\r\n    return csvContent\r\n}\r\n\r\n/**\r\n * Trigger CSV download in browser\r\n */\r\nexport function downloadCSV(csvContent: string, filename: string): void {\r\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })\r\n    const link = document.createElement('a')\r\n    link.href = URL.createObjectURL(blob)\r\n    link.download = filename\r\n    link.click()\r\n    URL.revokeObjectURL(link.href)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\b2b\\b2bPosOrderService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\b2b\\creditService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\display\\displayBroadcast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\display\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\__tests__\\financialOperationService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\__tests__\\refundService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\__tests__\\securityAudit.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\__tests__\\voidService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\auditService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\financialOperationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\refundService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\financial\\voidService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\inventory\\deferredAdjustmentService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\inventory\\deferredAdjustmentService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\inventory\\inventoryAlerts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\inventory\\stockReservation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\kds\\__tests__\\kdsStatusService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\kds\\__tests__\\orderCompletionService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\kds\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\kds\\kdsStatusService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\kds\\orderCompletionService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\lan\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\lan\\lanClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\lan\\lanHub.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\lan\\lanHub.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\lan\\lanProtocol.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\lan\\lanProtocol.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":179,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":179,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4420,4423],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4420,4423],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":206,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5225,5228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5225,5228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":223,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5685,5688],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5685,5688],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":245,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":245,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6275,6278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6275,6278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":264,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":264,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6739,6742],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6739,6742],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":326,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":326,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8210,8213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8210,8213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":350,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":350,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8841,8844],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8841,8844],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":381,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":381,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9592,9595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9592,9595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":409,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":409,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10355,10358],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10355,10358],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\cartPersistenceService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1755,1758],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1755,1758],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":493,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":493,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15172,15175],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15172,15175],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Cart Persistence Service Tests (Story 3.2)\r\n *\r\n * Tests for cart state persistence in localStorage\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';\r\nimport 'fake-indexeddb/auto';\r\nimport { db } from '@/lib/db';\r\nimport {\r\n  saveCart,\r\n  loadCart,\r\n  clearPersistedCart,\r\n  hasPersistedCart,\r\n  validateAndFilterCartItems,\r\n  CART_PERSISTENCE_KEY,\r\n  type IPersistedCartState,\r\n  type TSaveCartInput,\r\n} from '../cartPersistenceService';\r\nimport type { CartItem } from '@/stores/cartStore';\r\n\r\n// Mock localStorage\r\nconst localStorageMock = (() => {\r\n  let store: Record<string, string> = {};\r\n  return {\r\n    getItem: vi.fn((key: string) => store[key] ?? null),\r\n    setItem: vi.fn((key: string, value: string) => {\r\n      store[key] = value;\r\n    }),\r\n    removeItem: vi.fn((key: string) => {\r\n      delete store[key];\r\n    }),\r\n    clear: vi.fn(() => {\r\n      store = {};\r\n    }),\r\n    get length() {\r\n      return Object.keys(store).length;\r\n    },\r\n    key: vi.fn((index: number) => Object.keys(store)[index] ?? null),\r\n  };\r\n})();\r\n\r\nObject.defineProperty(window, 'localStorage', { value: localStorageMock });\r\n\r\n// Test fixtures\r\nconst createMockProduct = (id: string, name: string) => ({\r\n  id,\r\n  name,\r\n  sku: `SKU-${id}`,\r\n  retail_price: 10000,\r\n  category_id: 'cat-1',\r\n  product_type: 'finished',\r\n  is_active: true,\r\n  pos_visible: true,\r\n  available_for_sale: true,\r\n  wholesale_price: null,\r\n  cost_price: null,\r\n  current_stock: null,\r\n  image_url: null,\r\n  updated_at: new Date().toISOString(),\r\n});\r\n\r\nconst createMockCartItem = (\r\n  id: string,\r\n  productId: string,\r\n  productName: string\r\n): CartItem => ({\r\n  id,\r\n  type: 'product',\r\n  product: createMockProduct(productId, productName) as any,\r\n  quantity: 1,\r\n  unitPrice: 10000,\r\n  modifiers: [],\r\n  modifiersTotal: 0,\r\n  notes: '',\r\n  totalPrice: 10000,\r\n});\r\n\r\nconst createMockCartState = (items: CartItem[] = []): TSaveCartInput => ({\r\n  items,\r\n  lockedItemIds: [],\r\n  activeOrderId: null,\r\n  activeOrderNumber: null,\r\n  orderType: 'dine_in',\r\n  tableNumber: null,\r\n  customerId: null,\r\n  customerName: null,\r\n  customerCategorySlug: null,\r\n  discountType: null,\r\n  discountValue: 0,\r\n  discountReason: null,\r\n});\r\n\r\ndescribe('cartPersistenceService', () => {\r\n  beforeEach(async () => {\r\n    localStorageMock.clear();\r\n    vi.clearAllMocks();\r\n    // Clear Dexie tables\r\n    await db.offline_products.clear();\r\n  });\r\n\r\n  afterEach(async () => {\r\n    // Clear tables (don't close database)\r\n    await db.offline_products.clear();\r\n  });\r\n\r\n  describe('saveCart', () => {\r\n    it('should save cart state to localStorage', () => {\r\n      const cartState = createMockCartState();\r\n\r\n      saveCart(cartState);\r\n\r\n      expect(localStorageMock.setItem).toHaveBeenCalledWith(\r\n        CART_PERSISTENCE_KEY,\r\n        expect.any(String)\r\n      );\r\n\r\n      const savedData = JSON.parse(\r\n        localStorageMock.setItem.mock.calls[0][1]\r\n      ) as IPersistedCartState;\r\n      expect(savedData.items).toEqual([]);\r\n      expect(savedData.orderType).toBe('dine_in');\r\n      expect(savedData.savedAt).toBeDefined();\r\n    });\r\n\r\n    it('should save cart with items and modifiers', () => {\r\n      const item = createMockCartItem('item-1', 'prod-1', 'Test Product');\r\n      item.modifiers = [\r\n        {\r\n          groupName: 'Size',\r\n          optionId: 'opt-1',\r\n          optionLabel: 'Large',\r\n          priceAdjustment: 5000,\r\n        },\r\n      ];\r\n      item.modifiersTotal = 5000;\r\n      item.totalPrice = 15000;\r\n\r\n      const cartState = createMockCartState([item]);\r\n\r\n      saveCart(cartState);\r\n\r\n      const savedData = JSON.parse(\r\n        localStorageMock.setItem.mock.calls[0][1]\r\n      ) as IPersistedCartState;\r\n      expect(savedData.items).toHaveLength(1);\r\n      expect(savedData.items[0].modifiers).toHaveLength(1);\r\n      expect(savedData.items[0].modifiers[0].optionLabel).toBe('Large');\r\n    });\r\n\r\n    it('should save complete cart state including customer and discount', () => {\r\n      const cartState: TSaveCartInput = {\r\n        items: [createMockCartItem('item-1', 'prod-1', 'Product 1')],\r\n        lockedItemIds: ['item-1'],\r\n        activeOrderId: 'order-123',\r\n        activeOrderNumber: 'OFFLINE-20260201-001',\r\n        orderType: 'takeaway',\r\n        tableNumber: 'T5',\r\n        customerId: 'cust-1',\r\n        customerName: 'John Doe',\r\n        customerCategorySlug: 'retail',\r\n        discountType: 'percent',\r\n        discountValue: 10,\r\n        discountReason: 'VIP customer',\r\n      };\r\n\r\n      saveCart(cartState);\r\n\r\n      const savedData = JSON.parse(\r\n        localStorageMock.setItem.mock.calls[0][1]\r\n      ) as IPersistedCartState;\r\n      expect(savedData.lockedItemIds).toEqual(['item-1']);\r\n      expect(savedData.activeOrderId).toBe('order-123');\r\n      expect(savedData.orderType).toBe('takeaway');\r\n      expect(savedData.customerId).toBe('cust-1');\r\n      expect(savedData.discountType).toBe('percent');\r\n      expect(savedData.discountValue).toBe(10);\r\n    });\r\n\r\n    it('should not throw on localStorage error', () => {\r\n      localStorageMock.setItem.mockImplementationOnce(() => {\r\n        throw new Error('QuotaExceededError');\r\n      });\r\n\r\n      expect(() => saveCart(createMockCartState())).not.toThrow();\r\n    });\r\n  });\r\n\r\n  describe('loadCart', () => {\r\n    it('should return null when no cart exists', () => {\r\n      const result = loadCart();\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it('should return null for invalid JSON', () => {\r\n      localStorageMock.getItem.mockReturnValueOnce('invalid json {{{');\r\n\r\n      const result = loadCart();\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it('should return null when items array is missing', () => {\r\n      localStorageMock.getItem.mockReturnValueOnce(\r\n        JSON.stringify({ orderType: 'dine_in' })\r\n      );\r\n\r\n      const result = loadCart();\r\n      expect(result).toBeNull();\r\n    });\r\n\r\n    it('should load and parse valid cart state', () => {\r\n      const cartState: IPersistedCartState = {\r\n        items: [createMockCartItem('item-1', 'prod-1', 'Product 1')],\r\n        lockedItemIds: ['item-1'],\r\n        activeOrderId: 'order-123',\r\n        activeOrderNumber: 'OFFLINE-20260201-001',\r\n        orderType: 'takeaway',\r\n        tableNumber: 'T5',\r\n        customerId: 'cust-1',\r\n        customerName: 'John Doe',\r\n        customerCategorySlug: 'retail',\r\n        discountType: 'percent',\r\n        discountValue: 10,\r\n        discountReason: 'VIP',\r\n        savedAt: '2026-02-01T10:00:00.000Z',\r\n      };\r\n\r\n      localStorageMock.getItem.mockReturnValueOnce(JSON.stringify(cartState));\r\n\r\n      const result = loadCart();\r\n\r\n      expect(result).not.toBeNull();\r\n      expect(result!.items).toHaveLength(1);\r\n      expect(result!.lockedItemIds).toEqual(['item-1']);\r\n      expect(result!.activeOrderId).toBe('order-123');\r\n      expect(result!.orderType).toBe('takeaway');\r\n      expect(result!.customerId).toBe('cust-1');\r\n      expect(result!.discountValue).toBe(10);\r\n    });\r\n\r\n    it('should provide defaults for missing optional fields', () => {\r\n      const minimalCart = {\r\n        items: [],\r\n      };\r\n\r\n      localStorageMock.getItem.mockReturnValueOnce(JSON.stringify(minimalCart));\r\n\r\n      const result = loadCart();\r\n\r\n      expect(result).not.toBeNull();\r\n      expect(result!.lockedItemIds).toEqual([]);\r\n      expect(result!.activeOrderId).toBeNull();\r\n      expect(result!.orderType).toBe('dine_in');\r\n      expect(result!.discountValue).toBe(0);\r\n    });\r\n  });\r\n\r\n  describe('clearPersistedCart', () => {\r\n    it('should remove cart from localStorage', () => {\r\n      clearPersistedCart();\r\n\r\n      expect(localStorageMock.removeItem).toHaveBeenCalledWith(\r\n        CART_PERSISTENCE_KEY\r\n      );\r\n    });\r\n\r\n    it('should not throw on localStorage error', () => {\r\n      localStorageMock.removeItem.mockImplementationOnce(() => {\r\n        throw new Error('Storage error');\r\n      });\r\n\r\n      expect(() => clearPersistedCart()).not.toThrow();\r\n    });\r\n  });\r\n\r\n  describe('hasPersistedCart', () => {\r\n    it('should return false when no cart exists', () => {\r\n      expect(hasPersistedCart()).toBe(false);\r\n    });\r\n\r\n    it('should return true when cart exists', () => {\r\n      localStorageMock.getItem.mockReturnValueOnce('{}');\r\n\r\n      expect(hasPersistedCart()).toBe(true);\r\n    });\r\n\r\n    it('should return false when localStorage throws error', () => {\r\n      localStorageMock.getItem.mockImplementationOnce(() => {\r\n        throw new Error('Storage access denied');\r\n      });\r\n\r\n      expect(hasPersistedCart()).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('saveCart/loadCart round-trip', () => {\r\n    it('should preserve all data through save/load cycle', () => {\r\n      const originalState: TSaveCartInput = {\r\n        items: [\r\n          {\r\n            ...createMockCartItem('item-1', 'prod-1', 'Product 1'),\r\n            modifiers: [\r\n              {\r\n                groupName: 'Temperature',\r\n                optionId: 'opt-1',\r\n                optionLabel: 'Iced',\r\n                priceAdjustment: 2000,\r\n              },\r\n            ],\r\n            modifiersTotal: 2000,\r\n            totalPrice: 12000,\r\n          },\r\n        ],\r\n        lockedItemIds: ['item-1'],\r\n        activeOrderId: 'LOCAL-123',\r\n        activeOrderNumber: 'OFFLINE-20260201-005',\r\n        orderType: 'delivery',\r\n        tableNumber: null,\r\n        customerId: 'cust-abc',\r\n        customerName: 'Test Customer',\r\n        customerCategorySlug: 'wholesale',\r\n        discountType: 'amount',\r\n        discountValue: 5000,\r\n        discountReason: 'Promo code',\r\n      };\r\n\r\n      // Save\r\n      saveCart(originalState);\r\n\r\n      // Get the saved string and set it up for load\r\n      const savedString = localStorageMock.setItem.mock.calls[0][1];\r\n      localStorageMock.getItem.mockReturnValueOnce(savedString);\r\n\r\n      // Load\r\n      const loadedState = loadCart();\r\n\r\n      expect(loadedState).not.toBeNull();\r\n      expect(loadedState!.items).toHaveLength(1);\r\n      expect(loadedState!.items[0].id).toBe('item-1');\r\n      expect(loadedState!.items[0].modifiers).toHaveLength(1);\r\n      expect(loadedState!.lockedItemIds).toEqual(['item-1']);\r\n      expect(loadedState!.activeOrderId).toBe('LOCAL-123');\r\n      expect(loadedState!.orderType).toBe('delivery');\r\n      expect(loadedState!.customerId).toBe('cust-abc');\r\n      expect(loadedState!.discountType).toBe('amount');\r\n      expect(loadedState!.discountValue).toBe(5000);\r\n      expect(loadedState!.savedAt).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe('validateAndFilterCartItems', () => {\r\n    it('should keep items with valid products in offline cache', async () => {\r\n      // Add product to offline cache\r\n      await db.offline_products.add({\r\n        id: 'prod-1',\r\n        name: 'Valid Product',\r\n        sku: 'SKU-1',\r\n        retail_price: 10000,\r\n        category_id: 'cat-1',\r\n        product_type: 'finished',\r\n        is_active: true,\r\n        pos_visible: true,\r\n        available_for_sale: true,\r\n        wholesale_price: null,\r\n        cost_price: null,\r\n        current_stock: null,\r\n        image_url: null,\r\n        updated_at: new Date().toISOString(),\r\n      });\r\n\r\n      const items = [createMockCartItem('item-1', 'prod-1', 'Valid Product')];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(1);\r\n      expect(validItems[0].id).toBe('item-1');\r\n      expect(removedNames).toHaveLength(0);\r\n    });\r\n\r\n    it('should remove items with products not in offline cache', async () => {\r\n      const items = [\r\n        createMockCartItem('item-1', 'non-existent-prod', 'Missing Product'),\r\n      ];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(0);\r\n      expect(removedNames).toHaveLength(1);\r\n      expect(removedNames[0]).toBe('Missing Product');\r\n    });\r\n\r\n    it('should remove items with inactive products', async () => {\r\n      // Add inactive product to offline cache\r\n      await db.offline_products.add({\r\n        id: 'prod-inactive',\r\n        name: 'Inactive Product',\r\n        sku: 'SKU-I',\r\n        retail_price: 10000,\r\n        category_id: 'cat-1',\r\n        product_type: 'finished',\r\n        is_active: false, // Inactive\r\n        pos_visible: true,\r\n        available_for_sale: true,\r\n        wholesale_price: null,\r\n        cost_price: null,\r\n        current_stock: null,\r\n        image_url: null,\r\n        updated_at: new Date().toISOString(),\r\n      });\r\n\r\n      const items = [\r\n        createMockCartItem('item-1', 'prod-inactive', 'Inactive Product'),\r\n      ];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(0);\r\n      expect(removedNames).toHaveLength(1);\r\n    });\r\n\r\n    it('should remove items with products not visible in POS', async () => {\r\n      // Add product that is not POS visible\r\n      await db.offline_products.add({\r\n        id: 'prod-hidden',\r\n        name: 'Hidden Product',\r\n        sku: 'SKU-H',\r\n        retail_price: 10000,\r\n        category_id: 'cat-1',\r\n        product_type: 'finished',\r\n        is_active: true,\r\n        pos_visible: false, // Not visible in POS\r\n        available_for_sale: true,\r\n        wholesale_price: null,\r\n        cost_price: null,\r\n        current_stock: null,\r\n        image_url: null,\r\n        updated_at: new Date().toISOString(),\r\n      });\r\n\r\n      const items = [\r\n        createMockCartItem('item-1', 'prod-hidden', 'Hidden Product'),\r\n      ];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(0);\r\n      expect(removedNames).toHaveLength(1);\r\n      expect(removedNames[0]).toBe('Hidden Product');\r\n    });\r\n\r\n    it('should remove items with products not available for sale', async () => {\r\n      // Add product that is not available for sale\r\n      await db.offline_products.add({\r\n        id: 'prod-unavailable',\r\n        name: 'Unavailable Product',\r\n        sku: 'SKU-U',\r\n        retail_price: 10000,\r\n        category_id: 'cat-1',\r\n        product_type: 'finished',\r\n        is_active: true,\r\n        pos_visible: true,\r\n        available_for_sale: false, // Not available for sale\r\n        wholesale_price: null,\r\n        cost_price: null,\r\n        current_stock: null,\r\n        image_url: null,\r\n        updated_at: new Date().toISOString(),\r\n      });\r\n\r\n      const items = [\r\n        createMockCartItem('item-1', 'prod-unavailable', 'Unavailable Product'),\r\n      ];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(0);\r\n      expect(removedNames).toHaveLength(1);\r\n      expect(removedNames[0]).toBe('Unavailable Product');\r\n    });\r\n\r\n    it('should keep combo items without validation (MVP)', async () => {\r\n      const comboItem: CartItem = {\r\n        id: 'combo-item-1',\r\n        type: 'combo',\r\n        combo: {\r\n          id: 'combo-1',\r\n          name: 'Breakfast Combo',\r\n        } as any,\r\n        quantity: 1,\r\n        unitPrice: 25000,\r\n        modifiers: [],\r\n        comboSelections: [],\r\n        modifiersTotal: 0,\r\n        notes: '',\r\n        totalPrice: 25000,\r\n      };\r\n\r\n      const { validItems, removedNames } = await validateAndFilterCartItems([\r\n        comboItem,\r\n      ]);\r\n\r\n      expect(validItems).toHaveLength(1);\r\n      expect(validItems[0].type).toBe('combo');\r\n      expect(removedNames).toHaveLength(0);\r\n    });\r\n\r\n    it('should preserve locked items that are valid', async () => {\r\n      // Add products to offline cache\r\n      await db.offline_products.bulkAdd([\r\n        {\r\n          id: 'prod-1',\r\n          name: 'Product 1',\r\n          sku: 'SKU-1',\r\n          retail_price: 10000,\r\n          category_id: 'cat-1',\r\n          product_type: 'finished',\r\n          is_active: true,\r\n          pos_visible: true,\r\n          available_for_sale: true,\r\n          wholesale_price: null,\r\n          cost_price: null,\r\n          current_stock: null,\r\n          image_url: null,\r\n          updated_at: new Date().toISOString(),\r\n        },\r\n        {\r\n          id: 'prod-2',\r\n          name: 'Product 2',\r\n          sku: 'SKU-2',\r\n          retail_price: 15000,\r\n          category_id: 'cat-1',\r\n          product_type: 'finished',\r\n          is_active: true,\r\n          pos_visible: true,\r\n          available_for_sale: true,\r\n          wholesale_price: null,\r\n          cost_price: null,\r\n          current_stock: null,\r\n          image_url: null,\r\n          updated_at: new Date().toISOString(),\r\n        },\r\n      ]);\r\n\r\n      const items = [\r\n        createMockCartItem('item-1', 'prod-1', 'Product 1'),\r\n        createMockCartItem('item-2', 'prod-2', 'Product 2'),\r\n      ];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(2);\r\n      expect(removedNames).toHaveLength(0);\r\n\r\n      // Verify IDs are preserved (for locked items filtering)\r\n      expect(validItems.map((i) => i.id)).toContain('item-1');\r\n      expect(validItems.map((i) => i.id)).toContain('item-2');\r\n    });\r\n\r\n    it('should filter mixed valid and invalid items', async () => {\r\n      // Only add one product\r\n      await db.offline_products.add({\r\n        id: 'prod-valid',\r\n        name: 'Valid Product',\r\n        sku: 'SKU-V',\r\n        retail_price: 10000,\r\n        category_id: 'cat-1',\r\n        product_type: 'finished',\r\n        is_active: true,\r\n        pos_visible: true,\r\n        available_for_sale: true,\r\n        wholesale_price: null,\r\n        cost_price: null,\r\n        current_stock: null,\r\n        image_url: null,\r\n        updated_at: new Date().toISOString(),\r\n      });\r\n\r\n      const items = [\r\n        createMockCartItem('item-1', 'prod-valid', 'Valid Product'),\r\n        createMockCartItem('item-2', 'prod-missing', 'Missing Product'),\r\n        createMockCartItem('item-3', 'prod-valid', 'Valid Product Again'),\r\n      ];\r\n\r\n      const { validItems, removedNames } =\r\n        await validateAndFilterCartItems(items);\r\n\r\n      expect(validItems).toHaveLength(2);\r\n      expect(removedNames).toHaveLength(1);\r\n      expect(removedNames[0]).toBe('Missing Product');\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\categoriesCacheService.test.ts","messages":[{"ruleId":"no-extra-boolean-cast","severity":2,"message":"Redundant Boolean call.","line":183,"column":37,"nodeType":"CallExpression","messageId":"unexpectedCall","endLine":183,"endColumn":63,"fix":{"range":[5373,5399],"text":"c.is_raw_material"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Categories Cache Service Tests (Story 2.2)\r\n *\r\n * Tests for offline categories caching functionality.\r\n */\r\n\r\nimport { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';\r\nimport 'fake-indexeddb/auto';\r\n\r\n// Mock Supabase BEFORE importing the service\r\nvi.mock('@/lib/supabase', () => ({\r\n  supabase: {\r\n    from: vi.fn(),\r\n  },\r\n}));\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport { db } from '@/lib/db';\r\nimport {\r\n  cacheAllCategories,\r\n  getCachedCategories,\r\n  getAllCachedCategories,\r\n  getCachedCategoryById,\r\n  getCachedCategoriesCount,\r\n  getLastCategoriesSyncAt,\r\n  getCategoriesSyncMeta,\r\n  shouldRefreshCategories,\r\n  shouldRefreshCategoriesHourly,\r\n  refreshCategoriesCacheIfNeeded,\r\n  clearCategoriesCache,\r\n} from '../categoriesCacheService';\r\nimport type { IOfflineCategory } from '@/types/offline';\r\n\r\n// Test data\r\nconst mockCategories: IOfflineCategory[] = [\r\n  {\r\n    id: 'cat-1',\r\n    name: 'Viennoiseries',\r\n    icon: 'croissant',\r\n    color: '#F5DEB3',\r\n    sort_order: 1,\r\n    dispatch_station: 'kitchen',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n  {\r\n    id: 'cat-2',\r\n    name: 'Boissons',\r\n    icon: 'coffee',\r\n    color: '#8B4513',\r\n    sort_order: 2,\r\n    dispatch_station: 'barista',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n  {\r\n    id: 'cat-3',\r\n    name: 'Matières Premières',\r\n    icon: 'wheat',\r\n    color: '#DAA520',\r\n    sort_order: 3,\r\n    dispatch_station: null,\r\n    is_active: true,\r\n    is_raw_material: true, // Should be filtered out\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n  {\r\n    id: 'cat-4',\r\n    name: 'Ancienne Catégorie',\r\n    icon: 'archive',\r\n    color: '#808080',\r\n    sort_order: 4,\r\n    dispatch_station: 'display',\r\n    is_active: false, // Should be filtered out\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n  {\r\n    id: 'cat-5',\r\n    name: 'Pâtisseries',\r\n    icon: 'cake',\r\n    color: '#FFB6C1',\r\n    sort_order: 0, // Lowest sort_order, should be first\r\n    dispatch_station: 'kitchen',\r\n    is_active: true,\r\n    is_raw_material: false,\r\n    updated_at: '2026-01-30T10:00:00Z',\r\n  },\r\n];\r\n\r\n// Helper to setup Supabase mock\r\nfunction setupSupabaseMock(data: IOfflineCategory[] | null, error: { message: string } | null = null) {\r\n  const mockSelect = vi.fn().mockResolvedValue({ data, error });\r\n  const mockFrom = vi.fn().mockReturnValue({ select: mockSelect });\r\n  vi.mocked(supabase.from).mockImplementation(mockFrom);\r\n  return { mockFrom, mockSelect };\r\n}\r\n\r\ndescribe('categoriesCacheService', () => {\r\n  beforeEach(async () => {\r\n    // Clear database before each test\r\n    await db.offline_categories.clear();\r\n    await db.offline_sync_meta.delete('categories');\r\n    vi.clearAllMocks();\r\n  });\r\n\r\n  afterEach(() => {\r\n    vi.restoreAllMocks();\r\n  });\r\n\r\n  describe('cacheAllCategories', () => {\r\n    it('should fetch categories from Supabase and store in Dexie', async () => {\r\n      setupSupabaseMock(mockCategories);\r\n\r\n      await cacheAllCategories();\r\n\r\n      const cached = await db.offline_categories.toArray();\r\n      expect(cached).toHaveLength(5);\r\n      expect(cached.map(c => c.id)).toEqual(expect.arrayContaining(['cat-1', 'cat-2', 'cat-3', 'cat-4', 'cat-5']));\r\n    });\r\n\r\n    it('should update sync metadata after caching', async () => {\r\n      setupSupabaseMock(mockCategories);\r\n\r\n      await cacheAllCategories();\r\n\r\n      const meta = await db.offline_sync_meta.get('categories');\r\n      expect(meta).toBeDefined();\r\n      expect(meta?.entity).toBe('categories');\r\n      expect(meta?.recordCount).toBe(5);\r\n      expect(meta?.lastSyncAt).toBeDefined();\r\n    });\r\n\r\n    it('should clear existing cache before adding new data', async () => {\r\n      // Pre-populate with old data\r\n      await db.offline_categories.add({\r\n        id: 'old-cat',\r\n        name: 'Old Category',\r\n        icon: null,\r\n        color: null,\r\n        sort_order: 99,\r\n        dispatch_station: null,\r\n        is_active: true,\r\n        is_raw_material: false,\r\n        updated_at: '2025-01-01T00:00:00Z',\r\n      });\r\n\r\n      setupSupabaseMock(mockCategories);\r\n\r\n      await cacheAllCategories();\r\n\r\n      const cached = await db.offline_categories.toArray();\r\n      expect(cached).toHaveLength(5);\r\n      expect(cached.find(c => c.id === 'old-cat')).toBeUndefined();\r\n    });\r\n\r\n    it('should throw error if Supabase query fails', async () => {\r\n      setupSupabaseMock(null, { message: 'Network error' });\r\n\r\n      await expect(cacheAllCategories()).rejects.toThrow('Failed to fetch categories: Network error');\r\n    });\r\n\r\n    it('should throw error if no data returned', async () => {\r\n      setupSupabaseMock(null);\r\n\r\n      await expect(cacheAllCategories()).rejects.toThrow('No data returned from categories query');\r\n    });\r\n  });\r\n\r\n  describe('getCachedCategories', () => {\r\n    beforeEach(async () => {\r\n      // Populate test data\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n    });\r\n\r\n    it('should return only active non-raw-material categories', async () => {\r\n      const categories = await getCachedCategories();\r\n\r\n      expect(categories).toHaveLength(3); // cat-1, cat-2, cat-5\r\n      expect(categories.every(c => Boolean(c.is_active))).toBe(true);\r\n      expect(categories.every(c => !Boolean(c.is_raw_material))).toBe(true);\r\n    });\r\n\r\n    it('should sort categories by sort_order', async () => {\r\n      const categories = await getCachedCategories();\r\n\r\n      expect(categories[0].id).toBe('cat-5'); // sort_order: 0\r\n      expect(categories[1].id).toBe('cat-1'); // sort_order: 1\r\n      expect(categories[2].id).toBe('cat-2'); // sort_order: 2\r\n    });\r\n\r\n    it('should return empty array if no categories', async () => {\r\n      await db.offline_categories.clear();\r\n\r\n      const categories = await getCachedCategories();\r\n\r\n      expect(categories).toEqual([]);\r\n    });\r\n  });\r\n\r\n  describe('getAllCachedCategories', () => {\r\n    beforeEach(async () => {\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n    });\r\n\r\n    it('should return all categories including inactive and raw materials', async () => {\r\n      const categories = await getAllCachedCategories();\r\n\r\n      expect(categories).toHaveLength(5);\r\n    });\r\n\r\n    it('should sort by sort_order', async () => {\r\n      const categories = await getAllCachedCategories();\r\n\r\n      expect(categories[0].sort_order).toBe(0);\r\n      expect(categories[1].sort_order).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe('getCachedCategoryById', () => {\r\n    beforeEach(async () => {\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n    });\r\n\r\n    it('should return category by ID', async () => {\r\n      const category = await getCachedCategoryById('cat-2');\r\n\r\n      expect(category).toBeDefined();\r\n      expect(category?.name).toBe('Boissons');\r\n      expect(category?.dispatch_station).toBe('barista');\r\n    });\r\n\r\n    it('should return undefined for non-existent ID', async () => {\r\n      const category = await getCachedCategoryById('non-existent');\r\n\r\n      expect(category).toBeUndefined();\r\n    });\r\n  });\r\n\r\n  describe('getCachedCategoriesCount', () => {\r\n    it('should return correct count', async () => {\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n\r\n      const count = await getCachedCategoriesCount();\r\n\r\n      expect(count).toBe(5);\r\n    });\r\n\r\n    it('should return 0 for empty cache', async () => {\r\n      const count = await getCachedCategoriesCount();\r\n\r\n      expect(count).toBe(0);\r\n    });\r\n  });\r\n\r\n  describe('getLastCategoriesSyncAt', () => {\r\n    it('should return last sync timestamp', async () => {\r\n      const syncTime = '2026-01-30T12:00:00Z';\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: syncTime,\r\n        recordCount: 5,\r\n      });\r\n\r\n      const lastSync = await getLastCategoriesSyncAt();\r\n\r\n      expect(lastSync).toBe(syncTime);\r\n    });\r\n\r\n    it('should return null if never synced', async () => {\r\n      const lastSync = await getLastCategoriesSyncAt();\r\n\r\n      expect(lastSync).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('getCategoriesSyncMeta', () => {\r\n    it('should return full sync metadata', async () => {\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: '2026-01-30T12:00:00Z',\r\n        recordCount: 10,\r\n      });\r\n\r\n      const meta = await getCategoriesSyncMeta();\r\n\r\n      expect(meta).toBeDefined();\r\n      expect(meta?.entity).toBe('categories');\r\n      expect(meta?.recordCount).toBe(10);\r\n    });\r\n\r\n    it('should return undefined if never synced', async () => {\r\n      const meta = await getCategoriesSyncMeta();\r\n\r\n      expect(meta).toBeUndefined();\r\n    });\r\n  });\r\n\r\n  describe('shouldRefreshCategories (24h TTL)', () => {\r\n    it('should return true if never synced', async () => {\r\n      const shouldRefresh = await shouldRefreshCategories();\r\n\r\n      expect(shouldRefresh).toBe(true);\r\n    });\r\n\r\n    it('should return true if cache is older than 24 hours', async () => {\r\n      const oldDate = new Date();\r\n      oldDate.setHours(oldDate.getHours() - 25);\r\n\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: oldDate.toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      const shouldRefresh = await shouldRefreshCategories();\r\n\r\n      expect(shouldRefresh).toBe(true);\r\n    });\r\n\r\n    it('should return false if cache is fresh', async () => {\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: new Date().toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      const shouldRefresh = await shouldRefreshCategories();\r\n\r\n      expect(shouldRefresh).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('shouldRefreshCategoriesHourly', () => {\r\n    it('should return true if never synced', async () => {\r\n      const shouldRefresh = await shouldRefreshCategoriesHourly();\r\n\r\n      expect(shouldRefresh).toBe(true);\r\n    });\r\n\r\n    it('should return true if cache is older than 1 hour', async () => {\r\n      const oldDate = new Date();\r\n      oldDate.setMinutes(oldDate.getMinutes() - 61);\r\n\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: oldDate.toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      const shouldRefresh = await shouldRefreshCategoriesHourly();\r\n\r\n      expect(shouldRefresh).toBe(true);\r\n    });\r\n\r\n    it('should return false if synced within the hour', async () => {\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: new Date().toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      const shouldRefresh = await shouldRefreshCategoriesHourly();\r\n\r\n      expect(shouldRefresh).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('refreshCategoriesCacheIfNeeded', () => {\r\n    it('should refresh if cache is stale', async () => {\r\n      setupSupabaseMock(mockCategories);\r\n\r\n      const refreshed = await refreshCategoriesCacheIfNeeded();\r\n\r\n      expect(refreshed).toBe(true);\r\n      const cached = await db.offline_categories.count();\r\n      expect(cached).toBe(5);\r\n    });\r\n\r\n    it('should not refresh if cache is fresh', async () => {\r\n      setupSupabaseMock(mockCategories);\r\n\r\n      // First sync\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: new Date().toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      const refreshed = await refreshCategoriesCacheIfNeeded();\r\n\r\n      expect(refreshed).toBe(false);\r\n    });\r\n\r\n    it('should refresh if force flag is true', async () => {\r\n      setupSupabaseMock(mockCategories);\r\n\r\n      // Fresh cache\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: new Date().toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      const refreshed = await refreshCategoriesCacheIfNeeded(true);\r\n\r\n      expect(refreshed).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('clearCategoriesCache', () => {\r\n    it('should clear all categories and sync meta', async () => {\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n      await db.offline_sync_meta.put({\r\n        entity: 'categories',\r\n        lastSyncAt: new Date().toISOString(),\r\n        recordCount: 5,\r\n      });\r\n\r\n      await clearCategoriesCache();\r\n\r\n      const count = await db.offline_categories.count();\r\n      const meta = await db.offline_sync_meta.get('categories');\r\n\r\n      expect(count).toBe(0);\r\n      expect(meta).toBeUndefined();\r\n    });\r\n  });\r\n\r\n  describe('dispatch_station preservation', () => {\r\n    it('should preserve dispatch_station values', async () => {\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n\r\n      const categories = await getAllCachedCategories();\r\n\r\n      const kitchen = categories.find(c => c.id === 'cat-1');\r\n      const barista = categories.find(c => c.id === 'cat-2');\r\n      const display = categories.find(c => c.id === 'cat-4');\r\n\r\n      expect(kitchen?.dispatch_station).toBe('kitchen');\r\n      expect(barista?.dispatch_station).toBe('barista');\r\n      expect(display?.dispatch_station).toBe('display');\r\n    });\r\n\r\n    it('should handle null dispatch_station', async () => {\r\n      await db.offline_categories.bulkAdd(mockCategories);\r\n\r\n      const category = await getCachedCategoryById('cat-3');\r\n\r\n      expect(category?.dispatch_station).toBeNull();\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\kitchenDispatchService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\modifiersCacheService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":203,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5211,5214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5211,5214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":223,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5827,5830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5827,5830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":240,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":240,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6292,6295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6292,6295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":259,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6866,6869],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6866,6869],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":290,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7845,7848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7845,7848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":702,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":702,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21523,21526],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21523,21526],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Tests for modifiersCacheService\r\n *\r\n * @see Story 2.3: Product Modifiers Offline Cache\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, vi, afterEach } from 'vitest';\r\nimport 'fake-indexeddb/auto';\r\nimport { db } from '@/lib/db';\r\nimport type { IOfflineModifier } from '@/types/offline';\r\n\r\n// Mock Supabase - must be before imports that use it\r\nvi.mock('@/lib/supabase', () => ({\r\n  supabase: {\r\n    from: vi.fn().mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockReturnThis(),\r\n      }),\r\n    }),\r\n  },\r\n}));\r\n\r\nimport {\r\n  cacheAllModifiers,\r\n  getCachedModifiersForProduct,\r\n  getCachedModifiersForCategory,\r\n  getCachedModifierById,\r\n  getCachedModifiersCount,\r\n  resolveOfflineModifiers,\r\n  groupOfflineModifiers,\r\n  getLastModifiersSyncAt,\r\n  getModifiersSyncMeta,\r\n  shouldRefreshModifiers,\r\n  shouldRefreshModifiersHourly,\r\n  refreshModifiersCacheIfNeeded,\r\n  clearModifiersCache,\r\n} from '../modifiersCacheService';\r\nimport { supabase } from '@/lib/supabase';\r\n\r\n// =====================================================\r\n// Test Data\r\n// =====================================================\r\n\r\nconst mockProductModifiers: Partial<IOfflineModifier>[] = [\r\n  {\r\n    id: 'mod-1',\r\n    product_id: 'product-1',\r\n    category_id: null,\r\n    group_name: 'Size',\r\n    group_type: 'single',\r\n    group_required: true,\r\n    group_sort_order: 0,\r\n    option_id: 'small',\r\n    option_label: 'Small',\r\n    option_icon: null,\r\n    price_adjustment: 0,\r\n    is_default: true,\r\n    option_sort_order: 0,\r\n    is_active: true,\r\n    created_at: '2024-01-01T00:00:00Z',\r\n  },\r\n  {\r\n    id: 'mod-2',\r\n    product_id: 'product-1',\r\n    category_id: null,\r\n    group_name: 'Size',\r\n    group_type: 'single',\r\n    group_required: true,\r\n    group_sort_order: 0,\r\n    option_id: 'large',\r\n    option_label: 'Large',\r\n    option_icon: null,\r\n    price_adjustment: 5000,\r\n    is_default: false,\r\n    option_sort_order: 1,\r\n    is_active: true,\r\n    created_at: '2024-01-01T00:00:00Z',\r\n  },\r\n];\r\n\r\nconst mockCategoryModifiers: Partial<IOfflineModifier>[] = [\r\n  {\r\n    id: 'mod-3',\r\n    product_id: null,\r\n    category_id: 'category-1',\r\n    group_name: 'Temperature',\r\n    group_type: 'single',\r\n    group_required: false,\r\n    group_sort_order: 1,\r\n    option_id: 'hot',\r\n    option_label: 'Hot',\r\n    option_icon: '🔥',\r\n    price_adjustment: 0,\r\n    is_default: true,\r\n    option_sort_order: 0,\r\n    is_active: true,\r\n    created_at: '2024-01-01T00:00:00Z',\r\n  },\r\n  {\r\n    id: 'mod-4',\r\n    product_id: null,\r\n    category_id: 'category-1',\r\n    group_name: 'Temperature',\r\n    group_type: 'single',\r\n    group_required: false,\r\n    group_sort_order: 1,\r\n    option_id: 'iced',\r\n    option_label: 'Iced',\r\n    option_icon: '❄️',\r\n    price_adjustment: 2000,\r\n    is_default: false,\r\n    option_sort_order: 1,\r\n    is_active: true,\r\n    created_at: '2024-01-01T00:00:00Z',\r\n  },\r\n];\r\n\r\nconst mockMultipleSelectModifiers: Partial<IOfflineModifier>[] = [\r\n  {\r\n    id: 'mod-5',\r\n    product_id: 'product-2',\r\n    category_id: null,\r\n    group_name: 'Extras',\r\n    group_type: 'multiple',\r\n    group_required: false,\r\n    group_sort_order: 2,\r\n    option_id: 'extra-shot',\r\n    option_label: 'Extra Shot',\r\n    option_icon: null,\r\n    price_adjustment: 3000,\r\n    is_default: false,\r\n    option_sort_order: 0,\r\n    is_active: true,\r\n    created_at: '2024-01-01T00:00:00Z',\r\n  },\r\n  {\r\n    id: 'mod-6',\r\n    product_id: 'product-2',\r\n    category_id: null,\r\n    group_name: 'Extras',\r\n    group_type: 'multiple',\r\n    group_required: false,\r\n    group_sort_order: 2,\r\n    option_id: 'whipped-cream',\r\n    option_label: 'Whipped Cream',\r\n    option_icon: null,\r\n    price_adjustment: 2000,\r\n    is_default: false,\r\n    option_sort_order: 1,\r\n    is_active: true,\r\n    created_at: '2024-01-01T00:00:00Z',\r\n  },\r\n];\r\n\r\nconst mockInactiveModifier: Partial<IOfflineModifier> = {\r\n  id: 'mod-inactive',\r\n  product_id: 'product-1',\r\n  category_id: null,\r\n  group_name: 'Deprecated',\r\n  group_type: 'single',\r\n  group_required: false,\r\n  group_sort_order: 99,\r\n  option_id: 'old',\r\n  option_label: 'Old Option',\r\n  option_icon: null,\r\n  price_adjustment: 0,\r\n  is_default: false,\r\n  option_sort_order: 0,\r\n  is_active: false,\r\n  created_at: '2024-01-01T00:00:00Z',\r\n};\r\n\r\n// =====================================================\r\n// Setup & Teardown\r\n// =====================================================\r\n\r\nbeforeEach(async () => {\r\n  // Clear database tables\r\n  await db.offline_modifiers.clear();\r\n  await db.offline_sync_meta.clear();\r\n\r\n  // Reset mocks\r\n  vi.clearAllMocks();\r\n});\r\n\r\nafterEach(() => {\r\n  vi.restoreAllMocks();\r\n});\r\n\r\n// =====================================================\r\n// Tests: cacheAllModifiers\r\n// =====================================================\r\n\r\ndescribe('cacheAllModifiers', () => {\r\n  it('should cache modifiers from Supabase', async () => {\r\n    const allModifiers = [...mockProductModifiers, ...mockCategoryModifiers];\r\n\r\n    // Mock Supabase response\r\n    vi.mocked(supabase.from).mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockResolvedValue({ data: allModifiers, error: null }),\r\n      }),\r\n    } as any);\r\n\r\n    await cacheAllModifiers();\r\n\r\n    const cached = await db.offline_modifiers.toArray();\r\n    expect(cached).toHaveLength(4);\r\n  });\r\n\r\n  it('should clear existing cache before inserting new data', async () => {\r\n    // Pre-populate with old data\r\n    await db.offline_modifiers.add(mockInactiveModifier as IOfflineModifier);\r\n\r\n    // Mock Supabase response with new data\r\n    vi.mocked(supabase.from).mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockResolvedValue({\r\n          data: [mockProductModifiers[0]],\r\n          error: null,\r\n        }),\r\n      }),\r\n    } as any);\r\n\r\n    await cacheAllModifiers();\r\n\r\n    const cached = await db.offline_modifiers.toArray();\r\n    expect(cached).toHaveLength(1);\r\n    expect(cached[0].id).toBe('mod-1');\r\n  });\r\n\r\n  it('should update sync metadata', async () => {\r\n    vi.mocked(supabase.from).mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockResolvedValue({\r\n          data: mockProductModifiers,\r\n          error: null,\r\n        }),\r\n      }),\r\n    } as any);\r\n\r\n    await cacheAllModifiers();\r\n\r\n    const meta = await db.offline_sync_meta.get('modifiers');\r\n    expect(meta).toBeDefined();\r\n    expect(meta?.entity).toBe('modifiers');\r\n    expect(meta?.recordCount).toBe(2);\r\n    expect(meta?.lastSyncAt).toBeDefined();\r\n  });\r\n\r\n  it('should throw error on Supabase failure', async () => {\r\n    vi.mocked(supabase.from).mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockResolvedValue({\r\n          data: null,\r\n          error: { message: 'Network error' },\r\n        }),\r\n      }),\r\n    } as any);\r\n\r\n    await expect(cacheAllModifiers()).rejects.toThrow();\r\n  });\r\n\r\n  it('should apply default values for nullable fields', async () => {\r\n    const modifierWithNulls = {\r\n      id: 'mod-null',\r\n      product_id: 'product-1',\r\n      category_id: null,\r\n      group_name: 'Test',\r\n      group_type: null, // should default to 'single'\r\n      group_required: null, // should default to false\r\n      group_sort_order: null, // should default to 0\r\n      option_id: 'test',\r\n      option_label: 'Test',\r\n      option_icon: null,\r\n      price_adjustment: null, // should default to 0\r\n      is_default: null, // should default to false\r\n      option_sort_order: null, // should default to 0\r\n      is_active: true,\r\n      created_at: null,\r\n    };\r\n\r\n    vi.mocked(supabase.from).mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockResolvedValue({\r\n          data: [modifierWithNulls],\r\n          error: null,\r\n        }),\r\n      }),\r\n    } as any);\r\n\r\n    await cacheAllModifiers();\r\n\r\n    const cached = await db.offline_modifiers.get('mod-null');\r\n    expect(cached?.group_type).toBe('single');\r\n    expect(cached?.group_required).toBe(false);\r\n    expect(cached?.group_sort_order).toBe(0);\r\n    expect(cached?.price_adjustment).toBe(0);\r\n    expect(cached?.is_default).toBe(false);\r\n    expect(cached?.option_sort_order).toBe(0);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: getCachedModifiersForProduct\r\n// =====================================================\r\n\r\ndescribe('getCachedModifiersForProduct', () => {\r\n  beforeEach(async () => {\r\n    await db.offline_modifiers.bulkAdd(\r\n      [...mockProductModifiers, ...mockCategoryModifiers] as IOfflineModifier[]\r\n    );\r\n  });\r\n\r\n  it('should return only modifiers for the specified product', async () => {\r\n    const modifiers = await getCachedModifiersForProduct('product-1');\r\n\r\n    expect(modifiers).toHaveLength(2);\r\n    expect(modifiers.every((m) => m.product_id === 'product-1')).toBe(true);\r\n  });\r\n\r\n  it('should return empty array for unknown product', async () => {\r\n    const modifiers = await getCachedModifiersForProduct('unknown-product');\r\n\r\n    expect(modifiers).toHaveLength(0);\r\n  });\r\n\r\n  it('should filter out inactive modifiers', async () => {\r\n    await db.offline_modifiers.add(mockInactiveModifier as IOfflineModifier);\r\n\r\n    const modifiers = await getCachedModifiersForProduct('product-1');\r\n\r\n    expect(modifiers.every((m) => Boolean(m.is_active))).toBe(true);\r\n    expect(modifiers.some((m) => m.id === 'mod-inactive')).toBe(false);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: getCachedModifiersForCategory\r\n// =====================================================\r\n\r\ndescribe('getCachedModifiersForCategory', () => {\r\n  beforeEach(async () => {\r\n    await db.offline_modifiers.bulkAdd(\r\n      [...mockProductModifiers, ...mockCategoryModifiers] as IOfflineModifier[]\r\n    );\r\n  });\r\n\r\n  it('should return only modifiers for the specified category', async () => {\r\n    const modifiers = await getCachedModifiersForCategory('category-1');\r\n\r\n    expect(modifiers).toHaveLength(2);\r\n    expect(modifiers.every((m) => m.category_id === 'category-1')).toBe(true);\r\n  });\r\n\r\n  it('should return empty array for unknown category', async () => {\r\n    const modifiers = await getCachedModifiersForCategory('unknown-category');\r\n\r\n    expect(modifiers).toHaveLength(0);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: getCachedModifierById\r\n// =====================================================\r\n\r\ndescribe('getCachedModifierById', () => {\r\n  beforeEach(async () => {\r\n    await db.offline_modifiers.bulkAdd(mockProductModifiers as IOfflineModifier[]);\r\n  });\r\n\r\n  it('should return modifier by ID', async () => {\r\n    const modifier = await getCachedModifierById('mod-1');\r\n\r\n    expect(modifier).toBeDefined();\r\n    expect(modifier?.id).toBe('mod-1');\r\n    expect(modifier?.option_label).toBe('Small');\r\n  });\r\n\r\n  it('should return undefined for unknown ID', async () => {\r\n    const modifier = await getCachedModifierById('unknown-id');\r\n\r\n    expect(modifier).toBeUndefined();\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: getCachedModifiersCount\r\n// =====================================================\r\n\r\ndescribe('getCachedModifiersCount', () => {\r\n  it('should return correct count', async () => {\r\n    await db.offline_modifiers.bulkAdd(mockProductModifiers as IOfflineModifier[]);\r\n\r\n    const count = await getCachedModifiersCount();\r\n\r\n    expect(count).toBe(2);\r\n  });\r\n\r\n  it('should return 0 for empty cache', async () => {\r\n    const count = await getCachedModifiersCount();\r\n\r\n    expect(count).toBe(0);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: groupOfflineModifiers\r\n// =====================================================\r\n\r\ndescribe('groupOfflineModifiers', () => {\r\n  it('should group modifiers by group_name', () => {\r\n    const groups = groupOfflineModifiers(mockProductModifiers as IOfflineModifier[]);\r\n\r\n    expect(groups).toHaveLength(1);\r\n    expect(groups[0].name).toBe('Size');\r\n    expect(groups[0].options).toHaveLength(2);\r\n  });\r\n\r\n  it('should sort options by option_sort_order', () => {\r\n    const groups = groupOfflineModifiers(mockProductModifiers as IOfflineModifier[]);\r\n\r\n    expect(groups[0].options[0].id).toBe('small');\r\n    expect(groups[0].options[1].id).toBe('large');\r\n  });\r\n\r\n  it('should preserve group properties', () => {\r\n    const groups = groupOfflineModifiers(mockProductModifiers as IOfflineModifier[]);\r\n\r\n    expect(groups[0].type).toBe('single');\r\n    expect(groups[0].required).toBe(true);\r\n    expect(groups[0].sortOrder).toBe(0);\r\n  });\r\n\r\n  it('should mark groups as inherited when specified', () => {\r\n    const groups = groupOfflineModifiers(mockCategoryModifiers as IOfflineModifier[], true);\r\n\r\n    expect(groups[0].isInherited).toBe(true);\r\n  });\r\n\r\n  it('should handle multiple groups', () => {\r\n    const allModifiers = [\r\n      ...mockProductModifiers,\r\n      ...mockMultipleSelectModifiers,\r\n    ] as IOfflineModifier[];\r\n\r\n    const groups = groupOfflineModifiers(allModifiers);\r\n\r\n    expect(groups.length).toBeGreaterThanOrEqual(2);\r\n  });\r\n\r\n  it('should preserve price adjustment in options', () => {\r\n    const groups = groupOfflineModifiers(mockProductModifiers as IOfflineModifier[]);\r\n\r\n    const largeOption = groups[0].options.find((o) => o.id === 'large');\r\n    expect(largeOption?.priceAdjustment).toBe(5000);\r\n  });\r\n\r\n  it('should handle multiple-select groups', () => {\r\n    const groups = groupOfflineModifiers(mockMultipleSelectModifiers as IOfflineModifier[]);\r\n\r\n    expect(groups[0].type).toBe('multiple');\r\n    expect(groups[0].options).toHaveLength(2);\r\n  });\r\n\r\n  it('should filter out inactive modifiers', () => {\r\n    const modifiersWithInactive = [\r\n      ...mockProductModifiers,\r\n      mockInactiveModifier,\r\n    ] as IOfflineModifier[];\r\n\r\n    const groups = groupOfflineModifiers(modifiersWithInactive);\r\n\r\n    // Should not include the 'Deprecated' group from inactive modifier\r\n    expect(groups.every((g) => g.name !== 'Deprecated')).toBe(true);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: resolveOfflineModifiers\r\n// =====================================================\r\n\r\ndescribe('resolveOfflineModifiers', () => {\r\n  beforeEach(async () => {\r\n    await db.offline_modifiers.bulkAdd([\r\n      ...mockProductModifiers,\r\n      ...mockCategoryModifiers,\r\n    ] as IOfflineModifier[]);\r\n  });\r\n\r\n  it('should return product modifiers when available', async () => {\r\n    const groups = await resolveOfflineModifiers('product-1', 'category-1');\r\n\r\n    const productGroup = groups.find((g) => g.name === 'Size');\r\n    expect(productGroup).toBeDefined();\r\n    expect(productGroup?.isInherited).toBeFalsy();\r\n  });\r\n\r\n  it('should inherit category modifiers when product has none', async () => {\r\n    const groups = await resolveOfflineModifiers('product-1', 'category-1');\r\n\r\n    const categoryGroup = groups.find((g) => g.name === 'Temperature');\r\n    expect(categoryGroup).toBeDefined();\r\n    expect(categoryGroup?.isInherited).toBe(true);\r\n  });\r\n\r\n  it('should prioritize product groups over category groups with same name', async () => {\r\n    // Add a category modifier with same group name as product\r\n    const conflictingCategoryModifier: IOfflineModifier = {\r\n      id: 'mod-conflict',\r\n      product_id: null,\r\n      category_id: 'category-1',\r\n      group_name: 'Size', // Same as product modifier\r\n      group_type: 'single',\r\n      group_required: false, // Different from product\r\n      group_sort_order: 0,\r\n      option_id: 'category-size',\r\n      option_label: 'Category Size',\r\n      option_icon: null,\r\n      price_adjustment: 9999,\r\n      is_default: false,\r\n      option_sort_order: 0,\r\n      is_active: true,\r\n      created_at: '2024-01-01T00:00:00Z',\r\n    };\r\n    await db.offline_modifiers.add(conflictingCategoryModifier);\r\n\r\n    const groups = await resolveOfflineModifiers('product-1', 'category-1');\r\n\r\n    // Size group should come from product, not category\r\n    const sizeGroup = groups.find((g) => g.name === 'Size');\r\n    expect(sizeGroup?.required).toBe(true); // Product has required: true\r\n    expect(sizeGroup?.isInherited).toBeFalsy();\r\n    expect(sizeGroup?.options.every((o) => o.id !== 'category-size')).toBe(true);\r\n  });\r\n\r\n  it('should sort groups by sortOrder', async () => {\r\n    const groups = await resolveOfflineModifiers('product-1', 'category-1');\r\n\r\n    // Size (sortOrder: 0) should come before Temperature (sortOrder: 1)\r\n    const sizeIndex = groups.findIndex((g) => g.name === 'Size');\r\n    const tempIndex = groups.findIndex((g) => g.name === 'Temperature');\r\n    expect(sizeIndex).toBeLessThan(tempIndex);\r\n  });\r\n\r\n  it('should return empty array when no product or category specified', async () => {\r\n    const groups = await resolveOfflineModifiers(undefined, undefined);\r\n\r\n    expect(groups).toHaveLength(0);\r\n  });\r\n\r\n  it('should return only category modifiers when product has none', async () => {\r\n    const groups = await resolveOfflineModifiers('unknown-product', 'category-1');\r\n\r\n    expect(groups).toHaveLength(1);\r\n    expect(groups[0].name).toBe('Temperature');\r\n    expect(groups[0].isInherited).toBe(true);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: Sync Metadata\r\n// =====================================================\r\n\r\ndescribe('getLastModifiersSyncAt', () => {\r\n  it('should return null when no sync has occurred', async () => {\r\n    const timestamp = await getLastModifiersSyncAt();\r\n\r\n    expect(timestamp).toBeNull();\r\n  });\r\n\r\n  it('should return timestamp after sync', async () => {\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: '2024-01-15T10:00:00Z',\r\n      recordCount: 10,\r\n    });\r\n\r\n    const timestamp = await getLastModifiersSyncAt();\r\n\r\n    expect(timestamp).toBe('2024-01-15T10:00:00Z');\r\n  });\r\n});\r\n\r\ndescribe('getModifiersSyncMeta', () => {\r\n  it('should return null when no sync has occurred', async () => {\r\n    const meta = await getModifiersSyncMeta();\r\n\r\n    expect(meta).toBeNull();\r\n  });\r\n\r\n  it('should return full metadata after sync', async () => {\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: '2024-01-15T10:00:00Z',\r\n      recordCount: 25,\r\n    });\r\n\r\n    const meta = await getModifiersSyncMeta();\r\n\r\n    expect(meta).toEqual({\r\n      entity: 'modifiers',\r\n      lastSyncAt: '2024-01-15T10:00:00Z',\r\n      recordCount: 25,\r\n    });\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: Cache Freshness\r\n// =====================================================\r\n\r\ndescribe('shouldRefreshModifiers', () => {\r\n  it('should return true when no cache exists', async () => {\r\n    const shouldRefresh = await shouldRefreshModifiers();\r\n\r\n    expect(shouldRefresh).toBe(true);\r\n  });\r\n\r\n  it('should return true when cache is older than 24 hours', async () => {\r\n    const oldDate = new Date(Date.now() - 25 * 60 * 60 * 1000);\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: oldDate.toISOString(),\r\n      recordCount: 10,\r\n    });\r\n\r\n    const shouldRefresh = await shouldRefreshModifiers();\r\n\r\n    expect(shouldRefresh).toBe(true);\r\n  });\r\n\r\n  it('should return false when cache is fresh', async () => {\r\n    const recentDate = new Date(Date.now() - 1 * 60 * 60 * 1000); // 1 hour ago\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: recentDate.toISOString(),\r\n      recordCount: 10,\r\n    });\r\n\r\n    const shouldRefresh = await shouldRefreshModifiers();\r\n\r\n    expect(shouldRefresh).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe('shouldRefreshModifiersHourly', () => {\r\n  it('should return true when no cache exists', async () => {\r\n    const shouldRefresh = await shouldRefreshModifiersHourly();\r\n\r\n    expect(shouldRefresh).toBe(true);\r\n  });\r\n\r\n  it('should return true when cache is older than 1 hour', async () => {\r\n    const oldDate = new Date(Date.now() - 2 * 60 * 60 * 1000);\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: oldDate.toISOString(),\r\n      recordCount: 10,\r\n    });\r\n\r\n    const shouldRefresh = await shouldRefreshModifiersHourly();\r\n\r\n    expect(shouldRefresh).toBe(true);\r\n  });\r\n\r\n  it('should return false when cache is less than 1 hour old', async () => {\r\n    const recentDate = new Date(Date.now() - 30 * 60 * 1000); // 30 minutes ago\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: recentDate.toISOString(),\r\n      recordCount: 10,\r\n    });\r\n\r\n    const shouldRefresh = await shouldRefreshModifiersHourly();\r\n\r\n    expect(shouldRefresh).toBe(false);\r\n  });\r\n});\r\n\r\n// =====================================================\r\n// Tests: Cache Management\r\n// =====================================================\r\n\r\ndescribe('refreshModifiersCacheIfNeeded', () => {\r\n  it('should refresh when force is true', async () => {\r\n    // Setup fresh cache\r\n    const recentDate = new Date(Date.now() - 30 * 60 * 1000);\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: recentDate.toISOString(),\r\n      recordCount: 10,\r\n    });\r\n\r\n    vi.mocked(supabase.from).mockReturnValue({\r\n      select: vi.fn().mockReturnValue({\r\n        eq: vi.fn().mockResolvedValue({\r\n          data: mockProductModifiers,\r\n          error: null,\r\n        }),\r\n      }),\r\n    } as any);\r\n\r\n    const refreshed = await refreshModifiersCacheIfNeeded(true);\r\n\r\n    expect(refreshed).toBe(true);\r\n  });\r\n\r\n  it('should not refresh when cache is fresh', async () => {\r\n    const recentDate = new Date(Date.now() - 1 * 60 * 60 * 1000);\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: recentDate.toISOString(),\r\n      recordCount: 10,\r\n    });\r\n\r\n    const refreshed = await refreshModifiersCacheIfNeeded();\r\n\r\n    expect(refreshed).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe('clearModifiersCache', () => {\r\n  it('should clear all cached modifiers', async () => {\r\n    await db.offline_modifiers.bulkAdd(mockProductModifiers as IOfflineModifier[]);\r\n    await db.offline_sync_meta.put({\r\n      entity: 'modifiers',\r\n      lastSyncAt: new Date().toISOString(),\r\n      recordCount: 2,\r\n    });\r\n\r\n    await clearModifiersCache();\r\n\r\n    const count = await db.offline_modifiers.count();\r\n    const meta = await db.offline_sync_meta.get('modifiers');\r\n\r\n    expect(count).toBe(0);\r\n    expect(meta).toBeUndefined();\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\offlineAuthService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\offlineOrderService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_items' is assigned a value but never used.","line":270,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":270,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Tests for Offline Order Service (Story 3.3)\r\n *\r\n * Tests cart-to-order conversion, tax calculation,\r\n * and integration with ordersCacheService.\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, afterEach } from 'vitest';\r\nimport 'fake-indexeddb/auto';\r\nimport { db } from '@/lib/db';\r\nimport {\r\n  createOfflineOrder,\r\n  convertCartItemToOrderItem,\r\n  calculateTaxAmount,\r\n  type ICartStateForOrder,\r\n} from '../offlineOrderService';\r\nimport type { CartItem, CartModifier } from '@/stores/cartStore';\r\nimport type { Product } from '@/types/database';\r\n\r\n// =====================================================\r\n// Test Fixtures\r\n// =====================================================\r\n\r\nconst mockProduct = {\r\n  id: 'prod-001',\r\n  name: 'Croissant',\r\n  sku: 'CRO-001',\r\n  category_id: 'cat-001',\r\n  retail_price: 25000,\r\n  wholesale_price: 20000,\r\n  cost_price: 10000,\r\n  product_type: 'finished',\r\n  is_active: true,\r\n  pos_visible: true,\r\n  available_for_sale: true,\r\n  image_url: null,\r\n  description: null,\r\n  unit: 'pcs',\r\n  min_stock_level: null,\r\n  current_stock: 100,\r\n  deduct_ingredients: null,\r\n  is_made_to_order: null,\r\n  deleted_at: null,\r\n  created_at: '2026-01-01T00:00:00Z',\r\n  updated_at: '2026-01-01T00:00:00Z',\r\n} as unknown as Product;\r\n\r\nconst mockModifiers: CartModifier[] = [\r\n  {\r\n    groupName: 'Size',\r\n    optionId: 'opt-large',\r\n    optionLabel: 'Large',\r\n    priceAdjustment: 5000,\r\n  },\r\n];\r\n\r\nconst mockCartItem: CartItem = {\r\n  id: 'cart-item-001',\r\n  type: 'product',\r\n  product: mockProduct,\r\n  quantity: 2,\r\n  unitPrice: 25000,\r\n  modifiers: mockModifiers,\r\n  modifiersTotal: 5000,\r\n  notes: 'Extra butter',\r\n  totalPrice: 60000, // (25000 + 5000) * 2\r\n};\r\n\r\nconst mockComboCartItem: CartItem = {\r\n  id: 'cart-item-002',\r\n  type: 'combo',\r\n  combo: {\r\n    id: 'combo-001',\r\n    name: 'Breakfast Deal',\r\n    description: 'Croissant + Coffee',\r\n    combo_price: 35000,\r\n    is_active: true,\r\n    available_at_pos: true,\r\n    image_url: null,\r\n    sort_order: null,\r\n    created_at: '2026-01-01T00:00:00Z',\r\n    updated_at: '2026-01-01T00:00:00Z',\r\n  },\r\n  quantity: 1,\r\n  unitPrice: 35000,\r\n  modifiers: [],\r\n  comboSelections: [\r\n    {\r\n      group_id: 'group-001',\r\n      group_name: 'Drink',\r\n      item_id: 'item-001',\r\n      product_id: 'prod-coffee',\r\n      product_name: 'Americano',\r\n      price_adjustment: 0,\r\n    },\r\n  ],\r\n  modifiersTotal: 0,\r\n  notes: '',\r\n  totalPrice: 35000,\r\n};\r\n\r\nconst mockCategory = {\r\n  id: 'cat-001',\r\n  name: 'Pastries',\r\n  icon: 'croissant',\r\n  color: '#f5a623',\r\n  sort_order: 1,\r\n  dispatch_station: 'kitchen' as const,\r\n  is_active: true,\r\n  is_raw_material: false,\r\n  updated_at: '2026-01-01T00:00:00Z',\r\n};\r\n\r\nconst mockCartState: ICartStateForOrder = {\r\n  items: [mockCartItem],\r\n  orderType: 'dine_in',\r\n  tableNumber: 'T-05',\r\n  customerId: 'cust-001',\r\n  discountType: 'percent',\r\n  discountValue: 10,\r\n  discountReason: 'Regular customer',\r\n  subtotal: 60000,\r\n  discountAmount: 6000,\r\n  total: 54000,\r\n};\r\n\r\n// =====================================================\r\n// Test Setup\r\n// =====================================================\r\n\r\ndescribe('offlineOrderService', () => {\r\n  beforeEach(async () => {\r\n    // Clear all tables before each test\r\n    await db.offline_orders.clear();\r\n    await db.offline_order_items.clear();\r\n    await db.offline_sync_queue.clear();\r\n    await db.offline_categories.clear();\r\n\r\n    // Add mock category for dispatch station lookup\r\n    await db.offline_categories.add(mockCategory);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    // Clean up\r\n    await db.offline_orders.clear();\r\n    await db.offline_order_items.clear();\r\n    await db.offline_sync_queue.clear();\r\n    await db.offline_categories.clear();\r\n  });\r\n\r\n  // =====================================================\r\n  // calculateTaxAmount Tests\r\n  // =====================================================\r\n\r\n  describe('calculateTaxAmount', () => {\r\n    it('calculates 10% tax from total (included, not added)', () => {\r\n      // Tax is included in price: total × 10/110\r\n      expect(calculateTaxAmount(110000)).toBe(10000);\r\n      expect(calculateTaxAmount(55000)).toBe(5000);\r\n      expect(calculateTaxAmount(220000)).toBe(20000);\r\n    });\r\n\r\n    it('rounds to nearest IDR', () => {\r\n      // 54000 × 10/110 = 4909.09... → 4909\r\n      expect(calculateTaxAmount(54000)).toBe(4909);\r\n      // 12345 × 10/110 = 1122.27... → 1122\r\n      expect(calculateTaxAmount(12345)).toBe(1122);\r\n    });\r\n\r\n    it('handles zero total', () => {\r\n      expect(calculateTaxAmount(0)).toBe(0);\r\n    });\r\n  });\r\n\r\n  // =====================================================\r\n  // convertCartItemToOrderItem Tests\r\n  // =====================================================\r\n\r\n  describe('convertCartItemToOrderItem', () => {\r\n    it('converts product item with modifiers', async () => {\r\n      const result = await convertCartItemToOrderItem(mockCartItem);\r\n\r\n      expect(result.product_id).toBe('prod-001');\r\n      expect(result.product_name).toBe('Croissant');\r\n      expect(result.product_sku).toBe('CRO-001');\r\n      expect(result.quantity).toBe(2);\r\n      expect(result.unit_price).toBe(25000);\r\n      expect(result.subtotal).toBe(60000);\r\n      expect(result.notes).toBe('Extra butter');\r\n      expect(result.item_status).toBe('new');\r\n    });\r\n\r\n    it('maps modifiers correctly', async () => {\r\n      const result = await convertCartItemToOrderItem(mockCartItem);\r\n\r\n      expect(result.modifiers).toHaveLength(1);\r\n      expect(result.modifiers[0]).toEqual({\r\n        option_id: 'opt-large',\r\n        group_name: 'Size',\r\n        option_label: 'Large',\r\n        price_adjustment: 5000,\r\n      });\r\n    });\r\n\r\n    it('resolves dispatch station from category', async () => {\r\n      const result = await convertCartItemToOrderItem(mockCartItem);\r\n\r\n      expect(result.dispatch_station).toBe('kitchen');\r\n    });\r\n\r\n    it('handles product without category', async () => {\r\n      const itemWithoutCategory: CartItem = {\r\n        ...mockCartItem,\r\n        product: { ...mockProduct, category_id: null },\r\n      };\r\n\r\n      const result = await convertCartItemToOrderItem(itemWithoutCategory);\r\n\r\n      expect(result.dispatch_station).toBeNull();\r\n    });\r\n\r\n    it('converts combo item with selections', async () => {\r\n      const result = await convertCartItemToOrderItem(mockComboCartItem);\r\n\r\n      expect(result.product_id).toBe('combo-001');\r\n      expect(result.product_name).toBe('Breakfast Deal');\r\n      expect(result.product_sku).toBeNull();\r\n      expect(result.quantity).toBe(1);\r\n      expect(result.subtotal).toBe(35000);\r\n      expect(result.dispatch_station).toBeNull(); // Combos have null dispatch\r\n    });\r\n\r\n    it('maps combo selections as modifiers', async () => {\r\n      const result = await convertCartItemToOrderItem(mockComboCartItem);\r\n\r\n      expect(result.modifiers).toHaveLength(1);\r\n      expect(result.modifiers[0]).toEqual({\r\n        option_id: 'item-001',\r\n        group_name: 'Drink',\r\n        option_label: 'Americano',\r\n        price_adjustment: 0,\r\n      });\r\n    });\r\n\r\n    it('throws for invalid cart item', async () => {\r\n      const invalidItem: CartItem = {\r\n        id: 'invalid',\r\n        type: 'product',\r\n        product: undefined,\r\n        quantity: 1,\r\n        unitPrice: 0,\r\n        modifiers: [],\r\n        modifiersTotal: 0,\r\n        notes: '',\r\n        totalPrice: 0,\r\n      };\r\n\r\n      await expect(convertCartItemToOrderItem(invalidItem)).rejects.toThrow(\r\n        'Invalid cart item: must have product or combo'\r\n      );\r\n    });\r\n  });\r\n\r\n  // =====================================================\r\n  // createOfflineOrder Tests\r\n  // =====================================================\r\n\r\n  describe('createOfflineOrder', () => {\r\n    it('creates order with correct structure', async () => {\r\n      const { order, items: _items } = await createOfflineOrder(\r\n        mockCartState,\r\n        'user-001',\r\n        'session-001'\r\n      );\r\n\r\n      // Order structure\r\n      expect(order.id).toMatch(/^LOCAL-/);\r\n      expect(order.order_number).toMatch(/^OFFLINE-\\d{8}-\\d{3}$/);\r\n      expect(order.status).toBe('new');\r\n      expect(order.order_type).toBe('dine_in');\r\n      expect(order.sync_status).toBe('pending_sync');\r\n      expect(order.user_id).toBe('user-001');\r\n      expect(order.session_id).toBe('session-001');\r\n    });\r\n\r\n    it('calculates tax correctly (10% included)', async () => {\r\n      const { order } = await createOfflineOrder(\r\n        mockCartState,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      // Total is 54000, tax = 54000 × 10/110 = 4909\r\n      expect(order.tax_amount).toBe(4909);\r\n      expect(order.total).toBe(54000);\r\n    });\r\n\r\n    it('preserves customer_id and table_number', async () => {\r\n      const { order } = await createOfflineOrder(\r\n        mockCartState,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.customer_id).toBe('cust-001');\r\n      expect(order.table_number).toBe('T-05');\r\n    });\r\n\r\n    it('maps discount type correctly', async () => {\r\n      const { order } = await createOfflineOrder(\r\n        mockCartState,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      // Cart uses 'percent', order uses 'percentage'\r\n      expect(order.discount_type).toBe('percentage');\r\n      expect(order.discount_value).toBe(10);\r\n      expect(order.discount_amount).toBe(6000);\r\n    });\r\n\r\n    it('stores discount reason as notes', async () => {\r\n      const { order } = await createOfflineOrder(\r\n        mockCartState,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.notes).toBe('Regular customer');\r\n    });\r\n\r\n    it('converts all cart items to order items', async () => {\r\n      const cartWithMultipleItems: ICartStateForOrder = {\r\n        ...mockCartState,\r\n        items: [mockCartItem, mockComboCartItem],\r\n        total: 89000,\r\n      };\r\n\r\n      const { items } = await createOfflineOrder(\r\n        cartWithMultipleItems,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(items).toHaveLength(2);\r\n      expect(items[0].product_name).toBe('Croissant');\r\n      expect(items[1].product_name).toBe('Breakfast Deal');\r\n    });\r\n\r\n    it('adds entry to sync queue', async () => {\r\n      await createOfflineOrder(mockCartState, 'user-001', null);\r\n\r\n      const syncItems = await db.offline_sync_queue.toArray();\r\n      expect(syncItems).toHaveLength(1);\r\n      expect(syncItems[0].entity).toBe('orders');\r\n      expect(syncItems[0].action).toBe('create');\r\n      expect(syncItems[0].status).toBe('pending');\r\n    });\r\n\r\n    it('throws for empty cart', async () => {\r\n      const emptyCart: ICartStateForOrder = {\r\n        ...mockCartState,\r\n        items: [],\r\n      };\r\n\r\n      await expect(createOfflineOrder(emptyCart, 'user-001', null)).rejects.toThrow(\r\n        'Cannot create order with empty cart'\r\n      );\r\n    });\r\n\r\n    it('throws for missing user_id', async () => {\r\n      await expect(createOfflineOrder(mockCartState, '', null)).rejects.toThrow(\r\n        'User ID is required to create an order'\r\n      );\r\n    });\r\n\r\n    it('handles null session_id', async () => {\r\n      const { order } = await createOfflineOrder(\r\n        mockCartState,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.session_id).toBeNull();\r\n    });\r\n\r\n    it('handles null customer_id', async () => {\r\n      const cartWithoutCustomer: ICartStateForOrder = {\r\n        ...mockCartState,\r\n        customerId: null,\r\n      };\r\n\r\n      const { order } = await createOfflineOrder(\r\n        cartWithoutCustomer,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.customer_id).toBeNull();\r\n    });\r\n\r\n    it('handles null table_number', async () => {\r\n      const takeawayCart: ICartStateForOrder = {\r\n        ...mockCartState,\r\n        orderType: 'takeaway',\r\n        tableNumber: null,\r\n      };\r\n\r\n      const { order } = await createOfflineOrder(\r\n        takeawayCart,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.order_type).toBe('takeaway');\r\n      expect(order.table_number).toBeNull();\r\n    });\r\n\r\n    it('handles amount discount type', async () => {\r\n      const cartWithAmountDiscount: ICartStateForOrder = {\r\n        ...mockCartState,\r\n        discountType: 'amount',\r\n        discountValue: 5000,\r\n        discountAmount: 5000,\r\n      };\r\n\r\n      const { order } = await createOfflineOrder(\r\n        cartWithAmountDiscount,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.discount_type).toBe('amount');\r\n      expect(order.discount_value).toBe(5000);\r\n    });\r\n\r\n    it('handles null discount type', async () => {\r\n      const cartWithoutDiscount: ICartStateForOrder = {\r\n        ...mockCartState,\r\n        discountType: null,\r\n        discountValue: 0,\r\n        discountAmount: 0,\r\n      };\r\n\r\n      const { order } = await createOfflineOrder(\r\n        cartWithoutDiscount,\r\n        'user-001',\r\n        null\r\n      );\r\n\r\n      expect(order.discount_type).toBeNull();\r\n      expect(order.discount_value).toBeNull();\r\n      expect(order.discount_amount).toBe(0);\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\offlinePaymentService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\offlineSessionService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\ordersCacheService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\productionReminderService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\productsCacheInit.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\productsCacheService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\rateLimitService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\recipesCacheService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\__tests__\\settingsCacheService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\cartPersistenceService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\categoriesCacheService.ts","messages":[{"ruleId":"no-extra-boolean-cast","severity":2,"message":"Redundant Boolean call.","line":68,"column":45,"nodeType":"CallExpression","messageId":"unexpectedCall","endLine":68,"endColumn":71,"fix":{"range":[2181,2207],"text":"c.is_raw_material"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Categories Cache Service (Story 2.2)\r\n *\r\n * Provides offline caching functionality for product categories.\r\n * Categories are cached at startup and refreshed hourly when online.\r\n *\r\n * @see ADR-001: Entités Synchronisées Offline\r\n * @see ADR-003: Politique de Cache\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport { db } from '@/lib/db';\r\nimport type { IOfflineCategory, ISyncMeta } from '@/types/offline';\r\nimport {\r\n  CATEGORIES_CACHE_TTL_MS,\r\n  CATEGORIES_REFRESH_INTERVAL_MS,\r\n} from '@/types/offline';\r\n\r\n/**\r\n * Cache all categories from Supabase to Dexie\r\n *\r\n * Fetches all categories (including inactive) for offline access.\r\n * Active/raw_material filtering is done at read time.\r\n *\r\n * @throws Error if Supabase query fails\r\n */\r\nexport async function cacheAllCategories(): Promise<void> {\r\n  const { data, error } = await supabase\r\n    .from('categories')\r\n    .select('id, name, icon, color, sort_order, dispatch_station, is_active, is_raw_material, updated_at');\r\n\r\n  if (error) {\r\n    throw new Error(`Failed to fetch categories: ${error.message}`);\r\n  }\r\n\r\n  if (!data) {\r\n    throw new Error('No data returned from categories query');\r\n  }\r\n\r\n  // Clear existing cache and add new data\r\n  await db.offline_categories.clear();\r\n  await db.offline_categories.bulkAdd(data as IOfflineCategory[]);\r\n\r\n  // Update sync metadata\r\n  await db.offline_sync_meta.put({\r\n    entity: 'categories',\r\n    lastSyncAt: new Date().toISOString(),\r\n    recordCount: data.length,\r\n  });\r\n\r\n  console.log(`[CategoriesCache] Cached ${data.length} categories`);\r\n}\r\n\r\n/**\r\n * Get all cached categories filtered for POS display\r\n *\r\n * Returns only active, non-raw-material categories sorted by sort_order.\r\n * This matches the behavior of the online useCategories hook.\r\n *\r\n * @returns Array of categories filtered and sorted\r\n */\r\nexport async function getCachedCategories(): Promise<IOfflineCategory[]> {\r\n  const categories = await db.offline_categories.toArray();\r\n\r\n  // Filter: is_active = true AND is_raw_material = false\r\n  // Note: Dexie stores booleans as 0/1, use Boolean() for coercion\r\n  return categories\r\n    .filter((c) => Boolean(c.is_active) && !Boolean(c.is_raw_material))\r\n    .sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0));\r\n}\r\n\r\n/**\r\n * Get all cached categories without filtering\r\n *\r\n * Returns all categories in cache, including inactive and raw materials.\r\n * Sorted by sort_order.\r\n *\r\n * @returns Array of all cached categories\r\n */\r\nexport async function getAllCachedCategories(): Promise<IOfflineCategory[]> {\r\n  const categories = await db.offline_categories.toArray();\r\n  return categories.sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0));\r\n}\r\n\r\n/**\r\n * Get a single cached category by ID\r\n *\r\n * @param id - Category UUID\r\n * @returns Category if found, undefined otherwise\r\n */\r\nexport async function getCachedCategoryById(\r\n  id: string\r\n): Promise<IOfflineCategory | undefined> {\r\n  return db.offline_categories.get(id);\r\n}\r\n\r\n/**\r\n * Get cached categories count\r\n *\r\n * @returns Total number of categories in cache\r\n */\r\nexport async function getCachedCategoriesCount(): Promise<number> {\r\n  return db.offline_categories.count();\r\n}\r\n\r\n/**\r\n * Get timestamp of last categories sync\r\n *\r\n * @returns ISO 8601 timestamp or null if never synced\r\n */\r\nexport async function getLastCategoriesSyncAt(): Promise<string | null> {\r\n  const meta = await db.offline_sync_meta.get('categories');\r\n  return meta?.lastSyncAt ?? null;\r\n}\r\n\r\n/**\r\n * Get full sync metadata for categories\r\n *\r\n * @returns Sync metadata or undefined if never synced\r\n */\r\nexport async function getCategoriesSyncMeta(): Promise<ISyncMeta | undefined> {\r\n  return db.offline_sync_meta.get('categories');\r\n}\r\n\r\n/**\r\n * Check if categories cache needs refresh (24h TTL)\r\n *\r\n * @returns true if cache is stale or doesn't exist\r\n */\r\nexport async function shouldRefreshCategories(): Promise<boolean> {\r\n  const meta = await db.offline_sync_meta.get('categories');\r\n\r\n  if (!meta) {\r\n    return true; // Never synced\r\n  }\r\n\r\n  const lastSync = new Date(meta.lastSyncAt);\r\n  const now = new Date();\r\n  const elapsed = now.getTime() - lastSync.getTime();\r\n\r\n  return elapsed >= CATEGORIES_CACHE_TTL_MS;\r\n}\r\n\r\n/**\r\n * Check if categories cache needs hourly refresh\r\n *\r\n * @returns true if more than 1 hour since last sync\r\n */\r\nexport async function shouldRefreshCategoriesHourly(): Promise<boolean> {\r\n  const meta = await db.offline_sync_meta.get('categories');\r\n\r\n  if (!meta) {\r\n    return true; // Never synced\r\n  }\r\n\r\n  const lastSync = new Date(meta.lastSyncAt);\r\n  const now = new Date();\r\n  const elapsed = now.getTime() - lastSync.getTime();\r\n\r\n  return elapsed >= CATEGORIES_REFRESH_INTERVAL_MS;\r\n}\r\n\r\n/**\r\n * Refresh categories cache if needed\r\n *\r\n * @param force - Force refresh even if cache is fresh\r\n * @returns true if cache was refreshed\r\n */\r\nexport async function refreshCategoriesCacheIfNeeded(\r\n  force = false\r\n): Promise<boolean> {\r\n  const needsRefresh = force || (await shouldRefreshCategories());\r\n\r\n  if (needsRefresh) {\r\n    await cacheAllCategories();\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Clear categories cache\r\n *\r\n * Removes all categories from IndexedDB and clears sync metadata.\r\n */\r\nexport async function clearCategoriesCache(): Promise<void> {\r\n  await db.offline_categories.clear();\r\n  await db.offline_sync_meta.delete('categories');\r\n  console.log('[CategoriesCache] Cache cleared');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\kitchenDispatchService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\modifiersCacheService.ts","messages":[{"ruleId":"no-extra-boolean-cast","severity":2,"message":"Redundant Boolean call.","line":242,"column":10,"nodeType":"CallExpression","messageId":"unexpectedCall","endLine":242,"endColumn":32,"fix":{"range":[7732,7754],"text":"mod.is_active"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Modifiers Cache Service for Offline Support\r\n *\r\n * Provides offline caching for product modifiers to enable modifier selection\r\n * when the application is offline.\r\n *\r\n * Features:\r\n * - Cache all active modifiers from Supabase to IndexedDB\r\n * - Retrieve modifiers by product ID or category ID\r\n * - Resolve modifier inheritance (product > category)\r\n * - Group flat modifier rows into structured ModifierGroup[]\r\n * - Track cache freshness with sync metadata\r\n *\r\n * @see Story 2.3: Product Modifiers Offline Cache\r\n * @see ADR-001: Entités Synchronisées Offline\r\n * @see ADR-003: Politique de Cache\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport { db } from '@/lib/db';\r\nimport type { IOfflineModifier, ISyncMeta } from '@/types/offline';\r\nimport type { ModifierGroup } from '@/hooks/products/useProductModifiers';\r\n\r\n// =====================================================\r\n// Constants\r\n// =====================================================\r\n\r\n/** Cache TTL: 24 hours */\r\nconst CACHE_TTL_HOURS = 24;\r\n\r\n/** Refresh interval when online: 1 hour */\r\nconst REFRESH_INTERVAL_HOURS = 1;\r\n\r\n// =====================================================\r\n// Cache Operations\r\n// =====================================================\r\n\r\n/**\r\n * Fetches all active modifiers from Supabase and caches them in IndexedDB.\r\n *\r\n * This function:\r\n * 1. Queries all active modifiers from Supabase\r\n * 2. Transforms data to IOfflineModifier format with proper defaults\r\n * 3. Clears existing cache and bulk inserts new data\r\n * 4. Updates sync metadata\r\n *\r\n * @throws Error if Supabase query fails\r\n */\r\nexport async function cacheAllModifiers(): Promise<void> {\r\n  const { data, error } = await supabase\r\n    .from('product_modifiers')\r\n    .select(`\r\n      id, product_id, category_id, group_name, group_type, group_required,\r\n      group_sort_order, option_id, option_label, option_icon,\r\n      price_adjustment, is_default, option_sort_order, is_active, created_at\r\n    `)\r\n    .eq('is_active', true);\r\n\r\n  if (error) throw error;\r\n\r\n  // Transform to IOfflineModifier format with proper defaults\r\n  const modifiers: IOfflineModifier[] = (data || []).map((m) => ({\r\n    id: m.id,\r\n    product_id: m.product_id,\r\n    category_id: m.category_id,\r\n    group_name: m.group_name,\r\n    group_type: (m.group_type as 'single' | 'multiple') || 'single',\r\n    group_required: Boolean(m.group_required),\r\n    group_sort_order: m.group_sort_order ?? 0,\r\n    option_id: m.option_id,\r\n    option_label: m.option_label,\r\n    option_icon: m.option_icon,\r\n    price_adjustment: m.price_adjustment ?? 0,\r\n    is_default: Boolean(m.is_default),\r\n    option_sort_order: m.option_sort_order ?? 0,\r\n    is_active: Boolean(m.is_active),\r\n    created_at: m.created_at,\r\n  }));\r\n\r\n  // Clear and repopulate cache\r\n  await db.offline_modifiers.clear();\r\n  if (modifiers.length > 0) {\r\n    await db.offline_modifiers.bulkAdd(modifiers);\r\n  }\r\n\r\n  // Update sync metadata\r\n  await db.offline_sync_meta.put({\r\n    entity: 'modifiers',\r\n    lastSyncAt: new Date().toISOString(),\r\n    recordCount: modifiers.length,\r\n  });\r\n\r\n  console.log(`[ModifiersCache] Cached ${modifiers.length} modifiers`);\r\n}\r\n\r\n/**\r\n * Retrieves cached modifiers for a specific product.\r\n *\r\n * @param productId - The product UUID\r\n * @returns Array of modifiers linked to this product\r\n */\r\nexport async function getCachedModifiersForProduct(\r\n  productId: string\r\n): Promise<IOfflineModifier[]> {\r\n  try {\r\n    const modifiers = await db.offline_modifiers\r\n      .where('product_id')\r\n      .equals(productId)\r\n      .toArray();\r\n\r\n    // Filter active modifiers (Dexie stores booleans as 0/1)\r\n    return modifiers.filter((m) => Boolean(m.is_active));\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error getting product modifiers:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Retrieves cached modifiers for a specific category.\r\n *\r\n * @param categoryId - The category UUID\r\n * @returns Array of modifiers linked to this category\r\n */\r\nexport async function getCachedModifiersForCategory(\r\n  categoryId: string\r\n): Promise<IOfflineModifier[]> {\r\n  try {\r\n    const modifiers = await db.offline_modifiers\r\n      .where('category_id')\r\n      .equals(categoryId)\r\n      .toArray();\r\n\r\n    // Filter active modifiers (Dexie stores booleans as 0/1)\r\n    return modifiers.filter((m) => Boolean(m.is_active));\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error getting category modifiers:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Retrieves a single modifier by its ID.\r\n *\r\n * @param modifierId - The modifier UUID\r\n * @returns The modifier or undefined if not found\r\n */\r\nexport async function getCachedModifierById(\r\n  modifierId: string\r\n): Promise<IOfflineModifier | undefined> {\r\n  try {\r\n    return await db.offline_modifiers.get(modifierId);\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error getting modifier by ID:', error);\r\n    return undefined;\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the count of cached modifiers.\r\n */\r\nexport async function getCachedModifiersCount(): Promise<number> {\r\n  try {\r\n    return await db.offline_modifiers.count();\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error counting modifiers:', error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Modifier Resolution (Product > Category Inheritance)\r\n// =====================================================\r\n\r\n/**\r\n * Resolves modifiers for a product with proper inheritance.\r\n *\r\n * Resolution rules:\r\n * 1. Fetch product-specific modifiers\r\n * 2. Fetch category modifiers (if categoryId provided)\r\n * 3. Product groups override category groups with the same name\r\n * 4. Non-overridden category groups are inherited\r\n *\r\n * @param productId - The product UUID (optional)\r\n * @param categoryId - The category UUID (optional)\r\n * @returns Resolved and grouped modifiers ready for POS display\r\n */\r\nexport async function resolveOfflineModifiers(\r\n  productId: string | undefined,\r\n  categoryId: string | undefined\r\n): Promise<ModifierGroup[]> {\r\n  // Fetch product-specific modifiers\r\n  const productModifiers = productId\r\n    ? await getCachedModifiersForProduct(productId)\r\n    : [];\r\n\r\n  // Fetch category modifiers\r\n  const categoryModifiers = categoryId\r\n    ? await getCachedModifiersForCategory(categoryId)\r\n    : [];\r\n\r\n  // Group modifiers\r\n  const productGroups = groupOfflineModifiers(productModifiers, false);\r\n  const categoryGroups = groupOfflineModifiers(categoryModifiers, true);\r\n\r\n  // Get names of product-specific groups\r\n  const productGroupNames = new Set(productGroups.map((g) => g.name));\r\n\r\n  // Keep category groups that don't have product overrides\r\n  const inheritedGroups = categoryGroups.filter(\r\n    (g) => !productGroupNames.has(g.name)\r\n  );\r\n\r\n  // Combine: product groups + non-overridden category groups\r\n  const combined = [...productGroups, ...inheritedGroups];\r\n\r\n  // Sort by sortOrder\r\n  combined.sort((a, b) => a.sortOrder - b.sortOrder);\r\n\r\n  return combined;\r\n}\r\n\r\n/**\r\n * Groups flat modifier rows into structured ModifierGroup array.\r\n *\r\n * This function transforms the flat database structure where each row\r\n * represents a single option into a hierarchical structure where\r\n * options are grouped by group_name.\r\n *\r\n * @param modifiers - Flat array of offline modifiers\r\n * @param isInherited - Whether these modifiers are from category (inherited)\r\n * @returns Array of grouped modifiers\r\n */\r\nexport function groupOfflineModifiers(\r\n  modifiers: IOfflineModifier[],\r\n  isInherited: boolean = false\r\n): ModifierGroup[] {\r\n  const groupMap = new Map<string, ModifierGroup>();\r\n\r\n  for (const mod of modifiers) {\r\n    // Skip inactive modifiers\r\n    if (!Boolean(mod.is_active)) continue;\r\n\r\n    if (!groupMap.has(mod.group_name)) {\r\n      groupMap.set(mod.group_name, {\r\n        name: mod.group_name,\r\n        type: mod.group_type,\r\n        required: mod.group_required,\r\n        sortOrder: mod.group_sort_order,\r\n        options: [],\r\n        isInherited,\r\n      });\r\n    }\r\n\r\n    const group = groupMap.get(mod.group_name)!;\r\n    group.options.push({\r\n      id: mod.option_id,\r\n      dbId: mod.id,\r\n      label: mod.option_label,\r\n      icon: mod.option_icon || undefined,\r\n      priceAdjustment: mod.price_adjustment,\r\n      isDefault: mod.is_default,\r\n      sortOrder: mod.option_sort_order,\r\n    });\r\n  }\r\n\r\n  // Sort options within each group by sortOrder\r\n  for (const group of groupMap.values()) {\r\n    group.options.sort((a, b) => a.sortOrder - b.sortOrder);\r\n  }\r\n\r\n  return Array.from(groupMap.values());\r\n}\r\n\r\n// =====================================================\r\n// Sync Metadata\r\n// =====================================================\r\n\r\n/**\r\n * Returns the timestamp of the last modifiers sync.\r\n *\r\n * @returns ISO 8601 timestamp or null if never synced\r\n */\r\nexport async function getLastModifiersSyncAt(): Promise<string | null> {\r\n  try {\r\n    const meta = await db.offline_sync_meta.get('modifiers');\r\n    return meta?.lastSyncAt ?? null;\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error getting sync timestamp:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the full sync metadata for modifiers.\r\n *\r\n * @returns Sync metadata or null if never synced\r\n */\r\nexport async function getModifiersSyncMeta(): Promise<ISyncMeta | null> {\r\n  try {\r\n    const meta = await db.offline_sync_meta.get('modifiers');\r\n    return meta ?? null;\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error getting sync metadata:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Cache Freshness Checks\r\n// =====================================================\r\n\r\n/**\r\n * Checks if the modifiers cache needs to be refreshed (24h TTL).\r\n *\r\n * @returns true if cache is stale or doesn't exist\r\n */\r\nexport async function shouldRefreshModifiers(): Promise<boolean> {\r\n  try {\r\n    const meta = await db.offline_sync_meta.get('modifiers');\r\n    if (!meta) return true;\r\n\r\n    const lastSync = new Date(meta.lastSyncAt);\r\n    const hoursSinceSync =\r\n      (Date.now() - lastSync.getTime()) / (1000 * 60 * 60);\r\n\r\n    return hoursSinceSync >= CACHE_TTL_HOURS;\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error checking cache freshness:', error);\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if the modifiers cache should be refreshed based on hourly interval.\r\n *\r\n * This is a softer check than shouldRefreshModifiers - it triggers refresh\r\n * more frequently (every hour) when online to keep data fresh.\r\n *\r\n * @returns true if more than 1 hour since last sync\r\n */\r\nexport async function shouldRefreshModifiersHourly(): Promise<boolean> {\r\n  try {\r\n    const meta = await db.offline_sync_meta.get('modifiers');\r\n    if (!meta) return true;\r\n\r\n    const lastSync = new Date(meta.lastSyncAt);\r\n    const hoursSinceSync =\r\n      (Date.now() - lastSync.getTime()) / (1000 * 60 * 60);\r\n\r\n    return hoursSinceSync >= REFRESH_INTERVAL_HOURS;\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error checking hourly refresh:', error);\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * Refreshes the modifiers cache if needed.\r\n *\r\n * @param force - If true, refresh regardless of TTL\r\n * @returns true if refresh was performed\r\n */\r\nexport async function refreshModifiersCacheIfNeeded(\r\n  force: boolean = false\r\n): Promise<boolean> {\r\n  try {\r\n    const needsRefresh = force || (await shouldRefreshModifiers());\r\n    if (needsRefresh) {\r\n      await cacheAllModifiers();\r\n      return true;\r\n    }\r\n    return false;\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error refreshing cache:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Cache Management\r\n// =====================================================\r\n\r\n/**\r\n * Clears all cached modifiers and sync metadata.\r\n */\r\nexport async function clearModifiersCache(): Promise<void> {\r\n  try {\r\n    await db.offline_modifiers.clear();\r\n    await db.offline_sync_meta.delete('modifiers');\r\n    console.log('[ModifiersCache] Cache cleared');\r\n  } catch (error) {\r\n    console.error('[ModifiersCache] Error clearing cache:', error);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\offlineAuthService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":179,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":179,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Offline Authentication Service\r\n *\r\n * Manages user credential caching for offline PIN authentication.\r\n * Implements ADR-004 (PIN Verification Offline) and ADR-005 (Permissions Offline).\r\n *\r\n * Security considerations:\r\n * - PIN hash is already bcrypt-hashed by server (never stored in plaintext)\r\n * - IndexedDB is same-origin only (browser security model)\r\n * - 24h expiration limits exposure window\r\n *\r\n * @see _bmad-output/planning-artifacts/architecture.md#ADR-004\r\n * @see _bmad-output/planning-artifacts/architecture.md#ADR-005\r\n */\r\n\r\nimport bcryptjs from 'bcryptjs';\r\nimport { db } from '@/lib/db';\r\nimport type { IOfflineUser, IOfflineAuthResult } from '@/types/offline';\r\nimport { OFFLINE_USER_CACHE_TTL_MS } from '@/types/offline';\r\nimport type { Role, EffectivePermission, UserProfileExtended } from '@/types/auth';\r\n\r\n/**\r\n * Offline Authentication Service\r\n *\r\n * Provides functions for:\r\n * - Caching user credentials on successful online login\r\n * - Retrieving cached user data for offline auth\r\n * - Validating cache expiration (24h TTL)\r\n * - Clearing user cache on logout\r\n */\r\nexport const offlineAuthService = {\r\n  /**\r\n   * Cache user credentials for offline authentication\r\n   *\r\n   * Called after successful online login to enable offline auth.\r\n   * Stores PIN hash, roles, and permissions in IndexedDB.\r\n   *\r\n   * @param user - User profile with pin_hash (from Supabase)\r\n   * @param roles - User's assigned roles\r\n   * @param permissions - User's effective permissions\r\n   * @returns Promise<void>\r\n   *\r\n   * @example\r\n   * ```ts\r\n   * await offlineAuthService.cacheUserCredentials(\r\n   *   response.user,\r\n   *   response.roles,\r\n   *   response.permissions\r\n   * );\r\n   * ```\r\n   */\r\n  async cacheUserCredentials(\r\n    user: Partial<UserProfileExtended>,\r\n    roles: Role[],\r\n    permissions: EffectivePermission[]\r\n  ): Promise<void> {\r\n    // Can't cache without PIN hash - skip silently\r\n    if (!user.id || !user.pin_hash) {\r\n      console.debug('[offlineAuth] Skipping cache - no PIN hash available');\r\n      return;\r\n    }\r\n\r\n    const offlineUser: IOfflineUser = {\r\n      id: user.id,\r\n      pin_hash: user.pin_hash,\r\n      roles,\r\n      permissions,\r\n      display_name: user.display_name ?? null,\r\n      preferred_language: (user.preferred_language as 'fr' | 'en' | 'id') ?? 'id',\r\n      cached_at: new Date().toISOString(),\r\n    };\r\n\r\n    try {\r\n      // Use put() to insert or update (upsert)\r\n      await db.offline_users.put(offlineUser);\r\n      console.debug('[offlineAuth] User credentials cached:', user.id);\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to cache user credentials:', error);\r\n      // Don't throw - caching is optional enhancement\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Get cached user data by ID\r\n   *\r\n   * Returns null if user not found or cache expired.\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns Cached user data or null\r\n   */\r\n  async getCachedUser(userId: string): Promise<IOfflineUser | null> {\r\n    try {\r\n      const cached = await db.offline_users.get(userId);\r\n      return cached ?? null;\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to get cached user:', error);\r\n      return null;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Check if cached user credentials are still valid\r\n   *\r\n   * Validates:\r\n   * 1. User exists in cache\r\n   * 2. Cache is not expired (< 24h old)\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns true if cache is valid, false otherwise\r\n   */\r\n  async isCacheValid(userId: string): Promise<boolean> {\r\n    try {\r\n      const cached = await db.offline_users.get(userId);\r\n      if (!cached) {\r\n        return false;\r\n      }\r\n\r\n      const cachedTime = new Date(cached.cached_at).getTime();\r\n      const now = Date.now();\r\n      const isValid = now - cachedTime < OFFLINE_USER_CACHE_TTL_MS;\r\n\r\n      if (!isValid) {\r\n        console.debug('[offlineAuth] Cache expired for user:', userId);\r\n      }\r\n\r\n      return isValid;\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to validate cache:', error);\r\n      return false;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Clear user cache (called on logout)\r\n   *\r\n   * Removes user credentials from IndexedDB.\r\n   *\r\n   * @param userId - User UUID to clear\r\n   */\r\n  async clearUserCache(userId: string): Promise<void> {\r\n    try {\r\n      await db.offline_users.delete(userId);\r\n      console.debug('[offlineAuth] User cache cleared:', userId);\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to clear user cache:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Clear all cached users\r\n   *\r\n   * Used for full cache reset or security clearing.\r\n   */\r\n  async clearAllCache(): Promise<void> {\r\n    try {\r\n      await db.offline_users.clear();\r\n      console.debug('[offlineAuth] All user cache cleared');\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to clear all cache:', error);\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Get cache age in milliseconds\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns Cache age in ms, or -1 if not cached\r\n   */\r\n  async getCacheAge(userId: string): Promise<number> {\r\n    try {\r\n      const cached = await db.offline_users.get(userId);\r\n      if (!cached) {\r\n        return -1;\r\n      }\r\n\r\n      const cachedTime = new Date(cached.cached_at).getTime();\r\n      return Date.now() - cachedTime;\r\n    } catch (error) {\r\n      return -1;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Check if offline auth is available for a user\r\n   *\r\n   * Returns true if:\r\n   * 1. User is cached\r\n   * 2. Cache is not expired\r\n   * 3. PIN hash exists\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns true if offline auth is available\r\n   */\r\n  async isOfflineAuthAvailable(userId: string): Promise<boolean> {\r\n    const cached = await this.getCachedUser(userId);\r\n    if (!cached || !cached.pin_hash) {\r\n      return false;\r\n    }\r\n\r\n    return this.isCacheValid(userId);\r\n  },\r\n\r\n  /**\r\n   * Verify PIN offline using cached bcrypt hash\r\n   *\r\n   * SECURITY: Returns generic INVALID_PIN error for both \"wrong PIN\" and\r\n   * \"user not cached\" to prevent cache enumeration attacks.\r\n   *\r\n   * @param userId - User UUID to authenticate\r\n   * @param pinInput - PIN entered by user (plaintext)\r\n   * @returns Authentication result with user data on success\r\n   *\r\n   * @see ADR-004: PIN Verification Offline\r\n   */\r\n  async verifyPinOffline(\r\n    userId: string,\r\n    pinInput: string\r\n  ): Promise<IOfflineAuthResult> {\r\n    try {\r\n      // Check if cache exists and is valid (not expired)\r\n      const cacheValid = await this.isCacheValid(userId);\r\n      if (!cacheValid) {\r\n        // Check if user exists but cache expired vs not cached at all\r\n        const cached = await this.getCachedUser(userId);\r\n        if (cached) {\r\n          // Cache exists but expired - need online reconnection\r\n          console.debug('[offlineAuth] Cache expired for user:', userId);\r\n          return { success: false, error: 'CACHE_EXPIRED' };\r\n        }\r\n        // User not cached - return generic error (security: don't reveal cache state)\r\n        console.debug('[offlineAuth] User not in cache:', userId);\r\n        return { success: false, error: 'INVALID_PIN' };\r\n      }\r\n\r\n      // Get cached user data\r\n      const cached = await this.getCachedUser(userId);\r\n      if (!cached) {\r\n        // Should not happen if isCacheValid returned true, but handle gracefully\r\n        return { success: false, error: 'INVALID_PIN' };\r\n      }\r\n\r\n      // Verify PIN using bcrypt compare\r\n      const isValid = await bcryptjs.compare(pinInput, cached.pin_hash);\r\n      if (!isValid) {\r\n        console.debug('[offlineAuth] PIN verification failed for user:', userId);\r\n        return { success: false, error: 'INVALID_PIN' };\r\n      }\r\n\r\n      // Success - return cached user data\r\n      console.debug('[offlineAuth] PIN verified successfully for user:', userId);\r\n      return { success: true, user: cached };\r\n    } catch (error) {\r\n      console.error('[offlineAuth] PIN verification error:', error);\r\n      // Return generic error on any exception\r\n      return { success: false, error: 'INVALID_PIN' };\r\n    }\r\n  },\r\n\r\n  // =====================================================\r\n  // Offline Permission Functions (Story 1.3)\r\n  // =====================================================\r\n\r\n  /**\r\n   * Check if a user has a specific permission offline\r\n   *\r\n   * Uses cached permissions from IndexedDB to verify access rights.\r\n   *\r\n   * @param userId - User UUID\r\n   * @param code - Permission code (e.g., 'sales.void', 'inventory.adjust')\r\n   * @returns true if permission is granted, false otherwise\r\n   *\r\n   * @see ADR-005: Permissions Offline\r\n   *\r\n   * @example\r\n   * ```ts\r\n   * const canVoid = await offlineAuthService.hasPermissionOffline(userId, 'sales.void');\r\n   * ```\r\n   */\r\n  async hasPermissionOffline(userId: string, code: string): Promise<boolean> {\r\n    try {\r\n      const cached = await this.getCachedUser(userId);\r\n      if (!cached || !cached.permissions) {\r\n        return false;\r\n      }\r\n\r\n      const perm = cached.permissions.find(p => p.permission_code === code);\r\n      return perm?.is_granted ?? false;\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to check permission offline:', error);\r\n      return false;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Check if a user has a specific role offline\r\n   *\r\n   * Uses cached roles from IndexedDB to verify role membership.\r\n   *\r\n   * @param userId - User UUID\r\n   * @param roleCode - Role code (e.g., 'ADMIN', 'MANAGER', 'CASHIER')\r\n   * @returns true if user has the role, false otherwise\r\n   *\r\n   * @example\r\n   * ```ts\r\n   * const isManager = await offlineAuthService.hasRoleOffline(userId, 'MANAGER');\r\n   * ```\r\n   */\r\n  async hasRoleOffline(userId: string, roleCode: string): Promise<boolean> {\r\n    try {\r\n      const cached = await this.getCachedUser(userId);\r\n      if (!cached || !cached.roles) {\r\n        return false;\r\n      }\r\n\r\n      return cached.roles.some(r => r.code === roleCode);\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to check role offline:', error);\r\n      return false;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Get all cached permissions for a user\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns Array of EffectivePermission, empty array if not cached\r\n   */\r\n  async getOfflinePermissions(userId: string): Promise<EffectivePermission[]> {\r\n    try {\r\n      const cached = await this.getCachedUser(userId);\r\n      return cached?.permissions ?? [];\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to get offline permissions:', error);\r\n      return [];\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Get all cached roles for a user\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns Array of Role, empty array if not cached\r\n   */\r\n  async getOfflineRoles(userId: string): Promise<Role[]> {\r\n    try {\r\n      const cached = await this.getCachedUser(userId);\r\n      return cached?.roles ?? [];\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to get offline roles:', error);\r\n      return [];\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Check if user is manager or above (for sensitive actions)\r\n   *\r\n   * Returns true if user has SUPER_ADMIN, ADMIN, or MANAGER role.\r\n   * Used to determine if a user can approve sensitive offline actions.\r\n   *\r\n   * @param userId - User UUID\r\n   * @returns true if user is manager or above, false otherwise\r\n   *\r\n   * @example\r\n   * ```ts\r\n   * const canApprove = await offlineAuthService.isManagerOrAboveOffline(userId);\r\n   * if (canApprove) {\r\n   *   // Allow sensitive action approval\r\n   * }\r\n   * ```\r\n   */\r\n  async isManagerOrAboveOffline(userId: string): Promise<boolean> {\r\n    try {\r\n      const cached = await this.getCachedUser(userId);\r\n      if (!cached || !cached.roles) {\r\n        return false;\r\n      }\r\n\r\n      return cached.roles.some(r =>\r\n        ['SUPER_ADMIN', 'ADMIN', 'MANAGER'].includes(r.code)\r\n      );\r\n    } catch (error) {\r\n      console.error('[offlineAuth] Failed to check manager status offline:', error);\r\n      return false;\r\n    }\r\n  },\r\n};\r\n\r\nexport default offlineAuthService;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\offlineOrderService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\offlinePaymentService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\offlineSessionService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\ordersCacheService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\productionReminderService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\productsCacheInit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\productsCacheService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\rateLimitService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\recipesCacheService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\offline\\settingsCacheService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\payment\\__tests__\\paymentIntegration.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\payment\\__tests__\\paymentService.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'state' is assigned a value but never used.","line":288,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":288,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Payment Service Tests\r\n *\r\n * Tests for payment validation, change calculation, and split payment state management.\r\n */\r\n\r\nimport { describe, it, expect } from 'vitest';\r\nimport {\r\n  validatePayment,\r\n  validateSplitPayments,\r\n  calculateChange,\r\n  createSplitPaymentState,\r\n  addPaymentToState,\r\n  removePaymentFromState,\r\n  resetSplitPaymentState,\r\n} from '../paymentService';\r\nimport type { IPaymentInput } from '@/types/payment';\r\n\r\ndescribe('paymentService', () => {\r\n  describe('validatePayment', () => {\r\n    it('should accept valid cash payment', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'cash',\r\n        amount: 100000,\r\n        cashReceived: 100000,\r\n      };\r\n\r\n      const result = validatePayment(input, 100000);\r\n\r\n      expect(result.valid).toBe(true);\r\n      expect(result.errors).toHaveLength(0);\r\n    });\r\n\r\n    it('should accept valid card payment', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'card',\r\n        amount: 100000,\r\n        reference: 'CARD-12345',\r\n      };\r\n\r\n      const result = validatePayment(input, 100000);\r\n\r\n      expect(result.valid).toBe(true);\r\n      expect(result.errors).toHaveLength(0);\r\n    });\r\n\r\n    it('should reject zero amount', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'cash',\r\n        amount: 0,\r\n      };\r\n\r\n      const result = validatePayment(input, 100000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors).toContain('Payment amount must be greater than 0');\r\n    });\r\n\r\n    it('should reject negative amount', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'cash',\r\n        amount: -100,\r\n      };\r\n\r\n      const result = validatePayment(input, 100000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors).toContain('Payment amount must be greater than 0');\r\n    });\r\n\r\n    it('should reject cash payment with insufficient cash received', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'cash',\r\n        amount: 100000,\r\n        cashReceived: 50000,\r\n      };\r\n\r\n      const result = validatePayment(input, 100000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors).toContain(\r\n        'Cash received must be at least the payment amount'\r\n      );\r\n    });\r\n\r\n    it('should accept cash payment with excess cash received', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'cash',\r\n        amount: 100000,\r\n        cashReceived: 150000,\r\n      };\r\n\r\n      const result = validatePayment(input, 100000);\r\n\r\n      expect(result.valid).toBe(true);\r\n    });\r\n\r\n    it('should reject amount exceeding maximum', () => {\r\n      const input: IPaymentInput = {\r\n        method: 'cash',\r\n        amount: 20_000_000_000, // 20 billion\r\n      };\r\n\r\n      const result = validatePayment(input, 20_000_000_000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors.some((e) => e.includes('exceeds maximum'))).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('validateSplitPayments', () => {\r\n    it('should accept split payments totaling order amount', () => {\r\n      const inputs: IPaymentInput[] = [\r\n        { method: 'cash', amount: 100000, cashReceived: 100000 },\r\n        { method: 'card', amount: 50000 },\r\n      ];\r\n\r\n      const result = validateSplitPayments(inputs, 150000);\r\n\r\n      expect(result.valid).toBe(true);\r\n      expect(result.errors).toHaveLength(0);\r\n    });\r\n\r\n    it('should reject empty payments array', () => {\r\n      const result = validateSplitPayments([], 100000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors).toContain('At least one payment is required');\r\n    });\r\n\r\n    it('should reject split payments less than order total', () => {\r\n      const inputs: IPaymentInput[] = [\r\n        { method: 'cash', amount: 50000, cashReceived: 50000 },\r\n        { method: 'card', amount: 30000 },\r\n      ];\r\n\r\n      const result = validateSplitPayments(inputs, 150000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors.some((e) => e.includes('less than order total'))).toBe(\r\n        true\r\n      );\r\n    });\r\n\r\n    it('should reject split payments exceeding order total', () => {\r\n      const inputs: IPaymentInput[] = [\r\n        { method: 'cash', amount: 100000, cashReceived: 100000 },\r\n        { method: 'card', amount: 100000 },\r\n      ];\r\n\r\n      const result = validateSplitPayments(inputs, 150000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(result.errors.some((e) => e.includes('exceeds order total'))).toBe(\r\n        true\r\n      );\r\n    });\r\n\r\n    it('should allow 1 IDR rounding difference', () => {\r\n      const inputs: IPaymentInput[] = [\r\n        { method: 'cash', amount: 100000, cashReceived: 100000 },\r\n        { method: 'card', amount: 49999 },\r\n      ];\r\n\r\n      const result = validateSplitPayments(inputs, 150000);\r\n\r\n      expect(result.valid).toBe(true);\r\n    });\r\n\r\n    it('should validate individual payments in split', () => {\r\n      const inputs: IPaymentInput[] = [\r\n        { method: 'cash', amount: 100000, cashReceived: 50000 }, // Invalid: cash < amount\r\n        { method: 'card', amount: 50000 },\r\n      ];\r\n\r\n      const result = validateSplitPayments(inputs, 150000);\r\n\r\n      expect(result.valid).toBe(false);\r\n      expect(\r\n        result.errors.some((e) => e.includes('Payment 1:') && e.includes('Cash'))\r\n      ).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('calculateChange', () => {\r\n    it('should calculate correct change', () => {\r\n      expect(calculateChange(100000, 75000)).toBe(25000);\r\n    });\r\n\r\n    it('should return 0 when exact amount', () => {\r\n      expect(calculateChange(100000, 100000)).toBe(0);\r\n    });\r\n\r\n    it('should round down to nearest 100 IDR', () => {\r\n      expect(calculateChange(100050, 75000)).toBe(25000); // Not 25050\r\n    });\r\n\r\n    it('should return 0 when cash received is less', () => {\r\n      expect(calculateChange(50000, 75000)).toBe(0);\r\n    });\r\n\r\n    it('should handle large amounts', () => {\r\n      expect(calculateChange(1000000, 500000)).toBe(500000);\r\n    });\r\n  });\r\n\r\n  describe('Split Payment State Machine', () => {\r\n    describe('createSplitPaymentState', () => {\r\n      it('should create initial state with correct values', () => {\r\n        const state = createSplitPaymentState(150000);\r\n\r\n        expect(state.payments).toHaveLength(0);\r\n        expect(state.totalPaid).toBe(0);\r\n        expect(state.remainingAmount).toBe(150000);\r\n        expect(state.status).toBe('idle');\r\n      });\r\n    });\r\n\r\n    describe('addPaymentToState', () => {\r\n      it('should add payment and update totals', () => {\r\n        const initialState = createSplitPaymentState(150000);\r\n        const payment: IPaymentInput = {\r\n          method: 'cash',\r\n          amount: 100000,\r\n        };\r\n\r\n        const newState = addPaymentToState(initialState, payment, 150000);\r\n\r\n        expect(newState.payments).toHaveLength(1);\r\n        expect(newState.totalPaid).toBe(100000);\r\n        expect(newState.remainingAmount).toBe(50000);\r\n        expect(newState.status).toBe('adding');\r\n      });\r\n\r\n      it('should set status to complete when total reached', () => {\r\n        const initialState = createSplitPaymentState(150000);\r\n        const payment1: IPaymentInput = { method: 'cash', amount: 100000 };\r\n        const state1 = addPaymentToState(initialState, payment1, 150000);\r\n\r\n        const payment2: IPaymentInput = { method: 'card', amount: 50000 };\r\n        const state2 = addPaymentToState(state1, payment2, 150000);\r\n\r\n        expect(state2.payments).toHaveLength(2);\r\n        expect(state2.totalPaid).toBe(150000);\r\n        expect(state2.remainingAmount).toBe(0);\r\n        expect(state2.status).toBe('complete');\r\n      });\r\n\r\n      it('should handle small rounding differences', () => {\r\n        const initialState = createSplitPaymentState(150000);\r\n        const payment: IPaymentInput = { method: 'cash', amount: 149999 };\r\n\r\n        const newState = addPaymentToState(initialState, payment, 150000);\r\n\r\n        // 1 IDR difference should round to complete\r\n        expect(newState.status).toBe('complete');\r\n      });\r\n    });\r\n\r\n    describe('removePaymentFromState', () => {\r\n      it('should remove payment and update totals', () => {\r\n        let state = createSplitPaymentState(150000);\r\n        state = addPaymentToState(state, { method: 'cash', amount: 100000 }, 150000);\r\n        state = addPaymentToState(state, { method: 'card', amount: 50000 }, 150000);\r\n\r\n        const newState = removePaymentFromState(state, 0, 150000);\r\n\r\n        expect(newState.payments).toHaveLength(1);\r\n        expect(newState.totalPaid).toBe(50000);\r\n        expect(newState.remainingAmount).toBe(100000);\r\n        expect(newState.status).toBe('adding');\r\n      });\r\n\r\n      it('should set status to idle when all payments removed', () => {\r\n        let state = createSplitPaymentState(150000);\r\n        state = addPaymentToState(state, { method: 'cash', amount: 100000 }, 150000);\r\n\r\n        const newState = removePaymentFromState(state, 0, 150000);\r\n\r\n        expect(newState.payments).toHaveLength(0);\r\n        expect(newState.status).toBe('idle');\r\n      });\r\n    });\r\n\r\n    describe('resetSplitPaymentState', () => {\r\n      it('should reset to initial state', () => {\r\n        let state = createSplitPaymentState(150000);\r\n        state = addPaymentToState(state, { method: 'cash', amount: 100000 }, 150000);\r\n\r\n        const resetState = resetSplitPaymentState(150000);\r\n\r\n        expect(resetState.payments).toHaveLength(0);\r\n        expect(resetState.totalPaid).toBe(0);\r\n        expect(resetState.remainingAmount).toBe(150000);\r\n        expect(resetState.status).toBe('idle');\r\n      });\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\payment\\paymentService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\pos\\__tests__\\promotionEngine.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\pos\\promotionEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\print\\__tests__\\printService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\print\\printService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\products\\catalogSyncService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1358,1361],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1358,1361],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1686,1689],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1686,1689],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2808,2811],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2808,2811],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3138,3141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3138,3141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4351,4354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4351,4354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4692,4695],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4692,4695],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Catalog Sync Service\r\n * Handles offline-first management of products and categories.\r\n * Ensures data is saved locally immediately and synced to Supabase when online.\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport { db } from '@/lib/db';\r\nimport { addToSyncQueue } from '@/services/sync/syncQueue';\r\nimport type { IOfflineProduct, IOfflineCategory, IOfflineProductCategoryPrice } from '@/types/offline';\r\n\r\n/**\r\n * Save a product with offline-first logic\r\n */\r\nexport async function saveProduct(product: Partial<IOfflineProduct> & { id: string }): Promise<{ success: boolean; synced: boolean; error?: string }> {\r\n    try {\r\n        // 1. Get existing or merge\r\n        const existing = await db.offline_products.get(product.id);\r\n        const updatedProduct = {\r\n            ...existing,\r\n            ...product,\r\n            updated_at: new Date().toISOString()\r\n        } as IOfflineProduct;\r\n\r\n        // 2. Update local DB immediately\r\n        await db.offline_products.put(updatedProduct);\r\n\r\n        // 3. Attempt to sync to Supabase\r\n        try {\r\n            const { error: supabaseError } = await supabase\r\n                .from('products')\r\n                .upsert(updatedProduct as never);\r\n\r\n            if (supabaseError) throw supabaseError;\r\n\r\n            return { success: true, synced: true };\r\n        } catch (err: any) {\r\n            console.warn('[CatalogSync] Supabase sync failed, queuing for background sync:', err.message);\r\n\r\n            // 4. Queue for background sync if offline/failed\r\n            await addToSyncQueue('product', updatedProduct);\r\n\r\n            return { success: true, synced: false };\r\n        }\r\n    } catch (err: any) {\r\n        console.error('[CatalogSync] Critical error saving product:', err.message);\r\n        return { success: false, synced: false, error: err.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Save a category with offline-first logic\r\n */\r\nexport async function saveCategory(category: Partial<IOfflineCategory> & { id: string }): Promise<{ success: boolean; synced: boolean; error?: string }> {\r\n    try {\r\n        // 1. Get existing or merge\r\n        const existing = await db.offline_categories.get(category.id);\r\n        const updatedCategory = {\r\n            ...existing,\r\n            ...category,\r\n            updated_at: new Date().toISOString()\r\n        } as IOfflineCategory;\r\n\r\n        // 2. Update local DB immediately\r\n        await db.offline_categories.put(updatedCategory);\r\n\r\n        // 3. Attempt to sync to Supabase\r\n        try {\r\n            const { error: supabaseError } = await supabase\r\n                .from('categories')\r\n                .upsert(updatedCategory as never);\r\n\r\n            if (supabaseError) throw supabaseError;\r\n\r\n            return { success: true, synced: true };\r\n        } catch (err: any) {\r\n            console.warn('[CatalogSync] Supabase sync failed, queuing for background sync:', err.message);\r\n\r\n            // 4. Queue for background sync if offline/failed\r\n            await addToSyncQueue('category', updatedCategory);\r\n\r\n            return { success: true, synced: false };\r\n        }\r\n    } catch (err: any) {\r\n        console.error('[CatalogSync] Critical error saving category:', err.message);\r\n        return { success: false, synced: false, error: err.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Save a product category price with offline-first logic (supports partial)\r\n */\r\nexport async function saveProductCategoryPrice(price: Partial<IOfflineProductCategoryPrice> & { id: string }): Promise<{ success: boolean; synced: boolean; error?: string }> {\r\n    try {\r\n        // 1. Get existing or merge\r\n        const existing = await db.offline_product_category_prices.get(price.id);\r\n        const updatedPrice = {\r\n            ...existing,\r\n            ...price,\r\n            updated_at: new Date().toISOString()\r\n        } as IOfflineProductCategoryPrice;\r\n\r\n        // 2. Update local DB immediately\r\n        await db.offline_product_category_prices.put(updatedPrice);\r\n\r\n        // 3. Attempt to sync to Supabase\r\n        try {\r\n            const { error: supabaseError } = await supabase\r\n                .from('product_category_prices')\r\n                .upsert(updatedPrice as never);\r\n\r\n            if (supabaseError) throw supabaseError;\r\n\r\n            return { success: true, synced: true };\r\n        } catch (err: any) {\r\n            console.warn('[CatalogSync] Supabase sync failed, queuing for background sync:', err.message);\r\n\r\n            // 4. Queue for background sync if offline/failed\r\n            await addToSyncQueue('product_category_price', updatedPrice);\r\n\r\n            return { success: true, synced: false };\r\n        }\r\n    } catch (err: any) {\r\n        console.error('[CatalogSync] Critical error saving product category price:', err.message);\r\n        return { success: false, synced: false, error: err.message };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\products\\productImportExport.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":415,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":415,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14702,14705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14702,14705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":447,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":447,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16233,16236],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16233,16236],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":451,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16377,16380],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16377,16380],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Product Import/Export Service\r\n * Epic 10: Stories 10.9, 10.10\r\n *\r\n * Import and export products from/to CSV with section support\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase'\r\nimport { db } from '@/lib/db'\r\n\r\nexport interface IProductImport {\r\n    sku: string\r\n    name: string\r\n    description?: string\r\n    category?: string\r\n    section?: string // Section slug (e.g., \"breakery\", \"pastry\", \"warehouse\")\r\n    product_type: 'finished' | 'semi_finished' | 'raw_material'\r\n    unit: string\r\n    cost_price: number\r\n    sale_price: number\r\n    wholesale_price?: number\r\n    min_stock_level?: number\r\n    stock_quantity?: number\r\n    is_active?: boolean\r\n}\r\n\r\nexport interface IImportResult {\r\n    success: boolean\r\n    created: number\r\n    updated: number\r\n    errors: Array<{ row: number; sku: string; error: string }>\r\n}\r\n\r\n// Story 10.10: Export products to CSV with sections\r\nexport async function exportProducts(): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        // Fetch products with category\r\n        const { data: products, error } = await supabase\r\n            .from('products')\r\n            .select(`\r\n                id,\r\n                sku,\r\n                name,\r\n                description,\r\n                category:categories(name),\r\n                product_type,\r\n                unit,\r\n                cost_price,\r\n                retail_price,\r\n                wholesale_price,\r\n                min_stock_level,\r\n                current_stock,\r\n                is_active\r\n            `)\r\n            .order('name')\r\n\r\n        if (error) throw error\r\n\r\n        // Fetch product sections with section details\r\n        const { data: productSections } = await supabase\r\n            .from('product_sections')\r\n            .select(`\r\n                product_id,\r\n                is_primary,\r\n                section:sections(slug, name)\r\n            `)\r\n\r\n        // Build a map of product_id -> primary section slug\r\n        const sectionMap = new Map<string, string>()\r\n        for (const ps of productSections || []) {\r\n            // Handle Supabase relation which may return array or object\r\n            const sectionRaw = ps.section as unknown\r\n            const section = Array.isArray(sectionRaw) ? sectionRaw[0] : sectionRaw\r\n            if (ps.is_primary && section) {\r\n                sectionMap.set(ps.product_id, (section as { slug: string }).slug)\r\n            }\r\n        }\r\n        // If no primary, use first section found\r\n        for (const ps of productSections || []) {\r\n            const sectionRaw = ps.section as unknown\r\n            const section = Array.isArray(sectionRaw) ? sectionRaw[0] : sectionRaw\r\n            if (!sectionMap.has(ps.product_id) && section) {\r\n                sectionMap.set(ps.product_id, (section as { slug: string }).slug)\r\n            }\r\n        }\r\n\r\n        const csvRows = [\r\n            // Header with section\r\n            'sku,name,description,category,section,product_type,unit,cost_price,sale_price,wholesale_price,min_stock_level,stock_quantity,is_active'\r\n        ]\r\n\r\n        for (const p of products || []) {\r\n            const product = p as unknown as Record<string, unknown>\r\n            const category = product.category as { name: string } | null\r\n            const sectionSlug = sectionMap.get(product.id as string) || ''\r\n            const row = [\r\n                escapeCSV(product.sku || ''),\r\n                escapeCSV(product.name),\r\n                escapeCSV(product.description || ''),\r\n                escapeCSV(category?.name || ''),\r\n                escapeCSV(sectionSlug),\r\n                escapeCSV(product.product_type),\r\n                escapeCSV(product.unit),\r\n                product.cost_price || 0,\r\n                product.retail_price || 0,\r\n                product.wholesale_price || '',\r\n                product.min_stock_level || '',\r\n                product.current_stock || 0,\r\n                product.is_active ? 'true' : 'false'\r\n            ].join(',')\r\n            csvRows.push(row)\r\n        }\r\n\r\n        const csvContent = csvRows.join('\\n')\r\n        downloadCSV(csvContent, `products_${new Date().toISOString().split('T')[0]}.csv`)\r\n\r\n        return { success: true }\r\n    } catch (err) {\r\n        console.error('Export error:', err)\r\n        return { success: false, error: 'Error during export' }\r\n    }\r\n}\r\n\r\n// Story 10.10: Export product template for import with sections\r\nexport function downloadImportTemplate(): void {\r\n    const template = `sku,name,description,category,section,product_type,unit,cost_price,sale_price,wholesale_price,min_stock_level,stock_quantity,is_active\r\nPRD-001,Chocolate croissant,Chocolate pastry,Pastries,pastry,finished,piece,5000,15000,12000,10,50,true\r\nPRD-002,Traditional baguette,French traditional bread,Breads,breakery,finished,piece,3000,8000,6500,20,100,true\r\nING-001,Flour T55,Type 55 wheat flour,Ingredients,warehouse,raw_material,kg,15000,0,,50,200,true`\r\n\r\n    downloadCSV(template, 'product_import_template.csv')\r\n}\r\n\r\n// Story 10.10: Parse CSV file\r\nfunction parseCSV(content: string): Record<string, string>[] {\r\n    const lines = content.split('\\n').filter(line => line.trim())\r\n    if (lines.length < 2) return []\r\n\r\n    const headers = lines[0].split(',').map(h => h.trim().toLowerCase())\r\n    const rows: Record<string, string>[] = []\r\n\r\n    for (let i = 1; i < lines.length; i++) {\r\n        const values = parseCSVLine(lines[i])\r\n        const row: Record<string, string> = {}\r\n        headers.forEach((header, index) => {\r\n            row[header] = values[index]?.trim() || ''\r\n        })\r\n        rows.push(row)\r\n    }\r\n\r\n    return rows\r\n}\r\n\r\n// Parse a single CSV line (handles quoted values)\r\nfunction parseCSVLine(line: string): string[] {\r\n    const values: string[] = []\r\n    let current = ''\r\n    let inQuotes = false\r\n\r\n    for (let i = 0; i < line.length; i++) {\r\n        const char = line[i]\r\n\r\n        if (char === '\"') {\r\n            if (inQuotes && line[i + 1] === '\"') {\r\n                current += '\"'\r\n                i++\r\n            } else {\r\n                inQuotes = !inQuotes\r\n            }\r\n        } else if (char === ',' && !inQuotes) {\r\n            values.push(current)\r\n            current = ''\r\n        } else {\r\n            current += char\r\n        }\r\n    }\r\n    values.push(current)\r\n\r\n    return values\r\n}\r\n\r\n// Story 10.10: Import products from CSV with section support\r\nexport async function importProducts(\r\n    fileContent: string,\r\n    options?: {\r\n        updateExisting?: boolean\r\n        skipErrors?: boolean\r\n    }\r\n): Promise<IImportResult> {\r\n    const rows = parseCSV(fileContent)\r\n    const result: IImportResult = {\r\n        success: true,\r\n        created: 0,\r\n        updated: 0,\r\n        errors: []\r\n    }\r\n\r\n    if (rows.length === 0) {\r\n        return {\r\n            success: false,\r\n            created: 0,\r\n            updated: 0,\r\n            errors: [{ row: 0, sku: '', error: 'Empty file or invalid format' }]\r\n        }\r\n    }\r\n\r\n    // Get category mapping\r\n    const { data: categories } = await supabase\r\n        .from('categories')\r\n        .select('id, name')\r\n\r\n    const categoryMap = new Map<string, string>()\r\n    for (const cat of categories || []) {\r\n        categoryMap.set(cat.name.toLowerCase(), cat.id)\r\n    }\r\n\r\n    // Get section mapping (only active sections)\r\n    const { data: sections } = await supabase\r\n        .from('sections')\r\n        .select('id, slug, name')\r\n        .eq('is_active', true)\r\n\r\n    const sectionMap = new Map<string, string>()\r\n    for (const sec of sections || []) {\r\n        sectionMap.set(sec.slug.toLowerCase(), sec.id)\r\n        sectionMap.set(sec.name.toLowerCase(), sec.id) // Also map by name\r\n    }\r\n\r\n    for (let i = 0; i < rows.length; i++) {\r\n        const row = rows[i]\r\n        const rowNum = i + 2 // Account for header and 0-index\r\n\r\n        try {\r\n            // Validate required fields\r\n            if (!row.sku || !row.name || !row.product_type || !row.unit) {\r\n                throw new Error('Missing required fields (sku, name, product_type, unit)')\r\n            }\r\n\r\n            // Validate product_type\r\n            if (!['finished', 'semi_finished', 'raw_material'].includes(row.product_type)) {\r\n                throw new Error('Invalid product type')\r\n            }\r\n\r\n            // Get category ID\r\n            let categoryId: string | null = null\r\n            if (row.category) {\r\n                categoryId = categoryMap.get(row.category.toLowerCase()) || null\r\n                if (!categoryId) {\r\n                    // Create category if it doesn't exist\r\n                    const { data: newCat } = await supabase\r\n                        .from('categories')\r\n                        .insert({ name: row.category })\r\n                        .select('id')\r\n                        .single()\r\n                    if (newCat) {\r\n                        categoryId = newCat.id\r\n                        categoryMap.set(row.category.toLowerCase(), newCat.id)\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Get section ID if provided\r\n            let sectionId: string | null = null\r\n            if (row.section) {\r\n                sectionId = sectionMap.get(row.section.toLowerCase()) || null\r\n                if (!sectionId) {\r\n                    // Section not found - add warning but continue\r\n                    console.warn(`Section \"${row.section}\" not found for SKU ${row.sku}`)\r\n                }\r\n            }\r\n\r\n            // Check if product exists\r\n            const { data: existing } = await supabase\r\n                .from('products')\r\n                .select('id')\r\n                .eq('sku', row.sku)\r\n                .single()\r\n\r\n            const productData = {\r\n                sku: row.sku,\r\n                name: row.name,\r\n                description: row.description || null,\r\n                category_id: categoryId,\r\n                product_type: row.product_type as 'finished' | 'semi_finished' | 'raw_material',\r\n                unit: row.unit,\r\n                cost_price: parseFloat(row.cost_price) || 0,\r\n                retail_price: parseFloat(row.sale_price) || 0,\r\n                wholesale_price: row.wholesale_price ? parseFloat(row.wholesale_price) : null,\r\n                min_stock_level: row.min_stock_level ? parseFloat(row.min_stock_level) : null,\r\n                current_stock: row.stock_quantity ? parseFloat(row.stock_quantity) : 0,\r\n                is_active: row.is_active !== 'false'\r\n            }\r\n\r\n            let productId: string | null = null\r\n\r\n            if (existing) {\r\n                if (options?.updateExisting) {\r\n                    const { error } = await supabase\r\n                        .from('products')\r\n                        .update({\r\n                            ...productData,\r\n                            updated_at: new Date().toISOString()\r\n                        })\r\n                        .eq('id', existing.id)\r\n\r\n                    if (error) throw error\r\n                    productId = existing.id\r\n                    result.updated++\r\n                } else {\r\n                    result.errors.push({\r\n                        row: rowNum,\r\n                        sku: row.sku,\r\n                        error: 'Product already exists (enable \"Update\" to modify)'\r\n                    })\r\n                    continue\r\n                }\r\n            } else {\r\n                const { data: newProduct, error } = await supabase\r\n                    .from('products')\r\n                    .insert(productData)\r\n                    .select('id')\r\n                    .single()\r\n\r\n                if (error) throw error\r\n                productId = newProduct?.id || null\r\n                result.created++\r\n            }\r\n\r\n            // Link product to section if both exist\r\n            if (productId && sectionId) {\r\n                // First, remove existing primary section if updating\r\n                if (existing && options?.updateExisting) {\r\n                    await supabase\r\n                        .from('product_sections')\r\n                        .update({ is_primary: false })\r\n                        .eq('product_id', productId)\r\n                        .eq('is_primary', true)\r\n                }\r\n\r\n                // Upsert product_section link\r\n                await supabase\r\n                    .from('product_sections')\r\n                    .upsert({\r\n                        product_id: productId,\r\n                        section_id: sectionId,\r\n                        is_primary: true\r\n                    }, {\r\n                        onConflict: 'product_id,section_id'\r\n                    })\r\n            }\r\n        } catch (err) {\r\n            result.errors.push({\r\n                row: rowNum,\r\n                sku: row.sku || '',\r\n                error: err instanceof Error ? err.message : 'Unknown error'\r\n            })\r\n\r\n            if (!options?.skipErrors) {\r\n                result.success = false\r\n                break\r\n            }\r\n        }\r\n    }\r\n\r\n    if (result.errors.length > 0 && !options?.skipErrors) {\r\n        result.success = false\r\n    }\r\n\r\n    return result\r\n}\r\n\r\n/**\r\n * Push local IndexedDB products and categories to Supabase (Recovery Utility)\r\n * \r\n * Used when products were imported locally but failed to reach the cloud.\r\n */\r\nexport async function pushLocalProductsToCloud(): Promise<IImportResult> {\r\n    const result: IImportResult = {\r\n        success: true,\r\n        created: 0,\r\n        updated: 0,\r\n        errors: []\r\n    }\r\n\r\n    try {\r\n        // 1. Get all local data\r\n        const localProducts = await db.offline_products.toArray()\r\n        const localCategories = await db.offline_categories.toArray()\r\n\r\n        if (localProducts.length === 0) {\r\n            return {\r\n                success: true,\r\n                created: 0,\r\n                updated: 0,\r\n                errors: [{ row: 0, sku: '', error: 'No local products to synchronize' }]\r\n            }\r\n        }\r\n\r\n        // 2. Sync Categories first\r\n        const categoryMap = new Map<string, string>()\r\n        for (const cat of localCategories) {\r\n            try {\r\n                const { data: syncedCat, error: catError } = await supabase\r\n                    .from('categories')\r\n                    .upsert({\r\n                        id: cat.id,\r\n                        name: cat.name,\r\n                        updated_at: new Date().toISOString()\r\n                    })\r\n                    .select('id')\r\n                    .single()\r\n\r\n                if (catError) throw catError\r\n                if (syncedCat) categoryMap.set(cat.id, syncedCat.id)\r\n            } catch (err: any) {\r\n                result.errors.push({ row: 0, sku: 'CAT', error: `Category ${cat.name}: ${err.message}` })\r\n            }\r\n        }\r\n\r\n        // 3. Sync Products\r\n        for (const prod of localProducts) {\r\n            try {\r\n                // Map fields from offline format to Supabase format\r\n                // Note: The offline table uses names consistent with Supabase but some fields might be missing\r\n                const { error: prodError } = await supabase\r\n                    .from('products')\r\n                    .upsert({\r\n                        id: prod.id,\r\n                        sku: prod.sku,\r\n                        name: prod.name,\r\n                        category_id: prod.category_id,\r\n                        product_type: prod.product_type,\r\n                        unit: prod.unit,\r\n                        cost_price: prod.cost_price,\r\n                        retail_price: prod.retail_price,\r\n                        wholesale_price: prod.wholesale_price,\r\n                        min_stock_level: prod.min_stock_level,\r\n                        current_stock: prod.current_stock,\r\n                        is_active: prod.is_active,\r\n                        pos_visible: prod.pos_visible,\r\n                        image_url: prod.image_url,\r\n                        updated_at: new Date().toISOString()\r\n                    })\r\n\r\n                if (prodError) throw prodError\r\n                result.created++ // Count as created/updated since it's an upsert\r\n            } catch (err: any) {\r\n                result.errors.push({ row: 0, sku: prod.sku || 'N/A', error: err.message })\r\n            }\r\n        }\r\n    } catch (err: any) {\r\n        result.success = false\r\n        result.errors.push({ row: 0, sku: 'GLOBAL', error: err.message })\r\n    }\r\n\r\n    return result\r\n}\r\n\r\n// Helper functions\r\nfunction escapeCSV(value: unknown): string {\r\n    if (value === null || value === undefined) return ''\r\n    const str = String(value)\r\n    if (str.includes(',') || str.includes('\"') || str.includes('\\n')) {\r\n        return `\"${str.replace(/\"/g, '\"\"')}\"`\r\n    }\r\n    return str\r\n}\r\n\r\nfunction downloadCSV(content: string, filename: string) {\r\n    const blob = new Blob(['\\uFEFF' + content], { type: 'text/csv;charset=utf-8;' })\r\n    const link = document.createElement('a')\r\n    link.href = URL.createObjectURL(blob)\r\n    link.download = filename\r\n    link.click()\r\n    URL.revokeObjectURL(link.href)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\products\\recipeImportExport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\promotionService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1937,1940],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1937,1940],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4213,4216],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4213,4216],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":171,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5481,5484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5481,5484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":222,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":225,"endColumn":54},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":284,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":284,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9841,9844],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9841,9844],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":298,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10524,10527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10524,10527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":327,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11465,11468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11465,11468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase'\r\nimport {\r\n    Promotion\r\n} from '../types/database'\r\n\r\nexport interface CartItem {\r\n    product_id: string\r\n    product_name: string\r\n    category_id: string | null\r\n    quantity: number\r\n    unit_price: number\r\n    total_price: number\r\n}\r\n\r\nexport interface PromotionResult {\r\n    promotion: Promotion\r\n    discount_amount: number\r\n    free_products: Array<{ product_id: string; quantity: number }>\r\n    applicable_items: CartItem[]\r\n}\r\n\r\nexport interface AppliedPromotion {\r\n    promotion_id: string\r\n    promotion_code: string\r\n    promotion_name: string\r\n    discount_amount: number\r\n    free_products: Array<{ product_id: string; quantity: number }>\r\n}\r\n\r\n/**\r\n * Check if a promotion is currently valid based on time constraints\r\n */\r\nexport function isPromotionValid(\r\n    promotion: Promotion,\r\n    _customerId?: string | null\r\n): { valid: boolean; reason?: string } {\r\n    void _customerId; // Parameter reserved for future use\r\n    // Check if active\r\n    if (!promotion.is_active) {\r\n        return { valid: false, reason: 'Promotion inactive' }\r\n    }\r\n\r\n    const now = new Date()\r\n\r\n    // Check date range\r\n    if (promotion.start_date) {\r\n        const startDate = new Date(promotion.start_date)\r\n        if (now < startDate) {\r\n            return { valid: false, reason: 'Promotion not yet started' }\r\n        }\r\n    }\r\n\r\n    if (promotion.end_date) {\r\n        const endDate = new Date(promotion.end_date)\r\n        if (now > endDate) {\r\n            return { valid: false, reason: 'Promotion expired' }\r\n        }\r\n    }\r\n\r\n    // Check day of week\r\n    if (promotion.days_of_week && promotion.days_of_week.length > 0) {\r\n        const currentDay = now.getDay()\r\n        if (!promotion.days_of_week.includes(currentDay)) {\r\n            return { valid: false, reason: 'Promotion not valid today' }\r\n        }\r\n    }\r\n\r\n    // Check time range\r\n    const promoAny = promotion as any\r\n    if (promoAny.time_start && promoAny.time_end) {\r\n        const currentTime = now.toTimeString().slice(0, 5) // HH:MM format\r\n        if (currentTime < promoAny.time_start || currentTime > promoAny.time_end) {\r\n            return { valid: false, reason: 'Promotion not valid at this time' }\r\n        }\r\n    }\r\n\r\n    // Check total usage limit\r\n    if (promoAny.max_uses_total && promoAny.current_uses >= promoAny.max_uses_total) {\r\n        return { valid: false, reason: 'Promotion usage limit reached' }\r\n    }\r\n\r\n    return { valid: true }\r\n}\r\n\r\n/**\r\n * Get all applicable promotions for the current cart\r\n */\r\nexport async function getApplicablePromotions(\r\n    cartItems: CartItem[],\r\n    subtotal: number,\r\n    customerId?: string | null\r\n): Promise<Promotion[]> {\r\n    try {\r\n        // Fetch all active promotions\r\n        const { data: promotions, error } = await supabase\r\n            .from('promotions')\r\n            .select('*')\r\n            .eq('is_active', true)\r\n            .order('priority', { ascending: false })\r\n\r\n        if (error) throw error\r\n        if (!promotions) return []\r\n\r\n        // Filter promotions based on validity\r\n        const validPromotions: Promotion[] = []\r\n\r\n        for (const promotion of promotions) {\r\n            const { valid } = isPromotionValid(promotion, customerId)\r\n            if (!valid) continue\r\n\r\n            // Check minimum purchase amount\r\n            if (promotion.min_purchase_amount && subtotal < promotion.min_purchase_amount) {\r\n                continue\r\n            }\r\n\r\n            // Check if promotion applies to any cart items\r\n            const { data: promotionProducts } = await supabase\r\n                .from('promotion_products')\r\n                .select('*')\r\n                .eq('promotion_id', promotion.id)\r\n\r\n            // If no specific products/categories, promotion applies to all\r\n            if (!promotionProducts || promotionProducts.length === 0) {\r\n                validPromotions.push(promotion)\r\n                continue\r\n            }\r\n\r\n            // Check if any cart item matches promotion products/categories\r\n            const hasMatchingItem = cartItems.some(item => {\r\n                return promotionProducts.some(pp => {\r\n                    const ppAny = pp as any\r\n                    return (pp.product_id && pp.product_id === item.product_id) ||\r\n                        (ppAny.category_id && ppAny.category_id === item.category_id)\r\n                })\r\n            })\r\n\r\n            if (hasMatchingItem) {\r\n                validPromotions.push(promotion)\r\n            }\r\n        }\r\n\r\n        return validPromotions\r\n    } catch (error) {\r\n        console.error('Error fetching applicable promotions:', error)\r\n        return []\r\n    }\r\n}\r\n\r\n/**\r\n * Calculate discount for a specific promotion\r\n */\r\nexport async function calculatePromotionDiscount(\r\n    promotion: Promotion,\r\n    cartItems: CartItem[],\r\n    _subtotal: number\r\n): Promise<PromotionResult | null> {\r\n    void _subtotal; // Reserved for future use\r\n    try {\r\n        // Get promotion products\r\n        const { data: promotionProducts } = await supabase\r\n            .from('promotion_products')\r\n            .select('*')\r\n            .eq('promotion_id', promotion.id)\r\n\r\n        // Filter applicable items\r\n        let applicableItems = cartItems\r\n\r\n        if (promotionProducts && promotionProducts.length > 0) {\r\n            applicableItems = cartItems.filter(item =>\r\n                promotionProducts.some(pp => {\r\n                    const ppAny = pp as any\r\n                    return (pp.product_id && pp.product_id === item.product_id) ||\r\n                        (ppAny.category_id && ppAny.category_id === item.category_id)\r\n                })\r\n            )\r\n        }\r\n\r\n        if (applicableItems.length === 0) return null\r\n\r\n        let discountAmount = 0\r\n        const freeProducts: Array<{ product_id: string; quantity: number }> = []\r\n\r\n        switch (promotion.promotion_type) {\r\n            case 'percentage':\r\n                if (promotion.discount_percentage) {\r\n                    const applicableTotal = applicableItems.reduce(\r\n                        (sum, item) => sum + item.total_price,\r\n                        0\r\n                    )\r\n                    discountAmount = (applicableTotal * promotion.discount_percentage) / 100\r\n                }\r\n                break\r\n\r\n            case 'fixed_amount':\r\n                if (promotion.discount_amount) {\r\n                    discountAmount = promotion.discount_amount\r\n                }\r\n                break\r\n\r\n            case 'buy_x_get_y':\r\n                if (promotion.buy_quantity && promotion.get_quantity) {\r\n                    // Calculate how many times the promotion applies\r\n                    const totalQuantity = applicableItems.reduce(\r\n                        (sum, item) => sum + item.quantity,\r\n                        0\r\n                    )\r\n                    const promoSets = Math.floor(totalQuantity / promotion.buy_quantity)\r\n\r\n                    if (promoSets > 0) {\r\n                        // Find cheapest item to discount\r\n                        const sortedItems = [...applicableItems].sort(\r\n                            (a, b) => a.unit_price - b.unit_price\r\n                        )\r\n                        const freeQty = promoSets * promotion.get_quantity\r\n                        discountAmount = sortedItems[0].unit_price * Math.min(freeQty, sortedItems[0].quantity)\r\n                    }\r\n                }\r\n                break\r\n\r\n            case 'free_product':\r\n                // Get free products\r\n                const { data: freeProductsData } = await supabase\r\n                    .from('promotion_free_products')\r\n                    .select('product_id, quantity')\r\n                    .eq('promotion_id', promotion.id)\r\n\r\n                if (freeProductsData) {\r\n                    type FreeProductRow = { product_id?: string; free_product_id?: string; quantity?: number };\r\n                    const rawData = freeProductsData as unknown as FreeProductRow[];\r\n                    const validItems = rawData\r\n                        .map((fp) => ({\r\n                            product_id: fp.product_id || fp.free_product_id || '',\r\n                            quantity: fp.quantity || 1\r\n                        }))\r\n                        .filter((fp) => fp.product_id !== '');\r\n                    freeProducts.push(...validItems)\r\n                }\r\n                break\r\n        }\r\n\r\n        return {\r\n            promotion,\r\n            discount_amount: discountAmount,\r\n            free_products: freeProducts,\r\n            applicable_items: applicableItems\r\n        }\r\n    } catch (error) {\r\n        console.error('Error calculating promotion discount:', error)\r\n        return null\r\n    }\r\n}\r\n\r\n/**\r\n * Apply best promotions to cart (handles stacking logic)\r\n */\r\nexport async function applyBestPromotions(\r\n    cartItems: CartItem[],\r\n    subtotal: number,\r\n    customerId?: string | null\r\n): Promise<AppliedPromotion[]> {\r\n    try {\r\n        const applicablePromotions = await getApplicablePromotions(\r\n            cartItems,\r\n            subtotal,\r\n            customerId\r\n        )\r\n\r\n        if (applicablePromotions.length === 0) return []\r\n\r\n        const results: PromotionResult[] = []\r\n\r\n        for (const promotion of applicablePromotions) {\r\n            const result = await calculatePromotionDiscount(promotion, cartItems, subtotal)\r\n            if (result && result.discount_amount > 0) {\r\n                results.push(result)\r\n            }\r\n        }\r\n\r\n        // Sort by discount amount (best first)\r\n        results.sort((a, b) => b.discount_amount - a.discount_amount)\r\n\r\n        // Apply stacking logic\r\n        const appliedPromotions: AppliedPromotion[] = []\r\n        const appliedNonStackable = results.find(r => !(r.promotion as any).is_stackable)\r\n\r\n        if (appliedNonStackable) {\r\n            // If we have a non-stackable promotion, only apply that one\r\n            appliedPromotions.push({\r\n                promotion_id: appliedNonStackable.promotion.id,\r\n                promotion_code: appliedNonStackable.promotion.code || '',\r\n                promotion_name: appliedNonStackable.promotion.name,\r\n                discount_amount: appliedNonStackable.discount_amount,\r\n                free_products: appliedNonStackable.free_products\r\n            })\r\n        } else {\r\n            // Apply all stackable promotions\r\n            for (const result of results) {\r\n                if ((result.promotion as any).is_stackable || appliedPromotions.length === 0) {\r\n                    appliedPromotions.push({\r\n                        promotion_id: result.promotion.id,\r\n                        promotion_code: result.promotion.code || '',\r\n                        promotion_name: result.promotion.name,\r\n                        discount_amount: result.discount_amount,\r\n                        free_products: result.free_products\r\n                    })\r\n                }\r\n            }\r\n        }\r\n\r\n        return appliedPromotions\r\n    } catch (error) {\r\n        console.error('Error applying promotions:', error)\r\n        return []\r\n    }\r\n}\r\n\r\n/**\r\n * Record promotion usage after order completion\r\n */\r\nexport async function recordPromotionUsage(\r\n    promotionId: string,\r\n    customerId: string | null,\r\n    orderId: string,\r\n    discountAmount: number\r\n): Promise<void> {\r\n    try {\r\n        await supabase.rpc('record_promotion_usage' as any, {\r\n            p_promotion_id: promotionId,\r\n            p_customer_id: customerId || undefined,\r\n            p_order_id: orderId,\r\n            p_discount_amount: discountAmount\r\n        })\r\n    } catch (error) {\r\n        console.error('Error recording promotion usage:', error)\r\n    }\r\n}\r\n\r\n/**\r\n * Validate promotion code manually entered by user\r\n */\r\nexport async function validatePromotionCode(\r\n    code: string,\r\n    _cartItems: CartItem[],\r\n    subtotal: number,\r\n    customerId?: string | null\r\n): Promise<{ valid: boolean; promotion?: Promotion; reason?: string }> {\r\n    void _cartItems; // Reserved for future use\r\n    try {\r\n        const { data: promotion, error } = await supabase\r\n            .from('promotions')\r\n            .select('*')\r\n            .eq('code', code.toUpperCase())\r\n            .single()\r\n\r\n        if (error || !promotion) {\r\n            return { valid: false, reason: 'Code promotion invalide' }\r\n        }\r\n\r\n        const { valid, reason } = isPromotionValid(promotion, customerId)\r\n        if (!valid) {\r\n            return { valid: false, reason }\r\n        }\r\n\r\n        // Check minimum purchase\r\n        if (promotion.min_purchase_amount && subtotal < promotion.min_purchase_amount) {\r\n            return {\r\n                valid: false,\r\n                reason: `Montant minimum requis: ${promotion.min_purchase_amount} IDR`\r\n            }\r\n        }\r\n\r\n        return { valid: true, promotion }\r\n    } catch (error) {\r\n        console.error('Error validating promotion code:', error)\r\n        return { valid: false, reason: 'Erreur lors de la validation du code' }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\reports\\anomalyAlerts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\reports\\csvExport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\reports\\pdfExport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\storage\\companyAssetsService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\storage\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\customerPricingService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\customerSync.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\orderSyncProcessor.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\paymentSyncProcessor.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\promotionSync.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\promotionValidationService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\sessionSyncProcessor.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\syncEngineV2.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\__tests__\\syncQueueHelpers.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\customerCategorySync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\customerPricingService.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'customPricesMap' is never reassigned. Use 'const' instead.","line":187,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":187,"endColumn":22,"fix":{"range":[5700,5770],"text":"const customPricesMap = new Map<string, IOfflineProductCategoryPrice>();"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Customer Pricing Service\r\n * Story 6.2 - Customer Category Pricing Offline\r\n *\r\n * Calculates the correct price for a product based on customer category.\r\n * Mirrors the logic of the database function `get_customer_product_price`.\r\n *\r\n * Pricing priority:\r\n * 1. Custom price (from product_category_prices table)\r\n * 2. Wholesale price (if category uses wholesale pricing)\r\n * 3. Discount percentage (applies X% off retail)\r\n * 4. Retail price (fallback)\r\n *\r\n * @see database function: get_customer_product_price(p_product_id, p_customer_category_slug)\r\n */\r\n\r\nimport { db } from '@/lib/db';\r\nimport type { IOfflineProduct, IOfflineProductCategoryPrice } from '@/lib/db';\r\nimport type { TPriceType, ICustomerPriceResult } from '@/types/offline';\r\n\r\n// Re-export types for consumers\r\nexport type { TPriceType, ICustomerPriceResult };\r\n\r\n/**\r\n * Calculate the price for a product based on customer category\r\n * Replicates get_customer_product_price database function for offline use\r\n *\r\n * @param product The product to price\r\n * @param categorySlug Customer category slug (e.g., 'retail', 'wholesale', 'vip')\r\n * @returns Calculated price result with price type and savings\r\n */\r\nexport async function calculateCustomerPrice(\r\n  product: IOfflineProduct,\r\n  categorySlug: string | null\r\n): Promise<ICustomerPriceResult> {\r\n  const retailPrice = product.retail_price || 0;\r\n\r\n  // Default result for no category (retail customer)\r\n  if (!categorySlug || categorySlug === 'retail') {\r\n    return {\r\n      price: retailPrice,\r\n      priceType: 'retail',\r\n      savings: 0,\r\n      categoryName: null,\r\n    };\r\n  }\r\n\r\n  // Get customer category from offline cache\r\n  const category = await db.offline_customer_categories\r\n    .where('slug')\r\n    .equals(categorySlug)\r\n    .first();\r\n\r\n  if (!category || !category.is_active) {\r\n    // Category not found or inactive - return retail price\r\n    return {\r\n      price: retailPrice,\r\n      priceType: 'retail',\r\n      savings: 0,\r\n      categoryName: null,\r\n    };\r\n  }\r\n\r\n  // Determine price based on price_modifier_type\r\n  const modifierType = category.price_modifier_type;\r\n\r\n  // 1. Custom price - check product_category_prices table first\r\n  if (modifierType === 'custom') {\r\n    const customPrice = await db.offline_product_category_prices\r\n      .where('[product_id+customer_category_id]')\r\n      .equals([product.id, category.id])\r\n      .first();\r\n\r\n    if (customPrice && customPrice.is_active && customPrice.price > 0) {\r\n      const savings = retailPrice - customPrice.price;\r\n      return {\r\n        price: customPrice.price,\r\n        priceType: 'custom',\r\n        savings: savings > 0 ? savings : 0,\r\n        categoryName: category.name,\r\n      };\r\n    }\r\n    // No custom price found - fall back to retail\r\n    return {\r\n      price: retailPrice,\r\n      priceType: 'retail',\r\n      savings: 0,\r\n      categoryName: category.name,\r\n    };\r\n  }\r\n\r\n  // 2. Wholesale price\r\n  if (modifierType === 'wholesale') {\r\n    const wholesalePrice = product.wholesale_price;\r\n    if (wholesalePrice && wholesalePrice > 0) {\r\n      const savings = retailPrice - wholesalePrice;\r\n      return {\r\n        price: wholesalePrice,\r\n        priceType: 'wholesale',\r\n        savings: savings > 0 ? savings : 0,\r\n        categoryName: category.name,\r\n      };\r\n    }\r\n    // No wholesale price set - fall back to retail\r\n    return {\r\n      price: retailPrice,\r\n      priceType: 'retail',\r\n      savings: 0,\r\n      categoryName: category.name,\r\n    };\r\n  }\r\n\r\n  // 3. Discount percentage\r\n  if (modifierType === 'discount_percentage') {\r\n    const discountPct = category.discount_percentage;\r\n    if (discountPct && discountPct > 0) {\r\n      const discountAmount = retailPrice * (discountPct / 100);\r\n      const discountedPrice = Math.round((retailPrice - discountAmount) / 100) * 100; // Round to nearest 100 IDR\r\n      const savings = retailPrice - discountedPrice;\r\n      return {\r\n        price: discountedPrice,\r\n        priceType: 'discount',\r\n        savings: savings > 0 ? savings : 0,\r\n        categoryName: category.name,\r\n      };\r\n    }\r\n  }\r\n\r\n  // Default: retail price\r\n  return {\r\n    price: retailPrice,\r\n    priceType: 'retail',\r\n    savings: 0,\r\n    categoryName: category.name,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate prices for multiple products at once\r\n * More efficient for batch operations (e.g., product grid)\r\n *\r\n * @param products Array of products to price\r\n * @param categorySlug Customer category slug\r\n * @returns Map of product ID to price result\r\n */\r\nexport async function calculateCustomerPricesBatch(\r\n  products: IOfflineProduct[],\r\n  categorySlug: string | null\r\n): Promise<Map<string, ICustomerPriceResult>> {\r\n  const results = new Map<string, ICustomerPriceResult>();\r\n\r\n  // No category - all products get retail price\r\n  if (!categorySlug || categorySlug === 'retail') {\r\n    for (const product of products) {\r\n      results.set(product.id, {\r\n        price: product.retail_price || 0,\r\n        priceType: 'retail',\r\n        savings: 0,\r\n        categoryName: null,\r\n      });\r\n    }\r\n    return results;\r\n  }\r\n\r\n  // Get customer category\r\n  const category = await db.offline_customer_categories\r\n    .where('slug')\r\n    .equals(categorySlug)\r\n    .first();\r\n\r\n  if (!category || !category.is_active) {\r\n    // Category not found - all retail\r\n    for (const product of products) {\r\n      results.set(product.id, {\r\n        price: product.retail_price || 0,\r\n        priceType: 'retail',\r\n        savings: 0,\r\n        categoryName: null,\r\n      });\r\n    }\r\n    return results;\r\n  }\r\n\r\n  const modifierType = category.price_modifier_type;\r\n\r\n  // For custom pricing, batch fetch all custom prices for this category\r\n  let customPricesMap = new Map<string, IOfflineProductCategoryPrice>();\r\n  if (modifierType === 'custom') {\r\n    const customPrices = await db.offline_product_category_prices\r\n      .where('customer_category_id')\r\n      .equals(category.id)\r\n      .filter((p) => p.is_active)\r\n      .toArray();\r\n\r\n    for (const cp of customPrices) {\r\n      customPricesMap.set(cp.product_id, cp);\r\n    }\r\n  }\r\n\r\n  // Calculate price for each product\r\n  for (const product of products) {\r\n    const retailPrice = product.retail_price || 0;\r\n\r\n    if (modifierType === 'custom') {\r\n      const customPrice = customPricesMap.get(product.id);\r\n      if (customPrice && customPrice.price > 0) {\r\n        const savings = retailPrice - customPrice.price;\r\n        results.set(product.id, {\r\n          price: customPrice.price,\r\n          priceType: 'custom',\r\n          savings: savings > 0 ? savings : 0,\r\n          categoryName: category.name,\r\n        });\r\n      } else {\r\n        results.set(product.id, {\r\n          price: retailPrice,\r\n          priceType: 'retail',\r\n          savings: 0,\r\n          categoryName: category.name,\r\n        });\r\n      }\r\n    } else if (modifierType === 'wholesale') {\r\n      const wholesalePrice = product.wholesale_price;\r\n      if (wholesalePrice && wholesalePrice > 0) {\r\n        const savings = retailPrice - wholesalePrice;\r\n        results.set(product.id, {\r\n          price: wholesalePrice,\r\n          priceType: 'wholesale',\r\n          savings: savings > 0 ? savings : 0,\r\n          categoryName: category.name,\r\n        });\r\n      } else {\r\n        results.set(product.id, {\r\n          price: retailPrice,\r\n          priceType: 'retail',\r\n          savings: 0,\r\n          categoryName: category.name,\r\n        });\r\n      }\r\n    } else if (modifierType === 'discount_percentage') {\r\n      const discountPct = category.discount_percentage;\r\n      if (discountPct && discountPct > 0) {\r\n        const discountAmount = retailPrice * (discountPct / 100);\r\n        const discountedPrice = Math.round((retailPrice - discountAmount) / 100) * 100;\r\n        const savings = retailPrice - discountedPrice;\r\n        results.set(product.id, {\r\n          price: discountedPrice,\r\n          priceType: 'discount',\r\n          savings: savings > 0 ? savings : 0,\r\n          categoryName: category.name,\r\n        });\r\n      } else {\r\n        results.set(product.id, {\r\n          price: retailPrice,\r\n          priceType: 'retail',\r\n          savings: 0,\r\n          categoryName: category.name,\r\n        });\r\n      }\r\n    } else {\r\n      // Unknown modifier type - default to retail\r\n      results.set(product.id, {\r\n        price: retailPrice,\r\n        priceType: 'retail',\r\n        savings: 0,\r\n        categoryName: category.name,\r\n      });\r\n    }\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\n/**\r\n * Get the price display info for a single product\r\n * Convenience function for UI components\r\n *\r\n * @param productId Product ID\r\n * @param categorySlug Customer category slug\r\n * @returns Price result or null if product not found\r\n */\r\nexport async function getProductPriceForCustomer(\r\n  productId: string,\r\n  categorySlug: string | null\r\n): Promise<ICustomerPriceResult | null> {\r\n  const product = await db.offline_products.get(productId);\r\n  if (!product) return null;\r\n\r\n  return calculateCustomerPrice(product, categorySlug);\r\n}\r\n\r\n/**\r\n * Check if a customer category has any special pricing configured\r\n *\r\n * @param categorySlug Customer category slug\r\n * @returns true if category has non-retail pricing\r\n */\r\nexport async function categoryHasSpecialPricing(\r\n  categorySlug: string | null\r\n): Promise<boolean> {\r\n  if (!categorySlug || categorySlug === 'retail') return false;\r\n\r\n  const category = await db.offline_customer_categories\r\n    .where('slug')\r\n    .equals(categorySlug)\r\n    .first();\r\n\r\n  if (!category || !category.is_active) return false;\r\n\r\n  // Check if modifier type is anything other than retail\r\n  const modifierType = category.price_modifier_type;\r\n  if (modifierType === 'wholesale' || modifierType === 'discount_percentage') {\r\n    return true;\r\n  }\r\n\r\n  if (modifierType === 'custom') {\r\n    // Check if there are any custom prices for this category\r\n    const count = await db.offline_product_category_prices\r\n      .where('customer_category_id')\r\n      .equals(category.id)\r\n      .count();\r\n    return count > 0;\r\n  }\r\n\r\n  return false;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\customerSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\offlinePeriod.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\orderSync.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\orderSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\orderSyncProcessor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\paymentSyncProcessor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\productCategoryPriceSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\productSync.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\productSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\promotionSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\promotionValidationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\sessionSyncProcessor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\stockSync.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\stockSync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncDeviceService.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncDeviceService.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2103,2106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2103,2106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3235,3238],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3235,3238],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":124,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3834,3837],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3834,3837],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4308,4311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4308,4311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":162,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":162,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4868,4871],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4868,4871],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5567,5570],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5567,5570],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6264,6267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6264,6267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":234,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6853,6856],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6853,6856],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":265,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7581,7584],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7581,7584],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncEngine.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'engineState' is never reassigned. Use 'const' instead.","line":35,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":35,"endColumn":34,"fix":{"range":[888,1009],"text":"const engineState: ISyncEngineState = {\r\n  isRunning: false,\r\n  lastSyncAt: null,\r\n  itemsSynced: 0,\r\n  itemsFailed: 0,\r\n};"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\r\n * Sync Engine Service\r\n * Story 2.5 - Sync Queue Management\r\n * Story 3.5 - Automatic Sync Engine\r\n *\r\n * Manages automatic synchronization of offline transactions when internet returns.\r\n * Processes queue items in FIFO order with exponential backoff for retries.\r\n * Provides background automatic sync at configurable intervals.\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport {\r\n  getSyncQueueItems,\r\n  getRetryableItems,\r\n  markSyncing,\r\n  markSynced,\r\n  markFailed,\r\n  cleanupSyncedItems,\r\n  ISyncQueueItem,\r\n} from './syncQueue';\r\nimport { markOrderSynced } from './orderSync';\r\nimport { useSyncStore } from '../../stores/syncStore';\r\nimport { useNetworkStore } from '../../stores/networkStore';\r\n\r\n/**\r\n * Sync engine state\r\n */\r\ninterface ISyncEngineState {\r\n  isRunning: boolean;\r\n  lastSyncAt: Date | null;\r\n  itemsSynced: number;\r\n  itemsFailed: number;\r\n}\r\n\r\nlet engineState: ISyncEngineState = {\r\n  isRunning: false,\r\n  lastSyncAt: null,\r\n  itemsSynced: 0,\r\n  itemsFailed: 0,\r\n};\r\n\r\n/**\r\n * Delay for starting sync after going online (per Story 2.5: 5 seconds)\r\n */\r\nconst SYNC_START_DELAY = 5000;\r\n\r\n/**\r\n * Minimum delay between processing items\r\n */\r\nconst ITEM_PROCESS_DELAY = 100;\r\n\r\n/**\r\n * Background sync interval in milliseconds (Story 3.5: every 30 seconds)\r\n */\r\nconst BACKGROUND_SYNC_INTERVAL = 30000;\r\n\r\n/**\r\n * Interval ID for background sync timer\r\n */\r\nlet backgroundSyncIntervalId: ReturnType<typeof setInterval> | null = null;\r\n\r\n/**\r\n * C-5: Timeout ID for delayed sync start\r\n */\r\nlet startDelayTimeoutId: ReturnType<typeof setTimeout> | null = null;\r\n\r\n/**\r\n * Flag to track if auto-sync is enabled\r\n */\r\nlet autoSyncEnabled = true;\r\n\r\n/**\r\n * Get current sync engine state\r\n */\r\nexport function getSyncEngineState(): ISyncEngineState {\r\n  return { ...engineState };\r\n}\r\n\r\n/**\r\n * Sync a single order to Supabase\r\n */\r\nasync function syncOrder(item: ISyncQueueItem): Promise<void> {\r\n  const orderPayload = item.payload as Record<string, unknown>;\r\n\r\n  // Transform offline order to Supabase format\r\n  // Using explicit type assertion for dynamic sync payload\r\n  const orderData = {\r\n    order_number: orderPayload.order_number as string,\r\n    order_type: orderPayload.order_type as 'dine_in' | 'takeaway' | 'delivery' | 'b2b',\r\n    table_number: orderPayload.table_number as string | null,\r\n    customer_id: orderPayload.customer_id as string | null,\r\n    subtotal: orderPayload.subtotal as number,\r\n    discount_amount: orderPayload.discount_amount as number | null,\r\n    discount_type: orderPayload.discount_type as 'percentage' | 'fixed' | 'free' | null,\r\n    total: orderPayload.total as number,\r\n    tax_amount: orderPayload.tax_amount as number | null,\r\n    payment_status: orderPayload.payment_status as 'pending' | 'paid' | 'partial' | 'refunded',\r\n    payment_method: orderPayload.payment_method as string | null,\r\n    notes: orderPayload.notes as string | null,\r\n    pos_terminal_id: orderPayload.pos_terminal_id as string | null,\r\n  };\r\n\r\n  // Insert order\r\n  const { data: order, error: orderError } = await supabase\r\n    .from('orders')\r\n    .insert(orderData as never)\r\n    .select()\r\n    .single();\r\n\r\n  if (orderError) {\r\n    throw new Error(`Failed to sync order: ${orderError.message}`);\r\n  }\r\n\r\n  // Insert order items\r\n  const items = orderPayload.items as Array<Record<string, unknown>>;\r\n  if (items && items.length > 0) {\r\n    const orderItems = items.map((orderItem) => ({\r\n      order_id: order.id,\r\n      product_id: orderItem.product_id as string,\r\n      product_name: orderItem.product_name as string,\r\n      quantity: orderItem.quantity as number,\r\n      unit_price: orderItem.unit_price as number,\r\n      total_price: orderItem.total_price as number,\r\n      modifiers: orderItem.modifiers ?? null,\r\n    }));\r\n\r\n    const { error: itemsError } = await supabase\r\n      .from('order_items')\r\n      .insert(orderItems as never);\r\n\r\n    if (itemsError) {\r\n      console.error('[SyncEngine] Error inserting order items:', itemsError);\r\n      // Don't throw - order was created successfully\r\n    }\r\n  }\r\n\r\n  // Mark the offline order as synced\r\n  const offlineOrderId = orderPayload.id as string;\r\n  if (offlineOrderId) {\r\n    await markOrderSynced(offlineOrderId, order.id);\r\n  }\r\n\r\n  console.log(`[SyncEngine] Order ${orderPayload.order_number} synced as ${order.id}`);\r\n}\r\n\r\n/**\r\n * Sync a single payment to Supabase\r\n */\r\nasync function syncPayment(_item: ISyncQueueItem): Promise<void> {\r\n  // Payment sync logic - would depend on payment structure\r\n  // For now, payments are part of orders\r\n  console.log('[SyncEngine] Payment sync not yet implemented (part of order sync)');\r\n}\r\n\r\n/**\r\n * Sync a single stock movement to Supabase\r\n */\r\nasync function syncStockMovement(item: ISyncQueueItem): Promise<void> {\r\n  const movementPayload = item.payload as Record<string, unknown>;\r\n\r\n  // stock_movements requires movement_id, stock_before, stock_after\r\n  const movementId = `OFF-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n  type MovementType = 'transfer' | 'purchase' | 'production_in' | 'production_out' | 'sale_pos' | 'sale_b2b' | 'adjustment_in' | 'adjustment_out' | 'waste';\r\n  const { error } = await supabase.from('stock_movements').insert({\r\n    movement_id: movementId,\r\n    product_id: movementPayload.product_id as string,\r\n    movement_type: (movementPayload.movement_type || 'adjustment_out') as MovementType,\r\n    quantity: movementPayload.quantity as number,\r\n    reason: movementPayload.reason as string | null,\r\n    reference_id: movementPayload.reference_id as string | null,\r\n    stock_before: (movementPayload.stock_before as number) ?? 0,\r\n    stock_after: (movementPayload.stock_after as number) ?? 0,\r\n    unit: (movementPayload.unit as string) || 'pcs',\r\n  });\r\n\r\n  if (error) {\r\n    throw new Error(`Failed to sync stock movement: ${error.message}`);\r\n  }\r\n\r\n  console.log('[SyncEngine] Stock movement synced');\r\n}\r\n\r\n/**\r\n * Sync a single product to Supabase\r\n */\r\nasync function syncProduct(item: ISyncQueueItem): Promise<void> {\r\n  const { error } = await supabase.from('products').upsert(item.payload as never);\r\n  if (error) {\r\n    throw new Error(`Failed to sync product: ${error.message}`);\r\n  }\r\n  console.log(`[SyncEngine] Product ${item.entityId || 'unknown'} synced`);\r\n}\r\n\r\n/**\r\n * Sync a single category to Supabase\r\n */\r\nasync function syncCategory(item: ISyncQueueItem): Promise<void> {\r\n  const { error } = await supabase.from('categories').upsert(item.payload as never);\r\n  if (error) {\r\n    throw new Error(`Failed to sync category: ${error.message}`);\r\n  }\r\n  console.log(`[SyncEngine] Category ${item.entityId || 'unknown'} synced`);\r\n}\r\n\r\n/**\r\n * Sync a single product category price to Supabase\r\n */\r\nasync function syncProductCategoryPrice(item: ISyncQueueItem): Promise<void> {\r\n  const { error } = await supabase.from('product_category_prices').upsert(item.payload as never);\r\n  if (error) {\r\n    throw new Error(`Failed to sync product category price: ${error.message}`);\r\n  }\r\n  console.log(`[SyncEngine] Product category price ${item.entityId || 'unknown'} synced`);\r\n}\r\n\r\n/**\r\n * Process a single sync queue item\r\n */\r\nasync function processItem(item: ISyncQueueItem): Promise<boolean> {\r\n  try {\r\n    await markSyncing(item.id);\r\n\r\n    switch (item.type) {\r\n      case 'order':\r\n        await syncOrder(item);\r\n        break;\r\n      case 'payment':\r\n        await syncPayment(item);\r\n        break;\r\n      case 'stock_movement':\r\n        await syncStockMovement(item);\r\n        break;\r\n      case 'product':\r\n        await syncProduct(item);\r\n        break;\r\n      case 'category':\r\n        await syncCategory(item);\r\n        break;\r\n      case 'product_category_price':\r\n        await syncProductCategoryPrice(item);\r\n        break;\r\n      default:\r\n        console.warn(`[SyncEngine] Unknown item type: ${item.type}`);\r\n    }\r\n\r\n    await markSynced(item.id);\r\n    engineState.itemsSynced++;\r\n    return true;\r\n  } catch (error) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n    await markFailed(item.id, errorMessage);\r\n    engineState.itemsFailed++;\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Run the sync engine\r\n * Processes all pending items in the queue\r\n */\r\nexport async function runSyncEngine(): Promise<{\r\n  synced: number;\r\n  failed: number;\r\n}> {\r\n  if (engineState.isRunning) {\r\n    console.log('[SyncEngine] Already running');\r\n    return { synced: 0, failed: 0 };\r\n  }\r\n\r\n  engineState.isRunning = true;\r\n  engineState.itemsSynced = 0;\r\n  engineState.itemsFailed = 0;\r\n\r\n  // Update sync store status (Story 3.5)\r\n  const syncStore = useSyncStore.getState();\r\n  syncStore.setIsSyncing(true);\r\n  syncStore.setSyncStatus('syncing');\r\n\r\n  console.log('[SyncEngine] Starting sync...');\r\n\r\n  try {\r\n    // Get pending items\r\n    const pendingItems = await getSyncQueueItems('pending');\r\n    console.log(`[SyncEngine] Found ${pendingItems.length} pending items`);\r\n\r\n    // Process pending items\r\n    for (const item of pendingItems) {\r\n      await processItem(item);\r\n      // Small delay between items to avoid overwhelming the server\r\n      await new Promise((resolve) => setTimeout(resolve, ITEM_PROCESS_DELAY));\r\n    }\r\n\r\n    // Get retryable failed items\r\n    const retryableItems = await getRetryableItems();\r\n    console.log(`[SyncEngine] Found ${retryableItems.length} retryable items`);\r\n\r\n    // Process retryable items\r\n    for (const item of retryableItems) {\r\n      await processItem(item);\r\n      await new Promise((resolve) => setTimeout(resolve, ITEM_PROCESS_DELAY));\r\n    }\r\n\r\n    // Cleanup synced items\r\n    await cleanupSyncedItems();\r\n\r\n    engineState.lastSyncAt = new Date();\r\n\r\n    // Update sync store with results (Story 3.5)\r\n    const finalStatus = engineState.itemsFailed > 0 ? 'error' : 'complete';\r\n    syncStore.setSyncStatus(finalStatus);\r\n    syncStore.setLastSyncAt(engineState.lastSyncAt);\r\n\r\n    console.log(\r\n      `[SyncEngine] Sync complete: ${engineState.itemsSynced} synced, ${engineState.itemsFailed} failed`\r\n    );\r\n\r\n    return {\r\n      synced: engineState.itemsSynced,\r\n      failed: engineState.itemsFailed,\r\n    };\r\n  } catch (error) {\r\n    console.error('[SyncEngine] Error during sync:', error);\r\n    syncStore.setSyncStatus('error');\r\n    throw error;\r\n  } finally {\r\n    engineState.isRunning = false;\r\n    syncStore.setIsSyncing(false);\r\n  }\r\n}\r\n\r\n/**\r\n * Start sync engine with delay (called when going online)\r\n * Per Story 2.5: Starts automatically within 5 seconds\r\n */\r\nexport function startSyncWithDelay(): void {\r\n  // C-5: Clear any existing delay timeout before starting new one\r\n  if (startDelayTimeoutId) {\r\n    clearTimeout(startDelayTimeoutId);\r\n  }\r\n\r\n  console.log(`[SyncEngine] Will start sync in ${SYNC_START_DELAY / 1000}s`);\r\n  startDelayTimeoutId = setTimeout(() => {\r\n    startDelayTimeoutId = null;\r\n    runSyncEngine().catch((err) => {\r\n      console.error('[SyncEngine] Error during sync:', err);\r\n    });\r\n  }, SYNC_START_DELAY);\r\n}\r\n\r\n/**\r\n * Stop the sync engine\r\n *\r\n * C-5: Properly cleans up all timers before stopping\r\n */\r\nexport function stopSyncEngine(): void {\r\n  // C-5: Clear delay timeout if pending\r\n  if (startDelayTimeoutId) {\r\n    clearTimeout(startDelayTimeoutId);\r\n    startDelayTimeoutId = null;\r\n  }\r\n\r\n  // Stop background sync\r\n  stopBackgroundSync();\r\n\r\n  engineState.isRunning = false;\r\n  console.log('[SyncEngine] Stopped');\r\n}\r\n\r\n/**\r\n * Enable or disable automatic sync (Story 3.5)\r\n */\r\nexport function setAutoSyncEnabled(enabled: boolean): void {\r\n  autoSyncEnabled = enabled;\r\n  console.log(`[SyncEngine] Auto-sync ${enabled ? 'enabled' : 'disabled'}`);\r\n\r\n  if (enabled) {\r\n    startBackgroundSync();\r\n  } else {\r\n    stopBackgroundSync();\r\n  }\r\n}\r\n\r\n/**\r\n * Check if auto-sync is enabled\r\n */\r\nexport function isAutoSyncEnabled(): boolean {\r\n  return autoSyncEnabled;\r\n}\r\n\r\n/**\r\n * Start background sync interval (Story 3.5)\r\n * Runs sync automatically every BACKGROUND_SYNC_INTERVAL ms when online\r\n */\r\nexport function startBackgroundSync(): void {\r\n  if (backgroundSyncIntervalId) {\r\n    console.log('[SyncEngine] Background sync already running');\r\n    return;\r\n  }\r\n\r\n  console.log(`[SyncEngine] Starting background sync (every ${BACKGROUND_SYNC_INTERVAL / 1000}s)`);\r\n\r\n  backgroundSyncIntervalId = setInterval(async () => {\r\n    // Only sync if online and auto-sync is enabled\r\n    const isOnline = useNetworkStore.getState().isOnline;\r\n\r\n    if (!isOnline) {\r\n      console.log('[SyncEngine] Skipping background sync - offline');\r\n      return;\r\n    }\r\n\r\n    if (!autoSyncEnabled) {\r\n      console.log('[SyncEngine] Skipping background sync - disabled');\r\n      return;\r\n    }\r\n\r\n    if (engineState.isRunning) {\r\n      console.log('[SyncEngine] Skipping background sync - already running');\r\n      return;\r\n    }\r\n\r\n    // Check if there are pending items before running\r\n    const pendingItems = await getSyncQueueItems('pending');\r\n    if (pendingItems.length === 0) {\r\n      // No pending items, no need to sync\r\n      return;\r\n    }\r\n\r\n    console.log(`[SyncEngine] Background sync triggered - ${pendingItems.length} pending items`);\r\n    await runSyncEngine();\r\n  }, BACKGROUND_SYNC_INTERVAL);\r\n}\r\n\r\n/**\r\n * Stop background sync interval\r\n */\r\nexport function stopBackgroundSync(): void {\r\n  if (backgroundSyncIntervalId) {\r\n    clearInterval(backgroundSyncIntervalId);\r\n    backgroundSyncIntervalId = null;\r\n    console.log('[SyncEngine] Background sync stopped');\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize the sync engine (Story 3.5)\r\n * Should be called once when the app starts\r\n */\r\nexport function initializeSyncEngine(): void {\r\n  console.log('[SyncEngine] Initializing...');\r\n\r\n  // Start background sync\r\n  startBackgroundSync();\r\n\r\n  // Subscribe to network changes\r\n  useNetworkStore.subscribe((state, prevState) => {\r\n    if (state.isOnline && !prevState.isOnline) {\r\n      // Coming back online\r\n      console.log('[SyncEngine] Network restored - scheduling sync');\r\n      startSyncWithDelay();\r\n    }\r\n  });\r\n\r\n  console.log('[SyncEngine] Initialized');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncEngineV2.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'engineState' is never reassigned. Use 'const' instead.","line":63,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":63,"endColumn":34,"fix":{"range":[1958,2079],"text":"const engineState: ISyncEngineState = {\r\n  isRunning: false,\r\n  lastSyncAt: null,\r\n  itemsSynced: 0,\r\n  itemsFailed: 0,\r\n};"}},{"ruleId":"prefer-const","severity":2,"message":"'sessionIdMap' is never reassigned. Use 'const' instead.","line":76,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":76,"endColumn":38,"fix":{"range":[2362,2412],"text":"const sessionIdMap: Map<string, string> = new Map();"}},{"ruleId":"prefer-const","severity":2,"message":"'orderIdMap' is never reassigned. Use 'const' instead.","line":77,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":77,"endColumn":36,"fix":{"range":[2414,2462],"text":"const orderIdMap: Map<string, string> = new Map();"}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":3,"fixableWarningCount":0,"source":"/**\r\n * Sync Engine V2 (Story 3.6)\r\n *\r\n * Refactored sync engine using db.ts (offline_sync_queue) instead of legacy offlineDb.\r\n * Processes sync queue items in dependency order: Sessions → Orders → Payments.\r\n *\r\n * Features:\r\n * - FIFO processing with dependency ordering\r\n * - Exponential backoff for retries\r\n * - ID remapping for FK relationships\r\n * - Background polling every 30 seconds\r\n * - Automatic start after network reconnection (5s delay)\r\n *\r\n * @see ADR-002: Stratégie de Synchronisation\r\n * @see Story 3.6: Sync Queue Processing\r\n */\r\n\r\nimport { useSyncStore } from '@/stores/syncStore';\r\nimport { useNetworkStore } from '@/stores/networkStore';\r\nimport type { ISyncQueueItem, TSyncEntity } from '@/types/offline';\r\n\r\nimport {\r\n  getItemsToSync,\r\n  sortQueueByDependency,\r\n  markSyncing,\r\n  markSynced,\r\n  markFailed,\r\n  cleanupCompletedItems,\r\n  recoverOrphanedSyncingItems,\r\n  getPendingSyncCount,\r\n} from './syncQueueHelpers';\r\n\r\nimport { processSessionSync, updateOrdersWithSessionServerId } from './sessionSyncProcessor';\r\nimport { processOrderSync } from './orderSyncProcessor';\r\nimport { processPaymentSync } from './paymentSyncProcessor';\r\nimport { syncStockLevelsToOffline } from './stockSync';\r\nimport { syncPromotionsToOffline } from './promotionSync';\r\n\r\n// =====================================================\r\n// Constants\r\n// =====================================================\r\n\r\n/** Delay before starting sync after going online (5 seconds) */\r\nconst SYNC_START_DELAY = 5000;\r\n\r\n/** Minimum delay between processing items */\r\nconst ITEM_PROCESS_DELAY = 100;\r\n\r\n/** Background sync interval (30 seconds) */\r\nconst BACKGROUND_SYNC_INTERVAL = 30000;\r\n\r\n// =====================================================\r\n// Engine State\r\n// =====================================================\r\n\r\ninterface ISyncEngineState {\r\n  isRunning: boolean;\r\n  lastSyncAt: Date | null;\r\n  itemsSynced: number;\r\n  itemsFailed: number;\r\n}\r\n\r\nlet engineState: ISyncEngineState = {\r\n  isRunning: false,\r\n  lastSyncAt: null,\r\n  itemsSynced: 0,\r\n  itemsFailed: 0,\r\n};\r\n\r\nlet backgroundSyncIntervalId: ReturnType<typeof setInterval> | null = null;\r\n/** C-5: Store delay timeout ID for cleanup */\r\nlet startDelayTimeoutId: ReturnType<typeof setTimeout> | null = null;\r\nlet autoSyncEnabled = true;\r\n\r\n// ID mappings for FK resolution during batch sync\r\nlet sessionIdMap: Map<string, string> = new Map();\r\nlet orderIdMap: Map<string, string> = new Map();\r\n\r\n// =====================================================\r\n// Engine State Accessors\r\n// =====================================================\r\n\r\n/**\r\n * Get current sync engine state\r\n */\r\nexport function getSyncEngineState(): ISyncEngineState {\r\n  return { ...engineState };\r\n}\r\n\r\n/**\r\n * Check if auto-sync is enabled\r\n */\r\nexport function isAutoSyncEnabled(): boolean {\r\n  return autoSyncEnabled;\r\n}\r\n\r\n// =====================================================\r\n// Item Processing\r\n// =====================================================\r\n\r\n/**\r\n * Process a single sync queue item based on its entity type\r\n *\r\n * Routes to the appropriate processor and updates ID mappings.\r\n *\r\n * @param item - Sync queue item to process\r\n * @returns true if sync succeeded\r\n */\r\nasync function processItem(item: ISyncQueueItem): Promise<boolean> {\r\n  if (item.id === undefined) return false;\r\n\r\n  try {\r\n    await markSyncing(item.id);\r\n\r\n    let result;\r\n    const entity = item.entity as TSyncEntity;\r\n\r\n    switch (entity) {\r\n      case 'pos_sessions':\r\n        result = await processSessionSync(item);\r\n        if (result.success && result.serverId) {\r\n          sessionIdMap.set(item.entityId, result.serverId);\r\n          // Update orders that reference this session\r\n          await updateOrdersWithSessionServerId(item.entityId, result.serverId);\r\n        }\r\n        break;\r\n\r\n      case 'orders':\r\n        result = await processOrderSync(item, sessionIdMap);\r\n        if (result.success && result.serverId) {\r\n          orderIdMap.set(item.entityId, result.serverId);\r\n        }\r\n        break;\r\n\r\n      case 'payments':\r\n        result = await processPaymentSync(item, orderIdMap);\r\n        break;\r\n\r\n      default:\r\n        console.warn(`[SyncEngineV2] Unknown entity type: ${entity}`);\r\n        result = { success: false, error: `Unknown entity type: ${entity}` };\r\n    }\r\n\r\n    if (result.success) {\r\n      await markSynced(item.id);\r\n      engineState.itemsSynced++;\r\n      return true;\r\n    } else {\r\n      await markFailed(item.id, result.error || 'Unknown error');\r\n      engineState.itemsFailed++;\r\n      return false;\r\n    }\r\n  } catch (error) {\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n    if (item.id !== undefined) {\r\n      await markFailed(item.id, errorMessage);\r\n    }\r\n    engineState.itemsFailed++;\r\n    return false;\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Main Sync Engine\r\n// =====================================================\r\n\r\n/**\r\n * Run the sync engine\r\n *\r\n * Processes all pending and retryable items in dependency order.\r\n * Updates sync store with progress.\r\n *\r\n * @returns Promise with sync results\r\n */\r\nexport async function runSyncEngine(): Promise<{\r\n  synced: number;\r\n  failed: number;\r\n}> {\r\n  if (engineState.isRunning) {\r\n    console.log('[SyncEngineV2] Already running');\r\n    return { synced: 0, failed: 0 };\r\n  }\r\n\r\n  engineState.isRunning = true;\r\n  engineState.itemsSynced = 0;\r\n  engineState.itemsFailed = 0;\r\n\r\n  // Reset ID mappings for this batch\r\n  sessionIdMap.clear();\r\n  orderIdMap.clear();\r\n\r\n  // Update sync store status\r\n  const syncStore = useSyncStore.getState();\r\n  syncStore.setIsSyncing(true);\r\n  syncStore.setSyncStatus('syncing');\r\n\r\n  console.log('[SyncEngineV2] Starting sync...');\r\n\r\n  try {\r\n    // Get all items that need syncing\r\n    const items = await getItemsToSync();\r\n\r\n    if (items.length === 0) {\r\n      console.log('[SyncEngineV2] No items to sync');\r\n      return { synced: 0, failed: 0 };\r\n    }\r\n\r\n    // Sort by dependency (sessions → orders → payments)\r\n    const sortedItems = sortQueueByDependency(items);\r\n    console.log(`[SyncEngineV2] Processing ${sortedItems.length} items`);\r\n\r\n    // Process items in order\r\n    for (const item of sortedItems) {\r\n      await processItem(item);\r\n      // Small delay between items to avoid overwhelming the server\r\n      await new Promise((resolve) => setTimeout(resolve, ITEM_PROCESS_DELAY));\r\n    }\r\n\r\n    // Cleanup completed items\r\n    const cleaned = await cleanupCompletedItems();\r\n    if (cleaned > 0) {\r\n      console.log(`[SyncEngineV2] Cleaned ${cleaned} completed items`);\r\n    }\r\n\r\n    engineState.lastSyncAt = new Date();\r\n\r\n    // Update sync store with results\r\n    const finalStatus = engineState.itemsFailed > 0 ? 'error' : 'complete';\r\n    syncStore.setSyncStatus(finalStatus);\r\n    syncStore.setLastSyncAt(engineState.lastSyncAt);\r\n\r\n    console.log(\r\n      `[SyncEngineV2] Sync complete: ${engineState.itemsSynced} synced, ${engineState.itemsFailed} failed`\r\n    );\r\n\r\n    return {\r\n      synced: engineState.itemsSynced,\r\n      failed: engineState.itemsFailed,\r\n    };\r\n  } catch (error) {\r\n    console.error('[SyncEngineV2] Error during sync:', error);\r\n    syncStore.setSyncStatus('error');\r\n    throw error;\r\n  } finally {\r\n    engineState.isRunning = false;\r\n    syncStore.setIsSyncing(false);\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Auto-Sync Control\r\n// =====================================================\r\n\r\n/**\r\n * Start sync engine with delay (called when going online)\r\n *\r\n * Per Story requirements: Starts automatically within 5 seconds\r\n */\r\nexport function startSyncWithDelay(): void {\r\n  // C-5: Clear any existing delay timeout before starting new one\r\n  if (startDelayTimeoutId) {\r\n    clearTimeout(startDelayTimeoutId);\r\n  }\r\n\r\n  console.log(`[SyncEngineV2] Will start sync in ${SYNC_START_DELAY / 1000}s`);\r\n  startDelayTimeoutId = setTimeout(() => {\r\n    startDelayTimeoutId = null;\r\n    runSyncEngine().catch((err) => {\r\n      console.error('[SyncEngineV2] Error during sync:', err);\r\n    });\r\n  }, SYNC_START_DELAY);\r\n}\r\n\r\n/**\r\n * Stop the sync engine\r\n *\r\n * C-5: Properly cleans up all timers before stopping\r\n */\r\nexport function stopSyncEngine(): void {\r\n  // C-5: Clear delay timeout if pending\r\n  if (startDelayTimeoutId) {\r\n    clearTimeout(startDelayTimeoutId);\r\n    startDelayTimeoutId = null;\r\n  }\r\n\r\n  // Stop background sync\r\n  stopBackgroundSync();\r\n\r\n  engineState.isRunning = false;\r\n  console.log('[SyncEngineV2] Stopped');\r\n}\r\n\r\n/**\r\n * Enable or disable automatic sync\r\n *\r\n * @param enabled - Whether to enable auto-sync\r\n */\r\nexport function setAutoSyncEnabled(enabled: boolean): void {\r\n  autoSyncEnabled = enabled;\r\n  console.log(`[SyncEngineV2] Auto-sync ${enabled ? 'enabled' : 'disabled'}`);\r\n\r\n  if (enabled) {\r\n    startBackgroundSync();\r\n  } else {\r\n    stopBackgroundSync();\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Background Sync\r\n// =====================================================\r\n\r\n/**\r\n * Start background sync interval\r\n *\r\n * Runs sync automatically every BACKGROUND_SYNC_INTERVAL ms when online.\r\n */\r\nexport function startBackgroundSync(): void {\r\n  if (backgroundSyncIntervalId) {\r\n    console.log('[SyncEngineV2] Background sync already running');\r\n    return;\r\n  }\r\n\r\n  console.log(\r\n    `[SyncEngineV2] Starting background sync (every ${BACKGROUND_SYNC_INTERVAL / 1000}s)`\r\n  );\r\n\r\n  backgroundSyncIntervalId = setInterval(async () => {\r\n    // Only sync if online and auto-sync is enabled\r\n    const isOnline = useNetworkStore.getState().isOnline;\r\n\r\n    if (!isOnline) {\r\n      return; // Silent skip when offline\r\n    }\r\n\r\n    if (!autoSyncEnabled) {\r\n      return; // Silent skip when disabled\r\n    }\r\n\r\n    if (engineState.isRunning) {\r\n      return; // Silent skip when already running\r\n    }\r\n\r\n    // Check if there are pending items before running\r\n    const pendingCount = await getPendingSyncCount();\r\n    if (pendingCount === 0) {\r\n      return; // No pending items\r\n    }\r\n\r\n    console.log(\r\n      `[SyncEngineV2] Background sync triggered - ${pendingCount} pending items`\r\n    );\r\n    await runSyncEngine();\r\n  }, BACKGROUND_SYNC_INTERVAL);\r\n}\r\n\r\n/**\r\n * Stop background sync interval\r\n */\r\nexport function stopBackgroundSync(): void {\r\n  if (backgroundSyncIntervalId) {\r\n    clearInterval(backgroundSyncIntervalId);\r\n    backgroundSyncIntervalId = null;\r\n    console.log('[SyncEngineV2] Background sync stopped');\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// Initialization\r\n// =====================================================\r\n\r\n/**\r\n * Initialize the sync engine\r\n *\r\n * Should be called once when the app starts.\r\n * - Recovers orphaned 'syncing' items\r\n * - Starts background sync\r\n * - Subscribes to network changes\r\n */\r\nexport async function initializeSyncEngine(): Promise<void> {\r\n  console.log('[SyncEngineV2] Initializing...');\r\n\r\n  // Recover any items stuck in 'syncing' state from previous session\r\n  const recovered = await recoverOrphanedSyncingItems();\r\n  if (recovered > 0) {\r\n    console.log(`[SyncEngineV2] Recovered ${recovered} orphaned items`);\r\n  }\r\n\r\n  // Start background sync\r\n  startBackgroundSync();\r\n\r\n  // Subscribe to network changes\r\n  useNetworkStore.subscribe((state, prevState) => {\r\n    if (state.isOnline && !prevState.isOnline) {\r\n      // Coming back online\r\n      console.log('[SyncEngineV2] Network restored - scheduling sync');\r\n      startSyncWithDelay();\r\n\r\n      // Refresh read-only caches (stock levels per Story 5.1)\r\n      refreshReadOnlyCaches().catch((err) => {\r\n        console.error('[SyncEngineV2] Error refreshing caches:', err);\r\n      });\r\n    }\r\n  });\r\n\r\n  console.log('[SyncEngineV2] Initialized');\r\n}\r\n\r\n/**\r\n * Refresh read-only caches when coming back online\r\n *\r\n * Called after network reconnection to update cached data.\r\n * Per Story 5.1: Stock levels auto-refresh on reconnect.\r\n * Per Story 6.4: Promotions auto-refresh on reconnect.\r\n */\r\nasync function refreshReadOnlyCaches(): Promise<void> {\r\n  console.log('[SyncEngineV2] Refreshing read-only caches...');\r\n\r\n  try {\r\n    // Stock levels (Story 5.1)\r\n    const stockCount = await syncStockLevelsToOffline();\r\n    console.log(`[SyncEngineV2] Stock levels refreshed: ${stockCount} items`);\r\n  } catch (error) {\r\n    console.error('[SyncEngineV2] Error refreshing stock levels:', error);\r\n  }\r\n\r\n  try {\r\n    // Promotions (Story 6.4)\r\n    const promotionCount = await syncPromotionsToOffline();\r\n    console.log(`[SyncEngineV2] Promotions refreshed: ${promotionCount} items`);\r\n  } catch (error) {\r\n    console.error('[SyncEngineV2] Error refreshing promotions:', error);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncQueue.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncQueue.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1628,1631],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1628,1631],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\services\\sync\\syncQueueHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\setupTests.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\__tests__\\cartStoreCombo.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3999,4002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3999,4002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeEach } from 'vitest'\r\nimport { useCartStore, type ComboSelectedItem } from '../cartStore'\r\nimport type { ProductCombo } from '../../types/database'\r\n\r\nfunction makeCombo(overrides: Partial<ProductCombo> = {}): ProductCombo {\r\n    return {\r\n        id: 'combo-1',\r\n        name: 'Breakfast Combo',\r\n        description: 'Coffee + Croissant',\r\n        combo_price: 45000,\r\n        is_active: true,\r\n        available_at_pos: true,\r\n        sort_order: 1,\r\n        company_id: 'company-1',\r\n        created_at: '2026-01-01',\r\n        updated_at: '2026-01-01',\r\n        ...overrides,\r\n    } as ProductCombo\r\n}\r\n\r\nfunction makeSelections(): ComboSelectedItem[] {\r\n    return [\r\n        {\r\n            group_id: 'g1',\r\n            group_name: 'Beverage',\r\n            item_id: 'item-1',\r\n            product_id: 'prod-espresso',\r\n            product_name: 'Espresso',\r\n            price_adjustment: 0,\r\n        },\r\n        {\r\n            group_id: 'g2',\r\n            group_name: 'Pastry',\r\n            item_id: 'item-2',\r\n            product_id: 'prod-croissant',\r\n            product_name: 'Croissant',\r\n            price_adjustment: 0,\r\n        },\r\n    ]\r\n}\r\n\r\ndescribe('cartStore combo integration', () => {\r\n    beforeEach(() => {\r\n        useCartStore.getState().clearCart()\r\n    })\r\n\r\n    it('adds a combo to cart', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n\r\n        const state = useCartStore.getState()\r\n        expect(state.items).toHaveLength(1)\r\n        expect(state.items[0].type).toBe('combo')\r\n        expect(state.items[0].combo?.name).toBe('Breakfast Combo')\r\n        expect(state.items[0].comboSelections).toHaveLength(2)\r\n        expect(state.items[0].totalPrice).toBe(45000)\r\n    })\r\n\r\n    it('adds combo with price adjustments', () => {\r\n        const combo = makeCombo()\r\n        const selections: ComboSelectedItem[] = [\r\n            {\r\n                group_id: 'g1',\r\n                group_name: 'Beverage',\r\n                item_id: 'item-1',\r\n                product_id: 'prod-latte',\r\n                product_name: 'Oat Milk Latte',\r\n                price_adjustment: 5000,\r\n            },\r\n            {\r\n                group_id: 'g2',\r\n                group_name: 'Pastry',\r\n                item_id: 'item-2',\r\n                product_id: 'prod-croissant',\r\n                product_name: 'Croissant',\r\n                price_adjustment: 0,\r\n            },\r\n        ]\r\n\r\n        // totalPrice already includes adjustments (45000 base + 5000 adjustment)\r\n        useCartStore.getState().addCombo(combo, 1, selections, 50000, '')\r\n\r\n        const state = useCartStore.getState()\r\n        expect(state.items[0].totalPrice).toBe(50000)\r\n        expect(state.items[0].comboSelections?.[0].price_adjustment).toBe(5000)\r\n    })\r\n\r\n    it('adds combo with quantity > 1', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 2, selections, 45000, '')\r\n\r\n        const state = useCartStore.getState()\r\n        expect(state.items[0].quantity).toBe(2)\r\n        expect(state.items[0].totalPrice).toBe(90000)\r\n    })\r\n\r\n    it('adds combo with notes', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, 'No sugar')\r\n\r\n        const state = useCartStore.getState()\r\n        expect(state.items[0].notes).toBe('No sugar')\r\n    })\r\n\r\n    it('calculates subtotal correctly with combos and products', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        // Add a combo\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n\r\n        // Add a regular product\r\n        useCartStore.getState().addItem(\r\n            { id: 'prod-1', name: 'Brownie', retail_price: 25000 } as any,\r\n            1,\r\n            [],\r\n            '',\r\n            undefined\r\n        )\r\n\r\n        const state = useCartStore.getState()\r\n        expect(state.items).toHaveLength(2)\r\n        expect(state.subtotal).toBe(70000)\r\n    })\r\n\r\n    it('removes combo from cart', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n        const itemId = useCartStore.getState().items[0].id\r\n\r\n        useCartStore.getState().removeItem(itemId)\r\n\r\n        expect(useCartStore.getState().items).toHaveLength(0)\r\n    })\r\n\r\n    it('updates combo quantity', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n        const itemId = useCartStore.getState().items[0].id\r\n\r\n        useCartStore.getState().updateItemQuantity(itemId, 3)\r\n\r\n        const state = useCartStore.getState()\r\n        expect(state.items[0].quantity).toBe(3)\r\n        expect(state.items[0].totalPrice).toBe(135000)\r\n    })\r\n\r\n    it('clears cart removes combos', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n        useCartStore.getState().clearCart()\r\n\r\n        expect(useCartStore.getState().items).toHaveLength(0)\r\n    })\r\n\r\n    it('combo item id starts with combo- prefix', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n\r\n        expect(useCartStore.getState().items[0].id).toMatch(/^combo-/)\r\n    })\r\n\r\n    it('combo modifiers array is empty', () => {\r\n        const combo = makeCombo()\r\n        const selections = makeSelections()\r\n\r\n        useCartStore.getState().addCombo(combo, 1, selections, 45000, '')\r\n\r\n        expect(useCartStore.getState().items[0].modifiers).toHaveLength(0)\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\authStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\cartStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\displayStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\lanStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\mobileStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\networkStore.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\networkStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\orderStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\paymentStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\settingsStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\syncStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\terminalStore.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\stores\\terminalStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\database.backup.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":1584,"column":16,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":1586,"endColumn":10,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[66719,66787],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[66719,66787],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Database Types for Supabase\r\n// These types will be auto-generated from Supabase schema, but we define them manually for now\r\n\r\nexport type Json =\r\n    | string\r\n    | number\r\n    | boolean\r\n    | null\r\n    | { [key: string]: Json | undefined }\r\n    | Json[]\r\n\r\nexport interface Database {\r\n    public: {\r\n        Tables: {\r\n            categories: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    icon: string | null\r\n                    color: string | null\r\n                    dispatch_station: 'barista' | 'kitchen' | 'display' | 'none' | null\r\n                    is_raw_material: boolean\r\n                    sort_order: number\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['categories']['Row']> & { name: string }\r\n                Update: Partial<Database['public']['Tables']['categories']['Row']>\r\n            }\r\n            products: {\r\n                Row: {\r\n                    id: string\r\n                    sku: string\r\n                    name: string\r\n                    description: string | null\r\n                    category_id: string | null\r\n                    product_type: 'finished' | 'semi_finished' | 'raw_material'\r\n                    retail_price: number | null\r\n                    wholesale_price: number | null\r\n                    cost_price: number | null\r\n                    current_stock: number\r\n                    min_stock_level: number\r\n                    unit: string\r\n                    pos_visible: boolean\r\n                    available_for_sale: boolean\r\n                    image_url: string | null\r\n                    is_active: boolean\r\n                    default_producing_section_id: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['products']['Row']> & { sku: string, name: string }\r\n                Update: Partial<Database['public']['Tables']['products']['Row']>\r\n            }\r\n            product_modifiers: {\r\n                Row: {\r\n                    id: string\r\n                    product_id: string | null\r\n                    category_id: string | null\r\n                    group_name: string\r\n                    group_type: 'single' | 'multiple'\r\n                    group_required: boolean\r\n                    group_sort_order: number\r\n                    option_id: string\r\n                    option_label: string\r\n                    option_icon: string | null\r\n                    price_adjustment: number\r\n                    is_default: boolean\r\n                    option_sort_order: number\r\n                    is_active: boolean\r\n                    created_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['product_modifiers']['Row']> & { group_name: string, option_id: string, option_label: string }\r\n                Update: Partial<Database['public']['Tables']['product_modifiers']['Row']>\r\n            }\r\n            suppliers: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    contact_person: string | null\r\n                    email: string | null\r\n                    phone: string | null\r\n                    address: string | null\r\n                    city: string | null\r\n                    postal_code: string | null\r\n                    country: string | null\r\n                    tax_id: string | null\r\n                    payment_terms: string | null\r\n                    notes: string | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    name: string\r\n                    contact_person?: string | null\r\n                    email?: string | null\r\n                    phone?: string | null\r\n                    address?: string | null\r\n                    city?: string | null\r\n                    postal_code?: string | null\r\n                    country?: string | null\r\n                    tax_id?: string | null\r\n                    payment_terms?: string | null\r\n                    notes?: string | null\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['suppliers']['Row']>\r\n            },\r\n            customers: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    phone: string | null\r\n                    email: string | null\r\n                    address: string | null\r\n                    customer_type: 'retail' | 'wholesale'\r\n                    company_name: string | null\r\n                    tax_id: string | null\r\n                    payment_terms: 'cod' | 'net15' | 'net30' | 'net60' | null\r\n                    credit_limit: number | null\r\n                    loyalty_points: number\r\n                    total_visits: number\r\n                    total_spent: number\r\n                    last_visit_at: string | null\r\n                    notes: string | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['customers']['Row']> & { name: string }\r\n                Update: Partial<Database['public']['Tables']['customers']['Row']>\r\n            }\r\n            pos_sessions: {\r\n                Row: {\r\n                    id: string\r\n                    session_number: string\r\n                    opened_at: string\r\n                    opened_by: string | null\r\n                    opening_cash: number\r\n                    opening_cash_details: Json | null\r\n                    closed_at: string | null\r\n                    closed_by: string | null\r\n                    closing_cash: number | null\r\n                    closing_cash_details: Json | null\r\n                    total_cash_sales: number\r\n                    total_card_sales: number\r\n                    total_qris_sales: number\r\n                    total_orders: number\r\n                    total_discounts: number\r\n                    total_refunds: number\r\n                    expected_cash: number | null\r\n                    cash_difference: number | null\r\n                    difference_reason: string | null\r\n                    tips_cash: number\r\n                    tips_card: number\r\n                    manager_validated: boolean\r\n                    manager_id: string | null\r\n                    notes: string | null\r\n                    status: 'open' | 'closed'\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['pos_sessions']['Row']> & { session_number: string }\r\n                Update: Partial<Database['public']['Tables']['pos_sessions']['Row']>\r\n            }\r\n            orders: {\r\n                Row: {\r\n                    id: string\r\n                    order_number: string\r\n                    order_type: 'dine_in' | 'takeaway' | 'delivery' | 'b2b'\r\n                    table_number: string | null\r\n                    customer_id: string | null\r\n                    customer_name: string | null\r\n                    status: 'new' | 'preparing' | 'ready' | 'served' | 'completed' | 'cancelled'\r\n                    payment_status: 'unpaid' | 'partial' | 'paid'\r\n                    subtotal: number\r\n                    discount_type: 'percentage' | 'fixed' | 'free' | null\r\n                    discount_value: number\r\n                    discount_amount: number\r\n                    discount_reason: string | null\r\n                    discount_requires_manager: boolean\r\n                    discount_manager_id: string | null\r\n                    tax_rate: number\r\n                    tax_amount: number\r\n                    total: number\r\n                    payment_method: 'cash' | 'card' | 'qris' | 'split' | 'transfer' | null\r\n                    payment_details: Json | null\r\n                    cash_received: number | null\r\n                    change_given: number | null\r\n                    points_earned: number\r\n                    points_used: number\r\n                    points_discount: number\r\n                    staff_id: string | null\r\n                    session_id: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                    completed_at: string | null\r\n                    cancelled_at: string | null\r\n                    cancelled_by: string | null\r\n                    cancellation_reason: string | null\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['orders']['Row']> & { order_number: string }\r\n                Update: Partial<Database['public']['Tables']['orders']['Row']>\r\n            }\r\n            order_items: {\r\n                Row: {\r\n                    id: string\r\n                    order_id: string\r\n                    product_id: string | null\r\n                    product_name: string\r\n                    product_sku: string | null\r\n                    quantity: number\r\n                    unit_price: number\r\n                    total_price: number\r\n                    modifiers: Json | null\r\n                    modifiers_total: number\r\n                    notes: string | null\r\n                    dispatch_station: 'barista' | 'kitchen' | 'display' | 'none' | null\r\n                    item_status: 'new' | 'preparing' | 'ready' | 'served'\r\n                    sent_to_kitchen_at: string | null\r\n                    prepared_at: string | null\r\n                    prepared_by: string | null\r\n                    served_at: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['order_items']['Row']> & { order_id: string, product_name: string }\r\n                Update: Partial<Database['public']['Tables']['order_items']['Row']>\r\n            }\r\n            user_profiles: {\r\n                Row: {\r\n                    id: string\r\n                    auth_user_id: string | null\r\n                    name: string\r\n                    role: 'admin' | 'manager' | 'cashier' | 'server' | 'barista' | 'kitchen' | 'backoffice'\r\n                    pin_code: string | null\r\n                    can_apply_discount: boolean\r\n                    can_cancel_order: boolean\r\n                    can_access_reports: boolean\r\n                    avatar_url: string | null\r\n                    is_active: boolean\r\n                    // New fields from migration 040\r\n                    employee_code: string | null\r\n                    first_name: string | null\r\n                    last_name: string | null\r\n                    display_name: string | null\r\n                    phone: string | null\r\n                    preferred_language: 'fr' | 'en' | 'id'\r\n                    timezone: string\r\n                    pin_hash: string | null\r\n                    last_login_at: string | null\r\n                    failed_login_attempts: number\r\n                    locked_until: string | null\r\n                    password_changed_at: string | null\r\n                    must_change_password: boolean\r\n                    created_by: string | null\r\n                    updated_by: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['user_profiles']['Row']> & { name: string, role: 'admin' | 'manager' | 'cashier' | 'server' | 'barista' | 'kitchen' | 'backoffice' }\r\n                Update: Partial<Database['public']['Tables']['user_profiles']['Row']>\r\n            }\r\n            roles: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    description: string | null\r\n                    is_system: boolean\r\n                    is_active: boolean\r\n                    hierarchy_level: number\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['roles']['Row']> & { code: string, name_fr: string, name_en: string, name_id: string }\r\n                Update: Partial<Database['public']['Tables']['roles']['Row']>\r\n            }\r\n            permissions: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    module: string\r\n                    action: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    description: string | null\r\n                    is_sensitive: boolean\r\n                    created_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['permissions']['Row']> & { code: string, module: string, action: string, name_fr: string, name_en: string, name_id: string }\r\n                Update: Partial<Database['public']['Tables']['permissions']['Row']>\r\n            }\r\n            role_permissions: {\r\n                Row: {\r\n                    id: string\r\n                    role_id: string\r\n                    permission_id: string\r\n                    granted_at: string\r\n                    granted_by: string | null\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['role_permissions']['Row']> & { role_id: string, permission_id: string }\r\n                Update: Partial<Database['public']['Tables']['role_permissions']['Row']>\r\n            }\r\n            user_roles: {\r\n                Row: {\r\n                    id: string\r\n                    user_id: string\r\n                    role_id: string\r\n                    is_primary: boolean\r\n                    valid_from: string | null\r\n                    valid_until: string | null\r\n                    assigned_at: string\r\n                    assigned_by: string | null\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['user_roles']['Row']> & { user_id: string, role_id: string }\r\n                Update: Partial<Database['public']['Tables']['user_roles']['Row']>\r\n            }\r\n            user_permissions: {\r\n                Row: {\r\n                    id: string\r\n                    user_id: string\r\n                    permission_id: string\r\n                    is_granted: boolean\r\n                    valid_from: string | null\r\n                    valid_until: string | null\r\n                    reason: string | null\r\n                    granted_at: string\r\n                    granted_by: string | null\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['user_permissions']['Row']> & { user_id: string, permission_id: string }\r\n                Update: Partial<Database['public']['Tables']['user_permissions']['Row']>\r\n            }\r\n            user_sessions: {\r\n                Row: {\r\n                    id: string\r\n                    user_id: string\r\n                    session_token: string\r\n                    device_type: 'desktop' | 'tablet' | 'pos' | null\r\n                    device_name: string | null\r\n                    ip_address: string | null\r\n                    user_agent: string | null\r\n                    started_at: string\r\n                    last_activity_at: string\r\n                    ended_at: string | null\r\n                    end_reason: 'logout' | 'timeout' | 'forced' | null\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['user_sessions']['Row']> & { user_id: string, session_token: string }\r\n                Update: Partial<Database['public']['Tables']['user_sessions']['Row']>\r\n            }\r\n            audit_logs: {\r\n                Row: {\r\n                    id: string\r\n                    user_id: string | null\r\n                    action: string\r\n                    module: string\r\n                    entity_type: string | null\r\n                    entity_id: string | null\r\n                    old_values: Record<string, unknown> | null\r\n                    new_values: Record<string, unknown> | null\r\n                    ip_address: string | null\r\n                    user_agent: string | null\r\n                    session_id: string | null\r\n                    severity: 'info' | 'warning' | 'critical'\r\n                    created_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['audit_logs']['Row']> & { action: string, module: string }\r\n                Update: Partial<Database['public']['Tables']['audit_logs']['Row']>\r\n            }\r\n            stock_movements: {\r\n                Row: {\r\n                    id: string\r\n                    product_id: string\r\n                    movement_type: 'purchase' | 'waste' | 'adjustment_in' | 'adjustment_out' | 'sale' | 'production'\r\n                    quantity: number\r\n                    reason: string | null\r\n                    notes: string | null\r\n                    staff_id: string | null\r\n                    reference_id: string | null\r\n                    from_section_id: string | null\r\n                    to_section_id: string | null\r\n                    supplier_id?: string | null\r\n                    created_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['stock_movements']['Row']> & { product_id: string, movement_type: 'purchase' | 'waste' | 'adjustment_in' | 'adjustment_out' | 'sale' | 'production', quantity: number, supplier_id?: string | null }\r\n                Update: Partial<Database['public']['Tables']['stock_movements']['Row']>\r\n            },\r\n            sections: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    slug: string\r\n                    is_sales_point: boolean\r\n                    is_production_point: boolean\r\n                    is_warehouse: boolean\r\n                    created_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['sections']['Row']> & { name: string, slug: string }\r\n                Update: Partial<Database['public']['Tables']['sections']['Row']>\r\n            },\r\n            product_stocks: {\r\n                Row: {\r\n                    id: string\r\n                    section_id: string\r\n                    product_id: string\r\n                    quantity: number\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['product_stocks']['Row']> & { section_id: string, product_id: string }\r\n                Update: Partial<Database['public']['Tables']['product_stocks']['Row']>\r\n            },\r\n            product_sections: {\r\n                Row: {\r\n                    id: string\r\n                    product_id: string\r\n                    section_id: string\r\n                    is_primary: boolean\r\n                    created_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['product_sections']['Row']> & { product_id: string, section_id: string }\r\n                Update: Partial<Database['public']['Tables']['product_sections']['Row']>\r\n            },\r\n            production_records: {\r\n                Row: {\r\n                    id: string\r\n                    production_id: string\r\n                    product_id: string\r\n                    quantity_produced: number\r\n                    quantity_waste: number\r\n                    production_date: string\r\n                    section_id: string | null\r\n                    created_by: string | null\r\n                    staff_id: string | null\r\n                    staff_name: string | null\r\n                    stock_updated: boolean\r\n                    materials_consumed: boolean\r\n                    notes: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    production_id?: string // Generated by trigger\r\n                    product_id: string\r\n                    quantity_produced: number\r\n                    quantity_waste?: number\r\n                    production_date?: string\r\n                    section_id?: string | null\r\n                    created_by?: string | null\r\n                    staff_id?: string | null\r\n                    staff_name?: string | null\r\n                    stock_updated?: boolean\r\n                    materials_consumed?: boolean\r\n                    notes?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['production_records']['Row']>\r\n            },\r\n            recipes: {\r\n                Row: {\r\n                    id: string\r\n                    product_id: string\r\n                    material_id: string\r\n                    quantity: number\r\n                    unit: string | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: Partial<Database['public']['Tables']['recipes']['Row']> & { product_id: string, material_id: string, quantity: number }\r\n                Update: Partial<Database['public']['Tables']['recipes']['Row']>\r\n            }\r\n            product_uoms: {\r\n                Row: {\r\n                    id: string\r\n                    product_id: string\r\n                    unit_name: string\r\n                    conversion_factor: number\r\n                    is_purchase_unit: boolean\r\n                    is_consumption_unit: boolean\r\n                    is_stock_opname_unit: boolean\r\n                    barcode: string | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    product_id: string\r\n                    unit_name: string\r\n                    conversion_factor: number\r\n                    is_purchase_unit?: boolean\r\n                    is_consumption_unit?: boolean\r\n                    is_stock_opname_unit?: boolean\r\n                    barcode?: string | null\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['product_uoms']['Row']>\r\n            }\r\n            inventory_counts: {\r\n                Row: {\r\n                    id: string\r\n                    count_number: string\r\n                    status: 'draft' | 'completed' | 'cancelled'\r\n                    started_at: string\r\n                    started_by: string | null\r\n                    completed_at: string | null\r\n                    completed_by: string | null\r\n                    notes: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    count_number?: string  // Auto-generated by trigger\r\n                    status?: 'draft' | 'completed' | 'cancelled'\r\n                    started_at?: string\r\n                    started_by?: string | null\r\n                    completed_at?: string | null\r\n                    completed_by?: string | null\r\n                    notes?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['inventory_counts']['Row']>\r\n            }\r\n            inventory_count_items: {\r\n                Row: {\r\n                    id: string\r\n                    inventory_count_id: string\r\n                    product_id: string\r\n                    system_stock: number\r\n                    actual_stock: number | null\r\n                    variance: number | null\r\n                    unit: string | null\r\n                    notes: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    inventory_count_id: string\r\n                    product_id: string\r\n                    system_stock: number\r\n                    actual_stock?: number | null\r\n                    variance?: number | null\r\n                    unit?: string | null\r\n                    notes?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['inventory_count_items']['Row']>\r\n            }\r\n            product_combos: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    description: string | null\r\n                    combo_price: number\r\n                    is_active: boolean\r\n                    available_at_pos: boolean\r\n                    image_url: string | null\r\n                    sort_order: number\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    name: string\r\n                    description?: string | null\r\n                    combo_price: number\r\n                    is_active?: boolean\r\n                    available_at_pos?: boolean\r\n                    image_url?: string | null\r\n                    sort_order?: number\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['product_combos']['Row']>\r\n            }\r\n            product_combo_groups: {\r\n                Row: {\r\n                    id: string\r\n                    combo_id: string\r\n                    group_name: string\r\n                    group_type: 'single' | 'multiple'\r\n                    is_required: boolean\r\n                    min_selections: number\r\n                    max_selections: number\r\n                    sort_order: number\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    combo_id: string\r\n                    group_name: string\r\n                    group_type?: 'single' | 'multiple'\r\n                    is_required?: boolean\r\n                    min_selections?: number\r\n                    max_selections?: number\r\n                    sort_order?: number\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['product_combo_groups']['Row']>\r\n            }\r\n            product_combo_group_items: {\r\n                Row: {\r\n                    id: string\r\n                    group_id: string\r\n                    product_id: string\r\n                    price_adjustment: number\r\n                    is_default: boolean\r\n                    sort_order: number\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    group_id: string\r\n                    product_id: string\r\n                    price_adjustment?: number\r\n                    is_default?: boolean\r\n                    sort_order?: number\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['product_combo_group_items']['Row']>\r\n            }\r\n            promotions: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name: string\r\n                    description: string | null\r\n                    promotion_type: 'percentage' | 'fixed_amount' | 'buy_x_get_y' | 'free_product'\r\n                    is_active: boolean\r\n                    start_date: string | null\r\n                    end_date: string | null\r\n                    days_of_week: number[] | null\r\n                    time_start: string | null\r\n                    time_end: string | null\r\n                    discount_percentage: number | null\r\n                    discount_amount: number | null\r\n                    buy_quantity: number | null\r\n                    get_quantity: number | null\r\n                    min_purchase_amount: number | null\r\n                    min_quantity: number | null\r\n                    max_uses_total: number | null\r\n                    max_uses_per_customer: number | null\r\n                    current_uses: number\r\n                    priority: number\r\n                    is_stackable: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    code: string\r\n                    name: string\r\n                    description?: string | null\r\n                    promotion_type: 'percentage' | 'fixed_amount' | 'buy_x_get_y' | 'free_product'\r\n                    is_active?: boolean\r\n                    start_date?: string | null\r\n                    end_date?: string | null\r\n                    days_of_week?: number[] | null\r\n                    time_start?: string | null\r\n                    time_end?: string | null\r\n                    discount_percentage?: number | null\r\n                    discount_amount?: number | null\r\n                    buy_quantity?: number | null\r\n                    get_quantity?: number | null\r\n                    min_purchase_amount?: number | null\r\n                    min_quantity?: number | null\r\n                    max_uses_total?: number | null\r\n                    max_uses_per_customer?: number | null\r\n                    current_uses?: number\r\n                    priority?: number\r\n                    is_stackable?: boolean\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['promotions']['Row']>\r\n            }\r\n            promotion_products: {\r\n                Row: {\r\n                    id: string\r\n                    promotion_id: string\r\n                    product_id: string | null\r\n                    category_id: string | null\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    promotion_id: string\r\n                    product_id?: string | null\r\n                    category_id?: string | null\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['promotion_products']['Row']>\r\n            }\r\n            promotion_free_products: {\r\n                Row: {\r\n                    id: string\r\n                    promotion_id: string\r\n                    free_product_id: string\r\n                    quantity: number\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    promotion_id: string\r\n                    free_product_id: string\r\n                    quantity?: number\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['promotion_free_products']['Row']>\r\n            }\r\n            promotion_usage: {\r\n                Row: {\r\n                    id: string\r\n                    promotion_id: string\r\n                    customer_id: string | null\r\n                    order_id: string | null\r\n                    discount_amount: number\r\n                    used_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    promotion_id: string\r\n                    customer_id?: string | null\r\n                    order_id?: string | null\r\n                    discount_amount: number\r\n                    used_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['promotion_usage']['Row']>\r\n            }\r\n            floor_plan_items: {\r\n                Row: {\r\n                    id: string\r\n                    type: 'table' | 'decoration'\r\n                    number: string | null\r\n                    capacity: number | null\r\n                    section: string | null\r\n                    status: 'available' | 'occupied' | 'reserved' | null\r\n                    shape: 'square' | 'round' | 'rectangle'\r\n                    decoration_type: 'plant' | 'wall' | 'bar' | 'entrance' | null\r\n                    x: number\r\n                    y: number\r\n                    width: number | null\r\n                    height: number | null\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    type: 'table' | 'decoration'\r\n                    number?: string | null\r\n                    capacity?: number | null\r\n                    section?: string | null\r\n                    status?: 'available' | 'occupied' | 'reserved' | null\r\n                    shape?: 'square' | 'round' | 'rectangle'\r\n                    decoration_type?: 'plant' | 'wall' | 'bar' | 'entrance' | null\r\n                    x: number\r\n                    y: number\r\n                    width?: number | null\r\n                    height?: number | null\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['floor_plan_items']['Row']>\r\n            }\r\n            purchase_orders: {\r\n                Row: {\r\n                    id: string\r\n                    po_number: string\r\n                    supplier_id: string\r\n                    expected_delivery_date: string | null\r\n                    subtotal: number\r\n                    discount_amount: number\r\n                    discount_percentage: number | null\r\n                    tax_amount: number\r\n                    total_amount: number\r\n                    notes: string | null\r\n                    status: 'draft' | 'sent' | 'received' | 'cancelled'\r\n                    created_by: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    po_number?: string\r\n                    supplier_id: string\r\n                    expected_delivery_date?: string | null\r\n                    subtotal?: number\r\n                    discount_amount?: number\r\n                    discount_percentage?: number | null\r\n                    tax_amount?: number\r\n                    total_amount?: number\r\n                    notes?: string | null\r\n                    status?: 'draft' | 'sent' | 'received' | 'cancelled'\r\n                    created_by?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['purchase_orders']['Row']>\r\n            }\r\n            purchase_order_items: {\r\n                Row: {\r\n                    id: string\r\n                    purchase_order_id: string\r\n                    product_id: string | null\r\n                    product_name: string\r\n                    description: string | null\r\n                    quantity: number\r\n                    unit_price: number\r\n                    discount_amount: number\r\n                    discount_percentage: number | null\r\n                    tax_rate: number\r\n                    line_total: number\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    purchase_order_id: string\r\n                    product_id?: string | null\r\n                    product_name: string\r\n                    description?: string | null\r\n                    quantity: number\r\n                    unit_price: number\r\n                    discount_amount?: number\r\n                    discount_percentage?: number | null\r\n                    tax_rate?: number\r\n                    line_total?: number\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['purchase_order_items']['Row']>\r\n            }\r\n            // B2B Module Tables\r\n            b2b_orders: {\r\n                Row: {\r\n                    id: string\r\n                    order_number: string\r\n                    customer_id: string\r\n                    status: 'draft' | 'confirmed' | 'processing' | 'delivered' | 'cancelled'\r\n                    requested_delivery_date: string | null\r\n                    actual_delivery_date: string | null\r\n                    delivery_address: string | null\r\n                    delivery_notes: string | null\r\n                    subtotal: number\r\n                    discount_type: 'percentage' | 'fixed' | null\r\n                    discount_value: number\r\n                    discount_amount: number\r\n                    tax_rate: number\r\n                    tax_amount: number\r\n                    total_amount: number\r\n                    amount_paid: number\r\n                    amount_due: number\r\n                    payment_status: 'unpaid' | 'partial' | 'paid'\r\n                    payment_terms: 'cod' | 'net15' | 'net30' | 'net60' | null\r\n                    internal_notes: string | null\r\n                    created_by: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    order_number?: string\r\n                    customer_id: string\r\n                    status?: 'draft' | 'confirmed' | 'processing' | 'delivered' | 'cancelled'\r\n                    requested_delivery_date?: string | null\r\n                    actual_delivery_date?: string | null\r\n                    delivery_address?: string | null\r\n                    delivery_notes?: string | null\r\n                    subtotal?: number\r\n                    discount_type?: 'percentage' | 'fixed' | null\r\n                    discount_value?: number\r\n                    discount_amount?: number\r\n                    tax_rate?: number\r\n                    tax_amount?: number\r\n                    total_amount?: number\r\n                    amount_paid?: number\r\n                    amount_due?: number\r\n                    payment_status?: 'unpaid' | 'partial' | 'paid'\r\n                    payment_terms?: 'cod' | 'net15' | 'net30' | 'net60' | null\r\n                    internal_notes?: string | null\r\n                    created_by?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['b2b_orders']['Row']>\r\n            }\r\n            b2b_order_items: {\r\n                Row: {\r\n                    id: string\r\n                    order_id: string\r\n                    product_id: string | null\r\n                    product_name: string\r\n                    product_sku: string\r\n                    quantity: number\r\n                    unit: string\r\n                    unit_price: number\r\n                    discount_percentage: number\r\n                    discount_amount: number\r\n                    line_total: number\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    order_id: string\r\n                    product_id?: string | null\r\n                    product_name: string\r\n                    product_sku?: string\r\n                    quantity: number\r\n                    unit?: string\r\n                    unit_price: number\r\n                    discount_percentage?: number\r\n                    discount_amount?: number\r\n                    line_total?: number\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['b2b_order_items']['Row']>\r\n            }\r\n            b2b_payments: {\r\n                Row: {\r\n                    id: string\r\n                    order_id: string\r\n                    customer_id: string\r\n                    amount: number\r\n                    payment_method: string\r\n                    reference_number: string | null\r\n                    notes: string | null\r\n                    created_by: string | null\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    order_id: string\r\n                    customer_id: string\r\n                    amount: number\r\n                    payment_method: string\r\n                    reference_number?: string | null\r\n                    notes?: string | null\r\n                    created_by?: string | null\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['b2b_payments']['Row']>\r\n            }\r\n            // Settings Module Tables\r\n            settings_categories: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    description: string | null\r\n                    icon: string | null\r\n                    sort_order: number\r\n                    is_active: boolean\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en?: string\r\n                    name_id?: string\r\n                    description?: string | null\r\n                    icon?: string | null\r\n                    sort_order?: number\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['settings_categories']['Row']>\r\n            }\r\n            settings: {\r\n                Row: {\r\n                    id: string\r\n                    category_id: string | null\r\n                    key: string\r\n                    value: Json\r\n                    data_type: 'string' | 'number' | 'boolean' | 'json' | 'array'\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    description: string | null\r\n                    is_sensitive: boolean\r\n                    requires_restart: boolean\r\n                    validation_rules: Json | null\r\n                    default_value: Json | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    category_id?: string | null\r\n                    key: string\r\n                    value: Json\r\n                    data_type?: 'string' | 'number' | 'boolean' | 'json' | 'array'\r\n                    name_fr: string\r\n                    name_en?: string\r\n                    name_id?: string\r\n                    description?: string | null\r\n                    is_sensitive?: boolean\r\n                    requires_restart?: boolean\r\n                    validation_rules?: Json | null\r\n                    default_value?: Json | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['settings']['Row']>\r\n            }\r\n            email_templates: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name: string\r\n                    subject: string\r\n                    body_html: string\r\n                    body_text: string | null\r\n                    variables: Json | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    code: string\r\n                    name: string\r\n                    subject: string\r\n                    body_html: string\r\n                    body_text?: string | null\r\n                    variables?: Json | null\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['email_templates']['Row']>\r\n            }\r\n            receipt_templates: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name: string\r\n                    template_type: 'receipt' | 'invoice' | 'kitchen' | 'label'\r\n                    content: string\r\n                    styles: Json | null\r\n                    variables: Json | null\r\n                    paper_size: string | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    code: string\r\n                    name: string\r\n                    template_type?: 'receipt' | 'invoice' | 'kitchen' | 'label'\r\n                    content: string\r\n                    styles?: Json | null\r\n                    variables?: Json | null\r\n                    paper_size?: string | null\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['receipt_templates']['Row']>\r\n            }\r\n            customer_categories: {\r\n                Row: {\r\n                    id: string\r\n                    slug: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    description: string | null\r\n                    price_modifier_type: 'retail' | 'wholesale' | 'discount_percentage' | 'custom'\r\n                    discount_percentage: number | null\r\n                    is_active: boolean\r\n                    sort_order: number\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    slug: string\r\n                    name_fr: string\r\n                    name_en?: string\r\n                    name_id?: string\r\n                    description?: string | null\r\n                    price_modifier_type?: 'retail' | 'wholesale' | 'discount_percentage' | 'custom'\r\n                    discount_percentage?: number | null\r\n                    is_active?: boolean\r\n                    sort_order?: number\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['customer_categories']['Row']>\r\n            }\r\n            // Stock Locations and Transfers (from migration 039)\r\n            stock_locations: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    code: string\r\n                    location_type: 'main_warehouse' | 'section' | 'production' | 'waste'\r\n                    description: string | null\r\n                    responsible_person: string | null\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    name: string\r\n                    code: string\r\n                    location_type: 'main_warehouse' | 'section' | 'production' | 'waste'\r\n                    description?: string | null\r\n                    responsible_person?: string | null\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['stock_locations']['Row']>\r\n            }\r\n            internal_transfers: {\r\n                Row: {\r\n                    id: string\r\n                    transfer_number: string\r\n                    from_location_id: string\r\n                    to_location_id: string\r\n                    status: 'draft' | 'pending' | 'in_transit' | 'received' | 'cancelled'\r\n                    requested_by: string | null\r\n                    requested_by_name: string | null\r\n                    approved_by: string | null\r\n                    approved_by_name: string | null\r\n                    received_by: string | null\r\n                    received_by_name: string | null\r\n                    responsible_person: string\r\n                    transfer_date: string\r\n                    requested_at: string | null\r\n                    approved_at: string | null\r\n                    shipped_at: string | null\r\n                    received_at: string | null\r\n                    total_items: number\r\n                    total_value: number\r\n                    notes: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    transfer_number?: string\r\n                    from_location_id: string\r\n                    to_location_id: string\r\n                    status?: 'draft' | 'pending' | 'in_transit' | 'received' | 'cancelled'\r\n                    requested_by?: string | null\r\n                    requested_by_name?: string | null\r\n                    approved_by?: string | null\r\n                    approved_by_name?: string | null\r\n                    received_by?: string | null\r\n                    received_by_name?: string | null\r\n                    responsible_person: string\r\n                    transfer_date?: string\r\n                    requested_at?: string | null\r\n                    approved_at?: string | null\r\n                    shipped_at?: string | null\r\n                    received_at?: string | null\r\n                    total_items?: number\r\n                    total_value?: number\r\n                    notes?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['internal_transfers']['Row']>\r\n            }\r\n            transfer_items: {\r\n                Row: {\r\n                    id: string\r\n                    transfer_id: string\r\n                    product_id: string\r\n                    quantity_requested: number\r\n                    quantity_shipped: number\r\n                    quantity_received: number\r\n                    unit: string\r\n                    unit_cost: number | null\r\n                    line_total: number | null\r\n                    notes: string | null\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    transfer_id: string\r\n                    product_id: string\r\n                    quantity_requested: number\r\n                    quantity_shipped?: number\r\n                    quantity_received?: number\r\n                    unit?: string\r\n                    unit_cost?: number | null\r\n                    line_total?: number | null\r\n                    notes?: string | null\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['transfer_items']['Row']>\r\n            }\r\n            // Purchase Order History and Returns (from migration 025)\r\n            purchase_order_history: {\r\n                Row: {\r\n                    id: string\r\n                    purchase_order_id: string\r\n                    action_type: 'created' | 'modified' | 'sent' | 'confirmed' | 'received' | 'partially_received' | 'cancelled' | 'payment_made' | 'item_returned'\r\n                    previous_status: string | null\r\n                    new_status: string | null\r\n                    description: string\r\n                    changed_by: string | null\r\n                    metadata: Json | null\r\n                    created_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    purchase_order_id: string\r\n                    action_type: 'created' | 'modified' | 'sent' | 'confirmed' | 'received' | 'partially_received' | 'cancelled' | 'payment_made' | 'item_returned'\r\n                    previous_status?: string | null\r\n                    new_status?: string | null\r\n                    description: string\r\n                    changed_by?: string | null\r\n                    metadata?: Json | null\r\n                    created_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['purchase_order_history']['Row']>\r\n            }\r\n            purchase_order_returns: {\r\n                Row: {\r\n                    id: string\r\n                    purchase_order_id: string\r\n                    purchase_order_item_id: string\r\n                    quantity_returned: number\r\n                    reason: 'damaged' | 'wrong_item' | 'quality_issue' | 'excess_quantity' | 'other'\r\n                    reason_details: string | null\r\n                    return_date: string\r\n                    refund_amount: number | null\r\n                    status: 'pending' | 'approved' | 'rejected' | 'completed'\r\n                    created_by: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    purchase_order_id: string\r\n                    purchase_order_item_id: string\r\n                    quantity_returned: number\r\n                    reason: 'damaged' | 'wrong_item' | 'quality_issue' | 'excess_quantity' | 'other'\r\n                    reason_details?: string | null\r\n                    return_date?: string\r\n                    refund_amount?: number | null\r\n                    status?: 'pending' | 'approved' | 'rejected' | 'completed'\r\n                    created_by?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['purchase_order_returns']['Row']>\r\n            }\r\n            // Product Category Prices (from migration 029)\r\n            product_category_prices: {\r\n                Row: {\r\n                    id: string\r\n                    product_id: string\r\n                    customer_category_id: string\r\n                    price: number\r\n                    is_active: boolean\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    product_id: string\r\n                    customer_category_id: string\r\n                    price: number\r\n                    is_active?: boolean\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['product_category_prices']['Row']>\r\n            }\r\n            // Settings Module Tables (from migration 041)\r\n            settings_history: {\r\n                Row: {\r\n                    id: string\r\n                    setting_id: string\r\n                    old_value: Json | null\r\n                    new_value: Json | null\r\n                    changed_by: string | null\r\n                    changed_at: string\r\n                    change_reason: string | null\r\n                    ip_address: string | null\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    setting_id: string\r\n                    old_value?: Json | null\r\n                    new_value?: Json | null\r\n                    changed_by?: string | null\r\n                    changed_at?: string\r\n                    change_reason?: string | null\r\n                    ip_address?: string | null\r\n                }\r\n                Update: Partial<Database['public']['Tables']['settings_history']['Row']>\r\n            }\r\n            tax_rates: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    rate: number\r\n                    is_inclusive: boolean\r\n                    is_default: boolean\r\n                    is_active: boolean\r\n                    applies_to: Json\r\n                    valid_from: string | null\r\n                    valid_until: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    rate: number\r\n                    is_inclusive?: boolean\r\n                    is_default?: boolean\r\n                    is_active?: boolean\r\n                    applies_to?: Json\r\n                    valid_from?: string | null\r\n                    valid_until?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['tax_rates']['Row']>\r\n            }\r\n            payment_methods: {\r\n                Row: {\r\n                    id: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    icon: string | null\r\n                    payment_type: string\r\n                    is_active: boolean\r\n                    is_default: boolean\r\n                    requires_reference: boolean\r\n                    settings: Json\r\n                    sort_order: number\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    code: string\r\n                    name_fr: string\r\n                    name_en: string\r\n                    name_id: string\r\n                    icon?: string | null\r\n                    payment_type: string\r\n                    is_active?: boolean\r\n                    is_default?: boolean\r\n                    requires_reference?: boolean\r\n                    settings?: Json\r\n                    sort_order?: number\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['payment_methods']['Row']>\r\n            }\r\n            business_hours: {\r\n                Row: {\r\n                    id: string\r\n                    day_of_week: number\r\n                    open_time: string | null\r\n                    close_time: string | null\r\n                    is_closed: boolean\r\n                    break_start: string | null\r\n                    break_end: string | null\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    day_of_week: number\r\n                    open_time?: string | null\r\n                    close_time?: string | null\r\n                    is_closed?: boolean\r\n                    break_start?: string | null\r\n                    break_end?: string | null\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['business_hours']['Row']>\r\n            }\r\n            printer_configurations: {\r\n                Row: {\r\n                    id: string\r\n                    name: string\r\n                    printer_type: string\r\n                    connection_type: string\r\n                    connection_string: string | null\r\n                    paper_width: number\r\n                    is_default: boolean\r\n                    is_active: boolean\r\n                    settings: Json\r\n                    created_at: string\r\n                    updated_at: string\r\n                }\r\n                Insert: {\r\n                    id?: string\r\n                    name: string\r\n                    printer_type: string\r\n                    connection_type: string\r\n                    connection_string?: string | null\r\n                    paper_width?: number\r\n                    is_default?: boolean\r\n                    is_active?: boolean\r\n                    settings?: Json\r\n                    created_at?: string\r\n                    updated_at?: string\r\n                }\r\n                Update: Partial<Database['public']['Tables']['printer_configurations']['Row']>\r\n            }\r\n        }\r\n        Views: {\r\n            view_daily_kpis: {\r\n                Row: {\r\n                    date: string\r\n                    total_orders: number\r\n                    total_revenue: number\r\n                    net_revenue: number\r\n                    total_tax: number\r\n                    total_discount: number\r\n                    avg_basket_value: number\r\n                }\r\n            }\r\n            view_stock_waste: {\r\n                Row: {\r\n                    product_name: string\r\n                    category_name: string\r\n                    reason: string | null\r\n                    waste_events: number\r\n                    waste_quantity: number\r\n                    loss_value_at_cost: number\r\n                    loss_value_at_retail: number\r\n                    waste_date: string\r\n                }\r\n            }\r\n            view_inventory_valuation: {\r\n                Row: {\r\n                    total_skus: number\r\n                    total_items_in_stock: number\r\n                    total_valuation_cost: number\r\n                    total_valuation_retail: number\r\n                }\r\n            }\r\n            view_payment_method_stats: {\r\n                Row: {\r\n                    payment_method: string\r\n                    transaction_count: number\r\n                    total_revenue: number\r\n                    report_date: string\r\n                }\r\n            }\r\n            view_session_discrepancies: {\r\n                Row: {\r\n                    session_number: string\r\n                    staff_name: string | null\r\n                    opened_at: string\r\n                    closed_at: string | null\r\n                    expected_cash: number | null\r\n                    closing_cash: number | null\r\n                    cash_difference: number | null\r\n                    severity: 'info' | 'warning' | 'critical'\r\n                }\r\n            }\r\n        }\r\n        Functions: {\r\n            finalize_inventory_count: {\r\n                Args: {\r\n                    count_uuid: string\r\n                    user_uuid: string\r\n                }\r\n                Returns: void\r\n            }\r\n            get_sales_comparison: {\r\n                Args: {\r\n                    current_start: string\r\n                    current_end: string\r\n                    previous_start: string\r\n                    previous_end: string\r\n                }\r\n                Returns: {\r\n                    period_label: 'current' | 'previous'\r\n                    total_revenue: number\r\n                    net_revenue: number\r\n                    transaction_count: number\r\n                    avg_basket: number\r\n                }[]\r\n            }\r\n            get_reporting_dashboard_summary: {\r\n                Args: {\r\n                    start_date: string\r\n                    end_date: string\r\n                }\r\n                Returns: Json\r\n            },\r\n            process_production: {\r\n                Args: {\r\n                    production_uuid: string\r\n                }\r\n                Returns: boolean\r\n            },\r\n            transfer_stock: {\r\n                Args: {\r\n                    p_product_id: string\r\n                    p_from_section_id: string\r\n                    p_to_section_id: string\r\n                    p_quantity: number\r\n                }\r\n                Returns: boolean\r\n            },\r\n            // Users & Permissions functions (from migration 040)\r\n            user_has_permission: {\r\n                Args: {\r\n                    p_user_id: string\r\n                    p_permission_code: string\r\n                }\r\n                Returns: boolean\r\n            },\r\n            get_user_permissions: {\r\n                Args: {\r\n                    p_user_id: string\r\n                }\r\n                Returns: {\r\n                    permission_code: string\r\n                    permission_module: string\r\n                    permission_action: string\r\n                    is_granted: boolean\r\n                    source: 'direct' | 'role'\r\n                    is_sensitive: boolean\r\n                }[]\r\n            },\r\n            is_admin: {\r\n                Args: {\r\n                    p_user_id: string\r\n                }\r\n                Returns: boolean\r\n            },\r\n            is_super_admin: {\r\n                Args: {\r\n                    p_user_id: string\r\n                }\r\n                Returns: boolean\r\n            },\r\n            verify_user_pin: {\r\n                Args: {\r\n                    p_user_id: string\r\n                    p_pin: string\r\n                }\r\n                Returns: boolean\r\n            },\r\n            hash_pin: {\r\n                Args: {\r\n                    p_pin: string\r\n                }\r\n                Returns: string\r\n            }\r\n        }\r\n        Enums: {\r\n            // Add enums if needed for stricter typing\r\n        }\r\n    }\r\n}\r\n\r\n// Helper types\r\nexport type Category = Database['public']['Tables']['categories']['Row']\r\nexport type Product = Database['public']['Tables']['products']['Row']\r\nexport type ProductModifier = Database['public']['Tables']['product_modifiers']['Row']\r\nexport type Customer = Database['public']['Tables']['customers']['Row']\r\nexport type POSSession = Database['public']['Tables']['pos_sessions']['Row']\r\nexport type Order = Database['public']['Tables']['orders']['Row']\r\nexport type OrderItem = Database['public']['Tables']['order_items']['Row']\r\nexport type UserProfile = Database['public']['Tables']['user_profiles']['Row']\r\nexport type StockMovement = Database['public']['Tables']['stock_movements']['Row']\r\nexport type Recipe = Database['public']['Tables']['recipes']['Row']\r\nexport type ProductUOM = Database['public']['Tables']['product_uoms']['Row']\r\nexport type InventoryCount = Database['public']['Tables']['inventory_counts']['Row']\r\nexport type InventoryCountItem = Database['public']['Tables']['inventory_count_items']['Row']\r\nexport type Supplier = Database['public']['Tables']['suppliers']['Row']\r\n\r\nexport type ProductionRecord = Database['public']['Tables']['production_records']['Row']\r\nexport type Section = Database['public']['Tables']['sections']['Row']\r\nexport type ProductStock = Database['public']['Tables']['product_stocks']['Row']\r\nexport type ProductSection = Database['public']['Tables']['product_sections']['Row']\r\n\r\n// Combos and Promotions types\r\nexport type ProductCombo = Database['public']['Tables']['product_combos']['Row']\r\nexport type ProductComboGroup = Database['public']['Tables']['product_combo_groups']['Row']\r\nexport type ProductComboGroupItem = Database['public']['Tables']['product_combo_group_items']['Row']\r\nexport type Promotion = Database['public']['Tables']['promotions']['Row']\r\nexport type PromotionProduct = Database['public']['Tables']['promotion_products']['Row']\r\nexport type PromotionFreeProduct = Database['public']['Tables']['promotion_free_products']['Row']\r\nexport type PromotionUsage = Database['public']['Tables']['promotion_usage']['Row']\r\n\r\n// Users & Permissions types (from migration 040)\r\nexport type Role = Database['public']['Tables']['roles']['Row']\r\nexport type Permission = Database['public']['Tables']['permissions']['Row']\r\nexport type RolePermission = Database['public']['Tables']['role_permissions']['Row']\r\nexport type UserRole = Database['public']['Tables']['user_roles']['Row']\r\nexport type UserPermissionRow = Database['public']['Tables']['user_permissions']['Row']\r\nexport type UserSession = Database['public']['Tables']['user_sessions']['Row']\r\nexport type AuditLog = Database['public']['Tables']['audit_logs']['Row']\r\n\r\n// Promotion types\r\nexport type PromotionType = 'percentage' | 'fixed_amount' | 'buy_x_get_y' | 'free_product'\r\n\r\n// Extended types with relations\r\nexport interface ProductWithCategory extends Product {\r\n    category: Category | null\r\n}\r\n\r\nexport interface ProductSectionWithDetails extends ProductSection {\r\n    section: Section\r\n}\r\n\r\nexport interface ProductWithSections extends Product {\r\n    sections: ProductSectionWithDetails[]\r\n}\r\n\r\nexport interface OrderWithItems extends Order {\r\n    items: OrderItemWithProduct[]\r\n}\r\n\r\nexport interface OrderItemWithProduct extends OrderItem {\r\n    product: Product\r\n}\r\n\r\n// Combo with groups\r\nexport interface ProductComboWithGroups extends ProductCombo {\r\n    groups: ProductComboGroupWithItems[]\r\n}\r\n\r\nexport interface ProductComboGroupWithItems extends ProductComboGroup {\r\n    items: ProductComboGroupItemWithProduct[]\r\n}\r\n\r\nexport interface ProductComboGroupItemWithProduct extends ProductComboGroupItem {\r\n    product: Product\r\n}\r\n\r\n// Promotion with products\r\nexport interface PromotionWithProducts extends Promotion {\r\n    promotion_products: PromotionProduct[]\r\n    promotion_free_products: PromotionFreeProduct[]\r\n}\r\n\r\n// Stock Locations and Transfers types (from migration 039)\r\nexport type StockLocation = Database['public']['Tables']['stock_locations']['Row']\r\nexport type InternalTransfer = Database['public']['Tables']['internal_transfers']['Row']\r\nexport type TransferItem = Database['public']['Tables']['transfer_items']['Row']\r\n\r\n// Purchase Order History and Returns types (from migration 025)\r\nexport type PurchaseOrderHistory = Database['public']['Tables']['purchase_order_history']['Row']\r\nexport type PurchaseOrderReturn = Database['public']['Tables']['purchase_order_returns']['Row']\r\n\r\n// Product Category Prices (from migration 029)\r\nexport type ProductCategoryPrice = Database['public']['Tables']['product_category_prices']['Row']\r\n\r\n// Settings Module types (from migration 041)\r\nexport type SettingsHistory = Database['public']['Tables']['settings_history']['Row']\r\nexport type TaxRate = Database['public']['Tables']['tax_rates']['Row']\r\nexport type PaymentMethod = Database['public']['Tables']['payment_methods']['Row']\r\nexport type BusinessHour = Database['public']['Tables']['business_hours']['Row']\r\nexport type PrinterConfiguration = Database['public']['Tables']['printer_configurations']['Row']\r\n\r\n// Extended types with relations\r\nexport interface InternalTransferWithItems extends InternalTransfer {\r\n    items: TransferItemWithProduct[]\r\n    from_location: StockLocation\r\n    to_location: StockLocation\r\n}\r\n\r\nexport interface TransferItemWithProduct extends TransferItem {\r\n    product: Product\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\database.generated.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\database.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\offline.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1623,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1623,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45041,45044],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45041,45044],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\payment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\reporting.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2146,2149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2146,2149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2167,2170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2167,2170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface SalesComparison {\r\n    period_label: 'current' | 'previous';\r\n    total_revenue: number;\r\n    net_revenue: number;\r\n    transaction_count: number;\r\n    avg_basket: number;\r\n}\r\n\r\nexport interface PaymentMethodStat {\r\n    payment_method: string;\r\n    transaction_count: number;\r\n    total_revenue: number;\r\n    report_date: string;\r\n}\r\n\r\nexport interface StockWaste {\r\n    product_name: string;\r\n    category_name: string;\r\n    reason: string;\r\n    waste_events: number;\r\n    waste_quantity: number;\r\n    loss_value_at_cost: number;\r\n    loss_value_at_retail: number;\r\n    waste_date: string;\r\n}\r\n\r\nexport interface SessionDiscrepancy {\r\n    session_number: string;\r\n    staff_name: string;\r\n    opened_at: string;\r\n    closed_at: string;\r\n    expected_cash: number;\r\n    closing_cash: number;\r\n    cash_difference: number;\r\n    severity: 'info' | 'warning' | 'critical';\r\n}\r\n\r\nexport interface InventoryValuation {\r\n    total_skus: number;\r\n    total_items_in_stock: number;\r\n    total_valuation_cost: number;\r\n    total_valuation_retail: number;\r\n}\r\n\r\nexport interface DashboardSummary {\r\n    period_sales: number;\r\n    period_orders: number;\r\n    top_product: {\r\n        name: string;\r\n        qty: number;\r\n    } | null;\r\n    low_stock_alerts: number;\r\n    active_sessions: number;\r\n}\r\n\r\nexport interface DailySalesStat {\r\n    date: string;\r\n    total_sales: number; // mapped from total_revenue\r\n    total_orders: number;\r\n    avg_basket: number; // mapped from avg_basket_value\r\n    net_revenue: number;\r\n}\r\n\r\nexport interface ProductPerformanceStat {\r\n    product_id: string;\r\n    product_name: string;\r\n    category_name?: string;\r\n    quantity_sold: number;\r\n    total_revenue: number;\r\n    avg_price: number;\r\n    cost_price?: number;\r\n    margin_percentage?: number;\r\n}\r\n\r\nexport interface CategorySalesStat {\r\n    category_id: string;\r\n    category_name: string;\r\n    total_revenue: number;\r\n    transaction_count: number;\r\n}\r\n\r\nexport interface AuditLogEntry {\r\n    id: string;\r\n    action_type: string;\r\n    severity: 'info' | 'warning' | 'critical';\r\n    entity_type: string;\r\n    entity_id: string;\r\n    old_value: any;\r\n    new_value: any;\r\n    reason: string;\r\n    user_id: string;\r\n    created_at: string;\r\n}\r\n\r\n// =============================================================\r\n// Epic 3: New Report Types (Story 3.1, 3.2, 3.3)\r\n// =============================================================\r\n\r\n/**\r\n * Profit/Loss Report (FR35)\r\n */\r\nexport interface IProfitLossReport {\r\n    report_date: string;\r\n    order_count: number;\r\n    gross_revenue: number;\r\n    tax_collected: number;\r\n    total_discounts: number;\r\n    cogs: number;\r\n    gross_profit: number;\r\n    margin_percentage: number;\r\n}\r\n\r\n/**\r\n * Sales by Customer Report (FR36)\r\n */\r\nexport interface ISalesByCustomerReport {\r\n    customer_id: string;\r\n    customer_name: string;\r\n    company_name: string | null;\r\n    phone: string | null;\r\n    customer_type: string;\r\n    category_name: string | null;\r\n    loyalty_tier: string | null;\r\n    order_count: number;\r\n    total_spent: number;\r\n    avg_basket: number;\r\n    first_order_at: string | null;\r\n    last_order_at: string | null;\r\n    days_since_last_order: number;\r\n}\r\n\r\n/**\r\n * Sales by Hour Report (FR37)\r\n */\r\nexport interface ISalesByHourReport {\r\n    hour_of_day: number;\r\n    report_date: string;\r\n    order_count: number;\r\n    total_revenue: number;\r\n    avg_order_value: number;\r\n}\r\n\r\n/**\r\n * Session Cash Balance Report (FR44)\r\n */\r\nexport interface ISessionCashBalanceReport {\r\n    session_id: string;\r\n    terminal_id: string | null;\r\n    cashier_name: string;\r\n    started_at: string;\r\n    ended_at: string | null;\r\n    opening_cash: number;\r\n    closing_cash: number | null;\r\n    cash_received: number;\r\n    expected_cash: number;\r\n    cash_difference: number;\r\n    order_count: number;\r\n    total_revenue: number;\r\n    status: string;\r\n}\r\n\r\n/**\r\n * B2B Receivables Report (FR45)\r\n */\r\nexport interface IB2BReceivablesReport {\r\n    customer_id: string;\r\n    customer_name: string;\r\n    company_name: string | null;\r\n    phone: string | null;\r\n    credit_limit: number;\r\n    credit_balance: number;\r\n    outstanding_amount: number;\r\n    unpaid_order_count: number;\r\n    oldest_unpaid_at: string | null;\r\n    days_overdue: number;\r\n}\r\n\r\n/**\r\n * Stock Warning Report (FR40, FR41)\r\n */\r\nexport interface IStockWarningReport {\r\n    product_id: string;\r\n    sku: string | null;\r\n    product_name: string;\r\n    category_name: string | null;\r\n    current_stock: number;\r\n    unit: string;\r\n    min_stock_level: number;\r\n    cost_price: number;\r\n    retail_price: number;\r\n    stock_percentage: number;\r\n    alert_level: 'out_of_stock' | 'critical' | 'warning' | 'ok';\r\n    suggested_reorder: number;\r\n    value_at_risk: number;\r\n}\r\n\r\n/**\r\n * Expired Stock Report (FR42)\r\n */\r\nexport interface IExpiredStockReport {\r\n    product_id: string;\r\n    sku: string | null;\r\n    product_name: string;\r\n    category_name: string | null;\r\n    current_stock: number;\r\n    unit: string;\r\n    cost_price: number;\r\n    expiry_date: string;\r\n    days_until_expiry: number;\r\n    expiry_status: 'expired' | 'expiring_soon' | 'expiring' | 'ok';\r\n    potential_loss: number;\r\n}\r\n\r\n/**\r\n * Unsold Products Report (FR43)\r\n */\r\nexport interface IUnsoldProductsReport {\r\n    product_id: string;\r\n    sku: string | null;\r\n    product_name: string;\r\n    category_name: string | null;\r\n    current_stock: number;\r\n    unit: string;\r\n    cost_price: number;\r\n    retail_price: number;\r\n    last_sale_at: string | null;\r\n    days_since_sale: number;\r\n    total_units_sold: number;\r\n    stock_value: number;\r\n}\r\n\r\n/**\r\n * Cancellations Report (FR38)\r\n */\r\nexport interface ICancellationsReport {\r\n    order_id: string;\r\n    order_number: string;\r\n    cancelled_at: string;\r\n    cashier_name: string | null;\r\n    order_total: number;\r\n    cancel_reason: string | null;\r\n    items_count: number;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\types\\settings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\utils\\audio.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\utils\\helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\utils\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\MamatCEO\\App\\AppGrav\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
