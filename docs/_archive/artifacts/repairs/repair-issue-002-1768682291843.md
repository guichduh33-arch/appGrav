## ✅ [ISSUE-002] Row Level Security Policies - IMPLEMENTED

### Files Created/Modified

- ✅ `supabase/migrations/20250118_implement_rls_policies.sql`
- ✅ `src/utils/database-security.ts` (helper functions)
- ✅ `src/hooks/useRLSValidation.ts` (validation hook)

### Changes Summary

Implemented comprehensive Row Level Security (RLS) policies across all critical tables to prevent unauthorized data access. Added organization-based isolation, role-based permissions, and user-specific access controls.

### Code Implementation

**1. RLS Migration File:**

```sql
-- supabase/migrations/20250118_implement_rls_policies.sql

-- =====================================================
-- ROW LEVEL SECURITY IMPLEMENTATION
-- Critical security update for The Breakery ERP/POS
-- =====================================================

BEGIN;

-- Enable RLS on all critical tables
ALTER TABLE IF EXISTS products ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS sales ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS order_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS inventory ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS stock_movements ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS users ENABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS organizations ENABLE ROW LEVEL SECURITY;

-- =====================================================
-- HELPER FUNCTIONS FOR RLS
-- =====================================================

-- Function to get user's organization ID
CREATE OR REPLACE FUNCTION get_user_organization_id()
RETURNS UUID
LANGUAGE SQL
SECURITY DEFINER
STABLE
AS $$
  SELECT organization_id FROM users WHERE id = auth.uid();
$$;

-- Function to check if user has specific role
CREATE OR REPLACE FUNCTION user_has_role(required_role TEXT)
RETURNS BOOLEAN
LANGUAGE SQL
SECURITY DEFINER
STABLE
AS $$
  SELECT EXISTS (
    SELECT 1 FROM users 
    WHERE id = auth.uid() 
    AND role = required_role
  );
$$;

-- Function to check if user has any of the specified roles
CREATE OR REPLACE FUNCTION user_has_any_role(required_roles TEXT[])
RETURNS BOOLEAN
LANGUAGE SQL
SECURITY DEFINER
STABLE
AS $$
  SELECT EXISTS (
    SELECT 1 FROM users 
    WHERE id = auth.uid() 
    AND role = ANY(required_roles)
  );
$$;

-- =====================================================
-- PRODUCTS TABLE POLICIES
-- =====================================================

-- Drop existing policies if they exist
DROP POLICY IF EXISTS "products_read_policy" ON products;
DROP POLICY IF EXISTS "products_write_policy" ON products;

-- Anyone can view products (for POS system)
CREATE POLICY "products_read_policy"
  ON products FOR SELECT
  TO public
  USING (true);

-- Only authenticated staff/admin can modify products
CREATE POLICY "products_write_policy"
  ON products FOR ALL
  TO authenticated
  USING (user_has_any_role(ARRAY['admin', 'staff']))
  WITH CHECK (user_has_any_role(ARRAY['admin', 'staff']));

-- =====================================================
-- CATEGORIES TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "categories_read_policy" ON categories;
DROP POLICY IF EXISTS "categories_write_policy" ON categories;

-- Public read access for categories
CREATE POLICY "categories_read_policy"
  ON categories FOR SELECT
  TO public
  USING (true);

-- Only admins can manage categories
CREATE POLICY "categories_write_policy"
  ON categories FOR ALL
  TO authenticated
  USING (user_has_role('admin'))
  WITH CHECK (user_has_role('admin'));

-- =====================================================
-- CUSTOMERS TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "customers_user_policy" ON customers;
DROP POLICY IF EXISTS "customers_staff_policy" ON customers;
DROP POLICY IF EXISTS "customers_write_policy" ON customers;

-- Users can view their own customer data
CREATE POLICY "customers_user_policy"
  ON customers FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

-- Staff and admins can view all customers in their organization
CREATE POLICY "customers_staff_policy"
  ON customers FOR SELECT
  TO authenticated
  USING (
    user_has_any_role(ARRAY['admin', 'staff']) AND
    organization_id = get_user_organization_id()
  );

-- Staff and admins can manage customers
CREATE POLICY "customers_write_policy"
  ON customers FOR ALL
  TO authenticated
  USING (
    user_has_any_role(ARRAY['admin', 'staff']) AND
    organization_id = get_user_organization_id()
  )
  WITH CHECK (
    user_has_any_role(ARRAY['admin', 'staff']) AND
    organization_id = get_user_organization_id()
  );

-- =====================================================
-- SALES TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "sales_organization_policy" ON sales;
DROP POLICY IF EXISTS "sales_write_policy" ON sales;

-- Users can access sales from their organization
CREATE POLICY "sales_organization_policy"
  ON sales FOR SELECT
  TO authenticated
  USING (
    organization_id = get_user_organization_id() OR
    customer_id IN (
      SELECT id FROM customers WHERE user_id = auth.uid()
    )
  );

-- Staff and admins can manage sales
CREATE POLICY "sales_write_policy"
  ON sales FOR ALL
  TO authenticated
  USING (
    user_has_any_role(ARRAY['admin', 'staff', 'cashier']) AND
    organization_id = get_user_organization_id()
  )
  WITH CHECK (
    user_has_any_role(ARRAY['admin', 'staff', 'cashier']) AND
    organization_id = get_user_organization_id()
  );

-- =====================================================
-- ORDER_ITEMS TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "order_items_policy" ON order_items;

-- Order items follow the same rules as their parent sale
CREATE POLICY "order_items_policy"
  ON order_items FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM sales 
      WHERE sales.id = order_items.sale_id 
      AND (
        sales.organization_id = get_user_organization_id() OR
        sales.customer_id IN (
          SELECT id FROM customers WHERE user_id = auth.uid()
        )
      )
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM sales 
      WHERE sales.id = order_items.sale_id 
      AND sales.organization_id = get_user_organization_id()
    ) AND
    user_has_any_role(ARRAY['admin', 'staff', 'cashier'])
  );

-- =====================================================
-- INVENTORY TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "inventory_read_policy" ON inventory;
DROP POLICY IF EXISTS "inventory_write_policy" ON inventory;

-- Staff can view inventory
CREATE POLICY "inventory_read_policy"
  ON inventory FOR SELECT
  TO authenticated
  USING (
    user_has_any_role(ARRAY['admin', 'staff']) AND
    organization_id = get_user_organization_id()
  );

-- Only admins and inventory managers can modify inventory
CREATE POLICY "inventory_write_policy"
  ON inventory FOR ALL
  TO authenticated
  USING (
    user_has_any_role(ARRAY['admin', 'inventory_manager']) AND
    organization_id = get_user_organization_id()
  )
  WITH CHECK (
    user_has_any_role(ARRAY['admin', 'inventory_manager']) AND
    organization_id = get_user_organization_id()
  );

-- =====================================================
-- STOCK_MOVEMENTS TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "stock_movements_read_policy" ON stock_movements;
DROP POLICY IF EXISTS "stock_movements_write_policy" ON stock_movements;

-- Staff can view stock movements
CREATE POLICY "stock_movements_read_policy"
  ON stock_movements FOR SELECT
  TO authenticated
  USING (
    user_has_any_role(ARRAY['admin', 'staff', 'inventory_manager']) AND
    organization_id = get_user_organization_id()
  );

-- Only admins and inventory managers can create stock movements
CREATE POLICY "stock_movements_write_policy"
  ON stock_movements FOR INSERT
  TO authenticated
  WITH CHECK (
    user_has_any_role(ARRAY['admin', 'inventory_manager']) AND
    organization_id = get_user_organization_id() AND
    created_by = auth.uid()
  );

-- =====================================================
-- USERS TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "users_self_policy" ON users;
DROP POLICY IF EXISTS "users_admin_policy" ON users;

-- Users can view and update their own profile
CREATE POLICY "users_self_policy"
  ON users FOR ALL
  TO authenticated
  USING (id = auth.uid())
  WITH CHECK (id = auth.uid());

-- Admins can manage users in their organization
CREATE POLICY "users_admin_policy"
  ON users FOR ALL
  TO authenticated
  USING (
    user_has_role('admin') AND
    organization_id = get_user_organization_id()
  )
  WITH CHECK (
    user_has_role('admin') AND
    organization_id = get_user_organization_id()
  );

-- =====================================================
-- ORGANIZATIONS TABLE POLICIES
-- =====================================================

DROP POLICY IF EXISTS "organizations_member_policy" ON organizations;
DROP POLICY IF EXISTS "organizations_admin_policy" ON organizations;

-- Users can view their own organization
CREATE POLICY "organizations_member_policy"
  ON organizations FOR SELECT
  TO authenticated
  USING (id = get_user_organization_id());

-- Only organization admins can modify organization data
CREATE POLICY "organizations_admin_policy"
  ON organizations FOR ALL
  TO authenticated
  USING (
    id = get_user_organization_id() AND
    user_has_role('admin')
  )
  WITH CHECK (
    id = get_user_organization_id() AND
    user_has_role('admin')
  );

-- =====================================================
-- SECURITY INDEXES FOR PERFORMANCE
-- =====================================================

-- Index for organization-based queries
CREATE INDEX IF NOT EXISTS idx_sales_organization_id ON sales(organization_id);
CREATE INDEX IF NOT EXISTS idx_customers_organization_id ON customers(organization_id);
CREATE INDEX IF NOT EXISTS idx_inventory_organization_id ON inventory(organization_id);
CREATE INDEX IF NOT EXISTS idx_users_organization_id ON users(organization_id);

-- Index for role-based queries
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);

-- Index for user-based queries
CREATE INDEX IF NOT EXISTS idx_customers_user_id ON customers(user_id);
CREATE INDEX IF NOT EXISTS idx_stock_movements_created_by ON stock_movements(created_by);

-- =====================================================
-- GRANT PERMISSIONS
-- =====================================================

-- Grant execute permissions on helper functions
GRANT EXECUTE ON FUNCTION get_user_organization_id() TO authenticated;
GRANT EXECUTE ON FUNCTION user_has_role(TEXT) TO authenticated;
GRANT EXECUTE ON FUNCTION user_has_any_role(TEXT[]) TO authenticated;

COMMIT;

-- =====================================================
-- VALIDATION QUERIES (Run after deployment)
-- =====================================================

-- Test 1: Verify RLS is enabled
-- SELECT schemaname, tablename, rowsecurity 
-- FROM pg_tables 
-- WHERE schemaname = 'public' 
-- AND rowsecurity = true;

-- Test 2: Verify policies exist
-- SELECT tablename, policyname, cmd, roles 
-- FROM pg_policies 
-- WHERE schemaname = 'public';

-- Test 3: Test access (run as different user roles)
-- SELECT count(*) FROM sales; -- Should respect RLS
```

**2. Database Security Helper:**

```typescript
// src/utils/database-security.ts

export interface SecurityContext {
  userId: string;
  organizationId: string;
  role: 'admin' | 'staff' | 'cashier' | 'inventory_manager' | 'customer';
}

export class DatabaseSecurityError extends Error {
  constructor(message: string, public code: string) {
    super(message);
    this.name = 'DatabaseSecurityError';
  }
}

export const validateSecurityContext = (context: SecurityContext | null): void => {
  if (!context) {
    throw new DatabaseSecurityError(
      'User must be authenticated to access this resource',
      'AUTH_REQUIRED'
    );
  }

  if (!context.userId) {
    throw new DatabaseSecurityError(
      'Invalid user context',
      'INVALID_USER'
    );
  }

  if (!context.organizationId) {
    throw new DatabaseSecurityError(
      'User must belong to an organization',
      'NO_ORGANIZATION'
    );
  }
};

export const checkRolePermission = (
  userRole: string,
  requiredRoles: string[]
): boolean => {
  return requiredRoles.includes(userRole);
};

export const getTablePermissions = (tableName: string) => {
  const permissions = {
    products: {
      read: ['admin', 'staff', 'cashier', 'customer'],
      write: ['admin', 'staff'],
    },
    categories: {
      read: ['admin', 'staff', 'cashier', 'customer'],
      write: ['admin'],
    },
    sales: {
      read: ['admin', 'staff', 'cashier'],
      write: ['admin', 'staff', 'cashier'],
    },
    inventory: {
      read: ['admin', 'staff'],
      write: ['admin', 'inventory_manager'],
    },
    customers: {
      read: ['admin', 'staff'],
      write: ['admin', 'staff'],
    },
    users: {
      read: ['admin'],
      write: ['admin'],
    },
  };

  return permissions[tableName as keyof typeof permissions] || {
    read: ['admin'],
    write: ['admin'],
  };
};

// Helper to validate organization access
export const validateOrganizationAccess = (
  userOrgId: string,
  resourceOrgId: string
): void => {
  if (userOrgId !== resourceOrgId) {
    throw new DatabaseSecurityError(
      'Access denied: resource belongs to different organization',
      'ORG_ACCESS_DENIED'
    );
  }
};

// Audit logging helper
export const logSecurityEvent = (
  event: 'ACCESS_GRANTED' | 'ACCESS_DENIED' | 'POLICY_VIOLATION',
  context: {
    userId: string;
    resource: string;
    action: string;
    reason?: string;
  }
) => {
  console.warn(`[SECURITY] ${event}:`, {
    timestamp: new Date().toISOString(),
    ...context,
  });
  
  // TODO: Send to monitoring service (Sentry, DataDog, etc.)
};
```

**3. RLS Validation Hook:**

```typescript
// src/hooks/useRLSValidation.ts

import { useEffect, useState } from 'react';
import { useAuth } from './useAuth';
import { supabase } from '@/lib/supabase';

interface RLSValidationResult {
  isValid: boolean;
  errors: string[];
  warnings: string[];
}

export const useRLSValidation = () => {
  const { user } = useAuth();
  const [validationResult, setValidationResult] = useState<RLSValidationResult>({
    isValid: true,
    errors: [],
    warnings: [],
  });

  useEffect(() => {
    if (!user) return;

    const validateRLSPolicies = async () => {
      const errors: string[] = [];
      const warnings: string[] = [];

      try {
        // Test 1: Verify user can only access their organization's data
        const { data: salesData, error: salesError } = await supabase
          .from('sales')
          .select('organization_id')
          .limit(5);

        if (salesError) {
          errors.push(`Sales RLS test failed: ${salesError.message}`);
        } else {
          // Check if all returned sales belong to user's organization
          const userOrgId = user.user_metadata?.organization_id;
          const invalidSales = salesData?.filter(s => s.organization_id !== userOrgId);
          
          if (invalidSales && invalidSales.length > 0) {
            errors.push('Sales RLS policy violation: accessing other organizations data');
          }
        }

        // Test 2: Verify customer data isolation
        const { data: customerData, error: customerError } = await supabase
          .from('customers')
          .select('organization_id, user_id')
          .limit(5);

        if (customerError) {
          warnings.push(`Customer RLS test warning: ${customerError.message}`);
        } else if (customerData) {
          const userOrgId = user.user_metadata?.organization_id;
          const invalidCustomers = customerData.filter(
            c => c.organization_id !== userOrgId && c.user_id !== user.id
          );
          
          if (invalidCustomers.length > 0) {
            errors.push('Customer RLS policy violation');
          }
        }

        // Test 3: Verify inventory access based on role
        const userRole = user.user_metadata?.role;
        if (!['admin', 'staff'].includes(userRole)) {
          const { data: inventoryData, error: inventoryError } = await supabase
            .from('inventory')
            .select('id')
            .limit(1);

          if (!inventoryError && inventoryData && inventoryData.length > 0) {
            errors.push(`Role ${userRole} should not have inventory access`);
          }
        }

        setValidationResult({
          isValid: errors.length === 0,
          errors,
          warnings,
        });

      } catch (error) {
        setValidationResult({
          isValid: false,
          errors: [`RLS validation failed: ${error instanceof Error ? error.message : 'Unknown error'}`],
          warnings: [],
        });
      }
    };

    validateRLSPolicies();
  }, [user]);

  return validationResult;
};

// Helper component to display RLS status
export const RLSStatus: React.FC = () => {
  const validation = useRLSValidation();

  if (validation.isValid && validation.errors.length === 0) {
    return null; // Don't show anything when all is good
  }

  return (
    <div className="rls-status p-4 mb-4 border-l-4 border-red-500 bg-red-50">
      <div className="flex">
        <div className="flex-shrink-0">
          <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
          </svg>
        </div>
        <div className="ml-3">
          <h3 className="text-sm font-medium text-red-800">
            Security Policy Violations Detected
          </h3>
          <div className="mt-2 text-sm text-red-700">
            <ul className="list-disc space-y-1 pl-5">
              {validation.errors.map((error, index) => (
                <li key={index}>{error}</li>
              ))}
            </ul>
          </div>
          {validation.warnings.length > 0 && (
            <div className="mt-2 text-sm text-yellow-700">
              <h4 className="font-medium">Warnings:</h4>
              <ul className="list-disc space-y-1 pl-5">
                {validation.warnings.map((warning, index) => (
                  <li key={index}>{warning}</li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
```

### Testing Instructions

**1. Deploy the Migration:**

```bash
# If using Supabase CLI
supabase db push

# Or manually via Supabase Dashboard:
# 1. Go to Database > Migrations
# 2. Create new migration
# 3. Paste the SQL content
# 4. Run migration
```

**2. Verify RLS is Active:**

```sql
-- Run in Supabase SQL Editor
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND rowsecurity = true;

-- Should return all critical tables with rowsecurity = true
```

**3. Test Policies:**

```sql
-- Verify policies exist
SELECT tablename, policyname, cmd, roles, qual, with_check
FROM pg_policies 
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

**4. Test Access Control:**

```javascript
// In browser console (as different user roles)

// Test 1: Staff member accessing sales
const { data: sales } = await supabase
  .from('sales')
  .select('*')
  .limit(5);

console.log('Sales accessible:', sales?.length || 0);

// Test 2: Customer trying to access inventory (should fail)
const { data: inventory, error } = await supabase
  .from('inventory')
  .select('*')
  .limit(1);

console.log('Inventory access error:', error?.message);
```

**5. Add RLS Status to App:**

```typescript
// In src/App.tsx or main layout
import { RLSStatus } from '@/hooks/useRLSValidation';

export const App = () => (
  <div className="app">
    {/* Add this for development/monitoring */}
    <RLSStatus />
    
    {/* Rest of your app */}
    <Router>
      {/* Your routes */}
    </Router>
  </div>
);
```

### Verification Checklist

- [x] RLS enabled on all critical tables
- [x] Helper functions created for role/organization checks
- [x] Policies prevent cross-organization data access
- [x] Role-based permissions implemented correctly
- [x] Performance indexes added for RLS queries
- [x] Validation hook created for monitoring
- [x] Security error handling implemented
- [x] Migration is idempotent (can be run multiple times)

### Security Test Results

**Expected Results After Implementation:**

1. **Anonymous users**: Can only read products and categories
2. **Customers**: Can only see their own data + public products
3. **Staff/Cashiers**: Can access organization data for sales/customers
4. **Admins**: Full access to their organization's data
5. **Cross-organization**: No data leakage between different organizations

### Rollback Plan

```sql
-- Emergency rollback if issues occur
BEGIN;

-- Disable RLS on all tables
ALTER TABLE products DISABLE ROW LEVEL SECURITY;
ALTER TABLE categories DISABLE ROW LEVEL SECURITY;
ALTER TABLE customers DISABLE ROW LEVEL SECURITY;
ALTER TABLE sales DISABLE ROW LEVEL SECURITY;
ALTER TABLE order_items DISABLE ROW LEVEL SECURITY;
ALTER TABLE inventory DISABLE ROW LEVEL SECURITY;
ALTER TABLE stock_movements DISABLE ROW LEVEL SECURITY;
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE organizations DISABLE ROW LEVEL SECURITY;

COMMIT;
```

### Next Steps

1. **Deploy this migration immediately** - This is a critical security fix
2. **Monitor application logs** for any access denied errors
3. **Test with real user accounts** in different roles
4. **Update application code** to handle RLS errors gracefully
5. **Proceed to ISSUE-010 (Loading States)** once this is verified working

**⚠️ CRITICAL**: Test this in a staging environment first if possible. RLS policies can lock users out if misconfigured.