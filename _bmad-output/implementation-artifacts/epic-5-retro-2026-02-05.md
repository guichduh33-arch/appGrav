# Epic 5 Retrospective: Stock & Approvisionnement

**Date**: 2026-02-05
**Epic**: Epic 5 - Stock & Approvisionnement (Inventaire, Transferts & Achats)
**Status**: Done
**Stories Completed**: 8/8
**Participants**: Bob (SM), Alice (PO), Charlie (Dev), Dana (QA), Elena (Junior Dev), MamatCEO (Lead)

---

## Executive Summary

Epic 5 a livré un module complet de gestion des stocks, transferts internes et achats. L'architecture offline-first avec caches read-only a été validée et étendue. Le passage aux hooks React Query a établi un pattern réutilisable pour les epics suivants. La complexité du workflow d'achat (PO → Reception → Stock) a été maîtrisée grâce à une décomposition rigoureuse en stories.

---

## What Went Well

### 1. Migration React Query Systématique
- **Pattern établi**: Tous les hooks utilisent `@tanstack/react-query` avec invalidation de cache
- **Constantes de stale time**: 30s pour données fréquentes, cohérence cross-module
- **Invalidation granulaire**: Queries liste ET single invalidées après mutations
- **Résultat**: Performance et UX améliorées, code maintenable

### 2. Architecture Offline Read-Only (ADR-001)
- Stock levels, alertes, produits: **cache read-only** avec `useNetworkStatus`
- Mutations (adjustments, transfers, PO): **online-only** avec bannière bloquante
- Pattern clair et documenté, aucune ambiguïté pour les devs

### 3. Tests Unitaires Exhaustifs
- **180+ tests** au total pour l'Epic 5
- Tests pour edge cases: écarts de quantité, réception partielle, workflow transitions
- Couverture des hooks avec mocks Supabase appropriés

### 4. Traductions i18n Complètes
- **300+ clés** ajoutées dans les 3 locales (FR, EN, ID)
- Pattern de clés hiérarchiques: `module.feature.action`
- Validation croisée entre locales

### 5. Code Review Systématique
- Chaque story a été code reviewed avant merge
- **45+ issues** trouvées et corrigées (HIGH: 12, MEDIUM: 18, LOW: 15)
- Pattern de severity-based prioritization établi

---

## Challenges & Solutions

### Challenge 1: Workflow d'Achat Multi-Étapes
**Problème**: Le cycle PO → Approbation → Envoi → Réception → Stock est complexe
**Solution**: Décomposition en 3 stories distinctes (5-6, 5-7, 5-8) avec hooks dédiés
```typescript
// Hooks séparés par responsabilité
usePurchaseOrders()      // CRUD de base
usePurchaseOrderWorkflow()   // Transitions de statut
usePurchaseOrderReception()  // Réception + stock movements
```
**Impact**: Code modulaire, testable, maintenable

### Challenge 2: Génération Automatique des Stock Movements
**Problème**: Transfers et PO doivent créer des movements IN/OUT automatiquement
**Solution**: Logique dans les hooks de réception avec transaction-like behavior
```typescript
// Pseudo-transaction avec rollback manuel
try {
  await updateStatus(id, 'received');
  await createStockMovements(items);
} catch (error) {
  console.error('Recovery needed:', id);
  throw error;
}
```
**Impact**: Traçabilité complète, recovery documenté

### Challenge 3: Validation des Écarts de Quantité
**Problème**: Réception avec écarts (partielle ou surplus) nécessite justification
**Solution**: Note obligatoire si variance > 0, UX claire avec indicateurs visuels
```typescript
const hasVariance = received !== requested;
const requiresNote = hasVariance && !notes;
```
**Impact**: Audit trail complet, UX intuitive

### Challenge 4: Taille des Fichiers (PurchaseOrderDetailPage)
**Problème**: Page détail PO atteint 1131 lignes (limite 300)
**Solution**: Documenté comme dette technique, extraction en composants planifiée
**Impact**: Fonctionnel mais refactoring nécessaire (Epic 6+)

---

## Suivi des Recommandations Epic 4

| Recommandation Epic 4 | Application Epic 5 | Résultat |
|-----------------------|-------------------|----------|
| useRef pour state volatil | Utilisé dans formulaires et timeouts | Validé |
| isMounted flag cleanup | Implémenté dans tous les hooks async | Validé |
| Code review systématique | Chaque story reviewée avant merge | Validé |
| Tests plus tôt (TDD) | Tests écrits après impl mais avant review | Partiellement |
| LAN communication ready | Non utilisé (pas requis pour stock) | N/A |

**Note**: Le TDD n'a pas été strictement appliqué (tests écrits après implémentation), mais la couverture est bonne.

---

## Technical Decisions Made

| Decision | Rationale | Status |
|----------|-----------|--------|
| React Query hooks pattern | Performance, cache intégré, invalidation | Validé |
| Stock read-only offline | Évite conflits sync, données toujours fraîches | Validé |
| Mutations online-only | Traçabilité, pas de conflits | Validé |
| Status machine pour PO | Workflow clair, transitions validées | Validé |
| Notes obligatoires si écart | Audit trail, compliance | Validé |
| Pagination 50 items | Balance UX/performance | Validé |

---

## Patterns Established

### 1. Hook Structure Standard
```typescript
// Pattern pour tous les hooks CRUD
export function useEntity(filters?: IEntityFilter) {
  return useQuery({
    queryKey: ['entities', filters],
    queryFn: () => fetchEntities(filters),
    staleTime: ENTITY_STALE_TIME,
    enabled: isOnline,
  });
}

export function useCreateEntity() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: createEntity,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['entities'] });
    },
  });
}
```

### 2. Online-Only Mutation Pattern
```typescript
// Bannière + désactivation boutons
const { isOnline } = useNetworkStatus();

{!isOnline && (
  <Alert variant="warning">
    {t('common.offlineWarning')}
  </Alert>
)}

<Button disabled={!isOnline || isSubmitting}>
  {t('action.submit')}
</Button>
```

### 3. Status Workflow avec Validation
```typescript
const STATUS_TRANSITIONS: Record<POStatus, POStatus[]> = {
  draft: ['pending_approval', 'cancelled'],
  pending_approval: ['approved', 'rejected', 'draft'],
  approved: ['sent', 'cancelled'],
  sent: ['partially_received', 'received', 'cancelled'],
  // ...
};

function canTransition(from: POStatus, to: POStatus): boolean {
  return STATUS_TRANSITIONS[from]?.includes(to) ?? false;
}
```

### 4. Écarts avec Note Obligatoire
```typescript
interface IReceptionItem {
  quantity_ordered: number;
  quantity_received: number;
  notes?: string;
}

function validateReception(items: IReceptionItem[]): string[] {
  const errors: string[] = [];
  items.forEach((item, idx) => {
    const variance = item.quantity_received - item.quantity_ordered;
    if (variance > 0 && !item.notes) {
      errors.push(`Item ${idx + 1}: note requise pour surplus`);
    }
  });
  return errors;
}
```

---

## Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 8/8 (100%) |
| Total Tests Written | ~180 |
| New Hooks | 12 (useStockLevels, useStockAlerts, useStockAdjustment, useInternalTransfers, useReceiveTransfer, usePurchaseOrders, usePurchaseOrderWorkflow, usePurchaseOrderReception, etc.) |
| New Pages | 8 (StockLevelsPage, StockAlertsPage, StockAdjustmentPage, InternalTransfersPage, TransferDetailPage, PurchaseOrdersPage, PurchaseOrderFormPage, PurchaseOrderDetailPage) |
| i18n Keys Added | ~300 (100 par locale) |
| Code Review Issues Fixed | 45+ (12 HIGH, 18 MEDIUM, 15 LOW) |
| Technical Debt Identified | 1 major (PurchaseOrderDetailPage size) |

---

## Technical Debt Identified

### 1. PurchaseOrderDetailPage.tsx - 1131 lignes
**Problème**: Fichier dépasse largement la limite de 300 lignes
**Cause**: Formulaire réception complexe avec tableau éditable
**Solution proposée**: Extraire en composants:
- `POHeader.tsx` (~100 lignes)
- `POItemsTable.tsx` (~300 lignes)
- `POReceptionForm.tsx` (~200 lignes)
- `POStatusActions.tsx` (~150 lignes)
**Priorité**: Medium (fonctionnel mais difficile à maintenir)
**Epic cible**: Epic 6 ou dédié

### 2. Tests Manuels Non Documentés
**Problème**: Tests d'intégration manuels non formalisés
**Solution**: Créer checklist de tests manuels pour QA
**Priorité**: Low

---

## Recommendations for Epic 6

### 1. Réutiliser les Patterns Epic 5
- Hook structure avec React Query
- Online-only mutations avec bannière
- Validation avec notes obligatoires
- Code review systématique

### 2. Refactoring Opportuniste
- Si travail sur purchasing, extraire les composants de PurchaseOrderDetailPage
- Documenter comme dette technique si report

### 3. TDD pour Hooks Complexes
- Customer pricing rules ont beaucoup d'edge cases
- Écrire tests AVANT implémentation

### 4. Attention aux Calculs de Prix
- Loyalty points: 1 point = 1000 IDR
- Customer category pricing: wholesale, discount_percentage, custom
- Validation des arrondis IDR (nearest 100)

### 5. Combos & Promotions Complexity
- Stories 6-5 et 6-6 sont complexes
- Prévoir plus de temps pour tests

---

## Files Created/Modified (Summary)

### Hooks (12 nouveaux)
- `src/hooks/inventory/useStockLevels.ts`
- `src/hooks/inventory/useStockAlerts.ts`
- `src/hooks/inventory/useStockAdjustment.ts`
- `src/hooks/inventory/useInternalTransfers.ts`
- `src/hooks/inventory/useReceiveTransfer.ts`
- `src/hooks/purchasing/usePurchaseOrders.ts`
- `src/hooks/purchasing/usePurchaseOrderWorkflow.ts`
- `src/hooks/purchasing/usePurchaseOrderReception.ts`
- `src/hooks/inventory/index.ts` (exports)
- `src/hooks/purchasing/index.ts` (exports)

### Pages (8 nouvelles)
- `src/pages/inventory/StockLevelsPage.tsx`
- `src/pages/inventory/StockAlertsPage.tsx`
- `src/pages/inventory/StockAdjustmentPage.tsx`
- `src/pages/inventory/InternalTransfersPage.tsx`
- `src/pages/inventory/TransferFormPage.tsx`
- `src/pages/inventory/TransferDetailPage.tsx`
- `src/pages/purchasing/PurchaseOrdersPage.tsx`
- `src/pages/purchasing/PurchaseOrderFormPage.tsx`
- `src/pages/purchasing/PurchaseOrderDetailPage.tsx`

### CSS (8 nouveaux)
- Fichiers CSS correspondants pour chaque page

### Tests (180+)
- `src/hooks/inventory/__tests__/useStockLevels.test.ts`
- `src/hooks/inventory/__tests__/useStockAlerts.test.ts`
- `src/hooks/inventory/__tests__/useStockAdjustment.test.ts`
- `src/hooks/inventory/__tests__/useInternalTransfers.test.ts`
- `src/hooks/purchasing/__tests__/usePurchaseOrders.test.ts`
- `src/hooks/purchasing/__tests__/usePurchaseOrderWorkflow.test.ts`
- `src/hooks/purchasing/__tests__/usePurchaseOrderReception.test.ts`

### Locales
- `src/locales/fr.json` (~100 clés ajoutées)
- `src/locales/en.json` (~100 clés ajoutées)
- `src/locales/id.json` (~100 clés ajoutées)

---

## Team Discussion Highlights

### Bob (SM)
> "L'Epic 5 a validé notre approche offline-first read-only. La séparation claire entre cache et mutations évite les conflits de sync. Le pattern est prêt pour l'Epic 6."

### Alice (PO)
> "Le workflow d'achat complet va vraiment aider The Breakery. La traçabilité avec les stock movements automatiques est exactement ce qu'il fallait pour les audits."

### Charlie (Dev)
> "React Query a simplifié énormément le code. L'invalidation de cache est magique comparé à notre ancien pattern. Par contre, PurchaseOrderDetailPage est trop gros - on doit le refactorer."

### Dana (QA)
> "180 tests c'est solide. Les edge cases de réception partielle étaient bien couverts. J'aurais aimé des tests d'intégration automatisés mais le manuel a fonctionné."

### Elena (Junior)
> "J'ai appris le pattern React Query et les status machines. Le code review m'a aidé à voir mes erreurs avant qu'elles deviennent des bugs."

### MamatCEO (Lead)
> "Excellent epic. La dette technique sur PurchaseOrderDetailPage est notée - on la traitera quand on reviendra sur purchasing. Priorité maintenant: Epic 6 pour les clients et la fidélité."

---

## Impact sur Epic 6

Epic 5 a établi des bases solides pour Epic 6 (Clients & Marketing):

1. **React Query pattern prêt** - Hooks customers suivront le même pattern
2. **Offline read-only validé** - Customer cache, loyalty cache, promotions cache
3. **Status workflow pattern** - Réutilisable pour B2B orders
4. **i18n pattern mature** - 300+ clés ajoutées sans problème
5. **Code review culture** - Intégré dans le workflow

### Dépendances Epic 6 sur Epic 5
- Stories 6-1 à 6-4: Suivent le pattern read-only cache
- Story 6-7 (B2B orders): Similaire aux PO workflow
- Story 6-8 (B2B payments): Pattern réception applicable

---

## Conclusion

Epic 5 est un succès complet. Le module Stock & Approvisionnement est fonctionnel, testé, et documenté. Les patterns établis (React Query hooks, online-only mutations, status workflows) seront précieux pour l'Epic 6 et au-delà. La seule dette technique significative (PurchaseOrderDetailPage) est documentée et planifiée.

**Recommandation**: Marquer l'Epic 5 comme "done" et commencer Epic 6.

---

*Rétrospective facilitée par Bob (SM) avec participation de toute l'équipe BMAD.*
